# PostgreSQL 使用指南

本指南介绍如何使用 PostgreSQL 数据库管理系统。

## 快速开始

### 连接数据库

```bash
# 使用 psql
psql -U postgres -h localhost

# 创建数据库
CREATE DATABASE myapp;

# 连接到数据库
\c myapp

# 退出
\q
```

### 创建表

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 插入数据

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- 批量插入
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### 查询数据

```sql
-- 查询所有
SELECT * FROM users;

-- 条件查询
SELECT * FROM users WHERE id = 1;

-- 分页查询
SELECT * FROM users LIMIT 10 OFFSET 0;

-- 排序
SELECT * FROM users ORDER BY created_at DESC;
```

### 更新数据

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### 删除数据

```sql
DELETE FROM users WHERE id = 1;
```

## 常用数据类型

### 数值类型

| 类型 | 说明 |
|------|------|
| SMALLINT | 2 字节整数 (-32768 到 32767) |
| INTEGER | 4 字节整数 |
| BIGINT | 8 字节整数 |
| DECIMAL | 精确数值 |
| REAL | 4 字节浮点 |
| DOUBLE PRECISION | 8 字节浮点 |

### 字符串类型

| 类型 | 说明 |
|------|------|
| CHAR(n) | 固定长度 |
| VARCHAR(n) | 可变长度 |
| TEXT | 可变长度（无限制） |

### 日期时间类型

| 类型 | 说明 |
|------|------|
| DATE | 日期 |
| TIME | 时间 |
| TIMESTAMP | 日期和时间 |
| TIMESTAMPTZ | 带时区的日期时间 |

### JSON 类型

```sql
-- JSON 类型
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- 查询 JSON 数据
SELECT data->>'name' FROM events;
```

## 约束

### 主键

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### 外键

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### 唯一约束

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### 非空约束

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### 检查约束

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## 索引

### 创建索引

```sql
-- 单列索引
CREATE INDEX idx_users_email ON users(email);

-- 多列索引
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- 唯一索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### 删除索引

```sql
DROP INDEX idx_users_email;
```

## 视图

### 创建视图

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### 使用视图

```sql
SELECT * FROM active_users;
```

## 存储过程和函数

### 创建函数

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### 调用函数

```sql
SELECT get_user_count();
```

## 事务

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- 或 ROLLBACK;
```

## 备份和恢复

### 备份

```bash
# 备份单个数据库
pg_dump -U postgres mydb > backup.sql

# 备份所有数据库
pg_dumpall -U postgres > all_backup.sql

# 压缩备份
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### 恢复

```bash
# 恢复数据库
psql -U postgres mydb < backup.sql

# 恢复所有数据库
psql -U postgres -f all_backup.sql

# 解压恢复
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## 用户管理

### 创建用户

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### 授权

```sql
-- 授予数据库权限
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- 授予表权限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- 授予序列权限
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### 删除用户

```sql
DROP USER myuser;
```

## 性能优化

### EXPLAIN 分析

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### ANALYZE 更新统计信息

```sql
ANALYZE users;
```

### VACUUM 清理

```sql
-- 清理死亡元组
VACUUM users;

-- 重建表
VACUUM FULL users;
```

## 相关资源

- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [PostgreSQL 中文文档](https://www.postgresql.cn/)
- [pgAdmin 工具](https://www.pgadmin.org/)
