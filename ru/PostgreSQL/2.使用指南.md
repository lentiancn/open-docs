# Руководство пользователя PostgreSQL

В этом руководстве описано, как использовать систему управления базами данных PostgreSQL.

## Быстрый старт

### Подключение к базе данных

```bash
# Использование psql
psql -U postgres -h localhost

# Создать базу данных
CREATE DATABASE myapp;

# Подключиться к базе данных
\c myapp

# Выйти
\q
```

### Создание таблицы

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Вставка данных

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- Пакетная вставка
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### Запрос данных

```sql
-- Выбрать все
SELECT * FROM users;

-- Условный запрос
SELECT * FROM users WHERE id = 1;

-- Постраничный запрос
SELECT * FROM users LIMIT 10 OFFSET 0;

-- Сортировка
SELECT * FROM users ORDER BY created_at DESC;
```

### Обновление данных

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### Удаление данных

```sql
DELETE FROM users WHERE id = 1;
```

## Общие типы данных

### Числовые типы

| Тип | Описание |
|-----|----------|
| SMALLINT | 2-байтовое целое (-32768 до 32767) |
| INTEGER | 4-байтовое целое |
| BIGINT | 8-байтовое целое |
| DECIMAL | Точное число |
| REAL | 4-байтовое с плавающей точкой |
| DOUBLE PRECISION | 8-байтовое с плавающей точкой |

### Строковые типы

| Тип | Описание |
|-----|----------|
| CHAR(n) | Фиксированная длина |
| VARCHAR(n) | Переменная длина |
| TEXT | Переменная длина (без ограничений) |

### Типы даты и времени

| Тип | Описание |
|-----|----------|
| DATE | Дата |
| TIME | Время |
| TIMESTAMP | Дата и время |
| TIMESTAMPTZ | Дата и время с часовым поясом |

### Типы JSON

```sql
-- Тип JSON
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- Запрос JSON-данных
SELECT data->>'name' FROM events;
```

## Ограничения

### Первичный ключ

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### Внешний ключ

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### Ограничение уникальности

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### Ограничение NOT NULL

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### Проверочное ограничение

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## Индексы

### Создание индексов

```sql
-- Индекс на один столбец
CREATE INDEX idx_users_email ON users(email);

-- Индекс на несколько столбцов
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- Уникальный индекс
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### Удаление индексов

```sql
DROP INDEX idx_users_email;
```

## Представления

### Создание представления

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### Использование представления

```sql
SELECT * FROM active_users;
```

## Хранимые процедуры и функции

### Создание функции

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### Вызов функции

```sql
SELECT get_user_count();
```

## Транзакции

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- или ROLLBACK;
```

## Резервное копирование и восстановление

### Резервное копирование

```bash
# Резервное копирование одной базы данных
pg_dump -U postgres mydb > backup.sql

# Резервное копирование всех баз данных
pg_dumpall -U postgres > all_backup.sql

# Сжатое резервное копирование
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### Восстановление

```bash
# Восстановить базу данных
psql -U postgres mydb < backup.sql

# Восстановить все базы данных
psql -U postgres -f all_backup.sql

# Восстановить из архива
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## Управление пользователями

### Создание пользователя

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### Предоставление прав

```sql
-- Предоставить права на базу данных
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- Предоставить права на таблицы
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- Предоставить права на последовательности
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### Удаление пользователя

```sql
DROP USER myuser;
```

## Оптимизация производительности

### Анализ с EXPLAIN

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### Обновление статистики с ANALYZE

```sql
ANALYZE users;
```

### Очистка с VACUUM

```sql
-- Очистить мертвые кортежи
VACUUM users;

-- Перестроить таблицу
VACUUM FULL users;
```

## Ресурсы

- [Официальная документация PostgreSQL](https://www.postgresql.org/docs/)
- [Документация PostgreSQL](https://www.postgresql.org/docs/)
- [Инструмент pgAdmin](https://www.pgadmin.org/)
