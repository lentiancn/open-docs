# Benutzerhandbuch für Apache APISIX

## Grundkonzepte

### Route

Eine Route definiert die Zuordnung zwischen Anfragepfaden und Backend-Diensten.

### Upstream

Eine Gruppe von Knoten, die denselben Dienst bereitstellen. APISIX führt Lastauswahl zwischen diesen Knoten durch.

### Consumer

Ein API-Benutzer, der sich durch Authentifizierungs-Plugins identifizieren muss.

## Erste Schritte

### Erste Route erstellen

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "meine-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"httpbin.org:80": 1}
  }
}'
```

### Verifizieren

```bash
curl "http://127.0.0.1:9080/ip"
```

## Lastausgleich

### Gewichteter Round-Robin

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"dienst-a:8080": 3, "dienst-b:8080": 1}
  }
}'
```

## Authentifizierung

### API-Schlüssel-Authentifizierung

**Consumer erstellen:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "benutzer1",
  "plugins": {"key-auth": {"key": "mein-geheimer-schluessel"}}
}'
```

**Route aktivieren:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/meine-route" -X PATCH -d '
{"plugins": {"key-auth": {}}}
'
```

**Mit Schlüssel zugreifen:**

```bash
curl "http://127.0.0.1:9080/ip" -H "apikey: mein-geheimer-schluessel"
```

## Ratenbegrenzung

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/meine-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

## Verkehrs-Umleitung

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/v1/*",
  "plugins": {"proxy-rewrite": {"uri": "/$uri"}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

## Monitoring

### Prometheus

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {"prometheus": {}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

Metriken abrufen:

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

## Verwaltungsbefehle

### Alle Routen auflisten

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### Route löschen

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/meine-route" -X DELETE
```

## Best Practices

1. API-Schlüssel in Produktion ändern
2. HTTPS verwenden
3. Health Checks aktivieren
4. Vernünftige Ratenlimits setzen
5. Regelmäßig Konfigurationen sichern
