# Spring Cloud 使用指南

本指南介绍如何使用 Spring Cloud 组件开发分布式系统。

## 服务发现

### Eureka 服务端

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

```properties
# application.properties
server.port=8761
eureka.instance.hostname=localhost
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
eureka.client.service-url.defaultZone=http://${eureka.instance.hostname}:${server.port}/eureka/
```

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### Eureka 客户端

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

```properties
spring.application.name=my-service
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
eureka.instance.prefer-ip-address=true
```

## API 网关

### Spring Cloud Gateway

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
   pring-cloud-starter-gateway</artifactId <artifactId>s>
</dependency>
```

```properties
spring.cloud.gateway.routes[0].id=user-service
spring.cloud.gateway.routes[0].uri=lb://user-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/users/**
spring.cloud.gateway.routes[1].id=order-service
spring.cloud.gateway.routes[1].uri=lb://order-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/orders/**
```

## 服务间通信

### OpenFeign 客户端

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

```java
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/users/{id}")
    User getUserById(@PathVariable("id") Long id);
    
    @GetMapping("/users")
    List<User> getAllUsers();
}

@SpringBootApplication
@EnableFeignClients
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

## 配置管理

### Spring Cloud Config 服务端

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server</artifactId>
</dependency>
```

```properties
server.port=8888
spring.application.name=config-server
spring.cloud.config.server.git.uri=https://github.com/your-org/config-repo
spring.cloud.config.server.git.default-label=main
```

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```

### Config 客户端

```properties
spring.config.import=optional:configserver:http://localhost:8888
spring.application.name=myapp
```

## 熔断器

### Resilience4j

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
```

```java
@Service
public class UserService {
    
    @Autowired
    private UserClient userClient;
    
    @CircuitBreaker(name = "userService", fallbackMethod = "fallbackGetUser")
    public User getUserById(Long id) {
        return userClient.getUserById(id);
    }
    
    public User fallbackGetUser(Long id) {
        return new User();
    }
}
```

## 分布式消息

### Spring Cloud Stream

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream-binder-kafka</artifactId>
</dependency>
```

```java
@Component
public class MessageProducer {
    
    @Autowired
    private Source source;
    
    public void sendMessage(String message) {
        source.output().send(MessageBuilder.withPayload(message).build());
    }
}

@Component
public class MessageConsumer {
    
    @StreamListener(Sink.INPUT)
    public void receiveMessage(String message) {
        System.out.println("Received: " + message);
    }
}
```

```properties
spring.cloud.stream.bindings.input.destination=my-topic
spring.cloud.stream.bindings.output.destination=my-topic
```

## Docker Compose 示例

```yaml
version: '3.8'
services:
  eureka:
    image: spring-cloud/eureka-server
    ports:
      - "8761:8761"
  
  config-server:
    image: spring-cloud/config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_CLOUD_CONFIG_SERVER_GIT_URI=https://github.com/your-org/config
  
  gateway:
    image: myapp/gateway
    ports:
      - "8080:8080"
    depends_on:
      - eureka
      - config-server
```

## 最佳实践

1. **使用发布版本**：始终使用兼容的 Spring Boot 和 Spring Cloud 版本
2. **启用健康检查**：为所有服务配置 Actuator 健康端点
3. **使用 Config Server**：集中配置便于管理
4. **实现熔断器**：防止级联故障
5. **启用追踪**：使用 Spring Cloud Sleuth 进行分布式追踪

## 相关链接

- [Spring Cloud 官网](https://spring.io/projects/spring-cloud)
- [Spring Cloud Netflix](https://cloud.spring.io/spring-cloud-netflix/)
- [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-gateway/)
- [Spring Cloud OpenFeign](https://cloud.spring.io/spring-cloud-openfeign/)
