# Yarn User Manual

This manual provides detailed information on Yarn's features and usage, helping you make the most of this powerful JavaScript package manager. Whether you're new to Yarn or an experienced user wanting to understand advanced features, you'll find valuable information here.

---

## Basic Concepts

### Understanding package.json

package.json is the core configuration file for Node.js projects. It defines project metadata, dependencies, and executable scripts. Understanding the structure of package.json is essential for proficient use of Yarn.

**Basic Structure**:

```json
{
  "name": "my-awesome-project",
  "version": "1.0.0",
  "description": "This is an awesome project",
  "type": "module",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.esm.js",
      "require": "./dist/index.cjs"
    }
  },
  "files": [
    "dist"
  ],
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest",
    "lint": "eslint src --ext .ts,.tsx",
    "format": "prettier --write src"
  },
  "dependencies": {
    "react": "^18.2.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "vitest": "^1.0.0"
  },
  "peerDependencies": {
    "react": ">=16.8.0"
  },
  "optionalDependencies": {
    "fsevents": "^2.3.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "yarn": ">=4.0.0"
  },
  "packageManager": "yarn@4.0.0"
}
```

**Field Descriptions**:

- name: Project name, must be unique, cannot contain uppercase letters or special characters
- version: Semantic version number following major.minor.patch format
- description: Project description
- type: Module type, commonjs or module
- main: Package entry point
- module: ES module entry
- types: TypeScript type definition file
- exports: Package export configuration supporting multiple formats
- files: Files/directories to include when publishing
- scripts: Executable script commands
- dependencies: Production dependencies
- devDependencies: Development dependencies
- peerDependencies: Peer dependencies, specifies what consumers must provide
- optionalDependencies: Optional dependencies that don't cause installation failure
- engines: Runtime environment requirements
- packageManager: Package manager version used by the project

### Dependency Types Explained

Yarn (and npm) supports multiple dependency types, each serving different purposes:

**dependencies (Production Dependencies)**: Dependencies needed in the production environment. Libraries like React and Lodash needed at runtime.

**devDependencies (Development Dependencies)**: Dependencies only needed during development. Build tools like TypeScript, ESLint, and Vite. These won't be bundled into the final product.

**peerDependencies (Peer Dependencies)**: Specifies what consumers of the package must provide. Typically used in plugin development. For example, a React component library's peerDependencies would declare react versions, requiring consumers to install React themselves.

**optionalDependencies (Optional Dependencies)**: Dependencies whose installation failure doesn't cause overall installation failure. Typically used for platform-specific dependencies like fsevents which is only needed on macOS.

### The Role of yarn.lock

yarn.lock is one of Yarn's most important files, recording the exact version of each package in the dependency tree. When you run yarn install, Yarn:

1. Reads dependency declarations from package.json
2. Resolves all direct and transitive dependencies
3. Determines exact versions according to semantic versioning rules
4. Writes results to yarn.lock

Next time you install, regardless of environment or time, Yarn will install strictly according to versions in yarn.lock, ensuring completely consistent results. This is what "deterministic guarantees" means.

---

## Daily Usage Guide

### Initializing Projects

Creating a new Node.js project:

```bash
# Interactive initialization, will ask for project information
yarn init -2

# Or non-interactive quick creation
yarn init -y
```

This creates a basic package.json file in the current directory.

### Installing Dependencies

**Installing all dependencies**:

```bash
# Standard installation
yarn install

# Shorthand
yarn
```

First installation will install all dependencies based on package.json and yarn.lock (if exists).

**Installing and generating lock file**:

```bash
# Immutable mode, prevents modifying lock file
yarn install --immutable
```

This is commonly used in CI environments to prevent accidental lock file modifications.

### Adding Dependencies

```bash
# Add production dependency
yarn add lodash

# Add development dependency
yarn add -D typescript
yarn add --dev eslint

# Add specific version
yarn add lodash@4.17.21

# Add latest version
yarn add lodash@latest

# Add pre-release version
yarn add lodash@beta
```

Yarn automatically selects the appropriate version modifier. Default is caret (^), allowing minor version updates.

**Version Modifier Options**:

```bash
# Exact version (no modifier)
yarn add -E lodash@4.17.21

# Tilde (allows patch versions)
yarn add -T lodash@4.17.21

# Caret (allows minor versions, default)
yarn add -C lodash@4.17.21
```

### Removing Dependencies

```bash
# Remove production dependency
yarn remove lodash

# Remove development dependency
yarn remove typescript --dev
```

### Updating Dependencies

```bash
# Update to latest version (according to version modifier)
yarn up lodash
yarn upgrade lodash

# Update to specific version
yarn up lodash@4.17.20

# Interactive update (shows version selection)
yarn up -i

# Update all dependencies
yarn up --all

# Interactive update all
yarn up -i --all
```

### Running Scripts

Scripts defined in package.json can be run as follows:

```bash
# Run custom scripts
yarn dev
yarn build
yarn test

# Explicitly use run
yarn run dev

# List all available scripts
yarn run
```

If script names conflict with Yarn built-in commands, use run explicitly:

```bash
yarn run my-custom-script
```

### Viewing Dependencies

```bash
# List all dependencies
yarn list

# List only top-level dependencies
yarn list --level=0

# Display in tree format
yarn list --tree

# Check outdated dependencies
yarn outdated
```

### Viewing Package Information

```bash
# View detailed package information
yarn info lodash

# View specific version
yarn info lodash@4.17.21

# View specific field
yarn info lodash description
yarn info lodash repository
```

### Understanding Dependency Reasons

```bash
# View why a package was installed
yarn why lodash
```

This shows the dependency chain, helping you understand why a package was installed.

---

## Complete Guide to Workspaces

Workspaces is one of Yarn's most powerful features, allowing you to manage multiple related packages within a single code repository.

### Configuring Workspaces

Add workspaces field in root package.json:

```json
{
  "name": "my-monorepo",
  "private": true,
  "workspaces": [
    "packages/*",
    "apps/*"
  ]
}
```

Workspaces support glob patterns:

```json
{
  "workspaces": [
    "packages/*",
    "packages/@org/*",
    "apps/*"
  ]
}
```

### Creating Workspace Packages

Each workspace is essentially an ordinary npm package with its own package.json:

```
my-monorepo/
├── package.json
└── packages/
    ├── core/
    │   ├── package.json
    │   └── src/
    │       └── index.ts
    ├── ui-button/
    │   ├── package.json
    │   └── src/
    │       └── Button.tsx
    └── utils/
        ├── package.json
        └── src/
            └── index.ts
```

### Workspace Commands

**Adding dependencies to specific workspace**:

```bash
yarn workspace @my-org/core add lodash
yarn workspace @my-org/core add -D typescript
```

**Running scripts in specific workspace**:

```bash
yarn workspace @my-org/core run build
yarn workspace @my-org/ui-button run test
```

**Running commands in all workspaces**:

```bash
# Build all workspaces
yarn workspaces foreach -pt run build

# -p: parallel execution
# -t: show timing
# -A: include all workspaces
```

**Focused installation** (only install specified workspace):

```bash
# Only install @my-org/app and its dependencies
yarn workspaces focus @my-org/app

# Include production dependencies
yarn workspaces focus @my-org/app --production
```

**List all workspaces**:

```bash
yarn workspaces list
```

### Inter-Workspace Dependencies

Use workspace: protocol to reference workspaces:

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:*",
    "@my-org/constants": "workspace:^",
    "@my-org/shared": "workspace:~"
  }
}
```

When publishing, Yarn automatically converts to actual version numbers:

| workspace protocol | local version | after publish |
|-------------------|--------------|---------------|
| workspace:* | 1.0.0 | 1.0.0 |
| workspace:^ | 1.0.0 | ^1.0.0 |
| workspace:~ | 1.0.0 | ~1.0.0 |
| workspace:>= | 1.0.0 | >=1.0.0 |

### Constraints

Constraints allow you to define rules managing all workspaces. Create constraints.pro file:

```javascript
// Constraint: ensure all workspaces use same TypeScript version
workspaces.forEach(workspace => {
  const ts = workspace.dependencies.get("typescript");
  if (!ts || ts.version !== "^5.0.0") {
    workspace.dependencies.set("typescript", "workspace:^5.0.0");
  }
});

// Constraint: ensure all workspaces have correct license
workspaces.forEach(workspace => {
  if (!workspace.license) {
    throw new Error(`Missing license in ${workspace.name}`);
  }
});

// Constraint: ensure all workspaces have description
workspaces.forEach(workspace => {
  workspace.set("description", `The ${workspace.name} package`);
});
```

Run constraint checking:

```bash
yarn constraints
```

---

## Plugin System

### Introduction to Plugins

Yarn's plugin system allows extending its functionality. Yarn 4.x has core plugins built-in while providing rich official plugins.

### Official Plugin List

```bash
yarn plugin list
```

Common plugins:

- @yarnpkg/plugin-github - Install packages from GitHub
- @yarnpkg/plugin-npm - npm-related functionality
- @yarnpkg/plugin-pack - Packaging functionality
- @yarnpkg/plugin-workspace-tools - Workspace tools enhancement

### Installing Plugins

```bash
# Install from official plugin list
yarn plugin import @yarnpkg/plugin-github

# Install from URL
yarn plugin import https://example.com/plugin.js

# Install from local file
yarn plugin import ./my-plugin.js
```

### Removing Plugins

```bash
yarn plugin remove @yarnpkg/plugin-github
```

### Plugin Runtime

```bash
# View currently running plugins
yarn plugin runtime
```

---

## Cache Management

### Viewing Cache

```bash
# View cache directory
yarn cache dir

# List cached packages
yarn cache list

# List cached versions of specific package
yarn cache list lodash
```

### Cleaning Cache

```bash
# Clean all cache
yarn cache clean

# Clean specific package
yarn cache clean lodash
```

### Global Cache

Yarn 4.x supports global cache, modify .yarnrc.yml:

```yaml
enableGlobalCache: true
```

---

## Configuration Details

### .yarnrc.yml Configuration

Yarn 4.x uses YAML format configuration files:

```yaml
# npm registry
npmRegistryServer: "https://registry.npmjs.org"

# Enable global cache
enableGlobalCache: false

# Node.js linker
# node-modules: Traditional mode, creates node_modules
# pnp: Plug'n'Play mode
nodeLinker: node-modules

# Enable lifecycle scripts
enableScripts: true

# Enable global patches
enableGlobalPatches: false

# Installation mode
# production: only install dependencies
# development: install all dependencies
# skip-build: skip build scripts
# update-lockfile: only update lockfile
mode: development

# Unsafe HTTP whitelist
unsafeHttpWhitelist:
  - localhost
  - "*.internal.company.com"

# Compression level for installed packages
compressionLevel: 6
```

### Environment Variables

You can override configurations through environment variables:

```bash
# Set registry
YARN_NPM_REGISTRY_SERVER=https://registry.npmmirror.com yarn install

# Disable scripts
YARN_ENABLE_SCRIPTS=0 yarn install
```

---

## Advanced Features

### Zero-Installs

Zero-Installs lets you skip the installation step, making dependencies available immediately after cloning a project.

**Configuration**:

```yaml
# .yarnrc.yml
enableGlobalCache: false
```

**Validation**:

```bash
# Validate project
yarn install --immutable --immutable-cache
```

### Hardened Mode

Prevents accidental lockfile modifications:

```bash
yarn install --immutable
```

### Offline Mode

```bash
# Install using cache
yarn install --offline

# Prefer cache, fetch from network if not available
yarn install --prefer-offline
```

### Diagnosing Problems

```bash
# Diagnose configuration issues
yarn doctor
```

---

## Common Commands Quick Reference

### Dependency Management

| Command | Description |
|---------|-------------|
| yarn init | Initialize project |
| yarn install | Install dependencies |
| yarn add \<pkg\> | Add dependency |
| yarn add -D \<pkg\> | Add dev dependency |
| yarn add -E \<pkg\> | Exact version |
| yarn remove \<pkg\> | Remove dependency |
| yarn up \<pkg\> | Update dependency |
| yarn up --all | Update all |

### Information Viewing

| Command | Description |
|---------|-------------|
| yarn list | List dependencies |
| yarn list --level=0 | Top-level dependencies |
| yarn outdated | Outdated dependencies |
| yarn info \<pkg\> | Package information |
| yarn why \<pkg\> | Dependency reason |

### Script Running

| Command | Description |
|---------|-------------|
| yarn run \<script\> | Run script |
| yarn dev | Run dev script |
| yarn build | Run build script |
| yarn test | Run test script |

### Cache Management

| Command | Description |
|---------|-------------|
| yarn cache dir | Cache directory |
| yarn cache list | List cache |
| yarn cache clean | Clean cache |

### Workspaces

| Command | Description |
|---------|-------------|
| yarn workspace \<name\> add | Add to workspace |
| yarn workspace \<name\> run | Run script in workspace |
| yarn workspaces foreach | Run in all workspaces |
| yarn workspaces list | List workspaces |

---

## Best Practices

### Development Workflow

1. **Daily updates**: Regularly run yarn up to keep dependencies updated
2. **Pre-release checks**: Run yarn install --immutable to ensure lockfile is correct
3. **Clean cache**: Periodically run yarn cache clean to free space

### CI/CD Integration

```bash
# Use hardened mode in CI
yarn install --immutable

# Or use Zero-Installs
yarn install --immutable --immutable-cache
```

### Security Best Practices

1. Run security audits regularly: yarn npm audit
2. Use private registries for sensitive dependencies
3. Review third-party plugin sources

---

## Related Resources

- [FAQ](./4.FAQ.md)
- [Official Documentation](https://yarnpkg.com/docs)
- [CLI Reference](https://yarnpkg.com/cli)
- [Configuration Reference](https://yarnpkg.com/configuration)
