# Kubernetes 常见问题

本章节汇总了 Kubernetes 使用中的常见问题。

## 集群问题

### Q1: 节点 NotReady

**问题描述：**
节点状态为 NotReady。

**解决方案：**
```bash
# 查看节点详情
kubectl describe node nodename

# 检查 kubelet 状态
systemctl status kubelet

# 检查日志
journalctl -u kubelet -n 100

# 重启 kubelet
systemctl restart kubelet
```

### Q2: 集群无法启动

**解决方案：**
```bash
# 重置集群
kubeadm reset

# 重新初始化
kubeadm init

# 如果使用 flannel
kubectl delete -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

## Pod 问题

### Q3: Pod 无法启动

**解决方案：**
```bash
# 查看 Pod 状态
kubectl get pods
kubectl describe pod podname

# 查看日志
kubectl logs podname
kubectl logs podname -c containername

# 检查事件
kubectl get events
```

### Q4: Pod 一直处于 Pending

**解决方案：**
```bash
# 检查资源是否足够
kubectl describe node

# 检查是否有污点
kubectl get node -o json | jq '.items[].spec.taints'

# 检查 PVC
kubectl get pvc
```

### Q5: Pod 循环重启

**解决方案：**
```bash
# 检查探针配置
kubectl describe pod podname | grep -A 10 "Liveness"

# 检查日志
kubectl logs --previous podname
```

## 网络问题

### Q6: Service 无法访问

**解决方案：**
```bash
# 检查 Endpoints
kubectl get endpoints

# 检查 DNS
kubectl exec -it podname -- nslookup service-name

# 检查网络策略
kubectl get networkpolicies
```

### Q7: Ingress 不工作

**解决方案：**
```bash
# 检查 Ingress 控制器
kubectl get pods -n ingress-nginx

# 检查 Ingress 配置
kubectl describe ingress ingressname

# 查看日志
kubectl logs -n ingress-nginx deploy/ingress-nginx-controller
```

## 存储问题

### Q8: PVC 一直 Pending

**解决方案：**
```bash
# 检查 StorageClass
kubectl get storageclass

# 检查 PV
kubectl get pv

# 检查 PVC 事件
kubectl describe pvc pvcname
```

### Q9: 存储挂载失败

**解决方案：**
```bash
# 检查 Pod 事件
kubectl describe pod podname

# 检查挂载的 PV
kubectl get pv pvname
```

## 资源问题

### Q10: 资源不足

**解决方案：**
```bash
# 查看节点资源
kubectl describe node

# 检查资源配额
kubectl get resourcequota

# 增加资源或删除无用 Pod
```

### Q11: OOMKilled

**解决方案：**
```yaml
# 增加资源限制
resources:
  limits:
    memory: "512Mi"
  requests:
    memory: "256Mi"
```

## 更新和回滚

### Q12: 更新失败

**解决方案：**
```bash
# 查看更新状态
kubectl rollout status deployment/deploymentname

# 查看历史
kubectl rollout history deployment/deploymentname

# 回滚
kubectl rollout undo deployment/deploymentname

# 回滚到指定版本
kubectl rollout undo deployment/deploymentname --to-revision=2
```

## 安全问题

### Q13: 权限不足

**解决方案：**
```bash
# 检查 RBAC
kubectl auth can-i get pods --as=system:serviceaccount:namespace:sa-name

# 创建 Role 和 RoleBinding
kubectl apply -f role.yaml
```

### Q14: 镜像拉取失败

**解决方案：**
```bash
# 使用私有仓库
imagePullSecrets:
- name: myregsecret

# 创建 Secret
kubectl create secret docker-registry myregsecret \
  --docker-server=registry.example.com \
  --docker-username=user \
  --docker-password=password
```

## 监控问题

### Q15: 无法查看日志

**解决方案：**
```bash
# 确认日志驱动配置
kubectl logs podname --tail=100

# 检查日志插件
kubectl get pods -n kube-system
```

### Q16: 指标无法获取

**解决方案：**
```bash
# 检查 Metrics Server
kubectl get pods -n kube-system | grep metrics

# 部署 Metrics Server
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

## Helm 问题

### Q17: Helm 释放失败

**解决方案：**
```bash
# 查看 Helm 状态
helm status release-name

# 查看历史
helm history release-name

# 回滚
helm rollback release-name 1
```

### Q18: Chart 不兼容

**解决方案：**
```bash
# 查看 Chart 信息
helm show chart chartname

# 搜索兼容版本
helm search repo chartname --version
```

## 总结

本章节涵盖了 Kubernetes 使用中的常见问题：

- **集群**：节点 NotReady、无法启动
- **Pod**：无法启动、Pending、重启
- **网络**：Service、Ingress
- **存储**：PVC、挂载
- **资源**：不足、OOM
- **更新**：失败、回滚
- **安全**：权限、镜像拉取
- **监控**：日志、指标
- **Helm**：释放、版本

如需更多信息，请参考官方文档：https://kubernetes.io/docs/
