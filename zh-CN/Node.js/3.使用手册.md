# Node.js 使用手册

本手册介绍 Node.js 的核心概念和实际使用方法。

## 基础语法

### 模块系统

```javascript
// CommonJS 导入
const fs = require('fs');
const path = require('path');
const http = require('http');

// ES Modules 导入
import fs from 'fs';
import path from 'path';
import http from 'http';
```

### 全局对象

```javascript
// console
console.log('信息');
console.error('错误');
console.warn('警告');
console.debug('调试');

// process
console.log(process.version);
console.log(process.platform);
console.log(process.env);

// __dirname 和 __filename
console.log(__dirname);
console.log(__filename);
```

## 文件系统

### 读取文件

```javascript
const fs = require('fs');

// 异步读取
fs.readFile('file.txt', 'utf8', (err, data) => {
  if (err) throw err;
  console.log(data);
});

// 同步读取
const data = fs.readFileSync('file.txt', 'utf8');

// Promise 方式
const { promisify } = require('util');
const readFile = promisify(fs.readFile);
const data = await readFile('file.txt', 'utf8');

// Node.js 10+ 推荐
const fs = require('fs').promises;
const data = await fs.readFile('file.txt', 'utf8');
```

### 写入文件

```javascript
const fs = require('fs').promises;

// 异步写入
await fs.writeFile('output.txt', 'Hello World!', 'utf8');

// 追加内容
await fs.appendFile('output.txt', '\n新内容', 'utf8');
```

### 文件操作

```javascript
const fs = require('fs').promises;

// 检查文件是否存在
const exists = await fs.access('file.txt');

// 创建目录
await fs.mkdir('dir', { recursive: true });

// 读取目录
const files = await fs.readdir('dir');

// 删除文件
await fs.unlink('file.txt');

// 删除目录
await fs.rmdir('dir', { recursive: true });
```

## HTTP 服务器

### 基本服务器

```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Hello World!');
});

server.listen(3000, () => {
  console.log('服务器运行在 http://localhost:3000/');
});
```

### 处理不同路由

```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  const url = req.url;
  const method = req.method;
  
  if (url === '/' && method === 'GET') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end('<h1>首页</h1>');
  } else if (url === '/api' && method === 'GET') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ message: 'API' }));
  } else {
    res.writeHead(404);
    res.end('404 Not Found');
  }
});

server.listen(3000);
```

### 使用 Express

```javascript
const express = require('express');
const app = express();

app.get('/', (req, res) => {
  res.send('Hello World!');
});

app.get('/api/users', (req, res) => {
  res.json([
    { id: 1, name: 'Tom' },
    { id: 2, name: 'Jerry' }
  ]);
});

app.post('/api/users', (req, res) => {
  // 处理 POST 请求
  res.status(201).json({ message: '创建成功' });
});

app.listen(3000, () => {
  console.log('服务器运行在端口 3000');
});
```

## 路径处理

```javascript
const path = require('path');

// 路径拼接
const fullPath = path.join(__dirname, 'views', 'index.html');

// 获取文件名
const filename = path.basename('/foo/bar/baz.html');

// 获取扩展名
const ext = path.extname('file.txt');

// 解析路径
const parsed = path.parse('/foo/bar/baz.txt');
// { root: '/', dir: '/foo/bar', base: 'baz.txt', ext: '.txt', name: 'baz' }

// 路径格式化
const formatted = path.format({
  dir: '/foo/bar',
  name: 'baz',
  ext: '.txt'
});
```

## URL 处理

```javascript
const url = require('url');
const { URL } = url;

// 解析 URL
const myUrl = new URL('http://example.com:8080/path?name=Tom&age=25');

console.log(myUrl.hostname); // example.com
console.log(myUrl.pathname); // /path
console.log(myUrl.search);   // ?name=Tom&age=25
console.log(myUrl.searchParams.get('name')); // Tom
```

## Events 事件

```javascript
const EventEmitter = require('events');

class MyEmitter extends EventEmitter {}

const myEmitter = new MyEmitter();

myEmitter.on('event', () => {
  console.log('事件触发');
});

myEmitter.emit('event');
```

## Stream 流

### 读取流

```javascript
const fs = require('fs');

const readStream = fs.createReadStream('file.txt', 'utf8');

readStream.on('data', (chunk) => {
  console.log('接收到数据:', chunk);
});

readStream.on('end', () => {
  console.log('读取完成');
});

readStream.on('error', (err) => {
  console.error('错误:', err);
});
```

### 写入流

```javascript
const fs = require('fs');

const writeStream = fs.createWriteStream('output.txt');

writeStream.write('第一行\n');
writeStream.write('第二行\n');
writeStream.end('最后一行');

writeStream.on('finish', () => {
  console.log('写入完成');
});
```

### 管道

```javascript
const fs = require('fs');

const readStream = fs.createReadStream('input.txt');
const writeStream = fs.createWriteStream('output.txt');

readStream.pipe(writeStream);
```

## Buffer 二进制

```javascript
// 创建 Buffer
const buf = Buffer.alloc(10);
const buf2 = Buffer.from('Hello');
const buf3 = Buffer.allocUnsafe(10);

// 字符串转换
const str = buf2.toString('utf8');

// 写入
buf.write('Hello', 0, 'utf8');

// 读取
console.log(buf.toString());
```

## Promise 和异步

### async/await

```javascript
const fs = require('fs').promises;

async function readFiles() {
  try {
    const data = await fs.readFile('file1.txt', 'utf8');
    console.log(data);
  } catch (err) {
    console.error('读取失败:', err);
  }
}

readFiles();
```

### 并发执行

```javascript
const fs = require('fs').promises;

async function readAll() {
  const [file1, file2, file3] = await Promise.all([
    fs.readFile('file1.txt', 'utf8'),
    fs.readFile('file2.txt', 'utf8'),
    fs.readFile('file3.txt', 'utf8')
  ]);
  
  console.log(file1, file2, file3);
}

readAll();
```

## NPM 包使用

### express

```javascript
const express = require('express');
const app = express();

// 中间件
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 路由
app.get('/', (req, res) => {
  res.send('Hello');
});

// 路由参数
app.get('/user/:id', (req, res) => {
  res.send(`用户 ID: ${req.params.id}`);
});

// 查询参数
app.get('/search', (req, res) => {
  res.send(`搜索: ${req.query.q}`);
});

app.listen(3000);
```

### axios

```javascript
const axios = require('axios');

async function fetchData() {
  try {
    const response = await axios.get('https://api.example.com/data');
    console.log(response.data);
    
    // POST 请求
    const postResponse = await axios.post('https://api.example.com/create', {
      name: 'Tom'
    });
    console.log(postResponse.data);
  } catch (error) {
    console.error('请求失败:', error);
  }
}

fetchData();
```

### moment

```javascript
const moment = require('moment');

console.log(moment().format('YYYY-MM-DD HH:mm:ss'));
console.log(moment().add(1, 'days').format('YYYY-MM-DD'));
console.log(moment('2024-01-01').fromNow());
```

## 命令行参数

```javascript
// process.argv
console.log(process.argv);
// [node路径, 脚本路径, 参数1, 参数2, ...]

// 解析参数
const args = process.argv.slice(2);
// args = ['--name=Tom', '--age=25']
```

## 环境变量

```javascript
// 读取环境变量
const port = process.env.PORT || 3000;
const env = process.env.NODE_ENV;

// 设置环境变量
// Windows: set PORT=3000
// Linux/macOS: PORT=3000
```

## 异常处理

```javascript
// try-catch
try {
  // 可能出错的代码
} catch (err) {
  console.error('错误:', err);
}

// 未捕获的异常
process.on('uncaughtException', (err) => {
  console.error('未捕获的异常:', err);
});

// Promise 拒绝
process.on('unhandledRejection', (reason, promise) => {
  console.error('未处理的 Promise 拒绝:', reason);
});
```

## 总结

本手册涵盖了 Node.js 开发的核心知识点：

- **模块系统**：CommonJS、ES Modules
- **文件系统**：读取、写入、操作
- **HTTP**：创建服务器、处理路由
- **路径**：path 模块
- **URL**：url 模块
- **事件**：EventEmitter
- **流**：读取流、写入流、管道
- **Buffer**：二进制数据
- **异步**：Promise、async/await
- **NPM**：常用包使用
- **命令行**：参数解析、环境变量

掌握这些内容后，你就可以开始 Node.js 项目开发了。
