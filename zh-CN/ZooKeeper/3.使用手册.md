# ZooKeeper 使用手册

## 命令行操作

### 连接

```bash
zkCli.sh -server localhost:2181
```

### 基础操作

```bash
# 创建节点
create /myapp "data"
create -e /temp "temp"    # 临时节点
create -s /seq "data"     # 顺序节点

# 获取数据
get /myapp

# 设置数据
set /myapp "newdata"

# 删除节点
delete /myapp

# 列出子节点
ls /myapp
```

### 监听

```bash
# 监听节点变化
get -w /myapp

# 监听子节点变化
ls -w /myapp
```

## Java API

### Maven 依赖

```xml
<dependency>
    <groupId>org.apache.zookeeper</groupId>
    <artifactId>zookeeper</artifactId>
    <version>3.7.2</version>
</dependency>
```

### 基本操作

```java
ZooKeeper zk = new ZooKeeper("localhost:2181", 3000, watchedEvent -> {
    System.out.println("Event: " + watchedEvent);
});

// 创建
zk.create("/myapp", "data".getBytes(), 
    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);

// 获取
byte[] data = zk.getData("/myapp", false, null);
System.out.println(new String(data));

// 更新
zk.setData("/myapp", "newdata".getBytes(), -1);

// 删除
zk.delete("/myapp", -1);

// 关闭
zk.close();
```

### 分布式锁

```java
public class DistributedLock {
    
    private ZooKeeper zk;
    private String lockPath;
    
    public boolean lock() throws Exception {
        lockPath = zk.create("/lock/lock-", null, 
            ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
        
        // 检查是否是最小序号
        List<String> locks = zk.getChildren("/lock", false);
        Collections.sort(locks);
        
        return lockPath.endsWith(locks.get(0));
    }
    
    public void unlock() throws Exception {
        zk.delete(lockPath, -1);
    }
}
```

##  curator 框架

```java
CuratorFramework cf = CuratorFrameworkFactory.newClient(
    "localhost:2181", new RetryUntilElapsed(1000, 3));
cf.start();

// 分布式锁
InterProcessMutex lock = new InterProcessMutex(cf, "/mylock");
lock.acquire();
// 业务逻辑
lock.release();
```
