# ZooKeeper Installation Guide

This guide provides detailed instructions for installing ZooKeeper on all major platforms.

---

## Table of Contents

- [Installation Methods](#installation-methods)
- [Standalone Installation](#standalone-installation)
- [Docker Installation](#docker-installation)
- [Cluster (Quorum) Setup](#cluster-quorum-setup)
- [Configuration](#configuration)
- [Starting ZooKeeper](#starting-zookeeper)
- [Verification](#verification)
- [Uninstall ZooKeeper](#uninstall-zookeeper)

---

## Installation Methods

| Method | Description | Best For |
|--------|-------------|----------|
| **Standalone** | Single server | Development, testing |
| **Docker** | Containerized | Quick deployment |
| **Cluster (Quorum)** | Multi-server | Production |

---

## Standalone Installation

### Prerequisites

- Java 8 or higher
- Linux/macOS/Windows

### Download ZooKeeper

```bash
# Download latest stable version (3.9.x)
wget https://dlcdn.apache.org/zookeeper/zookeeper-3.9.3/zookeeper-3.9.3.tar.gz

# Extract
tar -xzf zookeeper-3.9.3.tar.gz

# Move to /opt
sudo mv zookeeper-3.9.3 /opt/zookeeper
```

### Configure Environment

```bash
# Add to ~/.bashrc
cat >> ~/.bashrc << 'EOF'

# ZooKeeper Environment
export ZOOKEEPER_HOME=/opt/zookeeper
export PATH=$PATH:$ZOOKEEPER_HOME/bin
EOF

source ~/.bashrc
```

### Create Configuration File

```bash
# Create configuration
nano $ZOOKEEPER_HOME/conf/zoo.cfg
```

```properties
# Basic settings
tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181

# Logging
admin.enableServer=true
admin.serverPort=8080
```

### Create Data Directory

```bash
sudo mkdir -p /var/lib/zookeeper
sudo chown -R $USER:$USER /var/lib/zookeeper
```

---

## Docker Installation

### Quick Start

```bash
# Run ZooKeeper
docker run -d \
  --name zookeeper \
  -p 2181:2181 \
  -p 8080:8080 \
  -v zookeeper-data:/data \
  confluentinc/cp-zookeeper:7.5.0
```

### With Custom Configuration

```bash
# Create configuration file
cat > zoo.cfg << 'EOF'
tickTime=2000
dataDir=/data
dataLogDir=/data/log
clientPort=2181
maxClientCnxns=60
initLimit=10
syncLimit=5
admin.enableServer=true
admin.serverPort=8080
EOF

# Run with custom config
docker run -d \
  --name zookeeper \
  -p 2181:2181 \
  -p 8080:8080 \
  -v $(pwd)/zoo.cfg:/etc/zookeeper/zoo.cfg \
  -v zookeeper-data:/data \
  confluentinc/cp-zookeeper:7.5.0
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| ZOOKEEPER_CLIENT_PORT | Client port | 2181 |
| ZOOKEEPER_TICK_TIME | Tick time | 2000 |
| ZOOKEEPER_INIT_LIMIT | Init limit | 10 |
| ZOOKEEPER_SYNC_LIMIT | Sync limit | 5 |

---

## Cluster (Quorum) Setup

### Architecture

```
ZooKeeper Server 1 (Leader)
        |
        +-- ZooKeeper Server 2 (Follower)
        +-- ZooKeeper Server 3 (Follower)
```

### Configuration

Create `zoo.cfg` on each server:

```properties
tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181
initLimit=10
syncLimit=5

# Server definitions
server.1=zoo1:2888:3888
server.2=zoo2:2888:3888
server.3=zoo3:2888:3888
```

### Configure Server ID

On each server, create `myid` file in dataDir:

```bash
# Server 1
echo "1" > /var/lib/zookeeper/myid

# Server 2
echo "2" > /var/lib/zookeeper/myid

# Server 3
echo "3" > /var/lib/zookeeper/myid
```

### Configure Hosts

Add to `/etc/hosts`:

```
192.168.1.101 zoo1
192.168.1.102 zoo2
192.168.1.103 zoo3
```

### Firewall Configuration

```bash
# Open ports on each server
sudo firewall-cmd --permanent --add-port=2181/tcp
sudo firewall-cmd --permanent --add-port=2888/tcp
sudo firewall-cmd --permanent --add-port=3888/tcp
sudo firewall-cmd --reload
```

---

## Configuration Options

### Basic Options

| Option | Description | Default |
|--------|-------------|---------|
| tickTime | Basic time unit (ms) | 2000 |
| dataDir | Data directory | /tmp/zookeeper |
| clientPort | Client port | 2181 |
| maxClientCnxns | Max client connections | 60 |

### Cluster Options

| Option | Description | Default |
|--------|-------------|---------|
| initLimit | Init timeout | 10 |
| syncLimit | Sync timeout | 2 |
| quorumListenOnAllIPs | Listen on all IPs | false |

### Ports

| Port | Purpose |
|------|---------|
| 2181 | Client connections |
| 2888 | Peer communication |
| 3888 | Leader election |
| 8080 | Admin server |

---

## Starting ZooKeeper

### Start Standalone

```bash
# Start ZooKeeper
$ZOOKEEPER_HOME/bin/zkServer.sh start

# Check status
$ZOOKEEPER_HOME/bin/zkServer.sh status

# Stop ZooKeeper
$ZOOKEEPER_HOME/bin/zkServer.sh stop

# Restart
$ZOOKEEPER_HOME/bin/zkServer.sh restart
```

### Start Cluster

```bash
# Start on each server
zkServer.sh start

# Check status
zkServer.sh status
```

### Start with Docker

```bash
# Start
docker start zookeeper

# Stop
docker stop zookeeper

# View logs
docker logs -f zookeeper
```

---

## Verification

### Check Running Process

```bash
# Check Java processes
jps | grep ZooKeeper

# Or use ps
ps aux | grep zookeeper
```

### Connect to ZooKeeper

```bash
# Connect using CLI
$ZOOKEEPER_HOME/bin/zkCli.sh -server localhost:2181

# Docker
docker exec -it zookeeper zkCli.sh -server localhost:2181
```

### Basic Commands

```bash
# List root znodes
ls /

# Create znode
create /test "hello"

# Get data
get /test

# Set data
set /test "world"

# Delete znode
delete /test
```

### Check Cluster Status

```bash
# In zkCli.sh
ruok

# Should return "imok" if healthy
```

### Admin Web Interface

```
http://localhost:8080/commands
```

---

## Logging

### Default Logging

```bash
# Logs location
$ZOOKEEPER_HOME/logs/

# View logs
tail -f $ZOOKEEPER_HOME/logs/zookeeper.out
```

### Configure Logging

Edit `logback.xml` in `$ZOOKEEPER_HOME/conf/`:

```xml
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n</pattern>
        </encoder>
    </appender>
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

---

## Uninstall ZooKeeper

### Standalone

```bash
# Stop ZooKeeper
$ZOOKEEPER_HOME/bin/zkServer.sh stop

# Remove installation
sudo rm -rf /opt/zookeeper

# Remove data directory
sudo rm -rf /var/lib/zookeeper
```

### Docker

```bash
# Stop and remove container
docker stop zookeeper
docker rm zookeeper

# Remove volume
docker volume rm zookeeper-data
```

---

## Version Information

### Current Stable Version

- **ZooKeeper 3.9.3** (Latest stable)
- Requires Java 8+

### Version History

| Version | Release | Notes |
|---------|---------|-------|
| 3.9.x | 2023+ | Latest stable |
| 3.8.x | 2021 | LTS |
| 3.7.x | 2021 | Previous stable |
| 3.6.x | 2020 | Previous LTS |

---

## Next Steps

- [Usage Guide](./2.使用指南.md)
- [ZooKeeper Official Documentation](https://zookeeper.apache.org/doc/current/)
