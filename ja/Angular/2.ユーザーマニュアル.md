# Angular ユーザーマニュアル

この手册では、Angular 開発のすべての側面を基礎から上級までカバーします。

---

## 目次

1. [はじめに](#はじめに)
2. [プロジェクト構造](#プロジェクト構造)
3. [コンポーネント](#コンポーネント)
4. [テンプレート](#テンプレート)
5. [サービス](#サービス)
6. [ルーティング](#ルーティング)
7. [フォーム](#フォーム)
8. [HTTP クライアント](#http-クライアント)
9. [状態管理](#状態管理)
10. [テスト](#テスト)
11. [ビルドとデプロイ](#ビルドとデプロイ)
12. [ベストプラクティス](#ベストプラクティス)

---

## はじめに

### Angular とは？

Angular は、Google によって開発された TypeScript ベースのオープンソース Web アプリケーションフレームワークです。現代のシングルページアプリケーション（SPA）を構築するための包括的なソリューションを提供します。

### 主な機能

- **コンポーネントベースのアーキテクチャ**：再利用可能なコンポーネントでアプリケーションを構築
- **双方向データバインディング**：モデルとビューの自動同期
- **依存性注入**：効率的なサービス管理
- **ルーティング**：クライアントサイドナビゲーション
- **フォーム**：堅牢なフォーム処理とバリデーション
- **HTTP クライアント**：バックエンドサービスとの通信
- **テスト**：組み込みのテストユーティリティ
- **クロスプラットフォーム**：Web、モバイル Web、ネイティブモバイル、デスクトップ

---

## プロジェクト構造

### 標準ディレクトリ構造

```
my-app/
├── src/
│   ├── app/
│   │   ├── components/        # 再利用可能なコンポーネント
│   │   ├── pages/             # ページレベルのコンポーネント
│   │   ├── services:          # Angular サービス
│   │   ├── models/            # データモデル/インターフェース
│   │   ├── guards/            # ルートガード
│   │   ├── interceptors/      # HTTP インタ셉タ
│   │   ├── pipes/             # カスタムパイプ
│   │   ├── directives/        # カスタムディレクティブ
│   │   ├── app.component.ts  # ルートコンポーネント
│   │   ├── app.config.ts     # アプリケーション設定（スタンドアロン）
│   │   ├── app.routes.ts     # アプリケーションルート
│   │   └── main.ts           # アプリケーションエントリポイント
│   ├── assets/               # 静的ファイル
│   ├── environments/         # 環境設定
│   ├── styles.css            # グローバルスタイル
│   └── index.html            # メイン HTML ファイル
├── angular.json              # Angular CLI 設定
├── package.json              # NPM 依存関係
└── tsconfig.json             # TypeScript 設定
```

---

## コンポーネント

### コンポーネントの作成

```bash
# Angular CLI を使用
ng generate component components/user-list
# または
ng g c components/user-list
```

### コンポーネントの例

```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-user-card',
  templateUrl: './user-card.component.html',
  styleUrls: ['./user-card.component.css']
})
export class UserCardComponent {
  @Input() user: User | null = null;
  @Output() delete = new EventEmitter<number>();

  onDelete() {
    if (this.user) {
      this.delete.emit(this.user.id);
    }
  }
}
```

### ライフサイクルフック

```typescript
import { Component, OnInit, OnDestroy, AfterViewInit } from '@angular/core';

@Component({...})
export class ExampleComponent implements OnInit, OnDestroy, AfterViewInit {
  
  ngOnInit() {
    // コンポーネントの初期化後に1回呼び出される
  }

  ngAfterViewInit() {
    // コンポーネントのビューが初期化された後に呼び出される
  }

  ngOnDestroy() {
    // コンポーネントが破棄される直前に呼び出される
    // サブスクリプションやタイマーのクリーンアップ
  }
}
```

### スタンドアロンコンポーネント（Angular 14+）

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-standalone',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <h1>{{ title }}</h1>
    <button (click)="onClick()">クリック</button>
  `
})
export class StandaloneComponent {
  title = 'スタンドアロンコンポーネント';
}
```

---

## テンプレート

### テンプレート構文

#### 補間
```html
<h1>こんにちは、{{ name }}さん</h1>
<p>合計：{{ 2 + 3 }}</p>
```

#### プロパティバインディング
```html
<img [src]="imageUrl" [alt]="imageAlt">
<button [class.active]="isActive">クリック</button>
```

#### イベントバインディング
```html
<button (click)="onClick()">クリック</button>
<input (input)="onInput($event)">
```

#### 双方向バインディング
```html
<input [(ngModel)]="username" name="username">
```

### 構造ディレクティブ

#### *ngIf
```html
<div *ngIf="isLoggedIn">
  ようこそ、{{ username }}さん！
</div>

<div *ngIf="isLoggedIn; else loggedOut">ようこそ！</div>
<ng-template #loggedOut>ログインしてください。</ng-template>
```

#### *ngFor
```html
<li *ngFor="let user of users; let i = index">
  {{ i + 1 }}. {{ user.name }}
</li>

<!-- trackBy を使用してパフォーマンスを向上 -->
<li *ngFor="let user of users; trackBy: trackById">
```

#### *ngSwitch
```html
<div [ngSwitch]="status">
  <p *ngSwitchCase="'pending'">処理中...</p>
  <p *ngSwitchCase="'approved'">承認済み！</p>
  <p *ngSwitchDefault>不明なステータス</p>
</div>
```

### パイプ

```html
<p>{{ today | date:'fullDate' }}</p>
<p>{{ price | currency:'JPY' }}</p>
<p>{{ name | uppercase }}</p>
<p>{{ text | slice:0:10 }}</p>
```

---

## サービス

### サービスの作成

```bash
ng generate service services/user
# または
ng g s services/user
```

### サービスの例

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { User } from '../models/user';

@Injectable({ providedIn: 'root' })
export class UserService {
  private apiUrl = 'https://api.example.com/users';

  constructor(private http: HttpClient) {}

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl);
  }

  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`);
  }

  createUser(user: User): Observable<User> {
    return this.http.post<User>(this.apiUrl, user);
  }

  updateUser(id: number, user: User): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user);
  }

  deleteUser(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

---

## ルーティング

### ルート設定

```typescript
// app.routes.ts
import { Routes } from '@angular/router';

export const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { 
    path: 'home', 
    loadComponent: () => import('./pages/home/home.component')
      .then(m => m.HomeComponent) 
  },
  { 
    path: 'users', 
    loadComponent: () => import('./pages/users/users.component')
      .then(m => m.UsersComponent) 
  },
  { 
    path: '**', 
    loadComponent: () => import('./pages/not-found/not-found.component')
      .then(m => m.NotFoundComponent) 
  }
];
```

### ルートパラメータ

```typescript
// ルート定義：{ path: 'user/:id', ... }

// コンポーネント内
import { ActivatedRoute } from '@angular/router';

constructor(private route: ActivatedRoute) {}

ngOnInit() {
  this.route.paramMap.subscribe(params => {
    const id = params.get('id');
  });
}
```

### ルートガード

```typescript
import { Injectable } from '@angular/core';
import { CanActivate, Router } from '@angular/router';

@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(private router: Router) {}

  canActivate(): boolean {
    const isLoggedIn = /* ログイン状態の確認 */;
    if (!isLoggedIn) {
      this.router.navigate(['/login']);
      return false;
    }
    return true;
  }
}
```

### 遅延読み込み

```typescript
{
  path: 'dashboard',
  loadComponent: () => import('./dashboard/dashboard.component')
    .then(m => m.DashboardComponent)
}
```

---

## フォーム

### テンプレート駆動フォーム

```typescript
import { Component } from '@angular/core';

@Component({
  selector: 'app-login',
  template: `
    <form #loginForm="ngForm" (ngSubmit)="onSubmit(loginForm)">
      <input type="email" [(ngModel)]="user.email" name="email" required email>
      <input type="password" [(ngModel)]="user.password" name="password" required minlength="6">
      <button type="submit" [disabled]="loginForm.invalid">ログイン</button>
    </form>
  `
})
export class LoginComponent {
  user = { email: '', password: '' };

  onSubmit(form: any) {
    console.log('フォームの値：', form.value);
  }
}
```

### リアクティブフォーム

```typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html'
})
export class RegisterComponent implements OnInit {
  registerForm!: FormGroup;

  constructor(private fb: FormBuilder) {}

  ngOnInit() {
    this.registerForm = this.fb.group({
      username: ['', [Validators.required, Validators.minLength(3)]],
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(8)]]
    });
  }

  onSubmit() {
    if (this.registerForm.valid) {
      console.log(this.registerForm.value);
    }
  }
}
```

```html
<form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
  <input formControlName="username">
  <div *ngIf="registerForm.get('username')?.invalid">ユーザー名は必須です</div>
  <button type="submit" [disabled]="registerForm.invalid">登録</button>
</form>
```

---

## HTTP クライアント

### 設定

```typescript
// app.config.ts（スタンドアロン）
import { ApplicationConfig } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';

export const appConfig: ApplicationConfig = {
  providers: [provideHttpClient()]
};
```

### HTTP メソッド

```typescript
constructor(private http: HttpClient) {}

// GET
this.http.get<User[]>(url).subscribe(data => console.log(data));

// POST
this.http.post<User>(url, user).subscribe(newUser => ...);

// PUT
this.http.put<User>(`${url}/${id}`, user).subscribe();

// DELETE
this.http.delete(`${url}/${id}`).subscribe();
```

### HTTP インタ셉タ

```typescript
import { HttpInterceptorFn } from '@angular/common/http';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const token = localStorage.getItem('token');
  const cloned = req.clone({
    setHeaders: { Authorization: token ? `Bearer ${token}` : '' }
  });
  return next(cloned);
};
```

---

## 状態管理

### サービスと BehaviorSubject の使用

```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class CartService {
  private items$ = new BehaviorSubject<CartItem[]>([]);
  
  getItems(): Observable<CartItem[]> {
    return this.items$.asObservable();
  }
  
  addItem(item: CartItem) {
    this.items$.next([...this.items$.value, item]);
  }
  
  removeItem(id: number) {
    this.items$.next(this.items$.value.filter(i => i.id !== id));
  }
}
```

### Signals の使用（Angular 16+）

```typescript
import { Component, signal, computed } from '@angular/core';

@Component({...})
export class CounterComponent {
  count = signal(0);
  doubled = computed(() => this.count() * 2);
  
  increment() {
    this.count.update(c => c + 1);
  }
}
```

---

## テスト

### ユニットテスト

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { UserListComponent } from './user-list.component';
import { UserService } from '../services/user.service';
import { of } from 'rxjs';

describe('UserListComponent', () => {
  let component: UserListComponent;
  let fixture: ComponentFixture<UserListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [UserListComponent],
      providers: [
        { provide: UserService, useValue: jasmine.createSpyObj('UserService', ['getUsers']) }
      ]
    }).compileComponents();

    fixture = TestBed.createComponent(UserListComponent);
    component = fixture.componentInstance;
  });

  it('作成されるべき', () => {
    expect(component).toBeTruthy();
  });

  it('ユーザーを読み込むべき', () => {
    const userService = TestBed.inject(UserService);
    userService.getUsers.and.returnValue(of([{ id: 1, name: '田中' }]));
    
    component.ngOnInit();
    
    expect(component.users.length).toBe(1);
  });
});
```

---

## ビルドとデプロイ

### 開発ビルド
```bash
ng build
ng serve
```

### 本番ビルド
```bash
ng build --configuration production
# または
ng build -c production
```

### デプロイオプション

#### Netlify
```bash
npm install -g netlify-cli
netlify deploy --prod --dir=dist/your-app
```

#### Vercel
```bash
npm i -g vercel
vercel --prod
```

#### Docker
```dockerfile
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build -- --configuration production

FROM nginx:alpine
COPY --from=build /app/dist/your-app/browser /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## ベストプラクティス

### プロジェクト構造
```
src/app/
├── core/           # シングルトンサービス、ガード
├── shared/         # 再利用可能なコンポーネント、パイプ、ディレクティブ
├── features/       # 機能モジュール
└── app.component.ts
```

### パフォーマンスのヒント
1. OnPush 変更検出を使用
2. *ngFor で trackBy を実装
3. ルートを遅延読み込み
4. シグナルで状態を管理
5. observable のサブスクリプションを解除（または async パイプを使用）

### コードスタイル
- 厳格な TypeScript を使用
- Angular スタイルガイドに従う
- スタンドアロンコンポーネントを使用
- コンポーネントを小さく保つ

---

## その他のリソース

- 公式サイト：https://angular.io/
- ドキュメント：https://angular.io/docs
- CLI リファレンス：https://angular.io/cli
- GitHub：https://github.com/angular/angular

---

*最終更新：2024*
