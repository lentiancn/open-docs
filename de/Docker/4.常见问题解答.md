# Docker 常见问题解答

本页面汇总了 Docker 使用过程中最常见的问题及解决方案。

---

## 目录

1. [安装问题](#安装问题)
2. [镜像问题](#镜像问题)
3. [容器问题](#容器问题)
4. [网络问题](#网络问题)
5. [数据卷问题](#数据卷问题)
6. [性能问题](#性能问题)
7. [Docker Compose 问题](#docker-compose-问题)
8. [授权与订阅](#授权与订阅)

---

## 安装问题

### Q1: Docker Desktop 在 Windows 上启动失败

**可能原因**：
- WSL 或 Hyper-V 未启用
- 虚拟化未在 BIOS/UEFI 中启用

**解决方案**：

1. 检查虚拟化是否启用：
   ```powershell
   systeminfo | findstr /C:"Hyper-V"
   ```

2. 启用 WSL：
   ```powershell
   wsl --install
   ```

3. 确保 BIOS/UEFI 中已启用虚拟化

### Q2: Docker 权限被拒绝

**错误信息**：
```
permission denied while trying to connect to the Docker daemon socket
```

**解决方案**：

将当前用户添加到 docker 组：
```bash
sudo usermod -aG docker $USER
```

然后注销并重新登录。

### Q3: 端口冲突

**错误信息**：
```
Error starting userland proxy: listen tcp4 0.0.0.0:80: bind: address already in use
```

**解决方案**：

1. 查找占用端口的进程：
   ```bash
   # Linux
   sudo lsof -i :80
   
   # Windows
   netstat -ano | findstr :80
   ```

2. 停止占用端口的进程，或使用其他端口：
   ```bash
   docker run -d -p 8080:80 nginx
   ```

---

## 镜像问题

### Q4: 镜像拉取失败

**可能原因**：
- 网络问题
- 镜像仓库不可用
- 认证问题

**解决方案**：

1. 检查网络连接：
   ```bash
   docker pull hello-world
   ```

2. 配置镜像加速器（中国区）：
   ```bash
   # 编辑 Docker 配置
   sudo vi /etc/docker/daemon.json
   
   # 添加以下内容
   {
     "registry-mirrors": [
       "https://docker.mirrors.ustc.edu.cn",
       "https://hub-mirror.c.163.com"
     ]
   }
   
   # 重启 Docker
   sudo systemctl restart docker
   ```

3. 登录私有仓库：
   ```bash
   docker login myregistry.com
   ```

### Q5: 构建镜像失败

**常见错误**：
- 缓存问题
- 依赖安装失败
- 文件路径错误

**解决方案**：

1. 清除构建缓存：
   ```bash
   docker builder prune
   ```

2. 使用 `--no-cache` 强制重新构建：
   ```bash
   docker build --no-cache -t myapp .
   ```

3. 检查 Dockerfile 语法和路径

### Q6: 镜像体积过大

**解决方案**：

1. 使用多阶段构建
2. 使用轻量级基础镜像（如 alpine）
3. 清理不必要的文件：
   ```dockerfile
   RUN apt-get clean && rm -rf /var/lib/apt/lists/*
   ```

---

## 容器问题

### Q7: 容器无法启动

**解决方案**：

1. 查看容器日志：
   ```bash
   docker logs <container_name>
   ```

2. 检查容器配置：
   ```bash
   docker inspect <container_name>
   ```

3. 检查资源限制：
   ```bash
   docker stats <container_name>
   ```

### Q8: 容器自动停止

**可能原因**：
- 容器内进程完成
- 内存不足
- 健康检查失败

**解决方案**：

1. 使用 `-d` 守护进程模式：
   ```bash
   docker run -d myapp
   ```

2. 设置重启策略：
   ```bash
   docker run -d --restart=always myapp
   ```

### Q9: 进入容器后无法使用 vim/vi

**解决方案**：

安装文本编辑器：
```bash
apt-get update && apt-get install -y vim
```

或使用其他工具：
```bash
cat file.txt          # 查看文件
echo "text" > file   # 写入文件
```

### Q10: 容器内中文乱码

**解决方案**：

设置环境变量：
```dockerfile
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
```

---

## 网络问题

### Q11: 容器无法访问外部网络

**解决方案**：

1. 检查 Docker 网络：
   ```bash
   docker network ls
   docker network inspect bridge
   ```

2. 重启 Docker 服务：
   ```bash
   # Linux
   sudo systemctl restart docker
   
   # Windows
   # 重启 Docker Desktop
   ```

3. 检查防火墙规则

### Q12: 容器间无法通信

**解决方案**：

1. 确保容器在同一网络：
   ```bash
   docker network inspect my-network
   ```

2. 使用容器名称进行通信（需自定义网络）：
   ```bash
   docker network create my-network
   docker run --network my-network --name web webapp
   docker run --network my-network --name db dbapp
   # 现在 web 可以通过 db 访问 db
   ```

### Q13: 端口映射不生效

**解决方案**：

1. 检查端口是否正确映射：
   ```bash
   docker port <container>
   ```

2. 确认容器内服务监听地址：
   ```bash
   # 容器内执行
   netstat -tlnp
   # 确保监听 0.0.0.0 而非 127.0.0.1
   ```

---

## 数据卷问题

### Q14: 数据卷权限问题

**错误信息**：
```
permission denied while trying to connect to the docker socket
```

**解决方案**：

1. 挂载时指定用户：
   ```bash
   docker run -v /host/path:/container/path -u 1000 myapp
   ```

2. 在 Dockerfile 中设置权限：
   ```dockerfile
   RUN chown -R appuser:appuser /app/data
   ```

### Q15: 数据未持久化

**解决方案**：

1. 使用命名卷而非绑定挂载：
   ```bash
   docker run -v my-volume:/app/data myapp
   ```

2. 确保应用配置正确的写入路径

### Q16: 删除容器后数据丢失

**解决方案**：

1. 使用数据卷持久化数据：
   ```bash
   docker volume create my-data
   docker run -v my-data:/app/data myapp
   ```

2. 定期备份数据卷：
   ```bash
   docker run --rm -v my-data:/data -v $(pwd):/backup alpine tar czf /backup/backup.tar.gz /data
   ```

---

## 性能问题

### Q17: Docker 运行缓慢

**解决方案**：

1. 分配更多资源给 Docker Desktop：
   - Docker Desktop > Settings > Resources

2. 清理未使用的资源：
   ```bash
   docker system prune -a
   ```

3. 移动 Docker 数据目录到更大磁盘

### Q18: 磁盘空间不足

**解决方案**：

1. 清理未使用的镜像：
   ```bash
   docker image prune -a
   ```

2. 清理构建缓存：
   ```bash
   docker builder prune
   ```

3. 清理已停止的容器：
   ```bash
   docker container prune
   ```

4. 清理数据卷：
   ```bash
   docker volume prune
   ```

### Q19: 容器内存占用过高

**解决方案**：

1. 限制容器内存：
   ```bash
   docker run -m 512m myapp
   ```

2. 设置内存交换限制：
   ```bash
   docker run -m 512m --memory-swap 1g myapp
   ```

---

## Docker Compose 问题

### Q20: Docker Compose 无法启动

**解决方案**：

1. 检查 docker-compose.yml 语法：
   ```bash
   docker-compose config
   ```

2. 查看详细错误：
   ```bash
   docker-compose up
   ```

### Q21: 服务间依赖问题

**解决方案**：

使用 `depends_on` 并配置等待逻辑：
```yaml
services:
  web:
    build: .
    depends_on:
      db:
        condition: service_healthy
  db:
    image: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
```

### Q22: 环境变量未生效

**解决方案**：

1. 检查 .env 文件位置：
   - 必须放在运行 docker-compose 的目录下
   - 文件名必须为 `.env`

2. 在 docker-compose.yml 中引用：
   ```yaml
   services:
     web:
       image: myapp
       environment:
         - DB_HOST=${DB_HOST}
   ```

---

## 授权与订阅

### Q23: Docker Desktop 需要付费吗？

**免费用途**：
- 小型企业（员工少于 250 人且年收入低于 1000 万美元）
- 个人用途
- 教育用途
- 非商业开源项目

**付费用途**：
- 商业用途超过上述限制

详细信息请参阅 [Docker 订阅和定价](https://www.docker.com/pricing/)。

### Q24: 如何申请教育/开源免费许可？

1. 访问 [Docker Hub](https://hub.docker.com/)
2. 登录您的账户
3. 前往 Account Settings > Subscription
4. 选择适合您的免费计划

---

## 获取更多帮助

- [Docker 官方文档](https://docs.docker.com/)
- [Docker Community](https://www.docker.com/community/)
- [Docker Forums](https://forums.docker.com/)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/docker)
