# APISIX ユーザーマニュアル

APISIX のコア機能と使用ヒント。

## 基本概念

### 用語

- **Route**: リクエストマッチルールを定義
- **Upstream**: 実際のバックエンドサービス
- **Service**: ルートコレクション
- **Plugin**: リクエスト処理ロジック
- **Consumer**: API 消費者

### リクエストフロー

1. クライアントが APISIX にリクエストを送信
2. APISIX がルートルールにマッチ
3. プラグインロジックを実行
4. アップストリームサービスに転送
5. レスポンスをクライアントに返す

## ルート管理

### ルートを作成

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "id": "1",
    "uri": "/api/users/*",
    "name": "user-api",
    "upstream": {
      "type": "roundrobin",
      "nodes": {
        "backend1.example.com:8080": 1
      }
    }
  }'
```

### ルートパラメータ

| パラメータ | 説明 | 必須 |
|-----------|------|------|
| id | ルートID | ○ |
| uri | URI | ○ |
| name | ルート名 | - |
| upstream | アップストリーム設定 | ○ |

## アップストリーム管理

### アップストリームを作成

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/upstreams/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "type": "roundrobin",
    "nodes": {"host1:8080": 1, "host2:8080": 1}
  }'
```

### 負荷分散策略

**ラウンドロビン:**

```json
{"type": "roundrobin"}
```

**コンシステントハッシュ:**

```json
{"type": "chash", "key": "remote_addr"}
```

## プラグイン

### 一般的なプラグイン

**トラフィック制御:**
- limit-req: レート制限
- limit-conn: 接続数制限

**認証:**
- jwt-auth: JWT 認証
- key-auth: Key 認証
- basic-auth: Basic 認証

### レート制限プラグインを使用

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "rejected_code": 503
      }
    }
  }'
```

### JWT 認証を使用

**1. Consumer を作成:**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/consumers \
  -H "X-API-KEY: 123456" \
  -d '{
    "username": "john",
    "plugins": {
      "jwt-auth": {"key": "user-key", "secret": "my-secret"}
    }
  }'
```

**2. ルートで認証を有効化:**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{"uri":"/api/*","plugins":{"jwt-auth":{}}}'
```

## サービス発見

### Eureka

```json
{
  "service_discovery": {
    "type": "eureka",
    "eureka": {"host": ["http://127.0.0.1:8761"]}
  }
}
```

### Nacos

```json
{
  "service_discovery": {
    "type": "nacos",
    "nacos": {"host": ["http://127.0.0.1:8848"]}
  }
}
```

## ヘルスチェック

```json
{
  "upstream": {
    "nodes": {"host1:8080": 1},
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5
      }
    }
  }
}
```

## ベストプラクティス

1. Admin API アクセス制御を有効化
2. 強力なキーを使用
3. ヘルスチェックを構成
4. 適切なレート制限値を設定

### デバッグ

```bash
curl http://127.0.0.1:9180/apisix/admin/routes -H "X-API-KEY: 123456"
tail -f logs/error.log
```
