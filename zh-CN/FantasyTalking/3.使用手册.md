# FantasyTalking 使用手册

FantasyTalking 的详细使用方法和示例。

## 基本用法

### 命令行生成视频

```bash
python inference.py \
  --source_image face.jpg \
  --audio speech.wav \
  --output output.mp4
```

### 参数说明

| 参数 | 简写 | 说明 | 默认值 |
|------|------|------|--------|
| --source_image | -s | 输入人物图片路径 | 必填 |
| --audio | -a | 输入音频文件路径 | 必填 |
| --output | -o | 输出视频路径 | output.mp4 |
| --face_enhancer | -f | 人脸增强模型 | None |
| --max_frames | -m | 最大帧数 | 300 |
| --fps | -fps | 输出帧率 | 25 |

### 完整示例

```bash
python inference.py \
  --source_image photos/person1.jpg \
  --audio audio/speech.wav \
  --output results/video1.mp4 \
  --face_enhancer realusf \
  --fps 30
```

## 进阶用法

### Python API

```python
from fantasytalking import FantasyTalking

# 初始化模型
ft = FantasyTalking(
    checkpoint_path="./models/checkpoint.pth",
    face_enhancer="realusf"
)

# 生成视频
ft.generate(
    source_image="face.jpg",
    audio="speech.wav",
    output="output.mp4"
)
```

### 批量处理

```python
import os
from fantasytalking import FantasyTalking

ft = FantasyTalking()

# 批量生成
images_dir = "./images"
audio_dir = "./audio"
output_dir = "./output"

for image_file in os.listdir(images_dir):
    for audio_file in os.listdir(audio_dir):
        output_name = f"{image_file}_{audio_file}.mp4"
        ft.generate(
            source_image=os.path.join(images_dir, image_file),
            audio=os.path.join(audio_dir, audio_file),
            output=os.path.join(output_dir, output_name)
        )
```

### Web API 服务

```bash
# 启动 API 服务
python api.py --port 8080
```

调用示例：

```bash
curl -X POST http://localhost:8080/generate \
  -F "image=@face.jpg" \
  -F "audio=@speech.wav" \
  -o output.mp4
```

## 输入要求

### 图片格式

- **支持格式**：JPG、PNG、BMP
- **建议分辨率**：512x512 或更高
- **人脸要求**：
  - 正面免冠照片效果最佳
  - 脸部占据画面 50% 以上
  - 光线充足、表情自然

### 音频格式

- **支持格式**：WAV、MP3、FLAC
- **采样率**：16000 Hz 或 44100 Hz
- **时长**：建议 1-60 秒
- **语言**：支持多语言自动识别

## 输出设置

### 分辨率

```bash
# 设置输出分辨率
python inference.py --source_image face.jpg --audio speech.wav --output output.mp4 --size 512
```

支持的分辨率：256、512、768、1024

### 帧率

```bash
# 设置帧率
python inference.py --source_image face.jpg --audio speech.wav --output output.mp4 --fps 30
```

### 视频格式

支持输出格式：MP4 (H.264)、AVI、MOV

## 性能优化

### GPU 加速

确保使用 CUDA：

```python
ft = FantasyTalking(device="cuda")
```

### 批处理

处理多个文件时使用批处理：

```python
ft.batch_generate(image_list, audio_list, output_dir)
```

### 混合精度

启用 FP16 加速：

```python
ft = FantasyTalking(precision="fp16")
```

## 常见问题

### 视频生成失败？

1. 检查输入图片是否包含人脸
2. 确认音频文件格式正确
3. 确保显存充足

### 人脸变形？

1. 使用更清晰的输入图片
2. 调整人脸关键点参数

### 口型不同步？

1. 检查音频是否清晰
2. 调整同步参数

## 最佳实践

1. **选择合适的图片**：正面、高清、光线均匀
2. **准备清晰的音频**：无噪音、语速适中
3. **合理设置参数**：根据需求调整分辨率和帧率
4. **使用人脸增强**：提升画面质量

## 下一阶段

- 常见问题解答：参见 4.常见问题.md
