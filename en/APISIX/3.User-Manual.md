# Apache APISIX User Manual

This manual provides a detailed guide on how to use APISIX for daily API management, including route configuration, load balancing, authentication, rate limiting, and other core features.

## Basic Concepts

Before diving in, understand APISIX's core concepts:

### Route

Route is the most fundamental concept in APISIX. It defines the mapping between **request paths** and **upstream services**. When you create a route, you're telling APISIX: "If a request matches this path, forward it to that service."

A simple route includes:

- **URI**: Request path (e.g., `/api/users`)
- **Upstream**: Upstream service address
- **Plugins** (optional): Plugins to execute

### Upstream

An upstream is a set of nodes providing the same service. APISIX performs load balancing across these nodes, distributing requests to different nodes.

### Consumer

A consumer is an API user, which can be an application, user, or service. Consumers need to prove their identity through authentication plugins.

### Plugin

Plugins are how APISIX extends functionality. APISIX provides rich built-in plugins covering authentication, rate limiting, monitoring, security, and more.

## Quick Start

### Create Your First Route

Assume you have a backend service running at `httpbin.org` and want to access it through APISIX:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "my-first-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  }
}'
```

After creation, accessing `http://127.0.0.1:9080/ip` will be forwarded to `http://httpbin.org/ip`.

### Verify the Route

```bash
curl "http://127.0.0.1:9080/ip"
```

Expected response:

```json
{
  "origin": "183.94.122.205"
}
```

## Load Balancing

APISIX supports multiple load balancing strategies. Choose the appropriate algorithm based on your needs.

### Weighted Round Robin

Set different weights for different nodes. Higher weight means more requests:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "weighted-route",
  "uri": "/headers",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 3,
      "service-b:8080": 1
    }
  }
}'
```

This configuration means: service-a receives 75% of requests, service-b receives 25%.

### Consistent Hashing

For session persistence scenarios, use consistent hashing:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "hash-route",
  "uri": "/user/*",
  "upstream": {
    "type": "chash",
    "key": "remote_addr",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    }
  }
}'
```

### Health Checks

APISIX supports health checks for upstream nodes, automatically filtering out faulty nodes:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "health-check-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "successes": 2
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    }
  }
}'
```

## Authentication

APISIX provides multiple authentication plugins to protect your APIs.

### API Key Authentication

This is the simplest and most commonly used authentication method:

**Step 1: Create a Consumer**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "tom",
  "plugins": {
    "key-auth": {
      "key": "secret-key-123"
    }
  }
}'
```

**Step 2: Enable Key Authentication on Route**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "key-auth": {}
  }
}'
```

**Step 3: Access with Key**

```bash
# Without key, will be denied
curl "http://127.0.0.1:9080/ip"
# Returns: 401 Unauthorized

# With correct key, access granted
curl "http://127.0.0.1:9080/ip" -H "apikey: secret-key-123"
# Returns: 200 OK
```

### JWT Authentication

For more complex authorization scenarios, use JWT:

```bash
# Create consumer with JWT
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "alice",
  "plugins": {
    "jwt-auth": {
      "key": "user-key",
      "secret": "my-secret"
    }
  }
}'

# Get JWT Token (needs backend to generate)
# Then include in request: Authorization: Bearer <jwt-token>
```

## Rate Limiting

APISIX provides multiple rate limiting plugins to restrict request frequency from different dimensions.

### Request Count Based Limiting

Limit the number of requests per unit time:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

This configuration means: Each IP can send at most 100 requests in 60 seconds. Excess requests return 503.

### Request Rate Based Limiting

Limit the request processing rate:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-req": {
      "rate": 100,
      "burst": 50,
      "rejected_code": 429
    }
  }
}'
```

### Concurrent Connection Based Limiting

Limit the number of concurrent connections:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-conn": {
      "conn": 100,
      "burst": 50,
      "rejected_code": 503
    }
  }
}'
```

## Request Rewriting

APISIX can modify requests before forwarding them.

### Rewrite Request Path

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "rewrite-route",
  "uri": "/api/v1/*",
  "plugins": {
    "proxy-rewrite": {
      "uri": "/$uri"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### Rewrite Request Headers

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "header-route",
  "uri": "/proxy",
  "plugins": {
    "proxy-rewrite": {
      "headers": {
        "X-Custom-Header": "custom-value",
        "X-Request-ID": "$request_id"
      }
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## Canary Release

By configuring two different upstream services, you can achieve smooth traffic switching.

### Weight-based Canary Release

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "canary-route",
  "uri": "/api/*",
  "plugins": {
    "traffic-split": {
      "rules": [
        {
          "weighted_upstream": [
            {
              "upstream": {
                "name": "v1",
                "nodes": {
                  "v1-service:8080": 100
                }
              },
              "weight": 90
            },
            {
              "upstream": {
                "name": "v2",
                "nodes": {
                  "v2-service:8080": 100
                }
              },
              "weight": 10
            }
          ]
        }
      ]
    }
  }
}'
```

This configuration means: 90% of traffic to v1, 10% to v2.

## Circuit Breaker

When upstream services fail, the circuit breaker can automatically stop sending requests to faulty nodes, preventing failure propagation.

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "circuit-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "passive": {
        "type": "http",
        "healthy": {
          "successes": 3
        },
        "unhealthy": {
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}'
```

## Monitoring and Logging

### Prometheus Monitoring

Enable the Prometheus plugin to collect metrics:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "monitor-route",
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

Get metrics:

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### Request Logging

Send request logs to external log systems:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "log-route",
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## Common Management Commands

### List All Routes

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### List All Upstreams

```bash
curl "http://127.0.0.1:9180/apisix/admin/upstreams" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### List All Consumers

```bash
curl "http://127.0.0.1:9180/apisix/admin/consumers" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### List All Plugins

```bash
curl "http://127.0.0.1:9180/apisix/admin/plugins" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### Delete a Route

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X DELETE
```

### Update a Route

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PUT -d '
{
  "uri": "/new-path",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "new-backend:8080": 1
    }
  }
}'
```

## Best Practices

1. **Change API Key in Production**: The default Admin API Key is public. Must change in production.

2. **Use HTTPS**: Enable SSL/TLS encryption in production.

3. **Enable Health Checks**: Configuring upstream health checks improves system stability.

4. **Set Reasonable Rate Limits**: Set appropriate rate limits based on actual business needs and backend capabilities.

5. **Backup Logs**: Send important logs to separate log systems for troubleshooting.

6. **Backup Configuration**: Regularly backup etcd configuration data.
