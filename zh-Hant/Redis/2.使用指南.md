# Redis 使用指南

高效使用 Redis 的完整指南。

---

## 目錄

- [基本概念](#基本概念)
- [資料類型](#資料類型)
- [字串操作](#字串操作)
- [列表操作](#列表操作)
- [雜湊操作](#雜湊操作)
- [集合操作](#集合操作)
- [有序集合操作](#有序集合操作)
- [鍵和過期時間](#鍵和過期時間)
- [發布/訂閱](#發布訂閱)
- [事務](#事務)
- [管道](#管道)
- [Lua 腳本](#lua-腳本)
- [持久化](#持久化)
- [複寫](#複寫)
- [叢集](#叢集)
- [安全性](#安全性)
- [效能優化](#效能優化)
- [常用範例](#常用範例)

---

## 基本概念

### 什麼是 Redis？

Redis 是一個開源的記憶體資料結構儲存系統，用作資料庫、快取和訊息中介軟體。它支援多種資料結構，提供高效能。

### 主要特性

- 記憶體儲存
- 資料持久化
- 主從複寫
- 叢集支援
- 發布/訂閱訊息
- Lua 腳本支援

### 關鍵術語

| 術語 | 說明 |
|------|------|
| Key | 值的唯一識別符 |
| Value | 儲存在 Redis 中的資料 |
| TTL | 存活時間（過期時間） |
| Pipeline | 批次執行多條命令 |
| Master | Redis 主實例 |
| Slave | 主實例的副本 |

---

## 資料類型

Redis 支援多種資料類型：

| 類型 | 說明 |
|------|------|
| String | 字串或二進制資料 |
| List | 有序字串列表 |
| Hash | 欄位-值對的集合 |
| Set | 無序唯一字串集合 |
| Sorted Set | 帶分數的有序集合 |
| HyperLogLog | 機率資料結構 |
| Bitmap | 位操作字串 |
| Stream | 日誌結構訊息佇列 |

---

## 字串操作

### 基礎命令

```bash
# 設定值
SET key "value"

# 取得值
GET key

# 設定多個鍵
MSET key1 "value1" key2 "value2"

# 取得多個鍵
MGET key1 key2

# 附加字串
APPEND key " appended"

# 取得字串長度
STRLEN key
```

### 數字操作

```遖

# 遞增
INCR counter
INCRBY counter 10

# 遞減
DECR counter
DECRBY counter 5

# 浮點數遞增
INCRBYFLOAT price 0.5
```

---

## 列表操作

### 基礎命令

```bash
# 左邊插入
LPUSH mylist "first"

# 右邊插入
RPUSH mylist "last"

# 左邊彈出
LPOP mylist

# 右邊彈出
RPOP mylist

# 取得範圍
LRANGE mylist 0 -1

# 取得列表長度
LLEN mylist
```

---

## 雜湊操作

### 基礎命令

```bash
# 設定雜湊欄位
HSET user:1 name "John"

# 設定多個雜湊欄位
HMSET user:1 name "John" email "john@example.com"

# 取得雜湊欄位
HGET user:1 name

# 取得所有欄位和值
HGETALL user:1

# 取得多個欄位
HMGET user:1 name email

# 刪除欄位
HDEL user:1 email
```

---

## 集合操作

### 基礎命令

```bash
# 新增到集合
SADD myset "member1"

# 從集合移除
SREM myset "member1"

# 取得所有成員
SMEMBERS myset

# 檢查成員
SISMEMBER myset "member1"

# 取得集合大小
SCARD myset
```

### 集合運算

```bash
# 聯集
SUNION set1 set2

# 交集
SINTER set1 set2

# 差集
SDIFF set1 set2
```

---

## 有序集合操作

### 基礎命令

```bash
# 新增到有序集合
ZADD leaderboard 100 "player1"

# 取得範圍（升序）
ZRANGE leaderboard 0 -1 WITHSCORES

# 取得範圍（降序）
ZREVRANGE leaderboard 0 -1 WITHSCORES

# 取得排名
ZRANK leaderboard "player1"

# 增加分數
ZINCRBY leaderboard 50 "player1"
```

---

## 鍵和過期時間

### 鍵管理

```bash
# 刪除鍵
DEL key

# 檢查鍵是否存在
EXISTS key

# 取得鍵類型
TYPE key

# 重新命名鍵
RENAME key newkey

# 取得所有鍵
KEYS pattern

# 掃描鍵
SCAN 0 MATCH pattern
```

### 過期時間

```bash
# 設定過期時間（秒）
EXPIRE key 60

# 設定過期時間（毫秒）
PEXPIRE key 60000

# 設定鍵並指定過期時間
SETEX key 60 "value"

# 移除過期時間
PERSIST key

# 取得剩餘存活時間（秒）
TTL key

# 取得剩餘存活時間（毫秒）
PTTL key
```

---

## 發布/訂閱

### 發布

```bash
# 訂閱頻道
SUBSCRIBE mychannel

# 發布訊息
PUBLISH mychannel "Hello"

# 模式訂閱
PSUBSCRIBE news.*
```

### 命令

```bash
# 訂閱
SUBSCRIBE channel1 channel2

# 發布
PUBLISH channel1 "message"

# 取消訂閱
UNSUBSCRIBE channel1
```

---

## 事務

### 基礎命令

```bash
# 開始事務
MULTI

# 佇列命令
SET key1 "value1"
SET key2 "value2"

# 執行事務
EXEC

# 取消事務
DISCARD
```

### Watch

```bash
WATCH key
# ... 一些操作 ...
MULTI
SET key newvalue
EXEC  # 如果鍵被修改則失敗
```

---

## 管道

### 使用管道

```bash
# 管道多個命令
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# 在程式碼中使用（Python 範例）
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Lua 腳本

### 基礎腳本

```bash
# 執行 Lua 腳本
EVAL "return redis.call('get', 'key')" 0

# 使用 Lua 設定鍵
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### 腳本範例

```lua
-- 遞增計數器
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## 持久化

### RDB（Redis 資料庫）

```bash
# 手動儲存
BGSAVE

# 取得上次儲存時間
LASTSAVE
```

### AOF（僅附加檔案）

```bash
# 在設定中啟用
appendonly yes

# 重寫 AOF
BGREWRITEAOF
```

### 設定

```bash
# 儲存頻率
save 900 1
save 300 10
save 60 10000
```

---

## 複寫

### 設定從節點

```bash
# 在 redis.conf 中
replicaof masterip masterport

# 或透過命令
REPLICAOF masterip masterport
```

### 命令

```bash
# 檢查複寫狀態
INFO replication

# 變為主節點
REPLICAOF NO ONE
```

---

## 叢集

### 建立叢集

```bash
# 建立叢集
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# 查看叢集節點
redis-cli -c cluster nodes
```

---

## 安全性

### 密碼認證

```bash
# 在設定中設定密碼
requirepass yourpassword

# 透過 CLI 認證
AUTH yourpassword
```

### ACL（Redis 6+）

```bash
# 建立使用者
ACL SETUSER alice on >password ~cached:* +get +set

# 列出使用者
ACL LIST
```

---

## 效能優化

### 記憶體優化

```bash
# 設定最大記憶體
maxmemory 2gb

# 淘汰策略
maxmemory-policy allkeys-lru
```

### 連線優化

```bash
# 使用連線池
# 在程式碼中
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## 常用範例

### 快取

```bash
# 帶過期時間的快取
SET user:1:profile "data" EX 3600

# 檢查快取
GET user:1:profile
```

### 限流

```bash
# 簡單限流
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### 分散式鎖

```bash
# 取得鎖
SET lock:myresource unique_value NX EX 10

# 釋放鎖
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### 會議儲存

```bash
# 儲存會議
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## 下一步

- 探索 [Redis Stack](https://redis.io/docs/stack/)
- 學習 [Redis Enterprise](https://redis.com/redis-enterprise/)
- 閱讀 [效能調優指南](https://redis.io/docs/management/optimization/)
