# Angular 常见问题解答

本文档汇总了 Angular 开发过程中常见的问题和解决方案。

---

## 目录

1. [安装和配置问题](#安装和配置问题)
2. [组件相关问题](#组件相关问题)
3. [路由相关问题](#路由相关问题)
4. [HTTP 和 API 相关问题](#http-和-api-相关问题)
5. [性能相关问题](#性能相关问题)
6. [测试相关问题](#测试相关问题)
7. [构建和部署问题](#构建和部署问题)

---

## 安装和配置问题

### Q1: Angular CLI 安装失败

**问题**：执行 `npm install -g @angular/cli` 时出现错误。

**解决方案**：
1. 清理 npm 缓存：
```bash
npm cache clean --force
```

2. 使用管理员权限安装：
```bash
# Windows
npm install -g @angular/cli

# Linux/macOS
sudo npm install -g @angular/cli
```

3. 如果仍然失败，尝试使用淘宝镜像：
```bash
npm install -g @angular/cli --registry=https://registry.npmmirror.com
```

### Q2: Node.js 版本不兼容

**问题**：Angular 项目提示 Node.js 版本过低。

**解决方案**：
1. 检查当前版本：
```bash
node --version
ng version
```

2. 使用 nvm 安装兼容版本：
```bash
# 安装 nvm（如果没有）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# 安装 Node.js 20 LTS
nvm install 20
nvm use 20
```

### Q3: ng 命令找不到

**问题**：安装后 `ng` 命令无法使用。

**解决方案**：
1. 找到 npm 全局 bin 目录：
```bash
npm config get prefix
```

2. 将路径添加到系统 PATH 环境变量

3. 或者直接使用 npx：
```bash
npx @angular/cli new my-app
```

---

## 组件相关问题

### Q4: 组件样式不生效

**问题**：组件中定义的 CSS 样式没有生效。

**可能原因**：
1. 视图 encapsulation 设置问题
2. 样式文件路径错误

**解决方案**：
```typescript
@Component({
  selector: 'app-my',
  templateUrl: './my.component.html',
  styleUrls: ['./my.component.css'],
  // 修改视图封装模式
  encapsulation: ViewEncapsulation.None  // 移除此行，仅在需要时使用
})
```

### Q5: 组件间通信失败

**问题**：父子组件之间数据传递不正常。

**解决方案**：
- 父组件 → 子组件：使用 `@Input()` 装饰器
- 子组件 → 父组件：使用 `@Output()` 和 `EventEmitter`

确保在子组件中正确导入和导出：
```typescript
// 子组件
@Input() data: any;
@Output() change = new EventEmitter<any>();
```

### Q6: 生命周期钩子不执行

**问题**：自定义的生命周期钩子方法没有被调用。

**解决方案**：
确保正确实现接口：
```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';

export class MyComponent implements OnInit, OnDestroy {
  ngOnInit() {
    // 初始化逻辑
  }

  ngOnDestroy() {
    // 清理逻辑
  }
}
```

---

## 路由相关问题

### Q7: 路由跳转后页面不更新

**问题**：点击链接后 URL 变化但页面内容没有更新。

**解决方案**：
1. 检查 `<router-outlet>` 是否在正确位置
2. 确保路由配置正确：
```typescript
const routes: Routes = [
  { path: 'home', component: HomeComponent }
];
```
3. 使用 `ng generate` 创建组件确保正确注册

### Q8: 路由参数获取不到

**问题**：通过路由参数传递的数据无法获取。

**解决方案**：
```typescript
import { ActivatedRoute } from '@angular/router';

export class UserComponent implements OnInit {
  constructor(private route: ActivatedRoute) {}

  ngOnInit() {
    // 方式一：订阅参数变化
    this.route.paramMap.subscribe(params => {
      const id = params.get('id');
    });

    // 方式二：快照（仅获取当前值）
    const id = this.route.snapshot.paramMap.get('id');
  }
}
```

### Q9: 路由守卫不生效

**问题**：配置的路由守卫没有被执行。

**解决方案**：
1. 确保守卫已正确注册：
```typescript
// app.routes.ts
export const routes: Routes = [
  {
    path: 'admin',
    component: AdminComponent,
    canActivate: [AuthGuard]  // 不要忘记在 providers 中提供
  }
];
```

2. 提供守卫服务：
```typescript
// app.config.ts 或 app.module.ts
providers: [provideRouter(routes, withComponentInputBinding())]
```

---

## HTTP 和 API 相关问题

### Q10: HTTP 请求失败 CORS 错误

**问题**：浏览器控制台显示 CORS 错误。

**解决方案**：
1. 后端服务器配置 CORS 头：
```javascript
// Express.js 示例
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  next();
});
```

2. 使用代理配置（开发环境）：
```json
// proxy.conf.json
{
  "/api": {
    "target": "http://localhost:3000",
    "secure": false,
    "changeOrigin": true
  }
}
```
在 `angular.json` 中配置：
```json
"architect": {
  "serve": {
    "options": {
      "proxyConfig": "proxy.conf.json"
    }
  }
}
```

### Q11: HttpClient 返回 null

**问题**：HTTP 请求返回 null 或 undefined。

**解决方案**：
1. 添加错误处理：
```typescript
this.http.get<User[]>('/api/users').subscribe({
  next: (data) => this.users = data,
  error: (err) => console.error('请求失败', err)
});
```

2. 确保后端返回正确的 JSON 格式

### Q12: HTTP 拦截器不生效

**问题**：配置的 HTTP 拦截器没有生效。

**解决方案**：
确保正确提供拦截器：
```typescript
// app.config.ts
import { provideHttpClient, withInterceptors } from '@angular/common/http';
import { authInterceptor } from './auth.interceptor';

export const appConfig: ApplicationConfig = {
  providers: [
    provideHttpClient(withInterceptors([authInterceptor]))
  ]
};
```

---

## 性能相关问题

### Q13: 变更检测导致性能问题

**问题**：应用运行缓慢，CPU 占用高。

**解决方案**：
1. 使用 OnPush 变更检测策略：
```typescript
@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class MyComponent {}
```

2. 使用信号（Signals）代替 RxJS：
```typescript
count = signal(0);
increment() {
  this.count.update(c => c + 1);
}
```

### Q14: 内存泄漏

**问题**：应用长时间运行后内存占用不断增加。

**解决方案**：
1. 取消订阅 Observable：
```typescript
import { OnDestroy } from '@angular/core';
import { Subject } from 'rxjs';

export class MyComponent implements OnDestroy {
  private destroy$ = new Subject<void>();

  ngOnInit() {
    this.dataService.getData().pipe(
      takeUntil(this.destroy$)
    ).subscribe(data => {
      this.data = data;
    });
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }
}
```

2. 使用 async 管道自动取消订阅：
```html
<div *ngIf="data$ | async as data">
  {{ data.name }}
</div>
```

### Q15: Bundle 体积过大

**问题**：生产构建的文件体积过大。

**解决方案**：
1. 启用 Tree Shaking：
```bash
ng build --configuration production
```

2. 使用延迟加载：
```typescript
{
  path: 'admin',
  loadChildren: () => import('./admin/admin.module').then(m => m.AdminModule)
}
```

3. 移除未使用的依赖

---

## 测试相关问题

### Q16: 单元测试失败

**问题**：运行 `ng test` 时测试失败。

**解决方案**：
1. 检查测试配置
2. 确保依赖正确 mock：
```typescript
beforeEach(async () => {
  await TestBed.configureTestingModule({
    declarations: [MyComponent],
    providers: [
      { provide: MyService, useValue: mockService }
    ]
  }).compileComponents();
});
```

### Q17: Karma 启动失败

**问题**：Karma 无法启动或连接失败。

**解决方案**：
1. 重新安装依赖：
```bash
rm -rf node_modules
npm install
```

2. 检查 Karma 配置文件

---

## 构建和部署问题

### Q18: 构建失败内存不足

**问题**：生产构建时出现内存溢出错误。

**解决方案**：
1. 增加 Node.js 内存限制：
```bash
export NODE_OPTIONS="--max-old-space-size=4096"
ng build --configuration production
```

2. 在 Windows PowerShell 中：
```powershell
$env:NODE_OPTIONS="--max-old-space-size=4096"
ng build --configuration production
```

### Q19: 部署后资源 404 错误

**问题**：部署到服务器后，页面刷新出现 404 错误。

**解决方案**：
1. 配置服务器重定向到 index.html
2. 对于 Nginx：
```nginx
location / {
  try_files $uri $uri/ /index.html;
}
```

3. 对于 Apache，在 `.htaccess` 中添加：
```apache
RewriteEngine On
RewriteBase /
RewriteRule ^index\.html$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]
```

### Q20: 环境变量不生效

**问题**：在生产构建中环境变量值不正确。

**解决方案**：
确保环境文件路径正确：
```typescript
// environment.ts
export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000/api'
};

// environment.prod.ts
export const environment = {
  production: true,
  apiUrl: 'https://api.production.com'
};
```

在组件中使用：
```typescript
import { environment } from '../environments/environment';
```

---

## 相关链接

- [Angular 官方文档](https://angular.io/)
- [Angular 中文文档](https://angular.cn/)
- [Angular CLI 文档](https://angular.io/cli)
- [Stack Overflow Angular 标签](https://stackoverflow.com/questions/tagged/angular)
