# Guía de usuario de DragonTalker

DragonTalker utiliza aprendizaje profundo para generar videos realistas de cabezas parlantes a partir de una sola imagen y entrada de audio.

## Inicio rápido

### Comando básico

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### Con mejora

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## Parámetros de comando

### Parámetros de entrada

| Parámetro | Descripción | Valor predeterminado |
|-----------|--------------|----------------------|
| `--source_image` | Ruta de imagen de retrato de entrada | Requerido |
| `--driven_audio` | Archivo de audio de entrada (WAV/MP3) | Requerido |
| `--result_dir` | Directorio de salida | ./results |

### Parámetros de procesamiento

| Parámetro | Descripción | Valor predeterminado |
|-----------|--------------|----------------------|
| `--preprocess` | Preprocesamiento de imagen: crop, resize, full | full |
| `--size` | Tamaño de imagen: 256, 512 | 256 |
| `--pose_style` | Estilo de pose 0-45 | 0 |
| `--expression_scale` | Intensidad de expresión 0.5-1.5 | 1.0 |

### Parámetros de mejora

| Parámetro | Descripción | Valor predeterminado |
|-----------|--------------|----------------------|
| `--enhancer` | Mejora de rostro: gfpgan, RestoreFormer, CodeFormer | Ninguno |

### Parámetros de rendimiento

| Parámetro | Descripción | Valor predeterminado |
|-----------|--------------|----------------------|
| `--batch_size` | Tamaño de lote | 1 |
| `--fps` | Cuadros por segundo del video de salida | 25 |

## Ejemplos de uso

### Ejemplo 1: Generación básica

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### Ejemplo 2: Mejora con GFPGAN

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### Ejemplo 3: Pose personalizada

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### Ejemplo 4: Mayor resolución

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## API de Python

### Uso básico

```python
from inference import DragonTalker

# Inicializar DragonTalker
dragon = DragonTalker()

# Generar video
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"Video guardado en: {video_path}")
```

### Uso avanzado

```python
from inference import DragonTalker
import torch

# Inicializar con configuración personalizada
dragon = DragonTalker(
    checkpoint_path="checkpoints/DragonTalker.pth",
    config_path="config/DragonTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Generar video con opciones avanzadas
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### Procesamiento por lotes

```python
from inference import DragonTalker
import os

dragon = DragonTalker()

# Procesar múltiples imágenes (mismo audio)
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        dragon.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Interfaz web

### Ejecutar demo web

```bash
python app.py
```

Luego abra http://localhost:8888 en su navegador

### Funciones de la interfaz web

1. **Subir imagen** - Arrastrar y soltar imagen de retrato
2. **Subir audio** - Seleccionar archivo de audio (WAV/MP3)
3. **Vista previa** - Previsualizar imagen y audio fuente
4. **Ajuste de parámetros** - Ajustar pose, expresión, mejora
5. **Generar** - Generar video con un clic
6. **Descargar** - Guardar video generado

## Mejoras de rostro

### Mejoras disponibles

| Mejora | Calidad | Velocidad | VRAM |
|--------|---------|-----------|------|
| Ninguna | Básica | Rápida | Bajo |
| gfpgan | Buena | Media | Medio |
| RestoreFormer | Muy buena | Lenta | Alto |
| CodeFormer | Muy buena | Lenta | Alto |

### Recomendaciones

- **VRAM bajo**: Sin mejora o gfpgan
- **Equilibrado**: gfpgan
- **Mejor calidad**: RestoreFormer o CodeFormer

## Modos de preprocesamiento

| Modo | Descripción | Caso de uso |
|------|-------------|-------------|
| crop | Recortar cara al centro | Procesamiento rápido |
| resize | Redimensionar al tamaño objetivo | Fondo simple |
| full | Pipeline de procesamiento completo | Mejor calidad |

## Requisitos de entrada

### Requisitos de imagen

- Formato: JPG, PNG
- Resolución: Se recomienda 512x512 o superior
- Rostro: Frontal, sin oclusión
- Fondo: Simple preferido

### Requisitos de audio

- Formato: WAV, MP3
- Duración: 1-60 segundos
- Frecuencia de muestreo: 16000-48000 Hz
- Voz: Clara, mínimo ruido

## Salida

### Formato de video

- Formato: MP4
- Códec: H.264
- Resolución: 256x256 o 512x512
- Cuadros por segundo: 25
- Tasa de bits: 2-5 Mbps

### Directorio de salida

Los resultados se guardan en el directorio de salida especificado:
```
results/
├── video.mp4          # Video generado
└── (archivos temporales)
```

## Solución de problemas

### Video muy oscuro/brillante

**Causa:** Falta de coincidencia de iluminación entre entrenamiento y entrada

**Soluciones:**
- Ajustar parámetro expression_scale (0.8-1.2)
- Usar imagen fuente de mayor calidad
- Probar diferente mejora

### Labios desincronizados

**Causa:** Problemas de calidad o alineación de audio

**Soluciones:**
- Usar audio de alta calidad
- Asegurarse de que el audio tenga voz clara
- Verificar sincronización audio-video

### Rostro deformado

**Causa:** Baja calidad de entrada o entrada inusual

**Soluciones:**
- Usar imagen de mayor resolución (512)
- Probar diferente modo de preprocesamiento
- Usar mejora de rostro
- Asegurarse de que el rostro sea claramente visible

### Procesamiento lento

**Soluciones:**
- Usar `--preprocess crop`
- Establecer `--size 256`
- Desactivar mejora
- Reducir tamaño de lote

### Memoria GPU insuficiente

**Soluciones:**
- Reducir batch_size a 1
- Usar tamaño de imagen más pequeño
- Cerrar otras aplicaciones GPU

## Consejos de rendimiento

### Procesamiento más rápido

1. Usar `--preprocess crop`
2. Establecer `--size 256`
3. Desactivar mejora

### Mejor calidad

1. Usar `--size 512`
2. Habilitar `--enhancer gfpgan`
3. Usar `--preprocess full`

## Enlaces relacionados

- [GitHub](https://github.com/your-repo/DragonTalker)
- [HuggingFace](https://huggingface.co/spaces)
- [Modelos](https://github.com/your-repo/DragonTalker/releases)
