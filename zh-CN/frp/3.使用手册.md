# frp 使用手册

本手册详细介绍 frp 的各种使用方式和配置方法。

## 基础配置说明

frp 从 v0.52.0 版本开始推荐使用 TOML 格式配置，同时也支持 YAML 和 JSON 格式。INI 格式已废弃，不建议使用。

### 服务端基础配置

```toml
# frps.toml - 服务端配置
bindPort = 7000
auth.method = "token"
auth.token = "your_token_here"

# Web 控制面板
webServer.addr = "0.0.0.0"
webServer.port = 7500
webServer.user = "admin"
webServer.password = "admin"
```

### 客户端基础配置

```toml
# frpc.toml - 客户端配置
serverAddr = "123.45.67.89"
serverPort = 7000
auth.method = "token"
auth.token = "your_token_here"

# 代理配置
[[proxies]]
name = "ssh"
type = "tcp"
localIP = "127.0.0.1"
localPort = 22
remotePort = 6000
```

## TCP 穿透

最常用的场景，通过 TCP 协议将内网端口映射到公网。

### SSH 远程登录

服务端配置 `frps.toml`：

```toml
bindPort = 7000
```

客户端配置 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "ssh"
type = "tcp"
localIP = "127.0.0.1"
localPort = 22
remotePort = 6000
```

使用方法：

```bash
# 从任意电脑 SSH 到内网机器
ssh -p 6000 username@123.45.67.89
```

### 远程桌面（RDP）

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "rdp"
type = "tcp"
localIP = "127.0.0.1"
localPort = 3389
remotePort = 13389
```

使用方法：

```
# Windows 自带远程桌面连接
mstsc /v:123.45.67.89:13389
```

### MySQL 数据库

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "mysql"
type = "tcp"
localIP = "127.0.0.1"
localPort = 3306
remotePort = 13306
```

使用方法：

```bash
mysql -h 123.45.67.89 -P 13306 -u root -p
```

## HTTP/HTTPS 穿透

用于将内网 Web 服务暴露到公网。

### HTTP 服务穿透

服务端配置 `frps.toml`：

```toml
bindPort = 7000
# HTTP 虚拟主机端口
vhostHTTPPort = 8080
```

客户端配置 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "web"
type = "http"
localPort = 80
customDomains = "www.yourdomain.com"
```

**注意**：需要将域名解析到服务器 IP，或配置 DNS 通配符。

### HTTPS 服务穿透

服务端配置 `frps.toml`：

```toml
bindPort = 7000
vhostHTTPSPort = 8443
```

客户端配置 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "web-https"
type = "https"
localPort = 443
customDomains = "www.yourdomain.com"
```

### 使用子域名

服务端配置 `frps.toml`：

```toml
bindPort = 7000
vhostHTTPPort = 8080
# 指定子域名基础域名
subDomainHost = "yourdomain.com"
```

客户端配置 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "web"
type = "http"
localPort = 80
# 完整域名将是 test.yourdomain.com
subdomain = "test"
```

## UDP 穿透

适用于 DNS、游戏服务器、视频流等 UDP 场景。

### DNS 服务器

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "dns"
type = "udp"
localIP = "8.8.8.8"
localPort = 53
remotePort = 6001
```

测试使用方法：

```bash
dig @123.45.67.89 -p 6001 www.google.com
```

## 高级功能

### 加密与压缩

在客户端启用加密和压缩，提高传输安全性和效率：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "ssh"
type = "tcp"
localPort = 22
remotePort = 6000
# 启用加密
transport.useEncryption = true
# 启用压缩
transport.useCompression = true
```

### TLS 加密（推荐）

frp 从 v0.50.0 开始默认启用 TLS。服务端可以强制只接受 TLS 连接：

```toml
# frps.toml
bindPort = 7000
transport.tls.force = true
```

客户端配置：

```toml
# frpc.toml
transport.tls.enable = true
```

### 端口复用

让 HTTP/HTTPS 端口与客户端连接端口共享：

```toml
# frps.toml
bindPort = 7000
vhostHTTPPort = 80
vhostHTTPSPort = 443
```

这样只需要开放 7000 端口即可。

### TCP 流复用

减少连接建立的开销，提高性能：

```toml
# frps.toml 和 frpc.toml 需要保持一致
transport.tcpMux = true
transport.tcpMuxKeepalive = 60
```

### KCP 协议

使用 KCP 协议可以降低延迟，适用于网络环境不好的场景：

服务端 `frps.toml`：

```toml
bindPort = 7000
kcpBindPort = 7000
```

客户端 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000
transport.protocol = "kcp"
```

### QUIC 协议

新一代 UDP 多路复用协议：

服务端 `frps.toml`：

```toml
bindPort = 7000
quicBindPort = 7000
```

客户端 `frpc.toml`：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000
transport.protocol = "quic"
```

### 负载均衡

多个客户端共享同一个公网端口：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "web1"
type = "tcp"
localPort = 8080
remotePort = 80
loadBalancer.group = "web"
loadBalancer.groupKey = "secret"

[[proxies]]
name = "web2"
type = "tcp"
localPort = 8081
remotePort = 80
loadBalancer.group = "web"
loadBalancer.groupKey = "secret"
```

### 健康检查

自动检测后端服务状态：

```toml
[[proxies]]
name = "web"
type = "tcp"
localPort = 80
remotePort = 8080
# TCP 健康检查
healthCheck.type = "tcp"
healthCheck.timeoutSeconds = 3
healthCheck.maxFailed = 3
healthCheck.intervalSeconds = 10
```

或者 HTTP 健康检查：

```toml
[[proxies]]
name = "web"
type = "http"
localPort = 80
customDomains = "web.example.com"
healthCheck.type = "http"
healthCheck.path = "/health"
healthCheck.timeoutSeconds = 3
healthCheck.maxFailed = 3
healthCheck.intervalSeconds = 10
```

### 带宽限制

限制每个代理的带宽：

```toml
[[proxies]]
name = "ssh"
type = "tcp"
localPort = 22
remotePort = 6000
# 限制带宽为 1MB
transport.bandwidthLimit = "1MB"
# 在客户端限速（可选 server）
transport.bandwidthLimitMode = "client"
```

### 连接池

预先建立连接，减少延迟：

服务端 `frps.toml`：

```toml
transport.maxPoolCount = 5
```

客户端 `frpc.toml`：

```toml
transport.poolCount = 1
```

## 特殊代理类型

### STCP（安全 TCP）

需要预共享密钥的安全连接：

客户端 A（提供服务的机器）：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "secret-ssh"
type = "stcp"
secretKey = "your_secret_key"
localIP = "127.0.0.1"
localPort = 22
```

客户端 B（访问服务的机器）：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[visitors]]
name = "secret-ssh-visitor"
type = "stcp"
serverName = "secret-ssh"
secretKey = "your_secret_key"
bindAddr = "127.0.0.1"
bindPort = 6000
```

使用方式：从客户端 B 连接到 localhost:6000

### XTCP（P2P 模式）

点对点传输，不经过服务器中转：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "p2p-ssh"
type = "xtcp"
secretKey = "your_secret_key"
localIP = "127.0.0.1"
localPort = 22
```

访问端配置与 STCP 类似。

### Unix 域 Socket

将 Unix 域 socket 映射为 TCP 端口：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "docker"
type = "tcp"
remotePort = 2375
[proxies.plugin]
type = "unix_domain_socket"
unixPath = "/var/run/docker.sock"
```

### 静态文件服务器

将本地目录暴露为 HTTP 服务：

```toml
serverAddr = "123.45.67.89"
serverPort = 7000

[[proxies]]
name = "static-file"
type = "tcp"
remotePort = 8080
[proxies.plugin]
type = "static_file"
# 本地目录
localPath = "/tmp/files"
# URL 前缀
stripPrefix = "static"
# 可选：访问密码
httpUser = "admin"
httpPassword = "admin"
```

访问：http://123.45.67.89:8080/static/

## 认证配置

### Token 认证

最简单的方式：

```toml
# frps.toml 和 frpc.toml
auth.method = "token"
auth.token = "your_secret_token"
```

### OIDC 认证

企业级认证方式：

服务端 `frps.toml`：

```toml
auth.method = "oidc"
auth.oidc.issuer = "https://your-oidc-provider.com/"
auth.oidc.audience = "frp"
```

客户端 `frpc.toml`：

```toml
auth.method = "oidc"
auth.oidc.clientID = "your-client-id"
auth.oidc.clientSecret = "your-client-secret"
auth.oidc.audience = "frp"
auth.oidc.tokenEndpointURL = "https://your-oidc-provider.com/oauth2/token"
```

## 热更新配置

修改配置后无需重启客户端：

```bash
# 验证配置
./frpc verify -c frpc.toml

# 热更新
./frpc reload -c frpc.toml
```

## 查看状态

### 客户端状态

```bash
./frpc status -c frpc.toml
```

需要在配置中启用 Admin UI：

```toml
webServer.addr = "127.0.0.1"
webServer.port = 7400
webServer.user = "admin"
webServer.password = "admin"
```

### 服务端控制面板

访问 http://your_server_ip:7500 查看所有连接和流量统计。

## 获取真实 IP

### HTTP 服务

通过 X-Forwarded-For 头获取：

```toml
[[proxies]]
name = "web"
type = "http"
localPort = 80
customDomains = "web.example.com"
```

在后端 Nginx 中配置：

```nginx
location / {
    proxy_pass http://127.0.0.1:80;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

### 使用 Proxy Protocol

```toml
[[proxies]]
name = "web"
type = "https"
localPort = 443
customDomains = "web.example.com"
transport.proxyProtocolVersion = "v2"
```

## 常见端口映射场景

| 内网服务 | localPort | remotePort | 用途 |
|---------|-----------|------------|------|
| SSH | 22 | 6000 | 远程登录 |
| RDP | 3389 | 13389 | 远程桌面 |
| MySQL | 3306 | 13306 | 数据库 |
| PostgreSQL | 5432 | 15432 | 数据库 |
| Redis | 6379 | 16379 | 缓存 |
| Web | 80 | 8080 | HTTP 服务 |
| Web | 443 | 8443 | HTTPS 服务 |

## 性能优化建议

1. **启用 TCP 流复用**：减少连接开销
2. **启用压缩**：节省带宽（网络带宽有限时）
3. **使用 KCP/QUIC**：降低延迟
4. **配置连接池**：减少连接建立时间
5. **启用 TLS**：默认已启用，保证安全

更多高级配置请参考官方完整配置文件：
- [frps 完整配置](https://github.com/fatedier/frp/blob/master/conf/frps_full_example.toml)
- [frpc 完整配置](https://github.com/fatedier/frp/blob/master/conf/frpc_full_example.toml)
