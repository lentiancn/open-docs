# Jenkins 使用指南

本指南介紹如何使用 Jenkins 實現持續整合和持續部署。

## 快速開始

### 建立第一個任務

1. 點擊「新建 Item」
2. 輸入任務名稱
3. 選擇「自由風格專案」
4. 配置來源碼管理（Git）
5. 配置建置觸發器
6. 配置建置步驟
7. 儲存並建置

## 任務類型

### 自由風格專案

```groovy
// 建置步驟範例
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/example/repo.git'
            }
        }
        stage('Build') {
            steps {
                sh 'npm install'
                sh 'npm test'
            }
        }
        stage('Deploy') {
            steps {
                sh 'npm run deploy'
            }
        }
    }
}
```

### Pipeline 專案

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        APP_NAME = 'my-app'
    }
    
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'npm install'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing...'
                sh 'npm test'
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying...'
            }
        }
    }
    
    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            echo 'Build succeeded!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
```

## 常用外掛程式

### Git 外掛程式

```groovy
git branch: 'main',
    credentialsId: 'github-credentials',
    url: 'https://github.com/example/repo.git'
```

### Docker 外掛程式

```groovy
docker.build('my-app:latest')
```

### Maven 外掛程式

```groovy
mvn clean package
```

## 建置觸發器

### 定時建置

```groovy
// 每小時建置一次
cron('H * * * *')

// 每天午夜建置
cron('H 0 * * *')
```

### 輪詢 SCM

```groovy
pollScm('H * * * *')
```

### Webhook 觸發

1. 安裝 "Generic Webhook Trigger" 外掛程式
2. 配置任務觸發器
3. 在 GitHub/GitLab 配置 Webhook

## 環境變數

### 內建變數

```groovy
echo "目前建置: ${BUILD_NUMBER}"
echo "工作目錄: ${WORKSPACE}"
echo "GIT_BRANCH: ${GIT_BRANCH}"
```

### 自訂變數

```groovy
environment {
    APP_VERSION = '1.0.0'
    DEPLOY_ENV = 'production'
}
```

## 憑證管理

### 新增憑證

1. 進入 "Manage Jenkins" → "Manage Credentials"
2. 新增憑證：
   - Username with password
   - SSH Username with private key
   - Secret file

### 使用憑證

```groovy
withCredentials([usernamePassword(credentialsId: 'my-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
    sh 'echo $USER:$PASS'
}
```

## 分散式建置

### 配置代理節點

1. 進入 "Manage Jenkins" → "Manage Nodes"
2. 新增新節點
3. 配置連線資訊

### 使用標籤

```groovy
pipeline {
    agent {
        label 'docker'
    }
    // 建置步驟
}
```

## 通知

### 郵件通知

```groovy
emailext (
    subject: "建置通知: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
    body: "建置狀態: ${currentBuild.result}",
    to: 'team@example.com'
)
```

### 釘釘通知

1. 安裝 "DingTalk" 外掛程式
2. 配置機器人
3. 新增通知步驟

## 備份和復原

### 備份

```bash
# 備份 JENKINS_HOME
tar -czvf jenkins-backup.tar.gz $JENKINS_HOME
```

### 復原

```bash
# 停止 Jenkins
# 解壓備份
tar -xzvf jenkins-backup.tar.gz -C $JENKINS_HOME
# 重新啟動 Jenkins
```

## 最佳實踐

### 1. 使用 Pipeline

```groovy
// 建議使用宣告式 Pipeline
pipeline {
    // 定義整個流程
}
```

### 2. 參數化建置

```groovy
parameters {
    choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: '部署環境')
    string(name: 'VERSION', defaultValue: '', description: '版本號')
}
```

### 3. 清理工作區

```groovy
post {
    always {
        cleanWs()
    }
}
```

## 相關資源

- [Jenkins 官方文件](https://www.jenkins.io/doc/)
- [Pipeline 語法](https://www.jenkins.io/doc/book/pipeline/syntax/)
