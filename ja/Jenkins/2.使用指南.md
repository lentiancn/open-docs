# Jenkins ユーザーガイド

このガイドでは、Jenkinsを使用して継続的インテグレーションと継続的デプロイを実現する方法について説明します。

## クイックスタート

### 最初のジョブを作成

1. 「新規アイテム」をクリック
2. ジョブ名を入力
3. 「フリースタイル・プロジェクト」を選択
4. ソースコード管理（Git）を設定
5. ビルドトリガーを設定
6. ビルドステップを設定
7. 保存してビルド

## ジョブタイプ

### フリースタイルプロジェクト

```groovy
// ビルドステップの例
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/example/repo.git'
            }
        }
        stage('Build') {
            steps {
                sh 'npm install'
                sh 'npm test'
            }
        }
        stage('Deploy') {
            steps {
                sh 'npm run deploy'
            }
        }
    }
}
```

### Pipelineプロジェクト

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        APP_NAME = 'my-app'
    }
    
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'npm install'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing...'
                sh 'npm test'
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying...'
            }
        }
    }
    
    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            echo 'Build succeeded!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
```

## 一般的なプラグイン

### Gitプラグイン

```groovy
git branch: 'main',
    credentialsId: 'github-credentials',
    url: 'https://github.com/example/repo.git'
```

### Dockerプラグイン

```groovy
docker.build('my-app:latest')
```

### Mavenプラグイン

```groovy
mvn clean package
```

## ビルドトリガー

### スケジュールビルド

```groovy
// 1時間ごとにビルド
cron('H * * * *')

// 毎日深夜にビルド
cron('H 0 * * *')
```

### SCMポーリング

```groovy
pollScm('H * * * *')
```

### Webhookトリガー

1. 「Generic Webhook Trigger」プラグインをインストール
2. ジョブのトリガーを設定
3. GitHub/GitLabでWebhookを設定

## 環境変数

### 組み込み変数

```groovy
echo "現在のビルド: ${BUILD_NUMBER}"
echo "ワークスペース: ${WORKSPACE}"
echo "GIT_BRANCH: ${GIT_BRANCH}"
```

### カスタム変数

```groovy
environment {
    APP_VERSION = '1.0.0'
    DEPLOY_ENV = 'production'
}
```

## 認証情報管理

### 認証情報を追加

1. 「Manage Jenkins」→「Manage Credentials」に移動
2. 認証情報を追加：
   - Username with password
   - SSH Username with private key
   - Secret file

### 認証情報を使用

```groovy
withCredentials([usernamePassword(credentialsId: 'my-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
    sh 'echo $USER:$PASS'
}
```

## 分散ビルド

### エージェントノードの設定

1. 「Manage Jenkins」→「Manage Nodes」に移動
2. 新規ノードを追加
3. 接続情報を設定

### ラベルを使用

```groovy
pipeline {
    agent {
        label 'docker'
    }
    // ビルドステップ
}
```

## 通知

### メール通知

```groovy
emailext (
    subject: "ビルド通知: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
    body: "ビルド状態: ${currentBuild.result}",
    to: 'team@example.com'
)
```

### Slack通知

1. 「Slack Notification」プラグインをインストール
2. ワークスペースを設定
3. 通知ステップを追加

## バックアップとリストア

### バックアップ

```bash
# JENKINS_HOMEをバックアップ
tar -czvf jenkins-backup.tar.gz $JENKINS_HOME
```

### リストア

```bash
# Jenkinsを停止
# バックアップを展開
tar -xzvf jenkins-backup.tar.gz -C $JENKINS_HOME
# Jenkinsを再起動
```

## ベストプラクティス

### 1. Pipelineを使用

```groovy
// 宣言的Pipelineの使用を推奨
pipeline {
    // プロセス全体を定義
}
```

### 2. パラメータライズドビルド

```groovy
parameters {
    choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: 'デプロイ環境')
    string(name: 'VERSION', defaultValue: '', description: 'バージョン')
}
```

### 3. ワークスペースのクリーンアップ

```groovy
post {
    always {
        cleanWs()
    }
}
```

## 関連リソース

- [Jenkins 公式ドキュメント](https://www.jenkins.io/doc/)
- [Pipeline 構文](https://www.jenkins.io/doc/book/pipeline/syntax/)
