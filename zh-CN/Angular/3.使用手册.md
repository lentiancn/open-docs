# Angular 使用手册

本手册将深入介绍 Angular 的核心概念和实际使用方法，包括组件、服务、路由、表单、HTTP 请求等内容。

## 组件（Component）

组件是 Angular 应用的基本构建块，每个组件由三个部分组成：模板（视图）、样式和逻辑。

### 创建组件

```bash
ng generate component user-profile
# 简写
ng g c user-profile
```

### 组件基本结构

```typescript
// user-profile.component.ts
import { Component } from '@angular/core';

@Component({
  selector: 'app-user-profile',
  templateUrl: './user-profile.component.html',
  styleUrls: ['./user-profile.component.css']
})
export class UserProfileComponent {
  // 组件属性
  username: string = '张三';
  age: number = 25;
  isActive: boolean = true;
  
  // 用户头像
  avatarUrl: string = 'https://example.com/avatar.jpg';
  
  // 爱好列表
  hobbies: string[] = ['编程', '阅读', '旅行'];
  
  // 构造函数
  constructor() {}
  
  // 组件方法
  greet(): string {
    return `你好，我是 ${this.username}！`;
  }
  
  toggleActive(): void {
    this.isActive = !this.isActive;
  }
  
  addHobby(hobby: string): void {
    this.hobbies.push(hobby);
  }
}
```

### 组件模板

```html
<!-- user-profile.component.html -->
<div class="profile-container">
  <!-- 头像 -->
  <img [src]="avatarUrl" [alt]="username" class="avatar">
  
  <!-- 用户信息 -->
  <h2>{{ username }}</h2>
  <p>年龄: {{ age }}</p>
  <p>状态: {{ isActive ? '活跃' : '不活跃' }}</p>
  
  <!-- 条件渲染 -->
  <div *ngIf="isActive" class="status-badge">
    在线
  </div>
  
  <!-- 列表渲染 -->
  <ul class="hobbies">
    <li *ngFor="let hobby of hobbies; let i = index">
      {{ i + 1 }}. {{ hobby }}
    </li>
  </ul>
  
  <!-- 事件绑定 -->
  <button (click)="toggleActive()">
    切换状态
  </button>
  
  <!-- 方法调用 -->
  <p>{{ greet() }}</p>
</div>
```

### 组件样式

```css
/* user-profile.component.css */
.profile-container {
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  background-color: #4caf50;
  color: white;
  border-radius: 4px;
  font-size: 14px;
}

.hobbies {
  list-style: none;
  padding: 0;
}

.hobbies li {
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}

button {
  padding: 10px 20px;
  background-color: #2196f3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background-color: #1976d2;
}
```

### 组件通信

#### 父组件向子组件传值（输入属性）

```typescript
// 子组件：child.component.ts
import { Component, Input } from '@angular/core';

@Component({
  selector: 'app-child',
  template: '<h2>{{ title }}</h2>'
})
export class ChildComponent {
  @Input() title: string = '';
  @Input() count: number = 0;
}
```

```html
<!-- 父组件模板 -->
<app-child title="Hello" [count]="5"></app-child>
```

#### 子组件向父组件传值（输出属性 + 事件）

```typescript
// 子组件
import { Component, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-child',
  template: '<button (click)="sendMessage()">发送</button>'
})
export class ChildComponent {
  @Output() messageEvent = new EventEmitter<string>();
  
  sendMessage() {
    this.messageEvent.emit('Hello from child!');
  }
}
```

```typescript
// 父组件
import { Component } from '@angular/core';

@Component({
  selector: 'app-parent',
  template: '<app-child (messageEvent)="onMessage($event)"></app-child>'
})
export class ParentComponent {
  onMessage(message: string) {
    console.log(message);
  }
}
```

### 生命周期钩子

```typescript
import { Component, OnInit, OnDestroy, OnChanges, AfterViewInit } from '@angular/core';

@Component({
  selector: 'app-lifecycle',
  template: '<p>生命周期示例</p>'
})
export class LifecycleComponent implements OnInit, OnDestroy, OnChanges, AfterViewInit {
  
  // 组件初始化时调用
  ngOnInit() {
    console.log('ngOnInit - 组件初始化');
  }
  
  // 输入属性变化时调用
  ngOnChanges() {
    console.log('ngOnChanges - 输入属性变化');
  }
  
  // 视图初始化后调用
  ngAfterViewInit() {
    console.log('ngAfterViewInit - 视图初始化完成');
  }
  
  // 组件销毁时调用
  ngOnDestroy() {
    console.log('ngOnDestroy - 组件销毁');
  }
}
```

## 服务（Service）

服务用于封装可重用的业务逻辑和数据访问代码。

### 创建服务

```bash
ng generate service user
# 简写
ng g s user
```

### 服务基本结构

```typescript
// user.service.ts
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, of } from 'rxjs';
import { catchError, map } from 'rxjs/operators';

export interface User {
  id: number;
  name: string;
  email: string;
}

@Injectable({
  providedIn: 'root'  // 全局单例
})
export class UserService {
  private apiUrl = 'https://api.example.com/users';
  
  constructor(private http: HttpClient) {}
  
  // 获取用户列表
  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl).pipe(
      catchError(this.handleError<User[]>('getUsers', []))
    );
  }
  
  // 获取单个用户
  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`).pipe(
      catchError(this.handleError<User>('getUser'))
    );
  }
  
  // 创建用户
  createUser(user: User): Observable<User> {
    return this.http.post<User>(this.apiUrl, user).pipe(
      catchError(this.handleError<User>('createUser'))
    );
  }
  
  // 更新用户
  updateUser(id: number, user: User): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user).pipe(
      catchError(this.handleError<User>('updateUser'))
    );
  }
  
  // 删除用户
  deleteUser(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`).pipe(
      catchError(this.handleError<void>('deleteUser'))
    );
  }
  
  // 错误处理
  private handleError<T>(operation = 'operation', result?: T) {
    return (error: any): Observable<T> => {
      console.error(`${operation} failed: ${error.message}`);
      return of(result as T);
    };
  }
}
```

### 在组件中使用服务

```typescript
import { Component, OnInit } from '@angular/core';
import { UserService, User } from './user.service';

@Component({
  selector: 'app-user-list',
  templateUrl: './user-list.component.html'
})
export class UserListComponent implements OnInit {
  users: User[] = [];
  loading: boolean = false;
  error: string = '';
  
  constructor(private userService: UserService) {}
  
  ngOnInit() {
    this.loadUsers();
  }
  
  loadUsers() {
    this.loading = true;
    this.userService.getUsers().subscribe({
      next: (data) => {
        this.users = data;
        this.loading = false;
      },
      error: (err) => {
        this.error = '加载用户失败';
        this.loading = false;
      }
    });
  }
  
  deleteUser(id: number) {
    if (confirm('确定要删除这个用户吗？')) {
      this.userService.deleteUser(id).subscribe(() => {
        this.users = this.users.filter(u => u.id !== id);
      });
    }
  }
}
```

## 路由（Router）

Angular Router 提供了完整的客户端路由功能。

### 配置路由

```typescript
// app.routes.ts
import { Routes } from '@angular/router';
import { HomeComponent } from './home/home.component';
import { AboutComponent } from './about/about.component';
import { UserListComponent } from './user-list/user-list.component';
import { UserDetailComponent } from './user-detail/user-detail.component';
import { NotFoundComponent } from './not-found/not-found.component';

export const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { path: 'home', component: HomeComponent, title: '首页' },
  { path: 'about', component: AboutComponent, title: '关于' },
  { 
    path: 'users', 
    children: [
      { path: '', component: UserListComponent },
      { path: ':id', component: UserDetailComponent }
    ]
  },
  { path: '**', component: NotFoundComponent, title: '404' }
];
```

### 在模板中使用路由

```html
<!-- 导航菜单 -->
<nav>
  <a routerLink="/home" routerLinkActive="active">首页</a>
  <a routerLink="/about" routerLinkActive="active">关于</a>
  <a routerLink="/users" routerLinkActive="active">用户</a>
</nav>

<!-- 路由出口 -->
<router-outlet></router-outlet>
```

### 路由参数

```typescript
// 获取路由参数
import { ActivatedRoute } from '@angular/router';

@Component({...})
export class UserDetailComponent implements OnInit {
  userId: number = 0;
  
  constructor(private route: ActivatedRoute) {}
  
  ngOnInit() {
    // 方式1：订阅参数变化
    this.route.paramMap.subscribe(params => {
      this.userId = Number(params.get('id'));
      this.loadUser(this.userId);
    });
    
    // 方式2：获取静态参数
    // this.userId = Number(this.route.snapshot.paramMap.get('id'));
  }
  
  loadUser(id: number) {
    // 加载用户数据
  }
}
```

### 路由守卫

```typescript
// auth.guard.ts
import { Injectable } from '@angular/core';
import { CanActivate, Router, UrlTree } from '@angular/router';
import { Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(private router: Router) {}
  
  canActivate(): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {
    const isLoggedIn = localStorage.getItem('token') !== null;
    
    if (isLoggedIn) {
      return true;
    } else {
      return this.router.createUrlTree(['/login']);
    }
  }
}

// 使用守卫
// { path: 'admin', component: AdminComponent, canActivate: [AuthGuard] }
```

### 懒加载模块

```typescript
// 懒加载
{ 
  path: 'admin', 
  loadComponent: () => import('./admin/admin.component').then(m => m.AdminComponent) 
}

// 或懒加载模块
{ 
  path: 'admin', 
  loadChildren: () => import('./admin/admin.module').then(m => m.AdminModule) 
}
```

## 表单（Forms）

Angular 支持两种表单处理方式：模板驱动表单和响应式表单。

### 响应式表单

```typescript
// reactive-form.component.ts
import { Component } from '@angular/core';
import { FormBuilder, FormGroup, Validators, FormArray } from '@angular/forms';

@Component({
  selector: 'app-reactive-form',
  templateUrl: './reactive-form.component.html'
})
export class ReactiveFormComponent {
  userForm: FormGroup;
  
  constructor(private fb: FormBuilder) {
    this.userForm = this.fb.group({
      // 基本字段
      username: ['', [Validators.required, Validators.minLength(3)]],
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(6)]],
      confirmPassword: ['', Validators.required],
      
      // 嵌套表单组
      address: this.fb.group({
        street: [''],
        city: [''],
        country: ['']
      }),
      
      // 动态表单数组
      hobbies: this.fb.array([])
    }, { validators: this.passwordMatchValidator });
  }
  
  // 获取 hobbies 表单数组
  get hobbies(): FormArray {
    return this.userForm.get('hobbies') as FormArray;
  }
  
  // 添加爱好
  addHobby() {
    this.hobbies.push(this.fb.control(''));
  }
  
  // 移除爱好
  removeHobby(index: number) {
    this.hobbies.removeAt(index);
  }
  
  // 密码匹配验证
  passwordMatchValidator(form: FormGroup) {
    const password = form.get('password');
    const confirmPassword = form.get('confirmPassword');
    
    if (password && confirmPassword && password.value !== confirmPassword.value) {
      confirmPassword.setErrors({ passwordMismatch: true });
    }
    return null;
  }
  
  // 提交表单
  onSubmit() {
    if (this.userForm.valid) {
      console.log('表单数据：', this.userForm.value);
    } else {
      console.log('表单无效');
      this.userForm.markAllAsTouched();
    }
  }
  
  // 重置表单
  resetForm() {
    this.userForm.reset();
  }
}
```

```html
<!-- reactive-form.component.html -->
<form [formGroup]="userForm" (ngSubmit)="onSubmit()">
  <!-- 用户名 -->
  <div>
    <label>用户名</label>
    <input formControlName="username">
    <div *ngIf="userForm.get('username')?.touched && userForm.get('username')?.invalid">
      <small *ngIf="userForm.get('username')?.errors?.['required']">用户名必填</small>
      <small *ngIf="userForm.get('username')?.errors?.['minlength']">用户名至少3个字符</small>
    </div>
  </div>
  
  <!-- 邮箱 -->
  <div>
    <label>邮箱</label>
    <input formControlName="email" type="email">
    <div *ngIf="userForm.get('email')?.touched && userForm.get('email')?.invalid">
      <small>请输入有效的邮箱地址</small>
    </div>
  </div>
  
  <!-- 地址（嵌套表单组） -->
  <div formGroupName="address">
    <label>城市</label>
    <input formControlName="city">
  </div>
  
  <!-- 爱好（动态表单数组） -->
  <div>
    <label>爱好</label>
    <div *ngFor="let hobby of hobbies.controls; let i = index">
      <input [formControlName]="i">
      <button type="button" (click)="removeHobby(i)">删除</button>
    </div>
    <button type="button" (click)="addHobby()">添加爱好</button>
  </div>
  
  <!-- 提交按钮 -->
  <button type="submit" [disabled]="userForm.invalid">提交</button>
  <button type="button" (click)="resetForm()">重置</button>
</form>
```

## HTTP 请求

Angular 的 HttpClient 模块提供了强大的 HTTP 请求功能。

### 配置 HttpClient

```typescript
// app.config.ts
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideHttpClient(),
    provideRouter(routes)
  ]
};
```

### 发送 HTTP 请求

```typescript
import { Component, OnInit } from '@angular/core';
import { HttpClient, HttpParams, HttpHeaders } from '@angular/common/http';

@Component({
  selector: 'app-http-demo',
  template: '<p>HTTP 示例</p>'
})
export class HttpDemoComponent implements OnInit {
  private apiUrl = 'https://api.example.com';
  
  constructor(private http: HttpClient) {}
  
  ngOnInit() {
    this.getData();
    this.postData();
    this.putData();
    this.deleteData();
  }
  
  // GET 请求
  getData() {
    const params = new HttpParams()
      .set('page', '1')
      .set('limit', '10');
    
    this.http.get(`${this.apiUrl}/items`, { params }).subscribe({
      next: (data) => console.log('GET 响应：', data),
      error: (err) => console.error('GET 错误：', err)
    });
  }
  
  // POST 请求
  postData() {
    const newItem = { name: '新项目', description: '描述' };
    this.http.post(`${this.apiUrl}/items`, newItem).subscribe({
      next: (data) => console.log('POST 响应：', data)
    });
  }
  
  // PUT 请求
  putData() {
    const updatedItem = { id: 1, name: '更新后的名称' };
    this.http.put(`${this.apiUrl}/items/1`, updatedItem).subscribe({
      next: (data) => console.log('PUT 响应：', data)
    });
  }
  
  // DELETE 请求
  deleteData() {
    this.http.delete(`${this.apiUrl}/items/1`).subscribe({
      next: () => console.log('DELETE 成功')
    });
  }
  
  // 设置请求头
  getWithHeaders() {
    const headers = new HttpHeaders()
      .set('Authorization', 'Bearer token')
      .set('Content-Type', 'application/json');
    
    this.http.get(`${this.apiUrl}/protected`, { headers }).subscribe();
  }
  
  // 监听下载进度
  downloadFile() {
    this.http.get(`${this.apiUrl}/file`, { 
      responseType: 'blob',
      reportProgress: true,
      observe: 'events'
    }).subscribe(event => {
      // 处理下载进度
    });
  }
}
```

### HTTP 拦截器

```typescript
// logging.interceptor.ts
import { HttpInterceptorFn } from '@angular/common/http';

export const loggingInterceptor: HttpInterceptorFn = (req, next) => {
  console.log(`请求: ${req.method} ${req.url}`);
  
  const startTime = Date.now();
  
  return next(req).pipe(
    // 响应后记录
    tap(() => {
      const duration = Date.now() - startTime;
      console.log(`响应时间: ${duration}ms`);
    }),
    // 错误处理
    catchError(error => {
      console.error('请求错误：', error);
      throw error;
    })
  );
};

// auth.interceptor.ts
import { HttpInterceptorFn } from '@angular/common/http';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const token = localStorage.getItem('token');
  
  if (token) {
    const authReq = req.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`
      }
    });
    return next(authReq);
  }
  
  return next(req);
};
```

```typescript
// app.config.ts 使用拦截器
import { provideHttpClient, withInterceptors } from '@angular/common/http';
import { loggingInterceptor } from './interceptors/logging.interceptor';
import { authInterceptor } from './interceptors/auth.interceptor';

export const appConfig: ApplicationConfig = {
  providers: [
    provideHttpClient(
      withInterceptors([loggingInterceptor, authInterceptor])
    )
  ]
};
```

## 指令（Directive）

指令用于扩展 HTML 元素的功能。

### 属性指令

```typescript
// highlight.directive.ts
import { Directive, ElementRef, Renderer2, OnInit } from '@angular/core';

@Directive({
  selector: '[appHighlight]'
})
export class HighlightDirective implements OnInit {
  constructor(private el: ElementRef, private renderer: Renderer2) {}
  
  ngOnInit() {
    this.renderer.setStyle(this.el.nativeElement, 'backgroundColor', 'yellow');
    this.renderer.setStyle(this.el.nativeElement, 'padding', '10px');
  }
}
```

```html
<!-- 使用属性指令 -->
<p appHighlight>这段文字会被高亮显示</p>
```

### 结构指令

```html
<!-- *ngIf - 条件渲染 -->
<div *ngIf="isVisible">内容</div>
<div *ngIf="users.length > 0; else noUsers">
  有用户数据
</div>
<ng-template #noUsers>
  没有用户数据
</ng-template>

<!-- *ngFor - 循环渲染 -->
<ul>
  <li *ngFor="let user of users; let i = index; let first = first; let last = last">
    {{ i + 1 }}. {{ user.name }}
    <span *ngIf="first"> - 第一个</span>
    <span *ngIf="last"> - 最后一个</span>
  </li>
</ul>

<!-- *ngSwitch - 多条件渲染 -->
<div [ngSwitch]="status">
  <p *ngSwitchCase="'loading'">加载中...</p>
  <p *ngSwitchCase="'success'">成功</p>
  <p *ngSwitchCase="'error'">错误</p>
  <p *ngSwitchDefault>未知状态</p>
</div>

<!-- @if / @for - Angular 17+ 控制流 -->
@if (isVisible) {
  <p>内容</p>
}

@for (user of users; track user.id) {
  <p>{{ user.name }}</p>
}
```

## 管道（Pipe）

管道用于转换模板中的数据。

### 内置管道

```html
<!-- 日期管道 -->
<p>{{ today | date:'yyyy-MM-dd HH:mm' }}</p>

<!-- 货币管道 -->
<p>{{ price | currency:'CNY':'symbol':'1.2-2' }}</p>

<!-- 大小写管道 -->
<p>{{ name | uppercase }}</p>
<p>{{ name | lowercase }}</p>

<!-- 百分比管道 -->
<p>{{ 0.85 | percent:'1.0-0' }}</p>

<!-- JSON 管道 -->
<pre>{{ user | json }}</pre>

<!-- slice 管道 -->
<p>{{ name | slice:0:5 }}</p>

<!-- 异步管道 -->
<p>{{ observableData | async }}</p>
```

### 自定义管道

```bash
ng generate pipe custom-slice
```

```typescript
// custom-slice.pipe.ts
import { Pipe, PipeTransform } from '@angular/core';

@Pipe({
  name: 'customSlice',
  standalone: true
})
export class CustomSlicePipe implements PipeTransform {
  transform(value: string, start: number, end: number): string {
    if (!value) return '';
    return value.slice(start, end);
  }
}
```

## 总结

本手册涵盖了 Angular 开发中最常用的核心概念：

- **组件**：构建用户界面的基本单元
- **服务**：封装业务逻辑和数据访问
- **路由**：实现页面导航和懒加载
- **表单**：处理用户输入（模板驱动和响应式）
- **HTTP**：与后端 API 通信
- **指令**：扩展 HTML 功能
- **管道**：转换和格式化数据

掌握这些概念后，你就可以开始构建功能丰富的 Angular 应用了。建议结合官方文档和实践项目不断深化理解。
