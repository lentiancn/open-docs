# Docker 使用指南

高效使用 Docker 的完整指南。

---

## 目錄

- [基本概念](#基本概念)
- [映像檔操作](#映像檔操作)
- [容器操作](#容器操作)
- [網路管理](#網路管理)
- [儲存管理](#儲存管理)
- [Docker Compose](#docker-compose)
- [Dockerfile 最佳實踐](#dockerfile-最佳實踐)
- [常用範例](#常用範例)
- [故障排除](#故障排除)

---

## 基本概念

### 什麼是 Docker？

- **映像檔**：用於建立容器的唯讀模板
- **容器**：映像檔的執行個體
- **倉庫**：儲存映像檔的地方（Docker Hub、GCR 等）

### 關鍵術語

| 術語 | 說明 |
|------|------|
| `image` | 唯讀模板 |
| `container` | 映像檔的執行個體 |
| `volume` | 持久化儲存 |
| `network` | 容器通訊 |
| `dockerfile` | 映像檔構建腳本 |

---

## 映像檔操作

### 拉取映像檔

```bash
# 拉取最新映像檔
docker pull nginx

# 拉取指定標籤
docker pull nginx:alpine
docker pull ubuntu:22.04
```

### 列出映像檔

```bash
# 列出所有映像檔
docker images

# 列出映像檔 ID
docker images -q
```

### 刪除映像檔

```bash
# 刪除單個映像檔
docker rmi nginx

# 清理未使用的映像檔
docker image prune
```

### 構建映像檔

```bash
# 從 Dockerfile 構建
docker build -t myapp:1.0 .

# 不使用快取構建
docker build --no-cache -t myapp:1.0 .
```

---

## 容器操作

### 執行容器

```bash
# 背景執行
docker run -d nginx

# 連接埠對應
docker run -d -p 8080:80 nginx

# 掛載卷
docker run -d -v /my/data:/data nginx

# 環境變數
docker run -d -e APP_ENV=production nginx

# 互動式執行
docker run -it ubuntu bash

# 執行後刪除
docker run --rm ubuntu ls
```

### 常用執行選項

| 選項 | 說明 |
|------|------|
| `-d` | 背景執行 |
| `-p` | 連接埠對應（主機:容器） |
| `-v` | 卷掛載 |
| `-e` | 環境變數 |
| `--name` | 容器名稱 |
| `--network` | 加入網路 |
| `-it` | 互動式 TTY |
| `--rm` | 退出時自動刪除 |

### 管理容器

```bash
# 列出執行中的容器
docker ps

# 列出所有容器
docker ps -a

# 停止容器
docker stop <容器ID>

# 啟動容器
docker start <容器ID>

# 重啟容器
docker restart <容器ID>

# 刪除容器
docker rm <容器ID>

# 強制刪除執行中的容器
docker rm -f <容器ID>

# 查看日誌
docker logs <容器ID>

# 即時查看日誌
docker logs -f <容器ID>

# 在容器中執行命令
docker exec -it <容器ID> bash
```

---

## 網路管理

### 建立網路

```bash
# 建立橋接網路
docker network create my-network
```

### 連接容器

```bash
# 在網路中執行容器
docker run -d --network my-network nginx

# 連接現有容器到網路
docker network connect my-network container_name
```

---

## 儲存管理

### 卷

```bash
# 建立卷
docker volume create my-volume

# 列出卷
docker volume ls

# 刪除未使用的卷
docker volume prune
```

### 掛載主機目錄

```bash
# 掛載主機目錄
docker run -v /host/path:/container/path nginx

# 唯讀掛載
docker run -v /host/path:/container/path:ro nginx
```

---

## Docker Compose

### 基本 docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
    depends_on:
      - api

  api:
    build: ./api
    environment:
      - DATABASE_URL=postgres://db:5432/app

  db:
    image: postgres:15-alpine
    volumes:
      - db-data:/var/lib/postgresql/data

volumes:
  db-data:
```

### 常用命令

```bash
# 啟動所有服務
docker compose up -d

# 停止所有服務
docker compose down

# 查看日誌
docker compose logs -f

# 重新構建服務
docker compose up -d --build

# 在服務中執行命令
docker compose exec web bash
```

---

## Dockerfile 最佳實踐

### 好的 Dockerfile 範例

```dockerfile
# 使用特定版本標籤
FROM node:20-alpine

# 設定工作目錄
WORKDIR /app

# 先複製包文件（利用快取）
COPY package*.json ./

# 安裝依賴
RUN npm ci --only=production

# 複製原始碼
COPY . .

# 暴露連接埠
EXPOSE 3000

# 定義啟動命令
CMD ["node", "server.js"]
```

### 關鍵最佳實踐

1. **使用特定標籤**：不要使用 `latest`
2. **使用 Alpine 映像檔**：體積小，漏洞少
3. **合理排序層**：將不常變化的放在前面
4. **使用 .dockerignore**：排除不必要的檔案
5. **以非 root 使用者執行**：新增 `USER` 指令

---

## 常用範例

### 執行 Nginx

```bash
docker run -d -p 80:80 -v $(pwd)/html:/usr/share/nginx/html nginx
```

### 執行 MySQL

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  -e MYSQL_DATABASE=app \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8
```

### 執行 PostgreSQL

```bash
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=app \
  -v postgres-data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:15
```

### 執行 Redis

```bash
docker run -d \
  --name redis \
  -v redis-data:/data \
  -p 6379:6379 \
  redis:alpine redis-server --appendonly yes
```

---

## 故障排除

### 容器無法啟動

```bash
# 檢查日誌
docker logs <容器ID>

# 檢查容器狀態
docker inspect <容器ID>
```

### 磁碟空間不足

```bash
# 顯示磁碟使用情況
docker system df

# 清理
docker system prune -a
```

### 權限問題

```bash
# 修復所有權
sudo chown -R $(id -u):$(id -g) ./data

# 或指定使用者執行
docker run -u $(id -u):$(id -g) -v $(pwd):/app app
```

---

## 下一步

- 探索 [Docker Hub](https://hub.docker.com/) 獲取映像檔
- 學習 [Kubernetes](https://kubernetes.io/) 進行編排
- 閱讀 [Docker 安全](https://docs.docker.com/engine/security/) 最佳實踐
