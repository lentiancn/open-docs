# APISIX 安装指南

APISIX 多种安装方式详解。

## 环境要求

### 硬件要求

- CPU：2 核及以上
- 内存：4GB 及以上
- 磁盘：40GB 及以上

### 软件要求

- 操作系统：Linux（推荐 Ubuntu 20.04+，CentOS 7+）
- Nginx 或 OpenResty
- Lua 5.1+
- etcd 3.4+

## Docker 安装（推荐）

### 快速启动

```bash
# 启动 etcd
docker run -d --name etcd \
  -p 2379:2379 \
  -e ETCD_ADVERTISE_CLIENT_URLS=http://127.0.0.1:2379 \
  -m 512M \
  apache/apisix:latest \
  etcd

# 启动 APISIX
docker run -d --name apisix \
  -p 9080:9080 \
  -p 9090:9090 \
  -v ./config.yaml:/usr/local/apisix/conf/config.yaml \
  apache/apisix:latest
```

### docker-compose 方式

创建 docker-compose.yaml：

```yaml
version: '3'

services:
  etcd:
    image: apache/apisix:3.5.0-etcd
    ports:
      - "2379:2379"
    environment:
      - ETCD_NAME=etcd
      - ETCD_ADVERTISE_CLIENT_URLS=http://127.0.0.1:2379
    volumes:
      - etcd-data:/etcd

  apisix:
    image: apache/apisix:3.5.0
    ports:
      - "9080:9080"
      - "9090:9090"
      - "9443:9443"
    depends_on:
      - etcd
    volumes:
      - ./config.yaml:/usr/local/apisix/conf/config.yaml

volumes:
  etcd-data:
```

启动服务：

```bash
docker-compose up -d
```

## Helm 安装（Kubernetes）

### 添加仓库

```bash
helm repo add apisix https://apache.github.io/apisix-helm-chart
helm repo update
```

### 安装 APISIX

```bash
# 安装 APISIX
helm install apisix apisix/apisix \
  --set gateway.type=LoadBalancer \
  --set admin.allow.ipList="0.0.0.0/0"

# 查看状态
helm status apisix
```

### 卸载

```bash
helm uninstall apisix
```

## 源码安装

### 安装依赖

**Ubuntu/Debian：**

```bash
# 安装 OpenResty
wget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -
sudo apt-get update
sudo apt-get install -y openresty

# 安装 etcd
sudo apt-get install -y etcd

# 安装 Lua 依赖
sudo apt-get install -y lua5.1 luarocks
```

**CentOS/RHEL：**

```bash
# 安装 OpenResty
sudo yum install -y openresty

# 安装 etcd
sudo yum install -y etcd
```

### 克隆源码

```bash
git clone https://github.com/apache/apisix.git
cd apisix
git checkout 3.5.0  # 选择稳定版本
```

### 安装依赖

```bash
# 安装 APISIX 依赖
make deps

# 初始化配置
make init
```

### 启动服务

```bash
# 启动 APISIX
make run

# 或者后台运行
nohup make run &
```

### 验证安装

```bash
# 检查进程
ps aux | grep apisix

# 测试 API
curl http://127.0.0.1:9080
```

## 配置说明

### 主配置文件

主配置文件位于 `conf/config.yaml`：

```yaml
apisix:
  node_listen: 9080           # API 监听端口
  enable_admin: true          # 启用 Admin API
  admin_key:
    - name: admin
      key: 123456              # 生产环境请修改
      role: admin
  
  enable_cache: true           # 开启缓存
  cache:
    cache_local: true
    redis:
      host: 127.0.0.1
      port: 6379
      password: ""
      database: 0

etcd:
  host:
    - "http://127.0.0.1:2379"
  prefix: /apisix              # etcd 路径前缀
  timeout: 30

deployment:
  role: traditional
  role_traditional:
    config_provider: etcd
```

### 环境变量配置

也可以通过环境变量配置：

```bash
APISIX_DASHBOARD_PORT=9090 APISIX_LISTEN_PORT=9080 apisix start
```

## Admin API 配置

### 开启 Admin API

```yaml
apisix:
  enable_admin: true
  admin_key:
    - name: admin
      key: your-secret-key    # 修改为强密钥
      role: admin
```

### 访问控制

```yaml
apisix:
  admin_api_mtls:
    enabled: true
    cert: /path/to/cert.pem
    key: /path/to/key.pem
```

## 常见问题

### 端口被占用

```bash
# 查看端口占用
netstat -tlnp | grep 9080

# 修改端口
apisix:
  node_listen: 9081
```

### etcd 连接失败

```bash
# 检查 etcd 状态
etcdctl endpoint health

# 启动 etcd
etcd --data-dir=/var/lib/etcd
```

### 权限问题

```bash
# 赋予目录权限
sudo chown -R nobody:nobody /usr/local/apisix/logs
```

## 卸载

### Docker 卸载

```bash
docker stop apisix etcd
docker rm apisix etcd
```

### 源码安装卸载

```bash
cd apisix
make stop
make uninstall
```

## 下一步

- 配置你的第一个路由：参见「使用手册」
- 配置插件实现认证
- 配置负载均衡
