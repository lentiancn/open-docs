# Docker 使用手册

本手册将介绍 Docker 的核心概念、常用操作和最佳实践。

## 镜像操作

### 搜索和拉取镜像

```bash
# 搜索镜像
docker search nginx

# 拉取镜像（默认 latest 标签）
docker pull nginx

# 拉取指定版本
docker pull nginx:1.25

# 拉取指定平台
docker pull --platform linux/amd64 nginx
```

### 查看镜像

```bash
# 列出本地镜像
docker images
docker image ls

# 查看镜像详细信息
docker image inspect nginx:latest

# 查看镜像层
docker history nginx:latest
```

### 构建镜像

```dockerfile
# Dockerfile 示例
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制文件
COPY package*.json ./

# 安装依赖
RUN npm install

# 复制源代码
COPY . .

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["node", "server.js"]
```

```bash
# 构建镜像
docker build -t myapp:latest .
docker build -t myapp:latest -f Dockerfile.prod .

# 使用构建缓存
docker build --cache-from myapp:previous .

# 多阶段构建
docker build -t myapp:latest .
```

### 删除镜像

```bash
# 删除单个镜像
docker rmi nginx:latest

# 删除未使用的镜像
docker image prune

# 删除所有未使用的镜像
docker image prune -a

# 强制删除
docker rmi -f nginx:latest
```

## 容器操作

### 创建和运行容器

```bash
# 基础运行
docker run nginx

# 后台运行
docker run -d nginx

# 指定名称
docker run -d --name mynginx nginx

# 端口映射
docker run -d -p 8080:80 nginx

# 环境变量
docker run -d -e APP_ENV=production nginx

# 挂载卷
docker run -d -v /host/path:/container/path nginx

# 资源限制
docker run -d --memory=512m --cpus=0.5 nginx
```

### 查看容器

```bash
# 运行中的容器
docker ps

# 所有容器（包括停止的）
docker ps -a

# 显示容器 ID
docker ps -q

# 显示容器数量
docker ps -a -q

# 查看容器详细信息
docker inspect mynginx
```

### 启动、停止、重启

```bash
# 启动容器
docker start mynginx

# 停止容器
docker stop mynginx

# 重启容器
docker restart mynginx

# 暂停容器
docker pause mynginx

# 取消暂停
docker unpause mynginx
```

### 删除容器

```bash
# 删除停止的容器
docker rm mynginx

# 强制删除运行中的容器
docker rm -f mynginx

# 删除已停止的所有容器
docker container prune

# 删除所有容器
docker rm -f $(docker ps -aq)
```

### 进入容器

```bash
# 进入容器（交互式）
docker exec -it mynginx bash
docker exec -it mynginx sh

# 执行单条命令
docker exec mynginx ls /app

# 从主机复制文件到容器
docker cp index.html mynginx:/usr/share/nginx/html/

# 从容器复制文件到主机
docker cp mynginx:/usr/share/nginx/html/index.html ./
```

### 查看日志

```bash
# 查看日志
docker logs mynginx

# 实时日志
docker logs -f mynginx

# 查看最近 100 行
docker logs --tail 100 mynginx

# 显示时间戳
docker logs -t mynginx
```

## 数据管理

### 卷（Volume）

```bash
# 创建卷
docker volume create mydata

# 查看卷
docker volume ls

# 查看卷详细信息
docker volume inspect mydata

# 使用卷运行容器
docker run -d -v mydata:/data nginx

# 删除未使用的卷
docker volume prune

# 删除指定卷
docker volume rm mydata
```

### 绑定挂载

```bash
# 挂载主机目录
docker run -d -v /host/path:/container/path nginx

# 挂载主机文件
docker run -d -v /host/file:/container/file:ro nginx

# 只读挂载
docker run -d -v /host/path:/container/path:ro nginx
```

## 网络

### 网络操作

```bash
# 列出网络
docker network ls

# 创建网络
docker network create mynetwork

# 查看网络详情
docker network inspect mynetwork

# 连接容器到网络
docker network connect mynetwork mynginx

# 断开容器网络
docker network disconnect mynetwork mynginx

# 删除网络
docker network rm mynetwork
```

### 网络类型

| 驱动 | 说明 |
|------|------|
| bridge | 默认网络，容器间通信 |
| host | 共享主机网络 |
| overlay | 跨主机通信（Swarm） |
| none | 无网络 |

```bash
# 使用 bridge 网络
docker run -d --network bridge nginx

# 使用 host 网络
docker run -d --network host nginx

# 使用自定义网络（推荐）
docker network create mynet
docker run -d --network mynet nginx
```

## Docker Compose

### docker-compose.yml 示例

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8080:3000"
    environment:
      - NODE_ENV=production
    volumes:
      - ./data:/app/data
    depends_on:
      - redis
    networks:
      - mynet

  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    networks:
      - mynet

volumes:
  redis-data:

networks:
  mynet:
    driver: bridge
```

### 常用命令

```bash
# 启动服务
docker-compose up
docker-compose up -d

# 停止服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 构建镜像
docker-compose build

# 重新构建
docker-compose up --build

# 扩展服务（Swarm）
docker-compose up -d --scale web=3
```

## Dockerfile 最佳实践

### 1. 使用官方基础镜像

```dockerfile
# 推荐
FROM node:18-alpine

# 不推荐
FROM ubuntu:20.04
RUN apt-get install nodejs
```

### 2. 减少层数

```dockerfile
# 不好 - 多层
RUN apt-get update
RUN apt-get install -y nginx
RUN rm -rf /var/lib/apt/lists/*

# 好 - 单层
RUN apt-get update && \
    apt-get install -y nginx && \
    rm -rf /var/lib/apt/lists/*
```

### 3. 使用 .dockerignore

```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
```

### 4. 多阶段构建

```dockerfile
# 构建阶段
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 运行阶段
FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
CMD ["node", "server.js"]
```

### 5. 正确设置工作目录

```dockerfile
WORKDIR /app
COPY . .
```

### 6. 使用特定版本标签

```dockerfile
# 不推荐
FROM node:latest

# 推荐
FROM node:18.17.0-alpine3.18
```

## 资源限制

### 内存限制

```bash
# 限制内存
docker run -d --memory=512m nginx

# 限制内存和交换空间
docker run -d --memory=512m --memory-swap=1g nginx
```

### CPU 限制

```bash
# 限制 CPU 核心数
docker run -d --cpus=0.5 nginx

# 限制特定 CPU 核心
docker run -d --cpuset-cpus="0,1" nginx
```

## 安全最佳实践

### 1. 不以 root 用户运行

```dockerfile
# 创建用户
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

USER appuser
```

### 2. 扫描镜像漏洞

```bash
# 使用 Trivy
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image nginx:latest

# 使用 Docker Scout
docker scout cves nginx:latest
```

### 3. 使用只读文件系统

```dockerfile
# 只读挂载
docker run --read-only -v /tmp nginx
```

## 监控和调试

### 监控容器

```bash
# 查看资源使用
docker stats

# 查看特定容器
docker stats mynginx

# 实时监控
docker stats --no-stream
```

### 调试

```bash
# 进入容器
docker exec -it mynginx sh

# 查看进程
docker top mynginx

# 查看网络
docker exec mynginx netstat -tulpn
```

## Docker 清理

```bash
# 清理未使用的容器
docker container prune

# 清理未使用的镜像
docker image prune

# 清理未使用的卷
docker volume prune

# 清理网络
docker network prune

# 清理所有未使用的对象
docker system prune

# 完全清理（包括构建缓存）
docker system prune -a --volumes
```

## 总结

本手册涵盖了 Docker 开发的常用操作：

- **镜像**：搜索、拉取、构建、删除
- **容器**：创建、运行、停止、删除
- **数据管理**：卷、绑定挂载
- **网络**：网络配置、连接
- **Docker Compose**：多容器编排
- **最佳实践**：Dockerfile、安全、性能

掌握这些内容后，你就可以熟练使用 Docker 进行应用开发和部署了。
