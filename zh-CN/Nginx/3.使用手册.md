# Nginx 使用手册

本手册介绍 Nginx 的核心配置和实际使用方法。

## 基础配置

### 最简单配置

```nginx
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name localhost;
        
        location / {
            root html;
            index index.html index.htm;
        }
    }
}
```

## 虚拟主机

### HTTP 虚拟主机

```nginx
# 站点 1
server {
    listen 80;
    server_name site1.com;
    root /var/www/site1;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 站点 2
server {
    listen 80;
    server_name site2.com;
    root /var/www/site2;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### HTTPS 虚拟主机

```nginx
server {
    listen 443 ssl http2;
    server_name example.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    location / {
        root /var/www/https;
        index index.html;
    }
}
```

## 反向代理

### 基本反向代理

```nginx
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        
        # 设置代理请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### WebSocket 代理

```nginx
location /ws/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}
```

### 带缓冲的代理

```nginx
location / {
    proxy_pass http://backend;
    
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

## 负载均衡

### 基本负载均衡

```nginx
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### 加权负载均衡

```nginx
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com weight=2;
    server backend3.example.com weight=1;
}
```

### 最少连接

```nginx
upstream backend {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
}
```

### IP 哈希

```nginx
upstream backend {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
}
```

### 健康检查

```nginx
upstream backend {
    server backend1.example.com max_fails=3 fail_timeout=30s;
    server backend2.example.com;
}
```

## 静态文件服务

### 静态文件

```nginx
server {
    listen 80;
    server_name static.example.com;
    root /var/www/static;
    
    # 缓存配置
    expires 7d;
    add_header Cache-Control "public, no-transform";
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript image/svg+xml;
    
    location / {
        autoindex on;
        try_files $uri $uri/ =404;
    }
}
```

### 防盗链

```nginx
location /images/ {
    valid_referers none blocked example.com;
    
    if ($invalid_referer) {
        return 403;
    }
}
```

## URL 重写

### 简单重写

```nginx
# 将 /about 重定向到 /pages/about
rewrite ^/about$ /pages/about last;

# 永久重定向
rewrite ^/old$(.*) /new$1 permanent;

# 临时重定向
rewrite ^/temp$(.*) /new$1 redirect;
```

### 去除 www

```nginx
server {
    listen 80;
    server_name www.example.com;
    return 301 http://example.com$request_uri;
}
```

### 添加尾部斜杠

```nginx
rewrite ^/(.*[^/])$ /$1/ permanent;
```

## 限流

### 请求限流

```nginx
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    
    server {
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
        }
    }
}
```

### 连接限流

```nginx
http {
    limit_conn_zone $binary_remote_addr zone=addr_limit:10m;
    
    server {
        location / {
            limit_conn addr_limit 10;
        }
    }
}
```

## 缓存配置

### 浏览器缓存

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```

### 代理缓存

```nginx
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=my_cache:10m inactive=60m use_temp_path=off;

server {
    location / {
        proxy_cache my_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;
    }
}
```

## 常见配置示例

### WordPress

```nginx
server {
    listen 80;
    server_name example.com;
    root /var/www/wordpress;
    index index.php index.html;
    
    location / {
        try_files $uri $uri/ /index.php?$args;
    }
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires max;
        log_not_found off;
    }
}
```

### Node.js

```nginx
server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### SSL 配置

```nginx
server {
    listen 443 ssl http2;
    server_name example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL 配置
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    location / {
        root /var/www/html;
        index index.html;
    }
}
```

## 常用指令

| 指令 | 说明 |
|------|------|
| listen | 监听端口 |
| server_name | 虚拟主机名 |
| root | 文档根目录 |
| location | URL 匹配 |
| proxy_pass | 代理地址 |
| rewrite | URL 重写 |
| expires | 缓存过期 |
| gzip | 压缩 |

## 总结

本手册涵盖了 Nginx 开发的常用配置：

- **虚拟主机**：HTTP、HTTPS
- **反向代理**：基本、WebSocket、带缓冲
- **负载均衡**：加权、最少连接、IP 哈希
- **静态文件**：服务、缓存、防盗链
- **URL 重写**：重定向
- **限流**：请求、连接
- **缓存**：浏览器、代理

掌握这些配置后，你就可以熟练使用 Nginx 了。
