# Docker Usage Guide

This guide provides detailed instructions for using Docker effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Working with Images](#working-with-images)
- [Working with Containers](#working-with-containers)
- [Networking](#networking)
- [Storage](#storage)
- [Docker Compose](#docker-compose)
- [Dockerfile Best Practices](#dockerfile-best-practices)
- [Common Scenarios](#common-scenarios)
- [Troubleshooting](#troubleshooting)

---

## Basic Concepts

| Concept | Description |
|---------|-------------|
| **Image** | A read-only template for creating containers |
| **Container** | A running instance of an image |
| **Registry** | Where images are stored (e.g., Docker Hub) |
| **Dockerfile** | Script file for building images |

---

## Working with Images

### Pull Images

```bash
# Pull latest image
docker pull nginx

# Pull specific tag
docker pull nginx:alpine
docker pull ubuntu:22.04

# Pull from custom registry
docker pull gcr.io/project/image:latest
docker pull registry.example.com/myapp:v1.0
```

### List Images

```bash
# List all images
docker images

# Show details
docker images -a

# Show only IDs
docker images -q
```

### Remove Images

```bash
# Remove single image
docker rmi nginx

# Force remove
docker rmi -f nginx

# Remove unused images
docker image prune

# Remove all unused images
docker image prune -a
```

### Build Images

```bash
# Build from current directory
docker build -t myapp:1.0 .

# Build without cache
docker build --no-cache -t myapp:1.0 .

# Build with build arguments
docker build --build-arg VERSION=1.0 -t myapp:1.0 .
```

---

## Working with Containers

### Run Containers

```bash
# Run in background (detached)
docker run -d nginx

# Run with port mapping
docker run -d -p 8080:80 nginx
docker run -d -p 8080:80 -p 443:443 nginx

# Run with volume
docker run -d -v /my/data:/data nginx
docker run -d -v $(pwd)/html:/usr/share/nginx/html nginx

# Run with environment variables
docker run -d -e APP_ENV=production -e DB_HOST=localhost nginx

# Run with name
docker run -d --name my-nginx nginx

# Run interactively
docker run -it ubuntu bash

# Run and remove after exit
docker run --rm ubuntu ls

# Run with network
docker run -d --network my-network nginx

# Specify restart policy
docker run -d --restart=always nginx
docker run -d --restart=on-failure:3 nginx
```

### Common Run Options

| Option | Description |
|--------|-------------|
| `-d` | Run in background |
| `-p` | Port mapping (host:container) |
| `-v` | Volume mount |
| `-e` | Environment variable |
| `--name` | Container name |
| `--network` | Network to join |
| `-it` | Interactive TTY |
| `--rm` | Auto-remove on exit |
| `--restart` | Restart policy |
| `--privileged` | Grant privileged access |
| `-u` | Specify user |

### Manage Containers

```bash
# List running containers
docker ps

# List all containers
docker ps -a

# Stop container
docker stop <container_id>

# Start container
docker start <container_id>

# Restart container
docker restart <container_id>

# Remove container
docker rm <container_id>

# Force remove running container
docker rm -f <container_id>

# View logs
docker logs <container_id>

# Follow logs in real-time
docker logs -f <container_id>

# View recent logs
docker logs --tail 100 <container_id>

# Execute command in running container
docker exec -it <container_id> bash
docker exec -it <container_id> sh

# Copy files (container -> host)
docker cp <container_id>:/path/in/container /local/path

# Copy files (host -> container)
docker cp /local/path <container_id>:/path/in/container

# Inspect container details
docker inspect <container_id>

# View resource usage
docker stats <container_id>
```

---

## Networking

### Create Network

```bash
# Create bridge network
docker network create my-network

# Create overlay network (Swarm mode)
docker network create -d overlay my-overlay
```

### Connect Containers

```bash
# Run container in network
docker run -d --network my-network nginx

# Connect existing container to network
docker network connect my-network container_name

# Disconnect container from network
docker network disconnect my-network container_name
```

### Network Operations

```bash
# List all networks
docker network ls

# Inspect network
docker network inspect bridge
docker network inspect my-network

# Remove unused networks
docker network prune

# Remove specified network
docker network rm my-network
```

---

## Storage Management

### Volumes

```bash
# Create volume
docker volume create my-volume

# List volumes
docker volume ls

# Inspect volume
docker volume inspect my-volume

# Remove unused volumes
docker volume prune

# Remove specified volume
docker volume rm my-volume
```

### Bind Mounts

```bash
# Mount host directory
docker run -v /host/path:/container/path nginx

# Read-only mount
docker run -v /host/path:/container/path:ro nginx
```

### tmpfs Mounts (RAM)

```bash
# Mount tmpfs
docker run --tmpfs /app nginx
```

---

## Docker Compose

### Basic docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
    environment:
      - NGINX_HOST=localhost
    depends_on:
      - api
    networks:
      - app-network

  api:
    build: ./api
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgres://db:5432/app
    depends_on:
      - db
    networks:
      - app-network

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=app
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - app-network

networks:
  app-network:

volumes:
  db-data:
```

### Common Commands

```bash
# Start all services
docker compose up -d

# Stop all services
docker compose down

# View logs in real-time
docker compose logs -f
docker compose logs -f web

# Rebuild and start
docker compose up -d --build

# Scale service
docker compose up -d --scale web=3

# Execute command in service
docker compose exec web bash
docker compose exec api sh

# Stop and remove volumes
docker compose down -v

# View service status
docker compose ps

# Validate configuration
docker compose config
```

---

## Dockerfile Best Practices

### Good Dockerfile Example

```dockerfile
# Use specific version tags, not latest
FROM node:20-alpine

# Set working directory
WORKDIR /app

# Copy package files first (layer caching)
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Define startup command
CMD ["node", "server.js"]
```

### Key Best Practices

1. **Use specific tags**: Don't use `latest`
2. **Use Alpine images**: Smaller size, fewer vulnerabilities
3. **Optimize layer order**: Put less frequently changed items first
4. **Use .dockerignore**: Exclude unnecessary files
5. **Run as non-root**: Add USER instruction
6. **Multi-stage builds**: Reduce final image size

### Multi-Stage Build Example

```dockerfile
# Build stage
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Run stage
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
EXPOSE 3000
CMD ["node", "dist/server.js"]
```

### .dockerignore Example

```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
*.md
dist
coverage
.vscode
.idea
```

---

## Common Scenarios

### Run Nginx with Web Files

```bash
docker run -d \
  -p 80:80 \
  -v $(pwd)/html:/usr/share/nginx/html \
  --name my-nginx \
  nginx:alpine
```

### Run MySQL

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  -e MYSQL_DATABASE=app \
  -e MYSQL_USER=user \
  -e MYSQL_PASSWORD=password \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8
```

### Run PostgreSQL

```bash
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=app \
  -v postgres-data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:15
```

### Run Redis

```bash
docker run -d \
  --name redis \
  -v redis-data:/data \
  -p 6379:6379 \
  redis:alpine redis-server --appendonly yes
```

### Run Full Application Stack

```bash
# Create network
docker network create app-network

# Start database
docker run -d \
  --name db \
  --network app-network \
  -v db-data:/var/lib/postgresql/data \
  -e POSTGRES_PASSWORD=secret \
  postgres:15

# Start backend
docker run -d \
  --name backend \
  --network app-network \
  -p 3000:3000 \
  -e DATABASE_URL=postgres://db:5432/app \
  mybackend:latest

# Start frontend
docker run -d \
  --name frontend \
  --network app-network \
  -p 80:80 \
  myfrontend:latest
```

---

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker logs <container>

# Inspect container
docker inspect <container>

# Check resource usage
docker stats <container>

# Check disk space
docker system df
```

### Network Issues

```bash
# Inspect network
docker network inspect <network>

# Test DNS resolution
docker exec <container> ping host.docker.internal

# Check port usage
netstat -tuln | grep <port>
```

### Disk Space Issues

```bash
# Show disk usage
docker system df

# Clean up
docker system prune -a
docker volume prune
docker builder prune -a
```

### Permission Issues

```bash
# Fix ownership
sudo chown -R $(id -u):$(id -g) ./data

# Or run with specific user
docker run -u $(id -u):$(id -g) -v $(pwd):/app app
```

### Data Migration

```bash
# Export container
docker export my-container > my-container.tar

# Import as image
cat my-container.tar | docker import - my-image:latest

# Commit container to image
docker commit my-container my-image:latest

# Save image
docker save my-image:latest > my-image.tar

# Load image
docker load < my-image.tar
```

---

## Quick Reference

### Images

```bash
docker pull <image>      # Pull image
docker images           # List images
docker rmi <image>      # Remove image
docker build -t <name>  # Build image
```

### Containers

```bash
docker run -d <image>           # Run container
docker ps                       # List containers
docker stop/start <container>   # Stop/start
docker logs <container>         # View logs
docker exec -it <container> sh # Enter container
docker rm <container>          # Remove container
```

### Docker Compose

```bash
docker compose up -d      # Start
docker compose down       # Stop
docker compose logs -f   # Logs
docker compose build     # Build
```

---

## Next Steps

- Explore [Docker Hub](https://hub.docker.com/) for images
- Learn [Kubernetes](https://kubernetes.io/) for orchestration
- Read [Docker Security Best Practices](https://docs.docker.com/engine/security/)
