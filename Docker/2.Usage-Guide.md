# Docker Usage Guide

Comprehensive guide for using Docker effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Working with Images](#working-with-images)
- [Working with Containers](#working-with-containers)
- [Networking](#networking)
- [Storage](#storage)
- [Docker Compose](#docker-compose)
- [Dockerfile Best Practices](#dockerfile-best-practices)
- [Common Recipes](#common-recipes)
- [Troubleshooting](#troubleshooting)

---

## Basic Concepts

### What is Docker?

- **Image**: A read-only template for creating containers
- **Container**: A running instance of an image
- **Registry**: Where images are stored (Docker Hub, GCR, etc.)

### Key Terms

| Term | Description |
|------|-------------|
| `docker` | CLI tool for Docker |
| `image` | Read-only template |
| `container` | Running instance of image |
| `volume` | Persistent storage |
| `network` | Container communication |
| `dockerfile` | Image build script |

---

## Working with Images

### Pull Images

```bash
# Pull latest image
docker pull nginx

# Pull specific tag
docker pull nginx:alpine
docker pull ubuntu:22.04

# Pull from custom registry
docker pull gcr.io/project/image:latest
```

### List Images

```bash
# List all images
docker images

# List with size
docker images -a

# List image IDs only
docker images -q
```

### Remove Images

```bash
# Remove single image
docker rmi nginx

# Remove unused images
docker image prune

# Remove all unused images
docker image prune -a
```

### Build Images

```bash
# Build from Dockerfile
docker build -t myapp:1.0 .

# Build with cache control
docker build --no-cache -t myapp:1.0 .

# Build with build arguments
docker build --build-arg VERSION=1.0 -t myapp:1.0 .
```

---

## Working with Containers

### Run Containers

```bash
# Run in background (detached)
docker run -d nginx

# Run with port mapping
docker run -d -p 8080:80 nginx

# Run with volume
docker run -d -v /my/data:/data nginx

# Run with environment variables
docker run -d -e APP_ENV=production nginx

# Run interactively
docker run -it ubuntu bash

# Run and remove after exit
docker run --rm ubuntu ls
```

### Common Run Options

| Option | Description |
|--------|-------------|
| `-d` | Detached mode |
| `-p` | Port mapping (host:container) |
| `-v` | Volume mapping |
| `-e` | Environment variable |
| `--name` | Container name |
| `--network` | Network to join |
| `-it` | Interactive TTY |
| `--rm` | Auto-remove on exit |
| `--restart` | Restart policy |

### Manage Containers

```bash
# List running containers
docker ps

# List all containers
docker ps -a

# Stop container
docker stop <container_id>

# Start container
docker start <container_id>

# Restart container
docker restart <container_id>

# Remove container
docker rm <container_id>

# Force remove running container
docker rm -f <container_id>

# View logs
docker logs <container_id>

# Follow logs
docker logs -f <container_id>

# Execute command in running container
docker exec -it <container_id> bash

# Copy files between container and host
docker cp <container_id>:/path/in/container /local/path
docker cp /local/path <container_id>:/path/in/container
```

### Container Lifecycle

```
Created → Running → Paused → Stopped → Deleted
   ↑         ↓         ↓         ↓
   └─────────┴─────────┴─────────┘ (docker rm)
```

---

## Networking

### Create Network

```bash
# Create bridge network
docker network create my-network

# Create overlay network (swarm)
docker network create -d overlay my-overlay
```

### Connect Containers

```bash
# Run container in network
docker run -d --network my-network nginx

# Connect existing container to network
docker network connect my-network container_name
```

### Inspect Network

```bash
# List networks
docker network ls

# Inspect network
docker network inspect bridge
```

---

## Storage

### Volumes

```bash
# Create volume
docker volume create my-volume

# List volumes
docker volume ls

# Inspect volume
docker volume inspect my-volume

# Remove unused volumes
docker volume prune
```

### Bind Mounts

```bash
# Mount host directory
docker run -v /host/path:/container/path nginx

# Mount read-only
docker run -v /host/path:/container/path:ro nginx
```

### tmpfs Mounts (RAM)

```bash
# Mount tmpfs
docker run --tmpfs /app nginx
```

---

## Docker Compose

### Basic docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
    environment:
      - NGINX_HOST=localhost
    depends_on:
      - api

  api:
    build: ./api
    environment:
      - DATABASE_URL=postgres://db:5432/app
    volumes:
      - api-data:/app/data

  db:
    image: postgres:15-alpine
    volumes:
      - db-data:/var/lib/postgresql/data

volumes:
  db-data:
```

### Common Commands

```bash
# Start all services
docker compose up -d

# Stop all services
docker compose down

# View logs
docker compose logs -f

# Rebuild services
docker compose up -d --build

# Scale service
docker compose up -d --scale web=3

# Execute command in service
docker compose exec web bash

# Stop and remove volumes
docker compose down -v
```

---

## Dockerfile Best Practices

### Good Dockerfile Example

```dockerfile
# Use specific version tag
FROM node:20-alpine

# Set working directory
WORKDIR /app

# Copy package files first (layer caching)
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Define startup command
CMD ["node", "server.js"]
```

### Key Best Practices

1. **Use specific tags**: Don't use `latest`
2. **Use Alpine images**: Smaller size, fewer vulnerabilities
3. **Order layers**: Put less frequently changed items first
4. **Use .dockerignore**: Exclude unnecessary files
5. **Run as non-root**: Add `USER` instruction
6. **Multi-stage builds**: Reduce final image size

---

## Common Recipes

### Run Nginx with HTML

```bash
docker run -d -p 80:80 -v $(pwd)/html:/usr/share/nginx/html nginx
```

### Run MySQL

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  -e MYSQL_DATABASE=app \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8
```

### Run PostgreSQL

```bash
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=app \
  -v postgres-data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:15
```

### Run Redis

```bash
docker run -d \
  --name redis \
  -v redis-data:/data \
  -p 6379:6379 \
  redis:alpine redis-server --appendonly yes
```

### Run Full Stack App

```bash
docker network create app-network

docker run -d --name frontend --network app-network -p 80:80 frontend:latest
docker run -d --name backend --network app-network -p 3000:3000 backend:latest
docker run -d --name db --network app-network -v db-data:/var/lib/postgresql/data postgres:15
```

---

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker logs <container>

# Inspect container
docker inspect <container>

# Check resource limits
docker stats <container>
```

### Network Issues

```bash
# Inspect network
docker network inspect <network>

# Check DNS resolution
docker exec <container> ping host.docker.internal
```

### Disk Space

```bash
# Show disk usage
docker system df

# Clean up
docker system prune -a
docker volume prune
```

### Permission Denied

```bash
# Fix ownership
sudo chown -R $(id -u):$(id -g) ./data

# Or run with user
docker run -u $(id -u):$(id -g) -v $(pwd):/app app
```

---

## Next Steps

- Explore [Docker Hub](https://hub.docker.com/) for images
- Learn about [Kubernetes](https://kubernetes.io/) for orchestration
- Read [Docker Security](https://docs.docker.com/engine/security/) best practices
