# Yarn ğŸ§¶

## ä»€ä¹ˆæ˜¯ Yarnï¼Ÿ

Yarn æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„**è½¯ä»¶åŒ…ç®¡ç†å™¨**ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é¡¹ç›®ç®¡ç†è€…ã€‚æ— è®ºæ˜¯å¤„ç†ç®€å•çš„é¡¹ç›®è¿˜æ˜¯å¤§å‹ monorepoï¼Œæ— è®ºä½ æ˜¯å¼€æºå¼€å‘è€…è¿˜æ˜¯ä¼ä¸šç”¨æˆ·ï¼ŒYarn éƒ½èƒ½ä¸ºä½ æä¾›å‡ºè‰²çš„æ”¯æŒã€‚

Yarn æ˜¯ä¸“é—¨ä¸º JavaScript é¡¹ç›®è®¾è®¡çš„ä¾èµ–ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°å®‰è£…ã€æ›´æ–°ã€é…ç½®å’Œåˆ é™¤è½¯ä»¶åŒ…ã€‚å®ƒä¸“æ³¨äº**é€Ÿåº¦**ã€**æ­£ç¡®æ€§**ã€**å®‰å…¨æ€§**å’Œ**å¼€å‘è€…ä½“éªŒ**ï¼Œé€šè¿‡åˆ›æ–°çš„åŠŸèƒ½ï¼ˆå¦‚å·¥ä½œåŒºã€ç¦»çº¿ç¼“å­˜ã€å¹¶è¡Œå®‰è£…ã€ç¡¬åŒ–æ¨¡å¼ã€äº¤äº’å¼å‘½ä»¤ç­‰ï¼‰ä¸æ–­æ”¹è¿›å„ä¸ªæ–¹é¢ã€‚

### Yarn çš„æ ¸å¿ƒç‰¹ç‚¹

- **å·¥ä½œåŒºï¼ˆWorkspacesï¼‰**ï¼šé¦–ä¸ªä¸“é—¨ä¸ºå·¥ä½œåŒºè®¾è®¡çš„åŒ…ç®¡ç†å™¨ï¼Œè®©ä½ å°†é¡¹ç›®æ‹†åˆ†ä¸ºå¤šä¸ªå­ç»„ä»¶
- **ç¨³å®šæ€§**ï¼šYarn ä¿è¯ä»Šå¤©èƒ½æ­£å¸¸å·¥ä½œçš„å®‰è£…åœ¨æœªæ¥ä¹Ÿèƒ½ä»¥ç›¸åŒæ–¹å¼è¿è¡Œ
- **æ–‡æ¡£å®Œå–„**ï¼šæˆ‘ä»¬éå¸¸é‡è§†æ–‡æ¡£ç»´æŠ¤ï¼Œæ¯ä¸ªæ–°ç‰ˆæœ¬éƒ½ä¼šä¸æ–­æ”¹è¿›
- **æ’ä»¶ç³»ç»Ÿ**ï¼šYarn å¯èƒ½æ— æ³•è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†å®ƒä¼šæä¾›å·¥å…·è®©ä½ è§£å†³é‡åˆ°çš„é—®é¢˜
- **åˆ›æ–°ç²¾ç¥**ï¼šæˆ‘ä»¬ç›¸ä¿¡æŒ‘æˆ˜ç°çŠ¶ï¼ŒYarn å°†å§‹ç»ˆç«™åœ¨å‰æ²¿
- **å®Œå…¨ç‹¬ç«‹**ï¼šYarn æ˜¯ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„å¼€æºé¡¹ç›®ï¼Œä¸å—ä»»ä½•å…¬å¸çº¦æŸ

### é€‚ç”¨åœºæ™¯

- å¤„ç†ç®€å•é¡¹ç›®
- ç®¡ç†å¤§å‹ monorepo
- ä¼ä¸šçº§åº”ç”¨å¼€å‘
- å¼€æºé¡¹ç›®ç»´æŠ¤
- è·¨å›¢é˜Ÿåä½œé¡¹ç›®

---

## ä¸»è¦åŠŸèƒ½

### 1. å·¥ä½œåŒºï¼ˆWorkspacesï¼‰

å·¥ä½œåŒºæ˜¯ Yarn æœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä½ åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ç®¡ç†å¤šä¸ªåŒ…ã€‚å½“ä½ æœ‰ä¸€ä¸ªæ ¸å¿ƒåŒ…å’Œå¤šä¸ªé™„åŠ ç»„ä»¶æ—¶ï¼Œå·¥ä½œåŒºç‰¹åˆ«æœ‰ç”¨ï¼ˆä¾‹å¦‚ Babelï¼‰ï¼›æˆ–è€…å½“ä½ éœ€è¦å‘å¸ƒå¤šä¸ªåŒ…å¹¶å¸Œæœ›è´¡çŒ®è€…èƒ½å¤Ÿåœ¨å•ä¸ª PR ä¸­è¿›è¡Œæ›´æ”¹æ—¶ï¼ˆä¾‹å¦‚ Jestï¼‰ã€‚

**å·¥ä½œåŒºçš„ä¸»è¦ä¼˜åŠ¿ï¼š**
- ç®€åŒ–è·¨åŒ…å¼•ç”¨
- ç»Ÿä¸€ä¾èµ–ç®¡ç†
- å‡å°‘é‡å¤å®‰è£…
- é›†ä¸­ç‰ˆæœ¬æ§åˆ¶

### 2. ç¦»çº¿ç¼“å­˜

Yarn ä¼šç¼“å­˜ä½ å®‰è£…çš„æ¯ä¸ªåŒ…ï¼Œä½¿å¾—åç»­å®‰è£…å¯ä»¥å®Œå…¨ç¦»çº¿å®Œæˆã€‚è¿™æ„å‘³ç€å³ä½¿æ²¡æœ‰ç½‘ç»œè¿æ¥ï¼Œä½ ä»ç„¶å¯ä»¥å®‰è£…é¡¹ç›®ä¾èµ–ã€‚

### 3. å¹¶è¡Œå®‰è£…

Yarn é‡‡ç”¨å¹¶è¡Œå®‰è£…ç­–ç•¥ï¼ŒåŒæ—¶å®‰è£…å¤šä¸ªåŒ…ï¼Œæ˜¾è‘—æå‡å®‰è£…é€Ÿåº¦ã€‚

### 4. ç¡®å®šæ€§å®‰è£…

Yarn ä½¿ç”¨ yarn.lock æ–‡ä»¶ç²¾ç¡®è®°å½•æ¯ä¸ªä¾èµ–çš„ç‰ˆæœ¬ï¼Œç¡®ä¿æ‰€æœ‰å›¢é˜Ÿæˆå‘˜å’Œæ‰€æœ‰ç¯å¢ƒä¸­çš„å®‰è£…ç»“æœå®Œå…¨ä¸€è‡´ã€‚

### 5. å®‰å…¨æ€§

Yarn åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¼šéªŒè¯æ¯ä¸ªåŒ…çš„å®Œæ•´æ€§ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç è¿›å…¥ä½ çš„é¡¹ç›®ã€‚

### 6. æ’ä»¶ç³»ç»Ÿ

Yarn æä¾›äº†å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸ä½ æ‰©å±•å…¶åŠŸèƒ½ä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£… Yarn

**ä½¿ç”¨ npm å®‰è£…ï¼š**

```bash
npm install -g yarn
```

**ä½¿ç”¨ corepack å®‰è£…ï¼ˆæ¨èï¼‰ï¼š**

```bash
corepack enable
corepack prepare yarn@stable --activate
```

**ä½¿ç”¨è„šæœ¬å®‰è£…ï¼ˆmacOS/Linuxï¼‰ï¼š**

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash
```

**ä½¿ç”¨ PowerShell å®‰è£…ï¼ˆWindowsï¼‰ï¼š**

```powershell
iwr -useb https://yarnpkg.com/install.ps1 | iex
```

### éªŒè¯å®‰è£…

```bash
yarn --version
```

### åˆå§‹åŒ–æ–°é¡¹ç›®

```bash
yarn init
```

### å®‰è£…é¡¹ç›®ä¾èµ–

```bash
yarn install
```

æˆ–ç®€å†™ï¼š

```bash
yarn
```

---

## å¸¸ç”¨å‘½ä»¤

### æ·»åŠ ä¾èµ–

**æ·»åŠ æ­£å¼ä¾èµ–ï¼š**

```bash
yarn add lodash
```

**æ·»åŠ å¼€å‘ä¾èµ–ï¼š**

```bash
yarn add -D typescript
# æˆ–è€…
yarn add --dev typescript
```

**æ·»åŠ ç‰¹å®šç‰ˆæœ¬ï¼š**

```bash
yarn add lodash@4.17.21
```

**æ·»åŠ å¯é€‰ä¾èµ–ï¼š**

```bash
yarn add -O express
```

**æ·»åŠ å¯¹ç­‰ä¾èµ–ï¼š**

```bash
yarn add -P react
```

### ç§»é™¤ä¾èµ–

```bash
yarn remove lodash
```

### æ›´æ–°ä¾èµ–

```bash
# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
yarn up lodash

# æ›´æ–°åˆ°æŒ‡å®šç‰ˆæœ¬
yarn up lodash@4.17.20

# æ›´æ–°æ‰€æœ‰ä¾èµ–
yarn up --all
```

### è¿è¡Œè„šæœ¬

```bash
yarn run build
# æˆ–è€…
yarn build
```

### æŸ¥çœ‹ä¾èµ–

```bash
# åˆ—å‡ºæ‰€æœ‰ä¾èµ–
yarn list

# æŸ¥çœ‹ä¾èµ–æ ‘
yarn list --tree

# æ£€æŸ¥è¿‡æ—¶ä¾èµ–
yarn outdated
```

### å…¶ä»–å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `yarn init` | åˆå§‹åŒ–æ–°é¡¹ç›® |
| `yarn install` | å®‰è£…æ‰€æœ‰ä¾èµ– |
| `yarn add <package>` | æ·»åŠ ä¾èµ– |
| `yarn remove <package>` | ç§»é™¤ä¾èµ– |
| `yarn up <package>` | æ›´æ–°ä¾èµ– |
| `yarn run <script>` | è¿è¡Œè„šæœ¬ |
| `yarn build` | è¿è¡Œ build è„šæœ¬ |
| `yarn dev` | è¿è¡Œ dev è„šæœ¬ |
| `yarn test` | è¿è¡Œæµ‹è¯• |
| `yarn list` | åˆ—å‡ºæ‰€æœ‰ä¾èµ– |
| `yarn outdated` | æ£€æŸ¥è¿‡æ—¶ä¾èµ– |
| `yarn upgrade` | å‡çº§æ‰€æœ‰ä¾èµ– |
| `yarn info <package>` | æŸ¥çœ‹åŒ…ä¿¡æ¯ |
| `yarn why <package>` | æŸ¥çœ‹ä¸ºä»€ä¹ˆå®‰è£…æŸä¸ªåŒ… |
| `yarn cache clean` | æ¸…ç†ç¼“å­˜ |

---

## å·¥ä½œåŒºï¼ˆWorkspacesï¼‰è¯¦è§£

### åˆ›å»ºå·¥ä½œåŒº

åœ¨å·¥ä½œåŒºæ ¹ç›®å½•çš„ package.json ä¸­æ·»åŠ  workspaces å­—æ®µï¼š

```json
{
  "name": "my-monorepo",
  "workspaces": [
    "packages/*"
  ]
}
```

ä¸Šè¿°é…ç½®è¡¨ç¤º packages ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•éƒ½å°†æˆä¸ºç‹¬ç«‹çš„å·¥ä½œåŒºã€‚

### å·¥ä½œåŒºé—´çš„ä¾èµ–

åœ¨å·¥ä½œåŒºä¹‹é—´å¼•ç”¨åŒ…æ—¶ï¼Œä½¿ç”¨ workspace: åè®®ï¼š

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:^"
  }
}
```

è¿™ç¡®ä¿äº†å½“ä½ å‘å¸ƒåŒ…æ—¶ï¼Œä¾èµ–ä¼šè¢«æ­£ç¡®è½¬æ¢ä¸ºå®é™…ç‰ˆæœ¬å·ã€‚

### å·¥ä½œåŒºå‘½ä»¤

**åœ¨æ‰€æœ‰å·¥ä½œåŒºè¿è¡Œå‘½ä»¤ï¼š**

```bash
yarn workspaces foreach -pt run build
```

**ä»…åœ¨å·¥ä½œåŒºè¿è¡Œå‘½ä»¤ï¼š**

```bash
yarn workspaces focus @my-org/app
```

**è¿è¡Œå…¨å±€è„šæœ¬ï¼š**

å¸¦æœ‰å†’å·çš„è„šæœ¬ï¼ˆå¦‚ `build:all`ï¼‰å¯ä»¥åœ¨é¡¹ç›®çš„ä»»ä½•ä½ç½®è¿è¡Œã€‚

---

## é…ç½®æ–‡ä»¶

### package.json

Yarn ä½¿ç”¨ package.json æ¥ç®¡ç†é¡¹ç›®é…ç½®ï¼Œä¸»è¦å­—æ®µåŒ…æ‹¬ï¼š

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "packages/*"
  ],
  "scripts": {
    "build": "yarn workspaces foreach -pt run build",
    "dev": "yarn workspaces foreach -pt run dev"
  },
  "devDependencies": {
    "typescript": "^5.0.0"
  }
}
```

### .yarnrc.yml

Yarn 4+ ä½¿ç”¨ .yarnrc.yml ä½œä¸ºé…ç½®æ–‡ä»¶ï¼š

```yaml
nodeLinker: node-modules

npmRegistryServer: "https://registry.npmjs.org"

enableGlobalCache: false
```

### yarn.lock

yarn.lock æ–‡ä»¶è®°å½•äº†æ‰€æœ‰ä¾èµ–çš„ç¡®åˆ‡ç‰ˆæœ¬ï¼Œä¸åº”æ‰‹åŠ¨ç¼–è¾‘ã€‚å®ƒç¡®ä¿äº†æ¯æ¬¡å®‰è£…éƒ½èƒ½å¾—åˆ°ç›¸åŒçš„ç»“æœã€‚

---

## é«˜çº§åŠŸèƒ½

### Zero-Installs

Yarn æ”¯æŒé›¶å®‰è£…åŠŸèƒ½ï¼Œåªéœ€å°†ç¼“å­˜å’Œ .pnp.cjs æ–‡ä»¶æäº¤åˆ°ä»£ç åº“ï¼Œå…‹éš†ä»“åº“æˆ–åˆ‡æ¢åˆ†æ”¯åæ— éœ€è¿è¡Œå®‰è£…ã€‚

```bash
# éªŒè¯é›¶å®‰è£…é¡¹ç›®
yarn install --immutable --immutable-cache
```

### ç¡¬æ ¸æ¨¡å¼ï¼ˆHardened Modeï¼‰

ç¡¬æ ¸æ¨¡å¼ç¡®ä¿å®‰è£…è¿‡ç¨‹å®Œå…¨ç¡®å®šæ€§ï¼š

```bash
yarn install --immutable
```

è¿™åœ¨ CI/CD ç¯å¢ƒä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå¯ä»¥é˜²æ­¢æ„å¤–çš„é”æ–‡ä»¶æ›´æ”¹ã€‚

### æ’ä»¶ç³»ç»Ÿ

Yarn æä¾›äº†ä¸°å¯Œçš„æ’ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æ‰©å±•å…¶åŠŸèƒ½ï¼š

```bash
# æ·»åŠ æ’ä»¶
yarn plugin import @yarnpkg/plugin-github
```

### çº¦æŸï¼ˆConstraintsï¼‰

çº¦æŸåŠŸèƒ½ç±»ä¼¼äºä»£ç çš„ ESLintï¼Œä½ å¯ä»¥å®šä¹‰è§„åˆ™æ¥ç®¡ç†å·¥ä½œåŒºï¼š

```javascript
// constraints.pro
 workspaces.forEach(workspace => {
   // å¼ºåˆ¶æ‰€æœ‰å·¥ä½œåŒºä½¿ç”¨ç›¸åŒçš„ TypeScript ç‰ˆæœ¬
   workspace.dependencies.get("typescript").version = "^5.0.0";
 });
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ yarn.lock

å§‹ç»ˆæäº¤ yarn.lock æ–‡ä»¶ï¼Œç¡®ä¿å›¢é˜Ÿæˆå‘˜å’Œ CI/CD ç¯å¢ƒä½¿ç”¨ç›¸åŒçš„ä¾èµ–ç‰ˆæœ¬ã€‚

### 2. å®šæœŸæ›´æ–°ä¾èµ–

ä½¿ç”¨ `yarn up` å®šæœŸæ›´æ–°ä¾èµ–ï¼Œè·å–æœ€æ–°çš„åŠŸèƒ½å’Œå®‰å…¨ä¿®å¤ã€‚

### 3. åˆ©ç”¨å·¥ä½œåŒº

å¯¹äºå¤šåŒ…é¡¹ç›®ï¼Œä½¿ç”¨å·¥ä½œåŒºå¯ä»¥ç®€åŒ–ä¾èµ–ç®¡ç†å’Œæ„å»ºæµç¨‹ã€‚

### 4. ä½¿ç”¨ CI éªŒè¯

åœ¨ CI ç¯å¢ƒä¸­ä½¿ç”¨ `--immutable` æ ‡å¿—ï¼Œç¡®ä¿é”æ–‡ä»¶ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹ã€‚

### 5. æ¸…ç†ç¼“å­˜

å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ç¼“å­˜ï¼š

```bash
yarn cache clean
```

### 6. æŸ¥çœ‹ä¾èµ–ä¿¡æ¯

ä½¿ç”¨ `yarn why` äº†è§£ä¸ºä»€ä¹ˆå®‰è£…äº†æŸä¸ªåŒ…ï¼š

```bash
yarn why lodash
```

---

## å¸¸è§é—®é¢˜

### Yarn ä¸ npm çš„åŒºåˆ«ï¼Ÿ

Yarn æ˜¯ npm çš„æ›¿ä»£å“ï¼Œä¸»è¦åŒºåˆ«åŒ…æ‹¬ï¼š
- é€Ÿåº¦æ›´å¿«ï¼ˆå¹¶è¡Œå®‰è£…ï¼‰
- æ›´ç¡®å®šæ€§çš„å®‰è£…
- æ›´å¥½çš„ç¦»çº¿æ”¯æŒ
- åŸç”Ÿå·¥ä½œåŒºæ”¯æŒ
- æ›´ç¾è§‚çš„è¾“å‡º

### å¦‚ä½•å‡çº§ Yarnï¼Ÿ

```bash
# ä½¿ç”¨ corepack å‡çº§
corepack prepare yarn@stable --activate

# æˆ–è€…ä½¿ç”¨ npm
npm install -g yarn
```

### å¦‚ä½•åˆ‡æ¢ Node.js ç‰ˆæœ¬ï¼Ÿ

Yarn æ”¯æŒä½¿ç”¨ corepack ç®¡ç† Node.js ç‰ˆæœ¬ï¼š

```bash
corepack prepare node@20.10.0 --activate
```

### å®‰è£…å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

1. æ¸…ç†ç¼“å­˜ï¼š`yarn cache clean`
2. åˆ é™¤ node_modules å’Œ yarn.lock
3. é‡æ–°å®‰è£…ï¼š`yarn install`

### å¦‚ä½•ä½¿ç”¨ç§æœ‰æ³¨å†Œè¡¨ï¼Ÿ

åœ¨ .yarnrc.yml ä¸­é…ç½®ï¼š

```yaml
npmRegistryServer: "https://registry.yarnpkg.com"
```

---

## ç›¸å…³èµ„æº

- å®˜æ–¹ç½‘ç«™ï¼šhttps://yarnpkg.com
- å®˜æ–¹æ–‡æ¡£ï¼šhttps://yarnpkg.com/docs
- GitHubï¼šhttps://github.com/yarnpkg/berry
- æ’ä»¶åˆ—è¡¨ï¼šhttps://yarnpkg.com/plugins
