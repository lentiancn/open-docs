# Nacos User Manual

This manual provides comprehensive instructions for using Nacos for service discovery and configuration management.

---

## Table of Contents

- [Service Discovery](#service-discovery)
- [Configuration Management](#configuration-management)
- [Namespace Management](#namespace-management)
- [Cluster Management](#cluster-management)
- [API Reference](#api-reference)
- [Best Practices](#best-practices)

---

## Service Discovery

### Registering a Service

#### Using Nacos SDK (Java)

```java
// Register a service instance
NamingService namingService = NacosFactory.createNamingService("127.0.0.1:8848");

// Register instance with metadata
namingService.registerInstance("shopping-service", "192.168.1.10", 8080, "zone=A");
```

#### Using HTTP API

```bash
# Register a service instance
curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance' \
  -d 'serviceName=shopping-service' \
  -d 'ip=192.168.1.10' \
  -d 'port=8080'
```

### Discovering Services

#### Using SDK

```java
// Get all instances
List<Instance> instances = namingService.selectInstances("shopping-service", true);

// Get healthy instances only
List<Instance> healthyInstances = namingService.selectInstances("shopping-service", true, true);

// Get one healthy instance (load balancing)
Instance instance = namingService.selectOneHealthyInstance("shopping-service");
```

#### Using HTTP API

```bash
# Get service instances
curl 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=shopping-service'
```

### Deregistering a Service

```java
// Deregister instance
namingService.deregisterInstance("shopping-service", "192.168.1.10", 8080);
```

---

## Configuration Management

### Creating a Configuration

#### Using Console

1. Navigate to Configuration Management â†’ Configuration List
2. Click "Create" button
3. Fill in:
   - Data ID: `application.yml`
   - Group: `DEFAULT_GROUP`
   - Content: YAML configuration content

#### Using API

```bash
# Create or update configuration
curl -X POST 'http://127.0.0.1:8848/nacos/v1/cs/configs' \
  -d 'dataId=application.yml' \
  -d 'group=DEFAULT_GROUP' \
  -d 'content=spring:\n  datasource:\n    url: jdbc:mysql://localhost:3306/mydb'
```

### Getting Configuration

```bash
# Get configuration
curl 'http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=application.yml&group=DEFAULT_GROUP'
```

### Listening for Changes

#### Using SDK

```java
// Add configuration listener
Properties properties = new Properties();
properties.put("serverAddr", "127.0.0.1:8848");

ConfigService configService = NacosFactory.createConfigService(properties);

configService.addListener("application.yml", "DEFAULT_GROUP", new Listener() {
    @Override
    public void receiveConfigInfo(String configInfo) {
        System.out.println("Config changed: " + configInfo);
    }

    @Override
    public Executor getExecutor() {
        return null;
    }
});
```

---

## Namespace Management

### Creating a Namespace

#### Using Console

1. Navigate to Namespace Management
2. Click "Create Namespace"
3. Enter namespace ID and name

#### Using API

```bash
# Create namespace
curl -X POST 'http://127.0.0.1:8848/nacos/v1/console/namespaces' \
  -d 'customNamespaceId=dev' \
  -d 'namespaceName=Development'
```

### Using Namespace in Configuration

```bash
# Get configuration from specific namespace
curl 'http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=app.yml&group=DEFAULT_GROUP&namespaceId=dev'
```

---

## Cluster Management

### Setting Up Cluster

#### Configuration (cluster.conf)

```
# Format: ip:port
192.168.1.1:8848
192.168.1.2:8848
192.168.1.3:8848
```

#### Starting Cluster Mode

```bash
# Start all nodes
./startup.sh -p cluster
```

### Health Check

Nacos provides multiple health check mechanisms:

- **TCP**: Check if port is open
- **HTTP**: Check HTTP endpoint
- **MySQL**: Check database connectivity

---

## API Reference

### Service Management API

| API | Method | Description |
|-----|--------|-------------|
| `/nacos/v1/ns/instance` | POST | Register instance |
| `/nacos/v1/ns/instance` | DELETE | Deregister instance |
| `/nacos/v1/ns/instance/list` | GET | List instances |
| `/nacos/v1/ns/service` | POST | Create service |
| `/nacos/v1/ns/service` | DELETE | Delete service |

### Configuration API

| API | Method | Description |
|-----|--------|-------------|
| `/nacos/v1/cs/configs` | POST | Publish config |
| `/nacos/v1/cs/configs` | DELETE | Delete config |
| `/nacos/v1/cs/configs` | GET | Get config |

---

## Best Practices

### Service Naming

- Use lowercase with hyphens: `user-service`
- Avoid special characters
- Keep names meaningful and consistent

### Configuration Management

1. **Use proper Data IDs**: `application-{environment}.yml`
2. **Organize with Groups**: Separate by application or environment
3. **Enable version control**: Nacos keeps configuration history
4. **Use templates**: For common configurations

### Security

1. Enable authentication in production
2. Use namespaces for environment isolation
3. Implement access control
4. Enable SSL/TLS for communication

### Performance

1. Use appropriate health check intervals
2. Monitor cluster health
3. Implement proper timeout settings
4. Use connection pooling

---

## Troubleshooting

### Instance Not Registering

1. Check network connectivity
2. Verify Nacos server is running
3. Check instance metadata
4. Review Nacos server logs

### Configuration Not Updating

1. Verify listener is registered
2. Check if configuration changed
3. Check network connectivity
4. Review client logs

### High Memory Usage

1. Adjust JVM heap size
2. Reduce number of monitored configurations
3. Optimize health check intervals

---

## Integration Examples

### Spring Boot Integration

```yaml
# application.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yml
```

### Kubernetes Integration

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    nacos.io/scr: "true"
  name: my-service
spec:
  ports:
    - port: 8080
```

---

## Advanced Features

### Service Metadata

```java
// Register with metadata
Map<String, String> metadata = new HashMap<>();
metadata.put("version", "1.0");
metadata.put("zone", "zone-a");

namingService.registerInstance("service-name", "192.168.1.10", 8080, metadata);
```

### Weighted Routing

```bash
# Update instance weight
curl -X PUT 'http://127.0.0.1:8848/nacos/v1/ns/instance' \
  -d 'serviceName=shopping-service' \
  -d 'ip=192.168.1.10' \
  -d 'port=8080' \
  -d 'weight=0.5'
```

### Protection Threshold

Set protection threshold to prevent service elimination:

```bash
curl -X PUT 'http://127.0.0.1:8848/nacos/v1/ns/service' \
  -d 'serviceName=shopping-service' \
  -d 'protectThreshold=0.5'
```
