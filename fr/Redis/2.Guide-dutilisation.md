# Guide d'utilisation Redis

Guide complet pour utiliser Redis efficacement.

---

## Table des matières

- [Concepts de base](#concepts-de-base)
- [Types de données](#types-de-données)
- [Opérations sur les chaînes](#opérations-sur-les-chaînes)
- [Opérations sur les listes](#opérations-sur-les-listes)
- [Opérations sur les hashs](#opérations-sur-les-hashs)
- [Opérations sur les ensembles](#opérations-sur-les-ensembles)
- [Opérations sur les ensembles triés](#opérations-sur-les-ensembles-triés)
- [Clés et expiration](#clés-et-expiration)
- [Pub/Sub](#pubsub)
- [Transactions](#transactions)
- [Pipeline](#pipeline)
- [Scripts Lua](#scripts-lua)
- [Persistance](#persistance)
- [Réplication](#réplication)
- [Cluster](#cluster)
- [Sécurité](#sécurité)
- [Optimisation des performances](#optimisation-des-performances)
- [Recettes courantes](#recettes-courantes)

---

## Concepts de base

### Qu'est-ce que Redis ?

Redis est un magasin de structures de données en mémoire open source, utilisé comme base de données, cache et broker de messages. Il prend en charge diverses structures de données et offre des performances élevées.

### Fonctionnalités principales

- Stockage en mémoire
- Persistance des données
- Réplication
- Partitionnement en cluster
- Messagerie Pub/Sub
- Scripting Lua

### Termes clés

| Terme | Description |
|-------|-------------|
| Key | Identifiant unique pour la valeur |
| Value | Données stockées dans Redis |
| TTL | Time To Live (expiration) |
| Pipeline | Exécuter plusieurs commandes en lot |
| Master | Instance Redis primaire |
| Slave | Réplique du maître |

---

## Types de données

Redis prend en charge divers types de données :

| Type | Description |
|------|-------------|
| String | Texte ou données binaires |
| List | Liste ordonnée de chaînes |
| Hash | Collection de paires champ-valeur |
| Set | Collection non ordonnée de chaînes uniques |
| Sorted Set | Ensemble avec scores pour le tri |
| HyperLogLog | Structure de données probabiliste |
| Bitmap | Chaîne avec opérations bit |
| Stream | Broker de messages structuré en journal |

---

## Opérations sur les chaînes

### Commandes de base

```bash
# Définir une valeur
SET key "value"

# Obtenir une valeur
GET key

# Définir plusieurs clés
MSET key1 "value1" key2 "value2"

# Obtenir plusieurs clés
MGET key1 key2

# Ajouter à la chaîne
APPEND key " appended"

# Obtenir la longueur de la chaîne
STRLEN key
```

### Opérations numériques

```bash
# Incrémenter
INCR counter
INCRBY counter 10

# Décrémenter
DECR counter
DECRBY counter 5

# Incrément décimal
INCRBYFLOAT price 0.5
```

---

## Opérations sur les listes

### Commandes de base

```bash
# Ajouter à gauche
LPUSH mylist "first"

# Ajouter à droite
RPUSH mylist "last"

# Retirer à gauche
LPOP mylist

# Retirer à droite
RPOP mylist

# Obtenir la plage
LRANGE mylist 0 -1

# Obtenir la longueur de la liste
LLEN mylist
```

---

## Opérations sur les hashs

### Commandes de base

```bash
# Définir un champ de hash
HSET user:1 name "John"

# Définir plusieurs champs de hash
HMSET user:1 name "John" email "john@example.com"

# Obtenir un champ de hash
HGET user:1 name

# Obtenir tous les champs et valeurs
HGETALL user:1

# Obtenir plusieurs champs
HMGET user:1 name email

# Supprimer un champ
HDEL user:1 email
```

---

## Opérations sur les ensembles

### Commandes de base

```bash
# Ajouter à l'ensemble
SADD myset "member1"

# Retirer de l'ensemble
SREM myset "member1"

# Obtenir tous les membres
SMEMBERS myset

# Vérifier l'appartenance
SISMEMBER myset "member1"

# Obtenir la taille de l'ensemble
SCARD myset
```

### Opérations sur les ensembles

```bash
# Union
SUNION set1 set2

# Intersection
SINTER set1 set2

# Différence
SDIFF set1 set2
```

---

## Opérations sur les ensembles triés

### Commandes de base

```bash
# Ajouter à l'ensemble trié
ZADD leaderboard 100 "player1"

# Obtenir la plage (croissant)
ZRANGE leaderboard 0 -1 WITHSCORES

# Obtenir la plage (décroissant)
ZREVRANGE leaderboard 0 -1 WITHSCORES

# Obtenir le rang
ZRANK leaderboard "player1"

# Incrémenter le score
ZINCRBY leaderboard 50 "player1"
```

---

## Clés et expiration

### Gestion des clés

```bash
# Supprimer la clé
DEL key

# Vérifier si la clé existe
EXISTS key

# Obtenir le type de clé
TYPE key

# Renommer la clé
RENAME key newkey

# Obtenir toutes les clés
KEYS pattern

# Scanner les clés
SCAN 0 MATCH pattern
```

### Expiration

```bash
# Définir l'expiration (secondes)
EXPIRE key 60

# Définir l'expiration (millisecondes)
PEXPIRE key 60000

# Définir la clé avec expiration
SETEX key 60 "value"

# Supprimer l'expiration
PERSIST key

# Obtenir le temps restant (secondes)
TTL key

# Obtenir le temps restant (millisecondes)
PTTL key
```

---

## Pub/Sub

### Publication

```bash
# S'abonner à un canal
SUBSCRIBE mychannel

# Publier un message
PUBLISH mychannel "Hello"

# Abonnement par motif
PSUBSCRIBE news.*
```

### Commandes

```bash
# S'abonner
SUBSCRIBE channel1 channel2

# Publier
PUBLISH channel1 "message"

# Se désabonner
UNSUBSCRIBE channel1
```

---

## Transactions

### Commandes de base

```bash
# Démarrer la transaction
MULTI

# Mettre les commandes en file d'attente
SET key1 "value1"
SET key2 "value2"

# Exécuter la transaction
EXEC

# Annuler la transaction
DISCARD
```

### Watch

```bash
WATCH key
# ... quelques opérations ...
MULTI
SET key newvalue
EXEC  # Échoue si la clé a été modifiée
```

---

## Pipeline

### Utilisation du pipeline

```bash
# Pipeline de plusieurs commandes
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# En code (exemple Python)
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Scripts Lua

### Script de base

```bash
# Exécuter un script Lua
EVAL "return redis.call('get', 'key')" 0

# Définir une clé avec Lua
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### Exemple de script

```lua
-- Incrémenter le compteur
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## Persistance

### RDB (Redis Database)

```bash
# Sauvegarder manuellement
BGSAVE

# Obtenir la dernière heure de sauvegarde
LASTSAVE
```

### AOF (Append Only File)

```bash
# Activer AOF dans la config
appendonly yes

# Réécrire AOF
BGREWRITEAOF
```

### Configuration

```bash
# Fréquence de sauvegarde
save 900 1
save 300 10
save 60 10000
```

---

## Réplication

### Configurer l'esclave

```bash
# Dans redis.conf
replicaof masterip masterport

# Ou via commande
REPLICAOF masterip masterport
```

### Commandes

```bash
# Vérifier le statut de réplication
INFO replication

# Devenir maître
REPLICAOF NO ONE
```

---

## Cluster

### Créer un cluster

```bash
# Créer le cluster
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# Voir les nœuds du cluster
redis-cli -c cluster nodes
```

---

## Sécurité

### Authentification par mot de passe

```bash
# Définir le mot de passe dans la config
requirepass yourpassword

# S'authentifier via CLI
AUTH yourpassword
```

### ACL (Redis 6+)

```bash
# Créer un utilisateur
ACL SETUSER alice on >password ~cached:* +get +set

# Lister les utilisateurs
ACL LIST
```

---

## Optimisation des performances

### Optimisation de la mémoire

```bash
# Définir la mémoire maximale
maxmemory 2gb

# Politique d'éviction
maxmemory-policy allkeys-lru
```

### Optimisation des connexions

```bash
# Utiliser le pool de connexions
# Dans le code
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## Recettes courantes

### Mise en cache

```bash
# Cache avec expiration
SET user:1:profile "data" EX 3600

# Vérifier le cache
GET user:1:profile
```

### Limitation de débit

```bash
# Limitation de débit simple
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### Verrou distribué

```bash
# Acquérir le verrou
SET lock:myresource unique_value NX EX 10

# Libérer le verrou
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### Stockage de session

```bash
# Stocker la session
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## Étapes suivantes

- Explorer [Redis Stack](https://redis.io/docs/stack/)
- En savoir plus sur [Redis Enterprise](https://redis.com/redis-enterprise/)
- Lire le [Guide d'optimisation des performances](https://redis.io/docs/management/optimization/)
