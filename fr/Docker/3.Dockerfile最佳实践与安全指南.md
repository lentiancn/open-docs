# Dockerfile 最佳实践与安全指南

本指南详细介绍 Dockerfile 的编写最佳实践和容器安全配置。

---

## 目录

1. [Dockerfile 编写最佳实践](#dockerfile-编写最佳实践)
2. [安全配置指南](#安全配置指南)
3. [性能优化](#性能优化)
4. [实用示例](#实用示例)

---

## Dockerfile 编写最佳实践

### 1. 使用特定版本标签

避免使用 `:latest` 标签，确保镜像构建的可重复性：

```dockerfile
# ✅ 推荐：使用特定版本
FROM node:18.17.0-alpine

# ❌ 避免：使用 latest
FROM node:latest
```

### 2. 优先使用官方镜像

官方镜像经过社区验证，定期更新安全补丁：

```dockerfile
# ✅ 推荐：官方镜像
FROM python:3.11-slim

# ❌ 避免：第三方未验证镜像
FROM someuser/python:3.11
```

### 3. 使用轻量级基础镜像

选择体积更小的镜像减少攻击面：

```dockerfile
# ✅ 推荐：alpine 镜像
FROM node:18-alpine

# 替代选项：使用 distroless
FROM gcr.io/distroless/nodejs:18
```

### 4. 减少镜像层数

合并多个 RUN 指令减少层数：

```dockerfile
# ✅ 推荐：合并相关操作
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        git \
    && rm -rf /var/lib/apt/lists/*

# ❌ 避免：多个独立 RUN 指令
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git
RUN rm -rf /var/lib/apt/lists/*
```

### 5. 合理安排指令顺序

将经常变更的指令放在后面，充分利用 Docker 缓存：

```dockerfile
# ✅ 推荐：不变的部分在前
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# 变更部分放后面
COPY . .
CMD ["node", "index.js"]
```

### 6. 使用 .dockerignore 文件

排除不必要的文件，减小镜像体积：

```
.git
node_modules
npm-debug.log
Dockerfile
.dockerignore
README.md
docs/
tests/
*.md
.env
.env.*
```

### 7. 不以 root 用户运行容器

创建并使用非 root 用户：

```dockerfile
# 创建应用用户
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# 设置文件和目录所有权
COPY --chown=appuser:appgroup . .

# 切换到非 root 用户
USER appuser
```

### 8. 使用多阶段构建

减小最终镜像体积，只包含运行时依赖：

```dockerfile
# 构建阶段
FROM golang:1.20 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# 运行阶段
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/main .
USER 1001
CMD ["./main"]
```

### 9. 显式声明端口

使用 EXPOSE 指令声明容器监听的端口：

```dockerfile
# ✅ 推荐：明确声明
EXPOSE 3000
EXPOSE 8080

# 容器运行时不改变端口映射
docker run -p 3000:3000 myapp
```

### 10. 设置健康检查

确保容器健康运行：

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
```

---

## 安全配置指南

### 1. 最小化权限

```dockerfile
# 创建非 root 用户
RUN adduser -D -g '' appuser
USER appuser
```

### 2. 只读文件系统

```bash
docker run --read-only myapp
```

或使用 Dockerfile：

```dockerfile
RUN chmod -R a-w /app
```

### 3. 配置资源限制

```bash
# 限制内存
docker run -m 512m myapp

# 限制 CPU
docker run --cpus="1.5" myapp
```

### 4. 安全扫描

使用 Docker Scout 或 Trivy 扫描镜像漏洞：

```bash
# 安装 Trivy
brew install trivy

# 扫描镜像
trivy image myapp:latest
```

### 5. 使用 Secret 管理敏感信息

Docker Swarm 或 Kubernetes 的 Secret 机制：

```yaml
# docker-compose.yml
services:
  app:
    image: myapp
    secrets:
      - db_password

secrets:
  db_password:
    file: ./db_password.txt
```

### 6. 网络隔离

```bash
# 创建自定义网络
docker network create mynetwork

# 容器加入网络
docker run --network mynetwork myapp
```

### 7. 禁用特权模式

```bash
# ❌ 避免：避免使用 --privileged
docker run --privileged myapp

# ✅ 推荐：按需添加特定能力
docker run --cap-drop ALL --cap-add NET_BIND_SERVICE myapp
```

---

## 性能优化

### 1. 利用构建缓存

- 合理安排指令顺序
- 使用 .dockerignore
- 复制依赖文件优先于源代码

### 2. 并行构建

```bash
docker buildx create --name mybuilder
docker buildx use mybuilder
docker buildx build --parallel .
```

### 3. 使用 BuildKit

```bash
# 启用 BuildKit
export DOCKER_BUILDKIT=1
docker build .
```

### 4. 减少镜像体积

```dockerfile
# 清理不必要的文件
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
```

---

## 实用示例

### Node.js 应用

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 运行阶段
FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# 创建非 root 用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs

COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules

USER nodejs
EXPOSE 3000
CMD ["node", "dist/main.js"]
```

### Python 应用

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非 root 用户
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 8000
CMD ["python", "main.py"]
```

### Go 应用

```dockerfile
# 构建阶段
FROM golang:1.20-alpine AS builder
RUN apk add --no-cache git
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# 运行阶段
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/main .
EXPOSE 8080
CMD ["./main"]
```

---

## 相关链接

- [Dockerfile 官方最佳实践](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Docker 安全文档](https://docs.docker.com/engine/security/)
- [Docker Scout](https://docs.docker.com/scout/)
- [Distroless 镜像](https://github.com/GoogleContainerTools/distroless)
