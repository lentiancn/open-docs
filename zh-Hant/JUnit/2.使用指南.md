# JUnit 使用指南

本指南涵蓋如何使用 JUnit 5（Jupiter）編寫有效的單元測試。

## 基本測試結構

### 簡單測試類別

```java
package com.example;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class MyFirstTest {
    
    @Test
    void simpleTest() {
        // 準備 - 設定測試資料
        int a = 1;
        int b = 2;
        
        // 執行 - 執行操作
        int result = a + b;
        
        // 斷言 - 驗證結果
        assertEquals(3, result);
    }
    
    @Test
    void anotherTest() {
        assertEquals(4, 2 + 2, "選用斷言訊息");
    }
}
```

### 測試檔案位置

```
src/
├── main/
│   └── java/
│       └── com/example/
│           └── Calculator.java
└── test/
    └── java/
        └── com/example/
            └── CalculatorTest.java
```

## 斷言

JUnit 5 在 `org.junit.jupiter.api.Assertions` 中提供 comprehensive 的斷言 API。

### 常用斷言

```java
import static org.junit.jupiter.api.Assertions.*;

// 相等斷言
@Test
void equalityTests() {
    assertEquals(expected, actual);
    assertEquals(expected, actual, "訊息");
    assertEquals(expected, actual, () -> "延遲訊息");
    
    // 浮點數的 delta
    assertEquals(0.01, 3.5, 0.1);
    
    // 不相等
    assertNotEquals(expected, actual);
}

// 布林斷言
@Test
void booleanTests() {
    assertTrue(condition);
    assertTrue(condition, "訊息");
    assertTrue(() -> condition, () -> "延遲訊息");
    
    assertFalse(condition);
}

// 空值斷言
@Test
void nullTests() {
    assertNull(object);
    assertNotNull(object);
    
    // 身份
    assertSame(obj1, obj2);
    assertNotSame(obj1, obj2);
}

// 陣列斷言
@Test
void arrayTests() {
    assertArrayEquals(expectedArray, actualArray);
    assertArrayEquals(expectedArray, actualArray, "訊息");
}

// 例外斷言
@Test
void exceptionTests() {
    // 斷言例外被拋出
    assertThrows(RuntimeException.class, () -> {
        throw new RuntimeException("測試例外");
    });
    
    // 斷言例外訊息
    Exception exception = assertThrows(IllegalArgumentException.class, () -> {
        throw new IllegalArgumentException("無效輸入");
    });
    assertEquals("無效輸入", exception.getMessage());
    
    // 斷言沒有例外被拋出
    assertDoesNotThrow(() -> {
        // 不應該拋出例外的程式碼
    });
}

// 組合斷言
@Test
void combinedAssertions() {
    // 執行多個斷言
    assertAll("使用者驗證",
        () -> assertNotNull(user),
        () -> assertEquals("John", user.getName()),
        () -> assertTrue(user.getAge() >= 18)
    );
}
```

### AssertJ 風格的軟斷言

```java
@Test
void softAssertionsTest() {
    SoftAssertions softly = new SoftAssertions();
    
    softly.assertThat(user.getName()).isEqualTo("John");
    softly.assertThat(user.getAge()).isGreaterThan(18);
    softly.assertThat(user.getEmail()).contains("@");
    
    softly.assertAll();
}
```

### 自訂斷言

```java
@Test
void customAssertion() {
    assertTrue(isValidEmail(email), "無效的電子郵件格式");
}

private boolean isValidEmail(String email) {
    return email != null && email.matches("^[A-Za-z0-9+_.-]+@.+$");
}
```

## 測試生命週期

### 之前和之後方法

```java
class LifecycleTest {
    
    @BeforeAll
    static void beforeAll() {
        // 在所有測試方法之前執行一次
        // 在一般類別中必須是 static
        System.out.println("Before All Tests");
    }
    
    @AfterAll
    static void afterAll() {
        // 在所有測試方法之後執行一次
        System.out.println("After All Tests");
    }
    
    @BeforeEach
    void beforeEach() {
        // 在每個測試方法之前執行
        System.out.println("Before Each Test");
    }
    
    @AfterEach
    void afterEach() {
        // 在每個測試方法之後執行
        System.out.println("After Each Test");
    }
    
    @Test
    void test1() {
        System.out.println("Test 1");
    }
    
    @Test
    void test2() {
        System.out.println("Test 2");
    }
}
```

### 每個類別的生命週期

```java
@TestInstance(Lifecycle.PER_CLASS)
class PerClassTest {
    
    private String resource;
    
    @BeforeAll
    void beforeAll() {
        // 可以對 PER_CLASS 使用非 static 方法
        resource = "initialized";
    }
    
    @Test
    void test1() {
        assertNotNull(resource);
    }
    
    @Test
    void test2() {
        assertNotNull(resource);
    }
}
```

## 巢狀測試

### 基本巢狀測試

```java
@Nested
class NestedTests {
    
    @Test
    void parentTest() {
        assertTrue(true);
    }
    
    @Nested
    class InnerClass {
        
        @Test
        void innerTest() {
            assertTrue(true);
        }
        
        @Nested
        class DeepNested {
            
            @Test
            void deepNestedTest() {
                assertTrue(true);
            }
        }
    }
}
```

### 共享狀態的巢狀測試

```java
@Nested
class CalculatorTests {
    
    private Calculator calculator;
    
    @BeforeEach
    void setUp() {
        calculator = new Calculator();
    }
    
    @Nested
    class AdditionTests {
        
        @Test
        void testPositiveNumbers() {
            assertEquals(5, calculator.add(2, 3));
        }
        
        @Test
        void testNegativeNumbers() {
            assertEquals(-1, calculator.add(-2, 1));
        }
    }
    
    @Nested
    class DivisionTests {
        
        @Test
        void testNormalDivision() {
            assertEquals(2, calculator.divide(6, 3));
        }
        
        @Test
        void testDivisionByZero() {
            assertThrows(ArithmeticException.class, 
                () -> calculator.divide(1, 0));
        }
    }
}
```

## 參數化測試

### 值來源

```java
@ParameterizedTest
@ValueSource(ints = {1, 2, 3, 4, 5})
void isEven(int number) {
    assertTrue(number % 2 == 0, number + " should be even");
}

@ParameterizedTest
@ValueSource(strings = {"Hello", "World", "JUnit"})
void stringTests(String value) {
    assertNotNull(value);
    assertTrue(value.length() > 0);
}
```

### CSV 來源

```java
@ParameterizedTest
@CsvSource({
    "1, 1, 2",
    "2, 3, 5",
    "10, 20, 30",
    "-1, -1, -2"
})
void addTest(int a, int b, int expected) {
    Calculator calc = new Calculator();
    assertEquals(expected, calc.add(a, b));
}

@ParameterizedTest
@CsvSource(value = {
    "admin@example.com, true",
    "user@example.com, true",
    "invalid, false"
})
void emailValidationTest(String email, boolean expected) {
    assertEquals(expected, isValidEmail(email));
}
```

### 方法來源

```java
@ParameterizedTest
@MethodSource("provideArguments")
void methodSourceTest(String arg1, int arg2, boolean expected) {
    assertEquals(expected, arg1.length() == arg2);
}

static Stream<Arguments> provideArguments() {
    return Stream.of(
        Arguments.of("test", 4, true),
        Arguments.of("hello", 5, true),
        Arguments.of("ab", 3, false)
    );
}
```

### 列舉來源

```java
@ParameterizedTest
@EnumSource(Month.class)
void monthTest(Month month) {
    assertNotNull(month);
}

@ParameterizedTest
@EnumSource(value = Month.class, names = {"JANUARY", "MARCH", "MAY", "JULY"})
void selectMonthsTest(Month month) {
    assertTrue(month.getValue() % 2 == 1);
}
```

### 空值和空來源

```java
@ParameterizedTest
@NullSource
void nullTest(String input) {
    assertNull(input);
}

@ParameterizedTest
@EmptySource
void emptyTest(String input) {
    assertTrue(input.isEmpty());
}

@ParameterizedTest
@NullAndEmptySource
void nullAndEmptyTest(String input) {
    assertTrue(input == null || input.isEmpty());
}
```

## 重複測試

```java
@RepeatedTest(10)
void repeatedTest(RepetitionInfo repetitionInfo) {
    System.out.println("Repetition " + 
        repetitionInfo.getCurrentRepetition());
    assertTrue(true);
}

@RepeatedTest(value = 5, name = "{displayName} - {currentRepetition}/{totalRepetitions}")
void customRepeatedTest() {
    assertTrue(true);
}
```

## 停用測試

```java
@Disabled("尚未準備好")
@Test
void disabledTest() {
    // 不會執行
}

@Test
void conditionalTest() {
    assumeTrue(System.getProperty("os.name").contains("Windows"));
    // 僅在 Windows 上執行
}

@DisabledOnOs(OS.LINUX)
@Test
void notOnLinux() {
    // 不會在 Linux 上執行
}

@DisabledOnJre(JRE.JAVA_8)
@Test
void notOnJava8() {
    // 不會在 Java 8 上執行
}

@EnabledIfSystemProperty(named = "ENV", matches = "prod")
@Test
void onlyInProduction() {
    // 僅在 -DENV=prod 時執行
}
```

## 測試介面

### 介面中的預設方法

```java
interface TestInterface {
    
    @BeforeEach
    default void setUp() {
        System.out.println("Interface setup");
    }
    
    @Test
    default void commonTest() {
        assertTrue(true);
    }
}

class InterfaceTest implements TestInterface {
    
    @Test
    void ownTest() {
        assertTrue(true);
    }
}
```

### 使用預設方法的共享測試

```java
interface CalculatorTests {
    
    Calculator getCalculator();
    
    @Test
    default void testAddition() {
        assertEquals(4, getCalculator().add(2, 2));
    }
    
    @Test
    default void testSubtraction() {
        assertEquals(0, getCalculator().subtract(2, 2));
    }
}

class BasicCalculatorTest implements CalculatorTests {
    
    private Calculator calculator = new BasicCalculator();
    
    @Override
    public Calculator getCalculator() {
        return calculator;
    }
}
```

## 使用 Mockito 進行模擬

### 基本 Mockito

```java
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testGetUserById() {
        // 準備
        User mockUser = new User(1L, "John");
        when(userRepository.findById(1L)).thenReturn(Optional.of(mockUser));
        
        // 執行
        User result = userService.getUserById(1L);
        
        // 斷言
        assertNotNull(result);
        assertEquals("John", result.getName());
        verify(userRepository).findById(1L);
    }
    
    @Test
    void testSaveUser() {
        // 準備
        User user = new User("John", "john@example.com");
        when(userRepository.save(any(User.class))).thenReturn(user);
        
        // 執行
        User saved = userService.saveUser(user);
        
        // 斷言
        assertNotNull(saved);
        verify(userRepository).save(user);
    }
}
```

### 引數匹配器

```java
@Test
void argumentMatchersTest() {
    // 任意匹配器
    when(userRepository.findById(any())).thenReturn(user);
    
    // 特定匹配器
    when(userRepository.findByName(contains("John"))).thenReturn(user);
    
    // 引數擷取器
    ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
    userService.saveUser(user);
    verify(userRepository).save(captor.capture());
    assertEquals("John", captor.getValue().getName());
}
```

### Mockito 註解

```java
@ExtendWith(MockitoExtension.class)
class DetailedMockitoTest {
    
    @Mock
    private List<String> mockedList;
    
    @InjectMocks
    private Service service;
    
    @BeforeEach
    void init() {
        MockitoAnnotations.openMocks(this);
    }
    
    @Test
    void testMocking() {
        mockedList.add("one");
        verify(mockedList).add("one");
        assertEquals(1, mockedList.size());
    }
}
```

## Spring Boot 測試

### 單元測試

```java
@SpringBootTest
class MyServiceIntegrationTest {
    
    @Autowired
    private MyService myService;
    
    @Test
    void testService() {
        String result = myService.doSomething();
        assertNotNull(result);
    }
}
```

### Web 層測試

```java
@WebMvcTest(MyController.class)
class MyControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private MyService myService;
    
    @Test
    void testEndpoint() throws Exception {
        when(myService.getData()).thenReturn("test data");
        
        mockMvc.perform(get("/api/data"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$").value("test data"));
    }
}
```

### 資料層測試

```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testFindByName() {
        entityManager.persist(new User("John", "john@example.com"));
        
        User user = userRepository.findByName("John");
        
        assertNotNull(user);
        assertEquals("John", user.getName());
    }
}
```

### 測試配置

```java
@TestConfiguration
static class TestConfig {
    
    @Bean
    @Primary
    public MyService testMyService() {
        return mock(MyService.class);
    }
}

@SpringBootTest
class IntegrationTestWithConfig {
    
    @Autowired
    @Primary
    MyService myService;  // 會是 mock
    
    @Test
    void test() {
        // 使用 mock
    }
}
```

## 測試執行

### 執行測試

```bash
# 執行所有測試
mvn test

# 執行特定測試類別
mvn test -Dtest=MyTest

# 執行特定測試方法
mvn test -Dtest=MyTest#myMethod

# 執行符合模式的測試
mvn test -Dtest="*Test"

# 使用 Gradle 執行
./gradlew test

# 使用 Gradle 執行特定測試
./gradlew test --tests "com.example.MyTest"

# 執行含覆蓋率的測試
mvn test jacoco:report
```

### 測試類別

```java
interface SlowTests {}

interface FastTests {}

class MyTest implements FastTests {
    @Test
    void fastTest() {}
}

@Tag("slow")
class SlowTest {
    @Test
    void slowTest() {}
}
```

```bash
# 僅執行快速測試
mvn test -Dgroups=com.example.FastTests

# 排除慢速測試
mvn test -DexcludedGroups=com.example.SlowTests
```

## 最佳實踐

### 測試命名

```java
// 好的 - 描述情境
@Test
void shouldReturnUserWhenValidIdProvided() {}

// 不好的 - 不清楚
@Test
void test1() {}
```

### 測試結構

```java
@Test
void shouldThrowExceptionWhenInvalidInput() {
    // 準備
    Validator validator = new Validator();
    
    // 執行與斷言
    assertThrows(IllegalArgumentException.class, () -> {
        validator.validate(null);
    });
}
```

### 避免測試相互依賴

```java
// 不好的 - 測試相互依賴
static int counter = 0;

@Test
void test1() {
    counter++;
    assertEquals(1, counter);
}

@Test
void test2() {
    assertEquals(1, counter); // 如果 test1 先執行會失敗
}

// 好的 - 獨立的測試
@Test
void testAdd() {
    Calculator calc = new Calculator();
    assertEquals(5, calc.add(2, 3));
}

@Test
void testSubtract() {
    Calculator calc = new Calculator();
    assertEquals(1, calc.subtract(3, 2));
}
```

### 使用適當的斷言

```java
// 好的 - 意圖清楚
assertTrue(user.isAdult());

// 不太清楚
assertEquals(true, user.isAdult());
```

### 保持測試快速

```java
// 避免 - 測試中的慢速操作
@Test
void slowTest() {
    Thread.sleep(1000); // 不要這樣做
}

// 較好 - 使用模擬或測試替身
@Test
void fastTest() {
    when(slowService.getData()).thenReturn("test");
    // 測試邏輯而不需等待
}
```

## 測試組織

### 套件結構

```
src/test/java/
├── com/example/
│   ├── service/
│   │   ├── UserServiceTest.java
│   │   └── OrderServiceTest.java
│   ├── repository/
│   │   └── UserRepositoryTest.java
│   └── controller/
│       └── UserControllerTest.java
```

### 測試類別命名

| 生產類別 | 測試類別 |
|-----------------|-----------|
| UserService | UserServiceTest |
| UserRepository | UserRepositoryTest |
| UserController | UserControllerTest |

## 相關連結

- [JUnit 5 官方文件](https://junit.org/junit5/docs/current/user/)
- [Mockito 文件](https://site.mockito.org)
- [AssertJ 文件](https://assertj.github.io)
- [Spring 測試文件](https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html)
