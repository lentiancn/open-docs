# Nginx Usage Guide

Comprehensive guide for using Nginx effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Server Blocks](#server-blocks)
- [Reverse Proxy](#reverse-proxy)
- [Load Balancing](#load-balancing)
- [SSL/TLS](#ssltls)
- [Performance Optimization](#performance-optimization)
- [Common Recipes](#common-recipes)
- [Troubleshooting](#troubleshooting)

---

## Basic Concepts

### What is Nginx?

Nginx is a high-performance HTTP server and reverse proxy server.

### Key Terms

| Term | Description |
|------|-------------|
| Worker Process | Handles requests |
| Worker Connections | Concurrent connections per process |
| Server Block | Virtual host configuration |
| Location | URL path matching |
| Upstream | Backend server group |

### Key Files and Directories

| Path | Description |
|------|-------------|
| `/etc/nginx/nginx.conf` | Main configuration |
| `/etc/nginx/sites-available/` | Available sites |
| `/etc/nginx/sites-enabled/` | Enabled sites |
| `/var/log/nginx/` | Log files |
| `/usr/share/nginx/html/` | Default document root |

---

## Server Blocks

### Basic Server Block

```nginx
server {
    listen 80;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### Multiple Domains

```nginx
# example.com
server {
    listen 80;
    server_name example.com;
    root /var/www/example.com;
}

# another.com
server {
    listen 80;
    server_name another.com;
    root /var/www/another.com;
}
```

### Redirects

```nginx
# HTTP to HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# www to non-www
server {
    listen 80;
    server_name www.example.com;
    return 301 $scheme://example.com$request_uri;
}
```

---

## Reverse Proxy

### Basic Proxy

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### Proxy with WebSocket Support

```nginx
location /ws/ {
    proxy_pass http://localhost:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}
```

### Proxy with SSL

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        proxy_pass http://localhost:3000;
    }
}
```

---

## Load Balancing

### Basic Load Balancer

```nginx
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### Load Balancing Methods

```nginx
# Round Robin (default)
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
}

# Least Connections
upstream backend {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
}

# IP Hash (session persistence)
upstream backend {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
}

# Weighted
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com weight=1;
}
```

### Health Check

```nginx
upstream backend {
    server backend1.example.com max_fails=3 fail_timeout=30s;
    server backend2.example.com max_fails=3 fail_timeout=30s;
}
```

---

## SSL/TLS

### Generate Self-Signed Certificate

```bash
# Generate private key
openssl genrsa -out key.pem 2048

# Generate CSR
openssl req -new -key key.pem -out csr.pem

# Generate self-signed certificate
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.pem
```

### SSL Configuration

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # Security settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        root /var/www/html;
    }
}
```

### Let's Encrypt (Auto Renewal)

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d example.com -d www.example.com

# Auto-renewal test
sudo certbot renew --dry-run
```

---

## Performance Optimization

### Gzip Compression

```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
```

### Browser Caching

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```

### Worker Optimization

```nginx
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}
```

### Connection Keep-Alive

```nginx
http {
    keepalive_timeout 65;
    keepalive_requests 100;
}
```

---

## Common Recipes

### Static Files Server

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;
    autoindex on;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### PHP-FPM

```nginx
server {
    listen 80;
    server_name php.example.com;

    root /var/www/php;
    index index.php index.html;

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### Node.js Backend

```nginx
server {
    listen 80;
    server_name node.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### Docker Registry

```nginx
server {
    listen 443 ssl;
    server_name registry.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    client_max_body_size 1G;

    location / {
        proxy_pass http://localhost:5000;
    }
}
```

---

## Troubleshooting

### Check Logs

```bash
# Error logs
tail -f /var/log/nginx/error.log

# Access logs
tail -f /var/log/nginx/access.log
```

### Common Errors

| Error | Solution |
|-------|----------|
| 403 Forbidden | Check file permissions, add index file |
| 404 Not Found | Check root path and file existence |
| 502 Bad Gateway | Check upstream is running |
| 504 Gateway Timeout | Increase proxy timeouts |

### Test Configuration

```bash
# Test configuration syntax
nginx -t

# Reload with debug
nginx -t && nginx -s reload
```

---

## Next Steps

- Explore [Nginx Modules](https://nginx.org/en/docs/)
- Learn about [Nginx Plus](https://www.nginx.com/products/nginx/)
- Read [Performance Tuning](https://nginx.org/en/docs/http/ngx_http_core_module.html)
