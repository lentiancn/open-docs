# Spring Cloud 使用ガイド

このガイドでは、分散システム開発のためにSpring Cloudコンポーネントを使用する方法について説明します。

## サービス検出

### Eurekaサーバーのセットアップ

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

```properties
# application.properties
server.port=8761
eureka.instance.hostname=localhost
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
eureka.client.service-url.defaultZone=http://${eureka.instance.hostname}:${server.port}/eureka/
```

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### Eurekaクライアント

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

```properties
spring.application.name=my-service
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
eureka.instance.prefer-ip-address=true
```

## APIゲートウェイ

### Spring Cloud Gateway

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

```properties
spring.cloud.gateway.routes[0].id=user-service
spring.cloud.gateway.routes[0].uri=lb://user-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/users/**
spring.cloud.gateway.routes[1].id=order-service
spring.cloud.gateway.routes[1].uri=lb://order-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/orders/**
```

### フィルター付きGateway

```java
@Component
public class CustomFilter implements GatewayFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 前処理
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            // 後処理
        }));
    }
}
```

## サービス間通信

### OpenFeignクライアント

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

```java
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/users/{id}")
    User getUserById(@PathVariable("id") Long id);
    
    @GetMapping("/users")
    List<User> getAllUsers();
}

@SpringBootApplication
@EnableFeignClients
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 負荷分散（Ribbon）

```properties
user-service.ribbon.listOfServers=localhost:8081,localhost:8082
```

## 設定管理

### Spring Cloud Configサーバー

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server</artifactId>
</dependency>
```

```properties
server.port=8888
spring.application.name=config-server
spring.cloud.config.server.git.uri=https://github.com/your-org/config-repo
spring.cloud.config.server.git.default-label=main
```

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```

### Configクライアント

```properties
spring.config.import=optional:configserver:http://localhost:8888
spring.application.name=myapp
```

## サーキットブレーカー

### Resilience4j

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
```

```java
@Service
public class UserService {
    
    @Autowired
    private UserClient userClient;
    
    @CircuitBreaker(name = "userService", fallbackMethod = "fallbackGetUser")
    public User getUserById(Long id) {
        return userClient.getUserById(id);
    }
    
    public User fallbackGetUser(Long id) {
        return new User(); // デフォルトまたはキャッシュされたユーザーを返す
    }
}
```

## 分散メッセージング

### Spring Cloud Stream

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream-binder-kafka</artifactId>
</dependency>
```

```java
@Component
public class MessageProducer {
    
    @Autowired
    private Source source;
    
    public void sendMessage(String message) {
        source.output().send(MessageBuilder.withPayload(message).build());
    }
}

@Component
public class MessageConsumer {
    
    @StreamListener(Sink.INPUT)
    public void receiveMessage(String message) {
        System.out.println("受信: " + message);
    }
}
```

```properties
spring.cloud.stream.bindings.input.destination=my-topic
spring.cloud.stream.bindings.output.destination=my-topic
```

## サービス監視

### Actuatorエンドポイント

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

```properties
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
```

## Docker Composeの例

```yaml
version: '3.8'
services:
  eureka:
    image: spring-cloud/eureka-server
    ports:
      - "8761:8761"
  
  config-server:
    image: spring-cloud/config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_CLOUD_CONFIG_SERVER_GIT_URI=https://github.com/your-org/config
  
  gateway:
    image: myapp/gateway
    ports:
      - "8080:8080"
    depends_on:
      - eureka
      - config-server
```

## ベストプラクティス

1. **リリーストレインを使用する**：常に互換性のあるSpring BootとSpring Cloudのバージョンを使う
2. **ヘルスチェックを有効にする**：すべてのサービスにactuator healthエンドポイントを設定する
3. **Config Serverを使用する**：集中設定で管理を簡素化する
4. **サーキットブレーカーを実装する**：カスケード障害を防ぐ
5. **トレーシングを有効にする**：Spring Cloud Sleuthを使用して分散トレーシングを行う

## 関連リンク

- [Spring Cloud 公式](https://spring.io/projects/spring-cloud)
- [Spring Cloud Netflix](https://cloud.spring.io/spring-cloud-netflix/)
- [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-gateway/)
- [Spring Cloud OpenFeign](https://cloud.spring.io/spring-cloud-openfeign/)
