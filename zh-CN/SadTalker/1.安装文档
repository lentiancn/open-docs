# SadTalker 安装指南

SadTalker 是一个 AI 项目，用于从单张图像和音频生成逼真的说话头像视频。

## 系统要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| GPU | NVIDIA 6GB 显存 | NVIDIA 16GB 显存 |
| 内存 | 8GB | 32GB |
| 存储 | 20GB 可用 | 50GB 可用 |

### 软件要求

| 软件 | 版本 | 说明 |
|------|------|------|
| Python | 3.8 - 3.10 | 推荐 3.9 |
| CUDA | 11.7+ | GPU 加速必需 |
| cuDNN | 8.5+ | CUDA 必需 |
| ffmpeg | 最新版 | 视频处理必需 |

## Linux/Ubuntu 安装

### 步骤 1：安装系统依赖

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Python 和开发工具
sudo apt install python3.9 python3-pip python3-venv git wget curl

# 安装系统库
sudo apt install libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1

# 安装 ffmpeg
sudo apt install ffmpeg
```

### 步骤 2：安装 CUDA（如需要）

```bash
# 下载并安装 CUDA 11.8
wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
sudo sh cuda_11.8.0_520.61.05_linux.run
```

### 步骤 3：克隆项目

```bash
git clone https://github.com/OpenTalker/SadTalker.git
cd SadTalker
```

### 步骤 4：创建虚拟环境

```bash
python3.9 -m venv venv
source venv/bin/activate

# 验证 Python 版本
python --version
```

### 步骤 5：安装 PyTorch

```bash
# CUDA 11.8 版本
pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118

# 验证安装
python -c "import torch; print(torch.cuda.is_available())"
```

### 步骤 6：安装依赖

```bash
pip install -r requirements.txt

# 安装额外依赖
pip install numpy opencv-python librosa soundfile
```

### 步骤 7：下载模型

```bash
# 创建模型目录
mkdir -p checkpoints

# 自动下载
bash scripts/download_models.sh

# 或从发布页手动下载
```

## Windows 安装

### 步骤 1：安装 Python

1. 从 python.org 下载 Python 3.9
2. 安装时勾选"Add Python to PATH"
3. 验证：`python --version`

### 步骤 2：安装 CUDA

1. 从 NVIDIA 网站下载 CUDA 11.8
2. 默认安装
3. 下载并安装 cuDNN 8.9

### 步骤 3：克隆和设置

```powershell
git clone https://github.com/OpenTalker/SadTalker.git
cd SadTalker

python -m venv venv
venv\Scripts\activate
```

### 步骤 4：安装依赖

```powershell
# 安装 PyTorch（CUDA 支持）
pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118

pip install -r requirements.txt
```

### 步骤 5：下载模型

从 GitHub releases 页面下载模型，放入 `checkpoints/` 目录。

## macOS 安装

### 步骤 1：安装依赖

```bash
# 安装 Homebrew（如未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Python 和 ffmpeg
brew install python@3.9 ffmpeg git
```

### 步骤 2：设置

```bash
git clone https://github.com/OpenTalker/SadTalker.git
cd SadTalker

python3.9 -m venv venv
source venv/bin/activate

# 安装 PyTorch（macOS 仅 CPU）
pip install torch==2.0.1 torchvision==0.15.2

pip install -r requirements.txt
```

注意：macOS 仅支持 CPU 模式，无法使用 GPU 加速。

## Docker 安装

### 使用 Docker

```bash
# 拉取镜像
docker pull ghcr.io/opentalker/sadtalker:latest

# 运行（需要 GPU）
docker run --gpus all -v $(pwd):/workspace -p 8888:8888 ghcr.io/opentalker/sadtalker:latest
```

### 使用 Docker Compose

```yaml
version: '3.8'
services:
  sadtalker:
    image: ghcr.io/opentalker/sadtalker:latest
    volumes:
      - ./workspace:/workspace
    ports:
      - "8888:8888"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
```

## 验证安装

```bash
# 测试基本功能
python inference.py --help
```

## 常见问题

### CUDA 内存不足

**解决方案：**
- 减小批次大小：`--batch_size 1`
- 使用较低分辨率：`--size 256`
- 启用模型卸载

### 缺少库（Windows）

**解决方案：**
- 安装 Visual C++ Redistributable 2015-2022
- 将 CUDA 添加到系统 PATH

### 模型下载失败

**解决方案：**
- 使用 VPN 或代理
- 从 GitHub releases 手动下载
- 检查网络连接

### 找不到 ffmpeg

**解决方案：**
- Linux：`sudo apt install ffmpeg`
- Windows：将 ffmpeg 添加到 PATH
- macOS：`brew install ffmpeg`

## 相关链接

- [GitHub 仓库](https://github.com/OpenTalker/SadTalker)
- [HuggingFace 演示](https://huggingface.co/spaces/fffilo/SadTalker)
- [论文](https://arxiv.org/abs/2303.17550)
- [模型下载](https://github.com/OpenTalker/SadTalker/releases)
