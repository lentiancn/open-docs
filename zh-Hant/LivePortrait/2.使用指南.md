# LivePortrait 使用指南

LivePortrait 是一個高效的人像動畫框架，使用驅動影片中的運動為靜態肖像製作動畫。它支援拼接和重定向控制。

## 快速開始

### 基本命令

```bash
# 影片驅動動畫
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results
```

### 帶拼接

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results \
  --stitching
```

### 帶眼睛/嘴唇重定向

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## 命令參數

### 輸入參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--source_image` | 輸入肖像圖片路徑 | 必要 |
| `--driving_video` | 驅動影片路徑 | 可選 |
| `--driven_audio` | 驅動音訊路徑 | 可選 |
| `--result_dir` | 輸出目錄 | ./results |

### 處理參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--stitching` | 啟用拼接 | False |
| `--eye_retargeting` | 眼睛重定向 (0-1) | 0 |
| `--lip_retargeting` | 嘴唇重定向 (0-1) | 0 |
| `--face_parser` | 啟用面部解析 | True |

### 效能參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--batch_size` | 批處理大小 | 1 |
| `--fps` | 輸出影片幀率 | 30 |

## 使用範例

### 範例 1：基本影片驅動動畫

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/basic
```

### 範例 2：帶拼接

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/stitching \
  --stitching
```

### 範例 3：眼睛控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/eyes \
  --eye_retargeting 0.8
```

### 範例 4：嘴唇同步控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/lips \
  --lip_retargeting 0.7
```

### 範例 5：完整控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/full \
  --stitching \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Python API

### 基本用法

```python
from liveportrait import LivePortrait

# 初始化
lp = LivePortrait()

# 製作肖像動畫
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.5,
    lip_retargeting=0.5
)

print(f"影片儲存至: {result}")
```

### 進階用法

```python
from liveportrait import LivePortrait
import torch

# 使用自訂設定初始化
lp = LivePortrait(
    checkpoint_path="pretrained_models/liveportrait.pth",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# 生成帶完整控制
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.8,
    lip_retargeting=0.8,
    output_fps=30,
    output_resolution=(512, 512)
)
```

### 批次處理

```python
from liveportrait import LivePortrait
import os

lp = LivePortrait()

# 處理多張圖片
source_dir = "source_images/"
driving_video = "driving.mp4"

for image_file in os.listdir(source_dir):
    if image_file.endswith(('.jpg', '.png')):
        result = lp.animate(
            source_image=os.path.join(source_dir, image_file),
            driving_video=driving_video,
            stitching=True
        )
```

## 網頁介面

### 執行網頁展示

```bash
python app.py
```

然後在瀏覽器中打開 http://localhost:7860

### 網頁介面功能

1. **來源圖像上傳** - 上傳肖像圖片
2. **驅動影片上傳** - 選擇驅動影片
3. **拼接開關** - 啟用/停用拼接
4. **眼睛控制** - 調整眼睛運動強度
5. **嘴唇控制** - 調整嘴唇同步強度
6. **生成** - 建立動畫
7. **下載** - 儲存結果

## 功能

### 1. 拼接

拼接模組將生成的頭部與身體無縫連接：

```bash
--stitching
```

- 頭部和身體之間的平滑過渡
- 適用於各種圖像風格（寫實、油畫、雕塑、3D）

### 2. 眼睛重定向

使用數值控制眼睛睜開程度 (0-1)：

```bash
--eye_retargeting 0.5
```

- 0: 閉眼
- 1: 完全睜眼
- 0.5: 自然

### 3. 嘴唇重定向

控制嘴唇運動強度：

```bash
--lip_retargeting 0.5
```

- 0: 最小運動
- 1: 最大運動
- 0.5: 自然

## 輸入要求

### 來源圖像

- 格式：JPG、PNG
- 解析度：建議 512x512 或更大
- 人臉：正面、清晰
- 背景：任意

### 驅動影片

- 格式：MP4、AVI
- 時長：1-60 秒
- 解析度：任意
- 人臉：清晰的面部表情

## 輸出

### 影片格式

- 格式：MP4
- 編解碼器：H.264
- 解析度：512x512
- 幀率：30

### 輸出目錄

```
results/
├── output.mp4          # 生成的影片
└── (暫時檔案)
```

## 故障排除

### 動畫品質差

**解決方案：**
- 使用更高品質的來源圖像
- 確保驅動影片有清晰的人臉
- 調整重定向參數

### 未偵測到人臉

**解決方案：**
- 使用更清晰的肖像圖像
- 確保人臉可見
- 檢查圖像格式

### 處理緩慢

**解決方案：**
- 降低輸出解析度
- 如不需要則停用拼接
- 使用 GPU 加速

### GPU 記憶體不足

**解決方案：**
- 將批處理大小減小到 1
- 使用更小的圖像大小
- 關閉其他 GPU 應用程式

## 效能提示

### 更快的處理

1. 如不需要則停用拼接
2. 使用較低的輸出解析度
3. 降低 fps

### 更好的品質

1. 啟用拼接
2. 使用高品質來源圖像
3. 調整重定向參數

## 相關連結

- [GitHub](https://github.com/KwaiVGI/LivePortrait)
- [論文](https://arxiv.org/abs/2407.03168)
- [展示](https://liveportrait.github.io)
