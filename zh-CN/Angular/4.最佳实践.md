# Angular 最佳实践指南

本文档汇集了 Angular 开发过程中的最佳实践和设计原则，帮助开发者编写高质量、可维护的代码。

---

## 目录

1. [项目结构最佳实践](#项目结构最佳实践)
2. [组件设计最佳实践](#组件设计最佳实践)
3. [服务设计最佳实践](#服务设计最佳实践)
4. [性能优化最佳实践](#性能优化最佳实践)
5. [安全最佳实践](#安全最佳实践)
6. [测试最佳实践](#测试最佳实践)
7. [代码风格最佳实践](#代码风格最佳实践)
8. [Git 提交规范](#git-提交规范)

---

## 项目结构最佳实践

### 模块化架构

将应用按功能模块划分，每个模块负责特定的功能域：

```
src/
├── app/
│   ├── core/                    # 核心模块
│   │   ├── services/           # 全局服务
│   │   ├── guards/             # 路由守卫
│   │   ├── interceptors/       # HTTP 拦截器
│   │   └── models/             # 数据模型
│   │
│   ├── shared/                  # 共享模块
│   │   ├── components/         # 公共组件
│   │   ├── directives/         # 公共指令
│   │   ├── pipes/              # 公共管道
│   │   └── utils/              # 工具函数
│   │
│   ├── features/                # 功能模块
│   │   ├── auth/               # 认证功能
│   │   ├── user/               # 用户管理
│   │   ├── product/            # 产品管理
│   │   └── dashboard/          # 仪表板
│   │
│   └── layout/                  # 布局组件
│       ├── header/
│       ├── sidebar/
│       └── footer/
```

### 独立组件优先

Angular 14+ 推荐使用独立组件（Standalone Components）：

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-user-card',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './user-card.component.html',
  styleUrls: ['./user-card.component.css']
})
export class UserCardComponent {
  // 组件逻辑
}
```

### barrel 文件模式

使用 barrel 文件（index.ts）简化导入路径：

```typescript
// shared/components/index.ts
export * from './button/button.component';
export * from './card/card.component';
export * from './modal/modal.component';

// 使用时
import { ButtonComponent, CardComponent } from '@shared/components';
```

---

## 组件设计最佳实践

### 单一职责原则

每个组件应该只负责一个功能：

```typescript
// ❌ 不好：一个组件做了太多事情
@Component({
  selector: 'app-user-dashboard',
  template: `
    <app-user-profile [user]="user"></app-user-profile>
    <app-user-orders [orders]="orders"></app-user-orders>
    <app-user-settings [settings]="settings"></app-user-settings>
  `
})
export class UserDashboardComponent {
  // 处理用户信息、订单、设置...
}

// ✅ 好：拆分多个单一职责组件
@Component({ selector: 'app-user-profile' }) // 只显示用户信息
@Component({ selector: 'app-user-orders' })  // 只显示订单
@Component({ selector: 'app-user-settings' }) // 只显示设置
```

### 智能组件与展示组件分离

- **智能组件**（Smart/Container）：处理业务逻辑、数据获取
- **展示组件**（Dumb/Presentational）：只负责显示数据

```typescript
// 智能组件 - 负责数据获取和状态管理
@Component({
  selector: 'app-user-container',
  template: `
    <app-user-list 
      [users]="users" 
      (select)="onSelect($event)">
    </app-user-list>
  `
})
export class UserContainerComponent implements OnInit {
  users: User[] = [];
  
  constructor(private userService: UserService) {}
  
  ngOnInit() {
    this.userService.getUsers().subscribe(users => this.users = users);
  }
  
  onSelect(user: User) {
    // 处理选择逻辑
  }
}

// 展示组件 - 只负责显示
@Component({
  selector: 'app-user-list',
  inputs: ['users'],
  outputs: ['select'],
  template: `
    <div *ngFor="let user of users" (click)="select.emit(user)">
      {{ user.name }}
    </div>
  `
})
export class UserListComponent {
  users: User[] = [];
  select = new EventEmitter<User>();
}
```

### 使用 OnPush 变更检测

对于不经常变化的组件，使用 OnPush 策略提升性能：

```typescript
@Component({
  selector: 'app-card',
  changeDetection: ChangeDetectionStrategy.OnPush,
  template: `...`
})
export class CardComponent {
  @Input() data: any;
}
```

### 避免在模板中写复杂逻辑

将模板中的逻辑移到组件方法：

```typescript
// ❌ 不好：模板中包含复杂逻辑
@Component({
  template: `
    <div *ngFor="let item of items">
      {{ item.price * item.quantity > 1000 ? 'VIP' : '普通' }}
    </div>
  `
})

// ✅ 好：逻辑移到组件
@Component({
  template: `
    <div *ngFor="let item of items">
      {{ getCustomerType(item) }}
    </div>
  `
})
export class ProductComponent {
  getCustomerType(item: any): string {
    return item.price * item.quantity > 1000 ? 'VIP' : '普通';
  }
}
```

---

## 服务设计最佳实践

### 提供服务的方式

使用 `providedIn: 'root'` 让服务成为单例：

```typescript
@Injectable({
  providedIn: 'root'  // 全局单例
})
export class UserService {
  // 服务逻辑
}
```

### 异步数据处理

使用 Observable 处理异步数据：

```typescript
@Injectable({ providedIn: 'root' })
export class DataService {
  private http = inject(HttpClient);

  // 使用 Observable
  getData(): Observable<Data[]> {
    return this.http.get<Data[]>('/api/data');
  }

  // 使用 Promise
  async getDataAsync(): Promise<Data[]> {
    return firstValueFrom(this.http.get<Data[]>('/api/data'));
  }
}
```

### 错误处理

统一处理 HTTP 错误：

```typescript
@Injectable({ providedIn: 'root' })
export class ErrorHandlerService {
  handleError(error: HttpErrorResponse) {
    let errorMessage = '未知错误';
    
    if (error.error instanceof ErrorEvent) {
      // 客户端错误
      errorMessage = `错误: ${error.error.message}`;
    } else {
      // 服务端错误
      errorMessage = `错误代码: ${error.status}\n消息: ${error.message}`;
    }
    
    console.error(errorMessage);
    return throwError(() => new Error(errorMessage));
  }
}
```

---

## 性能优化最佳实践

### 延迟加载模块

按需加载模块，减少首屏加载时间：

```typescript
// ✅ 好：延迟加载
const routes: Routes = [
  {
    path: 'admin',
    loadChildren: () => import('./admin/admin.module').then(m => m.AdminModule)
  },
  {
    path: 'dashboard',
    loadComponent: () => import('./dashboard/dashboard.component').then(m => m.DashboardComponent)
  }
];

// ❌ 不好：立即加载所有模块
const routes: Routes = [
  { path: 'admin', component: AdminComponent }
];
```

### 使用 trackBy 优化 ngFor

```html
<!-- ✅ 好：使用 trackBy -->
<li *ngFor="let item of items; trackBy: trackById">{{ item.name }}</li>

<!-- ❌ 不好：不使用 trackBy -->
<li *ngFor="let item of items">{{ item.name }}</li>
```

```typescript
trackById(index: number, item: any): number {
  return item.id;
}
```

### 避免不必要的变更检测

```typescript
@Component({
  changeDetection: ChangeDetectionStrategy.OnPush,
  // ...
})
export class PureComponent {
  // 组件逻辑
}
```

### 使用信号 (Signals) - Angular 16+

```typescript
@Component({
  selector: 'app-counter',
  template: `
    <p>计数: {{ count() }}</p>
    <p> doubled: {{ doubled() }}</p>
    <button (click)="increment()">+</button>
  `
})
export class CounterComponent {
  count = signal(0);
  doubled = computed(() => this.count() * 2);

  increment() {
    this.count.update(c => c + 1);
  }
}
```

### 图片优化

```html
<!-- 使用懒加载 -->
<img [src]="imageUrl" loading="lazy" alt="...">

<!-- 设置图片尺寸 -->
<img [src]="imageUrl" width="200" height="200" alt="...">
```

---

## 安全最佳实践

### 防止 XSS 攻击

Angular 默认会自动转义 HTML：

```typescript
// ✅ 好：Angular 会自动转义
@Component({
  template: `<div>{{ userInput }}</div>`
})

// ❌ 不好：使用 innerHTML 可能导致 XSS
@Component({
  template: `<div [innerHTML]="userInput"></div>`
})
```

如果必须使用 HTML，使用 DomSanitizer：

```typescript
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';

constructor(private sanitizer: DomSanitizer) {}

getSafeHtml(html: string): SafeHtml {
  return this.sanitizer.bypassSecurityTrustHtml(html);
}
```

### 使用 HTTP 拦截器添加认证

```typescript
@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const token = this.authService.getToken();
    
    if (token) {
      req = req.clone({
        setHeaders: {
          Authorization: `Bearer ${token}`
        }
      });
    }
    
    return next.handle(req);
  }
}
```

### 防止 CSRF 攻击

使用 Angular 的 HttpClientXsrfModule：

```typescript
import { HttpClientModule, HttpClientXsrfModule } from '@angular/common/http';

@NgModule({
  imports: [
    HttpClientModule,
    HttpClientXsrfModule.withOptions({
      cookieName: 'XSRF-TOKEN',
      headerName: 'X-XSRF-TOKEN'
    })
  ]
})
export class AppModule {}
```

---

## 测试最佳实践

### 单元测试

```typescript
describe('UserService', () => {
  let service: UserService;
  let httpMock: HttpTestingController;

  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [UserService]
    });

    service = TestBed.inject(UserService);
    httpMock = TestBed.inject(HttpTestingController);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });

  it('should get users', () => {
    service.getUsers().subscribe(users => {
      expect(users).toBeTruthy();
      expect(users.length).toBe(2);
    });

    const req = httpMock.expectOne('/api/users');
    expect(req.request.method).toBe('GET');
    req.flush([{ id: 1 }, { id: 2 }]);
  });
});
```

### 组件测试

```typescript
describe('UserCardComponent', () => {
  let component: UserCardComponent;
  let fixture: ComponentFixture<UserCardComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [UserCardComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(UserCardComponent);
    component = fixture.componentInstance;
  });

  it('should display user name', () => {
    component.user = { name: '张三', email: 'zhangsan@example.com' };
    fixture.detectChanges();

    const compiled = fixture.nativeElement;
    expect(compiled.querySelector('.name').textContent).toContain('张三');
  });
});
```

### E2E 测试

```typescript
// user.e2e-spec.ts
import { browser, by, element } from 'protractor';

describe('User List', () => {
  beforeEach(() => {
    browser.get('/users');
  });

  it('should display user list', () => {
    const users = element.all(by.css('.user-item'));
    expect(users.count()).toBeGreaterThan(0);
  });

  it('should navigate to user detail', () => {
    element(by.css('.user-item')).click();
    expect(browser.getCurrentUrl()).toContain('/users/1');
  });
});
```

---

## 代码风格最佳实践

### 命名规范

- **组件**: 使用 kebab-case 命名选择器，PascalCase 命名类
- **服务**: 使用 PascalCase 命名，以 Service 结尾
- **管道**: 使用 PascalCase 命名，以 Pipe 结尾
- **文件**: 使用 kebab-case 命名

```typescript
// ✅ 好
@Component({
  selector: 'app-user-profile'
})
export class UserProfileComponent {}

@Injectable()
export class UserService {}

// ❌ 不好
@Component({
  selector: 'appUserProfile'
})
export class userProfileComponent {}
```

### 导入排序

使用 EditorConfig 或 Prettier 格式化导入：

```typescript
// 1. Angular 核心模块
import { Component, OnInit } from '@angular/core';

// 2. Angular 公共模块
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';

// 3. 第三方库
import { NzButtonModule } from 'ng-zorro-antd/button';

// 4. 应用模块
import { UserService } from '@core/services';
import { UserCardComponent } from '@shared/components';
```

### 常量定义

```typescript
// ✅ 好：使用 const 或枚举
const API_BASE_URL = 'https://api.example.com';
const MAX_RETRY_COUNT = 3;

enum UserRole {
  Admin = 'admin',
  User = 'user',
  Guest = 'guest'
}

// ❌ 不好：使用魔法数字
if (retryCount > 3) { ... }
```

---

## Git 提交规范

### 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type 类型

- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具变动

### 示例

```
feat(user): 添加用户搜索功能

- 实现按用户名搜索
- 添加搜索结果分页
- 优化搜索性能

Closes #123
```

---

## 相关链接

- [Angular 官方风格指南](https://angular.io/guide/styleguide)
- [Angular 最佳实践](https://angular.io/best-practices/top-ten)
- [Angular 性能检查清单](https://angular.io/guide/performance)
