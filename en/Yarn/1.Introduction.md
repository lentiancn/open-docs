# Yarn ðŸ§¶

## What is Yarn?

Yarn is a powerful **package manager** and project manager developed and maintained by Facebook (now Meta). It is designed to provide faster, more reliable, and more secure dependency management for modern JavaScript developers. Whether you're working on simple personal projects or managing complex enterprise-level monorepos, Yarn has you covered.

Yarn was first released in 2016, created to solve some of the pain points of npm at the time, such as slow installation speeds and uncertain dependency versions. After years of development, Yarn has evolved from a simple package manager into a complete JavaScript project management tool, offering powerful features like Workspaces, plugin system, and Zero-Installs.

### Core Design Principles

The Yarn development team adheres to several core design principles that are reflected in every feature:

**Speed First**: Yarn uses parallel downloads and intelligent caching mechanisms, significantly improving dependency installation speed. In most scenarios, Yarn's installation speed is several times faster than npm, thanks to its unique offline caching system and parallel installation strategy.

**Deterministic Guarantees**: Yarn precisely records the exact version of each dependency and its transitive dependencies through the yarn.lock file, ensuring that installations performed at different times on different machines produce identical results. This determinism is crucial for team collaboration and CI/CD pipeline stability.

**Enhanced Security**: Yarn verifies checksums for each package during the installation process, ensuring downloaded packages exactly match expectations and preventing supply chain attacks and security threats. Additionally, Yarn offers Hardened Mode, which detects and blocks potentially malicious code during installation.

**Developer Experience**: Yarn focuses on developer experience, providing clear command-line output, interactive updates, rich prompt information, and more. The plugin system allows developers to customize and extend functionality based on project needs.

### Yarn Compared to Other Package Managers

In the JavaScript ecosystem, there are three main package managers: npm, Yarn, and pnpm. Each has its own characteristics and use cases:

**Compared to npm**: npm is the official Node.js package manager with the largest user base and richest ecosystem. Yarn outperforms npm in speed, determinism, and offline support, though npm has been continuously improving in recent years. npm's package-lock.json mechanism is similar to Yarn's yarn.lock, both ensuring deterministic installations.

**Compared to pnpm**: pnpm uses a unique symlink strategy to manage disk space more efficiently, showing clear advantages in large projects. Yarn has a slight edge in feature richness and community support, while pnpm excels in disk space utilization.

### Yarn Version Family

Yarn currently has two main version branches:

**Yarn 1.x (Classic)**: Also known as Yarn Classic, this is the originally released version that is still being maintained but no longer receiving new features. The last classic version is 1.22.x series.

**Yarn 2.x and above (Berry)**: Also known as Yarn Berry, this is a completely rewritten version with new architecture, providing PnP (Plug'n'Play) mode, a more powerful plugin system, and other advanced features. Yarn 4.x is the current stable version.

### Who Should Use Yarn and When

Yarn is suitable for JavaScript projects of all sizes:

**Individual Developers**: For independent developers, Yarn's fast installation and clear command-line output significantly improve development experience. Its offline caching feature is especially useful for developers in unstable network environments.

**Open Source Project Maintainers**: Yarn's Workspaces feature makes managing multi-package projects effortless. Developers can maintain core libraries andå‘¨è¾¹ tools in one repository, improving development and release efficiency.

**Enterprise Development Teams**: For enterprise teams, Yarn's determinism and security are particularly important. The yarn.lock file ensures team members use exactly the same dependency versions, avoiding strange issues caused by environment differences.

**DevOps and CI/CD**: Yarn's Hardened Mode and Zero-Installs features are perfect for automated build processes, significantly reducing CI/CD build times.

---

## Major Features of Yarn

### Workspaces

Workspaces is one of Yarn's most innovative features, allowing you to manage multiple related packages within a single code repository. This concept originated from tools like Lerna, but Yarn was the first package manager to natively integrate it into its core.

The core advantage of workspaces is simplifying multi-package dependency management. When you have a core library and multiple related tools or plugins, workspaces automatically handle inter-package dependencies, avoid duplicate installations, and streamline development and debugging.

For example, suppose you're developing a UI component library with a core package in packages/core and peripheral components in packages/button, packages/input, and so on. With workspaces, you can manage all dependencies in the root directory, while packages can reference each other without manual configuration.

**Practical Application Scenarios**: When developing a large open source project, you'll typically have core libraries, documentation sites, build tools, and more. Using workspaces, you can put them in the same repository, share dependencies, unify versions, and simplify CI/CD processes. Many well-known projects like Babel, Jest, and React use this approach.

**Advanced Workspace Features**: Yarn also offers Focused Install functionality, allowing you to install dependencies for specific workspaces only, which can significantly save installation time in large projects. The Constraints feature lets you define rules ensuring all workspaces follow consistent dependency strategies.

### Offline Caching

Yarn's offline caching is one of its most popular features. When you first install a package, Yarn caches it locally. Later, whether reinstalling or a new project needing the same version, Yarn can fetch directly from cache without downloading again.

This mechanism is particularly useful for:

**Continuous Development Environments**: When developing in corporate internal networks or unstable network environments, offline caching allows you to continue working without internet access. As long as packages have been installed before, they can be fetched from cache.

**CI/CD Pipelines**: In continuous integration environments, offline caching can significantly reduce dependency download times and speed up builds.

**Multi-project Collaboration**: If you're developing multiple projects simultaneously, the same version of dependencies only needs to be downloaded once and can then be reused from cache.

### Parallel Installation

Unlike npm's serial installation, Yarn uses parallel installation strategy by default, downloading multiple packages simultaneously. This design makes full use of network bandwidth, significantly reducing installation time.

Yarn's parallel installation is intelligent: it analyzes the dependency tree, determines which packages can be downloaded in parallel, while ensuring correct dependency order. For projects with many dependencies, this optimization brings obvious speed improvements.

### Hardened Mode

Hardened Mode is a security feature designed for enterprise applications. When this mode is enabled, if Yarn detects any operation that would modify the yarn.lock file during installation, it immediately exits with an error.

This feature is primarily used in CI/CD environments, ensuring only verified dependency changes can enter the codebase. It prevents accidental modificationå¯¼è‡´çš„ä¾èµ–ä¸ä¸€è‡´é—®é¢˜ï¼Œæé«˜äº†ä¾›åº”é“¾å®‰å…¨æ€§ã€‚

### Zero-Installs

Zero-Installs is a revolutionary feature introduced in Yarn 4.x. Traditionally, every time you clone a project or switch branches, you need to run yarn install to install dependencies, which can take minutes in large projects.

Zero-Installs solves this by committing dependency information directly to the code repository. Yarn generates a .pnp.cjs file containing location information for all dependencies. Additionally, Yarn's global cache can be committed as a separate directory.

This way, after cloning a project, there's no need to run the installation commandâ€”all dependencies are immediately available. This is a huge productivity boost for large teams and developers who frequently switch branches.

### Plugin System

Yarn's plugin system allows developers to extend and customize Yarn's functionality. The official provides various plugins covering scenarios like packaging, publishing, and version management.

The community has also developed many useful plugins, such as supporting specific registries and integrating various CI tools. If you have special needs, you can also develop custom plugins to meet project requirements.

### Interactive Updates

Yarn provides an interactive update mode (yarn up -i), allowing you to intuitively select which packages to update and their versions in the terminal. This feature combines flexibility with convenience, especially suitable for scenarios where careful dependency update handling is needed.

---

## Quick Start

### Environment Preparation

Before installing Yarn, ensure your system meets the following requirements:

**Node.js Version Requirements**:

- Yarn 4.x requires Node.js 16.0.0 or higher
- Yarn 3.x requires Node.js 14.0.0 or higher
- Yarn 1.x requires Node.js 8.0.0 or higher

Using Node.js 18 LTS or 20 LTS is recommended, as these versions provide the best performance and stability support.

**Operating System Support**:

Yarn supports all major operating systems, including macOS, Linux (various distributions), and Windows. On Windows, using PowerShell or WSL2 is recommended for the best experience.

### Installing Yarn

#### Method 1: Using Corepack (Recommended)

Corepack is a package manager manager built into Node.js 14.6.0 and above. It allows you to manage Yarn versions at the project level without global installation.

First, enable Corepack:

```bash
corepack enable
```

Then install and activate Yarn stable:

```bash
corepack prepare yarn@stable --activate
```

If you need a specific version:

```bash
# Install Yarn 4.x
corepack prepare yarn@4.0.0 --activate

# Install Yarn 3.x
corepack prepare yarn@3.6.0 --activate
```

#### Method 2: Using npm Global Installation

If you prefer the traditional global installation approach:

```bash
npm install -g yarn
```

#### Method 3: Using Script Installation (macOS/Linux)

The official provides a convenient installation script:

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash
```

If you need a specific version:

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 4.0.0
```

#### Method 4: Using PowerShell Installation (Windows)

On Windows, you can install using PowerShell:

```powershell
iwr -useb https://yarnpkg.com/install.ps1 | iex
```

### Verifying Installation

After installation, verify Yarn is correctly installed:

```bash
# Check version
yarn --version

# View help
yarn --help
```

### Initializing a New Project

If you're starting a new project from scratch:

```bash
# Interactive initialization, will guide you through project information
yarn init -2

# Or non-interactive quick creation
yarn init -y
```

This command creates a package.json file in the current directory.

### Installing Project Dependencies

If you already have a project with package.json:

```bash
# Install all dependencies
yarn install

# Or shorthand
yarn
```

Yarn will automatically read package.json and yarn.lock (if any) and install all necessary dependencies.

---

## Common Commands in Detail

### Dependency Management Commands

#### Adding Dependencies

Adding dependencies is one of the most frequently used operations:

```bash
# Add production dependency (needed at runtime)
yarn add lodash

# Add development dependency (only needed during development)
yarn add -D typescript
yarn add --dev typescript

# Add specific version
yarn add lodash@4.17.21

# Add latest version
yarn add lodash@latest

# Add pre-release version
yarn add lodash@beta
```

Yarn automatically selects the appropriate version modifier. By default, it uses the caret (^), allowing minor version updates. For example, ^4.17.21 allows installing 4.18.0 but not 5.0.0.

**Version Modifier Options**:

- `-E, --exact`: Use exact version, no modifier added
- `-T, --tilde`: Use tilde modifier, allowing patch version updates
- `-C, --caret`: Use caret modifier (default)

```bash
# Exact version
yarn add -E lodash@4.17.21

# Tilde version
yarn add -T lodash@4.17.21
```

#### Removing Dependencies

```bash
# Remove dependency
yarn remove lodash

# Remove development dependency
yarn remove typescript --dev
```

#### Updating Dependencies

```bash
# Update to latest version (according to version modifier)
yarn up lodash
yarn upgrade lodash

# Update to specific version
yarn up lodash@4.17.20

# Interactive update (will show available version list)
yarn up -i

# Update all dependencies
yarn up --all
```

### Script Running Commands

Scripts defined in package.json can be run via yarn:

```bash
# Run scripts defined in package.json
yarn dev
yarn build
yarn test

# Or explicitly use run command
yarn run dev
yarn run build
```

If the script name conflicts with Yarn built-in commands, use run explicitly:

```bash
yarn run my-custom-script
```

### Viewing Dependency Information

```bash
# List all dependencies (including nested dependencies)
yarn list

# List only top-level dependencies
yarn list --level=0

# Display dependencies in tree format
yarn list --tree

# Check which dependencies have outdated versions
yarn outdated

# View package information
yarn info lodash

# View specific version package information
yarn info lodash@4.17.21

# View why a package was installed
yarn why lodash
```

### Cache Management

```bash
# View cache directory
yarn cache dir

# List cached packages
yarn cache list

# Clean cache
yarn cache clean

# Clean specific package cache
yarn cache clean lodash
```

### Global Operations

```bash
# Globally install package
yarn global add yarn

# View global bin directory
yarn global bin
```

### Other Common Commands

```bash
# Diagnose problems
yarn doctor

# Explain error code
yarn explain E110

# List available scripts
yarn run

# Run package in temporary environment
yarn dlx create-react-app my-app
```

---

## Complete Guide to Workspaces

### What are Workspaces?

Workspaces is a project management pattern allowing you to organize multiple related packages within a single code repository. Yarn was the first JavaScript package manager to natively support workspaces, a feature that has completely changed how large projects are developed.

Consider this scenario: You're developing a UI component library with core functionality in one package, dozens of separate components in other packages, and a documentation site as another package. Before workspaces, you needed to manually manage dependencies between these packages, needing to publish new versions for each change to test in other packages.

With workspaces, you can put all packages in the same repository, they can directly reference each other, and changes take effect immediately. This greatly simplifies development and debugging workflows.

### Configuring Workspaces

Add the workspaces field in the root package.json:

```json
{
  "name": "my-monorepo",
  "private": true,
  "workspaces": [
    "packages/*"
  ]
}
```

The workspaces field accepts an array, with each element being a path pattern relative to the root directory. The above configuration means all subdirectories in the packages directory will become independent workspaces.

More complex configuration example:

```json
{
  "workspaces": [
    "packages/*",
    "apps/*",
    "tools/*"
  ]
}
```

### Workspace Package Structure

Each workspace is essentially an independent npm package with its own package.json:

```
my-monorepo/
â”œâ”€â”€ package.json          # Root package.json defining workspaces
â””â”€â”€ packages/
    â”œâ”€â”€ core/            # First workspace
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ src/
    â”œâ”€â”€ button/         # Second workspace
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ src/
    â””â”€â”€ input/           # Third workspace
        â”œâ”€â”€ package.json
        â””â”€â”€ src/
```

### Referencing Dependencies Between Workspaces

When referencing packages between workspaces, use the workspace: protocol:

```json
{
  "dependencies": {
    "@my-org/core": "workspace:*",
    "@my-org/utils": "workspace:^",
    "@my-org/constants": "workspace:~"
  }
}
```

- workspace:* uses the exact local version
- workspace:^ uses the local version's compatible range (recommended)
- workspace:~ uses the local version's patch range

When publishing packages, Yarn automatically converts workspace: protocols to actual version numbers.

### Workspace-Specific Commands

```bash
# Add dependency to specific workspace
yarn workspace @my-org/button add lodash

# Run script in specific workspace
yarn workspace @my-org/button run build

# Run command in all workspaces
yarn workspaces foreach run build

# Focused installation (only install specified workspace and its dependencies)
yarn workspaces focus @my-org/button

# List all workspaces
yarn workspaces list
```

### Advanced Workspace Features

**Constraints**: Constraints feature allows you to define rules managing all workspaces. For example, ensuring all workspaces use the same TypeScript version:

```javascript
// constraints.pro
workspaces.forEach(workspace => {
  const ts = workspace.dependencies.get("typescript");
  if (ts && ts.version !== "^5.0.0") {
    workspace.dependencies.set("typescript", "workspace:^5.0.0");
  }
});
```

**Global Scripts**: Using a colon (:) in script names creates global scripts that can be run from anywhere in the project:

```json
{
  "scripts": {
    "build:all": "yarn workspaces foreach -pt run build"
  }
}
```

Run as:

```bash
yarn build:all
```

---

## Configuration File Details

### Understanding package.json

package.json is the core configuration file for Node.js projects, and Yarn is fully compatible with npm standards:

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "description": "My project description",
  "private": true,
  "workspaces": ["packages/*"],
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test": "vitest",
    "lint": "eslint src --ext .ts,.tsx"
  },
  "dependencies": {
    "react": "^18.2.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "@types/react": "^18.2.0"
  },
  "peerDependencies": {
    "react": ">=16.8.0"
  },
  "optionalDependencies": {
    "fsevents": "^2.3.0"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "packageManager": "yarn@4.0.0"
}
```

### .yarnrc.yml Configuration

Yarn 4.x uses YAML format configuration files:

```yaml
# npm registry
npmRegistryServer: "https://registry.npmjs.org"

# Enable global cache
enableGlobalCache: false

# Node.js linker mode
# node-modules: Traditional mode
# pnp: Plug'n'Play mode
nodeLinker: node-modules

# Enable scripts
enableScripts: true

# Enable global patches
enableGlobalPatches: false

# Unsafe HTTP whitelist
unsafeHttpWhitelist:
  - "localhost"
  - "my-internal-registry.com"
```

### Environment Variable Configuration

You can override configurations through environment variables:

```bash
# Set registry
YARN_NPM_REGISTRY_SERVER=https://registry.npmmirror.com yarn install
```

---

## Plugin System

### Introduction to Plugins

Yarn's plugin system is one of its most extensible features. Plugins can add new commands, modify existing behavior, integrate external services, and more.

### Official Plugins

Yarn 4.x includes some core plugins built-in while providing rich official plugins:

```bash
# List available plugins
yarn plugin list
```

Common plugins include:

- @yarnpkg/plugin-github: Install packages from GitHub
- @yarnpkg/plugin-npm: npm-related functionality
- @yarnpkg/plugin-pack: Packaging functionality
- @yarnpkg/plugin-workspace-tools: Workspace tools enhancement

### Installing Plugins

```bash
# Install from official plugin list
yarn plugin import @yarnpkg/plugin-github

# Install from URL
yarn plugin import https://example.com/plugin.js

# Install from local file
yarn plugin import ./my-plugin.js
```

### Removing Plugins

```bash
yarn plugin remove @yarnpkg/plugin-github
```

---

## Best Practices

### Version Control Best Practices

Always commit yarn.lock to version control. This file records exact versions of all dependencies and is key to ensuring team members and CI environments use the same dependencies.

### CI/CD Integration Recommendations

In continuous integration environments, it's recommended to use Hardened Mode to prevent accidental lockfile modifications:

```bash
yarn install --immutable
```

If your project uses Zero-Installs, also add cache validation:

```bash
yarn install --immutable --immutable-cache
```

### Dependency Update Strategy

- Regularly check outdated dependencies: yarn outdated
- Use interactive updates for careful major version upgrades: yarn up -i
- Read changelogs before major version upgrades

### Performance Optimization

- Use workspaces to centrally manage dependencies
- Use focused installation to reduce installation time in large projects
- Periodically clean unnecessary caches

### Security Recommendations

- Run security audits regularly: yarn npm audit
- Use private registries for handling sensitive dependencies
- Review third-party plugin sources

---

## Frequently Asked Questions

### Yarn vs npm Command Comparison

Many npm commands have corresponding implementations in Yarn:

| npm Command | Yarn Command | Description |
|-------------|--------------|-------------|
| npm install | yarn | Install dependencies |
| npm install \<pkg\> | yarn add \<pkg\> | Add dependency |
| npm install -D \<pkg\> | yarn add -D \<pkg\> | Add dev dependency |
| npm uninstall \<pkg\> | yarn remove \<pkg\> | Remove dependency |
| npm update | yarn up | Update dependencies |
| npm run \<script\> | yarn \<script\> | Run script |
| npm list | yarn list | List dependencies |
| npm outdated | yarn outdated | Check outdated deps |

### What if Installation Fails?

1. Clean cache: yarn cache clean
2. Remove node_modules and yarn.lock
3. Reinstall: yarn install

### How to Switch Yarn Versions?

Use Corepack to easily switch versions:

```bash
# Switch to stable
corepack prepare yarn@stable --activate

# Switch to specific version
corepack prepare yarn@3.6.0 --activate
```

### What is the Purpose of yarn.lock?

yarn.lock records the exact version of each package in the dependency tree, including transitive dependencies. This ensures that no matter in what environment or when installations occur, completely identical results are obtained.

### Should I Add node_modules to Version Control?

No. node_modules should be ignored via .gitignore, only commit yarn.lock file.

---

## Related Resource Links

- Official Website: https://yarnpkg.com
- Official Documentation: https://yarnpkg.com/docs
- GitHub Repository: https://github.com/yarnpkg/berry
- Plugin List: https://yarnpkg.com/cli/plugin/list
- Discord Community: https://discord.gg/yarn
