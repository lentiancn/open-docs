# Nginx 使用指南

高效使用 Nginx 的完整指南。

---

## 目录

- [基本概念](#基本概念)
- [服务器块](#服务器块)
- [反向代理](#反向代理)
- [负载均衡](#负载均衡)
- [SSL/TLS](#ssltls)
- [性能优化](#性能优化)
- [常用示例](#常用示例)
- [故障排除](#故障排除)

---

## 基本概念

### 什么是 Nginx？

Nginx 是一个高性能的 HTTP 服务器和反向代理服务器。

### 关键术语

| 术语 | 说明 |
|------|------|
| Worker Process | 处理请求的工作进程 |
| Worker Connections | 每个进程的并发连接数 |
| Server Block | 虚拟主机配置 |
| Location | URL 路径匹配 |
| Upstream | 后端服务器组 |

### 关键文件和目录

| 路径 | 说明 |
|------|------|
| `/etc/nginx/nginx.conf` | 主配置 |
| `/etc/nginx/sites-available/` | 可用站点 |
| `/etc/nginx/sites-enabled/` | 启用的站点 |
| `/var/log/nginx/` | 日志文件 |
| `/usr/share/nginx/html/` | 默认文档根目录 |

---

## 服务器块

### 基础服务器块

```nginx
server {
    listen 80;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 多域名

```nginx
# example.com
server {
    listen 80;
    server_name example.com;
    root /var/www/example.com;
}

# another.com
server {
    listen 80;
    server_name another.com;
    root /var/www/another.com;
}
```

### 重定向

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# www 重定向到非 www
server {
    listen 80;
    server_name www.example.com;
    return 301 $scheme://example.com$request_uri;
}
```

---

## 反向代理

### 基础代理

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 支持 WebSocket

```nginx
location /ws/ {
    proxy_pass http://localhost:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}
```

---

## 负载均衡

### 基础负载均衡

```nginx
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### 负载均衡方法

```nginx
# 轮询（默认）
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
}

# 最少连接
upstream backend {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
}

# IP 哈希（会话保持）
upstream backend {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
}

# 加权
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com weight=1;
}
```

---

## SSL/TLS

### 生成自签名证书

```bash
# 生成私钥
openssl genrsa -out key.pem 2048

# 生成 CSR
openssl req -new -key key.pem -out csr.pem

# 生成自签名证书
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.pem
```

### SSL 配置

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # 安全设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        root /var/www/html;
    }
}
```

### Let's Encrypt（自动续期）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d example.com -d www.example.com

# 测试自动续期
sudo certbot renew --dry-run
```

---

## 性能优化

### Gzip 压缩

```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
```

### 浏览器缓存

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```

### Worker 优化

```nginx
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}
```

---

## 常用示例

### 静态文件服务器

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;
    autoindex on;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### PHP-FPM

```nginx
server {
    listen 80;
    server_name php.example.com;

    root /var/www/php;
    index index.php index.html;

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### Node.js 后端

```nginx
server {
    listen 80;
    server_name node.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 故障排除

### 查看日志

```bash
# 错误日志
tail -f /var/log/nginx/error.log

# 访问日志
tail -f /var/log/nginx/access.log
```

### 常见错误

| 错误 | 解决方案 |
|------|----------|
| 403 Forbidden | 检查文件权限，添加 index 文件 |
| 404 Not Found | 检查根路径和文件是否存在 |
| 502 Bad Gateway | 检查后端是否运行 |
| 504 Gateway Timeout | 增加代理超时时间 |

### 测试配置

```bash
# 测试配置语法
nginx -t
```

---

## 下一步

- 探索 [Nginx 模块](https://nginx.org/en/docs/)
- 学习 [Nginx Plus](https://www.nginx.com/products/nginx/)
