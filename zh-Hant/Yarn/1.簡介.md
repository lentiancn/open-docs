# Yarn 🧶

## 什麼是 Yarn？

Yarn 是一個功能強大的**套件管理器**，由 Facebook（現 Meta）開發並維護。它專為現代 JavaScript 開發者提供更快、更可靠、更安全的依賴管理體驗。無論你是開發簡單的個人項目，還是管理複雜的企業級 monorepo，Yarn 都能為你提供出色的支持。

Yarn 最初於 2016 年發布，旨在解決當時 npm 的一些痛點問題，如安裝速度慢、依賴版本不確定等。經過多年發展，Yarn 已經從一個單純的套件管理器演變成完整的 JavaScript 項目管理工具，提供了工作區（Workspaces）、插件系統、Zero-Installs 等眾多強大功能。

### Yarn 的核心設計理念

**速度優先**：Yarn 採用並行下載和智慧緩存機制，能夠顯著提升依賴安裝速度。在大多數場景下，Yarn 的安裝速度比 npm 快數倍。

**確定性保証**：Yarn 透過 yarn.lock 檔案精確記錄每個依賴及其嵌套依賴的确切版本，確保在不同機器、不同時間點進行的安裝操作能夠得到完全一致的結果。

**安全性增強**：Yarn 在安裝過程中會驗證每個包的校驗和，確保下載的包與預期完全一致，防止供應鏈攻擊和安全威脅。

**開發者體驗**：Yarn 注重開發者的使用體驗，提供了清晰的命令行輸出、交互式更新、豐富的提示資訊等功能。

### Yarn 與其他套件管理器的對比

在 JavaScript 生態系統中，主要有 npm、Yarn 和 pnpm 三種主流的套件管理器：

**與 npm 的對比**：npm 是 Node.js 官方的套件管理器，擁有最大的用戶基礎和最豐富的生態。Yarn 在速度、確定性和離線支持方面優於 npm。

**與 pnpm 的對比**：pnpm 採用獨特的符號鏈接策略，能夠更高效地管理磁碟空間。Yarn 在功能豐富度和社區支持方面略有優勢。

### Yarn 版本體系

Yarn 目前有兩個主要版本分支：

**Yarn 1.x（經典版）**：也稱為 Yarn Classic，是最初發布的版本，目前仍在維護但已不再添加新功能。

**Yarn 2.x 及以上（Berry）**：完全重寫的版本，採用新的架構設計，提供了 PnP（Plug'n'Play）模式、更強大的插件系統等高級功能。Yarn 4.x 是當前的穩定版本。

### 適用人群和場景

Yarn 適用於各種規模的 JavaScript 項目：

**個人開發者**：Yarn 的快速安裝和清晰的命令行輸出能夠顯著提升開發體驗。

**開源項目維護者**：Yarn 的工作區功能使得管理多包項目變得轻而易举。

**企業開發團隊**：Yarn 的確定性和安全性尤為重要，yarn.lock 確保團隊成員使用完全一致的依賴版本。

---

## Yarn 的主要功能特性

### 工作區（Workspaces）

工作區是 Yarn 最具創新性的功能之一，允許你在一個程式碼儲存庫中管理多個相關的套件。這個概念源於 Lerna 等工具，但 Yarn 是第一個將其原生整合到核心的套件管理器。

### 離線緩存機制

Yarn 的離線緩存是其最受歡迎的功能之一。當你首次安裝某個包時，Yarn 會將其緩存到本地。此後無論是重新安裝還是新項目需要同一版本，Yarn 都可以直接從緩存獲取，無需重新下載。

### 並行安裝

與 npm 的串行安裝不同，Yarn 預設使用並行安裝策略，同時下載多個包。這種設計能夠充分利用網絡頻寬，顯著縮短安裝時間。

### 硬化模式（Hardened Mode）

硬化模式是 Yarn 為企業級應用設計的安全特性。當啟用此模式後，如果安裝過程中檢測到任何會修改 yarn.lock 檔案的操作，Yarn 會立即報錯並退出。

### Zero-Installs（零安裝）

Zero-Installs 是 Yarn 4.x 引入的革命性功能。傳統上，每次克隆項目或切換分支後都需要運行 yarn install 來安裝依賴，這個過程在大項目中可能耗時數分鐘。

### 插件系統

Yarn 的插件系統允許開發者擴展和自定義 Yarn 的功能。官方提供了多種插件，覆蓋了打包、發布、版本管理等場景。

### 交互式更新

Yarn 提供了交互式更新模式（yarn up -i），可以讓你在終端中直觀地選擇要更新的包及其版本。

---

## 快速開始

### 環境準備

在安裝 Yarn 之前，請確保你的系統滿足以下要求：

**Node.js 版本要求**：

- Yarn 4.x 需要 Node.js 16.0.0 或更高版本
- Yarn 3.x 需要 Node.js 14.0.0 或更高版本
- Yarn 1.x 需要 Node.js 8.0.0 或更高版本

推薦使用 Node.js 18 LTS 或 20 LTS 版本。

### 安裝 Yarn

#### 方法一：使用 Corepack（推薦）

Corepack 是 Node.js 14.6.0 及以上版本內置的套件管理器管理器：

```bash
corepack enable
corepack prepare yarn@stable --activate
```

#### 方法二：使用 npm 全局安裝

```bash
npm install -g yarn
```

#### 方法三：使用腳本安裝（macOS/Linux）

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash
```

#### 方法四：使用 PowerShell 安裝（Windows）

```powershell
iwr -useb https://yarnpkg.com/install.ps1 | iex
```

### 驗證安裝

```bash
yarn --version
```

### 初始化新項目

```bash
yarn init -2
```

### 安裝項目依賴

```bash
yarn install
```

---

## 常用命令詳解

### 添加依賴

```bash
# 添加運行時依賴
yarn add lodash

# 添加開發依賴
yarn add -D typescript

# 添加特定版本
yarn add lodash@4.17.21
```

### 移除依賴

```bash
yarn remove lodash
```

### 更新依賴

```bash
yarn up lodash
yarn up --all
```

### 運行腳本

```bash
yarn dev
yarn build
yarn test
```

### 查看依賴

```bash
yarn list
yarn outdated
yarn info lodash
yarn why lodash
```

---

## 工作區（Workspaces）完全指南

### 配置工作區

在根 package.json 中添加 workspaces 欄位：

```json
{
  "name": "my-monorepo",
  "private": true,
  "workspaces": [
    "packages/*"
  ]
}
```

### 工作區命令

```bash
# 在特定工作區添加依賴
yarn workspace @my-org/core add lodash

# 在所有工作區運行命令
yarn workspaces foreach -pt run build

# 聚焦安裝
yarn workspaces focus @my-org/app
```

### 工作區間依賴

使用 workspace: 協議：

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:^"
  }
}
```

---

## 配置文件詳解

### .yarnrc.yml 配置

Yarn 4.x 使用 YAML 格式的配置文件：

```yaml
npmRegistryServer: "https://registry.npmjs.org"
enableGlobalCache: false
nodeLinker: node-modules
enableScripts: true
```

---

## 插件系統

### 安裝插件

```bash
# 從官方插件列表安裝
yarn plugin import @yarnpkg/plugin-github
```

### 移除插件

```bash
yarn plugin remove @yarnpkg/plugin-github
```

---

## 最佳實踐

### 1. 版本控制最佳實踐

始終將 yarn.lock 提交到版本控制系統。

### 2. CI/CD 集成建議

在 CI 環境中使用硬化模式：

```bash
yarn install --immutable
```

### 3. 依賴更新策略

定期運行 yarn up 保持依賴更新。

### 4. 性能優化

使用工作區集中管理依賴，利用聚焦安裝減少大型項目的安裝時間。

### 5. 安全建議

定期運行安全審計：yarn npm audit

---

## 常見問題解答

### Yarn 與 npm 的區別？

- 速度：Yarn 使用並行下載，通常比 npm 更快
- 確定性：Yarn 的 yarn.lock 確保每次安裝結果一致
- 離線支持：Yarn 有強大的離線緩存功能
- 工作區：Yarn 原生支持 monorepo 工作區

### 安裝失敗怎麼辦？

1. 檢查 Node.js 版本
2. 清理 npm 緩存：npm cache clean --force
3. 使用官方推薦的安裝方式

### yarn.lock 的作用是什麼？

yarn.lock 記錄了所有依賴的确切版本，確保每次安裝結果完全一致。

### 應該將 node_modules 加入版本控制嗎？

不應該。node_modules 應該通過 .gitignore 忽略，只提交 yarn.lock 檔案。

---

## 相關資源鏈接

- 官方網站：https://yarnpkg.com
- 官方文檔：https://yarnpkg.com/docs
- GitHub 倉庫：https://github.com/yarnpkg/berry
- Discord 社區：https://discord.gg/yarn
