# Kubernetes 安装指南

本指南将帮助你在各种环境中安装 Kubernetes。

## 环境要求

| 配置 | 最低 | 推荐 |
|------|------|------|
| CPU | 2 核 | 4 核+ |
| 内存 | 2 GB | 8 GB+ |
| 磁盘 | 20 GB | 50 GB+ |

## Minikube（本地开发）

### 安装

```bash
# macOS
brew install minikube

# Linux
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Windows
choco install minikube
```

### 启动集群

```bash
# 启动
minikube start

# 指定资源
minikube start --cpus 4 --memory 8192

# 使用 Docker 驱动
minikube start --driver=docker

# 使用 Kubernetes 版本
minikube start --kubernetes-version=v1.28.0
```

### 管理集群

```bash
# 查看状态
minikube status

# 停止集群
minikube stop

# 删除集群
minikube delete

# 访问 Dashboard
minikube dashboard
```

## kubeadm（生产环境）

### 安装

```bash
# Ubuntu/Debian
apt-get update
apt-get install -y apt-transport-https ca-certificates curl

# 添加阿里云镜像
curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -

cat <<EOF > /etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF

apt-get update
apt-get install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl
```

### 初始化集群

```bash
# 主节点初始化
kubeadm init --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12

# 配置 kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### 添加节点

```bash
# 在主节点获取 join 命令
kubeadm token create --print-join-command

# 在从节点执行
kubeadm join <master-ip>:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash>
```

### 安装网络插件

```bash
# Calico
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

# Flannel
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

## Docker Desktop（macOS/Windows）

### 安装

1. 下载 Docker Desktop：https://www.docker.com/products/docker-desktop
2. 启用 Kubernetes：
   - 打开 Docker Desktop 设置
   - 启用 Kubernetes
   - 点击 Apply & Restart

### 验证

```bash
kubectl config get-contexts
kubectl config use-context docker-desktop
kubectl get nodes
```

## Kind（本地测试）

### 安装

```bash
# macOS
brew install kind

# Linux
curl -Lo /usr/local/bin/kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
chmod +x /usr/local/bin/kind

# Windows
choco install kind
```

### 创建集群

```bash
# 创建集群
kind create cluster

# 指定配置
kind create cluster --name mycluster

# 使用配置文件
kind create cluster --config kind-config.yaml
```

```yaml
# kind-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
```

## kubectl 安装

### macOS

```bash
brew install kubectl

# 或
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/darwin/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
```

### Linux

```bash
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/kubectl
```

### Windows

```bash
choco install kubernetes-cli

# 或下载二进制
curl -LO https://dl.k8s.io/release/v1.28.0/bin/windows/amd64/kubectl.exe
```

## Helm 安装

### 包管理器

```bash
# macOS
brew install helm

# Linux
curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Windows
choco install kubernetes-helm
```

### 基本使用

```bash
# 添加仓库
helm repo add stable https://charts.helm.sh/stable
helm repo update

# 安装 Chart
helm install myrelease stable/nginx-ingress

# 升级
helm upgrade myrelease stable/nginx-ingress

# 卸载
helm uninstall myrelease
```

## Rancher（可视化）

### Docker 安装

```bash
docker run -d --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  --privileged \
  rancher/rancher
```

### Kubernetes 安装

```bash
# 安装 RKE
brew install rke

# 创建集群
rke up

# 集群配置
rke config
```

## 常用命令

```bash
# 查看集群信息
kubectl cluster-info
kubectl get nodes
kubectl get pods -A

# 查看资源
kubectl get pods
kubectl get services
kubectl get deployments

# 创建资源
kubectl apply -f deployment.yaml

# 删除资源
kubectl delete -f deployment.yaml

# 查看日志
kubectl logs -f podname

# 进入容器
kubectl exec -it podname -- /bin/bash
```

## 配置 kubeconfig

```bash
# 查看当前配置
kubectl config view

# 切换上下文
kubectl config use-context context-name

# 添加集群
kubectl config set-cluster cluster-name --server=https://127.0.0.1:6443 --certificate-authority=/path/to/ca.crt

# 添加凭据
kubectl config set-credentials user --token=bearer-token

# 添加上下文
kubectl config set-context context-name --cluster=cluster-name --user=user
```

## 常见问题

### Q1: 节点 NotReady

**解决方案：**
```bash
# 检查节点状态
kubectl get nodes
kubectl describe node nodename

# 检查 kubelet 状态
systemctl status kubelet
journalctl -u kubelet -n 50
```

### Q2: Pod 无法启动

**解决方案：**
```bash
# 查看 Pod 状态
kubectl get pods
kubectl describe pod podname

# 查看日志
kubectl logs podname
```

### Q3: 网络问题

**解决方案：**
```bash
# 检查网络插件
kubectl get pods -n kube-system

# 重置网络
kubeadm reset
```

## 下一步

- [Kubernetes 使用手册](./3.使用手册.md) - 学习 Kubernetes 使用
- [Kubernetes 常见问题](./4.常见问题.md) - 解答常见问题
- 官方文档：https://kubernetes.io/docs/
