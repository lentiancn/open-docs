# SadTalker Usage Guide

SadTalker generates realistic talking head videos from a single image and audio input using deep learning.

## Quick Start

### Basic Command

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### Generate Video with Enhancement

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## Command Line Parameters

### Input Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--source_image` | Input portrait image path | Required |
| `--driven_audio` | Input audio file path (WAV/MP3) | Required |
| `--result_dir` | Output directory | ./results |

### Processing Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--preprocess` | Image preprocessing: crop, resize, full | full |
| `--size` | Image size: 256, 512 | 256 |
| `--pose_style` | Pose style 0-45 | 0 |
| `--expression_scale` | Expression intensity 0.5-1.5 | 1.0 |

### Enhancement Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--enhancer` | Face enhancer: gfpgan, RestoreFormer, CodeFormer | None |
| `--enhancer_background` | Enhance background | False |

### Performance Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--batch_size` | Batch size for processing | 1 |
| `--fps` | Output video FPS | 25 |
| `--faceid` | Keep face identity | False |

### Other Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--help` | Show all options | - |

## Usage Examples

### Example 1: Basic Generation

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### Example 2: With GFPGAN Enhancement

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### Example 3: Custom Pose Style

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### Example 4: Higher Resolution

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### Basic Usage

```python
from inference import SadTalker

# Initialize SadTalker
sadtalker = SadTalker()

# Generate video
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"Video saved to: {video_path}")
```

### Advanced Usage

```python
from inference import SadTalker
import torch

# Initialize with custom settings
sadtalker = SadTalker(
    checkpoint_path="checkpoints/SadTalker.pth",
    config_path="config/SadTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Generate with advanced options
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### Batch Processing

```python
from inference import SadTalker
import os

sadtalker = SadTalker()

# Process multiple images with same audio
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        sadtalker.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Web Interface

### Running Web Demo

```bash
python app.py
```

Then open browser at http://localhost:8888

### Web Interface Features

1. **Image Upload**: Drag and drop or select portrait image
2. **Audio Upload**: Select audio file (WAV/MP3)
3. **Preview**: Preview source image and audio
4. **Parameters**: Adjust pose, expression, enhancer
5. **Generate**: Create video with one click
6. **Download**: Save generated video

### Web Interface Controls

| Control | Description |
|--------|-------------|
| Source Image | Upload portrait photo |
| Driven Audio | Upload speech audio |
| Preprocess | Choose preprocessing mode |
| Pose Style | Select pose animation style |
| Enhancer | Select face quality enhancer |
| Generate Button | Start video generation |

## Face Enhancers

### Available Enhancers

| Enhancer | Quality | Speed | VRAM |
|----------|---------|-------|------|
| None | Basic | Fast | Low |
| gfpgan | Good | Medium | Medium |
| RestoreFormer | Very Good | Slow | High |
| CodeFormer | Very Good | Slow | High |

### Recommendation

- **Low VRAM**: No enhancer or gfpgan
- **Balanced**: gfpgan
- **Best Quality**: RestoreFormer or CodeFormer

## Preprocessing Modes

| Mode | Description | Use Case |
|------|-------------|---------|
| crop | Center crop face | Fast processing |
| resize | Resize to target | Simple backgrounds |
| full | Full pipeline | Best results |

## Input Requirements

### Image Requirements

- Format: JPG, PNG
- Size: 512x512 or larger recommended
- Face: Front-facing, clear features
- Background: Simple preferred

### Audio Requirements

- Format: WAV, MP3
- Duration: 1-60 seconds
- Sample Rate: 16000-48000 Hz
- Speech: Clear audio with minimal noise

## Output

### Video Format

- Format: MP4
- Codec: H.264
- Resolution: 256x256 or 512x512
- FPS: 25
- Bitrate: 2-5 Mbps

### Output Directory

Results are saved in the specified result directory:
```
results/
├── video.mp4          # Generated video
├── video_idx.mp4     # With index (if multiple)
└── (temp files)
```

## Troubleshooting

### Video Too Dark/Bright

**Cause:** Lighting mismatch between training and input

**Solutions:**
- Adjust expression_scale parameter (0.8-1.2)
- Use better quality source image
- Try different enhancer

### Lips Not Synchronized

**Cause:** Audio quality or alignment issues

**Solutions:**
- Use high-quality audio
- Ensure audio has clear speech
- Check audio-video sync
- Trim audio to match video length

### Face Distortion

**Cause:** Low quality or unusual input

**Solutions:**
- Use higher resolution image (512)
- Try different preprocessing mode
- Use face enhancer
- Ensure face is clearly visible

### Slow Processing

**Solutions:**
- Reduce batch size
- Lower resolution (--size 256)
- Disable enhancer
- Use faster preprocessing (crop)

### GPU Out of Memory

**Solutions:**
- Reduce batch_size to 1
- Use smaller image size
- Close other GPU applications
- Enable CPU offloading

## Performance Tips

### Faster Processing

1. Use `--preprocess crop`
2. Set `--size 256`
3. Disable enhancer
4. Reduce batch size

### Better Quality

1. Use `--size 512`
2. Enable `--enhancer gfpgan`
3. Use `--preprocess full`
4. Adjust `--expression_scale`

### Save VRAM

1. Process one at a time
2. Use smaller models
3. Disable unnecessary features

## Integration Examples

### Python Flask API

```python
from flask import Flask, request, send_file
from inference import SadTalker
import tempfile

app = Flask(__name__)
sadtalker = SadTalker()

@app.route('/generate', methods=['POST'])
def generate():
    image = request.files['image']
    audio = request.files['audio']
    
    with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as img:
        image.save(img.name)
    
    with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as aud:
        audio.save(aud.name)
    
    video_path = sadtalker.generate(
        source_image=img.name,
        driven_audio=aud.name,
        preprocess="full"
    )
    
    return send_file(video_path, mimetype='video/mp4')
```

## Related Links

- [GitHub](https://github.com/OpenTalker/SadTalker)
- [HuggingFace](https://huggingface.co/spaces/fffilo/SadTalker)
- [Paper](https://arxiv.org/abs/2303.17550)
- [Models](https://github.com/OpenTalker/SadTalker/releases)
