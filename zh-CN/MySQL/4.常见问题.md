# MySQL 常见问题

本章节汇总了 MySQL 使用中的常见问题。

## 连接问题

### Q1: 连接被拒绝

**问题描述：**
`Can't connect to MySQL server`

**解决方案：**
1. 检查 MySQL 服务是否启动
   ```bash
   systemctl status mysql
   ```

2. 检查端口是否正确
   ```bash
   netstat -ano | findstr :3306
   ```

3. 检查防火墙

### Q2: 权限问题

**问题描述：**
`Access denied for user`

**解决方案：**
```sql
-- 授权远程访问
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password';
FLUSH PRIVILEGES;
```

## 性能问题

### Q3: 查询慢

**解决方案：**
1. 添加索引
   ```sql
   CREATE INDEX idx_column ON table_name(column);
   ```

2. 优化查询
   ```sql
   -- 避免 SELECT *
   SELECT id, name FROM users WHERE id = 1;
   
   -- 使用 LIMIT
   SELECT * FROM users LIMIT 10;
   ```

3. 使用 EXPLAIN 分析
   ```sql
   EXPLAIN SELECT * FROM users WHERE name = 'Tom';
   ```

### Q4: CPU 占用高

**解决方案：**
1. 查看慢查询日志
   ```sql
   SHOW VARIABLES LIKE 'slow_query_log%';
   ```

2. 优化复杂查询

3. 增加缓存

### Q5: 内存占用高

**解决方案：**
调整 InnoDB 缓冲池大小：
```sql
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
```

## 数据问题

### Q6: 中文乱码

**解决方案：**
1. 创建数据库时指定字符集
   ```sql
   CREATE DATABASE myapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

2. 连接时指定字符集
   ```sql
   SET NAMES 'utf8mb4';
   ```

3. 检查表字符集
   ```sql
   SHOW CREATE TABLE users;
   ```

### Q7: 主键冲突

**问题描述：**
`Duplicate entry 'xxx' for key 'PRIMARY'`

**解决方案：**
1. 检查插入数据的主键
2. 使用 INSERT IGNORE
3. 使用 ON DUPLICATE KEY UPDATE

### Q8: 外键约束失败

**解决方案：**
1. 先插入父表数据
2. 使用 SET FOREIGN_KEY_CHECKS = 0（临时）
3. 检查关联数据

## 备份问题

### Q9: 备份失败

**解决方案：**
```bash
# 检查磁盘空间
df -h

# 检查权限
ls -la /var/lib/mysql
```

### Q10: 恢复失败

**解决方案：**
1. 检查 SQL 文件编码
2. 确保目标数据库存在
3. 检查权限

## 锁问题

### Q11: 表锁

**问题描述：**
`Table 'xxx' is locked`

**解决方案：**
```sql
-- 查看锁表进程
SHOW PROCESSLIST;

-- 杀死进程
KILL process_id;
```

### Q12: 死锁

**解决方案：**
1. 调整事务顺序
2. 使用更小的事务
3. 添加索引

## 复制问题

### Q13: 主从不同步

**解决方案：**
1. 查看从节点状态
   ```sql
   SHOW SLAVE STATUS\G
   ```

2. 跳过错误
   ```sql
   STOP SLAVE;
   SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1;
   START SLAVE;
   ```

## 迁移问题

### Q14: 数据迁移

**解决方案：**
1. 使用 mysqldump 导出
   ```bash
   mysqldump -u root -p source_db > backup.sql
   ```

2. 导入目标数据库
   ```bash
   mysql -u root -p target_db < backup.sql
   ```

### Q15: 版本升级

**解决方案：**
1. 备份数据
2. 升级 MySQL 版本
3. 运行 mysql_upgrade

## 安全问题

### Q16: 忘记 root 密码

**解决方案：**
```bash
# 停止 MySQL
sudo systemctl stop mysql

# 跳过权限表启动
sudo mysqld_safe --skip-grant-tables &

# 登录并修改密码
mysql -u root
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';

# 重启 MySQL
sudo systemctl restart mysql
```

## 配置问题

### Q17: 最大连接数

**解决方案：**
```sql
-- 查看当前连接数
SHOW VARIABLES LIKE 'max_connections';

-- 设置最大连接数
SET GLOBAL max_connections = 200;
```

### Q18: 时区问题

**解决方案：**
```sql
-- 设置时区
SET GLOBAL time_zone = '+8:00';

-- 查看时区
SELECT NOW(), @@global.time_zone;
```

## 总结

本章节涵盖了 MySQL 使用中的常见问题：

- **连接**：权限、拒绝
- **性能**：查询、CPU、内存
- **数据**：乱码、主键、外键
- **备份**：失败、恢复
- **锁**：表锁、死锁
- **复制**：主从不一致
- **迁移**：数据、版本升级
- **安全**：密码重置
- **配置**：连接数、时区

如需更多信息，请参考官方文档：https://dev.mysql.com/doc/refman/8.0/en/
