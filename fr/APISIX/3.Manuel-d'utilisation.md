# Manuel d'utilisation d'Apache APISIX

## Concepts de Base

### Route

Définit le mappage entre les chemins de requête et les services upstream.

### Upstream

Groupe de nœuds fournissant le même service.

### Consumer

Utilisateur de l'API qui doit s'authentifier.

## Démarrage

### Créer une Route

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "ma-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"httpbin.org:80": 1}
  }
}'
```

### Vérifier

```bash
curl "http://127.0.0.1:9080/ip"
```

## Équilibrage de Charge

### Round Robin Pondéré

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"service-a:8080": 3, "service-b:8080": 1}
  }
}'
```

## Authentification

### Clé API

**Créer un Consumer:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "utilisateur1",
  "plugins": {"key-auth": {"key": "ma-cle-secrete"}}
}'
```

**Activer sur la Route:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/ma-route" -X PATCH -d '
{"plugins": {"key-auth": {}}}
'
```

**Accéder avec la Clé:**

```bash
curl "http://127.0.0.1:9080/ip" -H "apikey: ma-cle-secrete"
```

## Limitation de Débit

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/ma-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

## Monitoring

### Prometheus

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {"prometheus": {}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

Obtenir les métriques:

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

## Commandes

### Lister les Routes

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### Supprimer une Route

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/ma-route" -X DELETE
```

## Bonnes Pratiques

1. Changer la clé API en production
2. Utiliser HTTPS
3. Activer les health checks
4. Configurer des limites raisonables
