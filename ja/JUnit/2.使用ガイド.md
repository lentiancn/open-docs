# JUnit 使用ガイド

このガイドでは、JUnit 5（Jupiter）を使用して効果的なユニットテストを作成方法について説明します。

## 基本的なテスト構造

### 単純なテストクラス

```java
package com.example;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class MyFirstTest {
    
    @Test
    void simpleTest() {
        // 準備 - テストデータを設定
        int a = 1;
        int b = 2;
        
        // 実行 - アクションを実行
        int result = a + b;
        
        // アサーション - 結果を検証
        assertEquals(3, result);
    }
    
    @Test
    void anotherTest() {
        assertEquals(4, 2 + 2, "オプションのアサーションメッセージ");
    }
}
```

### テストファイルの場所

```
src/
├── main/
│   └── java/
│       └── com/example/
│           └── Calculator.java
└── test/
    └── java/
        └── com/example/
            └── CalculatorTest.java
```

## アサーション

JUnit 5は`org.junit.jupiter.api.Assertions`に包括的なアサーションAPIを提供します。

### 一般的なアサーション

```java
import static org.junit.jupiter.api.Assertions.*;

// 等価アサーション
@Test
void equalityTests() {
    assertEquals(expected, actual);
    assertEquals(expected, actual, "メッセージ");
    assertEquals(expected, actual, () -> "レイジーメッセージ");
    
    // 浮動小数点数のdelta
    assertEquals(0.01, 3.5, 0.1);
    
    // 等しくない
    assertNotEquals(expected, actual);
}

// ブールアサーション
@Test
void booleanTests() {
    assertTrue(condition);
    assertTrue(condition, "メッセージ");
    assertTrue(() -> condition, () -> "レイジーメッセージ");
    
    assertFalse(condition);
}

// Nullアサーション
@Test
void nullTests() {
    assertNull(object);
    assertNotNull(object);
    
    // 同一性
    assertSame(obj1, obj2);
    assertNotSame(obj1, obj2);
}

// 配列アサーション
@Test
void arrayTests() {
    assertArrayEquals(expectedArray, actualArray);
    assertArrayEquals(expectedArray, actualArray, "メッセージ");
}

// 例外アサーション
@Test
void exceptionTests() {
    // 例外がスローされることをアサート
    assertThrows(RuntimeException.class, () -> {
        throw new RuntimeException("テスト例外");
    });
    
    // 例外メッセージをアサート
    Exception exception = assertThrows(IllegalArgumentException.class, () -> {
        throw new IllegalArgumentException("無効な入力");
    });
    assertEquals("無効な入力", exception.getMessage());
    
    // 例外がスローされないことをアサート
    assertDoesNotThrow(() -> {
        // 例外をスローしないコード
    });
}

// 組み合わせアサーション
@Test
void combinedAssertions() {
    // 複数のアサーションを実行
    assertAll("ユーザー検証",
        () -> assertNotNull(user),
        () -> assertEquals("John", user.getName()),
        () -> assertTrue(user.getAge() >= 18)
    );
}
```

### AssertJスタイルのソフトアサーション

```java
@Test
void softAssertionsTest() {
    SoftAssertions softly = new SoftAssertions();
    
    softly.assertThat(user.getName()).isEqualTo("John");
    softly.assertThat(user.getAge()).isGreaterThan(18);
    softly.assertThat(user.getEmail()).contains("@");
    
    softly.assertAll();
}
```

### カスタムアサーション

```java
@Test
void customAssertion() {
    assertTrue(isValidEmail(email), "無効なメール形式");
}

private boolean isValidEmail(String email) {
    return email != null && email.matches("^[A-Za-z0-9+_.-]+@.+$");
}
```

## テストライフサイクル

### BeforeとAfterメソッド

```java
class LifecycleTest {
    
    @BeforeAll
    static void beforeAll() {
        // すべてのテストメソッドの前に1回実行
        // 通常クラスではstaticである必要がある
        System.out.println("Before All Tests");
    }
    
    @AfterAll
    static void afterAll() {
        // すべてのテストメソッドの後に1回実行
        System.out.println("After All Tests");
    }
    
    @BeforeEach
    void beforeEach() {
        // 各テストメソッドの前に実行
        System.out.println("Before Each Test");
    }
    
    @AfterEach
    void afterEach() {
        // 各テストメソッドの後に実行
        System.out.println("After Each Test");
    }
    
    @Test
    void test1() {
        System.out.println("Test 1");
    }
    
    @Test
    void test2() {
        System.out.println("Test 2");
    }
}
```

### クラスごとのライフサイクル

```java
@TestInstance(Lifecycle.PER_CLASS)
class PerClassTest {
    
    private String resource;
    
    @BeforeAll
    void beforeAll() {
        // PER_CLASSでは非staticメソッドを使用可能
        resource = "initialized";
    }
    
    @Test
    void test1() {
        assertNotNull(resource);
    }
    
    @Test
    void test2() {
        assertNotNull(resource);
    }
}
```

## ネストされたテスト

### 基本的なネストされたテスト

```java
@Nested
class NestedTests {
    
    @Test
    void parentTest() {
        assertTrue(true);
    }
    
    @Nested
    class InnerClass {
        
        @Test
        void innerTest() {
            assertTrue(true);
        }
        
        @Nested
        class DeepNested {
            
            @Test
            void deepNestedTest() {
                assertTrue(true);
            }
        }
    }
}
```

### 共有状態を持つネストされたテスト

```java
@Nested
class CalculatorTests {
    
    private Calculator calculator;
    
    @BeforeEach
    void setUp() {
        calculator = new Calculator();
    }
    
    @Nested
    class AdditionTests {
        
        @Test
        void testPositiveNumbers() {
            assertEquals(5, calculator.add(2, 3));
        }
        
        @Test
        void testNegativeNumbers() {
            assertEquals(-1, calculator.add(-2, 1));
        }
    }
    
    @Nested
    class DivisionTests {
        
        @Test
        void testNormalDivision() {
            assertEquals(2, calculator.divide(6, 3));
        }
        
        @Test
        void testDivisionByZero() {
            assertThrows(ArithmeticException.class, 
                () -> calculator.divide(1, 0));
        }
    }
}
```

## パラメータ化テスト

### 値ソース

```java
@ParameterizedTest
@ValueSource(ints = {1, 2, 3, 4, 5})
void isEven(int number) {
    assertTrue(number % 2 == 0, number + " should be even");
}

@ParameterizedTest
@ValueSource(strings = {"Hello", "World", "JUnit"})
void stringTests(String value) {
    assertNotNull(value);
    assertTrue(value.length() > 0);
}
```

### CSVソース

```java
@ParameterizedTest
@CsvSource({
    "1, 1, 2",
    "2, 3, 5",
    "10, 20, 30",
    "-1, -1, -2"
})
void addTest(int a, int b, int expected) {
    Calculator calc = new Calculator();
    assertEquals(expected, calc.add(a, b));
}

@ParameterizedTest
@CsvSource(value = {
    "admin@example.com, true",
    "user@example.com, true",
    "invalid, false"
})
void emailValidationTest(String email, boolean expected) {
    assertEquals(expected, isValidEmail(email));
}
```

### メソッドソース

```java
@ParameterizedTest
@MethodSource("provideArguments")
void methodSourceTest(String arg1, int arg2, boolean expected) {
    assertEquals(expected, arg1.length() == arg2);
}

static Stream<Arguments> provideArguments() {
    return Stream.of(
        Arguments.of("test", 4, true),
        Arguments.of("hello", 5, true),
        Arguments.of("ab", 3, false)
    );
}
```

### 列挙ソース

```java
@ParameterizedTest
@EnumSource(Month.class)
void monthTest(Month month) {
    assertNotNull(month);
}

@ParameterizedTest
@EnumSource(value = Month.class, names = {"JANUARY", "MARCH", "MAY", "JULY"})
void selectMonthsTest(Month month) {
    assertTrue(month.getValue() % 2 == 1);
}
```

### Nullと空ソース

```java
@ParameterizedTest
@NullSource
void nullTest(String input) {
    assertNull(input);
}

@ParameterizedTest
@EmptySource
void emptyTest(String input) {
    assertTrue(input.isEmpty());
}

@ParameterizedTest
@NullAndEmptySource
void nullAndEmptyTest(String input) {
    assertTrue(input == null || input.isEmpty());
}
```

## 反復テスト

```java
@RepeatedTest(10)
void repeatedTest(RepetitionInfo repetitionInfo) {
    System.out.println("Repetition " + 
        repetitionInfo.getCurrentRepetition());
    assertTrue(true);
}

@RepeatedTest(value = 5, name = "{displayName} - {currentRepetition}/{totalRepetitions}")
void customRepeatedTest() {
    assertTrue(true);
}
```

## テストの無効化

```java
@Disabled("まだ準備ができていません")
@Test
void disabledTest() {
    // 実行されません
}

@Test
void conditionalTest() {
    assumeTrue(System.getProperty("os.name").contains("Windows"));
    // Windowsでのみ実行
}

@DisabledOnOs(OS.LINUX)
@Test
void notOnLinux() {
    // Linuxでは実行されません
}

@DisabledOnJre(JRE.JAVA_8)
@Test
void notOnJava8() {
    // Java 8では実行されません
}

@EnabledIfSystemProperty(named = "ENV", matches = "prod")
@Test
void onlyInProduction() {
    // -DENV=prodでのみ実行
}
```

## テストインターフェース

### インターフェースのデフォルトメソッド

```java
interface TestInterface {
    
    @BeforeEach
    default void setUp() {
        System.out.println("Interface setup");
    }
    
    @Test
    default void commonTest() {
        assertTrue(true);
    }
}

class InterfaceTest implements TestInterface {
    
    @Test
    void ownTest() {
        assertTrue(true);
    }
}
```

### デフォルトメソッドで共有テスト

```java
interface CalculatorTests {
    
    Calculator getCalculator();
    
    @Test
    default void testAddition() {
        assertEquals(4, getCalculator().add(2, 2));
    }
    
    @Test
    default void double subtraction() {
        assertEquals(0, getCalculator().subtract(2, 2));
    }
}

class BasicCalculatorTest implements CalculatorTests {
    
    private Calculator calculator = new BasicCalculator();
    
    @Override
    public Calculator getCalculator() {
        return calculator;
    }
}
```

## Mockitoでのモック

### 基本的なMockito

```java
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testGetUserById() {
        // 準備
        User mockUser = new User(1L, "John");
        when(userRepository.findById(1L)).thenReturn(Optional.of(mockUser));
        
        // 実行
        User result = userService.getUserById(1L);
        
        // アサーション
        assertNotNull(result);
        assertEquals("John", result.getName());
        verify(userRepository).findById(1L);
    }
    
    @Test
    void testSaveUser() {
        // 準備
        User user = new User("John", "john@example.com");
        when(userRepository.save(any(User.class))).thenReturn(user);
        
        // 実行
        User saved = userService.saveUser(user);
        
        // アサーション
        assertNotNull(saved);
        verify(userRepository).save(user);
    }
}
```

### 引数マッチャー

```java
@Test
void argumentMatchersTest() {
    // 任意のマッチャー
    when(userRepository.findById(any())).thenReturn(user);
    
    // 特定のマッチャー
    when(userRepository.findByName(contains("John"))).thenReturn(user);
    
    // 引数キャプチャ
    ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
    userService.saveUser(user);
    verify(userRepository).save(captor.capture());
    assertEquals("John", captor.getValue().getName());
}
```

### Mockitoアノテーション

```java
@ExtendWith(MockitoExtension.class)
class DetailedMockitoTest {
    
    @Mock
    private List<String> mockedList;
    
    @InjectMocks
    private Service service;
    
    @BeforeEach
    void init() {
        MockitoAnnotations.openMocks(this);
    }
    
    @Test
    void testMocking() {
        mockedList.add("one");
        verify(mockedList).add("one");
        assertEquals(1, mockedList.size());
    }
}
```

## Spring Bootテスト

### ユニットテスト

```java
@SpringBootTest
class MyServiceIntegrationTest {
    
    @Autowired
    private MyService myService;
    
    @Test
    void testService() {
        String result = myService.doSomething();
        assertNotNull(result);
    }
}
```

### Web層テスト

```java
@WebMvcTest(MyController.class)
class MyControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private MyService myService;
    
    @Test
    void testEndpoint() throws Exception {
        when(myService.getData()).thenReturn("test data");
        
        mockMvc.perform(get("/api/data"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$").value("test data"));
    }
}
```

### データ層テスト

```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testFindByName() {
        entityManager.persist(new User("John", "john@example.com"));
        
        User user = userRepository.findByName("John");
        
        assertNotNull(user);
        assertEquals("John", user.getName());
    }
}
```

### テスト構成

```java
@TestConfiguration
static class TestConfig {
    
    @Bean
    @Primary
    public MyService testMyService() {
        return mock(MyService.class);
    }
}

@SpringBootTest
class IntegrationTestWithConfig {
    
    @Autowired
    @Primary
    MyService myService;  // モックになります
    
    @Test
    void test() {
        // モックを使用
    }
}
```

## テスト実行

### テストの実行

```bash
# すべてのテストを実行
mvn test

# 特定のテストクラスを実行
mvn test -Dtest=MyTest

# 特定のテストメソッドを実行
mvn test -Dtest=MyTest#myMethod

# パターンに一致するテストを実行
mvn test -Dtest="*Test"

# Gradleで実行
./gradlew test

# Gradleで特定のテストを実行
./gradlew test --tests "com.example.MyTest"

# カバレッジ付きでテストを実行
mvn test jacoco:report
```

### テストカテゴリ

```java
interface SlowTests {}

interface FastTests {}

class MyTest implements FastTests {
    @Test
    void fastTest() {}
}

@Tag("slow")
class SlowTest {
    @Test
    void slowTest() {}
}
```

```bash
#  빠른テストのみを実行
mvn test -Dgroups=com.example.FastTests

# 遅いテストを除外
mvn test -DexcludedGroups=com.example.SlowTests
```

## ベストプラクティス

### テスト命名

```java
// 良い - シナリオを説明
@Test
void shouldReturnUserWhenValidIdProvided() {}

// 悪い - 不明確
@Test
void test1() {}
```

### テスト構造

```java
@Test
void shouldThrowExceptionWhenInvalidInput() {
    // 準備
    Validator validator = new Validator();
    
    // 実行とアサーション
    assertThrows(IllegalArgumentException.class, () -> {
        validator.validate(null);
    });
}
```

### テストの相互依存を避ける

```java
// 悪い - テストが相互に依存
static int counter = 0;

@Test
void test1() {
    counter++;
    assertEquals(1, counter);
}

@Test
void test2() {
    assertEquals(1, counter); // test1が先に実行されないと失敗
}

// 良い - 独立したテスト
@Test
void testAdd() {
    Calculator calc = new Calculator();
    assertEquals(5, calc.add(2, 3));
}

@Test
void testSubtract() {
    Calculator calc = new Calculator();
    assertEquals(1, calc.subtract(3, 2));
}
```

### 適切なアサーションを使用

```java
// 良い - 意図が明確
assertTrue(user.isAdult());

// あまり明確でない
assertEquals(true, user.isAdult());
```

### テストを速く保つ

```java
// 避ける - テストでの遅い操作
@Test
void slowTest() {
    Thread.sleep(1000); // これは避ける
}

// より良い - モックまたはテストダブルを使用
@Test
void fastTest() {
    when(slowService.getData()).thenReturn("test");
    // 待たずにロジックをテスト
}
```

## テストの整理

### パッケージ構造

```
src/test/java/
├── com/example/
│   ├── service/
│   │   ├── UserServiceTest.java
│   │   └── OrderServiceTest.java
│   ├── repository/
│   │   └── UserRepositoryTest.java
│   └── controller/
│       └── UserControllerTest.java
```

### テストクラス命名

| 本番クラス | テストクラス |
|-----------------|-----------|
| UserService | UserServiceTest |
| UserRepository | UserRepositoryTest |
| UserController | UserControllerTest |

## 関連リンク

- [JUnit 5公式ドキュメント](https://junit.org/junit5/docs/current/user/)
- [Mockitoドキュメント](https://site.mockito.org)
- [AssertJドキュメント](https://assertj.github.io)
- [Springテストドキュメント](https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html)
