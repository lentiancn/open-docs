# Apache APISIX 常見問題

## 基礎問題

### 1. 什麼是 Apache APISIX？

Apache APISIX 是一個雲端原生 API 閘道，由 Apache 軟體基金會管理。它提供動態、即時、高效能的 API 流量管理功能，包括負載均衡、動態路由、身份驗證、限流、監控等。

### 2. APISIX 和 Nginx 有什麼區別？

Nginx 是一個傳統的 Web 伺服器和反向代理，而 APISIX 是構建在 Nginx 之上的 API 閘道。

主要區別：
- **設定方式**：Nginx 需要修改設定檔並重啟，APISIX 支援熱更新無需重啟
- **功能擴展**：APISIX 提供豐富的內建插件，Nginx 需要自己編寫模組
- **動態能力**：APISIX 原生支援動態路由、動態上游等能力
- **可觀測性**：APISIX 內建 Prometheus、SkyWalking 等監控整合

### 3. APISIX 需要哪些依賴？

APISIX 主要依賴：
- **etcd**：用於儲存配置資料，實現叢集間的配置同步
- **Lua**：APISIX 使用 Lua 編寫插件邏輯
- **Nginx**：底層使用 Nginx 處理 HTTP 請求

如果使用 Docker 方式安裝，這些依賴都會被自動設定好。

### 4. APISIX 的效能如何？

APISIX 的效能非常高，單核 QPS 可達 18,000 次，平均延遲小於 0.2 毫秒。這得益於：
- Nginx 的高效能 HTTP 處理能力
- LuaJIT 的即時編譯
- 優雅的架構設計

### 5. APISIX 支援哪些平台？

APISIX 支援多種平台：
- Linux（Ubuntu、CentOS、Debian 等）
- macOS
- Windows（透過 WSL 或 Docker）
- Kubernetes（透過 Helm 或 Operator）

## 安裝問題

### 6. 快速啟動腳本安裝失敗怎麼辦？

常見原因和解決方法：

1. **Docker 未啟動**
   ```bash
   # 啟動 Docker
   sudo systemctl start docker
   ```

2. **連接埠被佔用**
   ```bash
   # 檢查連接埠佔用
   lsof -i :9080
   
   # 停止佔用連接埠的程式，或修改 APISIX 配置使用其他連接埠
   ```

3. **網路問題**
   ```bash
   # 檢查 Docker 網路
   docker network ls
   
   # 嘗試手動拉取映像檔
   docker pull apache/apisix:3.3.0
   docker pull apache/apisix/etcdserve:v3.5.0
   ```

### 7. 如何修改 APISIX 連接埠？

修改 Docker Compose 設定：

```yaml
services:
  apisix:
    ports:
      - "9081:9080"  # 主機連接埠:容器連接埠
      - "9444:9443"
      - "9181:9180"
```

或者修改 `config.yaml` 設定檔：

```yaml
deployment:
  listen:
    ip: "0.0.0.0"
    port: 9081
```

### 8. etcd 啟動失敗怎麼解決？

常見原因：

1. **資料目錄權限問題**
   ```bash
   sudo chown -R etcd:etcd /var/lib/etcd
   ```

2. **連接埠衝突**
   ```bash
   lsof -i :2379
   ```

3. **磁碟空間不足**
   ```bash
   df -h
   # 清理不必要的檔案
   ```

### 9. 如何升級 APISIX？

Docker 方式：
```bash
# 拉取新版本映像檔
docker pull apache/apisix:3.4.0

# 停止舊容器
docker stop apisix

# 使用新映像檔啟動
docker run -d apache/apisix:3.4.0 ...
```

注意：升級前請備份配置資料。

## 設定問題

### 10. 如何修改 Admin API 金鑰？

編輯 `config.yaml` 設定檔：

```yaml
deployment:
  admin:
    admin_key:
      - name: "admin"
        key: "your-new-secret-key"
        role: "admin"
```

修改後需要重啟 APISIX。

### 11. 如何啟用 HTTPS？

APISIX 支援兩種方式啟用 HTTPS：

1. **手動設定 SSL 憑證**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/ssl" -X PUT -d '
   {
     "id": "ssl-1",
     "cert": "-----BEGIN CERTIFICATE-----\n...",
     "key": "-----BEGIN PRIVATE KEY-----\n...",
     "snis": ["example.com"]
   }'
   ```

2. **使用 Let's Encrypt 自動簽發**
   ```bash
   # 啟用 acme 插件
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "acme": {
         "account_email": "your@email.com"
       }
     }
   }'
   ```

### 12. 如何設定多個網域？

在建立路由時使用 `hosts` 欄位：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "multi-domain",
  "hosts": ["example.com", "api.example.com"],
  "uri": "/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 13. 如何實現請求重定向？

使用 `redirect` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "redirect-route",
  "uri": "/old-path",
  "plugins": {
    "redirect": {
      "uri": "/new-path",
      "http_status": 301
    }
  }
}'
```

## 功能問題

### 14. 如何實現灰度發布？

有兩種方式：

1. **基於權重的灰度發布**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "traffic-split": {
         "rules": [
           {
             "weighted_upstream": [
               {"upstream": {"name": "v1", "nodes": {"v1:8080": 100}}, "weight": 90},
               {"upstream": {"name": "v2", "nodes": {"v2:8080": 100}}, "weight": 10}
             ]
           }
         ]
       }
     }
   }'
   ```

2. **基於請求屬性的灰度發布**
   使用 `vars` 條件匹配，如根據 Header、Cookie、參數等分配到不同上游。

### 15. 如何實現熔斷？

APISIX 內建熔斷功能，透過健康檢查實現：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"backend:8080": 1},
    "checks": {
      "passive": {
        "healthy": {"successes": 3},
        "unhealthy": {"http_failures": 3}
      }
    }
  }
}'
```

### 16. 如何實現跨域請求？

使用 `cors` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "cors": {
      "allow_origins": "*",
      "allow_methods": "GET,POST,PUT,DELETE",
      "allow_headers": "*"
    }
  }
}'
```

### 17. 如何實現請求限流？

```bash
# 基於請求數量限流
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 429
    }
  }
}'
```

### 18. 如何使用消費者進行身份驗證？

1. 建立消費者：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
   {
     "username": "user1",
     "plugins": {
       "key-auth": {"key": "key-1"}
     }
   }'
   ```

2. 在路由上啟用驗證：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {"key-auth": {}}
   }'
   ```

3. 客戶端請求時攜帶金鑰：
   ```bash
   curl "http://127.0.0.1:9080/api" -H "apikey: key-1"
   ```

## 監控問題

### 19. 如何整合 Prometheus？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  }
}'
```

存取指標：
```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 20. 如何設定日誌傳送？

支援多種日誌輸出：

```bash
# HTTP 日誌
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  }
}'

# Kafka 日誌
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "kafka-logger": {
      "brokers": [{"host": "kafka", "port": 9092}],
      "topic": "apisix-logs"
    }
  }
}'
```

### 21. 如何使用 SkyWalking 追蹤？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "skywalking": {
      "endpoint_addr": "http://skywalking:11800",
      "service_name": "apisix",
      "sample_ratio": 1
    }
  }
}'
```

## 叢集問題

### 22. 如何搭建 APISIX 叢集？

APISIX 節點是無狀態的，只需要：

1. 部署多個 APISIX 節點
2. 設定所有節點連線到同一個 etcd 叢集
3. 使用負載均衡器（如 Nginx、HAProxy）分發流量

```yaml
# config.yaml
deployment:
  etcd:
    host:
      - "http://etcd1:2379"
      - "http://etcd2:2379"
      - "http://etcd3:2379"
```

### 23. 如何保證 etcd 的高可用性？

etcd 支援叢集模式部署：

```bash
# 啟動 etcd 叢集
etcd --name infra1 --initial-advertise-peer-urls http://localhost:2380 \
  --listen-peer-urls http://localhost:2380 \
  --initial-cluster infra1=http://localhost:2380,...
```

生產環境建議至少部署 3 個 etcd 節點。

### 24. 如何遷移 APISIX 配置？

1. 匯出配置：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx" > routes.json
   ```

2. 匯入到新叢集：
   ```bash
   # 逐條匯入或使用批量匯入工具
   ```

## 安全問題

### 25. 生產環境有哪些安全建議？

1. **修改預設 API 金鑰**
   ```yaml
   deployment:
     admin:
       admin_key:
         - key: "your-secure-key"
   ```

2. **限制 Admin API 存取**
   ```yaml
   deployment:
     admin:
       allow_access: ["127.0.0.1", "10.0.0.0/8"]
   ```

3. **啟用 HTTPS**

4. **設定防火牆規則**

5. **定期更新版本**

### 26. 如何防止 API 被惡意存取？

1. **啟用 IP 黑名單**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "ip-restriction": {
         "deny": ["1.2.3.4"]
       }
     }
   }'
   ```

2. **啟用請求驗證**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "request-validation": {
         "body_schema": {
           "type": "object",
           "required": ["name"],
           "properties": {"name": {"type": "string"}}
         }
       }
     }
   }'
   ```

3. **啟用 CSRF 防護**

## 調試問題

### 27. 如何查看 APISIX 日誌？

Docker 方式：
```bash
docker logs apisix
```

查看錯誤日誌：
```bash
tail -f logs/error.log
```

### 28. 如何調試路由匹配？

使用 `debug` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/plugin_metadata/debug" -X PUT -d '
{
  "headers": ["X-Request-ID"]
}'
```

### 29. 請求返回 404 怎麼辦？

1. 檢查路由是否正確建立：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx"
   ```

2. 檢查 URI 是否匹配：
   - 確保請求路徑與路由設定一致
   - 注意前綴匹配和精確匹配的區別

3. 檢查上游服務是否可達：
   ```bash
   curl -v http://backend:8080/health
   ```

### 30. 請求返回 503 怎麼辦？

通常是上游服務不可用：

1. 檢查上游節點是否運行
2. 檢查網路連通性
3. 檢查健康檢查設定是否過於嚴格

## 更多幫助

如果遇到本文未涵蓋的問題，可以參考以下資源：

- 官方文檔：https://apisix.apache.org/docs/
- GitHub：https://github.com/apache/apisix
- 社區論壇：https://github.com/apache/apisix/discussions
- Slack：https://apisix.apache.org/slack
