# Angular 使用手冊

本手冊涵蓋 Angular 開發從基礎到進階的所有面向。

---

## 目錄

1. [簡介](#簡介)
2. [專案結構](#專案結構)
3. [元件](#元件)
4. [範本](#範本)
5. [服務](#服務)
6. [路由](#路由)
7. [表單](#表單)
8. [HTTP 用戶端](#http-用戶端)
9. [狀態管理](#狀態管理)
10. [測試](#測試)
11. [建置和部署](#建置和部署)
12. [最佳實踐](#最佳實踐)

---

## 簡介

### 什麼是 Angular？

Angular 是由 Google 開發的基於 TypeScript 的開源 Web 應用框架。它為建構現代單頁應用（SPA）提供了完整的解決方案。

### 核心特性

- **元件化架構**：使用可複用元件建構應用
- **雙向資料繫結**：模型和範本自動同步
- **依賴注入**：高效的服務管理
- **路由**：用戶端導航
- **表單**：強大的表單處理和驗證
- **HTTP 用戶端**：與後端服務通訊
- **測試**：內建測試工具
- **跨平台**：Web、行動 Web、原生行動端和桌面端

---

## 專案結構

### 標準目錄結構

```
my-app/
├── src/
│   ├── app/
│   │   ├── components/        # 可複用元件
│   │   ├── pages/             # 頁面級元件
│   │   ├── services/          # Angular 服務
│   │   ├── models/            # 資料模型/介面
│   │   ├── guards:            # 路由守衛
│   │   ├── interceptors:      # HTTP 攔截器
│   │   ├── pipes:            # 自訂管道
│   │   ├── directives:       # 自訂指令
│   │   ├── app.component.ts  # 根元件
│   │   ├── app.config.ts     # 應用配置（獨立元件）
│   │   ├── app.routes.ts     # 應用路由
│   │   └── main.ts           # 應用入口
│   ├── assets:                # 靜態檔案
│   ├── environments:          # 環境配置
│   ├── styles.css             # 全域樣式
│   └── index.html             # 主 HTML 檔案
├── angular.json               # Angular CLI 配置
├── package.json               # NPM 相依套件
└── tsconfig.json              # TypeScript 配置
```

---

## 元件

### 建立元件

```bash
# 使用 Angular CLI
ng generate component components/user-list
# 或
ng g c components/user-list
```

### 元件範例

```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-user-card',
  templateUrl: './user-card.component.html',
  styleUrls: ['./user-card.component.css']
})
export class UserCardComponent {
  @Input() user: User | null = null;
  @Output() delete = new EventEmitter<number>();

  onDelete() {
    if (this.user) {
      this.delete.emit(this.user.id);
    }
  }
}
```

### 生命週期鉤子

```typescript
import { Component, OnInit, OnDestroy, AfterViewInit } from '@angular/core';

@Component({...})
export class ExampleComponent implements OnInit, OnDestroy, AfterViewInit {
  
  ngOnInit() {
    // 元件初始化後呼叫一次
  }

  ngAfterViewInit() {
    // 元件範本初始化後呼叫
  }

  ngOnDestroy() {
    // 元件銷毀前呼叫
    // 清理訂閱、計時器等
  }
}
```

### 獨立元件（Angular 14+）

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-standalone',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <h1>{{ title }}</h1>
    <button (click)="onClick()">點擊</button>
  `
})
export class StandaloneComponent {
  title = '獨立元件';
}
```

---

## 範本

### 範本語法

#### 插值
```html
<h1>你好，{{ name }}</h1>
<p>總計：{{ 2 + 3 }}</p>
```

#### 屬性繫結
```html
<img [src]="imageUrl" [alt]="imageAlt">
<button [class.active]="isActive">點擊</button>
```

#### 事件繫結
```html
<button (click)="onClick()">點擊我</button>
<input (input)="onInput($event)">
```

#### 雙向繫結
```html
<input [(ngModel)]="username" name="username">
```

### 結構指令

#### *ngIf
```html
<div *ngIf="isLoggedIn">
  歡迎，{{ username }}！
</div>

<div *ngIf="isLoggedIn; else loggedOut">歡迎！</div>
<ng-template #loggedOut>請登入。</ng-template>
```

#### *ngFor
```html
<li *ngFor="let user of users; let i = index">
  {{ i + 1 }}. {{ user.name }}
</li>

<!-- 使用 trackBy 提升效能 -->
<li *ngFor="let user of users; trackBy: trackById">
```

#### *ngSwitch
```html
<div [ngSwitch]="status">
  <p *ngSwitchCase="'pending'">待處理...</p>
  <p *ngSwitchCase="'approved'">已批准！</p>
  <p *ngSwitchDefault>未知狀態</p>
</div>
```

### 管道

```html
<p>{{ today | date:'fullDate' }}</p>
<p>{{ price | currency:'TWD' }}</p>
<p>{{ name | uppercase }}</p>
<p>{{ text | slice:0:10 }}</p>
```

---

## 服務

### 建立服務

```bash
ng generate service services/user
# 或
ng g s services/user
```

### 服務範例

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { User } from '../models/user';

@Injectable({ providedIn: 'root' })
export class UserService {
  private apiUrl = 'https://api.example.com/users';

  constructor(private http: HttpClient) {}

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl);
  }

  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`);
  }

  createUser(user: User): Observable<User> {
    return this.http.post<User>(this.apiUrl, user);
  }

  updateUser(id: number, user: User): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user);
  }

  deleteUser(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

---

## 路由

### 設定路由

```typescript
// app.routes.ts
import { Routes } from '@angular/router';

export const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { 
    path: 'home', 
    loadComponent: () => import('./pages/home/home.component')
      .then(m => m.HomeComponent) 
  },
  { 
    path: 'users', 
    loadComponent: () => import('./pages/users/users.component')
      .then(m => m.UsersComponent) 
  },
  { 
    path: '**', 
    loadComponent: () => import('./pages/not-found/not-found.component')
      .then(m => m.NotFoundComponent) 
  }
];
```

### 路由參數

```typescript
// 路由：{ path: 'user/:id', ... }

// 在元件中
import { ActivatedRoute } from '@angular/router';

constructor(private route: ActivatedRoute) {}

ngOnInit() {
  this.route.paramMap.subscribe(params => {
    const id = params.get('id');
  });
}
```

### 路由守衛

```typescript
import { Injectable } from '@angular/core';
import { CanActivate, Router } from '@angular/router';

@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(private router: Router) {}

  canActivate(): boolean {
    const isLoggedIn = /* 檢查登入狀態 */;
    if (!isLoggedIn) {
      this.router.navigate(['/login']);
      return false;
    }
    return true;
  }
}
```

### 延遲載入

```typescript
{
  path: 'dashboard',
  loadComponent: () => import('./dashboard/dashboard.component')
    .then(m => m.DashboardComponent)
}
```

---

## 表單

### 範本驅動表單

```typescript
import { Component } from '@angular/core';

@Component({
  selector: 'app-login',
  template: `
    <form #loginForm="ngForm" (ngSubmit)="onSubmit(loginForm)">
      <input type="email" [(ngModel)]="user.email" name="email" required email>
      <input type="password" [(ngModel)]="user.password" name="password" required minlength="6">
      <button type="submit" [disabled]="loginForm.invalid">登入</button>
    </form>
  `
})
export class LoginComponent {
  user = { email: '', password: '' };

  onSubmit(form: any) {
    console.log('表單值：', form.value);
  }
}
```

### 反應式表單

```typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html'
})
export class RegisterComponent implements OnInit {
  registerForm!: FormGroup;

  constructor(private fb: FormBuilder) {}

  ngOnInit() {
    this.registerForm = this.fb.group({
      username: ['', [Validators.required, Validators.minLength(3)]],
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(8)]]
    });
  }

  onSubmit() {
    if (this.registerForm.valid) {
      console.log(this.registerForm.value);
    }
  }
}
```

```html
<form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
  <input formControlName="username">
  <div *ngIf="registerForm.get('username')?.invalid">使用者名稱必填</div>
  <button type="submit" [disabled]="registerForm.invalid">註冊</button>
</form>
```

---

## HTTP 用戶端

### 配置

```typescript
// app.config.ts（獨立元件）
import { ApplicationConfig } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';

export const appConfig: ApplicationConfig = {
  providers: [provideHttpClient()]
};
```

### HTTP 方法

```typescript
constructor(private http: HttpClient) {}

// GET
this.http.get<User[]>(url).subscribe(data => console.log(data));

// POST
this.http.post<User>(url, user).subscribe(newUser => ...);

// PUT
this.http.put<User>(`${url}/${id}`, user).subscribe();

// DELETE
this.http.delete(`${url}/${id}`).subscribe();
```

### HTTP 攔截器

```typescript
import { HttpInterceptorFn } from '@angular/common/http';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const token = localStorage.getItem('token');
  const cloned = req.clone({
    setHeaders: { Authorization: token ? `Bearer ${token}` : '' }
  });
  return next(cloned);
};
```

---

## 狀態管理

### 使用服務和 BehaviorSubject

```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class CartService {
  private items$ = new BehaviorSubject<CartItem[]>([]);
  
  getItems(): Observable<CartItem[]> {
    return this.items$.asObservable();
  }
  
  addItem(item: CartItem) {
    this.items$.next([...this.items$.value, item]);
  }
  
  removeItem(id: number) {
    this.items$.next(this.items$.value.filter(i => i.id !== id));
  }
}
```

### 使用 Signals（Angular 16+）

```typescript
import { Component, signal, computed } from '@angular/core';

@Component({...})
export class CounterComponent {
  count = signal(0);
  doubled = computed(() => this.count() * 2);
  
  increment() {
    this.count.update(c => c + 1);
  }
}
```

---

## 測試

### 單元測試

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { UserListComponent } from './user-list.component';
import { UserService } from '../services/user.service';
import { of } from 'rxjs';

describe('UserListComponent', () => {
  let component: UserListComponent;
  let fixture: ComponentFixture<UserListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [UserListComponent],
      providers: [
        { provide: UserService, useValue: jasmine.createSpyObj('UserService', ['getUsers']) }
      ]
    }).compileComponents();

    fixture = TestBed.createComponent(UserListComponent);
    component = fixture.componentInstance;
  });

  it('應該建立', () => {
    expect(component).toBeTruthy();
  });

  it('應該載入使用者', () => {
    const userService = TestBed.inject(UserService);
    userService.getUsers.and.returnValue(of([{ id: 1, name: '張三' }]));
    
    component.ngOnInit();
    
    expect(component.users.length).toBe(1);
  });
});
```

---

## 建置和部署

### 開發建置
```bash
ng build
ng serve
```

### 生產建置
```bash
ng build --configuration production
# 或
ng build -c production
```

### 部署選項

#### Netlify
```bash
npm install -g netlify-cli
netlify deploy --prod --dir=dist/your-app
```

#### Vercel
```args
npm i -g vercel
vercel --prod
```

#### Docker
```dockerfile
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build -- --configuration production

FROM nginx:alpine
COPY --from=build /app/dist/your-app/browser /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## 最佳實踐

### 專案結構
```
src/app/
├── core/           # 單例服務、守衛
├── shared/         # 可複用元件、管道、指令
├── features:       # 功能模組
└── app.component.ts
```

### 效能優化
1. 使用 OnPush 變更偵測
2. 在 *ngFor 中實現 trackBy
3. 延遲載入路由
4. 使用 signals 管理狀態
5. 取消訂閱 observable（或使用 async 管道）

### 程式碼規範
- 使用嚴格 TypeScript
- 遵循 Angular 風格指南
- 使用獨立元件
- 保持元件小而專注

---

## 其他資源

- 官方網站：https://angular.io/
- 文件：https://angular.io/docs
- CLI 參考：https://angular.io/cli
- GitHub：https://github.com/angular/angular

---

*最後更新：2024*
