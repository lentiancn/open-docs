# Nacos Usage Guide

Comprehensive guide for using Nacos effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Configuration Management](#configuration-management)
- [Service Discovery](#service-discovery)
- [Naming Services](#naming-services)
- [API Usage](#api-usage)
- [Nacos Client](#nacos-client)
- [Best Practices](#best-practices)

---

## Basic Concepts

### What is Nacos?

Nacos provides easy-to-use features for:

| Feature | Description |
|---------|-------------|
| **Configuration Management** | Dynamic configuration |
| **Service Discovery** | Register and discover services |
| **Service Management** | Health monitoring |

### Key Terms

| Term | Description |
|------|-------------|
| **Data ID** | Unique identifier for configuration |
| **Group** | Group for organizing configurations |
| **Namespace** | Isolation for different environments |
| **Service** | Application registered in Nacos |
| **Instance** | Specific instance of a service |

---

## Configuration Management

### Web UI Operations

1. **Login**: http://localhost:8848/nacos
   - Username: nacos
   - Password: nacos

2. **Create Configuration**
   - Go to "Configuration Management" > "Configuration List"
   - Click "Create" button
   - Fill in:
     - Data ID: `example.yaml`
     - Group: `DEFAULT_GROUP`
     - Content: Configuration content

### Configuration Example

```yaml
# example.yaml
database:
  host: localhost
  port: 3306
  name: myapp
  
redis:
  host: localhost
  port: 6379

app:
  name: myapp
  version: 1.0.0
```

### Publish Configuration

```bash
# Using Nacos CLI
curl -X POST "http://localhost:8848/nacos/v1/cs/configs" \
  -d "dataId=example.yaml&group=DEFAULT_GROUP&content=database.host=localhost"
```

### Get Configuration

```bash
curl "http://localhost:8848/nacos/v1/cs/configs?dataId=example.yaml&group=DEFAULT_GROUP"
```

---

## Service Discovery

### Register Service

```bash
# Register service
curl -X POST "http://localhost:8848/nacos/v1/ns/instance" \
  -d "serviceName=nacos-test&ip=192.168.1.100&port=8080"
```

### Query Service

```bash
# Get service list
curl "http://localhost:8848/nacos/v1/ns/instance/list?serviceName=nacos-test"

# Get service detail
curl "http://localhost:8848/nacos/v1/ns/service?serviceName=nacos-test"
```

### Deregister Service

```bash
# Delete instance
curl -X DELETE "http://localhost:8848/nacos/v1/ns/instance" \
  -d "serviceName=nacos-test&ip=192.168.1.100&port=8080"
```

---

## Naming Services

### Create Service

```bash
curl -X POST "http://localhost:8848/nacos/v1/ns/service" \
  -d "serviceName=my-service&protectThreshold=0.5"
```

### Delete Service

```bash
curl -X DELETE "http://localhost:8848/nacos/v1/ns/service" \
  -d "serviceName=my-service"
```

### Update Service

```bash
curl -X PUT "http://localhost:8848/nacos/v1/ns/service" \
  -d "serviceName=my-service&protectThreshold=0.6"
```

---

## API Usage

### Configuration APIs

```bash
# Get config
GET /nacos/v1/cs/configs?dataId={dataId}&group={group}

# Publish config
POST /nacos/v1/cs/configs
  dataId={dataId}&group={group}&content={content}

# Delete config
DELETE /nacos/v1/cs/configs?dataId={dataId}&group={group}
```

### Service Discovery APIs

```bash
# Register instance
POST /nacos/v1/ns/instance
  serviceName={name}&ip={ip}&port={port}

# Deregister instance
DELETE /nacos/v1/ns/instance
  serviceName={name}&ip={ip}&port={port}

# Query instance list
GET /nacos/v1/ns/instance/list?serviceName={name}

# Query service
GET /nacos/v1/ns/service?serviceName={name}
```

### Namespace APIs

```bash
# Create namespace
POST /nacos/v1/console/ns
  customNamespaceId=dev&namespaceName=development&namespaceDesc=Dev+environment

# List namespaces
GET /nacos/v1/console/ns

# Delete namespace
DELETE /nacos/v1/console/ns?customNamespaceId=dev
```

---

## Nacos Client

### Java Client

#### Add Dependency

```xml
<!-- Maven -->
<dependency>
    <groupId>com.alibaba.nacos</groupId>
    <artifactId>nacos-client</artifactId>
    <version>2.3.0</version>
</dependency>
```

#### Configuration Client

```java
import com.alibaba.nacos.api.NacosFactory;
import com.alibaba.nacos.api.config.ConfigService;
import com.alibaba.nacos.api.exception.NacosException;
import java.util.Properties;

public class NacosConfigExample {
    public static void main(String[] args) throws NacosException {
        Properties properties = new Properties();
        properties.put("serverAddr", "127.0.0.1:8848");
        properties.put("namespace", "public");
        
        ConfigService configService = NacosFactory.createConfigService(properties);
        
        // Get config
        String config = configService.getConfig("example.yaml", "DEFAULT_GROUP", 5000);
        System.out.println("Config: " + config);
        
        // Publish config
        boolean success = configService.publishConfig("test.yaml", "DEFAULT_GROUP", "key=value");
        System.out.println("Published: " + success);
        
        // Listen for changes
        configService.addListener("example.yaml", "DEFAULT_GROUP", new Listener() {
            @Override
            public Executor getExecutor() {
                return null;
            }
            
            @Override
            public void receiveConfigInfo(String configInfo) {
                System.out.println("Config changed: " + configInfo);
            }
        });
    }
}
```

#### Service Discovery Client

```java
import com.alibaba.nacos.api.NacosFactory;
import com.alibaba.nacos.api.naming.NamingService;
import com.alibaba.nacos.api.naming.pojo.Instance;
import java.util.List;
import java.util.Properties;

public class NacosNamingExample {
    public static void main(String[] args) throws NacosException {
        Properties properties = new Properties();
        properties.put("serverAddr", "127.0.0.1:8848");
        
        NamingService namingService = NacosFactory.createNamingService(properties);
        
        // Register instance
        Instance instance = new Instance();
        instance.setIp("192.168.1.100");
        instance.setPort(8080);
        instance.setServiceName("my-service");
        namingService.registerInstance("my-service", instance);
        
        // Query instances
        List<Instance> instances = namingService.selectInstances("my-service", true);
        for (Instance inst : instances) {
            System.out.println("Instance: " + inst.getIp() + ":" + inst.getPort());
        }
        
        // Subscribe
        namingService.subscribe("my-service", event -> {
            System.out.println("Service changed: " + event);
        });
    }
}
```

### Spring Boot Integration

#### Add Dependency

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    <version>2022.0.0.0</version>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    <version>2022.0.0.0</version>
</dependency>
```

#### Configuration

```yaml
# application.yml
spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        namespace: public
        group: DEFAULT_GROUP
      config:
        namespace: public
        group: DEFAULT_GROUP
        file-extension: yaml
```

#### Use Configuration

```java
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RefreshScope
public class ConfigController {
    
    @Value("${database.host:localhost}")
    private String dbHost;
    
    @GetMapping("/config")
    public String getConfig() {
        return "Database host: " + dbHost;
    }
}
```

### Python Client

```python
import nacos

# Configuration
SERVER_ADDRESSES = "127.0.0.1:8848"
NAMESPACE = "public"

# Create client
client = nacos.NacosClient(SERVER_ADDRESSES, namespace=NAMESPACE)

# Get config
config = client.get_config("example.yaml", "DEFAULT_GROUP")
print(f"Config: {config}")

# Publish config
client.publish_config("test.yaml", "DEFAULT_GROUP", "key=value")

# Register service
client.add_naming_instance("my-service", "192.168.1.100", 8080)

# Query service
instances = client.list_naming_instance("my-service")
print(f"Instances: {instances}")
```

---

## Best Practices

### Configuration Management

1. **Use Appropriate Groups**
   ```
   # Group by environment
   DEV_GROUP
   TEST_GROUP
   PROD_GROUP
   ```

2. **Use Namespaces**
   ```
   # Namespace for isolation
   public (default)
   dev
   test
   prod
   ```

3. **Configuration Naming**
   ```
   # Use meaningful names
   application.yaml (shared config)
   {application}-{profile}.yaml (environment specific)
   ```

### Service Discovery

1. **Use Health Checks**
   - Enable health checks for instances
   - Remove unhealthy instances automatically

2. **Load Balancing**
   - Use Nacos for client-side load balancing
   - Configure weight for instances

3. **Service Naming**
   ```
   # Use consistent naming
   {application}.{group}.{namespace}
   ```

### Security

1. **Enable Authentication**
   ```properties
   nacos.core.auth.enabled=true
   ```

2. **Use Tokens**
   ```properties
   nacos.core.auth.token.secret.key=your-secret-key
   ```

3. **Limit Access**
   - Use ACL for sensitive configs
   - Configure IP whitelist

---

## Quick Reference

### Default Ports

| Port | Description |
|------|-------------|
| 8848 | HTTP API |
| 9848 | gRPC |
| 9849 | gRPC |

### Default Credentials

- Username: nacos
- Password: nacos

### API Base URL

```
http://localhost:8848/nacos/v1/
```

---

## Next Steps

- Explore [Nacos Config](https://nacos.io/en-us/docs/config-guide.html)
- Learn about [Nacos Service Discovery](https://nacos.io/en-us/docs/service-discovery.html)
- Read about [Nacos Architecture](https://nacos.io/en-us/docs/architecture.html)
