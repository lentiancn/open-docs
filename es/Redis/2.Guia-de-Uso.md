# Guía de Uso de Redis

Guía completa para usar Redis de manera efectiva.

---

## Tabla de Contenidos

- [Conceptos Básicos](#conceptos-básicos)
- [Tipos de Datos](#tipos-de-datos)
- [Operaciones con Cadenas](#operaciones-con-cadenas)
- [Operaciones con Listas](#operaciones-con-listas)
- [Operaciones con Hashes](#operaciones-con-hashes)
- [Operaciones con Conjuntos](#operaciones-con-conjuntos)
- [Operaciones con Conjuntos Ordenados](#operaciones-con-conjuntos-ordenados)
- [Claves y Expiración](#claves-y-expiración)
- [Pub/Sub](#pub-sub)
- [Transacciones](#transacciones)
- [Pipeline](#pipeline)
- [Scripts Lua](#scripts-lua)
- [Persistencia](#persistencia)
- [Replicación](#replicación)
- [Clúster](#clúster)
- [Seguridad](#seguridad)
- [Optimización de Rendimiento](#optimización-de-rendimiento)
- [Recetas Comunes](#recetas-comunes)

---

## Conceptos Básicos

### ¿Qué es Redis?

Redis es un almacén de estructuras de datos en memoria de código abierto, utilizado como base de datos, caché y broker de mensajes. Soporta varias estructuras de datos y proporciona alto rendimiento.

### Características Principales

- Almacenamiento en memoria
- Persistencia de datos
- Replicación
- Clústerajería Pub/es
- MensSub
- Scripting Lua

### Términos Clave

| Término | Descripción |
|---------|-------------|
| Key | Identificador único para el valor |
| Value | Datos almacenados en Redis |
| TTL | Time To Live (expiración) |
| Pipeline | Ejecutar múltiples comandos en lote |
| Master | Instancia primaria de Redis |
| Slave | Réplica del master |

---

## Tipos de Datos

Redis soporta varios tipos de datos:

| Tipo | Descripción |
|------|-------------|
| String | Texto o datos binarios |
| List | Lista ordenada de cadenas |
| Hash | Colección de pares campo-valor |
| Set | Colección no ordenada de cadenas únicas |
| Sorted Set | Set con puntuaciones para ordenar |
| HyperLogLog | Estructura de datos probabilística |
| Bitmap | Cadena con operaciones de bits |
| Stream | Broker de mensajes estructurado en log |

---

## Operaciones con Cadenas

### Comandos Básicos

```bash
# Establecer valor
SET key "value"

# Obtener valor
GET key

# Establecer múltiples claves
MSET key1 "value1" key2 "value2"

# Obtener múltiples claves
MGET key1 key2

# Append a cadena
APPEND key " appended"

# Obtener longitud de cadena
STRLEN key
```

### Operaciones Numéricas

```bash
# Incrementar
INCR counter
INCRBY counter 10

# Decrementar
DECR counter
DECRBY counter 5

# Incremento de flotante
INCRBYFLOAT price 0.5
```

---

## Operaciones con Listas

### Comandos Básicos

```bash
# Empujar a la izquierda
LPUSH mylist "first"

# Empujar a la derecha
RPUSH mylist "last"

# Pop desde la izquierda
LPOP mylist

# Pop desde la derecha
RPOP mylist

# Obtener rango
LRANGE mylist 0 -1

# Obtener longitud de lista
LLEN mylist
```

---

## Operaciones con Hashes

### Comandos Básicos

```bash
# Establecer campo de hash
HSET user:1 name "John"

# Establecer múltiples campos
HMSET user:1 name "John" email "john@example.com"

# Obtener campo de hash
HGET user:1 name

# Obtener todos los campos y valores
HGETALL user:1

# Obtener múltiples campos
HMGET user:1 name email

# Eliminar campo
HDEL user:1 email
```

---

## Operaciones con Conjuntos

### Comandos Básicos

```bash
# Agregar a conjunto
SADD myset "member1"

# Eliminar de conjunto
SREM myset "member1"

# Obtener todos los miembros
SMEMBERS myset

# Verificar membresía
SISMEMBER myset "member1"

# Obtener tamaño del conjunto
SCARD myset
```

### Operaciones de Conjuntos

```bash
# Unión
SUNION set1 set2

# Intersección
SINTER set1 set2

# Diferencia
SDIFF set1 set2
```

---

## Operaciones con Conjuntos Ordenados

### Comandos Básicos

```bash
# Agregar a conjunto ordenado
ZADD leaderboard 100 "player1"

# Obtener rango (ascendente)
ZRANGE leaderboard 0 -1 WITHSCORES

# Obtener rango (descendente)
ZREVRANGE leaderboard 0 -1 WITHSCORES

# Obtener rango
ZRANK leaderboard "player1"

# Incrementar puntuación
ZINCRBY leaderboard 50 "player1"
```

---

## Claves y Expiración

### Gestión de Claves

```bash
# Eliminar clave
DEL key

# Verificar si existe
EXISTS key

# Obtener tipo de clave
TYPE key

# Renombrar clave
RENAME key newkey

# Obtener todas las claves
KEYS pattern

# Escanear claves
SCAN 0 MATCH pattern
```

### Expiración

```bash
# Establecer expiración (segundos)
EXPIRE key 60

# Establecer expiración (milisegundos)
PEXPIRE key 60000

# Establecer clave con expiración
SETEX key 60 "value"

# Eliminar expiración
PERSIST key

# Obtener tiempo de vida (segundos)
TTL key

# Obtener tiempo de vida (milisegundos)
PTTL key
```

---

## Pub/Sub

### Publicando

```bash
# Suscribirse a canal
SUBSCRIBE mychannel

# Publicar mensaje
PUBLISH mychannel "Hello"

# Suscripción por patrón
PSUBSCRIBE news.*
```

### Comandos

```bash
# Suscribirse
SUBSCRIBE channel1 channel2

# Publicar
PUBLISH channel1 "message"

# Cancelar suscripción
UNSUBSCRIBE channel1
```

---

## Transacciones

### Comandos Básicos

```bash
# Iniciar transacción
MULTI

# Encolar comandos
SET key1 "value1"
SET key2 "value2"

# Ejecutar transacción
EXEC

# Descartar transacción
DISCARD
```

### Watch

```bash
WATCH key
# ... algunas operaciones ...
MULTI
SET key newvalue
EXEC  # Falla si la clave fue modificada
```

---

## Pipeline

### Usando Pipeline

```bash
# Pipeline de múltiples comandos
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# En código (ejemplo Python)
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Scripts Lua

### Script Básico

```bash
# Ejecutar script Lua
EVAL "return redis.call('get', 'key')" 0

# Establecer clave con Lua
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### Ejemplo de Script

```lua
-- Incrementar contador
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## Persistencia

### RDB (Redis Database)

```bash
# Guardar manualmente
BGSAVE

# Obtener última hora de guardado
LASTSAVE
```

### AOF (Append Only File)

```bash
# Habilitar AOF en config
appendonly yes

# Reescribir AOF
BGREWRITEAOF
```

### Configuración

```bash
# Frecuencia de guardado
save 900 1
save 300 10
save 60 10000
```

---

## Replicación

### Configurar Esclavo

```bash
# En redis.conf
replicaof masterip masterport

# O vía comando
REPLICAOF masterip masterport
```

### Comandos

```bash
# Ver estado de replicación
INFO replication

# Convertirse en master
REPLICAOF NO ONE
```

---

## Clúster

### Crear Clúster

```bash
# Crear clúster
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# Ver nodos del clúster
redis-cli -c cluster nodes
```

---

## Seguridad

### Autenticación con Contraseña

```bash
# Establecer contraseña en config
requirepass yourpassword

# Autenticar vía CLI
AUTH yourpassword
```

### ACL (Redis 6+)

```bash
# Crear usuario
ACL SETUSER alice on >password ~cached:* +get +set

# Listar usuarios
ACL LIST
```

---

## Optimización de Rendimiento

### Optimización de Memoria

```bash
# Establecer memoria máxima
maxmemory 2gb

# Política de evicción
maxmemory-policy allkeys-lru
```

### Optimización de Conexión

```bash
# Usar pool de conexiones
# En código
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## Recetas Comunes

### Caché

```bash
# Caché con expiración
SET user:1:profile "data" EX 3600

# Verificar caché
GET user:1:profile
```

### Limitación de Tasa

```bash
# Límite de tasa simple
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### Bloqueo Distribuido

```bash
# Adquirir bloqueo
SET lock:myresource unique_value NX EX 10

# Liberar bloqueo
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### Almacenamiento de Sesión

```bash
# Almacenar sesión
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## Próximos Pasos

- Explorar [Redis Stack](https://redis.io/docs/stack/)
- Aprender sobre [Redis Enterprise](https://redis.com/redis-enterprise/)
- Leer la [Guía de Ajuste de Rendimiento](https://redis.io/docs/management/optimization/)
