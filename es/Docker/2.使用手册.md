# Docker 使用手册

本手册详细介绍 Docker 的基本使用方法，包括镜像管理、容器操作、网络配置、数据卷管理等内容。

---

## 目录

1. [Docker 基本概念](#docker-基本概念)
2. [镜像操作](#镜像操作)
3. [容器操作](#容器操作)
4. [网络管理](#网络管理)
5. [数据卷管理](#数据卷管理)
6. [Docker Compose 使用](#docker-compose-使用)
7. [Dockerfile 编写](#dockerfile-编写)
8. [Docker 常用命令速查](#docker-常用命令速查)
9. [最佳实践](#最佳实践)
10. [故障排除](#故障排除)

---

## Docker 基本概念

### 什么是容器？

容器是一种轻量级、可执行的独立软件包，包含运行所需的所有内容：代码、运行时、系统工具、系统库和设置。容器化使软件可以在任何环境中一致地运行。

### 核心组件

- **镜像（Image）**：只读模板，用于创建容器
- **容器（Container）**：镜像的运行实例
- **仓库（Repository）**：存储镜像的地方
- **Dockerfile**：用于构建镜像的脚本文件
- **Docker Compose**：定义和运行多容器应用的工具

---

## 镜像操作

### 拉取镜像

从 Docker Hub 拉取镜像：

```bash
# 拉取最新版本
docker pull nginx

# 拉取指定版本
docker pull nginx:1.25

# 拉取特定标签
docker pull ubuntu:22.04
```

### 查看镜像列表

```bash
# 列出本地所有镜像
docker images

# 列出镜像 ID
docker images -q

# 显示镜像详细信息
docker image inspect nginx:latest
```

### 删除镜像

```bash
# 删除指定镜像
docker rmi nginx:latest

# 强制删除
docker rmi -f nginx:latest

# 删除未使用的镜像
docker image prune

# 删除所有未使用的镜像
docker image prune -a
```

### 构建镜像

使用 Dockerfile 构建镜像：

```bash
# 在当前目录查找 Dockerfile 并构建
docker build -t myapp:latest .

# 指定 Dockerfile 路径
docker build -f /path/to/Dockerfile -t myapp:latest .

# 构建时传递构建参数
docker build --build-arg VERSION=1.0 -t myapp:latest .
```

### 镜像标签

```bash
# 为镜像添加标签
docker tag myapp:latest myregistry.com/myapp:v1.0
```

### 推送镜像到仓库

```bash
# 登录 Docker Hub
docker login

# 推送镜像
docker push myapp:latest

# 推送到私有仓库
docker push myregistry.com/myapp:latest
```

---

## 容器操作

### 创建并启动容器

```bash
# 交互式容器（带终端）
docker run -it ubuntu /bin/bash

# 守护进程容器（后台运行）
docker run -d nginx

# 端口映射
docker run -d -p 8080:80 nginx

# 指定容器名称
docker run -d --name my-nginx nginx

# 自动重启容器
docker run -d --restart=always nginx

# 设置环境变量
docker run -d -e APP_ENV=production nginx

# 挂载数据卷
docker run -d -v /host/path:/container/path nginx
```

### 查看容器

```bash
# 列出运行中的容器
docker ps

# 列出所有容器（包括停止的）
docker ps -a

# 显示容器 ID
docker ps -q

# 显示容器详细信息
docker inspect my-nginx

# 查看容器日志
docker logs my-nginx

# 实时查看日志
docker logs -f my-nginx

# 查看容器资源使用
docker stats my-nginx
```

### 容器生命周期管理

```bash
# 启动容器
docker start my-nginx

# 停止容器
docker stop my-nginx

# 重启容器
docker restart my-nginx

# 暂停容器
docker pause my-nginx

# 取消暂停
docker unpause my-nginx

# 删除容器
docker rm my-nginx

# 强制删除运行中的容器
docker rm -f my-nginx

# 删除所有已停止的容器
docker container prune
```

### 进入容器内部

```bash
# 使用 exec 进入运行中的容器
docker exec -it my-nginx /bin/bash

# 在容器中执行命令
docker exec my-nginx ls -la
```

### 容器与主机之间文件拷贝

```bash
# 从主机拷贝到容器
docker cp /host/path/file.txt my-nginx:/container/path/

# 从容器拷贝到主机
docker cp my-nginx:/container/path/file.txt /host/path/
```

---

## 网络管理

### 查看网络

```bash
# 列出所有网络
docker network ls

# 查看网络详细信息
docker network inspect bridge
```

### 创建网络

```bash
# 创建桥接网络
docker network create my-network

# 创建自定义网络（支持容器名称解析）
docker network create --driver bridge my-network
```

### 容器网络操作

```bash
# 将容器连接到网络
docker network connect my-network my-nginx

# 断开容器网络
docker network disconnect my-network my-nginx
```

### 网络驱动类型

| 驱动类型 | 说明 |
|----------|------|
| bridge | 默认网络驱动，容器间网络通信 |
| host | 容器使用主机网络命名空间 |
| overlay | 跨主机容器通信（Swarm 模式）|
| macvlan | 为容器分配 MAC 地址 |
| none | 禁用网络 |

---

## 数据卷管理

### 创建数据卷

```bash
# 创建数据卷
docker volume create my-volume

# 列出数据卷
docker volume ls

# 查看数据卷详细信息
docker volume inspect my-volume
```

### 使用数据卷

```bash
# 挂载数据卷
docker run -d -v my-volume:/container/path nginx

# 挂载主机目录
docker run -d -v /host/path:/container/path nginx

# 只读挂载
docker run -d -v /host/path:/container/path:ro nginx
```

### 删除数据卷

```bash
# 删除指定数据卷
docker volume rm my-volume

# 删除未使用的数据卷
docker volume prune
```

### 数据卷类型

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| 匿名卷 | 由 Docker 自动创建 | 临时数据 |
| 命名卷 | 用户创建的卷 | 持久化数据 |
| 主机绑定 | 挂载主机目录 | 开发环境、配置 |

---

## Docker Compose 使用

### Docker Compose 文件结构

```yaml
version: '3.8'

services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html
    environment:
      - NGINX_HOST=localhost
    depends_on:
      - redis
    networks:
      - frontend
      - backend

  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    networks:
      - backend

networks:
  frontend:
  backend:

volumes:
  redis-data:
```

### 常用命令

```bash
# 启动所有服务
docker-compose up

# 后台启动
docker-compose up -d

# 停止所有服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v

# 查看日志
docker-compose logs -f

# 查看服务状态
docker-compose ps

# 构建镜像
docker-compose build

# 重启服务
docker-compose restart

# 进入服务容器
docker-compose exec web /bin/bash
```

### 多文件组合

```bash
# 使用指定配置文件
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

# 使用基础配置 + 开发配置
docker-compose -f base.yml -f development.yml up
```

---

## Dockerfile 编写

### 基础指令

```dockerfile
# 指定基础镜像
FROM node:18-alpine

# 设置维护者信息
LABEL maintainer="you@example.com"

# 设置环境变量
ENV NODE_ENV=production

# 设置工作目录
WORKDIR /app

# 复制文件
COPY package*.json ./

# 运行命令
RUN npm install

# 复制其余文件
COPY . .

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["node", "index.js"]
```

### 常用指令说明

| 指令 | 说明 | 示例 |
|------|------|------|
| FROM | 指定基础镜像 | FROM python:3.11 |
| RUN | 执行命令 | RUN pip install -r requirements.txt |
| COPY | 复制文件 | COPY ./src /app/src |
| ADD | 复制（支持 URL 和压缩包）| ADD https://example.com/file.tar.gz /tmp/ |
| WORKDIR | 设置工作目录 | WORKDIR /app |
| ENV | 设置环境变量 | ENV PORT=8080 |
| EXPOSE | 声明端口 | EXPOSE 8080 |
| CMD | 容器启动命令 | CMD ["node", "app.js"] |
| ENTRYPOINT | 入口点 | ENTRYPOINT ["python", "app.py"] |
| VOLUME | 创建挂载点 | VOLUME /data |
| LABEL | 添加元数据 | LABEL version="1.0" |
| USER | 设置用户 | USER node |
| ARG | 构建参数 | ARG VERSION |

### 多阶段构建示例

```dockerfile
# 构建阶段
FROM golang:1.20 AS builder
WORKDIR /app
COPY . .
RUN go build -o main .

# 运行阶段
FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/main .
CMD ["./main"]
```

### .dockerignore 文件

```
# 忽略版本控制文件
.git
.gitignore

# 忽略文档
*.md
docs/

# 忽略构建产物
node_modules/
dist/
build/

# 忽略敏感文件
.env*
*.pem
*.key

# 忽略日志
*.log
logs/
```

---

## Docker 常用命令速查

### 镜像命令

| 命令 | 说明 |
|------|------|
| `docker pull <image>` | 拉取镜像 |
| `docker images` | 列出镜像 |
| `docker rmi <image>` | 删除镜像 |
| `docker build -t <name> .` | 构建镜像 |
| `docker tag <image> <new-name>` | 为镜像打标签 |
| `docker push <image>` | 推送镜像 |

### 容器命令

| 命令 | 说明 |
|------|------|
| `docker run -d <image>` | 后台运行容器 |
| `docker run -it <image>` | 交互式运行容器 |
| `docker ps` | 列出运行中的容器 |
| `docker ps -a` | 列出所有容器 |
| `docker start <container>` | 启动容器 |
| `docker stop <container>` | 停止容器 |
| `docker rm <container>` | 删除容器 |
| `docker exec -it <container> /bin/bash` | 进入容器 |
| `docker logs <container>` | 查看日志 |

### 其他常用命令

| 命令 | 说明 |
|------|------|
| `docker network ls` | 列出网络 |
| `docker volume ls` | 列出数据卷 |
| `docker-compose up -d` | 启动 Compose 服务 |
| `docker-compose down` | 停止 Compose 服务 |
| `docker system prune` | 清理未使用的资源 |

---

## 最佳实践

### 镜像优化

1. **使用多阶段构建**：减小最终镜像体积
2. **选择合适的基础镜像**：优先使用 alpine 等轻量镜像
3. **减少层数**：合并 RUN 指令
4. **合理安排指令顺序**：利用 Docker 缓存
5. **使用 .dockerignore**：排除不必要的文件

### 安全建议

1. **不以 root 用户运行容器**：使用 USER 指令
2. **定期更新基础镜像**：获取最新安全补丁
3. **使用官方镜像**：优先使用经过验证的官方镜像
4. **扫描镜像漏洞**：使用 Docker Scout 或其他工具
5. **限制容器权限**：使用只读文件系统

### 开发工作流

1. **使用数据卷进行开发**：代码变更无需重建镜像
2. **使用 Docker Compose**：管理多容器应用
3. **环境变量配置**：使用环境变量而非硬编码
4. **日志管理**：配置适当的日志级别

---

## 故障排除

### 容器无法启动

```bash
# 查看容器日志
docker logs <container>

# 查看详细信息
docker inspect <container>

# 检查资源限制
docker stats <container>
```

### 端口冲突

```bash
# 检查端口占用
netstat -tlnp | grep <port>

# 使用其他端口
docker run -d -p 8081:80 nginx
```

### 磁盘空间不足

```bash
# 清理未使用的镜像
docker image prune -a

# 清理构建缓存
docker builder prune

# 清理所有未使用资源
docker system prune -a
```

### 网络问题

```bash
# 检查网络配置
docker network inspect <network>

# 创建新的网络
docker network create my-network

# 重新连接容器
docker network connect my-network <container>
```

### 权限问题

```bash
# 添加用户到 docker 组
sudo usermod -aG docker $USER

# 或者在容器内使用正确的用户
docker run -u 1000:1000 myapp
```

---

## 相关链接

- [Docker 官方文档](https://docs.docker.com/)
- [Docker Hub](https://hub.docker.com/)
- [Docker Compose 文档](https://docs.docker.com/compose/)
- [Dockerfile 最佳实践](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
