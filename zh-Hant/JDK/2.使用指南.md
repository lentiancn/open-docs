# JDK 使用指南

本指南介紹如何有效使用 JDK 進行 Java 開發。

## 基本命令

### 編譯 Java

```bash
# 編譯單個檔案
javac HelloWorld.java

# 使用自訂類別路徑編譯
javac -cp "lib/*" MyApp.java

# 編譯到指定目錄
javac -d ./build MyApp.java

# 啟用所有警告
javac -Xlint:all MyApp.java
```

### 執行 Java

```bash
# 執行已編譯的類別
java HelloWorld

# 使用自訂類別路徑執行
java -cp "lib/*:." MyApp

# 執行並分配更多記憶體
java -Xmx512m -Xms256m MyApp

# 使用系統屬性執行
java -Dapp.name=MyApp -Denv=prod MyApp
```

### Jar 命令

```bash
# 建立 JAR
jar cf myapp.jar -C out .

# 建立可執行 JAR
jar cfe myapp.jar com.example.Main -C out .

# 列出 JAR 內容
jar tf myapp.jar

# 解壓 JAR
jar xf myapp.jar
```

## JVM 選項

### 記憶體選項

```bash
# 堆大小
-Xms256m          # 初始堆大小
-Xmx1024m         # 最大堆大小
-Xmn128m          # 新生代大小

# Metaspace（Java 8+）
-XX:MetaspaceSize=128m
-XX:MaxMetaspaceSize=256m
```

### 垃圾回收

```bash
# G1GC（Java 9 預設）
-XX:+UseG1GC

# ZGC（低延遲）
-XX:+UseZGC

# Parallel GC（高吞吐量）
-XX:+UseParallelGC

# 記錄 GC 日誌
-Xlog:gc*:file=gc.log
```

### 效能優化

```bash
# JIT 編譯
-XX:+TieredCompilation

# 字串去重（Java 8u20+）
-XX:+UseStringDeduplication

# 類別資料共享
-Xshare:on
```

## 建構工具

### Maven

```bash
# 建立專案
mvn archetype:generate

# 編譯
mvn compile

# 執行測試
mvn test

# 打包
mvn package

# 執行
mvn spring-boot:run
```

### Gradle

```bash
# 建立專案
gradle init

# 編譯
gradle compileJava

# 執行測試
gradle test

# 建構
gradle build

# 執行
gradle bootRun
```

## 模組系統（Java 9+）

### 模組宣告

```java
// module-info.java
module com.example.myapp {
    requires com.example.utils;
    exports com.example.api;
}
```

### 使用模組執行

```bash
# 列出模組
java --list-modules

# 顯示模組解析
java --show-module-resolution

# 新增模組路徑
java --module-path lib -m com.example.myapp
```

## 安全

### Keytool 命令

```bash
# 產生金鑰庫
keytool -genkeypair -alias myapp -keyalg RSA -keysize 2048 -validity 365 -keystore keystore.jks

# 列出憑證
keytool -list -keystore keystore.jks

# 匯出憑證
keytool -exportcert -alias myapp -file myapp.crt -keystore keystore.jks
```

### 安全策略

```bash
# 設定安全策略
java -Djava.security.manager -Djava.security.policy=app.policy MyApp

# 停用安全管理器（Java 17+）
java --add-opens java.base/java.lang=ALL-UNNAMED MyApp
```

## 診斷工具

### jcmd

```bash
# 列出 Java 程式
jcmd -l

# 列印 VM 資訊
jcmd <pid> VM.flags

# 列印系統屬性
jcmd <pid> VM.system_properties
```

### jstack

```bash
# 列印執行緒傾印
jstack <pid>

# 列印帶鎖資訊的執行緒傾印
jstack -l <pid>
```

### jmap / jhsdb

```bash
# 堆傾印
jmap -dump:format=b,file=heap.bin <pid>

# 堆摘要
jmap -heap <pid>

# 類別直方圖
jmap -histo <pid>
```

## Docker

### Dockerfile

```dockerfile
# 建構映像檔
FROM eclipse-temurin:21-jdk-alpine AS build
WORKDIR /app
COPY . .
RUN ./mvnw package -DskipTests

# 執行階段映像檔
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 建構和執行

```bash
docker build -t myapp .
docker run -p 8080:8080 myapp
```

## 最佳實踐

1. **使用 LTS 版本** - 生產環境使用 JDK 21 或 JDK 17
2. **設定適當的堆大小** - 根據應用程式需求進行監控和調整
3. **啟用 GC 日誌記錄** - 用於排查效能問題
4. **使用模組化 JDK** - 使用 jlink 減小容器映像檔大小
5. **保持更新** - 定期套用安全性修補程式

## 相關連結

- [Java 官方文件](https://docs.oracle.com/en/java/javase/)
- [JVM 選項參考](https://docs.oracle.com/en/java/javase/21/tools/java.html)
- [Maven Central](https://maven.apache.org/)
- [Gradle](https://gradle.org/)
