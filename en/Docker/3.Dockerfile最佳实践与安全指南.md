# Dockerfile Best Practices and Security Guide

This guide provides detailed instructions on writing Dockerfiles and container security configuration.

---

## Table of Contents

1. [Dockerfile Writing Best Practices](#dockerfile-writing-best-practices)
2. [Security Configuration Guide](#security-configuration-guide)
3. [Performance Optimization](#performance-optimization)
4. [Practical Examples](#practical-examples)

---

## Dockerfile Writing Best Practices

### 1. Use Specific Version Tags

Avoid using `:latest` tag to ensure reproducible builds:

```dockerfile
# ✅ Recommended: Use specific version
FROM node:18.17.0-alpine

# ❌ Avoid: Using latest
FROM node:latest
```

### 2. Prefer Official Images

Official images are community-verified and receive regular security updates:

```dockerfile
# ✅ Recommended: Official image
FROM python:3.11-slim

# ❌ Avoid: Third-party unverified image
FROM someuser/python:3.11
```

### 3. Use Lightweight Base Images

Choose smaller images to reduce attack surface:

```dockerfile
# ✅ Recommended: alpine image
FROM node:18-alpine

# Alternative: Use distroless
FROM gcr.io/distroless/nodejs:18
```

### 4. Reduce Image Layers

Combine multiple RUN instructions to reduce layers:

```dockerfile
# ✅ Recommended: Combine related operations
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        git \
    && rm -rf /var/lib/apt/lists/*

# ❌ Avoid: Multiple separate RUN instructions
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git
RUN rm -rf /var/lib/apt/lists/*
```

### 5. Arrange Instructions Properly

Put frequently changing instructions later to take advantage of Docker cache:

```dockerfile
# ✅ Recommended: Unchanging parts first
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Changed parts later
COPY . .
CMD ["node", "index.js"]
```

### 6. Use .dockerignore File

Exclude unnecessary files to reduce image size:

```
.git
node_modules
npm-debug.log
Dockerfile
.dockerignore
README.md
docs/
tests/
*.md
.env
.env.*
```

### 7. Don't Run as Root User

Create and use non-root users:

```dockerfile
# Create app user
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# Set file and directory ownership
COPY --chown=appuser:appgroup . .

# Switch to non-root user
USER appuser
```

### 8. Use Multi-stage Builds

Reduce final image size by only including runtime dependencies:

```dockerfile
# Build stage
FROM golang:1.20 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Run stage
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/main .
USER 1001
CMD ["./main"]
```

### 9. Explicitly Declare Ports

Use EXPOSE instruction to declare ports the container listens on:

```dockerfile
# ✅ Recommended: Explicit declaration
EXPOSE 3000
EXPOSE 8080

# Port mapping unchanged when running
docker run -p 3000:3000 myapp
```

### 10. Set Health Checks

Ensure containers run healthily:

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
```

---

## Security Configuration Guide

### 1. Minimize Permissions

```dockerfile
# Create non-root user
RUN adduser -D -g '' appuser
USER appuser
```

### 2. Read-only Filesystem

```bash
docker run --read-only myapp
```

Or using Dockerfile:

```dockerfile
RUN chmod -R a-w /app
```

### 3. Configure Resource Limits

```bash
# Limit memory
docker run -m 512m myapp

# Limit CPU
docker run --cpus="1.5" myapp
```

### 4. Security Scanning

Use Docker Scout or Trivy to scan image vulnerabilities:

```bash
# Install Trivy
brew install trivy

# Scan image
trivy image myapp:latest
```

### 5. Use Secrets for Sensitive Information

Docker Swarm or Kubernetes secrets mechanism:

```yaml
# docker-compose.yml
services:
  app:
    image: myapp
    secrets:
      - db_password

secrets:
  db_password:
    file: ./db_password.txt
```

### 6. Network Isolation

```bash
# Create custom network
docker network create mynetwork

# Container joins network
docker run --network mynetwork myapp
```

### 7. Disable Privileged Mode

```bash
# ❌ Avoid: Avoid using --privileged
docker run --privileged myapp

# ✅ Recommended: Add specific capabilities as needed
docker run --cap-drop ALL --cap-add NET_BIND_SERVICE myapp
```

---

## Performance Optimization

### 1. Use Build Cache

- Arrange instructions properly
- Use .dockerignore
- Copy dependency files before source code

### 2. Parallel Builds

```bash
docker buildx create --name mybuilder
docker buildx use mybuilder
docker buildx build --parallel .
```

### 3. Use BuildKit

```bash
# Enable BuildKit
export DOCKER_BUILDKIT=1
docker build .
```

### 4. Reduce Image Size

```dockerfile
# Clean unnecessary files
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
```

---

## Practical Examples

### Node.js Application

```dockerfile
# Build stage
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Run stage
FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs

COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules

USER nodejs
EXPOSE 3000
CMD ["node", "dist/main.js"]
```

### Python Application

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create non-root user
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 8000
CMD ["python", "main.py"]
```

### Go Application

```dockerfile
# Build stage
FROM golang:1.20-alpine AS builder
RUN apk add --no-cache git
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Run stage
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/main .
EXPOSE 8080
CMD ["./main"]
```

---

## Related Links

- [Dockerfile Official Best Practices](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Docker Security Documentation](https://docs.docker.com/engine/security/)
- [Docker Scout](https://docs.docker.com/scout/)
- [Distroless Images](https://github.com/GoogleContainerTools/distroless)
