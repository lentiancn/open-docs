# Apache APISIX 使用手册

本手册将详细介绍如何使用 APISIX 进行日常的 API 管理工作，包括路由配置、负载均衡、身份验证、限流等核心功能。

## 基本概念

在深入使用之前，需要了解 APISIX 的几个核心概念：

### Route（路由）

路由是 APISIX 最基本的概念，它定义了**请求路径**与**上游服务**之间的映射关系。当你创建一个路由时，实际上是在告诉 APISIX："如果有请求匹配这个路径，就把它转发到那个服务"。

一个简单的路由包含：

- **URI**：请求路径（如 `/api/users`）
- **Upstream**：上游服务地址
- **Plugins**（可选）：需要执行的插件

### Upstream（上游）

上游是一组提供相同服务的节点集合。APISIX 会对这些节点进行负载均衡，将请求分发到不同的节点上。

### Consumer（消费者）

消费者是 API 的使用者，可以是某个应用、用户或服务。消费者需要通过身份验证插件来证明自己的身份。

### Plugin（插件）

插件是 APISIX 扩展功能的方式。APISIX 提供了丰富的内置插件，涵盖认证、限流、监控、安全等各个方面。

## 快速开始

### 创建第一个路由

假设你有一个后端服务运行在 `httpbin.org`，现在想通过 APISIX 来访问它：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "my-first-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  }
}'
```

创建成功后，访问 `http://127.0.0.1:9080/ip` 就会被转发到 `http://httpbin.org/ip`。

### 验证路由

```bash
curl "http://127.0.0.1:9080/ip"
```

预期返回类似：

```json
{
  "origin": "183.94.122.205"
}
```

## 负载均衡

APISIX 支持多种负载均衡策略，可以根据实际需求选择合适的算法。

### 加权轮询

可以为不同节点设置不同的权重，权重越高的节点接收的请求越多：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "weighted-route",
  "uri": "/headers",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 3,
      "service-b:8080": 1
    }
  }
}'
```

这个配置表示：service-a 接收 75% 的请求，service-b 接收 25% 的请求。

### 一致性哈希

对于需要会话保持的场景，可以使用一致性哈希算法：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "hash-route",
  "uri": "/user/*",
  "upstream": {
    "type": "chash",
    "key": "remote_addr",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    }
  }
}'
```

### 健康检查

APISIX 支持对上游节点进行健康检查，自动剔除故障节点：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "health-check-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "successes": 2
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    }
  }
}'
```

## 身份验证

APISIX 提供了多种身份验证插件来保护你的 API。

### API 密钥验证

这是最简单也是最常用的身份验证方式：

**第一步：创建消费者**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "tom",
  "plugins": {
    "key-auth": {
      "key": "secret-key-123"
    }
  }
}'
```

**第二步：在路由上启用密钥验证**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "key-auth": {}
  }
}'
```

**第三步：携带密钥访问**

```bash
# 不带密钥，会被拒绝
curl "http://127.0.0.1:9080/ip"
# 返回：401 Unauthorized

# 带正确密钥，可以访问
curl "http://127.0.0.1:9080/ip" -H "apikey: secret-key-123"
# 返回：200 OK
```

### JWT 认证

对于需要更复杂权限控制的场景，可以使用 JWT：

```bash
# 创建消费者并启用 JWT
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "alice",
  "plugins": {
    "jwt-auth": {
      "key": "user-key",
      "secret": "my-secret"
    }
  }
}'

# 获取 JWT Token（需要后端服务生成）
# 之后在请求中携带：Authorization: Bearer <jwt-token>
```

## 限流

APISIX 提供了多种限流插件，可以从不同维度限制请求频率。

### 基于请求数量的限流

限制单位时间内的请求数量：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

这个配置表示：每个 IP 在 60 秒内最多只能发送 100 个请求，超过的请求会返回 503 错误。

### 基于请求速率的限流

限制请求的处理速度：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-req": {
      "rate": 100,
      "burst": 50,
      "rejected_code": 429
    }
  }
}'
```

### 基于并发连接的限流

限制同时建立的连接数：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-conn": {
      "conn": 100,
      "burst": 50,
      "rejected_code": 503
    }
  }
}'
```

## 请求改写

APISIX 可以在请求转发前对其进行修改。

### 修改请求路径

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "rewrite-route",
  "uri": "/api/v1/*",
  "plugins": {
    "proxy-rewrite": {
      "uri": "/$uri"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 修改请求头

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "header-route",
  "uri": "/proxy",
  "plugins": {
    "proxy-rewrite": {
      "headers": {
        "X-Custom-Header": "custom-value",
        "X-Request-ID": "$request_id"
      }
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## 灰度发布

通过配置两个不同的上游服务，可以实现平滑的流量切换。

### 基于权重的灰度发布

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "canary-route",
  "uri": "/api/*",
  "plugins": {
    "traffic-split": {
      "rules": [
        {
          "weighted_upstream": [
            {
              "upstream": {
                "name": "v1",
                "nodes": {
                  "v1-service:8080": 100
                }
              },
              "weight": 90
            },
            {
              "upstream": {
                "name": "v2",
                "nodes": {
                  "v2-service:8080": 100
                }
              },
              "weight": 10
            }
          ]
        }
      ]
    }
  }
}'
```

这个配置表示：90% 的流量发送到 v1 版本，10% 的流量发送到 v2 版本。

## 熔断器

当上游服务出现故障时，熔断器可以自动停止向故障节点发送请求，防止故障扩散。

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "circuit-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "passive": {
        "type": "http",
        "healthy": {
          "successes": 3
        },
        "unhealthy": {
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}'
```

## 监控与日志

### Prometheus 监控

启用 Prometheus 插件来收集指标：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "monitor-route",
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

获取指标数据：

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 请求日志

将请求日志发送到外部日志系统：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "log-route",
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## 常用管理命令

### 查看所有路由

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有上游

```bash
curl "http://127.0.0.1:9180/apisix/admin/upstreams" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有消费者

```bash
curl "http://127.0.0.1:9180/apisix/admin/consumers" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有插件

```bash
curl "http://127.0.0.1:9180/apisix/admin/plugins" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 删除路由

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X DELETE
```

### 更新路由

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PUT -d '
{
  "uri": "/new-path",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "new-backend:8080": 1
    }
  }
}'
```

## 最佳实践

1. **生产环境务必修改 API Key**：默认的 Admin API Key 是公开的，生产环境必须修改。

2. **使用 HTTPS**：生产环境应启用 SSL/TLS 加密。

3. **启用健康检查**：配置上游健康检查可以提高系统稳定性。

4. **合理设置限流值**：根据实际业务需求和后端服务能力设置合理的限流阈值。

5. **做好日志备份**：将重要日志发送到独立的日志系统，便于问题排查。

6. **定期备份配置**：定期备份 etcd 中的配置数据。
