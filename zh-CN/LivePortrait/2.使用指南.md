# LivePortrait 使用指南

LivePortrait 是一个高效的人像动画框架，使用驱动视频中的运动为静态肖像制作动画。它支持拼接和重定向控制。

## 快速开始

### 基本命令

```bash
# 视频驱动动画
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results
```

### 带拼接

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results \
  --stitching
```

### 带眼睛/嘴唇重定向

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## 命令参数

### 输入参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--source_image` | 输入肖像图片路径 | 必需 |
| `--driving_video` | 驱动视频路径 | 可选 |
| `--driven_audio` | 驱动音频路径 | 可选 |
| `--result_dir` | 输出目录 | ./results |

### 处理参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--stitching` | 启用拼接 | False |
| `--eye_retargeting` | 眼睛重定向 (0-1) | 0 |
| `--lip_retargeting` | 嘴唇重定向 (0-1) | 0 |
| `--face_parser` | 启用面部解析 | True |

### 性能参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--batch_size` | 批处理大小 | 1 |
| `--fps` | 输出视频帧率 | 30 |

## 使用示例

### 示例 1：基本视频驱动动画

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/basic
```

### 示例 2：带拼接

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/stitching \
  --stitching
```

### 示例 3：眼睛控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/eyes \
  --eye_retargeting 0.8
```

### 示例 4：嘴唇同步控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/lips \
  --lip_retargeting 0.7
```

### 示例 5：完整控制

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/full \
  --stitching \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Python API

### 基本用法

```python
from liveportrait import LivePortrait

# 初始化
lp = LivePortrait()

# 制作肖像动画
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.5,
    lip_retargeting=0.5
)

print(f"视频保存至: {result}")
```

### 高级用法

```python
from liveportrait import LivePortrait
import torch

# 使用自定义设置初始化
lp = LivePortrait(
    checkpoint_path="pretrained_models/liveportrait.pth",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# 生成带完整控制
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.8,
    lip_retargeting=0.8,
    output_fps=30,
    output_resolution=(512, 512)
)
```

### 批量处理

```python
from liveportrait import LivePortrait
import os

lp = LivePortrait()

# 处理多张图片
source_dir = "source_images/"
driving_video = "driving.mp4"

for image_file in os.listdir(source_dir):
    if image_file.endswith(('.jpg', '.png')):
        result = lp.animate(
            source_image=os.path.join(source_dir, image_file),
            driving_video=driving_video,
            stitching=True
        )
```

## Web 界面

### 运行 Web 演示

```bash
python app.py
```

然后在浏览器中打开 http://localhost:7860

### Web 界面功能

1. **源图像上传** - 上传肖像图片
2. **驱动视频上传** - 选择驱动视频
3. **拼接开关** - 启用/禁用拼接
4. **眼睛控制** - 调整眼睛运动强度
5. **嘴唇控制** - 调整嘴唇同步强度
6. **生成** - 创建动画
7. **下载** - 保存结果

## 功能

### 1. 拼接

拼接模块将生成的头部与身体无缝连接：

```bash
--stitching
```

- 头部和身体之间的平滑过渡
- 适用于各种图像风格（写实、油画、雕塑、3D）

### 2. 眼睛重定向

使用标量值控制眼睛睁开程度 (0-1)：

```bash
--eye_retargeting 0.5
```

- 0: 闭眼
- 1: 完全睁眼
- 0.5: 自然

### 3. 嘴唇重定向

控制嘴唇运动强度：

```bash
--lip_retargeting 0.5
```

- 0: 最小运动
- 1: 最大运动
- 0.5: 自然

## 输入要求

### 源图像

- 格式：JPG、PNG
- 分辨率：建议 512x512 或更大
- 人脸：正面、清晰
- 背景：任意

### 驱动视频

- 格式：MP4、AVI
- 时长：1-60 秒
- 分辨率：任意
- 人脸：清晰的面部表情

## 输出

### 视频格式

- 格式：MP4
- 编解码器：H.264
- 分辨率：512x512
- 帧率：30

### 输出目录

```
results/
├── output.mp4          # 生成的视频
└── (临时文件)
```

## 故障排除

### 动画质量差

**解决方案：**
- 使用更高质量的源图像
- 确保驱动视频有清晰的人脸
- 调整重定向参数

### 未检测到人脸

**解决方案：**
- 使用更清晰的肖像图像
- 确保人脸可见
- 检查图像格式

### 处理缓慢

**解决方案：**
- 降低输出分辨率
- 如不需要则禁用拼接
- 使用 GPU 加速

### GPU 内存不足

**解决方案：**
- 将批处理大小减小到 1
- 使用更小的图像大小
- 关闭其他 GPU 应用程序

## 性能提示

### 更快的处理

1. 如不需要则禁用拼接
2. 使用较低的输出分辨率
3. 降低 fps

### 更好的质量

1. 启用拼接
2. 使用高质量源图像
3. 调整重定向参数

## 相关链接

- [GitHub](https://github.com/KwaiVGI/LivePortrait)
- [论文](https://arxiv.org/abs/2407.03168)
- [演示](https://liveportrait.github.io)
