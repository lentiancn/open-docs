# APISIX User Manual

APISIX core features and usage tips.

## Basic Concepts

### Core Terminology

- **Route**: Defines request matching rules
- **Upstream**: Actual backend services
- **Service**: Collection of routes
- **Plugin**: Request processing logic
- **Consumer**: API consumer

### Request Flow

1. Client sends request to APISIX
2. APISIX matches route rules
3. Execute plugin logic
4. Forward to upstream service
5. Return response to client

## Route Management

### Create Route

Via Admin API:

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "1",
    "uri": "/api/users/*",
    "name": "user-api",
    "methods": ["GET", "POST"],
    "hosts": ["api.example.com"],
    "remote_addr": "192.168.1.0/24",
    "upstream": {
      "type": "roundrobin",
      "nodes": {
        "backend1.example.com:8080": 1,
        "backend2.example.com:8080": 2
      },
      "timeout": {
        "connect": 5,
        "send": 5,
        "read": 5
      }
    },
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "key_by": "remote_addr"
      }
    }
  }'
```

### Route Parameters

| Parameter | Description | Required |
|-----------|-------------|----------|
| id | Route unique identifier | Yes |
| uri | Match URI | Yes |
| name | Route name | No |
| methods | HTTP methods | No |
| hosts | Match domains | No |
| remote_addr | Client IP | No |
| upstream | Upstream config | Yes |
| plugins | Plugin config | No |
| priority | Priority | No |
| labels | Labels | No |

### Route Matching

**Exact Match:**

```json
{
  "uri": "/api/users"
}
```

**Prefix Match:**

```json
{
  "uri": "/api/*"
}
```

**Regex Match:**

```json
{
  "uri": "/api/users/[0-9]+"
}
```

**Multiple URI:**

```json
{
  "uri": ["/api/users", "/api/products", "/api/orders"]
}
```

## Upstream Management

### Create Upstream

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/upstreams/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "id": "1",
    "type": "roundrobin",
    "nodes": {
      "host1.example.com:8080": 1,
      "host2.example.com:8080": 1,
      "host3.example.com:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "http_statuses": [200, 201]
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    },
    "retry_timeout": 10,
    "keepalive_pool": {
      "size": 10
    }
  }'
```

### Load Balancing

**Roundrobin (Default):**

```json
{
  "type": "roundrobin"
}
```

**Weighted Roundrobin:**

```json
{
  "type": "roundrobin",
  "nodes": {
    "host1:8080": 10,
    "host2:8080": 5
  }
}
```

**Consistent Hashing:**

```json
{
  "type": "chash",
  "key": "remote_addr",
  "nodes": {
    "host1:8080": 1,
    "host2:8080": 1
  }
}
```

## Plugin Usage

### Common Plugins

APISIX has 70+ built-in plugins:

**Traffic Control:**
- limit-req: Request rate limiting
- limit-conn: Connection limit
- limit-count: Count rate limiting

**Authentication:**
- jwt-auth: JWT authentication
- key-auth: Key authentication
- basic-auth: Basic authentication
- oauth2: OAuth 2.0

**Request Processing:**
- proxy-rewrite: Request rewrite
- redirect: Redirection
- rewrite: URI rewrite

**Response Processing:**
- response-rewrite: Response rewrite
- proxy-mirror: Request mirroring
- gzip: Response compression

**Logging/Monitoring:**
- logging: Logging
- prometheus: Metrics monitoring
- skywalking: Distributed tracing

### Using Rate Limit Plugin

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "rejected_code": 503,
        "key_by": "remote_addr"
      },
      "limit-count": {
        "count": 1000,
        "time_window": 60,
        "rejected_code": 503,
        "key": "remote_addr"
      }
    }
  }'
```

### Using JWT Authentication

**1. Create Consumer:**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/consumers \
  -H "X-API-KEY: 123456" \
  -d '{
    "username": "john",
    "plugins": {
      "jwt-auth": {
        "key": "user-key",
        "secret": "my-secret-key"
      }
    }
  }'
```

**2. Enable Auth on Route:**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "jwt-auth": {}
    }
  }'
```

**3. Get Token:**

```bash
curl -X GET http://127.0.0.1:9180/apisix/plugin/jwt/sign?key=user-key
```

## Service Discovery

### Eureka

```json
{
  "service_discovery": {
    "type": "eureka",
    "eureka": {
      "host": ["http://127.0.0.1:8761"],
      "prefix": "/eureka/",
      "fetch_interval": 30,
      "weight": 100
    }
  }
}
```

### Nacos

```json
{
  "service_discovery": {
    "type": "nacos",
    "nacos": {
      "host": ["http://127.0.0.1:8848"],
      "namespace": "public",
      "group_name": "DEFAULT_GROUP"
    }
  }
}
```

### Consul

```json
{
  "service_discovery": {
    "type": "consul",
    "consul": {
      "host": ["http://127.0.0.1:8500"],
      "fetch_interval": 5
    }
  }
}
```

## Health Checks

### Active Health Check

```json
{
  "upstream": {
    "nodes": {
      "host1:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 5,
          "http_statuses": [200, 201, 202]
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}
```

## Best Practices

### Production Recommendations

1. **Enable Admin API Access Control**
```yaml
apisix:
  admin_api_mtls:
    enabled: true
```

2. **Use Strong Keys**
```yaml
apisix:
  admin_key:
    - name: admin
      key: randomly-generated-strong-key
```

3. **Configure Health Checks**
Ensure automatic upstream failure detection

4. **Set Appropriate Rate Limits**
Avoid blocking legitimate traffic

5. **Enable Caching**
```yaml
apisix:
  enable_cache: true
```

### Debugging Tips

**View Routes:**
```bash
curl http://127.0.0.1:9180/apisix/admin/routes \
  -H "X-API-KEY: 123456"
```

**View Plugins:**
```bash
curl http://127.0.0.1:9180/apisix/admin/plugins \
  -H "X-API-KEY: 123456"
```

**View Error Logs:**
```bash
tail -f logs/error.log
```
