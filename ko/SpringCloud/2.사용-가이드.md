# Spring Cloud 사용 가이드

이 가이드에서는 분산 시스템 개발을 위해 Spring Cloud 구성 요소를 사용하는 방법을 설명합니다.

## 서비스 검색

### Eureka 서버 설정

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

```properties
# application.properties
server.port=8761
eureka.instance.hostname=localhost
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
eureka.client.service-url.defaultZone=http://${eureka.instance.hostname}:${server.port}/eureka/
```

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### Eureka 클라이언트

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

```properties
spring.application.name=my-service
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
eureka.instance.prefer-ip-address=true
```

## API Gateway

### Spring Cloud Gateway

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

```properties
spring.cloud.gateway.routes[0].id=user-service
spring.cloud.gateway.routes[0].uri=lb://user-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/users/**
spring.cloud.gateway.routes[1].id=order-service
spring.cloud.gateway.routes[1].uri=lb://order-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/orders/**
```

### 필터가 있는 Gateway

```java
@Component
public class CustomFilter implements GatewayFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 사전 처리
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            // 사후 처리
        }));
    }
}
```

## 서비스 간 통신

### OpenFeign 클라이언트

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

```java
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/users/{id}")
    User getUserById(@PathVariable("id") Long id);
    
    @GetMapping("/users")
    List<User> getAllUsers();
}

@SpringBootApplication
@EnableFeignClients
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 로드 밸런싱 (Ribbon)

```properties
user-service.ribbon.listOfServers=localhost:8081,localhost:8082
```

## 구성 관리

### Spring Cloud Config 서버

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server</artifactId>
</dependency>
```

```properties
server.port=8888
spring.application.name=config-server
spring.cloud.config.server.git.uri=https://github.com/your-org/config-repo
spring.cloud.config.server.git.default-label=main
```

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```

### 구성 클라이언트

```properties
spring.config.import=optional:configserver:http://localhost:8888
spring.application.name=myapp
```

## 서킷 브레이커

### Resilience4j

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
```

```java
@Service
public class UserService {
    
    @Autowired
    private UserClient userClient;
    
    @CircuitBreaker(name = "userService", fallbackMethod = "fallbackGetUser")
    public User getUserById(Long id) {
        return userClient.getUserById(id);
    }
    
    public User fallbackGetUser(Long id) {
        return new User(); // 기본값 또는 캐시된 사용자 반환
    }
}
```

## 분산 메시징

### Spring Cloud Stream

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream-binder-kafka</artifactId>
</dependency>
```

```java
@Component
public class MessageProducer {
    
    @Autowired
    private Source source;
    
    public void sendMessage(String message) {
        source.output().send(MessageBuilder.withPayload(message).build());
    }
}

@Component
public class MessageConsumer {
    
    @StreamListener(Sink.INPUT)
    public void receiveMessage(String message) {
        System.out.println("수신: " + message);
    }
}
```

```properties
spring.cloud.stream.bindings.input.destination=my-topic
spring.cloud.stream.bindings.output.destination=my-topic
```

## 서비스 모니터링

### Actuator 엔드포인트

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

```properties
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
```

## Docker Compose 예제

```yaml
version: '3.8'
services:
  eureka:
    image: spring-cloud/eureka-server
    ports:
      - "8761:8761"
  
  config-server:
    image: spring-cloud/config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_CLOUD_CONFIG_SERVER_GIT_URI=https://github.com/your-org/config
  
  gateway:
    image: myapp/gateway
    ports:
      - "8080:8080"
    depends_on:
      - eureka
      - config-server
```

## 모범 사례

1. **릴리스 트레인 사용**: 항상 호환되는 Spring Boot 및 Spring Cloud 버전 사용
2. **상태 확인 활성화**: 모든 서비스에 Actuator health 엔드포인트 구성
3. **Config 서버 사용**: 관리를 쉽게 하기 위해 구성 중앙화
4. **서킷 브레이커 구현**: 연쇄적 실패 방지
5. **추적 활성화**: 분산 추적을 위해 Spring Cloud Sleuth 사용

## 관련 링크

- [Spring Cloud 공식](https://spring.io/projects/spring-cloud)
- [Spring Cloud Netflix](https://cloud.spring.io/spring-cloud-netflix/)
- [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-gateway/)
- [Spring Cloud OpenFeign](https://cloud.spring.io/spring-cloud-openfeign/)
