# Angular 使用手册

本手册涵盖 Angular 开发从基础到高级的所有方面。

---

## 目录

1. [简介](#简介)
2. [项目结构](#项目结构)
3. [组件](#组件)
4. [模板](#模板)
5. [服务](#服务)
6. [路由](#路由)
7. [表单](#表单)
8. [HTTP 客户端](#http-客户端)
9. [状态管理](#状态管理)
10. [测试](#测试)
11. [构建和部署](#构建和部署)
12. [最佳实践](#最佳实践)

---

## 简介

### 什么是 Angular？

Angular 是由 Google 开发的基于 TypeScript 的开源 Web 应用框架。它为构建现代单页应用（SPA）提供了完整的解决方案。

### 核心特性

- **组件化架构**：使用可复用组件构建应用
- **双向数据绑定**：模型和视图自动同步
- **依赖注入**：高效的服务管理
- **路由**：客户端导航
- **表单**：强大的表单处理和验证
- **HTTP 客户端**：与后端服务通信
- **测试**：内置测试工具
- **跨平台**：Web、移动 Web、原生移动端和桌面端

---

## 项目结构

### 标准目录结构

```
my-app/
├── src/
│   ├── app/
│   │   ├── components/        # 可复用组件
│   │   ├── pages/             # 页面级组件
│   │   ├── services/          # Angular 服务
│   │   ├── models/            # 数据模型/接口
│   │   ├── guards/            # 路由守卫
│   │   ├── interceptors/      # HTTP 拦截器
│   │   ├── pipes:             # 自定义管道
│   │   ├── directives:        # 自定义指令
│   │   ├── app.component.ts   # 根组件
│   │   ├── app.config.ts      # 应用配置（独立组件）
│   │   ├── app.routes.ts      # 应用路由
│   │   └── main.ts            # 应用入口
│   ├── assets/                # 静态文件
│   ├── environments/          # 环境配置
│   ├── styles.css             # 全局样式
│   └── index.html             # 主 HTML 文件
├── angular.json               # Angular CLI 配置
├── package.json               # NPM 依赖
└── tsconfig.json              # TypeScript 配置
```

---

## 组件

### 创建组件

```bash
# 使用 Angular CLI
ng generate component components/user-list
# 或
ng g c components/user-list
```

### 组件示例

```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-user-card',
  templateUrl: './user-card.component.html',
  styleUrls: ['./user-card.component.css']
})
export class UserCardComponent {
  @Input() user: User | null = null;
  @Output() delete = new EventEmitter<number>();

  onDelete() {
    if (this.user) {
      this.delete.emit(this.user.id);
    }
  }
}
```

### 生命周期钩子

```typescript
import { Component, OnInit, OnDestroy, AfterViewInit } from '@angular/core';

@Component({...})
export class ExampleComponent implements OnInit, OnDestroy, AfterViewInit {
  
  ngOnInit() {
    // 组件初始化后调用一次
  }

  ngAfterViewInit() {
    // 组件视图初始化后调用
  }

  ngOnDestroy() {
    // 组件销毁前调用
    // 清理订阅、定时器等
  }
}
```

### 独立组件（Angular 14+）

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-standalone',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <h1>{{ title }}</h1>
    <button (click)="onClick()">点击</button>
  `
})
export class StandaloneComponent {
  title = '独立组件';
}
```

---

## 模板

### 模板语法

#### 插值
```html
<h1>你好，{{ name }}</h1>
<p>总计：{{ 2 + 3 }}</p>
```

#### 属性绑定
```html
<img [src]="imageUrl" [alt]="imageAlt">
<button [class.active]="isActive">点击</button>
```

#### 事件绑定
```html
<button (click)="onClick()">点击我</button>
<input (input)="onInput($event)">
```

#### 双向绑定
```html
<input [(ngModel)]="username" name="username">
```

### 结构指令

#### *ngIf
```html
<div *ngIf="isLoggedIn">
  欢迎，{{ username }}！
</div>

<div *ngIf="isLoggedIn; else loggedOut">欢迎！</div>
<ng-template #loggedOut>请登录。</ng-template>
```

#### *ngFor
```html
<li *ngFor="let user of users; let i = index">
  {{ i + 1 }}. {{ user.name }}
</li>

<!-- 使用 trackBy 提升性能 -->
<li *ngFor="let user of users; trackBy: trackById">
```

#### *ngSwitch
```html
<div [ngSwitch]="status">
  <p *ngSwitchCase="'pending'">待处理...</p>
  <p *ngSwitchCase="'approved'">已批准！</p>
  <p *ngSwitchDefault>未知状态</p>
</div>
```

### 管道

```html
<p>{{ today | date:'fullDate' }}</p>
<p>{{ price | currency:'CNY' }}</p>
<p>{{ name | uppercase }}</p>
<p>{{ text | slice:0:10 }}</p>
```

---

## 服务

### 创建服务

```bash
ng generate service services/user
# 或
ng g s services/user
```

### 服务示例

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { User } from '../models/user';

@Injectable({ providedIn: 'root' })
export class UserService {
  private apiUrl = 'https://api.example.com/users';

  constructor(private http: HttpClient) {}

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl);
  }

  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`);
  }

  createUser(user: User): Observable<User> {
    return this.http.post<User>(this.apiUrl, user);
  }

  updateUser(id: number, user: User): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user);
  }

  deleteUser(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

---

## 路由

### 设置路由

```typescript
// app.routes.ts
import { Routes } from '@angular/router';

export const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { 
    path: 'home', 
    loadComponent: () => import('./pages/home/home.component')
      .then(m => m.HomeComponent) 
  },
  { 
    path: 'users', 
    loadComponent: () => import('./pages/users/users.component')
      .then(m => m.UsersComponent) 
  },
  { 
    path: '**', 
    loadComponent: () => import('./pages/not-found/not-found.component')
      .then(m => m.NotFoundComponent) 
  }
];
```

### 路由参数

```typescript
// 路由：{ path: 'user/:id', ... }

// 在组件中
import { ActivatedRoute } from '@angular/router';

constructor(private route: ActivatedRoute) {}

ngOnInit() {
  this.route.paramMap.subscribe(params => {
    const id = params.get('id');
  });
}
```

### 路由守卫

```typescript
import { Injectable } from '@angular/core';
import { CanActivate, Router } from '@angular/router';

@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(private router: Router) {}

  canActivate(): boolean {
    const isLoggedIn = /* 检查登录状态 */;
    if (!isLoggedIn) {
      this.router.navigate(['/login']);
      return false;
    }
    return true;
  }
}
```

### 懒加载

```typescript
{
  path: 'dashboard',
  loadComponent: () => import('./dashboard/dashboard.component')
    .then(m => m.DashboardComponent)
}
```

---

## 表单

### 模板驱动表单

```typescript
import { Component } from '@angular/core';

@Component({
  selector: 'app-login',
  template: `
    <form #loginForm="ngForm" (ngSubmit)="onSubmit(loginForm)">
      <input type="email" [(ngModel)]="user.email" name="email" required email>
      <input type="password" [(ngModel)]="user.password" name="password" required minlength="6">
      <button type="submit" [disabled]="loginForm.invalid">登录</button>
    </form>
  `
})
export class LoginComponent {
  user = { email: '', password: '' };

  onSubmit(form: any) {
    console.log('表单值：', form.value);
  }
}
```

### 响应式表单

```typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html'
})
export class RegisterComponent implements OnInit {
  registerForm!: FormGroup;

  constructor(private fb: FormBuilder) {}

  ngOnInit() {
    this.registerForm = this.fb.group({
      username: ['', [Validators.required, Validators.minLength(3)]],
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(8)]]
    });
  }

  onSubmit() {
    if (this.registerForm.valid) {
      console.log(this.registerForm.value);
    }
  }
}
```

```html
<form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
  <input formControlName="username">
  <div *ngIf="registerForm.get('username')?.invalid">用户名必填</div>
  <button type="submit" [disabled]="registerForm.invalid">注册</button>
</form>
```

---

## HTTP 客户端

### 配置

```typescript
// app.config.ts（独立组件）
import { ApplicationConfig } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';

export const appConfig: ApplicationConfig = {
  providers: [provideHttpClient()]
};
```

### HTTP 方法

```typescript
constructor(private http: HttpClient) {}

// GET
this.http.get<User[]>(url).subscribe(data => console.log(data));

// POST
this.http.post<User>(url, user).subscribe(newUser => ...);

// PUT
this.http.put<User>(`${url}/${id}`, user).subscribe();

// DELETE
this.http.delete(`${url}/${id}`).subscribe();
```

### HTTP 拦截器

```typescript
import { HttpInterceptorFn } from '@angular/common/http';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const token = localStorage.getItem('token');
  const cloned = req.clone({
    setHeaders: { Authorization: token ? `Bearer ${token}` : '' }
  });
  return next(cloned);
};
```

---

## 状态管理

### 使用服务和 BehaviorSubject

```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class CartService {
  private items$ = new BehaviorSubject<CartItem[]>([]);
  
  getItems(): Observable<CartItem[]> {
    return this.items$.asObservable();
  }
  
  addItem(item: CartItem) {
    this.items$.next([...this.items$.value, item]);
  }
  
  removeItem(id: number) {
    this.items$.next(this.items$.value.filter(i => i.id !== id));
  }
}
```

### 使用 Signals（Angular 16+）

```typescript
import { Component, signal, computed } from '@angular/core';

@Component({...})
export class CounterComponent {
  count = signal(0);
  doubled = computed(() => this.count() * 2);
  
  increment() {
    this.count.update(c => c + 1);
  }
}
```

---

## 测试

### 单元测试

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { UserListComponent } from './user-list.component';
import { UserService } from '../services/user.service';
import { of } from 'rxjs';

describe('UserListComponent', () => {
  let component: UserListComponent;
  let fixture: ComponentFixture<UserListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [UserListComponent],
      providers: [
        { provide: UserService, useValue: jasmine.createSpyObj('UserService', ['getUsers']) }
      ]
    }).compileComponents();

    fixture = TestBed.createComponent(UserListComponent);
    component = fixture.componentInstance;
  });

  it('应该创建', () => {
    expect(component).toBeTruthy();
  });

  it('应该加载用户', () => {
    const userService = TestBed.inject(UserService);
    userService.getUsers.and.returnValue(of([{ id: 1, name: '张三' }]));
    
    component.ngOnInit();
    
    expect(component.users.length).toBe(1);
  });
});
```

---

## 构建和部署

### 开发构建
```bash
ng build
ng serve
```

### 生产构建
```bash
ng build --configuration production
# 或
ng build -c production
```

### 部署选项

#### Netlify
```bash
npm install -g netlify-cli
netlify deploy --prod --dir=dist/your-app
```

#### Vercel
```bash
npm i -g vercel
vercel --prod
```

#### Docker
```dockerfile
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build -- --configuration production

FROM nginx:alpine
COPY --from=build /app/dist/your-app/browser /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## 最佳实践

### 项目结构
```
src/app/
├── core/           # 单例服务、守卫
├── shared/         # 可复用组件、管道、指令
├── features:       # 功能模块
└── app.component.ts
```

### 性能优化
1. 使用 OnPush 变更检测
2. 在 *ngFor 中实现 trackBy
3. 懒加载路由
4. 使用 signals 管理状态
5. 取消订阅 observable（或使用 async 管道）

### 代码规范
- 使用严格 TypeScript
- 遵循 Angular 风格指南
- 使用独立组件
- 保持组件小而专注

---

## 其他资源

- 官方网站：https://angular.io/
- 文档：https://angular.io/docs
- CLI 参考：https://angular.io/cli
- GitHub：https://github.com/angular/angular

---

*最后更新：2024*
