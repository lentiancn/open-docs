# APISIX 常见问题

常见问题解答。

## 安装问题

### Q: Docker 容器无法启动？

**解决方案**：
1. 确认 Docker 已安装并运行
```bash
docker --version
docker ps
```
2. 检查端口是否被占用
```bash
netstat -tlnp | grep 9080
netstat -tlnp | grep 2379
```
3. 查看容器日志
```bash
docker logs apisix
docker logs etcd
```
4. 确认 etcd 正常运行

### Q: 启动失败，提示 etcd 连接失败？

**解决方案**：
1. 确认 etcd 已启动
```bash
docker ps | grep etcd
```
2. 检查 etcd 是否在监听正确端口
```bash
curl http://127.0.0.1:2379/version
```
3. 检查配置文件中的 etcd 地址是否正确
4. 如果使用 Docker，确保网络互通

### Q: 端口被占用？

**解决方案**：
1. 查找占用端口的进程
```bash
lsof -i:9080
netstat -tlnp | grep 9080
```
2. 杀掉占用进程或修改 APISIX 端口配置
```yaml
apisix:
  node_listen: 9081
```

### Q: 安装依赖失败？

**解决方案**：
1. 确认系统已安装基础开发工具
2. Ubuntu/Debian:
```bash
sudo apt-get update
sudo apt-get install -y build-essential
```
3. CentOS/RHEL:
```bash
sudo yum install -y gcc gcc-c++
```

## 使用问题

### Q: 路由不生效？

**解决方案**：
1. 检查路由配置格式是否正确
```bash
curl http://127.0.0.1:9180/apisix/admin/routes \
  -H "X-API-KEY: 123456"
```
2. 确认路由已正确创建
3. 检查 URI 匹配规则是否正确
4. 查看 APISIX 错误日志
```bash
tail -f logs/error.log
```
5. 使用调试模式查看请求匹配过程

### Q: 插件不生效？

**解决方案**：
1. 确认插件已启用
```bash
curl http://127.0.0.1:9180/apisix/admin/plugins \
  -H "X-API-KEY: 123456"
```
2. 检查插件配置格式
3. 确认插件依赖满足（如 JWT 需要先创建 Consumer）
4. 检查插件执行顺序
5. 查看日志中的插件错误信息

### Q: 上游服务无法访问？

**解决方案**：
1. 确认上游服务正常运行
2. 检查网络连通性
```bash
curl -v http://backend.example.com:8080
```
3. 检查上游配置中的地址和端口
4. 检查防火墙规则
5. 查看负载均衡配置

### Q: 响应时间很长？

**解决方案**：
1. 检查上游服务响应时间
2. 开启连接池复用
```json
{
  "keepalive_pool": {
    "size": 10
  }
}
```
3. 减少不必要的插件
4. 检查是否有大量请求排队

### Q: 如何实现灰度发布？

**解决方案**：
使用 traffic 插件实现：

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "traffic": {
        "rules": [
          {
            "match": [
              {"vars": [["http_header", "X-Version", "==", "v2"]]}
            ],
            "weight": 50
          }
        ]
      }
    }
  }'
```

## 配置问题

### Q: 如何配置 SSL/TLS 证书？

**解决方案**：
1. 上传 SSL 证书
```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/ssls/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "cert": "证书内容",
    "key": "私钥内容",
    "sni": "example.com"
  }'
```
2. 绑定到路由
```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "ssl": {
        "ssl_cert": "证书路径"
      }
    }
  }'
```

### Q: 如何配置跨域（CORS）？

**解决方案**：
使用 cors 插件：

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "cors": {}
    }
  }'
```

或手动配置：

```json
{
  "plugins": {
    "proxy-rewrite": {
      "headers": {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET,POST,PUT,DELETE",
        "Access-Control-Allow-Headers": "Authorization"
      }
    }
  }
}
```

### Q: 如何使用环境变量？

**解决方案**：
支持在配置中使用环境变量：

```yaml
apisix:
  node_listen: ${APISIX_PORT}
etcd:
  host:
    - ${ETCD_HOST}
```

## 性能问题

### Q: 内存占用越来越高？

**解决方案**：
1. 检查是否有内存泄漏的插件
2. 限制缓冲区大小
```yaml
apisix:
  proxy_buffering: off
```
3. 定期清理日志

### Q: CPU 使用率高？

**解决方案**：
1. 检查是否有大量请求
2. 优化正则匹配规则
3. 减少插件数量
4. 使用连接池

### Q: 如何提高并发能力？

**解决方案**：
1. 增加 worker 进程数
```nginx
worker_processes auto;
worker_rlimit_nofile 65440;
```
2. 调整连接数限制
```nginx
worker_connections 10240;
```
3. 启用 keepalive
```json
{
  "keepalive": 32
}
```

## 安全问题

### Q: 如何保护 Admin API？

**解决方案**：
1. 使用强密钥
2. 限制访问 IP
```yaml
apisix:
  allow_admin:
    - 127.0.0.1
    - 10.0.0.0/8
```
3. 启用 HTTPS
4. 使用 ACL 控制

### Q: 如何防止被攻击？

**解决方案**：
1. 启用限流插件
2. 启用 IP 黑名单
3. 启用防火墙
4. 监控异常请求

## 学习资源

### Q: 哪里学习 APISIX？

- 官方文档：https://apisix.apache.org/docs
- GitHub：https://github.com/apache/apisix
- 官方博客：https://apisix.apache.org/blog
- 视频教程：Bilibili、YouTube

### Q: 如何获取帮助？

- 提交 Issue：https://github.com/apache/apisix/issues
- 社区论坛：https://apisix.discourse.group
- Slack：加入 Apache APISIX 频道

### Q: 如何贡献代码？

- 查阅贡献指南：https://apisix.apache.org/docs/general/contributor-guide
- 从 good first issue 开始：https://github.com/apache/apisix/labels/good%20first%20issue
