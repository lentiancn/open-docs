# Kubernetes 使用手册

本手册介绍 Kubernetes 的核心概念和实际使用方法。

## Pod 管理

### 创建 Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
spec:
  containers:
  - name: myapp
    image: nginx:latest
    ports:
    - containerPort: 80
    env:
    - name: NODE_ENV
      value: "production"
```

```bash
kubectl apply -f pod.yaml
kubectl get pods
kubectl describe pod myapp-pod
kubectl logs myapp-pod
kubectl delete pod myapp-pod
```

### 多容器 Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-pod
spec:
  containers:
  - name: nginx
    image: nginx:latest
  - name: sidecar
    image: busybox
    command: ['sh', '-c', 'tail -f /dev/null']
```

## Deployment 管理

### 创建 Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:v1
        ports:
        - containerPort: 80
        resources:
          limits:
            memory: "128Mi"
            cpu: "500m"
          requests:
            memory: "64Mi"
            cpu: "250m"
```

```bash
# 部署
kubectl apply -f deployment.yaml

# 查看状态
kubectl get deployments
kubectl get rs
kubectl get pods -l app=myapp

# 扩缩容
kubectl scale deployment myapp-deployment --replicas=5

# 更新镜像
kubectl set image deployment/myapp-deployment myapp=myapp:v2

# 回滚
kubectl rollout undo deployment/myapp-deployment

# 查看历史
kubectl rollout history deployment/myapp-deployment
```

### 更新策略

```yaml
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
```

## Service 管理

### 创建 Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  type: ClusterIP
```

### Service 类型

```yaml
# ClusterIP（默认）
type: ClusterIP

# NodePort
type: NodePort
nodePort: 30080

# LoadBalancer
type: LoadBalancer

# ExternalName
type: ExternalName
externalName: mydb.example.com
```

```bash
# 查看 Service
kubectl get services

# 描述 Service
kubectl describe service myapp-service

# 删除 Service
kubectl delete service myapp-service
```

## ConfigMap 和 Secret

### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
data:
  database_url: "postgres://db:5432/myapp"
  cache_enabled: "true"
```

```bash
# 使用环境变量
env:
- name: DATABASE_URL
  valueFrom:
    configMapKeyRef:
      name: myapp-config
      key: database_url

# 使用文件挂载
volumeMounts:
- name: config
  mountPath: /etc/config
volumes:
- name: config
  configMap:
    name: myapp-config
```

### Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  username: admin
  password: secret
```

```bash
# 使用 Secret
env:
- name: USERNAME
  valueFrom:
    secretKeyRef:
      name: myapp-secret
      key: username
```

## Ingress

### 创建 Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80
```

```bash
kubectl get ingress
kubectl describe ingress myapp-ingress
```

## 存储

### PersistentVolume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/mnt/data"
```

### PersistentVolumeClaim

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

```yaml
# 使用 PVC
volumes:
- name: storage
  persistentVolumeClaim:
    claimName: my-pvc
```

## 资源配额

### ResourceQuota

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: my-quota
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    pods: "10"
```

### LimitRange

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: my-limits
spec:
  limits:
  - max:
      cpu: "2"
      memory: "1Gi"
    min:
      cpu: "100m"
      memory: "128Mi"
    default:
      cpu: "500m"
      memory: "512Mi"
    defaultRequest:
      cpu: "200m"
      memory: "256Mi"
    type: Container
```

## 探针

### Liveness Probe

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
```

### Readiness Probe

```yaml
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
```

### Startup Probe

```yaml
startupProbe:
  httpGet:
    path: /started
    port: 8080
  failureThreshold: 30
  periodSeconds: 10
```

## 任务和定时任务

### Job

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: myjob
spec:
  template:
    spec:
      containers:
      - name: job
        image: busybox
        command: ['sh', '-c', 'echo Job running']
      restartPolicy: OnFailure
  backoffLimit: 4
```

### CronJob

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mycronjob
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cronjob
            image: busybox
            command: ['sh', '-c', 'echo Running']
          restartPolicy: OnFailure
```

## 总结

本手册涵盖了 Kubernetes 开发的常用操作：

- **Pod**：创建、管理
- **Deployment**：部署、更新、回滚
- **Service**：服务发现、负载均衡
- **ConfigMap/Secret**：配置管理
- **Ingress**：HTTP 路由
- **存储**：PV、PVC
- **配额**：ResourceQuota、LimitRange
- **探针**：健康检查
- **任务**：Job、CronJob

掌握这些内容后，你就可以熟练使用 Kubernetes 了。
