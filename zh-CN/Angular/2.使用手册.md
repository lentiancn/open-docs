# Angular 使用手册

本文档详细介绍 Angular 框架的核心概念、组件开发、服务使用、路由配置等日常开发内容。

---

## 目录

1. [Angular 核心概念](#angular-核心概念)
2. [组件开发](#组件开发)
3. [模板语法](#模板语法)
4. [服务与依赖注入](#服务与依赖注入)
5. [路由与导航](#路由与导航)
6. [表单处理](#表单处理)
7. [HTTP 通信](#http-通信)
8. [状态管理](#状态管理)
9. [样式与样式表](#样式与样式表)
10. [测试](#测试)
11. [构建与部署](#构建与部署)
12. [最佳实践](#最佳实践)

---

## Angular 核心概念

### 模块 (Module)

Angular 应用由模块组成，模块将相关的组件、服务、指令、管道组织在一起。

```typescript
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { AppComponent } from './app.component';

@NgModule({
  declarations: [
    AppComponent
  ],
  imports: [
    BrowserModule
  ],
  providers: [],
  bootstrap: [AppComponent]
})
export class AppModule { }
```

### 组件 (Component)

组件是 Angular 应用的基本构建块，负责控制屏幕上的一小块区域（视图）。

```typescript
import { Component } from '@angular/core';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent {
  title = '我的第一个 Angular 应用';
}
```

### 组件模板 (Template)

组件的视图模板定义了用户界面的结构。

```html
<div>
  <h1>{{ title }}</h1>
  <app-child-component></app-child-component>
</div>
```

### 数据绑定

Angular 支持多种数据绑定方式：

| 绑定类型 | 语法 | 说明 |
|----------|------|------|
| 插值绑定 | `{{ value }}` | 单向绑定，从组件到视图 |
| 属性绑定 | `[property]="value"` | 单向绑定，从组件到 DOM 属性 |
| 事件绑定 | `(event)="handler()"` | 单向绑定，从视图到组件 |
| 双向绑定 | `[(ngModel)]="value"` | 双向绑定 |

### 指令 (Directive)

指令用于增强模板的功能。

#### 结构指令

```html
<!-- *ngIf：条件渲染 -->
<div *ngIf="isLoggedIn">欢迎回来！</div>

<!-- *ngFor：循环渲染 -->
<ul>
  <li *ngFor="let item of items">{{ item.name }}</li>
</ul>

<!-- ngSwitch：switch 选择 -->
<div [ngSwitch]="status">
  <div *ngSwitchCase="'active'">活跃</div>
  <div *ngSwitchCase="'inactive'">不活跃</div>
  <div *ngSwitchDefault>未知</div>
</div>
```

#### 属性指令

```html
<!-- ngClass：动态添加 CSS 类 -->
<div [ngClass]="{'active': isActive, 'disabled': isDisabled}">

<!-- ngStyle：动态设置样式 -->
<div [ngStyle]="{'color': textColor, 'font-size': fontSize + 'px'}">
```

---

## 组件开发

### 创建组件

使用 Angular CLI 创建组件：

```bash
ng generate component user-profile
# 或简写
ng g c user-profile
```

### 组件通信

#### 父组件向子组件传值（输入属性）

```typescript
// 子组件
import { Component, Input } from '@angular/core';

@Component({
  selector: 'app-user-card',
  template: '<h2>{{ userName }}</h2>'
})
export class UserCardComponent {
  @Input() userName: string = '';
  @Input() userAge?: number;
}
```

```html
<!-- 父组件模板 -->
<app-user-card [userName]="'张三'" [userAge]="25"></app-user-card>
```

#### 子组件向父组件传值（输出属性）

```typescript
// 子组件
import { Component, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-counter',
  template: '<button (click)="increment()">增加</button>'
})
export class CounterComponent {
  @Output() countChange = new EventEmitter<number>();
  count = 0;

  increment() {
    this.count++;
    this.countChange.emit(this.count);
  }
}
```

```typescript
// 父组件
export class AppComponent {
  onCountChange(newCount: number) {
    console.log('计数变化:', newCount);
  }
}
```

```html
<!-- 父组件模板 -->
<app-counter (countChange)="onCountChange($event)"></app-counter>
```

### 生命周期钩子

| 钩子 | 说明 |
|------|------|
| `ngOnInit` | 组件初始化后调用 |
| `ngOnChanges` | 输入属性变化时调用 |
| `ngDoCheck` | 每次变更检测时调用 |
| `ngAfterViewInit` | 视图初始化后调用 |
| `ngOnDestroy` | 组件销毁前调用 |

```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';

export class MyComponent implements OnInit, OnDestroy {
  ngOnInit() {
    console.log('组件初始化');
  }

  ngOnDestroy() {
    console.log('组件销毁');
  }
}
```

---

## 模板语法

### 插值

```html
<h1>{{ title }}</h1>
<p>计算结果：{{ 1 + 1 }}</p>
<p>方法返回值：{{ getMessage() }}</p>
```

### 属性绑定

```html
<img [src]="imageUrl" [alt]="imageAlt">
<button [disabled]="isDisabled">提交</button>
```

### 事件绑定

```html
<button (click)="onSave()">保存</button>
<input (input)="onInput($event)">
```

### 双向绑定

需要导入 `FormsModule`：

```typescript
import { FormsModule } from '@angular/forms';

@NgModule({
  imports: [FormsModule],
})
export class AppModule {}
```

```html
<input [(ngModel)]="username">
<p>你好，{{ username }}！</p>
```

### 管道 (Pipe)

管道用于转换模板中的数据显示格式。

```html
<!-- 日期管道 -->
<p>日期：{{ today | date:'yyyy-MM-dd' }}</p>

<!-- 货币管道 -->
<p>价格：{{ price | currency:'CNY' }}</p>

<!-- 大小写管道 -->
<p>{{ name | uppercase }}</p>

<!-- JSON 管道（调试用） -->
<pre>{{ data | json }}</pre>
```

常用内置管道：
- `date`：日期格式化
- `currency`：货币格式化
- `uppercase` / `lowercase`：大小写转换
- `percent`：百分比格式化
- `decimal`：数字格式化
- `slice`：截取数组或字符串

---

## 服务与依赖注入

### 创建服务

```bash
ng generate service user
# 或简写
ng g s user
```

### 服务示例

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';

export interface User {
  id: number;
  name: string;
  email: string;
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private apiUrl = 'https://api.example.com/users';

  constructor(private http: HttpClient) {}

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl);
  }

  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`);
  }

  createUser(user: Partial<User>): Observable<User> {
    return this.http.post<User>(this.apiUrl, user);
  }
}
```

### 在组件中使用服务

```typescript
import { Component, OnInit } from '@angular/core';
import { UserService, User } from './user.service';

@Component({
  selector: 'app-user-list',
  templateUrl: './user-list.component.html'
})
export class UserListComponent implements OnInit {
  users: User[] = [];

  constructor(private userService: UserService) {}

  ngOnInit() {
    this.userService.getUsers().subscribe(data => {
      this.users = data;
    });
  }
}
```

---

## 路由与导航

### 配置路由

```typescript
import { Routes } from '@angular/router';
import { HomeComponent } from './home/home.component';
import { AboutComponent } from './about/about.component';
import { UserComponent } from './user/user.component';

const routes: Routes = [
  { path: '', component: HomeComponent },
  { path: 'about', component: AboutComponent },
  { path: 'user/:id', component: UserComponent },
  { path: '**', redirectTo: '' }  // 404 重定向
];
```

### 路由出口

```html
<!-- app.component.html -->
<nav>
  <a routerLink="/">首页</a>
  <a routerLink="/about">关于</a>
  <a routerLink="/user/1">用户</a>
</nav>

<router-outlet></router-outlet>
```

### 编程式导航

```typescript
import { Router } from '@angular/router';

export class MyComponent {
  constructor(private router: Router) {}

  goToUser(id: number) {
    this.router.navigate(['/user', id]);
  }

  goToHome() {
    this.router.navigate(['/']);
  }
}
```

### 路由守卫

#### CanActivate（路由守卫）

```typescript
import { Injectable } from '@angular/core';
import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router } from '@angular/router';

@Injectable({
  providedIn: 'root'
})
export class AuthGuard implements CanActivate {
  constructor(private router: Router) {}

  canActivate(
    route: ActivatedRouteSnapshot,
    state: RouterStateSnapshot
  ): boolean {
    const isLoggedIn = /* 判断登录状态 */;
    
    if (!isLoggedIn) {
      this.router.navigate(['/login']);
      return false;
    }
    return true;
  }
}
```

在路由中使用：

```typescript
const routes: Routes = [
  { 
    path: 'admin', 
    component: AdminComponent,
    canActivate: [AuthGuard]
  }
];
```

---

## 表单处理

### 响应式表单

1. 导入模块：

```typescript
import { ReactiveFormsModule } from '@angular/forms';

@NgModule({
  imports: [ReactiveFormsModule],
})
export class AppModule {}
```

2. 创建表单：

```typescript
import { Component } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-login',
  templateUrl: './login.component.html'
})
export class LoginComponent implements OnInit {
  loginForm!: FormGroup;

  constructor(private fb: FormBuilder) {}

  ngOnInit() {
    this.loginForm = this.fb.group({
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(6)]],
      remember: [false]
    });
  }

  onSubmit() {
    if (this.loginForm.valid) {
      console.log('表单值:', this.loginForm.value);
    }
  }
}
```

3. 模板代码：

```html
<form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
  <div>
    <label>邮箱</label>
    <input formControlName="email" type="email">
    <div *ngIf="loginForm.get('email')?.invalid && loginForm.get('email')?.touched">
      请输入有效的邮箱地址
    </div>
  </div>
  
  <div>
    <label>密码</label>
    <input formControlName="password" type="password">
  </div>
  
  <div>
    <label>
      <input formControlName="remember" type="checkbox">
      记住我
    </label>
  </div>
  
  <button type="submit" [disabled]="loginForm.invalid">登录</button>
</form>
```

### 模板驱动表单

```typescript
import { Component } from '@angular/core';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-contact',
  template: `
    <form #contactForm="ngForm" (ngSubmit)="onSubmit(contactForm)">
      <input [(ngModel)]="contact.name" name="name" required>
      <input [(ngModel)]="contact.email" name="email" required email>
      <button type="submit" [disabled]="contactForm.invalid">提交</button>
    </form>
  `
})
export class ContactComponent {
  contact = { name: '', email: '' };
  
  onSubmit(form: any) {
    console.log('表单值:', form.value);
  }
}
```

---

## HTTP 通信

### 配置 HttpClient

```typescript
import { HttpClientModule } from '@angular/common/http';

@NgModule({
  imports: [HttpClientModule],
})
export class AppModule {}
```

### 发送 HTTP 请求

```typescript
import { Component, OnInit } from '@angular/core';
import { HttpClient } from '@angular/common/http';

@Component({
  selector: 'app-data',
  templateUrl: './data.component.html'
})
export class DataComponent implements OnInit {
  data: any[] = [];

  constructor(private http: HttpClient) {}

  ngOnInit() {
    // GET 请求
    this.http.get('https://api.example.com/data').subscribe({
      next: (response) => {
        this.data = response as any[];
      },
      error: (error) => {
        console.error('请求失败:', error);
      }
    });
  }

  // POST 请求
  createItem(item: any) {
    this.http.post('https://api.example.com/data', item).subscribe({
      next: (response) => {
        console.log('创建成功:', response);
      }
    });
  }
}
```

### 使用 HttpClientModule 替代方案（Angular 15+）

推荐使用函数式方式：

```typescript
import { HttpClient } from '@angular/common/http';
import { inject } from '@angular/core';

export class DataService {
  private http = inject(HttpClient);
  
  getData() {
    return this.http.get('https://api.example.com/data');
  }
}
```

---

## 状态管理

### 组件内状态管理

对于简单应用，可以在组件内部管理状态：

```typescript
@Component({
  selector: 'app-counter',
  template: `
    <button (click)="decrement()">-</button>
    <span>{{ count }}</span>
    <button (click)="increment()">+</button>
  `
})
export class CounterComponent {
  count = 0;

  increment() { this.count++; }
  decrement() { this.count--; }
}
```

### 使用信号 (Signals) - Angular 16+

```typescript
import { Component, signal, computed } from '@angular/core';

@Component({
  selector: 'app-signals',
  template: `
    <p>计数：{{ count() }}</p>
    <p> doubled：{{ doubled() }}</p>
    <button (click)="update()">更新</button>
  `
})
export class SignalsComponent {
  count = signal(0);
  doubled = computed(() => this.count() * 2);

  update() {
    this.count.update(c => c + 1);
  }
}
```

### 服务状态管理

使用 BehaviorSubject 进行状态共享：

```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class CartService {
  private cartItems = new BehaviorSubject<any[]>([]);
  
  cartItems$ = this.cartItems.asObservable();

  addItem(item: any) {
    const current = this.cartItems.value;
    this.cartItems.next([...current, item]);
  }

  removeItem(index: number) {
    const current = this.cartItems.value;
    current.splice(index, 1);
    this.cartItems.next([...current]);
  }
}
```

---

## 样式与样式表

### 组件样式

```typescript
@Component({
  selector: 'app-styled',
  // 外部样式文件
  styleUrls: ['./styled.component.css']
  // 或内联样式
  // styles: [`
  //   .container { padding: 20px; }
  // `]
})
export class StyledComponent {}
```

### 全局样式

在 `src/styles.css` 中定义全局样式：

```css
/* 全局变量 */
:root {
  --primary-color: #1976d2;
  --secondary-color: #424242;
}

/* 全局重置 */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
```

### 使用 SCSS

Angular CLI 创建项目时可以选择 SCSS：

```bash
ng new my-app --style=scss
```

### 视图封装

```typescript
@Component({
  selector: 'app-encapsulation',
  templateUrl: './encapsulation.component.html',
  // 视图封装模式
  // ViewEncapsulation.Emulated - 默认，模拟 Shadow DOM
  // ViewEncapsulation.ShadowDom - 使用原生 Shadow DOM
  // ViewEncapsulation.None - 无封装，样式全局生效
  encapsulation: ViewEncapsulation.Emulated
})
export class EncapsulationComponent {}
```

---

## 测试

### 单元测试 (Jasmine/Karma)

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { UserCardComponent } from './user-card.component';

describe('UserCardComponent', () => {
  let component: UserCardComponent;
  let fixture: ComponentFixture<UserCardComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [UserCardComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(UserCardComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should display user name', () => {
    component.userName = '张三';
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h2')?.textContent).toContain('张三');
  });
});
```

### 运行测试

```bash
# 运行所有测试
ng test

# 运行生产环境测试
ng test --watch=false --browsers=ChromeHeadless
```

### 端到端测试 (Playwright/Cypress)

```bash
# 创建 e2e 测试
ng generate e2e my-e2e

# 运行 e2e 测试
ng e2e
```

---

## 构建与部署

### 开发构建

```bash
ng build
```

### 生产构建

```bash
ng build --configuration production
```

生产构建会：
- 启用代码压缩和混淆
- 移除调试代码
- 优化 bundle 大小

### 静态网站部署

#### 使用 Firebase Hosting

```bash
# 安装 Firebase CLI
npm install -g firebase-tools

# 登录
firebase login

# 初始化
firebase init

# 部署
firebase deploy
```

#### 使用 GitHub Pages

```bash
# 安装 angular-cli-ghpages
npm install -g angular-cli-ghpages

# 构建并部署
ng build --configuration production --base-href "https://username.github.io/repo/"
ngh --dir dist/<project-name>
```

#### 使用 Vercel

```bash
# 安装 Vercel CLI
npm i -g vercel

# 部署
vercel
```

---

## 最佳实践

### 项目结构

```
src/
├── app/
│   ├── core/                 # 核心模块（单例服务、全局配置）
│   │   ├── services/
│   │   ├── guards/
│   │   └── interceptors/
│   ├── shared/               # 共享模块（公共组件、指令、管道）
│   │   ├── components/
│   │   ├── directives/
│   │   └── pipes/
│   ├── features/             # 功能模块（业务功能）
│   │   ├── user/
│   │   └── product/
│   ├── layout/               # 布局组件
│   │   ├── header/
│   │   ├── sidebar/
│   │   └── footer/
│   └── app.component.ts      # 根组件
├── assets/                   # 静态资源
├── environments/             # 环境配置
└── styles.scss               # 全局样式
```

### 性能优化

1. **使用 OnPush 变更检测策略**

```typescript
@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class MyComponent {}
```

2. **使用 trackBy 优化 ngFor**

```html
<li *ngFor="let item of items; trackBy: trackById">{{ item.name }}</li>
```

```typescript
trackById(index: number, item: any): number {
  return item.id;
}
```

3. **延迟加载模块**

```typescript
const routes: Routes = [
  {
    path: 'admin',
    loadChildren: () => import('./admin/admin.module').then(m => m.AdminModule)
  }
];
```

4. **使用信号 (Signals)**

Angular 16+ 推荐使用信号进行响应式编程，提高性能。

### 安全最佳实践

1. **使用 DOMSanitizer 处理 HTML**

```typescript
import { DomSanitizer } from '@angular/platform-browser';

constructor(private sanitizer: DomSanitizer) {}

getSafeHtml(html: string) {
  return this.sanitizer.bypassSecurityTrustHtml(html);
}
```

2. **防止 XSS 攻击**

- Angular 默认启用 XSS 防护
- 避免使用 `innerHTML`，或使用 `DomSanitizer`

3. **使用 HTTP 拦截器添加认证**

```typescript
import { Injectable } from '@angular/core';
import { HttpInterceptor, HttpRequest, HttpHandler } from '@angular/common/http';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  intercept(req: HttpRequest<any>, next: HttpHandler) {
    const token = localStorage.getItem('token');
    const authReq = req.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`
      }
    });
    return next.handle(authReq);
  }
}
```

---

## 相关链接

- [Angular 官方文档](https://angular.io/)
- [Angular 中文文档](https://angular.cn/)
- [Angular CLI 文档](https://angular.io/cli)
- [Angular Material 组件库](https://material.angular.io/)
- [RxJS 文档](https://rxjs.dev/)
