# Nginx 常见问题

本章节汇总了 Nginx 使用中的常见问题。

## 启动问题

### Q1: 启动失败

**问题描述：**
Nginx 无法启动。

**解决方案：**
```bash
# 检查错误日志
tail -f /var/log/nginx/error.log

# 测试配置
nginx -t

# 查看端口占用
netstat -tlnp | grep :80
```

### Q2: 端口被占用

**问题描述：**
`nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)`

**解决方案：**
```bash
# 查找占用端口的进程
lsof -i :80

# 停止占用进程
kill <PID>

# 或更改 Nginx 端口
listen 8080;
```

## 配置问题

### Q3: 403 禁止访问

**问题描述：**
访问页面返回 403 错误。

**解决方案：**
1. 检查文件权限
   ```bash
   chmod 755 /var/www
   chmod 644 /var/www/index.html
   ```

2. 检查 index 文件
   ```nginx
   index index.html index.htm;
   ```

3. 检查 SELinux
   ```bash
   sudo setsebool -P httpd_read_user_content 1
   ```

### Q4: 404 Not Found

**问题描述：**
页面找不到。

**解决方案：**
1. 检查 root 路径
2. 检查文件是否存在
3. 检查 try_files 配置

### Q5: 配置不生效

**问题描述：**
修改配置后没有生效。

**解决方案：**
```bash
# 测试配置
nginx -t

# 重载配置
nginx -s reload

# 完全重启
nginx -s stop
nginx
```

## 性能问题

### Q6: 性能下降

**问题描述：**
Nginx 响应变慢。

**解决方案：**
1. 调整 worker 进程数
   ```nginx
   worker_processes auto;
   ```

2. 调整 worker 连接数
   ```nginx
   events {
       worker_connections 1024;
   }
   ```

3. 启用 gzip 压缩
   ```nginx
   gzip on;
   gzip_types text/plain text/css application/json;
   ```

### Q7: 内存占用高

**解决方案：**
1. 减少 worker 连接数
2. 关闭不必要的模块
3. 优化缓冲区大小

## 代理问题

### Q8: 代理失败

**问题描述：**
无法代理到后端服务器。

**解决方案：**
```nginx
# 检查后端服务
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 添加必要的头部
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

### Q9: WebSocket 失败

**解决方案：**
```nginx
location /ws/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### Q10: HTTPS 证书错误

**解决方案：**
1. 检查证书路径
2. 证书格式正确
3. 证书链完整

```nginx
ssl_certificate /etc/nginx/ssl/cert.pem;
ssl_certificate_key /etc/nginx/ssl/key.pem;
```

## 安全问题

### Q11: SSL/TLS 漏洞

**解决方案：**
```nginx
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers HIGH:!aNULL:!MD5;
ssl_prefer_server_ciphers on;
```

### Q12: 目录遍历

**解决方案：**
关闭 autoindex：
```nginx
location / {
    autoindex off;
}
```

## 缓存问题

### Q13: 缓存不生效

**解决方案：**
```nginx
# 设置缓存头
expires 7d;
add_header Cache-Control "public, no-transform";

# 代理时缓存
proxy_cache_valid 200 60m;
```

### Q14: 浏览器缓存旧文件

**解决方案：**
```bash
# 清理浏览器缓存
# 或添加版本号
location / {
    rewrite ^/(.*)$ /$1?v=$ts_hash last;
}
```

## 日志问题

### Q15: 日志文件过大

**解决方案：**
配置日志轮转：
```nginx
access_log /var/log/nginx/access.log main;
```

或使用 logrotate：
```bash
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

## 总结

本章节涵盖了 Nginx 使用中的常见问题：

- **启动**：失败、端口占用
- **配置**：403、404、不生效
- **性能**：响应慢、内存高
- **代理**：失败、WebSocket
- **安全**：SSL漏洞、目录遍历
- **缓存**：不生效、旧文件
- **日志**：文件过大

如需更多信息，请参考官方文档：https://nginx.org/en/docs/
