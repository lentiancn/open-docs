# Redis 使用ガイド

Redis を効率的に使用する完全なガイドです。

---

## 目次

- [基本的なコンセプト](#基本的なコンセプト)
- [データ型](#データ型)
- [文字列操作](#文字列操作)
- [リスト操作](#リスト操作)
- [ハッシュ操作](#ハッシュ操作)
- [セット操作](#セット操作)
- [順序付きセット操作](#順序付きセット操作)
- [キーと有効期限](#キーと有効期限)
- [パブリッシュ/サブスクライブ](#パブリッシュサブスクライブ)
- [トランザクション](#トランザクション)
- [パイプライン](#パイプライン)
- [Lua スクリプト](#lua-スクリプト)
- [永続化](#永続化)
- [レプリケーション](#レプリケーション)
- [クラスター](#クラスター)
- [セキュリティ](#セキュリティ)
- [パフォーマンス最適化](#パフォーマンス最適化)
- [一般的なレシピ](#一般的なレシピ)

---

## 基本的なコンセプト

### Redis とは？

Redis はオープンソースのメモリ内データ構造ストアで、データベース、キャッシュ、メッセージブローカーとして使用されます。 다양한データ構造をサポートし、高パフォーマンスを提供します。

### 主な機能

- メモリ内ストレージ
- データの永続化
- レプリケーション
- クラスタリング
- パブリッシュ/サブスクライブメッセージング
- Lua スクリプティング

### 重要な用語

| 用語 | 説明 |
|------|------|
| Key | 値の一意の識別子 |
| Value | Redis に保存されるデータ |
| TTL | Time To Live（有効期限） |
| Pipeline | 複数のコマンドを一括実行 |
| Master | Redis のプライマリインスタンス |
| Slave | マスターのレプリカ |

---

## データ型

Redis は様々なデータ型をサポートします：

| 型 | 説明 |
|------|-------------|
| String | テキストまたはバイナリデータ |
| List | 順序付き文字列リスト |
| Hash | フィールドと値のペアのコレクション |
| Set | 一意の文字列の順序なしコレクション |
| Sorted Set | 順序付けのためのスコアを持つセット |
| HyperLogLog | 確率的データ構造 |
| Bitmap | ビット操作可能な文字列 |
| Stream | ログ構造のメッセージブローカー |

---

## 文字列操作

### 基本的なコマンド

```bash
# 値を設定
SET key "value"

# 値を取得
GET key

# 複数のキーを設定
MSET key1 "value1" key2 "value2"

# 複数のキーを取得
MGET key1 key2

# 文字列に追加
APPEND key " appended"

# 文字列の長さを取得
STRLEN key
```

### 数値操作

```bash
# インクリメント
INCR counter
INCRBY counter 10

# デクリメント
DECR counter
DECRBY counter 5

# 浮動小数点のインクリメント
INCRBYFLOAT price 0.5
```

---

## リスト操作

### 基本的なコマンド

```bash
# 左に追加
LPUSH mylist "first"

# 右に追加
RPUSH mylist "last"

# 左からポップ
LPOP mylist

# 右からポップ
RPOP mylist

# 範囲を取得
LRANGE mylist 0 -1

# リストの長さを取得
LLEN mylist
```

---

## ハッシュ操作

### 基本的なコマンド

```bash
# ハッシュフィールドを設定
HSET user:1 name "John"

# 複数のハッシュフィールドを設定
HMSET user:1 name "John" email "john@example.com"

# ハッシュフィールドを取得
HGET user:1 name

# すべてのフィールドと値を取得
HGETALL user:1

# 複数のフィールドを取得
HMGET user:1 name email

# フィールドを削除
HDEL user:1 email
```

---

## セット操作

### 基本的なコマンド

```bash
# セットに追加
SADD myset "member1"

# セットから削除
SREM myset "member1"

# すべてのメンバーを取得
SMEMBERS myset

# メンバーシップを確認
SISMEMBER myset "member1"

# セットのサイズを取得
SCARD myset
```

### セット演算

```bash
# 和集合
SUNION set1 set2

# 積集合
SINTER set1 set2

# 差集合
SDIFF set1 set2
```

---

## 順序付きセット操作

### 基本的なコマンド

```bash
# 順序付きセットに追加
ZADD leaderboard 100 "player1"

# 範囲を取得（昇順）
ZRANGE leaderboard 0 -1 WITHSCORES

# 範囲を取得（降順）
ZREVRANGE leaderboard 0 -1 WITHSCORES

# 順位を取得
ZRANK leaderboard "player1"

# スコアを増加
ZINCRBY leaderboard 50 "player1"
```

---

## キーと有効期限

### キー管理

```bash
# キーを削除
DEL key

# キーが存在するか確認
EXISTS key

# キーのタイプを取得
TYPE key

# キーを名前変更
RENAME key newkey

# すべてのキーを取得
KEYS pattern

# キーをスキャン
SCAN 0 MATCH pattern
```

### 有効期限

```bash
# 有効期限を設定（秒）
EXPIRE key 60

# 有効期限を設定（ミリ秒）
PEXPIRE key 60000

# 有効期限付きでキーを設定
SETEX key 60 "value"

# 有効期限を削除
PERSIST key

# 残り時間を取得（秒）
TTL key

# 残り時間を取得（ミリ秒）
PTTL key
```

---

## パブリッシュ/サブスクライブ

### パブリッシング

```bash
# チャンネルを購読
SUBSCRIBE mychannel

# メッセージを公開
PUBLISH mychannel "Hello"

# パターン購読
PSUBSCRIBE news.*
```

### コマンド

```bash
# 購読
SUBSCRIBE channel1 channel2

# 公開
PUBLISH channel1 "message"

# 購読解除
UNSUBSCRIBE channel1
```

---

## トランザクション

### 基本的なコマンド

```bash
# トランザクション開始
MULTI

# コマンドをキューに追加
SET key1 "value1"
SET key2 "value2"

# トランザクションを実行
EXEC

# トランザクションを破棄
DISCARD
```

### Watch

```bash
WATCH key
# ... 何らかの操作 ...
MULTI
SET key newvalue
EXEC  # キーが変更されていた場合は失敗
```

---

## パイプライン

### パイプラインの使用

```bash
# 複数のコマンドをパイプライン化
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# コードでの使用（Python の例）
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Lua スクリプト

### 基本的なスクリプト

```bash
# Lua スクリプトを実行
EVAL "return redis.call('get', 'key')" 0

# Lua でキーを設定
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### スクリプトの例

```lua
-- カウンタをインクリメント
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## 永続化

### RDB（Redis データベース）

```bash
# 手動で保存
BGSAVE

# 前回の保存時刻を取得
LASTSAVE
```

### AOF（Append Only File）

```bash
# 設定で有効化
appendonly yes

# AOF を再書き込み
BGREWRITEAOF
```

### 設定

```bash
# 保存の頻度
save 900 1
save 300 10
save 60 10000
```

---

## レプリケーション

### スレーブの設定

```bash
# redis.conf で
replicaof masterip masterport

# またはコマンドで
REPLICAOF masterip masterport
```

### コマンド

```bash
# レプリケーション状態を確認
INFO replication

# マスターになる
REPLICAOF NO ONE
```

---

## クラスター

### クラスターの作成

```bash
# クラスターを作成
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# クラスターノードを確認
redis-cli -c cluster nodes
```

---

## セキュリティ

### パスワード認証

```bash
# 設定でパスワードを設定
requirepass yourpassword

# CLI で認証
AUTH yourpassword
```

### ACL（Redis 6+）

```bash
# ユーザーを作成
ACL SETUSER alice on >password ~cached:* +get +set

# ユーザーを一覧表示
ACL LIST
```

---

## パフォーマンス最適化

### メモリ最適化

```bash
# 最大メモリを設定
maxmemory 2gb

# 淘汰ポリシー
maxmemory-policy allkeys-lru
```

### 接続最適化

```bash
# 接続プールを使用
# コード内で
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## 一般的なレシピ

### キャッシュ

```bash
# 有効期限付きのキャッシュ
SET user:1:profile "data" EX 3600

# キャッシュを確認
GET user:1:profile
```

### レート制限

```bash
# シンプルなレート制限
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### 分散ロック

```bash
# ロックを取得
SET lock:myresource unique_value NX EX 10

# ロックを解放
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### セッションストレージ

```bash
# セッションを保存
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## 次のステップ

- [Redis Stack](https://redis.io/docs/stack/) を探索
- [Redis Enterprise](https://redis.com/redis-enterprise/) について学習
- [パフォーマンスチューニングガイド](https://redis.io/docs/management/optimization/) を読む
