# Apache APISIX FAQ

## Basic Questions

### 1. What is Apache APISIX?

Apache APISIX is a cloud-native API gateway managed by the Apache Software Foundation. It provides dynamic, real-time, high-performance API traffic management features including load balancing, dynamic routing, authentication, rate limiting, monitoring, and more.

### 2. What's the difference between APISIX and Nginx?

Nginx is a traditional web server and reverse proxy, while APISIX is an API gateway built on top of Nginx.

Main differences:
- **Configuration**: Nginx requires config file changes and restart; APISIX supports hot updates without restart
- **Extension**: APISIX provides rich built-in plugins; Nginx requires writing custom modules
- **Dynamic**: APISIX natively supports dynamic routing, dynamic upstream, etc.
- **Observability**: APISIX has built-in Prometheus, SkyWalking monitoring integration

### 3. What dependencies does APISIX need?

APISIX primarily depends on:
- **etcd**: For configuration storage and cluster synchronization
- **Lua**: APISIX uses Lua for plugin logic
- **Nginx**: Uses Nginx for HTTP request handling

If using Docker, all dependencies are automatically configured.

### 4. How is APISIX's performance?

APISIX has very high performance, reaching 18,000 QPS per core with average latency under 0.2ms. This is due to:
- Nginx's high-performance HTTP processing
- LuaJIT's just-in-time compilation
- Elegant architecture design

### 5. What platforms does APISIX support?

APISIX supports multiple platforms:
- Linux (Ubuntu, CentOS, Debian, etc.)
- macOS
- Windows (via WSL or Docker)
- Kubernetes (via Helm or Operator)

## Installation Questions

### 6. What to do if quickstart script fails?

Common causes and solutions:

1. **Docker not running**
   ```bash
   # Start Docker
   sudo systemctl start docker
   ```

2. **Port already in use**
   ```bash
   # Check port usage
   lsof -i :9080
   
   # Stop the process using the port, or modify APISIX config
   ```

3. **Network issues**
   ```bash
   # Check Docker network
   docker network ls
   
   # Try manually pulling images
   docker pull apache/apisix:3.3.0
   docker pull apache/apisix/etcdserve:v3.5.0
   ```

### 7. How to change APISIX ports?

Modify Docker Compose config:

```yaml
services:
  apisix:
    ports:
      - "9081:9080"  # host:container
      - "9444:9443"
      - "9181:9180"
```

Or modify `config.yaml`:

```yaml
deployment:
  listen:
    ip: "0.0.0.0"
    port: 9081
```

### 8. How to fix etcd startup failure?

Common causes:

1. **Data directory permission**
   ```bash
   sudo chown -R etcd:etcd /var/lib/etcd
   ```

2. **Port conflict**
   ```bash
   lsof -i :2379
   ```

3. **Insufficient disk space**
   ```bash
   df -h
   # Clean unnecessary files
   ```

### 9. How to upgrade APISIX?

Docker method:
```bash
# Pull new version image
docker pull apache/apisix:3.4.0

# Stop old container
docker stop apisix

# Start with new image
docker run -d apache/apisix:3.4.0 ...
```

Note: Backup configuration data before upgrading.

## Configuration Questions

### 10. How to change Admin API Key?

Edit `config.yaml`:

```yaml
deployment:
  admin:
    admin_key:
      - name: "admin"
        key: "your-new-secret-key"
        role: "admin"
```

Restart APISIX after changes.

### 11. How to enable HTTPS?

APISIX supports two ways to enable HTTPS:

1. **Manual SSL certificate**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/ssl" -X PUT -d '
   {
     "id": "ssl-1",
     "cert": "-----BEGIN CERTIFICATE-----\n...",
     "key": "-----BEGIN PRIVATE KEY-----\n...",
     "snis": ["example.com"]
   }'
   ```

2. **Auto-issue with Let's Encrypt**
   ```bash
   # Enable acme plugin
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "acme": {
         "account_email": "your@email.com"
       }
     }
   }'
   ```

### 12. How to configure multiple domains?

Use the `hosts` field when creating routes:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "multi-domain",
  "hosts": ["example.com", "api.example.com"],
  "uri": "/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 13. How to implement request redirect?

Use the `redirect` plugin:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "redirect-route",
  "uri": "/old-path",
  "plugins": {
    "redirect": {
      "uri": "/new-path",
      "http_status": 301
    }
  }
}'
```

## Feature Questions

### 14. How to implement canary release?

There are two methods:

1. **Weight-based canary**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "traffic-split": {
         "rules": [
           {
             "weighted_upstream": [
               {"upstream": {"name": "v1", "nodes": {"v1:8080": 100}}, "weight": 90},
               {"upstream": {"name": "v2", "nodes": {"v2:8080": 100}}, "weight": 10}
             ]
           }
         ]
       }
     }
   }'
   ```

2. **Request attribute-based canary**
   Use `vars` for condition matching, such as distributing to different upstreams based on headers, cookies, or parameters.

### 15. How to implement circuit breaker?

APISIX has built-in circuit breaker functionality via health checks:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"backend:8080": 1},
    "checks": {
      "passive": {
        "healthy": {"successes": 3},
        "unhealthy": {"http_failures": 3}
      }
    }
  }
}'
```

### 16. How to enable CORS?

Use the `cors` plugin:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "cors": {
      "allow_origins": "*",
      "allow_methods": "GET,POST,PUT,DELETE",
      "allow_headers": "*"
    }
  }
}'
```

### 17. How to implement rate limiting?

```bash
# Request count based
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 429
    }
  }
}'
```

### 18. How to use consumers for authentication?

1. Create consumer:
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
   {
     "username": "user1",
     "plugins": {
       "key-auth": {"key": "key-1"}
     }
   }'
   ```

2. Enable verification on route:
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {"key-auth": {}}
   }'
   ```

3. Client includes key in request:
   ```bash
   curl "http://127.0.0.1:9080/api" -H "apikey: key-1"
   ```

## Monitoring Questions

### 19. How to integrate Prometheus?

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  }
}'
```

Access metrics:
```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 20. How to configure log forwarding?

Multiple log outputs supported:

```bash
# HTTP log
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  }
}'

# Kafka log
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "kafka-logger": {
      "brokers": [{"host": "kafka", "port": 9092}],
      "topic": "apisix-logs"
    }
  }
}'
```

### 21. How to use SkyWalking tracing?

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "skywalking": {
      "endpoint_addr": "http://skywalking:11800",
      "service_name": "apisix",
      "sample_ratio": 1
    }
  }
}'
```

## Cluster Questions

### 22. How to build an APISIX cluster?

APISIX nodes are stateless. You only need to:

1. Deploy multiple APISIX nodes
2. Configure all nodes to connect to the same etcd cluster
3. Use a load balancer (like Nginx, HAProxy) to distribute traffic

```yaml
# config.yaml
deployment:
  etcd:
    host:
      - "http://etcd1:2379"
      - "http://etcd2:2379"
      - "http://etcd3:2379"
```

### 23. How to ensure etcd high availability?

etcd supports cluster mode deployment:

```bash
# Start etcd cluster
etcd --name infra1 --initial-advertise-peer-urls http://localhost:2380 \
  --listen-peer-urls http://localhost:2380 \
  --initial-cluster infra1=http://localhost:2380,...
```

For production, deploy at least 3 etcd nodes.

### 24. How to migrate APISIX configuration?

1. Export config:
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx" > routes.json
   ```

2. Import to new cluster:
   ```bash
   # Import one by one or use batch import tool
   ```

## Security Questions

### 25. What are the security recommendations for production?

1. **Change default API Key**
   ```yaml
   deployment:
     admin:
       admin_key:
         - key: "your-secure-key"
   ```

2. **Restrict Admin API access**
   ```yaml
   deployment:
     admin:
       allow_access: ["127.0.0.1", "10.0.0.0/8"]
   ```

3. **Enable HTTPS**

4. **Configure firewall rules**

5. **Regularly update versions**

### 26. How to prevent malicious API access?

1. **Enable IP blacklist**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "ip-restriction": {
         "deny": ["1.2.3.4"]
       }
     }
   }'
   ```

2. **Enable request validation**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "request-validation": {
         "body_schema": {
           "type": "object",
           "required": ["name"],
           "properties": {"name": {"type": "string"}}
         }
       }
     }
   }'
   ```

3. **Enable CSRF protection**

## Debugging Questions

### 27. How to view APISIX logs?

Docker method:
```bash
docker logs apisix
```

View error logs:
```bash
tail -f logs/error.log
```

### 28. How to debug route matching?

Use the `debug` plugin:

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/plugin_metadata/debug" -X PUT -d '
{
  "headers": ["X-Request-ID"]
}'
```

### 29. Request returns 404 what to do?

1. Check if route is created correctly:
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx"
   ```

2. Check if URI matches:
   - Ensure request path matches route config
   - Note the difference between prefix matching and exact matching

3. Check if upstream is reachable:
   ```bash
   curl -v http://backend:8080/health
   ```

### 30. Request returns 503 what to do?

Usually the upstream is unavailable:

1. Check if upstream nodes are running
2. Check network connectivity
3. Check if health check configuration is too strict

## More Help

For issues not covered in this FAQ, refer to:

- Official docs: https://apisix.apache.org/docs/
- GitHub: https://github.com/apache/apisix
- Community forum: https://github.com/apache/apisix/discussions
- Slack: https://apisix.apache.org/slack
