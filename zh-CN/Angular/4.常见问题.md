# Angular 常见问题

本章节汇总了 Angular 开发中常见的疑问和解决方案，涵盖安装、开发、测试、部署等各个方面。

## 安装和环境问题

### Q1: Angular CLI 安装失败，提示权限错误

**问题描述：**
```
EPERM: operation not permitted, mkdir 'C:\Users\xxx\AppData\Roaming\npm'
```

**解决方案：**

**Windows：**
1. 以管理员身份打开 PowerShell 或 CMD
2. 或者修改 npm 全局安装路径：
   ```powershell
   # 创建全局安装目录
   mkdir $HOME\npm-global
   
   # 配置 npm
   npm config set prefix "$HOME\npm-global"
   
   # 添加到 PATH
   # 在系统环境变量中添加：%USERPROFILE%\npm-global
   ```

**macOS/Linux：**
```bash
# 创建全局安装目录
mkdir -p ~/.npm-global

# 配置 npm
npm config set prefix '~/.npm-global'

# 添加到 .bashrc 或 .zshrc
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

### Q2: Node.js 版本不兼容

**问题描述：**
```
The current Node.js version (v14.x) is not supported by Angular. Please use Node.js 18.x or higher.
```

**解决方案：**

使用 nvm（Node Version Manager）管理 Node.js 版本：

```bash
# 安装 nvm (macOS/Linux)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 安装 Node.js LTS
nvm install --lts

# 切换到 LTS 版本
nvm use --lts

# 设置为默认版本
nvm alias default lts/*

# Windows 使用 nvm-windows
# 下载：https://github.com/coreybutler/nvm-windows
```

### Q3: npm 安装速度慢或超时

**解决方案：**

1. **配置镜像源：**
   ```bash
   # 淘宝镜像
   npm config set registry https://registry.npmmirror.com
   
   # 恢复官方源
   npm config set registry https://registry.npmjs.org
   ```

2. **使用 yarn：**
   ```bash
   npm install -g yarn
   yarn config set registry https://registry.npmmirror.com
   ```

3. **使用 pnpm：**
   ```bash
   npm install -g pnpm
   pnpm config set registry https://registry.npmmirror.com
   ```

### Q4: ng 命令找不到

**解决方案：**

```bash
# 方案1：重新安装
npm uninstall -g @angular/cli
npm install -g @angular/cli

# 方案2：使用 npx
npx @angular/cli new my-app

# 方案3：检查 PATH 环境变量
# 确保包含 npm 全局模块路径
echo $PATH
npm config get prefix
```

### Q5: Windows Defender 或杀毒软件阻止

**解决方案：**

1. 临时关闭实时保护
2. 将 Node.js 添加到排除项：
   - 打开 Windows Defender 安全中心
   - 病毒和威胁防护 → 病毒和威胁防护设置 → 排除项 → 添加排除项
   - 添加 Node.js 安装目录（如 `C:\Program Files\nodejs`）

## 开发常见问题

### Q6: 组件样式不生效

**可能原因：**

1. **ViewEncapsulation 设置**
   ```typescript
   import { Component, ViewEncapsulation } from '@angular/core';
   
   @Component({
     selector: 'app-example',
     templateUrl: './example.component.html',
     styleUrls: ['./example.component.css'],
     encapsulation: ViewEncapsulation.None  // 允许样式影响全局
   })
   export class ExampleComponent {}
   ```

2. **样式文件路径错误**
   ```typescript
   // 正确
   styleUrls: ['./example.component.css']
   
   // 错误（相对路径不正确）
   styleUrls: ['example.component.css']
   ```

3. **CSS 选择器优先级问题**
   - 使用 `:host` 伪类选择器
   - 使用 `::ng-deep`（已废弃，尽量避免）

### Q7: 双向数据绑定不工作

**问题描述：** `[(ngModel)]` 绑定不生效

**解决方案：**

1. **导入 FormsModule：**
   ```typescript
   import { FormsModule } from '@angular/forms';
   
   @Component({
     imports: [FormsModule],  // standalone 组件
     // 或在 NgModule 中
   })
   export class MyModule {}
   ```

2. **检查语法：**
   ```html
   <!-- 正确 -->
   <input [(ngModel)]="username">
   
   <!-- 错误 -->
   <input [ngModel]="username">
   ```

### Q8: 路由跳转后数据不更新

**问题描述：** 同一路由跳转时，组件数据不刷新

**解决方案：**

```typescript
import { ActivatedRoute } from '@angular/router';

@Component({...})
export class UserDetailComponent implements OnInit, OnDestroy {
  private destroyed$ = new Subject<void>();
  
  constructor(private route: ActivatedRoute) {}
  
  ngOnInit() {
    // 使用 paramMap 订阅参数变化
    this.route.paramMap.pipe(
      takeUntil(this.destroyed$)
    ).subscribe(params => {
      const id = Number(params.get('id'));
      this.loadUser(id);
    });
  }
  
  ngOnDestroy() {
    this.destroyed$.next();
    this.destroyed$.complete();
  }
}
```

**Angular 16+ 简化方案：**
```typescript
import { ActivatedRoute } from '@angular/router';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({...})
export class UserDetailComponent {
  private route = inject(ActivatedRoute);
  
  // 自动转换为 Signal
  userId = toSignal(this.route.paramMap.pipe(
    map(params => Number(params.get('id')))
  ));
  
  user = toSignal(this.userService.getUser(this.userId()));
}
```

### Q9: Http 请求返回 401 或 403 错误

**解决方案：**

1. **检查请求头是否正确设置**
2. **添加认证拦截器：**
   ```typescript
   // auth.interceptor.ts
   import { HttpInterceptorFn } from '@angular/common/http';
   
   export const authInterceptor: HttpInterceptorFn = (req, next) => {
     const token = localStorage.getItem('auth_token');
     
     if (token) {
       const authReq = req.clone({
         setHeaders: {
           Authorization: `Bearer ${token}`
         }
       });
       return next(authReq);
     }
     
     return next(req);
   };
   ```

3. **在应用中注册拦截器：**
   ```typescript
   // app.config.ts
   import { provideHttpClient, withInterceptors } from '@angular/common/http';
   import { authInterceptor } from './interceptors/auth.interceptor';
   
   export const appConfig: ApplicationConfig = {
     providers: [
       provideHttpClient(
         withInterceptors([authInterceptor])
       )
     ]
   };
   ```

### Q10: 内存泄漏问题

**问题描述：** 组件销毁后，定时器、订阅等未清理

**解决方案：**

```typescript
import { Component, OnDestroy, OnInit } from '@angular/core';
import { Subject, interval } from 'rxjs';
import { takeUntil, filter } from 'rxjs/operators';

@Component({...})
export class MyComponent implements OnDestroy {
  // 创建销毁 subject
  private destroy$ = new Subject<void>();
  
  constructor() {
    // 订阅 Observable
    interval(1000).pipe(
      takeUntil(this.destroy$)
    ).subscribe(n => console.log(n));
    
    // 设置定时器
    this.timerId = setTimeout(() => {
      console.log('延迟执行');
    }, 5000);
  }
  
  ngOnDestroy() {
    // 清理所有订阅和定时器
    this.destroy$.next();
    this.destroy$.complete();
    
    if (this.timerId) {
      clearTimeout(this.timerId);
    }
  }
}
```

**Angular 16+ 使用 takeUntilDestroyed：**
```typescript
import { Component, destroyOnDestroy, inject } from '@angular/core';
import { toObservable } from '@angular/core/rxjs-interop';
import { interval, tap } from 'rxjs';

@Component({
  selector: 'app-example',
  templateUrl: './example.component.html',
  // 自动在组件销毁时清理
  providers: [destroyOnDestroy()]
})
export class ExampleComponent {
  private interval$ = interval(1000).pipe(
    tap(n => console.log(n))
  );
  
  constructor() {
    this.interval$.subscribe();
  }
}
```

### Q11: 表单验证不生效

**解决方案：**

```typescript
import { ReactiveFormsModule, FormBuilder, Validators } from '@angular/forms';

@Component({
  imports: [ReactiveFormsModule],
  // 或在 NgModule 中导入 ReactiveFormsModule
})
export class MyComponent {
  form = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]]
  });
  
  // 触发表单验证
  markAllAsTouched() {
    this.form.markAllAsTouched();
  }
  
  // 检查特定字段
  isFieldInvalid(field: string): boolean {
    const control = this.form.get(field);
    return !!(control && control.invalid && control.touched);
  }
}
```

```html
<!-- 在模板中显示错误信息 -->
<div *ngIf="isFieldInvalid('email')">
  <small *ngIf="form.get('email')?.errors?.['required']">邮箱必填</small>
  <small *ngIf="form.get('email')?.errors?.['email']">邮箱格式不正确</small>
</div>
```

### Q12: 异步数据不显示

**问题描述：** HTTP 请求返回数据后，模板不更新

**解决方案：**

1. **使用 AsyncPipe：**
   ```typescript
   // 组件中
   users$ = this.userService.getUsers();
   ```
   
   ```html
   <!-- 模板中 -->
   <ul>
     <li *ngFor="let user of users$ | async">
       {{ user.name }}
     </li>
   </ul>
   ```

2. **使用 Signal（Angular 16+）：**
   ```typescript
   import { toSignal } from '@angular/core/rxjs-interop';
   
   users = toSignal(this.userService.getUsers());
   ```
   
   ```html
   <!-- 模板中 -->
   <ul>
     <li *ngFor="let user of users()">
       {{ user.name }}
     </li>
   </ul>
   ```

3. **手动触发变更检测：**
   ```typescript
   import { ChangeDetectorRef } from '@angular/core';
   
   constructor(private cdr: ChangeDetectorRef) {}
   
   // 在异步操作后
   this.http.get('/api/data').subscribe(data => {
     this.data = data;
     this.cdr.detectChanges();  // 强制刷新
   });
   ```

## 构建和部署问题

### Q13: 构建体积过大

**解决方案：**

1. **开启生产模式构建：**
   ```bash
   ng build --configuration production
   # 或简写
   ng b -c production
   ```

2. **启用 Tree Shaking：**
   - 确保使用 ES 模块
   - 避免使用 CommonJS 模块

3. **懒加载模块：**
   ```typescript
   // 路由懒加载
   {
     path: 'admin',
     loadComponent: () => import('./admin/admin.component').then(m => m.AdminComponent)
   }
   ```

4. **使用 standalone 组件：**
   - 减少 NgModule 打包体积
   - 按需导入

5. **分析打包体积：**
   ```bash
   ng build --stats-json
   npx webpack-bundle-analyzer dist/stats.json
   ```

### Q14: 生产环境运行报错

**问题描述：** 开发环境正常，生产环境报错

**常见原因和解决方案：**

1. **AOT 编译错误**
   - 检查模板语法
   - 确保没有动态执行代码

2. **环境变量问题**
   ```typescript
   // 确保 environment.prod.ts 存在
   export const environment = {
     production: true,
     apiUrl: 'https://api.example.com'
   };
   ```

3. **路径大小写问题**
   - Linux 服务器区分大小写
   - 确保文件名大小写一致

### Q15: 部署到服务器后刷新 404

**问题描述：** 直接访问非首页路由返回 404

**解决方案：**

**Nginx 配置：**
```nginx
server {
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

**Apache 配置：**
```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

## 测试问题

### Q16: 单元测试找不到模块

**解决方案：**

```bash
# 安装缺失的类型定义
npm install --save-dev @types/jasmine @types/node

# 配置 tsconfig.spec.json
{
  "compilerOptions": {
    "module": "commonjs",
    "types": ["jasmine", "node"]
  }
}
```

### Q17: 组件测试中 HTTP 请求

**解决方案：**

```typescript
import { TestBed } from '@angular/core/testing';
import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing';

describe('UserService', () => {
  let service: UserService;
  let httpMock: HttpTestingController;
  
  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [UserService]
    });
    
    service = TestBed.inject(UserService);
    httpMock = TestBed.inject(HttpTestingController);
  });
  
  afterEach(() => {
    httpMock.verify();
  });
  
  it('should fetch users', () => {
    const mockUsers = [{ id: 1, name: '张三' }];
    
    service.getUsers().subscribe(users => {
      expect(users).toEqual(mockUsers);
    });
    
    const req = httpMock.expectOne('/api/users');
    expect(req.request.method).toBe('GET');
    req.flush(mockUsers);
  });
});
```

## 性能优化问题

### Q18: 变更检测导致性能问题

**解决方案：**

1. **使用 OnPush 变更检测策略：**
   ```typescript
   import { Component, ChangeDetectionStrategy } from '@angular/core';
   
   @Component({
     selector: 'app-example',
     changeDetection: ChangeDetectionStrategy.OnPush,
     template: '...'
   })
   export class ExampleComponent {}
   ```

2. **使用 Signal：**
   ```typescript
   import { signal, computed } from '@angular/core';
   
   count = signal(0);
   doubled = computed(() => this.count() * 2);
   ```

3. **使用 trackBy 函数：**
   ```html
   <li *ngFor="let item of items; trackBy: trackById">
     {{ item.name }}
   </li>
   ```
   
   ```typescript
   trackById(index: number, item: any): number {
     return item.id;
   }
   ```

### Q19: 首屏加载慢

**解决方案：**

1. **启用懒加载：**
   ```typescript
   {
     path: 'feature',
     loadChildren: () => import('./feature/feature.module').then(m => m.FeatureModule)
   }
   ```

2. **服务器端渲染 (SSR)：**
   ```bash
   ng add @angular/ssr
   ```

3. **预加载关键资源：**
   ```html
   <link rel="preload" href="main.js" as="script">
   ```

4. **图片优化：**
   - 使用 WebP 格式
   - 延迟加载图片

## 其他常见问题

### Q20: 如何升级 Angular 版本？

```bash
# 使用 Angular CLI 升级
ng update @angular/cli@<version>
ng update @angular/core@<version>

# 例如升级到 Angular 17
ng update @angular/cli@17 @angular/core@17

# 或使用 npx
npx @angular/cli@17 update
```

### Q21: 独立组件 vs NgModule

**选择建议：**

- **使用独立组件（Standalone）：**
  - Angular 14+ 推荐
  - 项目结构简单
  - 更好的 Tree Shaking
  
- **使用 NgModule：**
  - 大型团队项目
  - 需要严格的模块边界
  - 遗留项目维护

### Q22: 如何处理 CORS 错误？

**问题描述：**
```
Access-Control-Allow-Origin header is present on the requested resource
```

**解决方案：**

1. **后端配置 CORS**（推荐）
2. **使用代理服务器：**
   ```typescript
   // proxy.conf.json
   {
     "/api": {
       "target": "http://localhost:3000",
       "secure": false,
       "changeOrigin": true
     }
   }
   ```
   
   ```bash
   ng serve --proxy-config proxy.conf.json
   ```

### Q23: 如何调试 Angular 应用？

**方法：**

1. **Angular DevTools 扩展**
   - Chrome 扩展商店安装
   - 查看组件树、变更检测

2. **Augury**（旧版）
   - Chrome 扩展
   - 可视化调试工具

3. **浏览器开发者工具**
   - 断点调试
   - 查看网络请求
   - Console 输出

4. **VS Code 调试**
   - 使用 Chrome 调试配置

## 总结

本章节涵盖了 Angular 开发中最常见的问题：

- **安装问题**：权限、版本兼容性、网络问题
- **开发问题**：样式、绑定、路由、HTTP、内存泄漏
- **构建部署**：体积优化、生产环境、服务器配置
- **测试问题**：模块找不到、HTTP 模拟
- **性能问题**：变更检测、首屏加载

如果你遇到本文未涵盖的问题，建议：
1. 查阅官方文档：https://angular.io/docs
2. 搜索 Stack Overflow
3. 在 Angular 社区提问
4. 查看 GitHub Issues
