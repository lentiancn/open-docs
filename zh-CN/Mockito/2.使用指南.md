# Mockito 使用指南

高效使用 Mockito 进行单元测试的完整指南。

---

## 基本概念

### 什么是 Mockito？

Mockito 是一个 Java 单元测试模拟框架。它允许你创建模拟对象来替代真实依赖。

### 关键术语

| 术语 | 说明 |
|------|------|
| Mock | 模拟真实行为的假对象 |
| Stub | 方法调用的预定义响应 |
| Spy | 包装真实对象的局部模拟 |
| Verification | 检查方法是否被调用 |
| Argument Matcher | 方法参数的通配符匹配 |

---

## 创建 Mock

### 使用 Mockito.mock()

```java
import org.mockito.Mockito;

List<String> mockList = Mockito.mock(List.class);
```

### 使用 @Mock 注解

```java
@Mock
private List<String> mockList;

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
}
```

---

## Stubbing

### 基础 Stub

```java
// Stub 返回值
when(mockList.get(0)).thenReturn("first");

// Stub 多个返回值
when(mockList.get(0)).thenReturn("first", "second");

// Stub 抛出异常
when(mockList.get(0)).thenThrow(new RuntimeException("Error"));
```

### Stub void 方法

```java
// 什么也不做
doNothing().when(mockList).clear();

// 抛出异常
doThrow(new RuntimeException("Error")).when(mockList).clear();
```

---

## 验证行为

### 基础验证

```java
// 验证方法被调用
verify(mockList).add("element");

// 验证调用精确次数
verify(mockList, times(2)).add("element");

// 验证从未调用
verify(mockList, never()).clear();
```

---

## Argument Matcher

### 常用匹配器

```java
// 任意值
any(), anyInt(), anyString()

// 任意列表
anyList(), anyMap()

// 自定义匹配器
argThat(argument -> argument.length() > 3)
```

---

## Spy

### 创建 Spy

```java
// 使用 spy()
List<String> spyList = Mockito.spy(new ArrayList<>());

// 使用 @Spy 注解
@Spy
private List<String> spyList = new ArrayList<>();
```

### Mock vs Spy

| 特性 | Mock | Spy |
|------|------|-----|
| 默认行为 | 返回 null/默认值 | 调用真实方法 |
| Stubbing | 完全控制 | 只模拟 stub 的方法 |

---

## 注解

### @Mock

```java
@Mock
private UserService userService;
```

### @Spy

```java
@Spy
private UserService userService = new UserService();
```

### @InjectMocks

```java
@InjectMocks
private UserController userController;
```

### @Captor

```java
@Captor
private ArgumentCaptor<User> userCaptor;
```

---

## BDD 风格

```java
import static org.mockito.BDDMockito.*;

// Given
given(mockList.get(0)).willReturn("first");

// When
String result = mockList.get(0);

// Then
assertEquals("first", result);

// 验证
then(mockList).should(times(1)).get(0);
```

---

## 常用示例

### 测试异常

```java
@Test
void testException() {
    when(mockList.get(0)).thenThrow(new IndexOutOfBoundsException("Error"));
    
    assertThrows(IndexOutOfBoundsException.class, () -> {
        mockList.get(0);
    });
}
```

### ArgumentCaptor

```java
@Captor
private ArgumentCaptor<User> userCaptor;

@Test
void testArgumentCapture() {
    userService.saveUser(new User("John", "john@example.com"));
    
    verify(userRepository).save(userCaptor.capture());
    
    User captured = userCaptor.getValue();
    assertEquals("John", captured.getName());
}
```

---

## 最佳实践

1. **不要模拟值对象**：对 DTO 使用真实对象
2. **保持测试专注**：一次只测试一件事
3. **使用有意义的断言**：不只是验证，要断言实际值
4. **避免过度使用 mocks**：有时真实对象更好

---

## 下一步

- 探索 [Mockito 扩展](https://mockito-extensions.readthedocs.io/)
- 学习 [JUnit 5 集成](https://junit.org/junit5/docs/current/user-guide/)
