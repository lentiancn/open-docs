# Руководство пользователя DragonTalker

DragonTalker использует глубокое обучение для создания реалистичных видео с говорящей головой из одного изображения и аудио входных данных.

## Быстрый старт

### Основная команда

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### С улучшением

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## Параметры команды

### Параметры ввода

| Параметр | Описание | По умолчанию |
|----------|----------|---------------|
| `--source_image` | Путь к входному портретному изображению | Обязательно |
| `--driven_audio` | Входной аудиофайл (WAV/MP3) | Обязательно |
| `--result_dir` | Выходная директория | ./results |

### Параметры обработки

| Параметр | Описание | По умолчанию |
|----------|----------|---------------|
| `--preprocess` | Предобработка изображения: crop, resize, full | full |
| `--size` | Размер изображения: 256, 512 | 256 |
| `--pose_style` | Стиль позы 0-45 | 0 |
| `--expression_scale` | Интенсивность выражения 0.5-1.5 | 1.0 |

### Параметры улучшения

| Параметр | Описание | По умолчанию |
|----------|----------|---------------|
| `--enhancer` - | Улучшатель лица: gfpgan, RestoreFormer, CodeFormer | Нет |

### Параметры производительности

| Параметр | Описание | По умолчанию |
|----------|----------|---------------|
| `--batch_size` | Размер партии | 1 |
| `--fps` | Частота кадров выходного видео | 25 |

## Примеры использования

### Пример 1: Базовая генерация

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### Пример 2: Улучшение GFPGAN

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### Пример 3: Пользовательская поза

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### Пример 4: Высокое разрешение

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### Базовое использование

```python
from inference import DragonTalker

# Инициализация DragonTalker
dragon = DragonTalker()

# Создание видео
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"Видео сохранено: {video_path}")
```

### Расширенное использование

```python
from inference import DragonTalker
import torch

# Инициализация с пользовательскими настройками
dragon = DragonTalker(
    checkpoint_path="checkpoints/DragonTalker.pth",
    config_path="config/DragonTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Создание видео с расширенными опциями
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### Пакетная обработка

```python
from inference import DragonTalker
import os

dragon = DragonTalker()

# Обработка нескольких изображений (одно аудио)
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        dragon.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Веб-интерфейс

### Запуск веб-демо

```bash
python app.py
```

Затем откройте http://localhost:8888 в браузере

### Функции веб-интерфейса

1. **Загрузка изображения** - Перетащите портретное изображение
2. **Загрузка аудио** - Выберите аудиофайл (WAV/MP3)
3. **Предпросмотр** - Просмотр исходного изображения и аудио
4. **Настройка параметров** - Настройка позы, выражения, улучшателя
5. **Создание** - Создание видео одним кликом
6. **Скачивание** - Сохранение созданного видео

## Улучшатели лица

### Доступные улучшатели

| Улучшатель | Качество | Скорость | VRAM |
|------------|----------|----------|------|
| Нет | Базовая | Быстро | Низко |
| gfpgan | Хорошо | Средне | Средне |
| RestoreFormer | Очень хорошо | Медленно | Высоко |
| CodeFormer | Очень хорошо | Медленно | Высоко |

### Рекомендации

- **Низкий VRAM**: Без улучшателя или gfpgan
- **Баланс**: gfpgan
- **Лучшее качество**: RestoreFormer или CodeFormer

## Режимы предобработки

| Режим | Описание | Применение |
|-------|----------|------------|
| crop | Центрированная обрезка лица | Быстрая обработка |
| resize | Изменение до целевого размера | Простой фон |
| full | Полный конвейер обработки | Лучшее качество |

## Требования к входным данным

### Требования к изображению

- Формат: JPG, PNG
- Разрешение: Рекомендуется 512x512 или выше
- Лицо: Фронтальное, без遮挡
- Фон: Простой предпочтителен

### Требования к аудио

- Формат: WAV, MP3
- Длительность: 1-60 секунд
- Частота дискретизации: 16000-48000 Гц
- Речь: Чёткая, минимальный шум

## Выходные данные

### Формат видео

- Формат: MP4
- Кодек: H.264
- Разрешение: 256x256 или 512x512
- Частота кадров: 25
- Битрейт: 2-5 Мбит/с

### Выходная директория

Результаты сохраняются в указанной выходной директории:
```
results/
├── video.mp4          # Созданное видео
└── (временные файлы)
```

## Устранение неполадок

### Видео слишком тёмное/светлое

**Причина:** Несоответствие освещения между обучением и вводом

**Решения:**
- Настроить параметр expression_scale (0.8-1.2)
- Использовать изображение более высокого качества
- Попробовать другой улучшатель

### Губы не синхронизированы

**Причина:** Проблемы с качеством или выравниванием аудио

**Решения:**
- Использовать высококачественное аудио
- Убедиться, что аудио содержит чёткую речь
- Проверить синхронизацию аудио и видео

### Лицо деформировано

**Причина:** Низкое качество ввода или необычный ввод

**Решения:**
- Использовать изображение более высокого разрешения (512)
- Попробовать другой режим предобработки
- Использовать улучшатель лица
- Убедиться, что лицо чётко видно

### Медленная обработка

**Решения:**
- Использовать `--preprocess crop`
- Установить `--size 256`
- Отключить улучшатель
- Уменьшить размер партии

### Недостаточно памяти GPU

**Решения:**
- Уменьшить batch_size до 1
- Использовать меньший размер изображения
- Закрыть другие приложения GPU

## Советы по производительности

### Более быстрая обработка

1. Использовать `--preprocess crop`
2. Установить `--size 256`
3. Отключить улучшатель

### Лучшее качество

1. Использовать `--size 512`
2. Включить `--enhancer gfpgan`
3. Использовать `--preprocess full`

## Ссылки

- [GitHub](https://github.com/your-repo/DragonTalker)
- [HuggingFace](https://huggingface.co/spaces)
- [Модели](https://github.com/your-repo/DragonTalker/releases)
