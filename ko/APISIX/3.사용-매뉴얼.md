# Apache APISIX 사용 매뉴얼

## 기본 개념

### Route

요청 경로와 업스트림 서비스 간의 매핑을 정의합니다.

### Upstream

동일한 서비스를 제공하는 노드 그룹입니다.

### Consumer

인증 플러그인으로 인증해야 하는 API 사용자입니다.

## 시작하기

### 첫 번째 라우트 생성

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "my-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"httpbin.org:80": 1}
  }
}'
```

### 확인

```bash
curl "http://127.0.0.1:9080/ip"
```

## 로드밸런싱

### 가중치 Round-Robin

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"service-a:8080": 3, "service-b:8080": 1}
  }
}'
```

## 인증

### API 키

**Consumer 생성:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "user1",
  "plugins": {"key-auth": {"key": "my-secret-key"}}
}'
```

**라우트에서 활성화:**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-route" -X PATCH -d '
{"plugins": {"key-auth": {}}}
'
```

**키로 접근:**

```bash
curl "http://127.0.0.1:9080/ip" -H "apikey: my-secret-key"
```

## 레이트 리미팅

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

## 모니터링

### Prometheus

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {"prometheus": {}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

메트릭 가져오기:

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

## 명령어

### 라우트 목록

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 라우트 삭제

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-route" -X DELETE
```

## 권장 사항

1. 프로덕션에서 API 키 변경
2. HTTPS 사용
3. 헬스 체크 활성화
4. 합리적인 제한 설정
