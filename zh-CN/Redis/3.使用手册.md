# Redis 使用手册

本手册介绍 Redis 的核心命令和实际使用方法。

## 基础操作

### 连接

```bash
# 本地连接
redis-cli

# 远程连接
redis-cli -h 192.168.1.100 -p 6379

# 密码认证
redis-cli -a yourpassword

# 选择数据库
redis-cli -n 1  # 选择数据库1
```

### 键操作

```bash
# 设置键值
SET name "Tom"

# 获取值
GET name

# 设置多个键
MSET key1 value1 key2 value2

# 获取多个值
MGET key1 key2

# 删除键
DEL name

# 检查键是否存在
EXISTS name

# 获取键类型
TYPE name

# 设置过期时间（秒）
SET name "Tom"
EXPIRE name 60

# 设置过期时间（毫秒）
PSETEX name 60000 "Tom"

# 查看剩余过期时间
TTL name

# 移除过期时间
PERSIST name

# 查找键
KEYS pattern     # 慎用，会阻塞
SCAN 0 MATCH pattern
```

## STRING（字符串）

```bash
# 设置值
SET name "Tom"
SET age 25

# 获取值
GET name

# 自增
INCR age
INCRBY age 5
DECR age
DECRBY age 5

# 浮点数自增
SET score 10.5
INCRBYFLOAT score 2.5

# 追加
APPEND name " Smith"  # "Tom Smith"

# 获取字符串长度
STRLEN name

# 字符串截取
SET name "Tom"
GETRANGE name 0 1  # "To"
SETRANGE name 0 "Ja"  # "Jam"

# 批量操作
MSET user:1 "Tom" user:2 "Jerry"
MGET user:1 user:2
```

## LIST（列表）

```bash
# 左边入队
LPUSH fruits "apple"
LPUSH fruits "banana" "orange"

# 右边入队
RPUSH fruits "grape"

# 获取列表元素
LRANGE fruits 0 -1  # 获取所有

# 弹出元素
LPOP fruits  # 左边弹出
RPOP fruits  # 右边弹出

# 列表长度
LLEN fruits

# 获取指定索引元素
LINDEX fruits 0

# 设置指定索引元素
LSET fruits 0 "pear"

# 范围保留
LTRIM fruits 0 2

# 阻塞弹出
BLPOP fruits 0  # 阻塞等待
BRPOP fruits 0
```

## SET（集合）

```bash
# 添加元素
SADD tags "redis" "database" "cache"

# 获取所有元素
SMEMBERS tags

# 检查元素是否存在
SISMEMBER tags "redis"

# 集合大小
SCARD tags

# 随机弹出
SPOP tags

# 集合运算
SADD set1 "a" "b" "c"
SADD set2 "b" "c" "d"

SINTER set1 set2     # 交集: b,c
SUNION set1 set2     # 并集: a,b,c,d
SDIFF set1 set2      # 差集: a

# 集合运算并保存
SINTERSTORE result set1 set2
```

## ZSET（有序集合）

```bash
# 添加元素
ZADD leaderboard 1000 "user1"
ZADD leaderboard 800 "user2"
ZADD leaderboard 900 "user3"

# 获取排名（正序）
ZRANGE leaderboard 0 -1 WITHSCORES

# 获取排名（倒序）
ZREVRANGE leaderboard 0 -1 WITHSCORES

# 获取指定元素排名
ZRANK leaderboard "user2"
ZREVRANK leaderboard "user2"

# 增加分数
ZINCRBY leaderboard 100 "user2"

# 范围查询
ZRANGEBYSCORE leaderboard 800 1000
ZREVRANGEBYSCORE leaderboard 1000 800
```

## HASH（哈希表）

```bash
# 设置哈希
HSET user:1 name "Tom"
HSET user:1 age 25
HSET user:1 email "tom@example.com"

# 批量设置
HMSET user:2 name "Jerry" age 30 email "jerry@example.com"

# 获取哈希
HGET user:1 name
HMGET user:1 name age
HGETALL user:1

# 自增
HINCRBY user:1 age 1

# 删除字段
HDEL user:1 email

# 字段是否存在
HEXISTS user:1 name

# 字段数量
HLEN user:1

# 获取所有字段
HKEYS user:1

# 获取所有值
HVALS user:1
```

## BITMAP（位图）

```bash
# 设置位
SETBIT sign:user:1 0 1  # 第0天签到
SETBIT sign:user:1 1 1  # 第1天签到

# 获取位
GETBIT sign:user:1 0

# 位统计
BITCOUNT sign:user:1

# 位运算
SETBIT a 0 1
SETBIT a 3 1
SETBIT b 0 1
SETBIT b 3 1
BITOP AND result a b
```

## HYPERLOGLOG（基数统计）

```bash
# 添加元素
PFADD uv "user1" "user2" "user3"

# 统计基数
PFCOUNT uv

# 合并
PFADD uv1 "a" "b" "c"
PFADD uv2 "c" "d" "e"
PFMERGE uv3 uv1 uv2
PFCOUNT uv3
```

## GEOSPATIAL（地理位置）

```bash
# 添加位置
GEOADD cities 116.4074 39.9042 "beijing"
GEOADD cities 121.4737 31.2304 "shanghai"

# 获取位置
GEOPOS cities "beijing"

# 计算距离
GEODIST cities "beijing" "shanghai" km

# 附近搜索
GEORADIUS cities 116.4074 39.9042 500 km
GEORADIUSBYMEMBER cities "beijing" 500 km
```

## STREAM（流）

```bash
# 添加消息
XADD mystream * user "Tom" message "Hello"

# 读取消息
XRANGE mystream - +

# 读取新消息
XREAD COUNT 2 STREAMS mystream 0

# 创建消费者组
XGROUP CREATE mystream mygroup 0

# 读取消息
XREADGROUP GROUP mygroup consumer1 COUNT 10 STREAMS mystream >
```

## 事务

```bash
# 开启事务
MULTI

# 命令入队
SET name "Tom"
INCR counter
GET counter

# 执行事务
EXEC

# 取消事务
DISCARD
```

## 过期操作

```bash
# 设置过期时间
SET name "Tom"
EXPIRE name 60      # 60秒
EXPIREAT name 1640995200  # 精确时间戳

# 查看过期时间
TTL name
PTTL name  # 毫秒
```

## 发布/订阅

```bash
# 订阅频道
SUBSCRIBE news
PSUBSCRIBE news.*

# 发布消息
PUBLISH news "Breaking news!"

# 查看频道订阅
PUBSUB CHANNELS

# 查看订阅数
PUBSUB NUMSUB news
```

## 管道

```bash
# 管道批量执行
# 减少网络往返延迟
(pipeline) 
SET key1 value1
GET key1
INCR counter
```

##  Lua 脚本

```bash
# 执行脚本
EVAL "return 'hello'" 0

# 脚本中访问键
EVAL "return redis.call('get', KEYS[1])" 1 mykey

# 设置脚本缓存
SCRIPT LOAD "return 'hello'"
EVALSHA "sha1" 0
```

## 总结

本手册涵盖了 Redis 开发的常用命令：

- **键操作**：SET、GET、DEL、EXPIRE
- **STRING**：字符串操作
- **LIST**：列表操作
- **SET**：集合操作
- **ZSET**：有序集合
- **HASH**：哈希表
- **BITMAP**：位图
- **HYPERLOGLOG**：基数统计
- **GEOSPATIAL**：地理位置
- **STREAM**：消息流
- **事务**：MULTI/EXEC
- **发布/订阅**：PUB/SUB

掌握这些命令后，你就可以熟练使用 Redis 了。
