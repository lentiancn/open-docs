# Redis 使用指南

高效使用 Redis 的完整指南。

---

## 目录

- [基本概念](#基本概念)
- [数据类型](#数据类型)
- [字符串操作](#字符串操作)
- [列表操作](#列表操作)
- [哈希操作](#哈希操作)
- [集合操作](#集合操作)
- [有序集合操作](#有序集合操作)
- [键和过期时间](#键和过期时间)
- [发布/订阅](#发布订阅)
- [事务](#事务)
- [管道](#管道)
- [Lua 脚本](#lua-脚本)
- [持久化](#持久化)
- [复制](#复制)
- [集群](#集群)
- [安全性](#安全性)
- [性能优化](#性能优化)
- [常用示例](#常用示例)

---

## 基本概念

### 什么是 Redis？

Redis 是一个开源的内存数据结构存储系统，用作数据库、缓存和消息中间件。它支持多种数据结构，提供高性能。

### 主要特性

- 内存存储
- 数据持久化
- 主从复制
- 集群支持
- 发布/订阅消息
- Lua 脚本支持

### 关键术语

| 术语 | 说明 |
|------|------|
| Key | 值的唯一标识符 |
| Value | 存储在 Redis 中的数据 |
| TTL | 生存时间（过期时间） |
| Pipeline | 批量执行多条命令 |
| Master | Redis 主实例 |
| Slave | 主实例的副本 |

---

## 数据类型

Redis 支持多种数据类型：

| 类型 | 说明 |
|------|------|
| String | 字符串或二进制数据 |
| List | 有序字符串列表 |
| Hash | 字段-值对的集合 |
| Set | 无序唯一字符串集合 |
| Sorted Set | 带分数的有序集合 |
| HyperLogLog | 概率数据结构 |
| Bitmap | 位操作字符串 |
| Stream | 日志结构消息队列 |

---

## 字符串操作

### 基础命令

```bash
# 设置值
SET key "value"

# 获取值
GET key

# 设置多个键
MSET key1 "value1" key2 "value2"

# 获取多个键
MGET key1 key2

# 追加字符串
APPEND key " appended"

# 获取字符串长度
STRLEN key
```

### 数字操作

```bash
# 递增
INCR counter
INCRBY counter 10

# 递减
DECR counter
DECRBY counter 5

# 浮点数递增
INCRBYFLOAT price 0.5
```

---

## 列表操作

### 基础命令

```bash
# 左边插入
LPUSH mylist "first"

# 右边插入
RPUSH mylist "last"

# 左边弹出
LPOP mylist

# 右边弹出
RPOP mylist

# 获取范围
LRANGE mylist 0 -1

# 获取列表长度
LLEN mylist
```

---

## 哈希操作

### 基础命令

```bash
# 设置哈希字段
HSET user:1 name "John"

# 设置多个哈希字段
HMSET user:1 name "John" email "john@example.com"

# 获取哈希字段
HGET user:1 name

# 获取所有字段和值
HGETALL user:1

# 获取多个字段
HMGET user:1 name email

# 删除字段
HDEL user:1 email
```

---

## 集合操作

### 基础命令

```bash
# 添加到集合
SADD myset "member1"

# 从集合移除
SREM myset "member1"

# 获取所有成员
SMEMBERS myset

# 检查成员
SISMEMBER myset "member1"

# 获取集合大小
SCARD myset
```

### 集合运算

```bash
# 并集
SUNION set1 set2

# 交集
SINTER set1 set2

# 差集
SDIFF set1 set2
```

---

## 有序集合操作

### 基础命令

```bash
# 添加到有序集合
ZADD leaderboard 100 "player1"

# 获取范围（升序）
ZRANGE leaderboard 0 -1 WITHSCORES

# 获取范围（降序）
ZREVRANGE leaderboard 0 -1 WITHSCORES

# 获取排名
ZRANK leaderboard "player1"

# 增加分数
ZINCRBY leaderboard 50 "player1"
```

---

## 键和过期时间

### 键管理

```bash
# 删除键
DEL key

# 检查键是否存在
EXISTS key

# 获取键类型
TYPE key

# 重命名键
RENAME key newkey

# 获取所有键
KEYS pattern

# 扫描键
SCAN 0 MATCH pattern
```

### 过期时间

```bash
# 设置过期时间（秒）
EXPIRE key 60

# 设置过期时间（毫秒）
PEXPIRE key 60000

# 设置键并指定过期时间
SETEX key 60 "value"

# 移除过期时间
PERSIST key

# 获取剩余生存时间（秒）
TTL key

# 获取剩余生存时间（毫秒）
PTTL key
```

---

## 发布/订阅

### 发布

```bash
# 订阅频道
SUBSCRIBE mychannel

# 发布消息
PUBLISH mychannel "Hello"

# 模式订阅
PSUBSCRIBE news.*
```

### 命令

```bash
# 订阅
SUBSCRIBE channel1 channel2

# 发布
PUBLISH channel1 "message"

# 取消订阅
UNSUBSCRIBE channel1
```

---

## 事务

### 基础命令

```bash
# 开始事务
MULTI

# 队列命令
SET key1 "value1"
SET key2 "value2"

# 执行事务
EXEC

# 取消事务
DISCARD
```

### Watch

```bash
WATCH key
# ... 一些操作 ...
MULTI
SET key newvalue
EXEC  # 如果键被修改则失败
```

---

## 管道

### 使用管道

```bash
# 管道多个命令
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# 在代码中使用（Python 示例）
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Lua 脚本

### 基础脚本

```bash
# 执行 Lua 脚本
EVAL "return redis.call('get', 'key')" 0

# 使用 Lua 设置键
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### 脚本示例

```lua
-- 递增计数器
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## 持久化

### RDB（Redis 数据库）

```bash
# 手动保存
BGSAVE

# 获取上次保存时间
LASTSAVE
```

### AOF（仅追加文件）

```bash
# 在配置中启用
appendonly yes

# 重写 AOF
BGREWRITEAOF
```

### 配置

```bash
# 保存频率
save 900 1
save 300 10
save 60 10000
```

---

## 复制

### 设置从节点

```bash
# 在 redis.conf 中
replicaof masterip masterport

# 或通过命令
REPLICAOF masterip masterport
```

### 命令

```bash
# 检查复制状态
INFO replication

# 变为主节点
REPLICAOF NO ONE
```

---

## 集群

### 创建集群

```bash
# 创建集群
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# 查看集群节点
redis-cli -c cluster nodes
```

---

## 安全性

### 密码认证

```bash
# 在配置中设置密码
requirepass yourpassword

# 通过 CLI 认证
AUTH yourpassword
```

### ACL（Redis 6+）

```bash
# 创建用户
ACL SETUSER alice on >password ~cached:* +get +set

# 列出用户
ACL LIST
```

---

## 性能优化

### 内存优化

```bash
# 设置最大内存
maxmemory 2gb

# 淘汰策略
maxmemory-policy allkeys-lru
```

### 连接优化

```bash
# 使用连接池
# 在代码中
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## 常用示例

### 缓存

```bash
# 带过期时间的缓存
SET user:1:profile "data" EX 3600

# 检查缓存
GET user:1:profile
```

### 限流

```bash
# 简单限流
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### 分布式锁

```bash
# 获取锁
SET lock:myresource unique_value NX EX 10

# 释放锁
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### 会话存储

```bash
# 存储会话
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## 下一步

- 探索 [Redis Stack](https://redis.io/docs/stack/)
- 学习 [Redis Enterprise](https://redis.com/redis-enterprise/)
- 阅读 [性能调优指南](https://redis.io/docs/management/optimization/)
