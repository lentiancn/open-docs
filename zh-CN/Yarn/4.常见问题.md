# Yarn 常见问题解答

本页面汇总了 Yarn 使用过程中最常见的问题和解答。如果你在使用 Yarn 时遇到问题，首先应该在这里寻找解决方案。如果仍然无法解决，建议查看官方文档或在社区寻求帮助。

---

## 基础问题

### 什么是 Yarn？

Yarn 是一个 JavaScript 包管理器，由 Facebook（现 Meta）开发并维护。它可以帮助你安装、更新、配置和删除项目中的依赖包。Yarn 以其速度、确定性和安全性著称，是 npm 的流行替代品。

### Yarn 和 npm 有什么区别？

主要区别在于：

- **速度**：Yarn 使用并行下载，通常比 npm 更快
- **确定性**：Yarn 的 yarn.lock 文件确保每次安装结果完全一致
- **离线支持**：Yarn 有强大的离线缓存功能
- **工作区**：Yarn 原生支持 monorepo 工作区
- **输出**：Yarn 的命令行输出更清晰、更美观

### Yarn 是免费的吗？

是的，Yarn 是完全免费的开源项目，采用 MIT 许可证。源代码托管在 GitHub 上。

### 我需要什么版本的 Node.js？

- **Yarn 4.x**：需要 Node.js 16.0.0 或更高版本
- **Yarn 3.x**：需要 Node.js 14.0.0 或更高版本
- **Yarn 1.x**：需要 Node.js 8.0.0 或更高版本

推荐使用 Node.js 18 LTS 或 20 LTS 以获得最佳性能和稳定性。

### Yarn 1.x 和 Yarn 4.x 有什么区别？

Yarn 1.x 是经典版本，已经停止新功能开发。Yarn 4.x（也称为 Berry）是完全重写的版本，提供了：

- 更好的性能
- PnP（Plug'n'Play）模式
- 更强大的插件系统
- Zero-Installs 功能
- 更现代的配置方式（.yarnrc.yml）

---

## 安装问题

### 安装失败怎么办？

1. 检查 Node.js 版本：
   ```bash
   node --version
   ```
   确保 Node.js 版本 >= 16.0.0

2. 清理 npm 缓存：
   ```bash
   npm cache clean --force
   ```

3. 使用官方推荐的安装方式：
   ```bash
   corepack enable
   corepack prepare yarn@stable --activate
   ```

4. 检查权限问题，不要使用 sudo

### Windows 上安装有问题？

Windows 用户推荐使用以下方式之一：

1. **使用 PowerShell（推荐）**：
   ```powershell
   iwr -useb https://yarnpkg.com/install.ps1 | iex
   ```

2. **使用 winget**：
   ```bash
   winget install Yarn.Yarn
   ```

3. **使用 Chocolatey**：
   ```bash
   choco install yarn
   ```

如果遇到问题，尝试关闭杀毒软件后重新安装。

### 如何升级 Yarn？

使用 Corepack 升级：

```bash
corepack prepare yarn@stable --activate
```

或使用 npm：

```bash
npm update -g yarn
```

### 安装后命令找不到？

确保 Yarn 的全局 bin 目录在 PATH 中：

```bash
# 临时添加
export PATH="$(yarn global bin):$PATH"

# 永久添加（添加到 ~/.bashrc 或 ~/.zshrc）
echo 'export PATH="$(yarn global bin):$PATH"' >> ~/.bashrc
source ~/.bashrc
```

### 如何切换 Yarn 版本？

使用 Corepack 轻松切换：

```bash
# 切换到 Yarn 4.x
corepack prepare yarn@4.0.0 --activate

# 切换到 Yarn 1.x
corepack prepare yarn@1.22.22 --activate
```

---

## 使用问题

### 如何添加依赖？

```bash
# 添加运行时依赖
yarn add lodash

# 添加开发依赖
yarn add -D typescript
yarn add --dev eslint

# 添加特定版本
yarn add lodash@4.17.21
```

### 如何移除依赖？

```bash
yarn remove lodash
```

### 如何更新依赖？

```bash
# 更新到最新版本
yarn up lodash

# 交互式更新
yarn up -i

# 更新所有依赖
yarn up --all
```

### 依赖安装失败？

1. 清理缓存：
   ```bash
   yarn cache clean
   ```

2. 删除 node_modules 和 yarn.lock：
   ```bash
   rm -rf node_modules yarn.lock
   ```

3. 重新安装：
   ```bash
   yarn install
   ```

### 如何运行脚本？

```bash
# 运行 package.json 中定义的脚本
yarn dev
yarn build
yarn test

# 运行自定义脚本
yarn run my-script
```

### 如何查看依赖树？

```bash
yarn list

# 只显示顶层依赖
yarn list --level=0
```

---

## 工作区问题

### 什么是工作区？

工作区允许你在单个代码库中管理多个相关的包（monorepo）。当你有一个核心库和多个相关工具时，工作区特别有用。

### 如何配置工作区？

在根 package.json 中添加：

```json
{
  "workspaces": [
    "packages/*"
  ]
}
```

### 工作区之间如何引用？

使用 workspace: 协议：

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:^"
  }
}
```

### 如何在工作区中运行命令？

```bash
# 在特定工作区添加依赖
yarn workspace @my-org/core add lodash

# 在特定工作区运行脚本
yarn workspace @my-org/core run build

# 在所有工作区运行
yarn workspaces foreach -pt run build
```

### 工作区依赖不同步？

使用约束（Constraints）来强制同步：

创建 constraints.pro 文件并运行：

```bash
yarn constraints
```

---

## 配置问题

### 配置文件在哪里？

- **Yarn 4.x**：`.yarnrc.yml`
- **Yarn 1.x**：`.yarnrc`

### 如何配置私有注册表？

在 `.yarnrc.yml` 中：

```yaml
npmRegistryServer: "https://registry.mycompany.com"
```

或者使用命令：

```bash
yarn config set registry https://registry.mycompany.com
```

### 如何使用 PnP 模式？

在 `.yarnrc.yml` 中：

```yaml
nodeLinker: pnp
```

### 如何启用硬化模式？

```bash
yarn install --immutable
```

---

## 性能问题

### 安装太慢？

1. 使用离线缓存：
   ```bash
   yarn install --offline
   ```

2. 并行下载默认已启用，确保网络条件良好

3. 清理不需要的缓存：
   ```bash
   yarn cache clean
   ```

### CI/CD 如何加速？

1. 使用 Zero-Installs：
   ```yaml
   # .yarnrc.yml
   enableGlobalCache: false
   ```

2. 提交缓存到代码库

3. 使用 --immutable 防止意外修改

---

## 依赖问题

### 依赖版本冲突？

Yarn 会自动解决依赖冲突。如果遇到问题：

1. 检查依赖树：
   ```bash
   yarn list
   ```

2. 查看为什么安装某个包：
   ```bash
   yarn why lodash
   ```

3. 使用约束强制同步版本

### peerDependencies 警告？

这是正常的，表示某个包期望宿主提供特定的依赖。确保在项目中安装相应的依赖：

```bash
yarn add -P react
```

### 依赖过时怎么办？

```bash
yarn outdated
yarn up
```

---

## Lock 文件问题

### 什么是 yarn.lock？

yarn.lock 记录了所有依赖的确切版本，确保每次安装结果一致。

### 应该提交 yarn.lock 吗？

**是的**，始终将 yarn.lock 提交到版本控制系统。这是 Yarn 最重要的特性之一。

### lock 文件被意外修改？

恢复 lock 文件：

```bash
git checkout yarn.lock
```

在 CI 中检测意外修改：

```bash
yarn install --immutable
```

---

## 其他问题

### 如何查看 Yarn 版本？

```bash
yarn --version
```

### 如何获取帮助？

- 官方文档：https://yarnpkg.com/docs
- GitHub Issues：https://github.com/yarnpkg/berry/issues
- Discord 社区：https://discord.gg/yarn
- Stack Overflow：添加 "yarnpkg" 标签

### 如何报告 Bug？

1. 确认问题可重现
2. 收集信息：
   ```bash
   yarn --version
   node --version
   yarn config list
   ```
3. 在 GitHub 提交 Issue

### 如何删除 node_modules？

```bash
rm -rf node_modules
```

### npm 和 Yarn 可以混用吗？

技术上可以，但不推荐。混用可能导致依赖版本不一致。建议在一个项目中坚持使用一种包管理器。

### 如何从 npm 迁移到 Yarn？

直接删除 node_modules 和 package-lock.json，然后运行：

```bash
yarn install
```

Yarn 会生成新的 yarn.lock 文件。

### 如何从 Yarn 迁移到 npm？

删除 yarn.lock，然后运行：

```bash
npm install
```

npm 会生成新的 package-lock.json。

---

## 相关资源链接

- 官方网站：https://yarnpkg.com
- 官方文档：https://yarnpkg.com/docs
- CLI 参考：https://yarnpkg.com/cli
- 配置参考：https://yarnpkg.com/configuration
- GitHub：https://github.com/yarnpkg/berry
- Discord：https://discord.gg/yarn
