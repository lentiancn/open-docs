# Yarn 使用手册

本手册将详细介绍 Yarn 的各项功能和使用方法，帮助你充分利用这个强大的包管理器。无论你是初学者还是有经验的开发者，都能在这里找到有用的信息。

---

## 基础概念

### 什么是 package.json？

package.json 是 Node.js 项目的核心配置文件，它包含了项目的元数据、依赖列表和脚本命令。

**基本结构：**

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "description": "我的项目",
  "main": "index.js",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "test": "vitest"
  },
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "typescript": "^5.0.0"
  }
}
```

### 依赖类型

Yarn 支持多种依赖类型：

- **dependencies**：项目运行时需要的依赖
- **devDependencies**：开发时需要的依赖（如测试工具、构建工具）
- **peerDependencies**：对等依赖，规定宿主项目必须提供的依赖
- **optionalDependencies**：可选依赖，安装失败不会导致项目失败

### yarn.lock

yarn.lock 文件记录了所有依赖的确切版本和依赖树，确保每次安装的结果完全一致。

---

## 日常使用

### 初始化新项目

```bash
# 交互式创建
yarn init

# 非交互式创建
yarn init -y
```

### 安装依赖

**安装所有依赖：**

```bash
yarn install
# 或简写
yarn
```

**安装并生成锁文件：**

```bash
yarn install --immutable
```

### 添加依赖

**添加正式依赖：**

```bash
yarn add lodash
yarn add react react-dom
```

**添加开发依赖：**

```bash
yarn add -D typescript
yarn add --dev eslint
```

**添加特定版本：**

```bash
yarn add lodash@4.17.21
yarn add react@18.2.0
```

**添加最新版本：**

```bash
yarn add lodash@latest
```

**添加可选依赖：**

```bash
yarn add -O fsevents
```

**添加对等依赖：**

```bash
yarn add -P @types/react
```

**使用不同版本修饰符：**

```bash
# 精确版本
yarn add -E lodash

# Tilde 版本（补丁版本）
yarn add -T lodash

# Caret 版本（次版本）
yarn add -C lodash
```

### 移除依赖

```bash
yarn remove lodash
yarn remove typescript --dev
```

### 更新依赖

**更新到最新版本：**

```bash
yarn up lodash
yarn up react
```

**更新到特定版本：**

```bash
yarn up lodash@4.17.20
```

**更新所有依赖：**

```bash
yarn up --all
```

**交互式更新：**

```bash
yarn up -i
```

---

## 运行脚本

### package.json 中的脚本

在 package.json 中定义脚本：

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test": "vitest",
    "lint": "eslint src",
    "format": "prettier --write src"
  }
}
```

### 运行脚本

```bash
# 运行 dev 脚本
yarn dev

# 运行 build 脚本
yarn build

# 运行自定义脚本
yarn run my-script

# 运行多个脚本
yarn build && yarn test
```

### 传递参数

```bash
# 传递额外参数
yarn dev --port 3000

# 传递多个参数
yarn build --env production --analyze
```

---

## 查看依赖信息

### 列出依赖

```bash
# 列出所有依赖
yarn list

# 列出顶级依赖
yarn list --level=0

# 树形显示依赖
yarn list --tree
```

### 检查过时依赖

```bash
yarn outdated
```

输出示例：

```
Package            Current   Wanted   Latest  Package Type    URL
lodash             4.17.20  4.17.21  4.17.21  dependencies    https://lodash.com/
typescript         5.0.2    5.0.4    5.1.0   devDependencies  https://typescriptlang.org/
```

### 查看包信息

```bash
# 查看包详情
yarn info lodash

# 查看特定版本
yarn info lodash@4.17.21

# 查看包的依赖
yarn info lodash dependencies
```

### 查看依赖原因

```bash
yarn why lodash
```

---

## 工作区（Workspaces）

工作区是 Yarn 最强大的功能之一，允许你在单个代码库中管理多个包。

### 配置工作区

在根 package.json 中添加 workspaces 字段：

```json
{
  "name": "my-monorepo",
  "workspaces": [
    "packages/*"
  ]
}
```

### 创建工作区包

在 packages 目录下创建子包：

```
my-monorepo/
├── package.json
└── packages/
    ├── core/
    │   └── package.json
    ├── ui/
    │   └── package.json
    └── utils/
        └── package.json
```

### 工作区命令

**在工作区中添加依赖：**

```bash
# 在根目录添加，所有工作区共享
yarn add lodash

# 在特定工作区添加
yarn workspace @my-org/core add lodash
```

**在工作区中运行脚本：**

```bash
yarn workspace @my-org/core run build
```

**在所有工作区运行命令：**

```bash
# 构建所有工作区
yarn workspaces foreach -pt run build

# 聚焦单个工作区
yarn workspaces focus @my-org/app
```

**列出所有工作区：**

```bash
yarn workspaces list
```

### 工作区间依赖

使用 workspace: 协议引用工作区：

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:^"
  }
}
```

---

## 插件系统

Yarn 的插件系统允许你扩展其功能。

### 安装插件

```bash
# 安装官方插件
yarn plugin import @yarnpkg/plugin-github

# 安装社区插件
yarn plugin import https://example.com/plugin.js
```

### 常用插件

- **@yarnpkg/plugin-github**：支持 GitHub 包
- **@yarnpkg/plugin-npm**：npm 相关功能
- **@yarnpkg/plugin-pack**：打包功能
- **@yarnpkg/plugin-workspace-tools**：工作区工具

### 创建自定义插件

你可以创建自己的 Yarn 插件来满足特定需求。

---

## 缓存管理

### 查看缓存

```bash
# 查看缓存位置
yarn cache dir

# 列出缓存的包
yarn cache list
```

### 清理缓存

```bash
# 清理所有缓存
yarn cache clean

# 清理特定包
yarn cache clean lodash
```

### 全局缓存

在 .yarnrc.yml 中启用全局缓存：

```yaml
enableGlobalCache: true
```

---

## 配置

### .yarnrc.yml

Yarn 4+ 使用 .yarnrc.yml 作为配置文件：

```yaml
# npm 注册表
npmRegistryServer: "https://registry.npmjs.org"

# 启用全局缓存
enableGlobalCache: false

# Node.js 链接器
nodeLinker: node-modules

# 安装模式
enableScripts: true
enableGlobalPatches: false
```

### 配置选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| `nodeLinker` | Node.js 链接器 | "node-modules" |
| `npmRegistryServer` | npm 注册表 | "https://registry.npmjs.org" |
| `enableGlobalCache` | 启用全局缓存 | false |
| `enableScripts` | 启用生命周期脚本 | true |
| `unsafeHttpWhitelist` | 允许的 HTTP 主机 | [] |

---

## 高级功能

### Zero-Installs

零安装功能允许你跳过安装过程，只需将缓存和 .pnp.cjs 文件提交到代码库。

**启用：**

```yaml
# 在 .yarnrc.yml 中
enableGlobalCache: false
```

**验证项目：**

```bash
yarn install --immutable --immutable-cache
```

### 硬核模式

在 CI 环境中使用硬核模式防止锁文件被意外修改：

```bash
yarn install --immutable
```

### 约束（Constraints）

约束允许你在 monorepo 中强制执行规则：

```javascript
// constraints.pro

// 确保所有工作区使用相同版本的 TypeScript
workspaces.forEach(workspace => {
  const ts = workspace.dependencies.get("typescript");
  if (ts && ts.version !== "^5.0.0") {
    workspace.dependencies.set("typescript", "workspace:^5.0.0");
  }
});
```

---

## 调试和故障排除

### 详细输出

```bash
# 详细模式
yarn add lodash -v

# 调试模式
YARN_DEBUG=1 yarn add lodash
```

### 查看日志

```bash
# 查看 Yarn 日志
ls -la ~/.yarn/logs/
```

### 诊断问题

```bash
# 检查配置
yarn config list

# 检查环境
yarn info environment
```

---

## 常用命令速查表

| 命令 | 说明 |
|------|------|
| `yarn init` | 初始化项目 |
| `yarn install` | 安装依赖 |
| `yarn add <pkg>` | 添加依赖 |
| `yarn remove <pkg>` | 移除依赖 |
| `yarn up <pkg>` | 更新依赖 |
| `yarn run <script>` | 运行脚本 |
| `yarn list` | 列出依赖 |
| `yarn outdated` | 检查过时依赖 |
| `yarn info <pkg>` | 查看包信息 |
| `yarn why <pkg>` | 查看依赖原因 |
| `yarn cache clean` | 清理缓存 |
| `yarn config get <key>` | 获取配置 |
| `yarn config set <key> <value>` | 设置配置 |
| `yarn workspaces foreach` | 在所有工作区运行 |
| `yarn workspace <name> <cmd>` | 在工作区运行命令 |

---

## 最佳实践

### 1. 提交 yarn.lock

始终将 yarn.lock 文件提交到版本控制系统，确保团队成员使用相同的依赖版本。

### 2. 使用 --immutable 在 CI 中

在 CI/CD 流程中使用 `--immutable` 标志：

```bash
yarn install --immutable
```

### 3. 定期更新依赖

定期运行 `yarn up` 更新依赖，获取安全修复和新功能。

### 4. 使用工作区

对于多包项目，使用工作区简化依赖管理。

### 5. 合理使用依赖类型

- 仅运行时需要的依赖放在 dependencies
- 仅开发时需要的依赖放在 devDependencies

### 6. 清理不需要的依赖

定期运行 `yarn up --all` 清理未使用的依赖。

---

## 下一步

- [常见问题](/4.常见问题.md)：解答使用中的常见疑问
- [官方文档](https://yarnpkg.com/docs)：获取完整的配置参考
- [插件列表](https://yarnpkg.com/plugins)：探索可用插件
