# Angular 使用手册

本手册详细介绍 Angular 的核心概念、组件开发、服务与依赖注入、路由、表单处理、HTTP 请求等内容。

---

## 目录

1. [Angular 核心概念](#angular-核心概念)
2. [组件开发](#组件开发)
3. [模板语法](#模板语法)
4. [服务与依赖注入](#服务与依赖注入)
5. [路由](#路由)
6. [表单处理](#表单处理)
7. [HTTP 请求](#http-请求)
8. [状态管理](#状态管理)
9. [Angular CLI 命令](#angular-cli-命令)
10. [最佳实践](#最佳实践)

---

## Angular 核心概念

### 架构概览

Angular 应用由以下核心部分组成：

- **模块（Module）**：组织应用的代码块
- **组件（Component）**：控制屏幕上一块区域
- **模板（Template）**：组件的视图
- **服务（Service）**：可复用的业务逻辑
- **指令（Directive）**：给模板添加行为

### 模块（NgModule）

NgModule 是 Angular 的核心组织单元：

```typescript
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { HttpClientModule } from '@angular/common/http';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';

import { AppComponent } from './app.component';
import { HomeComponent } from './home/home.component';

@NgModule({
  declarations: [
    AppComponent,
    HomeComponent
  ],
  imports: [
    BrowserModule,
    HttpClientModule,
    FormsModule,
    ReactiveFormsModule
  ],
  providers: [],
  bootstrap: [AppComponent]
})
export class AppModule { }
```

### 独立组件（Standalone Components）

Angular 14+ 支持独立组件，无需 NgModule：

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, RouterModule],
  template: `
    <h1>我的 Angular 应用</h1>
    <nav>
      <a routerLink="/home">首页</a>
      <a routerLink="/about">关于</a>
    </nav>
    <router-outlet></router-outlet>
  `
})
export class AppComponent { }
```

---

## 组件开发

### 创建组件

使用 Angular CLI 创建组件：

```bash
# 创建组件
ng generate component components/user-list

# 创建独立组件
ng generate component components/user-list --standalone

# 创建带样式的组件
ng generate component components/user-list --style=scss

# 创建带路由的组件
ng generate component components/user-list --routing
```

### 组件基本结构

```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';

@Component({
  selector: 'app-user',
  templateUrl: './user.component.html',
  styleUrls: ['./user.component.css']
})
export class UserComponent implements OnInit, OnDestroy {
  // 输入属性
  userId: string = '';
  userName: string = '';
  
  // 组件内部状态
  isLoading: boolean = false;
  users: User[] = [];

  // 生命周期钩子
  ngOnInit(): void {
    console.log('组件初始化');
    this.loadUsers();
  }

  ngOnDestroy(): void {
    console.log('组件销毁');
  }

  loadUsers(): void {
    this.isLoading = true;
    // 加载用户逻辑
  }
}

interface User {
  id: number;
  name: string;
  email: string;
}
```

### 组件通信

#### 父组件向子组件传值（@Input）

```typescript
// 子组件
import { Component, Input } from '@angular/core';

@Component({
  selector: 'app-child',
  template: '<p>收到的消息: {{ message }}</p>'
})
export class ChildComponent {
  @Input() message: string = '';
}

// 父组件
@Component({
  selector: 'app-parent',
  template: '<app-child [message]="parentMessage"></app-child>'
})
export class ParentComponent {
  parentMessage = '来自父组件的消息';
}
```

#### 子组件向父组件传值（@Output + EventEmitter）

```typescript
// 子组件
import { Component, Output, EventEmitter } from '@angular/core';

@Component({
  selector: 'app-child',
  template: '<button (click)="sendMessage()">发送消息</button>'
})
export class ChildComponent {
  @Output() messageEvent = new EventEmitter<string>();

  sendMessage() {
    this.messageEvent.emit('来自子组件的消息');
  }
}

// 父组件
@Component({
  selector: 'app-parent',
  template: '<app-child (messageEvent)="receiveMessage($event)"></app-child>'
})
export class ParentComponent {
  receiveMessage(message: string) {
    console.log(message);
  }
}
```

#### 组件样式

```typescript
@Component({
  selector: 'app-styled',
  template: `
    <div class="container">
      <h1>样式示例</h1>
    </div>
  `,
  styles: [`
    .container {
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
  `]
})
export class StyledComponent { }
```

---

## 模板语法

### 数据绑定

```html
<!-- 插值绑定 -->
<p>用户名: {{ userName }}</p>

<!-- 属性绑定 -->
<img [src]="imageUrl" [alt]="imageAlt">

<!-- 事件绑定 -->
<button (click)="onSave()">保存</button>

<!-- 双向绑定 -->
<input [(ngModel)]="username">
```

### 条件渲染

```html
<!-- if 条件 -->
<div *ngIf="isLoggedIn">
  欢迎回来！
</div>

<!-- if-else 条件 -->
<div *ngIf="isLoggedIn; else loginTemplate">
  欢迎回来！
</div>
<ng-template #loginTemplate>
  请登录
</ng-template>

<!-- @if (Angular 17+ 新语法) -->
@if (isLoggedIn) {
  欢迎回来！
} @else {
  请登录
}
```

### 循环渲染

```html
<!-- ngFor 循环 -->
<ul>
  <li *ngFor="let user of users; trackBy: trackById">
    {{ user.name }}
  </li>
</ul>

<!-- @for (Angular 17+ 新语法) -->
@for (user of users; track user.id) {
  <li>{{ user.name }}</li>
}
```

### 管道（Pipe）

```html
<!-- 日期管道 -->
<p>日期: {{ today | date:'yyyy-MM-dd' }}</p>

<!-- 大小写管道 -->
<p>大写: {{ name | uppercase }}</p>
<p>小写: {{ name | lowercase }}</p>

<!-- 货币管道 -->
<p>价格: {{ price | currency:'CNY' }}</p>

<!-- 小数管道 -->
<p>数字: {{ number | number:'1.2-2' }}</p>

<!-- JSON 管道（调试用） -->
<pre>{{ object | json }}</pre>
```

### 内置管道

| 管道 | 说明 | 示例 |
|------|------|------|
| date | 日期格式化 | date:'yyyy-MM-dd' |
| uppercase | 转换为大写 | uppercase |
| lowercase | 转换为小写 | lowercase |
| currency | 货币格式化 | currency:'CNY' |
| percent | 百分比格式化 | percent |
| number | 数字格式化 | number:'1.2-2' |
| json | JSON 序列化 | json |
| slice | 截取数组/字符串 | slice:0:5 |
| async | 异步对象 | async |

---

## 服务与依赖注入

### 创建服务

```bash
# 创建服务
ng generate service services/user

# 创建带路径的服务
ng generate service services/user/user
```

### 服务基本结构

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { User } from '../models/user.model';

@Injectable({
  providedIn: 'root'  // 全局单例
})
export class UserService {
  private apiUrl = 'https://api.example.com/users';

  constructor(private http: HttpClient) { }

  // 获取用户列表
  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl);
  }

  // 获取单个用户
  getUser(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`);
  }

  // 创建用户
  createUser(user: Partial<User>): Observable<User> {
    return this.http.post<User>(this.apiUrl, user);
  }

  // 更新用户
  updateUser(id: number, user: Partial<User>): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user);
  }

  // 删除用户
  deleteUser(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

### 使用服务

```typescript
import { Component, OnInit } from '@angular/core';
import { UserService } from '../services/user.service';
import { User } from '../models/user.model';

@Component({
  selector: 'app-user-list',
  template: `
    <div *ngFor="let user of users">
      {{ user.name }}
    </div>
  `
})
export class UserListComponent implements OnInit {
  users: User[] = [];

  // 依赖注入
  constructor(private userService: UserService) { }

  ngOnInit(): void {
    this.loadUsers();
  }

  loadUsers(): void {
    this.userService.getUsers().subscribe({
      next: (data) => this.users = data,
      error: (err) => console.error('获取用户失败', err)
    });
  }
}
```

### 依赖注入 providers

```typescript
// 方式一：providedIn: 'root'（推荐）
@Injectable({
  providedIn: 'root'
})

// 方式二：在组件级别提供
@Component({
  selector: 'app-my',
  providers: [MyService]
})

// 方式三：在模块级别提供
@NgModule({
  providers: [MyService]
})
```

---

## 路由

### 配置路由

```typescript
import { NgModule } from '@angular/core';
import { RouterModule, Routes } from '@angular/router';
import { HomeComponent } from './home/home.component';
import { AboutComponent } from './about/about.component';
import { UserComponent } from './user/user.component';
import { NotFoundComponent } from './not-found/not-found.component';

const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { path: 'home', component: HomeComponent },
  { path: 'about', component: AboutComponent },
  { path: 'users/:id', component: UserComponent },
  { path: '**', component: NotFoundComponent }
];

@NgModule({
  imports: [RouterModule.forRoot(routes)],
  exports: [RouterModule]
})
export class AppRoutingModule { }
```

### 路由链接

```html
<!-- 基本链接 -->
<a routerLink="/home">首页</a>
<a routerLink="/about">关于</a>

<!-- 带参数的链接 -->
<a [routerLink]="['/users', user.id]">用户详情</a>

<!-- 激活状态 -->
<a routerLink="/home" routerLinkActive="active">首页</a>

<!-- 路由出口 -->
<router-outlet></router-outlet>
```

### 编程式导航

```typescript
import { Router } from '@angular/router';

constructor(private router: Router) { }

// 导航到指定路径
this.router.navigate(['/home']);

// 导航带参数
this.router.navigate(['/users', userId]);

// 导航带查询参数
this.router.navigate(['/search'], { queryParams: { q: 'keyword' } });

// 导航带状态
this.router.navigate(['/detail'], { state: { data: { id: 1 } } });

// 返回上一页
this.router.navigate(['..']);
```

### 路由参数获取

```typescript
import { ActivatedRoute } from '@angular/router';

constructor(private route: ActivatedRoute) { }

ngOnInit(): void {
  // 获取路由参数
  this.route.paramMap.subscribe(params => {
    const id = params.get('id');
  });

  // 获取查询参数
  this.route.queryParamMap.subscribe(queryParams => {
    const page = queryParams.get('page');
  });
}
```

### 路由守卫

#### CanActivate - 路由守卫

```typescript
import { Injectable } from '@angular/core';
import { CanActivate, Router } from '@angular/router';

@Injectable({
  providedIn: 'root'
})
export class AuthGuard implements CanActivate {
  constructor(private router: Router) { }

  canActivate(): boolean {
    const isLoggedIn = /* 检查登录状态 */;
    if (!isLoggedIn) {
      this.router.navigate(['/login']);
      return false;
    }
    return true;
  }
}
```

使用守卫：

```typescript
const routes: Routes = [
  { 
    path: 'dashboard', 
    component: DashboardComponent,
    canActivate: [AuthGuard]
  }
];
```

---

## 表单处理

### 模板驱动表单

```typescript
import { Component } from '@angular/core';
import { NgForm } from '@angular/forms';

@Component({
  selector: 'app-login',
  template: `
    <form #loginForm="ngForm" (ngSubmit)="onSubmit(loginForm)">
      <input 
        type="email" 
        name="email" 
        [(ngModel)]="email"
        required
        email
        #emailInput="ngModel">
      <div *ngIf="emailInput.invalid && emailInput.touched">
        请输入有效的邮箱地址
      </div>
      
      <input 
        type="password" 
        name="password" 
        [(ngModel)]="password"
        required
        minlength="6"
        #passwordInput="ngModel">
      
      <button type="submit" [disabled]="loginForm.invalid">登录</button>
    </form>
  `
})
export class LoginComponent {
  email: string = '';
  password: string = '';

  onSubmit(form: NgForm): void {
    if (form.valid) {
      console.log('表单提交', form.value);
    }
  }
}
```

### 响应式表单

```typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-register',
  template: `
    <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
      <div>
        <label>用户名</label>
        <input formControlName="username">
        <div *ngIf="registerForm.get('username')?.invalid && 
                    registerForm.get('username')?.touched">
          用户名必填，至少3个字符
        </div>
      </div>
      
      <div>
        <label>邮箱</label>
        <input formControlName="email">
      </div>
      
      <div formGroupName="address">
        <label>城市</label>
        <input formControlName="city">
      </div>
      
      <button type="submit" [disabled]="registerForm.invalid">注册</button>
    </form>
  `
})
export class RegisterComponent implements OnInit {
  registerForm!: FormGroup;

  constructor(private fb: FormBuilder) { }

  ngOnInit(): void {
    this.registerForm = this.fb.group({
      username: ['', [Validators.required, Validators.minLength(3)]],
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(6)]],
      address: this.fb.group({
        city: [''],
        street: ['']
      })
    });
  }

  onSubmit(): void {
    if (this.registerForm.valid) {
      console.log('表单提交', this.registerForm.value);
    }
  }
}
```

### 表单验证器

```typescript
import { AbstractControl, ValidationErrors, ValidatorFn } from '@angular/forms';

// 自定义验证器
export function passwordMatcher(): ValidatorFn {
  return (control: AbstractControl): ValidationErrors | null => {
    const password = control.get('password');
    const confirmPassword = control.get('confirmPassword');
    
    if (password && confirmPassword && 
        password.value !== confirmPassword.value) {
      return { passwordMismatch: true };
    }
    return null;
  };
}
```

---

## HTTP 请求

### 配置 HttpClient

```typescript
import { HttpClientModule } from '@angular/common/http';

@NgModule({
  imports: [
    HttpClientModule
  ]
})
export class AppModule { }
```

### 基本 HTTP 请求

```typescript
import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class ApiService {
  private baseUrl = 'https://api.example.com';

  constructor(private http: HttpClient) { }

  // GET 请求
  get<T>(endpoint: string): Observable<T> {
    return this.http.get<T>(`${this.baseUrl}/${endpoint}`);
  }

  // POST 请求
  post<T>(endpoint: string, data: any): Observable<T> {
    return this.http.post<T>(`${this.baseUrl}/${endpoint}`, data);
  }

  // PUT 请求
  put<T>(endpoint: string, data: any): Observable<T> {
    return this.http.put<T>(`${this.baseUrl}/${endpoint}`, data);
  }

  // DELETE 请求
  delete<T>(endpoint: string): Observable<T> {
    return this.http.delete<T>(`${this.baseUrl}/${endpoint}`);
  }
}
```

### 请求拦截器

```typescript
import { Injectable } from '@angular/core';
import { HttpInterceptor, HttpRequest, HttpHandler, HttpEvent } from '@angular/common/http';
import { Observable } from 'rxjs';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const token = localStorage.getItem('token');
    
    if (token) {
      const cloned = req.clone({
        headers: req.headers.set('Authorization', `Bearer ${token}`)
      });
      return next.handle(cloned);
    }
    
    return next.handle(req);
  }
}
```

注册拦截器：

```typescript
@NgModule({
  providers: [
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true }
  ]
})
export class AppModule { }
```

---

## 状态管理

### 使用 Signal（Angular 16+）

```typescript
import { Component, signal, computed, effect } from '@angular/core';

@Component({
  selector: 'app-counter',
  template: `
    <p>计数: {{ count() }}</p>
    <p>倍数: {{ doubleCount() }}</p>
    <button (click)="increment()">增加</button>
  `
})
export class CounterComponent {
  // 创建 signal
  count = signal(0);

  // 创建计算值
  doubleCount = computed(() => this.count() * 2);

  constructor() {
    // 创建副作用
    effect(() => {
      console.log('计数变化:', this.count());
    });
  }

  increment(): void {
    this.count.update(c => c + 1);
  }
}
```

### 使用 BehaviorSubject

```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private currentUserSubject = new BehaviorSubject<User | null>(null);
  currentUser$ = this.currentUserSubject.asObservable();

  login(user: User): void {
    this.currentUserSubject.next(user);
  }

  logout(): void {
    this.currentUserSubject.next(null);
  }

  get currentUser(): User | null {
    return this.currentUserSubject.value;
  }
}
```

---

## Angular CLI 命令

### 项目命令

| 命令 | 说明 |
|------|------|
| `ng new <name>` | 创建新 Angular 项目 |
| `ng serve` | 启动开发服务器 |
| `ng build` | 构建生产版本 |
| `ng test` | 运行单元测试 |
| `ng e2e` | 运行端到端测试 |
| `ng add <package>` | 添加 Angular 包 |
| `ng update <package>` | 更新 Angular 包 |

### 生成命令

| 命令 | 说明 |
|------|------|
| `ng generate component <name>` | 生成组件 |
| `ng g c <name>` | 生成组件（简写）|
| `ng generate service <name>` | 生成服务 |
| `ng g s <name>` | 生成服务（简写）|
| `ng generate module <name>` | 生成模块 |
| `ng g m <name>` | 生成模块（简写）|
| `ng generate directive <name>` | 生成指令 |
| `ng g d <name>` | 生成指令（简写）|
| `ng generate pipe <name>` | 生成管道 |
| `ng g p <name>` | 生成管道（简写）|
| `ng generate class <name>` | 生成类 |
| `ng g cl <name>` | 生成类（简写）|
| `ng generate interface <name>` | 生成接口 |
| `ng g i <name>` | 生成接口（简写）|

### 其他命令

| 命令 | 说明 |
|------|------|
| `ng version` | 查看 Angular 版本 |
| `ng lint` | 运行代码检查 |
| `ng eject` | 弹出 webpack 配置 |
| `ng doc <term>` | 打开 Angular 文档 |
| `ng analytics disable` | 禁用 Angular CLI 遥测 |

---

## 最佳实践

### 项目结构

```
src/
├── app/
│   ├── core/           # 核心模块（单例服务、拦截器）
│   │   ├── services/
│   │   ├── interceptors/
│   │   └── core.module.ts
│   ├── shared/         # 共享模块（公共组件、指令、管道）
│   │   ├── components/
│   │   ├── directives/
│   │   ├── pipes/
│   │   └── shared.module.ts
│   ├── features/       # 功能模块
│   │   ├── home/
│   │   ├── about/
│   │   └── user/
│   ├── app.component.ts
│   ├── app.module.ts
│   └── app-routing.module.ts
├── assets/             # 静态资源
├── environments/        # 环境配置
└── styles.*            # 全局样式
```

### 性能优化

1. **使用 OnPush 变更检测策略**
   ```typescript
   @Component({
     changeDetection: ChangeDetectionStrategy.OnPush
   })
   ```

2. **使用 trackBy 优化循环**
   ```html
   <div *ngFor="let item of items; trackBy: trackById">
     {{ item.name }}
   </div>
   ```

3. **延迟加载模块**
   ```typescript
   const routes: Routes = [
     { 
       path: 'admin', 
       loadChildren: () => import('./admin/admin.module')
         .then(m => m.AdminModule) 
     }
   ];
   ```

4. **使用 standalone 组件减少模块开销**

### 安全建议

1. **防范 XSS 攻击**
   - 使用 Angular 的内置防护
   - 避免使用 innerHTML，除非必要

2. **防范 CSRF/XSRF**
   - 使用 HttpClient 的 CSRF 防护

3. **敏感数据处理**
   - 不要在客户端存储敏感信息

---

## 相关链接

- [Angular 官方文档](https://angular.io/docs)
- [Angular CLI 文档](https://angular.io/cli)
- [Angular 中文网](https://angular.cn/)
- [Angular GitHub](https://github.com/angular/angular)
