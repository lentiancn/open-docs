# Docker 使用指南

高效使用 Docker 的完整指南。

---

## 目录

- [基本概念](#基本概念)
- [镜像操作](#镜像操作)
- [容器操作](#容器操作)
- [网络管理](#网络管理)
- [存储管理](#存储管理)
- [Docker Compose](#docker-compose)
- [Dockerfile 最佳实践](#dockerfile-最佳实践)
- [常用示例](#常用示例)
- [故障排除](#故障排除)

---

## 基本概念

### 什么是 Docker？

- **镜像**：用于创建容器的只读模板
- **容器**：镜像的运行实例
- **仓库**：存储镜像的地方（Docker Hub、GCR 等）

### 关键术语

| 术语 | 说明 |
|------|------|
| `image` | 只读模板 |
| `container` | 镜像的运行实例 |
| `volume` | 持久化存储 |
| `network` | 容器通信 |
| `dockerfile` | 镜像构建脚本 |

---

## 镜像操作

### 拉取镜像

```bash
# 拉取最新镜像
docker pull nginx

# 拉取指定标签
docker pull nginx:alpine
docker pull ubuntu:22.04
```

### 列出镜像

```bash
# 列出所有镜像
docker images

# 列出镜像 ID
docker images -q
```

### 删除镜像

```bash
# 删除单个镜像
docker rmi nginx

# 清理未使用的镜像
docker image prune
```

### 构建镜像

```bash
# 从 Dockerfile 构建
docker build -t myapp:1.0 .

# 不使用缓存构建
docker build --no-cache -t myapp:1.0 .
```

---

## 容器操作

### 运行容器

```bash
# 后台运行
docker run -d nginx

# 端口映射
docker run -d -p 8080:80 nginx

# 挂载卷
docker run -d -v /my/data:/data nginx

# 环境变量
docker run -d -e APP_ENV=production nginx

# 交互式运行
docker run -it ubuntu bash

# 运行后删除
docker run --rm ubuntu ls
```

### 常用运行选项

| 选项 | 说明 |
|------|------|
| `-d` | 后台运行 |
| `-p` | 端口映射（主机:容器） |
| `-v` | 卷挂载 |
| `-e` | 环境变量 |
| `--name` | 容器名称 |
| `--network` | 加入网络 |
| `-it` | 交互式 TTY |
| `--rm` | 退出时自动删除 |

### 管理容器

```bash
# 列出运行中的容器
docker ps

# 列出所有容器
docker ps -a

# 停止容器
docker stop <容器ID>

# 启动容器
docker start <容器ID>

# 重启容器
docker restart <容器ID>

# 删除容器
docker rm <容器ID>

# 强制删除运行中的容器
docker rm -f <容器ID>

# 查看日志
docker logs <容器ID>

# 实时查看日志
docker logs -f <容器ID>

# 在容器中执行命令
docker exec -it <容器ID> bash
```

---

## 网络管理

### 创建网络

```bash
# 创建桥接网络
docker network create my-network
```

### 连接容器

```bash
# 在网络中运行容器
docker run -d --network my-network nginx

# 连接现有容器到网络
docker network connect my-network container_name
```

---

## 存储管理

### 卷

```bash
# 创建卷
docker volume create my-volume

# 列出卷
docker volume ls

# 删除未使用的卷
docker volume prune
```

### 挂载主机目录

```bash
# 挂载主机目录
docker run -v /host/path:/container/path nginx

# 只读挂载
docker run -v /host/path:/container/path:ro nginx
```

---

## Docker Compose

### 基本 docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
    depends_on:
      - api

  api:
    build: ./api
    environment:
      - DATABASE_URL=postgres://db:5432/app

  db:
    image: postgres:15-alpine
    volumes:
      - db-data:/var/lib/postgresql/data

volumes:
  db-data:
```

### 常用命令

```bash
# 启动所有服务
docker compose up -d

# 停止所有服务
docker compose down

# 查看日志
docker compose logs -f

# 重新构建服务
docker compose up -d --build

# 在服务中执行命令
docker compose exec web bash
```

---

## Dockerfile 最佳实践

### 好的 Dockerfile 示例

```dockerfile
# 使用特定版本标签
FROM node:20-alpine

# 设置工作目录
WORKDIR /app

# 先复制包文件（利用缓存）
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 暴露端口
EXPOSE 3000

# 定义启动命令
CMD ["node", "server.js"]
```

### 关键最佳实践

1. **使用特定标签**：不要使用 `latest`
2. **使用 Alpine 镜像**：体积小，漏洞少
3. **合理排序层**：将不常变化的放在前面
4. **使用 .dockerignore**：排除不必要的文件
5. **以非 root 用户运行**：添加 `USER` 指令

---

## 常用示例

### 运行 Nginx

```bash
docker run -d -p 80:80 -v $(pwd)/html:/usr/share/nginx/html nginx
```

### 运行 MySQL

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  -e MYSQL_DATABASE=app \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8
```

### 运行 PostgreSQL

```bash
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=app \
  -v postgres-data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:15
```

### 运行 Redis

```bash
docker run -d \
  --name redis \
  -v redis-data:/data \
  -p 6379:6379 \
  redis:alpine redis-server --appendonly yes
```

---

## 故障排除

### 容器无法启动

```bash
# 检查日志
docker logs <容器ID>

# 检查容器状态
docker inspect <容器ID>
```

### 磁盘空间不足

```bash
# 显示磁盘使用情况
docker system df

# 清理
docker system prune -a
```

### 权限问题

```bash
# 修复所有权
sudo chown -R $(id -u):$(id -g) ./data

# 或指定用户运行
docker run -u $(id -u):$(id -g) -v $(pwd):/app app
```

---

## 下一步

- 探索 [Docker Hub](https://hub.docker.com/) 获取镜像
- 学习 [Kubernetes](https://kubernetes.io/) 进行编排
- 阅读 [Docker 安全](https://docs.docker.com/engine/security/) 最佳实践
