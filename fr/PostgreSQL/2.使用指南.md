# Guide utilisateur PostgreSQL

Ce guide explique comment utiliser le système de gestion de base de données PostgreSQL.

## Démarrage rapide

### Connexion à la base de données

```bash
# Utiliser psql
psql -U postgres -h localhost

# Créer une base de données
CREATE DATABASE myapp;

# Se connecter à la base de données
\c myapp

# Quitter
\q
```

### Créer une table

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Insérer des données

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- Insertion en masse
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### Interroger les données

```sql
-- Tout sélectionner
SELECT * FROM users;

-- Requête conditionnelle
SELECT * FROM users WHERE id = 1;

-- Requête paginée
SELECT * FROM users LIMIT 10 OFFSET 0;

-- Tri
SELECT * FROM users ORDER BY created_at DESC;
```

### Mettre à jour les données

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### Supprimer des données

```sql
DELETE FROM users WHERE id = 1;
```

## Types de données courants

### Types numériques

| Type | Description |
|------|-------------|
| SMALLINT | Entier 2 octets (-32768 à 32767) |
| INTEGER | Entier 4 octets |
| BIGINT | Entier 8 octets |
| DECIMAL | Valeur exacte |
| REAL | Virgule flottante 4 octets |
| DOUBLE PRECISION | Virgule flottante 8 octets |

### Types chaîne

| Type | Description |
|------|-------------|
| CHAR(n) | Longueur fixe |
| VARCHAR(n) | Longueur variable |
| TEXT | Longueur variable (sans limite) |

### Types date et heure

| Type | Description |
|------|-------------|
| DATE | Date |
| TIME | Heure |
| TIMESTAMP | Date et heure |
| TIMESTAMPTZ | Date et heure avec fuseau horaire |

### Types JSON

```sql
-- Type JSON
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- Interroger les données JSON
SELECT data->>'name' FROM events;
```

## Contraintes

### Clé primaire

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### Clé étrangère

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### Contrainte unique

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### Contrainte NOT NULL

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### Contrainte CHECK

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## Index

### Créer des index

```sql
-- Index sur une colonne
CREATE INDEX idx_users_email ON users(email);

-- Index sur plusieurs colonnes
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- Index unique
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### Supprimer des index

```sql
DROP INDEX idx_users_email;
```

## Vues

### Créer une vue

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### Utiliser une vue

```sql
SELECT * FROM active_users;
```

## Procédures stockées et fonctions

### Créer une fonction

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### Appeler une fonction

```sql
SELECT get_user_count();
```

## Transactions

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- ou ROLLBACK;
```

## Sauvegarde et restauration

### Sauvegarder

```bash
# Sauvegarder une base de données
pg_dump -U postgres mydb > backup.sql

# Sauvegarder toutes les bases de données
pg_dumpall -U postgres > all_backup.sql

# Sauvegarde compressée
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### Restaurer

```bash
# Restaurer une base de données
psql -U postgres mydb < backup.sql

# Restaurer toutes les bases de données
psql -U postgres -f all_backup.sql

# Restaurer depuis l'archive
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## Gestion des utilisateurs

### Créer un utilisateur

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### Accorder des privilèges

```sql
-- Accorder les privilèges sur la base de données
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- Accorder les privilèges sur les tables
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- Accorder les privilèges sur les séquences
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### Supprimer un utilisateur

```sql
DROP USER myuser;
```

## Optimisation des performances

### Analyse avec EXPLAIN

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### Mettre à jour les statistiques avec ANALYZE

```sql
ANALYZE users;
```

### Nettoyage avec VACUUM

```sql
-- Nettoyer les lignes mortes
VACUUM users;

-- Reconstruire la table
VACUUM FULL users;
```

## Ressources utiles

- [Documentation officielle PostgreSQL](https://www.postgresql.org/docs/)
- [Documentation PostgreSQL](https://www.postgresql.org/docs/)
- [Outil pgAdmin](https://www.pgadmin.org/)
