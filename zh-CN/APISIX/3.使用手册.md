# APISIX 使用手册

APISIX 核心功能和使用技巧。

## 基本概念

### 核心术语

- **Route（路由）**：定义请求匹配规则
- **Upstream（上游）**：实际的后端服务
- **Service（服务）**：一组路由的集合
- **Plugin（插件）**：请求处理逻辑
- **Consumer（消费者）**：API 使用者

### 请求处理流程

1. 客户端发送请求到 APISIX
2. APISIX 根据路由规则匹配
3. 执行插件逻辑
4. 转发到上游服务
5. 返回响应给客户端

## 路由管理

### 创建路由

通过 Admin API 创建：

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "1",
    "uri": "/api/users/*",
    "name": "user-api",
    "methods": ["GET", "POST"],
    "hosts": ["api.example.com"],
    "remote_addr": "192.168.1.0/24",
    "upstream": {
      "type": "roundrobin",
      "nodes": {
        "backend1.example.com:8080": 1,
        "backend2.example.com:8080": 2
      },
      "timeout": {
        "connect": 5,
        "send": 5,
        "read": 5
      }
    },
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "key_by": "remote_addr"
      }
    }
  }'
```

### 路由参数说明

| 参数 | 说明 | 必填 |
|------|------|------|
| id | 路由唯一标识 | 是 |
| uri | 匹配 URI | 是 |
| name | 路由名称 | 否 |
| methods | 匹配的 HTTP 方法 | 否 |
| hosts | 匹配的域名 | 否 |
| remote_addr | 匹配的客户端 IP | 否 |
| upstream | 上游服务配置 | 是 |
| plugins | 插件配置 | 否 |
| priority | 优先级，数字越大越高 | 否 |
| labels | 标签 | 否 |

### 路由匹配规则

**精确匹配：**

```json
{
  "uri": "/api/users"
}
```

**前缀匹配：**

```json
{
  "uri": "/api/*"
}
```

**正则匹配：**

```json
{
  "uri": "/api/users/[0-9]+"
}
```

**多 URI 匹配：**

```json
{
  "uri": ["/api/users", "/api/products", "/api/orders"]
}
```

## 上游管理

### 创建上游

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/upstreams/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "id": "1",
    "type": "roundrobin",
    "nodes": {
      "host1.example.com:8080": 1,
      "host2.example.com:8080": 1,
      "host3.example.com:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "http_statuses": [200, 201]
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    },
    "retry_timeout": 10,
    "keepalive_pool": {
      "size": 10
    }
  }'
```

### 负载均衡策略

**轮询（默认）：**

```json
{
  "type": "roundrobin"
}
```

**加权轮询：**

```json
{
  "type": "roundrobin",
  "nodes": {
    "host1:8080": 10,
    "host2:8080": 5
  }
}
```

**一致性哈希：**

```json
{
  "type": "chash",
  "key": "remote_addr",
  "nodes": {
    "host1:8080": 1,
    "host2:8080": 1
  }
}
```

## 插件使用

### 常用插件列表

APISIX 内置 70+ 插件，以下是常用分类：

**流量控制：**
- limit-req：请求限流
- limit-conn：连接数限制
- limit-count：计数限流

**认证授权：**
- jwt-auth：JWT 认证
- key-auth：Key 认证
- basic-auth：Basic 认证
- oauth2：OAuth 2.0

**请求处理：**
- proxy-rewrite：请求改写
- redirect：重定向
- rewrite：URI 重写

**响应处理：**
- response-rewrite：响应改写
- proxy-mirror：请求镜像
- gzip：响应压缩

**日志监控：**
- logging：日志记录
- prometheus：指标监控
- skywalking：链路追踪

### 使用限流插件

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "rejected_code": 503,
        "key_by": "remote_addr"
      },
      "limit-count": {
        "count": 1000,
        "time_window": 60,
        "rejected_code": 503,
        "key": "remote_addr"
      }
    }
  }'
```

### 使用 JWT 认证

**1. 创建 Consumer：**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/consumers \
  -H "X-API-KEY: 123456" \
  -d '{
    "username": "john",
    "plugins": {
      "jwt-auth": {
        "key": "user-key",
        "secret": "my-secret-key"
      }
    }
  }'
```

**2. 路由启用认证：**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "jwt-auth": {}
    }
  }'
```

**3. 获取 Token：**

```bash
curl -X GET http://127.0.0.1:9180/apisix/plugin/jwt/sign?key=user-key
```

## 服务发现

### Eureka

```json
{
  "service_discovery": {
    "type": "eureka",
    "eureka": {
      "host": ["http://127.0.0.1:8761"],
      "prefix": "/eureka/",
      "fetch_interval": 30,
      "weight": 100
    }
  }
}
```

### Nacos

```json
{
  "service_discovery": {
    "type": "nacos",
    "nacos": {
      "host": ["http://127.0.0.1:8848"],
      "namespace": "public",
      "group_name": "DEFAULT_GROUP"
    }
  }
}
```

### Consul

```json
{
  "service_discovery": {
    "type": "consul",
    "consul": {
      "host": ["http://127.0.0.1:8500"],
      "fetch_interval": 5
    }
  }
}
```

## 健康检查

### 主动健康检查

```json
{
  "upstream": {
    "nodes": {
      "host1:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 5,
          "http_statuses": [200, 201, 202]
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}
```

## 最佳实践

### 生产环境配置建议

1. **启用 Admin API 访问控制**
```yaml
apisix:
  admin_api_mtls:
    enabled: true
```

2. **使用强密钥**
```yaml
apisix:
  admin_key:
    - name: admin
      key: 使用随机生成的强密钥
```

3. **配置健康检查**
确保上游故障时自动摘除

4. **合理设置限流值**
根据实际业务量设置，避免误伤正常流量

5. **启用缓存**
```yaml
apisix:
  enable_cache: true
```

### 调试技巧

**查看路由匹配：**
```bash
curl http://127.0.0.1:9180/apisix/admin/routes \
  -H "X-API-KEY: 123456"
```

**查看插件列表：**
```bash
curl http://127.0.0.1:9180/apisix/admin/plugins \
  -H "X-API-KEY: 123456"
```

**查看错误日志：**
```bash
tail -f logs/error.log
```
