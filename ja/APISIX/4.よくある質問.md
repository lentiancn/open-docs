# Apache APISIX よくある質問

## 基本的な質問

### 1. Apache APISIXとは何ですか？

Apache APISIXは、Apache Software Foundationが管理するクラウドネイティブAPIゲートウェイです。負荷分散、動的ルート、認証、レート制限、モニタリングなどの動的・リアルタイム・高性能なAPIトラフィック管理機能を提供します。

### 2. APISIXとNginxの違いは何ですか？

Nginxは従来のWebサーバー兼リバースプロキシですが、APISIXはNginxの上に構築されたAPIゲートウェイです。

主な違い：
- **設定方法**: Nginxは設定ファイルの変更と再起動が必要、APISIXは再起動なしのホットアップデートをサポート
- **機能拡張**: APISIXは豊富な組み込みプラグインを提供、Nginxはカスタムモジュールを作成する必要がある
- **動的機能**: APISIXは動的ルート、動的アップストリームなどをネイティブサポート
- **可観測性**: APISIXはPrometheus、SkyWalkingなどのモニタリング統合を組み込み

### 3. APISIXには哪些の依存が必要ですか？

APISIXの主な依存：
- **etcd**: 設定存储とクラスター同期用
- **Lua**: APISIXはLuaでプラグインロジックを記述
- **Nginx**: HTTPリクエスト処理のベースとしてNginxを使用

Dockerを使用する場合、これらの依存は自動的に設定されます。

### 4. APISIXのパフォーマンスはどうですか？

APISIXは非常に高いパフォーマンスを持ち、1コアあたり18,000 QPS、平均レイテンシ0.2ミリ秒未満を達成しています。これは以下のためです：
- Nginxの高性能HTTP処理
- LuaJITのジャストインタイムコンパイル
- 効率的なアーキテクチャ設計

### 5. APISIXは哪些プラットフォームをサポートしていますか？

APISIXは複数のプラットフォームをサポート：
- Linux（Ubuntu、CentOS、Debianなど）
- macOS
- Windows（WSLまたはDocker経由）
- Kubernetes（HelmまたはOperator経由）

## インストールに関する質問

### 6. クイックスタートスクリプトのインストールに失敗した場合はどうしますか？

よくある原因と解決策：

1. **Dockerが起動していない**
   ```bash
   # Dockerを起動
   sudo systemctl start docker
   ```

2. **ポートが使用中**
   ```bash
   # ポートの使用状況を確認
   lsof -i :9080
   
   # ポートを使用しているプロセスを停止するか、APISIX設定で別のポートを使用
   ```

3. **ネットワーク問題**
   ```bash
   # Dockerネットワークを確認
   docker network ls
   
   # イメージをを手動でプル 시도
   docker pull apache/apisix:3.3.0
   docker pull apache/apisix/etcdserve:v3.5.0
   ```

### 7. APISIXのポートを変更する方法は？

Docker Compose設定を変更：

```yaml
services:
  apisix:
    ports:
      - "9081:9080"  # ホスト:コンテナ
      - "9444:9443"
      - "9181:9180"
```

または`config.yaml`を設定：

```yaml
deployment:
  listen:
    ip: "0.0.0.0"
    port: 9081
```

### 8. etcdの起動に失敗した場合はどう解決しますか？

よくある原因：

1. **データディレクトリの権限問題**
   ```bash
   sudo chown -R etcd:etcd /var/lib/etcd
   ```

2. **ポート競合**
   ```bash
   lsof -i :2379
   ```

3. **ディスク容量不足**
   ```bash
   df -h
   # 不要なファイルをクリーンアップ
   ```

### 9. APISIXをアップグレードする方法は？

Dockerの場合：
```bash
# 新バージョンのイメージをプル
docker pull apache/apisix:3.4.0

# 古いコンテナを停止
docker stop apisix

# 新しいイメージで起動
docker run -d apache/apisix:3.4.0 ...
```

注意：アップグレード前に設定データをバックアップしてください。

## 設定に関する質問

### 10. Admin APIキーを変更する方法は？

`config.yaml`を設定ファイル：

```yaml
deployment:
  admin:
    admin_key:
      - name: "admin"
        key: "your-new-secret-key"
        role: "admin"
```

変更後、APISIXを再起動する必要があります。

### 11. HTTPSを有効にする方法は？

APISIXはHTTPSを有効にする2つの方法を提供：

1. **手動SSL証明書**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/ssl" -X PUT -d '
   {
     "id": "ssl-1",
     "cert": "-----BEGIN CERTIFICATE-----\n...",
     "key": "-----BEGIN PRIVATE KEY-----\n...",
     "snis": ["example.com"]
   }'
   ```

2. **Let's Encryptで自動発行**
   ```bash
   # acmeプラグインを有効化
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "acme": {
         "account_email": "your@email.com"
       }
     }
   }'
   ```

### 12. 複数のドメインを設定する方法は？

ルートを作成する際に`hosts`フィールドを使用：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "multi-domain",
  "hosts": ["example.com", "api.example.com"],
  "uri": "/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 13. リクエストリダイレクトを実装する方法は？

`redirect`プラグインを使用：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "redirect-route",
  "uri": "/old-path",
  "plugins": {
    "redirect": {
      "uri": "/new-path",
      "http_status": 301
    }
  }
}'
```

## 機能に関する質問

### 14. カナリアリリースを実装する方法は？

2つの方法があります：

1. **重みベースのカナリア**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "traffic-split": {
         "rules": [
           {
             "weighted_upstream": [
               {"upstream": {"name": "v1", "nodes": {"v1:8080": 100}}, "weight": 90},
               {"upstream": {"name": "v2", "nodes": {"v2:8080": 100}}, "weight": 10}
             ]
           }
         ]
       }
     }
   }'
   ```

2. **リクエストリア**
   `vars`を使用して条件マッチングを行い属性ベースのカナ、ヘッダー、Cookie、パラメータに基づいて異なるアップストリームに分配します。

### 15. サーキットブレーカーを実装する方法は？

APISIXにはヘルスチェック経由で実装される組み込みのサーキットブレーカー機能があります：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"backend:8080": 1},
    "checks": {
      "passive": {
        "healthy": {"successes": 3},
        "unhealthy": {"http_failures": 3}
      }
    }
  }
}'
```

### 16. CORSを有効にする方法は？

`cors`プラグインを使用：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "cors": {
      "allow_origins": "*",
      "allow_methods": "GET,POST,PUT,DELETE",
      "allow_headers": "*"
    }
  }
}'
```

### 17. レート制限を実装する方法は？

```bash
# リクエスト数ベース
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 429
    }
  }
}'
```

### 18. コンシューマーを使用して認証する方法は？

1. コンシューマーを作成：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
   {
     "username": "user1",
     "plugins": {
       "key-auth": {"key": "key-1"}
     }
   }'
   ```

2. ルートで認証を有効化：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {"key-auth": {}}
   }'
   ```

3. クライアントがリクエスト時にキーを含める：
   ```bash
   curl "http://127.0.0.1:9080/api" -H "apikey: key-1"
   ```

## モニタリングに関する質問

### 19. Prometheusを統合する方法は？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  }
}'
```

メトリクスにアクセス：
```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 20. ログ転送を設定する方法は？

複数のログ出力をサポート：

```bash
# HTTPログ
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  }
}'

# Kafkaログ
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "kafka-logger": {
      "brokers": [{"host": "kafka", "port": 9092}],
      "topic": "apisix-logs"
    }
  }
}'
```

### 21. SkyWalkingトレーシングを使用する方法は？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "skywalking": {
      "endpoint_addr": "http://skywalking:11800",
      "service_name": "apisix",
      "sample_ratio": 1
    }
  }
}'
```

## クラスターに関する質問

### 22. APISIXクラスターを構築する方法は？

APISIXノードはステートレスです。必要なことは：

1. 複数のAPISIXノードをデプロイ
2. すべてのノードを同じetcdクラスターに接続するよう設定
3. ロードバランサー（Nginx、HAProxyなど）を使用してトラフィックを分散

```yaml
# config.yaml
deployment:
  etcd:
    host:
      - "http://etcd1:2379"
      - "http://etcd2:2379"
      - "http://etcd3:2379"
```

### 23. etcdの高可用性を確保する方法は？

etcdはクラスターモードのデプロイをサポート：

```bash
# etcdクラスターを起動
etcd --name infra1 --initial-advertise-peer-urls http://localhost:2380 \
  --listen-peer-urls http://localhost:2380 \
  --initial-cluster infra1=http://localhost:2380,...
```

本番環境では少なくとも3つのetcdノードをデプロイすることを推奨します。

### 24. APISIX設定を移行する方法は？

1. 設定をエクスポート：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx" > routes.json
   ```

2. 新しいクラスターにインポート：
   ```bash
   # 1つずつインポートまたはバッチインポートツールを使用
   ```

## セキュリティに関する質問

### 25. 本番環境のセキュリティ推奨事項は？

1. **デフォルトAPIキーを変更**
   ```yaml
   deployment:
     admin:
       admin_key:
         - key: "your-secure-key"
   ```

2. **Admin APIアクセスを制限**
   ```yaml
   deployment:
     admin:
       allow_access: ["127.0.0.1", "10.0.0.0/8"]
   ```

3. **HTTPSを有効化**

4. **ファイアウォールルールを設定**

5. **定期的にバージョンを更新**

### 26. APIへの悪意のあるアクセスを防ぐ方法は？

1. **IPブラックリストを有効化**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "ip-restriction": {
         "deny": ["1.2.3.4"]
       }
     }
   }'
   ```

2. **リクエスト検証を有効化**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "request-validation": {
         "body_schema": {
           "type": "object",
           "required": ["name"],
           "properties": {"name": {"type": "string"}}
         }
       }
     }
   }'
   ```

3. **CSRF保護を有効化**

## デバッグに関する質問

### 27. APISIXログを表示する方法は？

Dockerの場合：
```bash
docker logs apisix
```

エラーログを表示：
```bash
tail -f logs/error.log
```

### 28. ルートマッチングをデバッグする方法は？

`debug`プラグインを使用：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/plugin_metadata/debug" -X PUT -d '
{
  "headers": ["X-Request-ID"]
}'
```

### 29. リクエストが404を返した場合はどうしますか？

1. ルートが正しく作成されているか確認：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx"
   ```

2. URIがマッチするか確認：
   - リクエストパスがルート設定と一致していることを確認
   - プレフィックスマッチと完全マッチの違いに注意

3. アップストリームに到達可能か確認：
   ```bash
   curl -v http://backend:8080/health
   ```

### 30. リクエストが503を返した場合はどうしますか？

通常、アップストリームが利用不可です：

1. アップストリームノードが実行中か確認
2. ネットワーク接続性を確認
3. ヘルスチェック設定が厳しすぎないか確認

## その他のヘルプ

このFAQでカバーされていない問題が発生した場合は、以下のリソースを参照：

- 公式ドキュメント：https://apisix.apache.org/docs/
- GitHub：https://github.com/apache/apisix
- コミュニティフォーラム：https://github.com/apache/apisix/discussions
- Slack：https://apisix.apache.org/slack
