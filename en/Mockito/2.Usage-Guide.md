# Mockito Usage Guide

Comprehensive guide for using Mockito in unit testing.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Creating Mocks](#creating-mocks)
- [Verifying Behavior](#verifying-behavior)
- [Stubbing](#stubbing)
- [Argument Matchers](#argument-matchers)
- [Spy](#spy)
- [Annotations](#annotations)
- [Answers](#answers)
- [Timeouts](#timeouts)
- [InOrder Verification](#inorder-verification)
- [Spy vs Mock](#spy-vs-mock)
- [BDD Style](#bdd-style)
- [Common Recipes](#common-recipes)

---

## Basic Concepts

### What is Mockito?

Mockito is a mocking framework for unit testing in Java. It allows you to create mock objects to replace real dependencies.

### Key Terms

| Term | Description |
|------|-------------|
| Mock | Fake object that simulates real behavior |
| Stub | Predefined responses for method calls |
| Spy | Partial mock that wraps real objects |
| Verification | Checking that methods were called |
| Argument Matcher | Wildcard matching for method arguments |

---

## Creating Mocks

### Using Mockito.mock()

```java
import org.mockito.Mockito;

List<String> mockList = Mockito.mock(List.class);
```

### Using @Mock Annotation

```java
@Mock
private List<String> mockList;

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
}
```

### Using @ExtendWith

```java
@ExtendWith(MockitoExtension.class)
class MyTest {
    @Mock
    private MyService myService;
}
```

---

## Stubbing

### Basic Stubbing

```java
// Stub a method to return a value
when(mockList.get(0)).thenReturn("first");

// Stub multiple return values
when(mockList.get(0)).thenReturn("first", "second", "third");

// Stub to throw exception
when(mockList.get(0)).thenThrow(new RuntimeException("Error"));

// Stub with doThrow
doThrow(new RuntimeException("Error")).when(mockList).clear();
```

### Stubbing Methods Returning Void

```java
// Do nothing
doNothing().when(mockList).clear();

// Throw exception
doThrow(new RuntimeException("Error")).when(mockList).clear();

// Do answer
doAnswer(invocation -> {
    System.out.println("Method called");
    return null;
}).when(mockList).clear();
```

### Stubbing with Argument Matchers

```java
// Match any argument
when(mockList.get(anyInt())).thenReturn("element");

// Match specific argument
when(mockList.get(0)).thenReturn("first");

// Match null
when(mockList.get(null)).thenReturn("null");

// Match any string
when(mockList.contains(anyString())).thenReturn(true);
```

---

## Verifying Behavior

### Basic Verification

```java
// Verify method was called
verify(mockList).add("element");

// Verify method was called exactly n times
verify(mockList, times(2)).add("element");

// Verify method was never called
verify(mockList, never()).clear();

// Verify method was called at least n times
verify(mockList, atLeast(1)).add("element");

// Verify method was called at most n times
verify(mockList, atMost(3)).add("element");
```

### Verification with Arguments

```java
// Verify with specific argument
verify(mockList).add("element");

// Verify with argument matcher
verify(mockList).add(anyString());

// Verify with specific value
verify(mockList, times(1)).add(eq("element"));
```

### InOrder Verification

```java
InOrder inOrder = inOrder(mockList, mockMap);

inOrder.verify(mockList).add("first");
inOrder.verify(mockList).add("second");
inOrder.verify(mockMap).put("key", "value");
```

---

## Argument Matchers

### Common Matchers

```java
// Any value
any(), anyInt(), anyString(), anyObject()

// Specific types
anyList(), anyMap(), anySet()

// Null checks
isNull(), isNotNull()

// Collection matching
anyListOf(String.class), anyMapOf(String.class, Integer.class)

// Custom matchers
argThat(argument -> argument.length() > 3)
```

### Using Matchers

```java
// Combine matchers
verify(mockList).add(anyString());
verify(mockMap, atLeast(0)).put(anyString(), anyInt());

// Using eq() for specific values
verify(mockList).add(eq("specific"));
```

---

## Spy

### Creating a Spy

```java
// Using spy()
List<String> spyList = Mockito.spy(new ArrayList<>());

// Using @Spy annotation
@Spy
private List<String> spyList = new ArrayList<>();
```

### Stubbing a Spy

```java
// Stub specific method
doReturn("first").when(spyList).get(0);

// Real method will be called for non-stubbed methods
spyList.add("element"); // Real method
verify(spyList).add("element");
```

### Difference from Mock

| Feature | Mock | Spy |
|---------|------|-----|
| Default behavior | Returns null/default | Calls real methods |
| Stubbing | Full control | Only stubbed methods are mocked |
| Use case | Replace dependencies | Partial mocking |

---

## Annotations

### @Mock

```java
@Mock
private UserService userService;
```

### @Spy

```java
@Spy
private UserService userService = new UserService();
```

### @InjectMocks

```java
@InjectMocks
private UserController userController;
```

### @Captor

```java
@Captor
private ArgumentCaptor<User> userCaptor;
```

---

## Answers

### Custom Answers

```java
when(mockList.get(anyInt())).thenAnswer(invocation -> {
    int index = invocation.getArgument(0);
    return "Element at " + index;
});

// Or use doAnswer
doAnswer(invocation -> {
    Object[] args = invocation.getArguments();
    System.out.println("Called with: " + Arrays.toString(args));
    return null;
}).when(mockList).clear();
```

### Common Built-in Answers

```java
// Return null by default
thenReturn(null)

// Throw exception
thenThrow(new RuntimeException())

// Use real implementation (for spies)
thenCallRealMethod()
```

---

## Timeouts

### Verification with Timeout

```java
// Verify within timeout
verify(mockList, timeout(1000)).add("element");

// Verify with times and timeout
verify(mockList, timeout(1000).times(2)).add("element");
```

---

## BDD Style

### Given-When-Then

```java
import static org.mockito.BDDMockito.*;

// Given
given(mockList.get(0)).willReturn("first");

// When
String result = mockList.get(0);

// Then
assertEquals("first", result);

// Verify
then(mockList).should(times(1)).get(0);
```

---

## Common Recipes

### Testing Exceptions

```java
@Test
void testException() {
    when(mockList.get(0)).thenThrow(new IndexOutOfBoundsException("Error"));
    
    assertThrows(IndexOutOfBoundsException.class, () -> {
        mockList.get(0);
    });
}
```

### Testing Void Methods

```java
@Test
void testVoidMethod() {
    doNothing().when(mockList).clear();
    mockList.clear();
    verify(mockList).clear();
}
```

### Mocking Static Methods

```java
@Test
void testStaticMethod() {
    try (MockedStatic<UtilityClass> mocked = mockStatic(UtilityClass.class)) {
        mocked.when(UtilityClass::staticMethod).thenReturn("mocked");
        
        assertEquals("mocked", UtilityClass.staticMethod());
    }
}
```

### Mocking Private Methods

```java
@Test
void testPrivateMethod() throws Exception {
    try (MockedConstruction<MyClass> mocked = Mockito.mockConstruction(MyClass.class)) {
        MyClass instance = new MyClass();
        
        // Use reflection or test public interface
    }
}
```

### ArgumentCaptor

```java
@Captor
private ArgumentCaptor<User> userCaptor;

@Test
void testArgumentCapture() {
    userService.saveUser(new User("John", "john@example.com"));
    
    verify(userRepository).save(userCaptor.capture());
    
    User captured = userCaptor.getValue();
    assertEquals("John", captured.getName());
}
```

---

## Best Practices

1. **Don't mock value objects**: Use real objects for DTOs
2. **Keep tests focused**: Test one thing at a time
3. **Use meaningful assertions**: Don't just verify, assert actual values
4. **Avoid stubbing getters**: Use real objects when possible
5. **Use BDD style**: Makes tests more readable
6. **Don't overuse mocks**: Sometimes a real object is better

---

## Common Errors

| Error | Solution |
|-------|----------|
| Unnecessary stubbing | Remove or use lenient stubbing |
| Wrong number of arguments | Check method signature |
| Cannot mock final classes | Use mockito-inline |
| NullPointerException | Initialize mocks properly |

---

## Next Steps

- Explore [Mockito Extensions](https://mockito-extensions.readthedocs.io/)
- Learn about [JUnit 5 Integration](https://junit.org/junit5/docs/current/user-guide/)
