# Apache APISIX 使用手冊

本手冊將詳細介紹如何使用 APISIX 進行日常的 API 管理工作，包括路由配置、負載均衡、身份驗證、限流等核心功能。

## 基本概念

在深入使用之前，需要了解 APISIX 的幾個核心概念：

### Route（路由）

路由是 APISIX 最基本的概念，它定義了**請求路徑**與**上游服務**之間的對應關係。當你建立一個路由時，實際上是在告訴 APISIX：「如果有請求匹配這個路徑，就把它轉發到那個服務」。

一個簡單的路由包含：

- **URI**：請求路徑（如 `/api/users`）
- **Upstream**：上游服務位址
- **Plugins**（可選）：需要執行的插件

### Upstream（上游）

上游是一組提供相同服務的節點集合。APISIX 會對這些節點進行負載均衡，將請求分發到不同的節點上。

### Consumer（消費者）

消費者是 API 的使用者，可以是某個應用、使用者或服務。消費者需要透過身份驗證插件來證明自己的身份。

### Plugin（插件）

插件是 APISIX 擴展功能的方式。APISIX 提供了豐富的內建插件，涵蓋認證、限流、監控、安全等各個方面。

## 快速開始

### 建立第一個路由

假設你有一個後端服務運行在 `httpbin.org`，現在想透過 APISIX 來存取它：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "my-first-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  }
}'
```

建立成功後，存取 `http://127.0.0.1:9080/ip` 就會被轉發到 `http://httpbin.org/ip`。

### 驗證路由

```bash
curl "http://127.0.0.1:9080/ip"
```

預期返回類似：

```json
{
  "origin": "183.94.122.205"
}
```

## 負載均衡

APISIX 支援多種負載均衡策略，可以根據實際需求選擇合適的演算法。

### 加權輪詢

可以為不同節點設定不同的權重，權重越高的節點接收的請求越多：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "weighted-route",
  "uri": "/headers",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 3,
      "service-b:8080": 1
    }
  }
}'
```

這個配置表示：service-a 接收 75% 的請求，service-b 接收 25% 的請求。

### 一致性雜湊

對於需要會話保持的場景，可以使用一致性雜湊演算法：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "hash-route",
  "uri": "/user/*",
  "upstream": {
    "type": "chash",
    "key": "remote_addr",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    }
  }
}'
```

### 健康檢查

APISIX 支援對上游節點進行健康檢查，自動剔除故障節點：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "health-check-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "successes": 2
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    }
  }
}'
```

## 身份驗證

APISIX 提供了多種身份驗證插件來保護你的 API。

### API 金鑰驗證

這是最簡單也是最常用的身份驗證方式：

**第一步：建立消費者**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "tom",
  "plugins": {
    "key-auth": {
      "key": "secret-key-123"
    }
  }
}'
```

**第二步：在路由上啟用金鑰驗證**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "key-auth": {}
  }
}'
```

**第三步：攜帶金鑰存取**

```bash
# 不帶金鑰，會被拒絕
curl "http://127.0.0.1:9080/ip"
# 返回：401 Unauthorized

# 带正确密钥，可以访问
curl "http://127.0.0.1:9080/ip" -H "apikey: secret-key-123"
# 返回：200 OK
```

### JWT 認證

對於需要更複雜許可權控制的場景，可以使用 JWT：

```bash
# 建立消費者並啟用 JWT
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "alice",
  "plugins": {
    "jwt-auth": {
      "key": "user-key",
      "secret": "my-secret"
    }
  }
}'

# 獲取 JWT Token（需要後端服務生成）
# 之後在請求中攜帶：Authorization: Bearer <jwt-token>
```

## 限流

APISIX 提供了多種限流插件，可以從不同維度限制請求頻率。

### 基於請求數量的限流

限制單位時間內的請求數量：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

這個配置表示：每個 IP 在 60 秒內最多只能傳送 100 個請求，超過的請求會返回 503 錯誤。

### 基於請求速率的限流

限制請求的處理速度：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-req": {
      "rate": 100,
      "burst": 50,
      "rejected_code": 429
    }
  }
}'
```

### 基於並行連線的限流

限制同時建立的連線數：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-conn": {
      "conn": 100,
      "burst": 50,
      "rejected_code": 503
    }
  }
}'
```

## 請求改寫

APISIX 可以在請求轉發前對其進行修改。

### 修改請求路徑

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "rewrite-route",
  "uri": "/api/v1/*",
  "plugins": {
    "proxy-rewrite": {
      "uri": "/$uri"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 修改請求Header

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "header-route",
  "uri": "/proxy",
  "plugins": {
    "proxy-rewrite": {
      "headers": {
        "X-Custom-Header": "custom-value",
        "X-Request-ID": "$request_id"
      }
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## 灰度發布

透過設定兩個不同的上游服務，可以實現平滑的流量切換。

### 基於權重的灰度發布

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "canary-route",
  "uri": "/api/*",
  "plugins": {
    "traffic-split": {
      "rules": [
        {
          "weighted_upstream": [
            {
              "upstream": {
                "name": "v1",
                "nodes": {
                  "v1-service:8080": 100
                }
              },
              "weight": 90
            },
            {
              "upstream": {
                "name": "v2",
                "nodes": {
                  "v2-service:8080": 100
                }
              },
              "weight": 10
            }
          ]
        }
      ]
    }
  }
}'
```

這個配置表示：90% 的流量發送到 v1 版本，10% 的流量發送到 v2 版本。

## 熔斷器

當上游服務出現故障時，熔斷器可以自動停止向故障節點傳送請求，防止故障擴散。

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "circuit-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "passive": {
        "type": "http",
        "healthy": {
          "successes": 3
        },
        "unhealthy": {
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}'
```

## 監控與日誌

### Prometheus 監控

啟用 Prometheus 插件來收集指標：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "monitor-route",
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

取得指標資料：

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 請求日誌

將請求日誌傳送到外部日誌系統：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "log-route",
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## 常用管理指令

### 查看所有路由

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有上游

```bash
curl "http://127.0.0.1:9180/apisix/admin/upstreams" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有消費者

```bash
curl "http://127.0.0.1:9180/apisix/admin/consumers" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 查看所有插件

```bash
curl "http://127.0.0.1:9180/apisix/admin/plugins" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### 刪除路由

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X DELETE
```

### 更新路由

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PUT -d '
{
  "uri": "/new-path",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "new-backend:8080": 1
    }
  }
}'
```

## 最佳實踐

1. **生產環境務必修改 API 金鑰**：預設的 Admin API 金鑰是公開的，生產環境必須修改。

2. **使用 HTTPS**：生產環境應啟用 SSL/TLS 加密。

3. **啟用健康檢查**：設定上游健康檢查可以提高系統穩定性。

4. **合理設定限流值**：根據實際業務需求和後端服務能力設定合理的限流閾值。

5. **做好日誌備份**：將重要日誌傳送到獨立的日誌系統，便於問題排查。

6. **定期備份配置**：定期備份 etcd 中的配置資料。
