# LivePortrait Usage Guide

LivePortrait is an efficient portrait animation framework that animates still portraits using motion from driving videos. It supports stitching and retargeting control.

## Quick Start

### Basic Command

```bash
# Video-driven animation
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results
```

### With Stitching

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results \
  --stitching
```

### With Eye/Lip Retargeting

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Command Parameters

### Input Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--source_image` | Input portrait image path | Required |
| `--driving_video` | Driving video path | Optional |
| `--driven_audio` | Driving audio path | Optional |
| `--result_dir` | Output directory | ./results |

### Processing Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--stitching` | Enable stitching | False |
| `--eye_retargeting` | Eye retargeting (0-1) | 0 |
| `--lip_retargeting` | Lip retargeting (0-1) | 0 |
| `--face_parser` | Enable face parsing | True |

### Performance Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--batch_size` | Batch size | 1 |
| `--fps` | Output video frame rate | 30 |

## Usage Examples

### Example 1: Basic Video-Driven Animation

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/basic
```

### Example 2: With Stitching

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/stitching \
  --stitching
```

### Example 3: Eye Control

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/eyes \
  --eye_retargeting 0.8
```

### Example 4: Lip Sync Control

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/lips \
  --lip_retargeting 0.7
```

### Example 5: Full Control

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/full \
  --stitching \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Python API

### Basic Usage

```python
from liveportrait import LivePortrait

# Initialize
lp = LivePortrait()

# Animate portrait
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.5,
    lip_retargeting=0.5
)

print(f"Video saved to: {result}")
```

### Advanced Usage

```python
from liveportrait import LivePortrait
import torch

# Initialize with custom settings
lp = LivePortrait(
    checkpoint_path="pretrained_models/liveportrait.pth",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Generate with full control
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.8,
    lip_retargeting=0.8,
    output_fps=30,
    output_resolution=(512, 512)
)
```

### Batch Processing

```python
from liveportrait import LivePortrait
import os

lp = LivePortrait()

# Process multiple images
source_dir = "source_images/"
driving_video = "driving.mp4"

for image_file in os.listdir(source_dir):
    if image_file.endswith(('.jpg', '.png')):
        result = lp.animate(
            source_image=os.path.join(source_dir, image_file),
            driving_video=driving_video,
            stitching=True
        )
```

## Web Interface

### Run Web Demo

```bash
python app.py
```

Then open http://localhost:7860 in your browser

### Web Interface Features

1. **Source Image Upload** - Upload portrait image
2. **Driving Video Upload** - Select driving video
3. **Stitching Toggle** - Enable/disable stitching
4. **Eye Control** - Adjust eye movement intensity
5. **Lip Control** - Adjust lip sync intensity
6. **Generate** - Create animation
7. **Download** - Save result

## Features

### 1. Stitching

The stitching module connects the generated head with the body seamlessly:

```bash
--stitching
```

- Smooth transition between head and body
- Works with various image styles (realistic, oil painting, sculpture, 3D)

### 2. Eye Retargeting

Control eye openness with a scalar value (0-1):

```bash
--eye_retargeting 0.5
```

- 0: Closed eyes
- 1: Fully open eyes
- 0.5: Natural

### 3. Lip Retargeting

Control lip movement intensity:

```bash
--lip_retargeting 0.5
```

- 0: Minimal movement
- 1: Maximum movement
- 0.5: Natural

## Input Requirements

### Source Image

- Format: JPG, PNG
- Resolution: 512x512 or higher recommended
- Face: Front-facing, clear
- Background: Any

### Driving Video

- Format: MP4, AVI
- Duration: 1-60 seconds
- Resolution: Any
- Face: Clear facial expressions

## Output

### Video Format

- Format: MP4
- Codec: H.264
- Resolution: 512x512
- Frame rate: 30

### Output Directory

```
results/
├── output.mp4          # Generated video
└── (temporary files)
```

## Troubleshooting

### Poor Animation Quality

**Solutions:**
- Use higher quality source image
- Ensure driving video has clear face
- Adjust retargeting parameters

### Face Not Detected

**Solutions:**
- Use clearer portrait image
- Ensure face is visible
- Check image format

### Slow Processing

**Solutions:**
- Reduce output resolution
- Disable stitching if not needed
- Use GPU acceleration

### GPU Out of Memory

**Solutions:**
- Reduce batch size to 1
- Use smaller image size
- Close other GPU applications

## Performance Tips

### Faster Processing

1. Disable stitching if not needed
2. Use lower output resolution
3. Reduce fps

### Better Quality

1. Enable stitching
2. Use high quality source image
3. Adjust retargeting parameters

## Related Links

- [GitHub](https://github.com/KwaiVGI/LivePortrait)
- [Paper](https://arxiv.org/abs/2407.03168)
- [Demo](https://liveportrait.github.io)
