# Docker 常见问题

本章节汇总了 Docker 使用中常见的问题和解决方案。

## 安装问题

### Q1: Docker Desktop 启动失败（Windows）

**问题描述：**
Docker Desktop 无法启动，提示 "Docker Desktop is shutting down"

**解决方案：**

1. **启用 Hyper-V**
   ```powershell
   # 以管理员身份运行 PowerShell
   Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All
   Enable-WindowsOptionalFeature -Online -FeatureName Containers -All
   ```

2. **使用 WSL 2**
   ```powershell
   wsl --install
   ```

3. **检查 CPU 虚拟化**
   - 重启进入 BIOS
   - 启用 Intel VT-x 或 AMD-V

4. **查看错误日志**
   - C:\ProgramData\DockerDesktop\log
   - %LOCALAPPDATA%\Docker\log

### Q2: Docker 权限被拒绝

**问题描述：**
```
permission denied while trying to connect to the Docker daemon socket
```

**解决方案：**

```bash
# 将当前用户添加到 docker 组
sudo usermod -aG docker $USER

# 重新登录或重启
# 或使用临时方案（不推荐用于生产）
sudo chmod 666 /var/run/docker.sock
```

### Q3: 拉取镜像失败

**问题描述：**
```
Error pulling image: connection reset
```

**解决方案：**

1. **配置国内镜像加速**
   ```bash
   sudo mkdir -p /etc/docker
   sudo tee /etc/docker/daemon.json <<EOF
   {
     "registry-mirrors": [
       "https://docker.mirrors.ustc.edu.cn",
       "https://hub-mirror.c.163.com"
     ]
   }
   EOF
   sudo systemctl daemon-reload
   sudo systemctl restart docker
   ```

2. **检查网络**
   ```bash
   ping docker.io
   curl -I https://registry-1.docker.io
   ```

### Q4: 端口冲突

**问题描述：**
```
Error starting userland proxy: listen tcp4 0.0.0.0:8080: bind: address already in use
```

**解决方案：**

```bash
# 查看端口占用
netstat -tlnp | grep 8080
# 或
lsof -i :8080

# 更换端口
docker run -d -p 8081:80 nginx

# 停止占用端口的进程
kill <PID>
```

## 运行问题

### Q5: 容器无法访问网络

**问题描述：**
容器内无法访问外部网络

**解决方案：**

1. **检查 Docker 网络**
   ```bash
   docker network ls
   docker network inspect bridge
   ```

2. **创建自定义网络**
   ```bash
   docker network create mynet
   docker run --network mynet nginx
   ```

3. **检查防火墙**
   ```bash
   # 临时关闭防火墙测试
   sudo systemctl stop firewalld
   # 或
   sudo iptables -F
   ```

### Q6: 容器自动停止

**问题描述：**
容器启动后立即停止

**解决方案：**

1. **查看容器日志**
   ```bash
   docker logs <container_id>
   ```

2. **以前台模式运行**
   ```bash
   docker run -it nginx /bin/bash
   ```

3. **使用 tail -f 保持容器运行**
   ```dockerfile
   CMD ["tail", "-f", "/dev/null"]
   ```

### Q7: 容器间无法通信

**问题描述：**
不同容器之间无法通信

**解决方案：**

1. **使用同一网络**
   ```bash
   docker network create mynet
   docker run -d --network mynet --name container1 nginx
   docker run -d --network mynet --name container2 alpine
   docker exec container2 ping container1
   ```

2. **使用容器名作为主机名**
   - Docker DNS 会自动解析容器名

3. **使用 link（已废弃）**
   ```bash
   docker run -d --link container1 nginx
   ```

### Q8: 数据丢失

**问题描述：**
容器删除后数据丢失

**解决方案：**

1. **使用卷**
   ```bash
   docker run -v mydata:/data nginx
   ```

2. **使用绑定挂载**
   ```bash
   docker run -v /host/path:/container/path nginx
   ```

3. **定期备份数据**
   ```bash
   docker cp container:/data ./backup
   ```

## 镜像问题

### Q9: 镜像太大

**解决方案：**

1. **使用 Alpine 基础镜像**
   ```dockerfile
   FROM node:18-alpine
   ```

2. **多阶段构建**
   ```dockerfile
   FROM node:18 AS builder
   RUN npm run build
   
   FROM node:18-alpine
   COPY --from=builder /app/dist ./dist
   ```

3. **清理缓存**
   ```dockerfile
   RUN apt-get clean && rm -rf /var/lib/apt/lists/*
   ```

4. **压缩镜像**
   ```bash
   docker build --compress
   ```

### Q10: 构建缓存失效

**问题描述：**
每次构建都重新安装依赖

**解决方案：**

```dockerfile
# 先复制依赖文件
COPY package*.json ./
RUN npm install

# 再复制源代码
COPY . .
```

### Q11: Dockerfile 构建失败

**解决方案：**

1. **检查基础镜像**
   ```bash
   docker pull <base-image>
   ```

2. **检查网络**
   - 确保能访问外部网络

3. **使用代理**
   ```dockerfile
   ENV HTTP_PROXY=http://proxy:8080
   ENV HTTPS_PROXY=http://proxy:8080
   ```

## 性能问题

### Q12: Docker 占用大量磁盘空间

**解决方案：**

```bash
# 清理未使用的对象
docker system prune -a

# 清理构建缓存
docker builder prune

# 清理卷
docker volume prune

# 查看磁盘使用
docker system df
```

### Q13: 容器运行缓慢

**解决方案：**

1. **限制资源使用**
   ```bash
   docker run -d --memory=512m --cpus=0.5 nginx
   ```

2. **使用 SSD**
   - 将 Docker 数据目录移到 SSD

3. **减少日志大小**
   ```bash
   docker run --log-driver=json-file --log-opt max-size=10m --log-opt max-file=3 nginx
   ```

### Q14: 内存不足

**解决方案：**

1. **限制容器内存**
   ```bash
   docker run -d --memory=256m nginx
   ```

2. **增加 swap**
   ```bash
   docker run -d --memory=256m --memory-swap=512m nginx
   ```

3. **清理内存**
   ```bash
   docker system prune
   ```

## 网络问题

### Q15: 无法从宿主机访问容器

**解决方案：**

1. **检查端口映射**
   ```bash
   docker port mynginx
   ```

2. **正确映射端口**
   ```bash
   # 格式：主机端口:容器端口
   docker run -d -p 8080:80 nginx
   ```

3. **检查防火墙**
   ```bash
   # Windows
   netsh advfirewall firewall add rule name="Docker" dir=in action=allow protocol=tcp localport=8080
   ```

### Q16: DNS 解析失败

**问题描述：**
容器内无法解析域名

**解决方案：**

1. **使用 Google DNS**
   ```bash
   docker run --dns=8.8.8.8 nginx
   ```

2. **修改 Docker DNS**
   ```json
   {
     "dns": ["8.8.8.8", "8.8.4.4"]
   }
   ```

3. **使用 host 网络**
   ```bash
   docker run --network=host nginx
   ```

## 安全问题

### Q17: 以 root 用户运行容器

**解决方案：**

```dockerfile
FROM node:18-alpine

# 创建用户
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# 设置工作目录
WORKDIR /app
COPY --chown=appuser:appgroup . .

# 切换用户
USER appuser

CMD ["node", "server.js"]
```

### Q18: 镜像漏洞

**解决方案：**

1. **使用 Trivy 扫描**
   ```bash
   docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image nginx:latest
   ```

2. **定期更新镜像**
   ```bash
   docker pull nginx:latest
   ```

3. **使用最小化基础镜像**
   ```dockerfile
   FROM node:18-alpine
   ```

## Docker Compose 问题

### Q19: 服务无法启动

**解决方案：**

```bash
# 查看日志
docker-compose logs -f

# 重新构建
docker-compose up --build

# 删除后重新启动
docker-compose down
docker-compose up -d
```

### Q20: 容器依赖顺序

**解决方案：**

```yaml
version: '3.8'
services:
  web:
    build: .
    depends_on:
      - db
      - redis

  db:
    image: postgres

  redis:
    image: redis
```

### Q21: 环境变量不生效

**解决方案：**

```yaml
services:
  web:
    environment:
      - NODE_ENV=production
    env_file:
      - .env
```

## 备份和恢复

### Q22: 备份容器数据

```bash
# 备份卷数据
docker run --rm -v mydata:/data -v $(pwd):/backup alpine tar cvf /backup/mydata.tar /data

# 恢复数据
docker run --rm -v mydata:/data -v $(pwd):/backup alpine tar xvf /backup/mydata.tar -C /
```

## 总结

本章节涵盖了 Docker 使用中的常见问题：

- **安装**：权限、网络、版本
- **运行**：网络、数据、停止
- **镜像**：大小、缓存、构建
- **性能**：磁盘、内存、资源
- **安全**：root 权限、漏洞扫描
- **Compose**：依赖、环境变量

如需更多信息，请参考官方文档：https://docs.docker.com
