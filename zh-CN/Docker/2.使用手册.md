# Docker 使用手册

本手册详细介绍 Docker 的使用方法，从基础到进阶。

---

## 目录

1. [基础概念](#基础概念)
2. [Docker 命令](#docker-命令)
3. [使用镜像](#使用镜像)
4. [使用容器](#使用容器)
5. [网络管理](#网络管理)
6. [数据管理](#数据管理)
7. [Dockerfile 指南](#dockerfile-指南)
8. [Docker Compose](#docker-compose)
9. [最佳实践](#最佳实践)
10. [故障排查](#故障排查)

---

## 基础概念

### 镜像（Image）

镜像是一个只读模板，用于创建容器。可以把镜像看作是一个安装包，包含应用程序及其所有依赖。

```bash
# 列出本地镜像
docker images

# 拉取镜像
docker pull ubuntu:20.04

# 删除镜像
docker rmi ubuntu:20.04
```

### 容器（Container）

容器是镜像的运行实例。每个容器都是相互隔离的运行环境。

```bash
# 运行容器
docker run ubuntu:20.04

# 列出运行中的容器
docker ps

# 列出所有容器
docker ps -a

# 停止容器
docker stop <container_id>
```

### 仓库（Repository）

仓库是存储镜像的地方，最常用的是 Docker Hub。

```bash
# 登录 Docker Hub
docker login

# 推送镜像
docker push username/image:tag

# 搜索镜像
docker search ubuntu
```

---

## Docker 命令

### 镜像命令

```bash
# 列出镜像
docker images
docker image ls

# 拉取镜像
docker pull nginx:latest

# 构建镜像
docker build -t myapp:1.0 .

# 删除镜像
docker rmi nginx:latest
docker image prune -a  # 删除所有未使用的镜像

# 查看镜像历史
docker history nginx:latest

# 镜像标签
docker tag myapp:1.0 myapp:latest
```

### 容器命令

```bash
# 创建并运行容器
docker run -it ubuntu /bin/bash
docker run -d nginx  # 后台运行

# 常用选项
docker run -it      # 交互式 TTY
docker run -d       # 后台运行
docker run -p 8080:80  # 端口映射
docker run -v /host/path:/container/path  # 卷挂载
docker run --name mycontainer  # 指定容器名称
docker run --rm  # 退出后自动删除

# 列出容器
docker ps           # 运行中的
docker ps -a        # 所有
docker ps -q        # 只显示 ID

# 启动/停止/重启容器
docker start <container>
docker stop <container>
docker restart <container>

# 进入容器
docker exec -it <container> /bin/bash
docker attach <container>

# 查看容器日志
docker logs <container>
docker logs -f <container>  # 实时跟踪
docker logs --tail 100 <container>  # 最后100行

# 删除容器
docker rm <container>
docker rm -f <container>  # 强制删除
docker container prune    # 删除所有已停止的容器

# 查看容器详情
docker inspect <container>
```

### 系统命令

```bash
# 查看 Docker 信息
docker info

# 查看磁盘使用
docker system df

# 清理未使用的资源
docker system prune
docker system prune -a  # 包括镜像
```

---

## 使用镜像

### 拉取镜像

```bash
# 拉取最新版本
docker pull ubuntu

# 拉取指定版本
docker pull ubuntu:20.04

# 拉取私人仓库镜像
docker pull registry.example.com/myapp:latest
```

### 构建镜像

#### 使用 Dockerfile

```dockerfile
# 基础镜像
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制文件
COPY package*.json ./
COPY . .

# 安装依赖
RUN npm install

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["node", "server.js"]
```

```bash
# 构建镜像
docker build -t myapp:1.0 .
docker build -t myapp:1.0 -f Dockerfile.dev .  # 指定 Dockerfile
```

#### 使用容器提交

```bash
# 运行容器并修改
docker run -it ubuntu bash

# 在容器中安装软件
apt-get update && apt-get install vim

# 提交更改
docker commit -m "Added vim" <container_id> myubuntu:v1
```

### 多阶段构建

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

---

## 使用容器

### 运行容器

```bash
# 交互式容器
docker run -it ubuntu /bin/bash

# 后台运行容器
docker run -d nginx

# 带端口映射
docker run -d -p 8080:80 nginx

# 带卷挂载
docker run -d -v /my/data:/data mysql

# 带环境变量
docker run -d -e MYSQL_ROOT_PASSWORD=secret mysql
```

### 容器生命周期

```bash
# 创建容器（不运行）
docker create nginx

# 运行容器
docker start <container>

# 创建并运行
docker run nginx

# 停止容器
docker stop <container>

# 重启容器
docker restart <container>

# 暂停容器（CPU暂停）
docker pause <container>

# 取消暂停
docker unpause <container>

# 删除容器
docker rm <container>
```

### 容器日志

```bash
# 查看日志
docker logs <container>

# 实时跟踪
docker logs -f <container>

# 显示时间戳
docker logs -t <container>

# 最后N行
docker logs --tail 100 <container>
```

### 进入容器

```bash
# exec 方式（推荐）
docker exec -it <container> /bin/bash

# attach 方式（会共享容器的标准输入输出）
docker attach <container>
```

---

## 网络管理

### 网络类型

| 驱动 | 说明 |
|------|------|
| bridge | 默认网络，容器间通信 |
| host | 共享主机网络 |
| overlay | 跨主机通信 |
| macvlan | 给容器分配 MAC 地址 |

### 管理网络

```bash
# 列出网络
docker network ls

# 创建网络
docker network create mynetwork

# 查看网络详情
docker network inspect mynetwork

# 删除网络
docker network rm mynetwork

# 连接容器到网络
docker network connect mynetwork <container>

# 断开容器与网络
docker network disconnect mynetwork <container>
```

### 端口映射

```bash
# 主机端口 8080 映射到容器端口 80
docker run -p 8080:80 nginx

# 指定协议
docker run -p 8080:80/tcp nginx

# 映射多个端口
docker run -p 8080:80 -p 443:443 nginx
```

---

## 数据管理

### 卷（Volume）

```bash
# 创建卷
docker volume create mydata

# 列出卷
docker volume ls

# 查看卷详情
docker volume inspect mydata

# 删除卷
docker volume rm mydata

# 使用卷运行容器
docker run -v mydata:/data mysql

# 绑定主机目录
docker run -v /host/path:/container/path nginx
```

### 挂载类型

```bash
# 命名卷
docker run -v myvolume:/data nginx

# 绑定挂载（主机目录）
docker run -v $(pwd):/app nginx

# 只读挂载
docker run -v myvolume:/data:ro nginx

# tmpfs 挂载（内存）
docker run --tmpfs /app nginx
```

---

## Dockerfile 指南

### 常用指令

```dockerfile
# 指定基础镜像
FROM python:3.9-slim

# 设置维护者
LABEL maintainer="email@example.com"

# 设置环境变量
ENV APP_ENV=production

# 设置工作目录
WORKDIR /app

# 复制文件
COPY requirements.txt ./
COPY . .

# 运行命令
RUN pip install -r requirements.txt

# 暴露端口
EXPOSE 3000

# 设置默认命令
CMD ["python", "app.py"]

# 设置入口点（与 CMD 配合）
ENTRYPOINT ["python", "app.py"]
```

### 最佳实践

```dockerfile
# 1. 使用特定版本标签，避免使用 latest
FROM node:18-alpine

# 2. 多阶段构建减少镜像大小
FROM node:18-alpine AS builder
WORKDIR /app
RUN npm install && npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html

# 3. 合理排序指令，利用缓存
COPY package*.json ./
RUN npm install
COPY . .

# 4. 使用 .dockerignore
# .git
# node_modules
# Dockerfile
# README.md

# 5. 使用多行命令
RUN apt-get update && \
    apt-get install -y curl && \
    rm -rf /var/lib/apt/lists/*

# 6. 非 root 用户
RUN useradd -m appuser
USER appuser
```

### 示例 Dockerfile

#### Node.js 应用

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

USER node

CMD ["node", "index.js"]
```

#### Python 应用

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

#### React 应用

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine
COPY --from=builder /app/build /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## Docker Compose

### 基本结构

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - .:/app
    environment:
      - NODE_ENV=production
    depends_on:
      - db

  db:
    image: postgres:14
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=secret

volumes:
  db-data:
```

### 常用命令

```bash
# 启动所有服务
docker-compose up

# 后台启动
docker-compose up -d

# 停止服务
docker-compose down

# 查看日志
docker-compose logs -f

# 构建镜像
docker-compose build

# 重新创建容器
docker-compose up -d --force-recreate

# 进入服务容器
docker-compose exec web bash

# 列出容器
docker-compose ps

# 扩展服务
docker-compose up -d --scale web=3
```

### 多文件组合

```bash
# 使用指定文件
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
```

---

## 最佳实践

### 1. 镜像优化

- 使用轻量基础镜像（alpine）
- 多阶段构建
- 减少层数
- 合理使用 .dockerignore

### 2. 安全

- 不使用 root 用户运行容器
- 扫描镜像漏洞
- 限制容器资源
- 使用 secrets 存储敏感信息

```dockerfile
# 创建非 root 用户
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

USER appuser
```

### 3. 日志管理

```bash
# 限制日志大小
docker run --log-opt max-size=10m --log-opt max-file=3 nginx
```

### 4. 健康检查

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost/ || exit 1
```

### 5. 资源限制

```bash
# 限制 CPU 和内存
docker run --memory=512m --cpus=0.5 nginx
```

---

## 故障排查

### 容器无法启动

```bash
# 查看详细错误
docker logs <container>

# 查看容器进程
docker top <container>

# 查看资源限制
docker stats <container>
```

### 网络问题

```bash
# 检查网络
docker network inspect bridge

# 测试容器间通信
docker exec <container1> ping <container2>
```

### 磁盘空间不足

```bash
# 清理资源
docker system prune -a
docker volume prune
```

---

## 相关资源

- Docker 官方文档：https://docs.docker.com/
- Docker Hub：https://hub.docker.com/
- Docker Compose：https://docs.docker.com/compose/
- 最佳实践指南：https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

---

*最后更新：2024*
