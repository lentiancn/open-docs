# frp 常见问题

本章节汇总了 frp 使用过程中最常见的问题和解决方案。

## 连接问题

### 无法连接服务器

**问题表现**：
- 客户端显示 `connect to server failed`
- 日志显示 `connection refused`

**排查步骤**：

1. **检查网络连通性**

```bash
# ping 服务器
ping your_server_ip

# telnet 测试端口
telnet your_server_ip 7000
```

2. **检查服务端是否运行**

```bash
# 查看 frps 进程
ps aux | grep frps

# 查看端口监听
netstat -tlnp | grep frps
```

3. **检查防火墙**

```bash
# 查看已开放端口
firewall-cmd --list-ports

# 临时关闭防火墙测试
systemctl stop firewalld
```

4. **检查 Token 是否匹配**

确保服务端和客户端的 `auth.token` 配置完全一致。

5. **查看详细日志**

```bash
# 以前台模式运行查看详细输出
./frps -c frps.toml -v
# 或
./frpc -c frpc.toml -v
```

### 连接成功但无法访问服务

**问题表现**：
- 客户端显示连接成功
- 但访问公网端口提示连接被拒绝

**排查步骤**：

1. **检查本地服务是否运行**

```bash
# 例如 SSH 服务
systemctl status sshd
# 或
netstat -tlnp | grep :22
```

2. **检查 localPort 配置**

确认 `localPort` 与实际服务端口一致。

3. **检查 remotePort 是否被占用**

```bash
netstat -tlnp | grep :6000
```

4. **检查日志**

查看服务端和客户端日志，确认请求是否到达服务端。

### 连接经常断开

**解决方案**：

1. **启用 TCP 心跳检测**

```toml
# frpc.toml
transport.tcpMux = true
transport.tcpMuxKeepalive = 60
```

2. **增加重连机制**

```toml
# frpc.toml
transport.poolCount = 5
```

3. **使用更稳定的协议**

```toml
# 尝试使用 KCP
transport.protocol = "kcp"
```

## 配置问题

### 端口被占用

**问题表现**：
- 启动失败，提示 `port already in use`

**解决方案**：

1. **查找占用进程**

```bash
netstat -tlnp | grep :7000
```

2. **更换端口**

在配置中修改为其他端口：

```toml
bindPort = 7001
```

3. **Linux 系统端口复用**

如果需要同一端口同时处理多种协议：

```toml
bindPort = 7000
vhostHTTPPort = 80
vhostHTTPSPort = 443
```

### 多个客户端使用相同端口

**问题场景**：
- 多个 frpc 需要暴露 80 端口

**解决方案**：

1. **使用不同的域名**

```toml
# 客户端 1
[[proxies]]
name = "web1"
type = "http"
localPort = 8080
customDomains = "web1.yourdomain.com"

# 客户端 2
[[proxies]]
name = "web2"
type = "http"
localPort = 8080
customDomains = "web2.yourdomain.com"
```

2. **使用 URL 路由**

```toml
# 客户端 1
[[proxies]]
name = "web1"
type = "http"
localPort = 8080
customDomains = "web.yourdomain.com"
locations = ["/api"]

# 客户端 2
[[proxies]]
name = "web2"
type = "http"
localPort = 8081
customDomains = "web.yourdomain.com"
locations = ["/"]
```

### 配置文件格式错误

**问题表现**：
- 启动失败，提示配置解析错误

**常见错误**：

1. **TOML 格式错误**
   - 字符串必须用引号
   - 数组元素用逗号分隔
   - 布尔值小写（true/false）

2. **YAML 格式错误**
   - 缩进必须一致
   - 数组用 `-` 开头

**验证配置**：

```bash
./frpc verify -c frpc.toml
```

## 性能问题

### 传输速度慢

**可能原因**：
- 网络带宽不足
- 未启用压缩
- 服务器负载过高

**优化方案**：

1. **启用压缩**

```toml
[[proxies]]
name = "ssh"
type = "tcp"
transport.useCompression = true
```

2. **启用加密**（默认已启用）

```toml
transport.useEncryption = true
```

3. **选择就近的服务器**

选择延迟更低的服务端节点。

4. **检查服务器网络**

```bash
# 本地测速
speedtest-cli
```

### 延迟太高

**优化建议**：

1. **使用 KCP 协议**

```toml
transport.protocol = "kcp"
```

2. **使用 QUIC 协议**

```toml
transport.protocol = "quic"
```

3. **启用 TCP 流复用**

```toml
transport.tcpMux = true
```

4. **使用 P2P 模式**（XTCP）

适用于大流量场景，数据不经过服务器中转。

### 内存占用高

**优化方案**：

1. **减少连接池数量**

```toml
transport.poolCount = 1
```

2. **减少代理数量**

只暴露必要的服务。

3. **使用轻量级客户端**

可考虑使用 [tiny-frpc](https://github.com/gofrp/tiny-frpc)，最小仅 3.5MB。

## 安全问题

### 如何保证安全

**建议措施**：

1. **使用强 Token**

```toml
auth.token = "生成一个复杂的随机字符串"
```

2. **启用 TLS 加密**

默认已启用，确保没有被手动禁用。

3. **限制可访问的端口**

```toml
# frps.toml
allowPorts = [
  { start = 2000, end = 3000 },
  { single = 6000 },
  { single = 7000 }
]
```

4. **Web 服务使用密码保护**

```toml
[[proxies]]
name = "web"
type = "http"
localPort = 80
httpUser = "admin"
httpPassword = "your_password"
```

5. **使用 STCP 而非 TCP**

需要预共享密钥，更安全。

6. **定期更新版本**

及时修复安全漏洞。

### frpc 被杀毒软件删除

**问题说明**：
- 某些杀毒软件会误报 frpc 为恶意软件

**解决方案**：
1. 将 frpc 添加到杀毒软件白名单
2. 或在杀毒软件设置中排除 frpc 所在目录

### 如何防止端口被滥用

```toml
# frps.toml
allowPorts = [
  { start = 2000, end = 8000 }
]
```

只允许特定范围内的端口，避免安全风险。

## 功能问题

### 热更新失败

**可能原因**：
- 配置文件语法错误
- 新端口被占用

**排查**：

```bash
# 先验证配置
./frpc verify -c frpc.toml

# 再热更新
./frpc reload -c frpc.toml
```

### 无法访问控制面板

**排查步骤**：

1. **检查端口是否开放**

```bash
netstat -tlnp | grep :7500
```

2. **检查防火墙**

```bash
firewall-cmd --permanent --add-port=7500/tcp
firewall-cmd --reload
```

3. **检查配置**

```toml
webServer.addr = "0.0.0.0"  # 监听地址
webServer.port = 7500
```

### P2P 模式无法连接

**可能原因**：
- NAT 类型不支持
- 防火墙阻断 UDP

**解决方案**：

1. **使用 STCP 作为备选**

```toml
# 客户端
[[proxies]]
name = "ssh"
type = "stcp"  # 改为 stcp
secretKey = "your_key"
```

2. **配置 STUN 服务器**

```toml
natHoleStunServer = "your-stun-server.com:3478"
```

### 微信公众号开发调试

**配置示例**：

```toml
serverAddr = "your_server_ip"
serverPort = 7000

[[proxies]]
name = "wechat"
type = "http"
localPort = 8080
customDomains = "yourdomain.com"
```

**注意事项**：
- 需要将域名解析到服务器 IP
- 微信公众号后台需要配置服务器地址为 `http://yourdomain.com`

## 运维问题

### 如何开机自启

**Linux systemd**：

```bash
sudo systemctl enable frps
sudo systemctl enable frpc
```

**Windows**：

使用 NSSM 或创建计划任务。

### 如何查看日志

**systemd 日志**：

```bash
# 实时查看
journalctl -u frps -f

# 最近 100 行
journalctl -u frps -n 100
```

**nohup 日志**：

```bash
tail -f nohup.out
```

### 如何升级 frp

1. 停止服务
2. 下载新版本
3. 替换二进制文件
4. 重新启动

```bash
# 停止服务
systemctl stop frps

# 下载新版本
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz

# 解压替换
tar -xzf frp_0.52.0_linux_amd64.tar.gz
cp frp_0.52.0_linux_amd64/frps /usr/local/bin/

# 重启服务
systemctl restart frps
```

### 如何迁移服务器

1. 在新服务器安装 frp
2. 使用相同配置（Token、端口等）
3. 确保防火墙开放相应端口
4. 客户端无需修改配置

## 其他问题

### frp 与 ngrok 的区别

| 特性 | frp | ngrok |
|------|-----|-------|
| 开源 | ✅ | 部分开源 |
| 自建服务器 | ✅ | 需要付费 |
| 性能 | 高 | 中 |
| 协议支持 | 多 | 较少 |
| 配置复杂度 | 低 | 中 |

### 为什么选择 frp

- 完全开源免费
- 可以自己搭建服务器
- 性能优秀
- 配置简单
- 社区活跃

### frp v2 什么时候发布

根据官方说明，v2 版本正在开发中，复杂度较高，发布时间未定。当前 v0.x 版本稳定可靠，可以放心使用。

### 常见错误代码

| 错误 | 说明 | 解决方案 |
|-----|------|---------|
| 1001 | 连接被拒绝 | 检查服务端是否运行 |
| 1002 | 认证失败 | 检查 Token |
| 1003 | 端口被占用 | 更换端口 |
| 1004 | 代理不存在 | 检查代理名称 |
| 1005 | 配置错误 | 验证配置文件 |

### 获取帮助

- 官方文档：https://gofrp.org
- GitHub Issues：https://github.com/fatedier/frp/issues
- 搜索已有问题，大部分常见问题都有解答
