# Руководство по использованию LivePortrait

LivePortrait — эффективная платформа для анимации портретов, которая анимирует статические портреты с использованием движения из управляющих видео. Поддерживает управление сшиванием и перенацеливанием.

## Быстрый старт

### Основная команда

```bash
# Анимация на основе видео
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results
```

### Со сшиванием

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir ./results \
  --stitching
```

### С перенацеливанием глаз/губ

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Параметры команды

### Параметры ввода

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `--source_image` | Путь к входному изображению портрета | Обязательно |
| `--driving_video` | Путь к управляющему видео | Опционально |
| `--driven_audio` | Путь к управляющему аудио | Опционально |
| `--result_dir` | Выходная директория | ./results |

### Параметры обработки

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `--stitching` | Включить сшивание | False |
| `--eye_retargeting` | Перенацеливание глаз (0-1) | 0 |
| `--lip_retargeting` | Перенацеливание губ (0-1) | 0 |
| `--face_parser` | Включить разбор лица | True |

### Параметры производительности

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `--batch_size` | Размер пакета | 1 |
| `--fps` | Частота кадров выходного видео | 30 |

## Примеры использования

### Пример 1: Базовая анимация на основе видео

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/basic
```

### Пример 2: Со сшиванием

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/stitching \
  --stitching
```

### Пример 3: Управление глазами

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/eyes \
  --eye_retargeting 0.8
```

### Пример 4: Управление синхронизацией губ

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/lips \
  --lip_retargeting 0.7
```

### Пример 5: Полный контроль

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driving_video examples/driving_video.mp4 \
  --result_dir results/full \
  --stitching \
  --eye_retargeting 0.5 \
  --lip_retargeting 0.5
```

## Python API

### Базовое использование

```python
from liveportrait import LivePortrait

# Инициализация
lp = LivePortrait()

# Анимация портрета
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.5,
    lip_retargeting=0.5
)

print(f"Видео сохранено в: {result}")
```

### Расширенное использование

```python
from liveportrait import LivePortrait
import torch

# Инициализация с пользовательскими настройками
lp = LivePortrait(
    checkpoint_path="pretrained_models/liveportrait.pth",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Генерация с полным контролем
result = lp.animate(
    source_image="image.jpg",
    driving_video="video.mp4",
    stitching=True,
    eye_retargeting=0.8,
    lip_retargeting=0.8,
    output_fps=30,
    output_resolution=(512, 512)
)
```

### Пакетная обработка

```python
from liveportrait import LivePortrait
import os

lp = LivePortrait()

# Обработка нескольких изображений
source_dir = "source_images/"
driving_video = "driving.mp4"

for image_file in os.listdir(source_dir):
    if image_file.endswith(('.jpg', '.png')):
        result = lp.animate(
            source_image=os.path.join(source_dir, image_file),
            driving_video=driving_video,
            stitching=True
        )
```

## Веб-интерфейс

### Запуск веб-демонстрации

```bash
python app.py
```

Затем откройте http://localhost:7860 в браузере

### Функции веб-интерфейса

1. **Загрузка исходного изображения** - Загрузить изображение портрета
2. **Загрузка управляющего видео** - Выбрать управляющее видео
3. **Переключатель сшивания** - Включить/отключить сшивание
4. **Управление глазами** - Настроить интенсивность движения глаз
5. **Управление губами** - Настроить интенсивность синхронизации губ
6. **Создать** - Создать анимацию
7. **Скачать** - Сохранить результат

## Функции

### 1. Сшивание

Модуль сшивания соединяет сгенерированную голову с телом бесшовно:

```bash
--stitching
```

- Плавный переход между головой и телом
- Работает с различными стилями изображений (реалистичный, масляная живопись, скульптура, 3D)

### 2. Перенацеливание глаз

Управляет открытием глаз с помощью скалярного значения (0-1):

```bash
--eye_retargeting 0.5
```

- 0: Глаза закрыты
- 1: Глаза полностью открыты
- 0.5: Естественно

### 3. Перенацеливание губ

Управляет интенсивностью движения губ:

```bash
--lip_retargeting 0.5
```

- 0: Минимальное движение
- 1: Максимальное движение
- 0.5: Естественно

## Требования к входным данным

### Исходное изображение

- Формат: JPG, PNG
- Разрешение: Рекомендуется 512x512 или выше
- Лицо: Анфас, четкое
- Фон: Любой

### Управляющее видео

- Формат: MP4, AVI
- Длительность: 1-60 секунд
- Разрешение: Любое
- Лицо: Четкие выражения лица

## Выходные данные

### Формат видео

- Формат: MP4
- Кодек: H.264
- Разрешение: 512x512
- Частота кадров: 30

### Выходная директория

```
results/
├── output.mp4          # Сгенерированное видео
└── (временные файлы)
```

## Устранение неполадок

### Низкое качество анимации

**Решения:**
- Использовать исходное изображение более высокого качества
- Убедиться, что управляющее видео имеет четкое лицо
- Настроить параметры перенацеливания

### Лицо не обнаружено

**Решения:**
- Использовать более четкое изображение портрета
- Убедиться, что лицо видно
- Проверить формат изображения

### Медленная обработка

**Решения:**
- Снизить выходное разрешение
- Отключить сшивание, если не требуется
- Использовать ускорение GPU

### Недостаточно памяти GPU

**Решения:**
- Уменьшить размер пакета до 1
- Использовать меньший размер изображения
- Закрыть другие приложения GPU

## Советы по производительности

### Более быстрая обработка

1. Отключить сшивание, если не требуется
2. Использовать более низкое выходное разрешение
3. Снизить fps

### Лучшее качество

1. Включить сшивание
2. Использовать исходное изображение высокого качества
3. Настроить параметры перенацеливания

## Ссылки

- [GitHub](https://github.com/KwaiVGI/LivePortrait)
- [Статья](https://arxiv.org/abs/2407.03168)
- [Демо](https://liveportrait.github.io)
