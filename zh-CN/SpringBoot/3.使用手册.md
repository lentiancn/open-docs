# Spring Boot 使用手册

本手册介绍 Spring Boot 的核心概念和实际使用方法。

## 第一个 Spring Boot 应用

### 主类

```java
package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}
```

## REST API 开发

### Controller

```java
package com.example.demo.controller;

import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/api/users")
public class UserController {
    
    private final UserService userService;
    
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    @GetMapping
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    @PutMapping("/{id}")
    public User updateUser(@PathVariable Long id, @RequestBody User user) {
        user.setId(id);
        return userService.save(user);
    }
    
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteById(id);
    }
}
```

### Service

```java
package com.example.demo.service;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import org.springframework.stereotype.Service;
import java.util.List;

@Service
public class UserService {
    
    private final UserRepository userRepository;
    
    public UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
    
    public List<User> findAll() {
        return userRepository.findAll();
    }
    
    public User findById(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("User not found"));
    }
    
    public User save(User user) {
        return userRepository.save(user);
    }
    
    public void deleteById(Long id) {
        userRepository.deleteById(id);
    }
}
```

### Entity

```java
package com.example.demo.model;

import jakarta.persistence.*;

@Entity
@Table(name = "users")
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(unique = true)
    private String email;
    
    private Integer age;
    
    // Getter 和 Setter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    
    public Integer getAge() { return age; }
    public void setAge(Integer age) { this.age = age; }
}
```

### Repository

```java
package com.example.demo.repository;

import com.example.demo.model.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
}
```

## 参数校验

### 使用 Validation

```java
import jakarta.validation.constraints.*;

public class UserRequest {
    
    @NotBlank(message = "姓名不能为空")
    private String name;
    
    @Email(message = "邮箱格式不正确")
    private String email;
    
    @Min(value = 0, message = "年龄不能小于0")
    @Max(value = 150, message = "年龄不能大于150")
    private Integer age;
    
    // Getter 和 Setter
}
```

### Controller 中使用

```java
@PostMapping
public User createUser(@Valid @RequestBody UserRequest request) {
    User user = new User();
    user.setName(request.getName());
    user.setEmail(request.getEmail());
    user.setAge(request.getAge());
    return userService.save(user);
}
```

### 全局异常处理

```java
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String, String>> handleValidationExceptions(
            MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getAllErrors().forEach((error) -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });
        return ResponseEntity.badRequest().body(errors);
    }
}
```

## 事务管理

### 开启事务

```java
@Service
public class UserService {
    
    @Transactional
    public void updateUser(Long id, User user) {
        User existing = userRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Not found"));
        existing.setName(user.getName());
        userRepository.save(existing);
    }
    
    @Transactional(rollbackFor = Exception.class)
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
}
```

## 数据库操作

### JPA 常用方法

```java
// 继承 JpaRepository 后自动获得的方法
userRepository.findAll();           // 查询所有
userRepository.findById(id);       // 按 ID 查询
userRepository.save(user);          // 保存/更新
userRepository.deleteById(id);     // 删除
userRepository.count();             // 计数
userRepository.existsById(id);      // 判断是否存在
```

### 自定义查询

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // 根据姓名查询
    List<User> findByName(String name);
    
    // 模糊查询
    List<User> findByNameContaining(String name);
    
    // 多条件查询
    Optional<User> findByEmailAndName(String email, String name);
    
    // 排序
    List<User> findByAgeGreaterThanOrderByAgeDesc(int age);
    
    // 分页
    Page<User> findByNameContaining(String name, Pageable pageable);
}
```

### 使用 Query 注解

```java
@Query("SELECT u FROM User u WHERE u.name = ?1")
User findByNameQuery(String name);

@Query("SELECT u FROM User u WHERE u.email = :email")
User findByEmail(@Param("email") String email);

@Modifying
@Query("UPDATE User u SET u.name = ?1 WHERE u.id = ?2")
int updateNameById(String name, Long id);
```

## 拦截器和过滤器

### 拦截器

```java
import org.springframework.web.servlet.HandlerInterceptor;
import jakarta.servlet.http.*;

public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        String token = request.getHeader("Authorization");
        if (token == null) {
            response.setStatus(401);
            return false;
        }
        return true;
    }
}
```

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new AuthInterceptor())
            .addPathPatterns("/api/**")
            .excludePathPatterns("/api/public/**");
    }
}
```

### 过滤器

```java
import jakarta.servlet.*;
import jakarta.servlet.http.*;
import org.springframework.stereotype.Component;
import java.io.IOException;

@Component
public class LoggingFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) 
                        throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        System.out.println("Request: " + httpRequest.getRequestURI());
        chain.doFilter(request, response);
    }
}
```

## 异步处理

### Async

```java
@Service
public class AsyncService {
    
    @Async
    public void asyncMethod() {
        // 异步执行
    }
    
    @Async
    public CompletableFuture<String> asyncWithResult() {
        return CompletableFuture.completedFuture("Result");
    }
}
```

```java
@Configuration
@EnableAsync
public class AsyncConfig {
}
```

## 定时任务

### Scheduled

```java
@Service
public class ScheduledService {
    
    // 每分钟执行
    @Scheduled(cron = "0 * * * * ?")
    public void task1() {
        System.out.println("每分钟执行");
    }
    
    // 每 5 秒执行
    @Scheduled(fixedRate = 5000)
    public void task2() {
        System.out.println("每5秒执行");
    }
}
```

```java
@Configuration
@EnableScheduling
public class SchedulingConfig {
}
```

## 文件上传

```java
@PostMapping("/upload")
public String uploadFile(@RequestParam("file") MultipartFile file) {
    if (file.isEmpty()) {
        return "文件为空";
    }
    
    String filename = file.getOriginalFilename();
    String path = "uploads/" + filename;
    
    try {
        file.transferTo(new java.io.File(path));
        return "上传成功";
    } catch (IOException e) {
        return "上传失败";
    }
}
```

## 常用注解

| 注解 | 说明 |
|------|------|
| @SpringBootApplication | 启动类注解 |
| @RestController | REST 控制器 |
| @Service | 服务层 |
| @Repository | 持久层 |
| @Component | 组件 |
| @Autowired | 自动注入 |
| @RequestMapping | 请求映射 |
| @GetMapping | GET 请求 |
| @PostMapping | POST 请求 |
| @PutMapping | PUT 请求 |
| @DeleteMapping | DELETE 请求 |
| @RequestBody | 请求体 |
| @PathVariable | 路径参数 |
| @RequestParam | 请求参数 |
| @Transactional | 事务 |
| @Valid | 参数校验 |

## 总结

本手册涵盖了 Spring Boot 开发的核心知识点：

- **REST API**：Controller、Service、Repository
- **数据访问**：JPA、Repository、自定义查询
- **参数校验**：Validation、异常处理
- **拦截器/过滤器**：请求拦截、日志
- **异步**：@Async
- **定时任务**：@Scheduled
- **文件上传**：MultipartFile

掌握这些内容后，你就可以开始 Spring Boot 项目开发了。
