# Yarn 使用手册

本手册将详细介绍 Yarn 的各项功能和使用方法，帮助你充分利用这个强大的 JavaScript 包管理器。无论你是刚刚接触 Yarn 的新手，还是希望深入了解高级功能的老用户，都能在这里找到有价值的信息。

---

## 基础概念

### package.json 详解

package.json 是 Node.js 项目的核心配置文件，它定义了项目的元数据、依赖关系和可执行脚本。理解 package.json 的结构对于熟练使用 Yarn 至关重要。

**基本结构**：

```json
{
  "name": "my-awesome-project",
  "version": "1.0.0",
  "description": "这是一个令人惊叹的项目",
  "type": "module",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.esm.js",
      "require": "./dist/index.cjs"
    }
  },
  "files": [
    "dist"
  ],
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest",
    "lint": "eslint src --ext .ts,.tsx",
    "format": "prettier --write src"
  },
  "dependencies": {
    "react": "^18.2.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "vitest": "^1.0.0"
  },
  "peerDependencies": {
    "react": ">=16.8.0"
  },
  "optionalDependencies": {
    "fsevents": "^2.3.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "yarn": ">=4.0.0"
  },
  "packageManager": "yarn@4.0.0"
}
```

**字段说明**：

- name：项目名称，必须唯一，不能包含大写字母和特殊字符
- version：语义化版本号，遵循 major.minor.patch 格式
- description：项目描述
- type：模块类型，commonjs 或 module
- main：包的入口文件
- module：ES 模块入口
- types：TypeScript 类型定义文件
- exports：包的导出配置，支持多种格式
- files：发布时要包含的文件/目录
- scripts：可执行的脚本命令
- dependencies：运行时依赖
- devDependencies：开发时依赖
- peerDependencies：对等依赖，规定宿主必须提供的依赖
- optionalDependencies：可选依赖，安装失败不会导致项目失败
- engines：运行环境要求
- packageManager：项目使用的包管理器版本

### 依赖类型详解

Yarn（和 npm）支持多种依赖类型，每种类型有不同的用途：

**dependencies（运行时依赖）**：项目在生产环境中需要的依赖。比如 React、Lodash 等库，生产部署时仍然需要。

**devDependencies（开发依赖）**：仅在开发过程中需要的依赖。比如 TypeScript、ESLint、Vite 等构建工具和开发工具。这些依赖不会被打包到最终产品中。

**peerDependencies（对等依赖）**：规定包的消费者必须自行提供的依赖。通常用于插件开发。比如一个 React 组件库的 peerDependencies 会声明 react 版本，消费者需要自行安装 React。

**optionalDependencies（可选依赖）**：安装失败不会导致整体安装失败的依赖。通常用于平台特定的依赖，比如 fsevents 只在 macOS 上需要。

### yarn.lock 文件的作用

yarn.lock 是 Yarn 最重要的文件之一，它记录了依赖树中每个包的确切版本。当你运行 yarn install 时，Yarn 会：

1. 读取 package.json 中的依赖声明
2. 解析所有直接依赖和传递依赖
3. 根据语义化版本规则确定确切的版本
4. 将结果写入 yarn.lock

下次安装时，无论在什么环境、什么时间，Yarn 都会严格按照 yarn.lock 中的版本来安装，确保完全一致的结果。这就是所谓的"确定性保证"。

---

## 日常使用指南

### 初始化项目

创建一个新的 Node.js 项目：

```bash
# 交互式初始化（会询问项目信息）
yarn init -2

# 非交互式快速创建
yarn init -y
```

这会在当前目录创建一个基本的 package.json 文件。

### 安装依赖

**安装所有依赖**：

```bash
# 标准安装
yarn install

# 简写
yarn
```

首次安装会根据 package.json 和 yarn.lock（如有）安装所有依赖。

**安装并生成锁文件**：

```bash
# immutable 模式，防止修改 lock 文件
yarn install --immutable
```

这在 CI 环境中常用，确保不会意外修改锁文件。

### 添加依赖

```bash
# 添加运行时依赖
yarn add lodash

# 添加开发依赖
yarn add -D typescript
yarn add --dev eslint

# 添加特定版本
yarn add lodash@4.17.21

# 添加最新版本
yarn add lodash@latest

# 添加预发布版本
yarn add lodash@beta
```

Yarn 会自动选择合适的版本修饰符。默认使用脱字符（^），允许次版本更新。

**版本修饰符选项**：

```bash
# 精确版本（无修饰符）
yarn add -E lodash@4.17.21

# 波浪号（允许补丁版本）
yarn add -T lodash@4.17.21

# 脱字符（允许次版本，默认）
yarn add -C lodash@4.17.21
```

### 移除依赖

```bash
# 移除运行时依赖
yarn remove lodash

# 移除开发依赖
yarn remove typescript --dev
```

### 更新依赖

```bash
# 更新到最新版本（根据版本修饰符）
yarn up lodash

# 更新到特定版本
yarn up lodash@4.17.20

# 交互式更新（显示版本选择）
yarn up -i

# 更新所有依赖
yarn up --all

# 交互式更新所有
yarn up -i --all
```

### 运行脚本

在 package.json 中定义的脚本可以通过以下方式运行：

```bash
# 运行自定义脚本
yarn dev
yarn build
yarn test

# 显式使用 run
yarn run dev

# 列出所有可用脚本
yarn run
```

如果脚本名称与 Yarn 内置命令冲突，使用 run：

```bash
yarn run my-custom-script
```

### 查看依赖

```bash
# 列出所有依赖
yarn list

# 只列出顶层依赖
yarn list --level=0

# 树形显示
yarn list --tree

# 检查过时依赖
yarn outdated
```

outdated 命令的输出示例：

```
Package            Current   Wanted   Latest  Package Type    URL
lodash             4.17.20  4.17.21  4.17.21  dependencies    https://lodash.com/
typescript         5.0.2    5.0.4    5.1.0   devDependencies  https://typescriptlang.org/
```

### 查看包信息

```bash
# 查看包详细信息
yarn info lodash

# 查看特定版本
yarn info lodash@4.17.21

# 查看特定字段
yarn info lodash description
yarn info lodash repository
```

### 了解依赖原因

```bash
# 查看为什么安装了某个包
yarn why lodash
```

这会显示依赖链，帮助你理解为什么某个包被安装。

---

## 工作区（Workspaces）完全指南

工作区是 Yarn 最强大的功能之一，它允许你在单个代码库中管理多个相关的包。

### 配置工作区

在根 package.json 中添加 workspaces 字段：

```json
{
  "name": "my-monorepo",
  "private": true,
  "workspaces": [
    "packages/*",
    "apps/*"
  ]
}
```

workspaces 支持 glob 模式：

```json
{
  "workspaces": [
    "packages/*",
    "packages/@org/*",
    "apps/*"
  ]
}
```

### 创建工作区包

每个工作区就是一个普通的 npm 包，有自己的 package.json：

```
my-monorepo/
├── package.json
└── packages/
    ├── core/
    │   ├── package.json
    │   └── src/
    │       └── index.ts
    ├── ui-button/
    │   ├── package.json
    │   └── src/
    │       └── Button.tsx
    └── utils/
        ├── package.json
        └── src/
            └── index.ts
```

### 工作区命令

**添加依赖到特定工作区**：

```bash
yarn workspace @my-org/core add lodash
yarn workspace @my-org/core add -D typescript
```

**在特定工作区运行脚本**：

```bash
yarn workspace @my-org/core run build
yarn workspace @my-org/ui-button run test
```

**在所有工作区运行命令**：

```bash
# 构建所有工作区
yarn workspaces foreach -pt run build

# -p: 并行执行
# -t: 显示时间
# -A: 包括所有工作区
```

**聚焦安装**（只安装指定工作区）：

```bash
# 只安装 @my-org/app 及其依赖
yarn workspaces focus @my-org/app

# 包括生产依赖
yarn workspaces focus @my-org/app --production
```

**列出所有工作区**：

```bash
yarn workspaces list
```

### 工作区间依赖

使用 workspace: 协议引用工作区：

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:*",
    "@my-org/constants": "workspace:^",
    "@my-org/shared": "workspace:~"
  }
}
```

发布时，Yarn 会自动转换为实际版本号：

| workspace 协议 | 本地版本 | 发布后 |
|---------------|---------|--------|
| workspace:* | 1.0.0 | 1.0.0 |
| workspace:^ | 1.0.0 | ^1.0.0 |
| workspace:~ | 1.0.0 | ~1.0.0 |
| workspace:>= | 1.0.0 | >=1.0.0 |

### 约束（Constraints）

约束允许你定义规则来管理所有工作区。创建 constraints.pro 文件：

```javascript
// 约束：确保所有工作区使用相同版本的 TypeScript
workspaces.forEach(workspace => {
  const ts = workspace.dependencies.get("typescript");
  if (!ts || ts.version !== "^5.0.0") {
    workspace.dependencies.set("typescript", "workspace:^5.0.0");
  }
});

// 约束：确保所有工作区有正确的 license
workspaces.forEach(workspace => {
  if (!workspace.license) {
    throw new Error(`Missing license in ${workspace.name}`);
  }
});

// 约束：确保所有工作区有 description
workspaces.forEach(workspace => {
  workspace.set("description", `The ${workspace.name} package`);
});
```

运行约束检查：

```bash
yarn constraints
```

---

## 插件系统

### 插件简介

Yarn 的插件系统允许你扩展其功能。Yarn 4.x 内置了核心插件，同时提供了丰富的官方插件。

### 官方插件列表

```bash
yarn plugin list
```

常用插件：

- @yarnpkg/plugin-github - 从 GitHub 安装包
- @yarnpkg/plugin-npm - npm 相关功能
- @yarnpkg/plugin-pack - 打包功能
- @yarnpkg/plugin-workspace-tools - 工作区工具增强

### 安装插件

```bash
# 从官方插件列表安装
yarn plugin import @yarnpkg/plugin-github

# 从 URL 安装
yarn plugin import https://example.com/plugin.js

# 从本地文件安装
yarn plugin import ./my-plugin.js
```

### 移除插件

```bash
yarn plugin remove @yarnpkg/plugin-github
```

### 插件运行时

```bash
# 查看当前运行的插件
yarn plugin runtime
```

---

## 缓存管理

### 查看缓存

```bash
# 查看缓存目录
yarn cache dir

# 列出缓存的包
yarn cache list

# 列出特定包的缓存版本
yarn cache list lodash
```

### 清理缓存

```bash
# 清理所有缓存
yarn cache clean

# 清理特定包
yarn cache clean lodash
```

### 全局缓存

Yarn 4.x 支持全局缓存，修改 .yarnrc.yml：

```yaml
enableGlobalCache: true
```

---

## 配置详解

### .yarnrc.yml 配置

Yarn 4.x 使用 YAML 格式的配置文件：

```yaml
# npm 注册表
npmRegistryServer: "https://registry.npmjs.org"

# 启用全局缓存
enableGlobalCache: false

# Node.js 链接器
# node-modules: 传统模式，创建 node_modules
# pnp: Plug'n'Play 模式
nodeLinker: node-modules

# 启用生命周期脚本
enableScripts: true

# 启用全局补丁
enableGlobalPatches: false

# 安装模式
# production: 只安装 dependencies
# development: 安装所有依赖
# skip-build: 跳过构建脚本
# update-lockfile: 只更新锁文件
mode: development

# 不安全的 HTTP 白名单
unsafeHttpWhitelist:
  - localhost
  - "*.internal.company.com"

# 压缩已安装的包
compressionLevel: 6
```

### 环境变量

可以通过环境变量覆盖配置：

```bash
# 设置注册表
YARN_NPM_REGISTRY_SERVER=https://registry.npmmirror.com yarn install

# 禁用脚本
YARN_ENABLE_SCRIPTS=0 yarn install
```

---

## 高级功能

### Zero-Installs（零安装）

Zero-Installs 让你跳过安装步骤，克隆项目后立即可用。

**配置**：

```yaml
# .yarnrc.yml
enableGlobalCache: false
```

**验证**：

```bash
# 验证项目
yarn install --immutable --immutable-cache
```

### 硬化模式

防止意外修改锁文件：

```bash
yarn install --immutable
```

### 离线模式

```bash
# 使用缓存安装
yarn install --offline

# 偏好缓存，没有则网络获取
yarn install --prefer-offline
```

### 诊断问题

```bash
# 诊断配置问题
yarn doctor
```

---

## 常用命令速查表

### 依赖管理

| 命令 | 说明 |
|------|------|
| yarn init | 初始化项目 |
| yarn install | 安装依赖 |
| yarn add \<pkg\> | 添加依赖 |
| yarn add -D \<pkg\> | 添加开发依赖 |
| yarn add -E \<pkg\> | 精确版本 |
| yarn remove \<pkg\> | 移除依赖 |
| yarn up \<pkg\> | 更新依赖 |
| yarn up --all | 更新所有 |

### 信息查看

| 命令 | 说明 |
|------|------|
| yarn list | 列出依赖 |
| yarn list --level=0 | 顶层依赖 |
| yarn outdated | 过时依赖 |
| yarn info \<pkg\> | 包信息 |
| yarn why \<pkg\> | 依赖原因 |

### 脚本运行

| 命令 | 说明 |
|------|------|
| yarn run \<script\> | 运行脚本 |
| yarn dev | 运行 dev 脚本 |
| yarn build | 运行 build 脚本 |
| yarn test | 运行 test 脚本 |

### 缓存管理

| 命令 | 说明 |
|------|------|
| yarn cache dir | 缓存目录 |
| yarn cache list | 列出缓存 |
| yarn cache clean | 清理缓存 |

### 工作区

| 命令 | 说明 |
|------|------|
| yarn workspace \<name\> add | 添加到工作区 |
| yarn workspace \<name\> run | 工作区运行脚本 |
| yarn workspaces foreach | 所有工作区运行 |
| yarn workspaces list | 列出工作区 |

---

## 最佳实践

### 开发工作流

1. **每日更新**：定期运行 yarn up 保持依赖更新
2. **发布前检查**：运行 yarn install --immutable 确保锁文件正确
3. **清理缓存**：定期 yarn cache clean 释放空间

### CI/CD 集成

```bash
# 在 CI 中使用硬化模式
yarn install --immutable

# 或使用 Zero-Installs
yarn install --immutable --immutable-cache
```

### 安全最佳实践

1. 定期运行安全审计：yarn npm audit
2. 使用私有注册表处理敏感依赖
3. 审查第三方插件来源

---

## 常见问题

### 如何处理依赖冲突？

Yarn 会自动解决依赖冲突。如果遇到问题：

```bash
# 查看依赖树
yarn list

# 查找冲突来源
yarn why lodash
```

### peerDependencies 警告？

这是正常的。确保安装相应的对等依赖：

```bash
yarn add -P react
```

---

## 相关资源

- [常见问题解答](./4.常见问题.md)
- [官方文档](https://yarnpkg.com/docs)
- [CLI 参考](https://yarnpkg.com/cli)
- [配置参考](https://yarnpkg.com/configuration)
