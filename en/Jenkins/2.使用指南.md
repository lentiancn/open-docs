# Jenkins 使用指南

本指南介绍如何使用 Jenkins 实现持续集成和持续部署。

## 快速开始

### 创建第一个任务

1. 点击"新建 Item"
2. 输入任务名称
3. 选择"自由风格项目"
4. 配置源码管理（Git）
5. 配置构建触发器
6. 配置构建步骤
7. 保存并构建

## 任务类型

### 自由风格项目

```groovy
// 构建步骤示例
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/example/repo.git'
            }
        }
        stage('Build') {
            steps {
                sh 'npm install'
                sh 'npm test'
            }
        }
        stage('Deploy') {
            steps {
                sh 'npm run deploy'
            }
        }
    }
}
```

### Pipeline 项目

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        APP_NAME = 'my-app'
    }
    
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'npm install'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing...'
                sh 'npm test'
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying...'
            }
        }
    }
    
    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            echo 'Build succeeded!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
```

## 常用插件

### Git 插件

```groovy
git branch: 'main',
    credentialsId: 'github-credentials',
    url: 'https://github.com/example/repo.git'
```

### Docker 插件

```groovy
docker.build('my-app:latest')
```

### Maven 插件

```groovy
mvn clean package
```

## 构建触发器

### 定时构建

```groovy
// 每小时构建一次
cron('H * * * *')

// 每天午夜构建
cron('H 0 * * *')
```

### 轮询 SCM

```groovy
pollScm('H * * * *')
```

### Webhook 触发

1. 安装 "Generic Webhook Trigger" 插件
2. 配置任务触发器
3. 在 GitHub/GitLab 配置 Webhook

## 环境变量

### 内置变量

```groovy
echo "当前构建: ${BUILD_NUMBER}"
echo "工作目录: ${WORKSPACE}"
echo "GIT_BRANCH: ${GIT_BRANCH}"
```

### 自定义变量

```groovy
environment {
    APP_VERSION = '1.0.0'
    DEPLOY_ENV = 'production'
}
```

## 凭证管理

### 添加凭证

1. 进入 "Manage Jenkins" → "Manage Credentials"
2. 添加凭证：
   - Username with password
   - SSH Username with private key
   - Secret file

### 使用凭证

```groovy
withCredentials([usernamePassword(credentialsId: 'my-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
    sh 'echo $USER:$PASS'
}
```

## 分布式构建

### 配置代理节点

1. 进入 "Manage Jenkins" → "Manage Nodes"
2. 添加新节点
3. 配置连接信息

### 使用标签

```groovy
pipeline {
    agent {
        label 'docker'
    }
    // 构建步骤
}
```

## 通知

### 邮件通知

```groovy
emailext (
    subject: "构建通知: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
    body: "构建状态: ${currentBuild.result}",
    to: 'team@example.com'
)
```

### 钉钉通知

1. 安装 "DingTalk" 插件
2. 配置机器人
3. 添加通知步骤

## 备份和恢复

### 备份

```bash
# 备份 JENKINS_HOME
tar -czvf jenkins-backup.tar.gz $JENKINS_HOME
```

### 恢复

```bash
# 停止 Jenkins
# 解压备份
tar -xzvf jenkins-backup.tar.gz -C $JENKINS_HOME
# 重启 Jenkins
```

## 最佳实践

### 1. 使用 Pipeline

```groovy
// 推荐使用声明式 Pipeline
pipeline {
    // 定义整个流程
}
```

### 2. 参数化构建

```groovy
parameters {
    choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: '部署环境')
    string(name: 'VERSION', defaultValue: '', description: '版本号')
}
```

### 3. 清理工作区

```groovy
post {
    always {
        cleanWs()
    }
}
```

## 相关资源

- [Jenkins 官方文档](https://www.jenkins.io/doc/)
- [Pipeline 语法](https://www.jenkins.io/doc/book/pipeline/syntax/)
