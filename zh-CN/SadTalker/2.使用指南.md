# SadTalker 使用指南

SadTalker 使用深度学习从单张图像和音频输入生成逼真的说话头像视频。

## 快速开始

### 基本命令

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### 带增强功能

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## 命令参数

### 输入参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--source_image` | 输入肖像图片路径 | 必需 |
| `--driven_audio` | 输入音频文件路径 (WAV/MP3) | 必需 |
| `--result_dir` | 输出目录 | ./results |

### 处理参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--preprocess` | 图像预处理：crop, resize, full | full |
| `--size` | 图像大小：256, 512 | 256 |
| `--pose_style` | 姿势风格 0-45 | 0 |
| `--expression_scale` | 表情强度 0.5-1.5 | 1.0 |

### 增强参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--enhancer` | 人脸增强器：gfpgan, RestoreFormer, CodeFormer | None |

### 性能参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--batch_size` | 批处理大小 | 1 |
| `--fps` | 输出视频帧率 | 25 |

## 使用示例

### 示例 1：基本生成

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### 示例 2：GFPGAN 增强

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### 示例 3：自定义姿势

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### 示例 4：更高分辨率

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### 基本用法

```python
from inference import SadTalker

# 初始化 SadTalker
sadtalker = SadTalker()

# 生成视频
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"视频保存至: {video_path}")
```

### 高级用法

```python
from inference import SadTalker
import torch

# 使用自定义设置初始化
sadtalker = SadTalker(
    checkpoint_path="checkpoints/SadTalker.pth",
    config_path="config/SadTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# 生成带高级选项的视频
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### 批量处理

```python
from inference import SadTalker
import os

sadtalker = SadTalker()

# 处理多张图片（同一音频）
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        sadtalker.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Web 界面

### 运行 Web 演示

```bash
python app.py
```

然后在浏览器中打开 http://localhost:8888

### Web 界面功能

1. **图像上传**：拖放或选择肖像图片
2. **音频上传**：选择音频文件（WAV/MP3）
3. **预览**：预览源图像和音频
4. **参数调整**：调整姿势、表情、增强器
5. **生成**：一键生成视频
6. **下载**：保存生成的视频

## 人脸增强器

### 可用增强器

| 增强器 | 质量 | 速度 | 显存 |
|--------|------|------|-------|
| 无 | 基础 | 快 | 低 |
| gfpgan | 良好 | 中等 | 中等 |
| RestoreFormer | 非常好 | 慢 | 高 |
| CodeFormer | 非常好 | 慢 | 高 |

### 建议

- **低显存**：无增强器或 gfpgan
- **平衡**：gfpgan
- **最佳质量**：RestoreFormer 或 CodeFormer

## 预处理模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| crop | 居中裁剪人脸 | 快速处理 |
| resize | 调整为目标大小 | 简单背景 |
| full | 完整处理流程 | 最佳效果 |

## 输入要求

### 图像要求

- 格式：JPG、PNG
- 分辨率：建议 512x512 或更大
- 人脸：正面、无遮挡
- 背景：简单最好

### 音频要求

- 格式：WAV、MP3
- 时长：1-60 秒
- 采样率：16000-48000 Hz
- 语音：清晰、最小噪音

## 输出

### 视频格式

- 格式：MP4
- 编解码器：H.264
- 分辨率：256x256 或 512x512
- 帧率：25
- 比特率：2-5 Mbps

### 输出目录

结果保存在指定的输出目录：
```
results/
├── video.mp4          # 生成的视频
└── (临时文件)
```

## 故障排除

### 视频过暗/过亮

**原因：** 训练和输入之间的光照不匹配

**解决方案：**
- 调整 expression_scale 参数 (0.8-1.2)
- 使用更高质量的源图像
- 尝试不同的增强器

### 嘴唇不同步

**原因：** 音频质量或对齐问题

**解决方案：**
- 使用高质量音频
- 确保音频有清晰的语音
- 检查音视频同步

### 脸部变形

**原因：** 输入质量低或不寻常

**解决方案：**
- 使用更高分辨率图像 (512)
- 尝试不同的预处理模式
- 使用人脸增强器
- 确保脸部清晰可见

### 处理缓慢

**解决方案：**
- 使用 `--preprocess crop`
- 设置 `--size 256`
- 禁用增强器
- 减小批次大小

### GPU 内存不足

**解决方案：**
- 将 batch_size 减小到 1
- 使用更小的图像大小
- 关闭其他 GPU 应用程序

## 性能提示

### 更快的处理

1. 使用 `--preprocess crop`
2. 设置 `--size 256`
3. 禁用增强器

### 更好的质量

1. 使用 `--size 512`
2. 启用 `--enhancer gfpgan`
3. 使用 `--preprocess full`

## 相关链接

- [GitHub](https://github.com/OpenTalker/SadTalker)
- [HuggingFace](https://huggingface.co/spaces/fffilo/SadTalker)
- [论文](https://arxiv.org/abs/2303.17550)
- [模型](https://github.com/OpenTalker/SadTalker/releases)
