# Apache APISIX 常见问题

## 基础问题

### 1. 什么是 Apache APISIX？

Apache APISIX 是一个云原生 API 网关，由 Apache 软件基金会管理。它提供动态、实时、高性能的 API 流量管理功能，包括负载均衡、动态路由、身份验证、限流、监控等。

### 2. APISIX 和 Nginx 有什么区别？

Nginx 是一个传统的 Web 服务器和反向代理，而 APISIX 是构建在 Nginx 之上的 API 网关。

主要区别：
- **配置方式**：Nginx 需要修改配置文件并重启，APISIX 支持热更新无需重启
- **功能扩展**：APISIX 提供丰富的内置插件，Nginx 需要自己编写模块
- **动态能力**：APISIX 原生支持动态路由、动态上游等能力
- **可观测性**：APISIX 内置 Prometheus、SkyWalking 等监控集成

### 3. APISIX 需要哪些依赖？

APISIX 主要依赖：
- **etcd**：用于存储配置数据，实现集群间的配置同步
- **Lua**：APISIX 使用 Lua 编写插件逻辑
- **Nginx**：底层使用 Nginx 处理 HTTP 请求

如果使用 Docker 方式安装，这些依赖都会被自动配置好。

### 4. APISIX 的性能如何？

APISIX 的性能非常高，单核 QPS 可达 18,000 次，平均延迟小于 0.2 毫秒。这得益于：
- Nginx 的高性能 HTTP 处理能力
- LuaJIT 的即时编译
- 优雅的架构设计

### 5. APISIX 支持哪些平台？

APISIX 支持多种平台：
- Linux（Ubuntu、CentOS、Debian 等）
- macOS
- Windows（通过 WSL 或 Docker）
- Kubernetes（通过 Helm 或 Operator）

## 安装问题

### 6. 快速启动脚本安装失败怎么办？

常见原因和解决方法：

1. **Docker 未启动**
   ```bash
   # 启动 Docker
   sudo systemctl start docker
   ```

2. **端口被占用**
   ```bash
   # 检查端口占用
   lsof -i :9080
   
   # 停止占用端口的进程，或修改 APISIX 配置使用其他端口
   ```

3. **网络问题**
   ```bash
   # 检查 Docker 网络
   docker network ls
   
   # 尝试手动拉取镜像
   docker pull apache/apisix:3.3.0
   docker pull apache/apisix/etcdserve:v3.5.0
   ```

### 7. 如何修改 APISIX 端口？

修改 Docker Compose 配置：

```yaml
services:
  apisix:
    ports:
      - "9081:9080"  # 主机端口:容器端口
      - "9444:9443"
      - "9181:9180"
```

或者修改 `config.yaml` 配置文件：

```yaml
deployment:
  listen:
    ip: "0.0.0.0"
    port: 9081
```

### 8. etcd 启动失败怎么解决？

常见原因：

1. **数据目录权限问题**
   ```bash
   sudo chown -R etcd:etcd /var/lib/etcd
   ```

2. **端口冲突**
   ```bash
   lsof -i :2379
   ```

3. **磁盘空间不足**
   ```bash
   df -h
   # 清理不必要的文件
   ```

### 9. 如何升级 APISIX？

Docker 方式：
```bash
# 拉取新版本镜像
docker pull apache/apisix:3.4.0

# 停止旧容器
docker stop apisix

# 使用新镜像启动
docker run -d apache/apisix:3.4.0 ...
```

注意：升级前请备份配置数据。

## 配置问题

### 10. 如何修改 Admin API Key？

编辑 `config.yaml` 配置文件：

```yaml
deployment:
  admin:
    admin_key:
      - name: "admin"
        key: "your-new-secret-key"
        role: "admin"
```

修改后需要重启 APISIX。

### 11. 如何启用 HTTPS？

APISIX 支持两种方式启用 HTTPS：

1. **手动配置 SSL 证书**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/ssl" -X PUT -d '
   {
     "id": "ssl-1",
     "cert": "-----BEGIN CERTIFICATE-----\n...",
     "key": "-----BEGIN PRIVATE KEY-----\n...",
     "snis": ["example.com"]
   }'
   ```

2. **使用 Let's Encrypt 自动签发**
   ```bash
   # 启用 acme 插件
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "acme": {
         "account_email": "your@email.com"
       }
     }
   }'
   ```

### 12. 如何配置多个域名？

在创建路由时使用 `hosts` 字段：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "multi-domain",
  "hosts": ["example.com", "api.example.com"],
  "uri": "/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### 13. 如何实现请求重定向？

使用 `redirect` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "redirect-route",
  "uri": "/old-path",
  "plugins": {
    "redirect": {
      "uri": "/new-path",
      "http_status": 301
    }
  }
}'
```

## 功能问题

### 14. 如何实现灰度发布？

有两种方式：

1. **基于权重的灰度发布**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "traffic-split": {
         "rules": [
           {
             "weighted_upstream": [
               {"upstream": {"name": "v1", "nodes": {"v1:8080": 100}}, "weight": 90},
               {"upstream": {"name": "v2", "nodes": {"v2:8080": 100}}, "weight": 10}
             ]
           }
         ]
       }
     }
   }'
   ```

2. **基于请求属性的灰度发布**
   使用 `vars` 条件匹配，如根据 Header、Cookie、参数等分配到不同上游。

### 15. 如何实现熔断？

APISIX 内置熔断功能，通过健康检查实现：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"backend:8080": 1},
    "checks": {
      "passive": {
        "healthy": {"successes": 3},
        "unhealthy": {"http_failures": 3}
      }
    }
  }
}'
```

### 16. 如何实现跨域请求？

使用 `cors` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "cors": {
      "allow_origins": "*",
      "allow_methods": "GET,POST,PUT,DELETE",
      "allow_headers": "*"
    }
  }
}'
```

### 17. 如何实现请求限流？

```bash
# 基于请求数量限流
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 429
    }
  }
}'
```

### 18. 如何使用消费者进行身份验证？

1. 创建消费者：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
   {
     "username": "user1",
     "plugins": {
       "key-auth": {"key": "key-1"}
     }
   }'
   ```

2. 在路由上启用验证：
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {"key-auth": {}}
   }'
   ```

3. 客户端请求时携带密钥：
   ```bash
   curl "http://127.0.0.1:9080/api" -H "apikey: key-1"
   ```

## 监控问题

### 19. 如何集成 Prometheus？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  }
}'
```

访问指标：
```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### 20. 如何配置日志发送？

支持多种日志输出：

```bash
# HTTP 日志
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  }
}'

# Kafka 日志
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "kafka-logger": {
      "brokers": [{"host": "kafka", "port": 9092}],
      "topic": "apisix-logs"
    }
  }
}'
```

### 21. 如何使用 SkyWalking 追踪？

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "skywalking": {
      "endpoint_addr": "http://skywalking:11800",
      "service_name": "apisix",
      "sample_ratio": 1
    }
  }
}'
```

## 集群问题

### 22. 如何搭建 APISIX 集群？

APISIX 节点是无状态的，只需要：

1. 部署多个 APISIX 节点
2. 配置所有节点连接同一个 etcd 集群
3. 使用负载均衡器（如 Nginx、HAProxy）分发流量

```yaml
# config.yaml
deployment:
  etcd:
    host:
      - "http://etcd1:2379"
      - "http://etcd2:2379"
      - "http://etcd3:2379"
```

### 23. 如何保证 etcd 的高可用？

etcd 支持集群模式部署：

```bash
# 启动 etcd 集群
etcd --name infra1 --initial-advertise-peer-urls http://localhost:2380 \
  --listen-peer-urls http://localhost:2380 \
  --initial-cluster infra1=http://localhost:2380,...
```

生产环境建议至少部署 3 个 etcd 节点。

### 24. 如何迁移 APISIX 配置？

1. 导出配置：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx" > routes.json
   ```

2. 导入到新集群：
   ```bash
   # 逐条导入或使用批量导入工具
   ```

## 安全问题

### 25. 生产环境有哪些安全建议？

1. **修改默认 API Key**
   ```yaml
   deployment:
     admin:
       admin_key:
         - key: "your-secure-key"
   ```

2. **限制 Admin API 访问**
   ```yaml
   deployment:
     admin:
       allow_access: ["127.0.0.1", "10.0.0.0/8"]
   ```

3. **启用 HTTPS**

4. **配置防火墙规则**

5. **定期更新版本**

### 26. 如何防止 API 被恶意访问？

1. **启用 IP 黑名单**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "ip-restriction": {
         "deny": ["1.2.3.4"]
       }
     }
   }'
   ```

2. **启用请求验证**
   ```bash
   curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
   {
     "uri": "/api/*",
     "plugins": {
       "request-validation": {
         "body_schema": {
           "type": "object",
           "required": ["name"],
           "properties": {"name": {"type": "string"}}
         }
       }
     }
   }'
   ```

3. **启用 CSRF 防护**

## 调试问题

### 27. 如何查看 APISIX 日志？

Docker 方式：
```bash
docker logs apisix
```

查看错误日志：
```bash
tail -f logs/error.log
```

### 28. 如何调试路由匹配？

使用 `debug` 插件：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/plugin_metadata/debug" -X PUT -d '
{
  "headers": ["X-Request-ID"]
}'
```

### 29. 请求返回 404 怎么办？

1. 检查路由是否正确创建：
   ```bash
   curl "http://127.0.0.1:9180/apisix/admin/routes" \
     -H "X-API-KEY: xxx"
   ```

2. 检查 URI 是否匹配：
   - 确保请求路径与路由配置一致
   - 注意前缀匹配和精确匹配的区别

3. 检查上游服务是否可达：
   ```bash
   curl -v http://backend:8080/health
   ```

### 30. 请求返回 503 怎么办？

通常是上游服务不可用：

1. 检查上游节点是否运行
2. 检查网络连通性
3. 检查健康检查配置是否过于严格

## 更多帮助

如果遇到本文未涵盖的问题，可以参考以下资源：

- 官方文档：https://apisix.apache.org/docs/
- GitHub：https://github.com/apache/apisix
- 社区论坛：https://github.com/apache/apisix/discussions
- Slack：https://apisix.apache.org/slack
