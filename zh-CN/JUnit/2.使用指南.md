# JUnit 使用指南

本指南介绍如何使用 JUnit 5 编写有效的单元测试。

## 基本测试结构

### 简单测试类

```java
package com.example;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class MyFirstTest {
    
    @Test
    void simpleTest() {
        // 安排 - 设置测试数据
        int a = 1;
        int b = 2;
        
        // 执行 - 执行操作
        int result = a + b;
        
        // 断言 - 验证结果
        assertEquals(3, result);
    }
}
```

## 断言

JUnit 5 在 `org.junit.jupiter.api.Assertions` 中提供了全面的断言 API。

### 常用断言

```java
import static org.junit.jupiter.api.Assertions.*;

// 相等断言
@Test
void equalityTests() {
    assertEquals(expected, actual);
    assertEquals(expected, actual, "消息");
    assertEquals(0.01, 3.5, 0.1);  // 浮点数精度
    
    assertNotEquals(expected, actual);
}

// 布尔断言
@Test
void booleanTests() {
    assertTrue(condition);
    assertFalse(condition);
}

// 空断言
@Test
void nullTests() {
    assertNull(object);
    assertNotNull(object);
    
    // 身份
    assertSame(obj1, obj2);
    assertNotSame(obj1, obj2);
}

// 数组断言
@Test
void arrayTests() {
    assertArrayEquals(expectedArray, actualArray);
}

// 异常断言
@Test
void exceptionTests() {
    // 断言抛出异常
    assertThrows(RuntimeException.class, () -> {
        throw new RuntimeException("测试异常");
    });
    
    // 组合断言
    assertAll("用户验证",
        () -> assertNotNull(user),
        () -> assertEquals("John", user.getName()),
        () -> assertTrue(user.getAge() >= 18)
    );
}
```

## 测试生命周期

### Before 和 After 方法

```java
class LifecycleTest {
    
    @BeforeAll
    static void beforeAll() {
        // 所有测试方法之前运行一次
        // 在常规类中必须是 static
    }
    
    @AfterAll
    static void afterAll() {
        // 所有测试方法之后运行一次
    }
    
    @BeforeEach
    void beforeEach() {
        // 每个测试方法之前运行
    }
    
    @AfterEach
    void afterEach() {
        // 每个测试方法之后运行
    }
}
```

## 嵌套测试

```java
@Nested
class NestedTests {
    
    @Test
    void parentTest() {
        assertTrue(true);
    }
    
    @Nested
    class InnerClass {
        
        @Test
        void innerTest() {
            assertTrue(true);
        }
    }
}
```

## 参数化测试

### Value Source

```java
@ParameterizedTest
@ValueSource(ints = {1, 2, 3, 4, 5})
void isEven(int number) {
    assertTrue(number % 2 == 0);
}

@ParameterizedTest
@ValueSource(strings = {"Hello", "World", "JUnit"})
void stringTests(String value) {
    assertNotNull(value);
}
```

### CSV Source

```java
@ParameterizedTest
@CsvSource({
    "1, 1, 2",
    "2, 3, 5",
    "10, 20, 30"
})
void addTest(int a, int b, int expected) {
    Calculator calc = new Calculator();
    assertEquals(expected, calc.add(a, b));
}
```

### Method Source

```java
@ParameterizedTest
@MethodSource("provideArguments")
void methodSourceTest(String arg1, int arg2, boolean expected) {
    assertEquals(expected, arg1.length() == arg2);
}

static Stream<Arguments> provideArguments() {
    return Stream.of(
        Arguments.of("test", 4, true),
        Arguments.of("hello", 5, true)
    );
}
```

## 使用 Mockito 进行模拟

### 基本 Mockito

```java
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testGetUserById() {
        // 安排
        User mockUser = new User(1L, "John");
        when(userRepository.findById(1L)).thenReturn(Optional.of(mockUser));
        
        // 执行
        User result = userService.getUserById(1L);
        
        // 断言
        assertNotNull(result);
        assertEquals("John", result.getName());
        verify(userRepository).findById(1L);
    }
}
```

## Spring Boot 测试

### 单元测试

```java
@SpringBootTest
class MyServiceIntegrationTest {
    
    @Autowired
    private MyService myService;
    
    @Test
    void testService() {
        String result = myService.doSomething();
        assertNotNull(result);
    }
}
```

### Web 层测试

```java
@WebMvcTest(MyController.class)
class MyControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private MyService myService;
    
    @Test
    void testEndpoint() throws Exception {
        when(myService.getData()).thenReturn("test data");
        
        mockMvc.perform(get("/api/data"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$").value("test data"));
    }
}
```

## 运行测试

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=MyTest

# 运行特定测试方法
mvn test -Dtest=MyTest#myMethod

# 使用 Gradle
./gradlew test
```

## 最佳实践

### 测试命名

```java
// 好 - 描述场景
@Test
void shouldReturnUserWhenValidIdProvided() {}

// 不好 - 不清晰
@Test
void test1() {}
```

### 测试结构

```java
@Test
void shouldThrowExceptionWhenInvalidInput() {
    // 安排
    Validator validator = new Validator();
    
    // 执行和断言
    assertThrows(IllegalArgumentException.class, () -> {
        validator.validate(null);
    });
}
```

### 避免测试相互依赖

```java
// 好 - 独立测试
@Test
void testAdd() {
    Calculator calc = new Calculator();
    assertEquals(5, calc.add(2, 3));
}

@Test
void testSubtract() {
    Calculator calc = new Calculator();
    assertEquals(1, calc.subtract(3, 2));
}
```

## 相关链接

- [JUnit 5 官方文档](https://junit.org/junit5/docs/current/user/)
- [Mockito 文档](https://site.mockito.org)
- [AssertJ 文档](https://assertj.github.io)
- [Spring 测试文档](https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html)
