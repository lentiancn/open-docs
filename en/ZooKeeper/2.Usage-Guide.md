# ZooKeeper Usage Guide

Comprehensive guide for using ZooKeeper effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [ZooKeeper CLI](#zookeeper-cli)
- [Znode Operations](#znode-operations)
- [ACL (Access Control)](#acl-access-control)
- [Watches](#watches)
- [Programming with ZooKeeper](#programming-with-zookeeper)
- [Monitoring](#monitoring)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

---

## Basic Concepts

### What is ZooKeeper?

ZooKeeper is a centralized service for maintaining configuration information, naming, and providing distributed synchronization.

### Key Terms

| Term | Description |
|------|-------------|
| **Znode** | Data node in ZooKeeper (like files) |
| **Ephemeral** | Temporary znode (deleted on disconnect) |
| **Sequential** | Znode with auto-incrementing suffix |
| **Watch** | One-time notification of changes |
| **ACL** | Access Control List |

### Znode Types

| Type | Description |
|------|-------------|
| **Persistent** | Exists until explicitly deleted |
| **Ephemeral** | Deleted when client disconnects |
| **Sequential** | Auto-incrementing sequence number |

---

## ZooKeeper CLI

### Connect to ZooKeeper

```bash
# Local
zkCli.sh -server localhost:2181

# Remote
zkCli.sh -server zoo1:2181

# Docker
docker exec -it zookeeper zkCli.sh
```

### CLI Commands

```bash
help                    # Show help
ls /                   # List root znodes
ls2 /                  # List with stats
create /path data      # Create znode
get /path              # Get data
set /path data         # Set data
delete /path           # Delete znode
stat /path             # Get znode stats
```

---

## Znode Operations

### Create Znode

```bash
# Persistent znode
create /mypath "mydata"

# Ephemeral znode (deleted on disconnect)
create -e /ephemeral "temp"

# Sequential znode
create -s /seq 0

# Create with ACL
create /protected "data" world:anyone:r
```

### Read Data

```bash
# Get data and stat
get /mypath

# Get children
ls /mypath

# Get all children recursively
ls -R /
```

### Update Data

```bash
# Set data
set /mypath "newdata"

# Set with version (optimistic locking)
set /mypath "newdata" 1
```

### Delete Znode

```bash
# Delete
delete /mypath

# Delete with version
delete /mypath 1

# Delete recursively
deleteall /parent
```

---

## ACL (Access Control)

### ACL Permissions

| Permission | Description |
|------------|-------------|
| **c** | CREATE - can create children |
| **r** | READ - can read data |
| **w** | WRITE - can write data |
| **d** | DELETE - can delete children |
| **a** | ADMIN - can set ACL |

### ACL Schemes

```bash
# World (anyone)
setAcl /path world:anyone:cdrwa

# Auth (authenticated users)
setAcl /path auth:user:password:cdrwa

# Digest (username:password)
setAcl /path digest username:password:cdrwa

# IP (by IP address)
setAcl /path ip:192.168.1.1:cdrwa
```

### Examples

```bash
# Read-only
create /readonly "" world:anyone:r

# Admin only
create /admin "" auth:admin:secret:cdrwa
```

---

## Watches

### Set Watch

```bash
# Watch for changes
get /path watch

# Watch for children
ls /path watch
```

### Watch Events

| Event | Description |
|-------|-------------|
| NodeCreated | Znode created |
| NodeDeleted | Znode deleted |
| NodeDataChanged | Data changed |
| NodeChildrenChanged | Children changed |

---

## Programming with ZooKeeper

### Java Example

```java
import org.apache.zookeeper.*;

public class ZKExample {
    private static final String CONNECT = "localhost:2181";
    private static final int TIMEOUT = 3000;

    public static void main(String[] args) throws Exception {
        ZooKeeper zk = new ZooKeeper(CONNECT, TIMEOUT, watchedEvent -> {
            System.out.println("Event: " + watchedEvent.getType());
        });

        // Create
        zk.create("/mypath", "data".getBytes(),
                  ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);

        // Read
        byte[] data = zk.getData("/mypath", false, null);
        System.out.println(new String(data));

        // Update
        zk.setData("/mypath", "newdata".getBytes(), -1);

        // Delete
        zk.delete("/mypath", -1);

        zk.close();
    }
}
```

### Python Example (kazoo)

```python
from kazoo.client import KazooClient

zk = KazooClient(hosts='localhost:2181')
zk.start()

# Create
zk.create('/mypath', b'data', ephemeral=True, sequence=True)

# Read
data, stat = zk.get('/mypath')
print(data)

# Update
zk.set('/mypath', b'newdata')

# Delete
zk.delete('/mypath', recursive=True)

zk.stop()
```

### Go Example

```go
package main

import (
    "github.com/go-zookeeper/zk"
)

func main() {
    conn, _, _ := zk.Connect([]string{"localhost:2181"}, time.Second)
    defer conn.Close()

    // Create
    conn.Create("/mypath", []byte("data"), 0, zk.WorldACL(zk.PermAll))

    // Read
    data, _, _ := conn.Get("/mypath")
    println(string(data))

    // Update
    conn.Set("/mypath", []byte("newdata"), -1)

    // Delete
    conn.Delete("/mypath", -1)
}
```

---

## Monitoring

### Four Letter Words

```bash
# Server status
echo ruok | nc localhost 2181

# Server statistics
echo stat | nc localhost 2181

# Server configuration
echo conf | nc localhost 2181

# Environment
echo envi | nc localhost 2181

# List connections
echo cons | nc localhost 2181
```

### Admin Server

```bash
# Access admin interface
http://localhost:8080/commands
```

### Commands

| Command | Description |
|--------|-------------|
| ruok | Server status (returns "imok") |
| stat | Server statistics |
| conf | Server configuration |
| envi | Environment |
| cons | Client connections |
| mntr | Monitoring stats |

---

## Best Practices

### Znode Design

1. **Use Consistent Naming**
   ```
   /service/component/node
   /config/service/key
   /locks/lockname
   ```

2. **Avoid Deep Hierarchy**
   - Keep depth under 5 levels
   - Flat is often better

3. **Use Ephemeral for Service Discovery**
   ```bash
   create -e /services/myapp/server1 "host1:port1"
   ```

### Configuration

1. **Use Odd Number of Servers**
   - Minimum 3 for production
   - 5 is common for production

2. **Separate Data and Log Directories**
   ```properties
   dataDir=/var/lib/zookeeper
   dataLogDir=/var/log/zookeeper
   ```

3. **Set Appropriate Timeouts**
   ```properties
   tickTime=2000
   initLimit=10
   syncLimit=5
   ```

### Security

1. **Enable Authentication**
   ```properties
   authProvider.1=org.apache.zookeeper.server.auth.DigestAuthenticationProvider
   ```

2. **Use ACLs**
   ```bash
   setAcl /sensitive auth:user:pass:cdrwa
   ```

3. **Enable TLS**
   - Use TLS for client connections in production

---

## Troubleshooting

### Common Issues

#### Cannot Connect to Server

```bash
# Check if server is running
jps | grep ZooKeeper

# Check port
netstat -an | grep 2181

# Check firewall
sudo firewall-cmd --list-ports
```

#### Leader Election Issues

```bash
# Check logs
tail -f $ZOOKEEPER_HOME/logs/zookeeper.out

# Verify myid files
cat /var/lib/zookeeper/myid

# Check server IDs in config
grep server. /opt/zookeeper/conf/zoo.cfg
```

#### Data Inconsistency

```bash
# Check for leader
echo stat | nc localhost 2181

# Sync follower
echo sync | nc localhost 2181
```

### Reset ZooKeeper

```bash
# Stop all servers
zkServer.sh stop

# Clear data directory
rm -rf /var/lib/zookeeper/*

# Restart
zkServer.sh start
```

---

## Quick Reference

### Common Commands

```bash
zkCli.sh -server localhost:2181  # Connect
ls /                              # List
create /path data                # Create
get /path                        # Read
set /path data                   # Update
delete /path                     # Delete
stat /path                       # Stats
```

### Docker Commands

```bash
docker run -d --name zookeeper -p 2181:2181 confluentinc/cp-zookeeper
docker exec -it zookeeper zkCli.sh
docker logs -f zookeeper
```

---

## Next Steps

- Explore [ZooKeeper Recipes](https://zookeeper.apache.org/doc/current/recipes.html)
- Learn about [ZooKeeper Internals](https://zookeeper.apache.org/doc/current/zookeeperInternals.html)
