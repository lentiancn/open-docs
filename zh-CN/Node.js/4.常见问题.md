# Node.js 常见问题

本章节汇总了 Node.js 开发中的常见问题。

## 安装问题

### Q1: node 命令找不到

**问题描述：**
安装 Node.js 后，终端输入 `node` 提示命令找不到。

**解决方案：**
- Windows：检查环境变量 PATH 是否包含 Node.js 安装目录
- Linux/macOS：使用 `source ~/.bashrc` 刷新配置
- 使用 nvm 管理版本

### Q2: npm 安装失败

**解决方案：**
```bash
# 清理缓存
npm cache clean --force

# 配置镜像
npm config set registry https://registry.npmmirror.com
```

### Q3: 版本冲突

**解决方案：**
使用 nvm 管理多个版本：
```bash
nvm install 20
nvm install 18
nvm use 20
```

## 开发问题

### Q4: 模块找不到

**问题描述：**
`Error: Cannot find module 'xxx'`

**解决方案：**
1. 检查模块是否已安装
   ```bash
   npm list express
   ```

2. 重新安装
   ```bash
   npm install
   ```

3. 检查路径是否正确

### Q5: 异步回调地狱

**问题描述：**
多层嵌套的回调函数，代码难以维护。

**解决方案：**
使用 Promise 或 async/await：
```javascript
// 之前
fs.readFile('file1', (err, data) => {
  fs.readFile('file2', (err, data) => {
    fs.readFile('file3', (err, data) => {
      // ...
    });
  });
});

// 之后
async function readFiles() {
  const file1 = await fs.promises.readFile('file1', 'utf8');
  const file2 = await fs.promises.readFile('file2', 'utf8');
  const file3 = await fs.promises.readFile('file3', 'utf8');
}
```

### Q6: 事件循环阻塞

**问题描述：**
Node.js 应用响应缓慢。

**解决方案：**
1. 将耗时操作拆分为小任务
   ```javascript
   // 使用 setImmediate
   function processLargeData(data) {
     const chunk = data.splice(0, 1000);
     processChunk(chunk);
     
     if (data.length > 0) {
       setImmediate(() => processLargeData(data));
     }
   }
   ```

2. 使用 Worker Threads

### Q7: 内存泄漏

**问题描述：**
应用运行一段时间后内存持续增长。

**解决方案：**
1. 使用 heapdump 分析内存
   ```javascript
   const heapdump = require('heapdump');
   heapdump.writeSnapshot();
   ```

2. 检查全局变量和闭包

3. 及时清理定时器

### Q8: 路径问题

**问题描述：**
路径拼接或解析错误。

**解决方案：**
使用 path 模块：
```javascript
const path = require('path');
const fullPath = path.join(__dirname, 'dir', 'file.txt');
```

## HTTP 问题

### Q9: 端口被占用

**问题描述：**
`Error: listen EADDRINUSE: address already in use`

**解决方案：**
```bash
# 查找占用端口的进程
netstat -ano | findstr :3000

# Windows 结束进程
taskkill /PID <PID> /F

# Linux/macOS
kill -9 <PID>
```

### Q10: 请求超时

**解决方案：**
```javascript
const axios = require('axios');

axios.get('/api', {
  timeout: 5000 // 5秒超时
}).catch(err => {
  if (err.code === 'ECONNABORTED') {
    console.log('请求超时');
  }
});
```

### Q11: CORS 跨域

**解决方案：**
```javascript
const cors = require('cors');
app.use(cors({
  origin: 'http://example.com',
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type']
}));
```

## 性能问题

### Q12: CPU 占用高

**解决方案：**
1. 使用性能分析工具
   ```bash
   node --prof app.js
   node --inspect app.js
   ```

2. 使用 cluster 模块

### Q13: I/O 性能差

**解决方案：**
1. 使用流处理大文件
2. 批量 I/O 操作
3. 使用缓存

## 安全问题

### Q14: 命令注入

**问题描述：**
用户输入被当作命令执行。

**解决方案：**
```javascript
// 不好
const cmd = `ls ${userInput}`;

// 好：使用参数化
const { execFile } = require('child_process');
execFile('ls', [userInput], callback);
```

### Q15: 敏感信息泄露

**解决方案：**
1. 使用环境变量
   ```javascript
   const apiKey = process.env.API_KEY;
   ```

2. 不要提交 .env 文件到版本控制
   ```
   # .gitignore
   .env
   ```

## 测试问题

### Q16: 单元测试

**解决方案：**
使用 Jest 或 Mocha：
```bash
npm install --save-dev jest
```

```javascript
// sum.test.js
const sum = require('./sum');

test('adds 1 + 2 to equal 3', () => {
  expect(sum(1, 2)).toBe(3);
});
```

## 构建问题

### Q17: 模块解析失败

**解决方案：**
检查 package.json 中的 exports 字段：
```json
{
  "exports": {
    ".": "./index.js",
    "./sub": "./lib/sub.js"
  }
}
```

### Q18: TypeScript 支持

**解决方案：**
```bash
npm install --save-dev typescript @types/node ts-node
npx tsc --init
```

## 部署问题

### Q19: 进程意外退出

**解决方案：**
使用 PM2 管理进程：
```bash
npm install -g pm2
pm2 start app.js
pm2 logs
pm2 restart app
```

### Q20: 多实例部署

**解决方案：**
使用 cluster 模块：
```javascript
const cluster = require('cluster');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
} else {
  const app = require('express')();
  app.listen(3000);
}
```

## 总结

本章节涵盖了 Node.js 开发中的常见问题：

- **安装**：命令找不到、版本冲突
- **开发**：模块找不到、异步、内存泄漏
- **HTTP**：端口占用、超时、跨域
- **性能**：CPU、I/O
- **安全**：命令注入、敏感信息
- **测试**：单元测试
- **构建**：模块解析、TypeScript
- **部署**：进程管理、多实例

如需更多信息，请参考官方文档：https://nodejs.org/zh-cn/docs/
