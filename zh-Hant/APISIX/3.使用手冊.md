# APISIX 使用手冊

APISIX 核心功能和使用技巧。

## 基本概念

### 核心術語

- **Route（路由）**：定義請求匹配規則
- **Upstream（上游）**：實際的後端服務
- **Service（服務）**：一組路由的集合
- **Plugin（插件）**：請求處理邏輯
- **Consumer（消費者）**：API 使用者

### 請求處理流程

1. 客戶端發送請求到 APISIX
2. APISIX 根據路由規則匹配
3. 執行插件邏輯
4. 轉發到上游服務
5. 返回響應給客戶端

## 路由管理

### 創建路由

通過 Admin API 創建：

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "id": "1",
    "uri": "/api/users/*",
    "name": "user-api",
    "upstream": {
      "type": "roundrobin",
      "nodes": {
        "backend1.example.com:8080": 1,
        "backend2.example.com:8080": 2
      }
    }
  }'
```

### 路由參數說明

| 參數 | 說明 | 必填 |
|------|------|------|
| id | 路由唯一標識 | 是 |
| uri | 匹配 URI | 是 |
| name | 路由名稱 | 否 |
| methods | 匹配的 HTTP 方法 | 否 |
| hosts | 匹配的域名 | 否 |
| upstream | 上游服務配置 | 是 |
| plugins | 插件配置 | 否 |

## 上游管理

### 創建上游

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/upstreams/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "type": "roundrobin",
    "nodes": {
      "host1:8080": 1,
      "host2:8080": 1
    }
  }'
```

### 負載均衡策略

**輪詢（默認）：**

```json
{
  "type": "roundrobin"
}
```

**一致性哈希：**

```json
{
  "type": "chash",
  "key": "remote_addr"
}
```

## 插件使用

### 常用插件列表

APISIX 內置 70+ 插件，以下是常用分類：

**流量控制：**
- limit-req：請求限流
- limit-conn：連接數限制
- limit-count：計數限流

**認證授權：**
- jwt-auth：JWT 認證
- key-auth：Key 認證
- basic-auth：Basic 認證

**請求處理：**
- proxy-rewrite：請求改寫
- redirect：重定向

**響應處理：**
- response-rewrite：響應改寫
- gzip：響應壓縮

### 使用限流插件

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "limit-req": {
        "rate": 100,
        "burst": 50,
        "rejected_code": 503
      }
    }
  }'
```

### 使用 JWT 認證

**1. 創建 Consumer：**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/consumers \
  -H "X-API-KEY: 123456" \
  -d '{
    "username": "john",
    "plugins": {
      "jwt-auth": {
        "key": "user-key",
        "secret": "my-secret"
      }
    }
  }'
```

**2. 路由啟用認證：**

```bash
curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/1 \
  -H "X-API-KEY: 123456" \
  -d '{
    "uri": "/api/*",
    "plugins": {
      "jwt-auth": {}
    }
  }'
```

## 服務發現

### Eureka

```json
{
  "service_discovery": {
    "type": "eureka",
    "eureka": {
      "host": ["http://127.0.0.1:8761"]
    }
  }
}
```

### Nacos

```json
{
  "service_discovery": {
    "type": "nacos",
    "nacos": {
      "host": ["http://127.0.0.1:8848"]
    }
  }
}
```

## 健康檢查

```json
{
  "upstream": {
    "nodes": {"host1:8080": 1},
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5
      }
    }
  }
}
```

## 最佳實踐

1. **啟用 Admin API 訪問控制**
2. **使用強密鑰**
3. **配置健康檢查**
4. **合理設置限流值**
5. **啟用緩存**

### 調試技巧

**查看路由：**
```bash
curl http://127.0.0.1:9180/apisix/admin/routes \
  -H "X-API-KEY: 123456"
```

**查看錯誤日誌：**
```bash
tail -f logs/error.log
```
