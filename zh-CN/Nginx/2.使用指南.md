# Nginx 使用指南

高效使用 Nginx 的完整指南。

---

## 目录

- [基本概念](#基本概念)
- [服务器块](#服务器块)
- [反向代理](#反向代理)
- [负载均衡](#负载均衡)
- [SSL/TLS](#ssltls)
- [性能优化](#性能优化)
- [缓存](#缓存)
- [安全](#安全)
- [常用示例](#常用示例)
- [故障排除](#故障排除)

---

## 基本概念

### 什么是 Nginx？

Nginx 是一个高性能的 HTTP 服务器、反向代理服务器和 TCP/UDP 代理服务器。以稳定性、丰富的功能集和低资源消耗著称。

### 架构

- **Master Process**：读取配置，管理 worker 进程
- **Worker Processes**：处理实际请求
- **Worker Connections**：每个 worker 的并发连接数

### 关键术语

| 术语 | 说明 |
|------|------|
| Worker Process | 处理 HTTP 请求的进程 |
| Worker Connections | 最大并发连接数 |
| Server Block | 虚拟主机配置 |
| Location | URL 路径匹配规则 |
| Upstream | 后端服务器组 |
| Directives | 配置指令 |

### 关键文件

| 路径 | 说明 |
|------|------|
| `/etc/nginx/nginx.conf` | 主配置 |
| `/etc/nginx/conf.d/` | 额外配置 |
| `/etc/nginx/sites-available/` | 可用站点 |
| `/etc/nginx/sites-enabled/` | 启用站点 |
| `/var/log/nginx/access.log` | 访问日志 |
| `/var/log/nginx/error.log` | 错误日志 |

---

## 服务器块

### 基础服务器块

```nginx
server {
    listen 80;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 多域名

```nginx
# example.com
server {
    listen 80;
    server_name example.com;
    root /var/www/example.com;
    access_log /var/log/nginx/example.log;
}

# another.com
server {
    listen 80;
    server_name another.com;
    root /var/www/another.com;
    access_log /var/log/nginx/another.log;
}
```

### 默认服务器

```nginx
server {
    listen 80 default_server;
    server_name _;
    root /var/www/default;
}
```

### 重定向

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# www 重定向到非 www
server {
    listen 80;
    server_name www.example.com;
    return 301 $scheme://example.com$request_uri;
}
```

### 自定义错误页面

```nginx
server {
    listen 80;
    server_name example.com;

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        internal;
    }

    location = /50x.html {
        internal;
    }
}
```

---

## 反向代理

### 基础代理

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 支持 WebSocket

```nginx
location /ws/ {
    proxy_pass http://localhost:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;
}
```

### 带 SSL 的代理

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        proxy_pass http://localhost:3000;
    }
}
```

---

## 负载均衡

### 基础负载均衡

```nginx
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### 负载均衡方法

```nginx
# 轮询（默认）
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
}

# 最少连接
upstream backend {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
}

# IP 哈希（会话保持）
upstream backend {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
}

# 加权（流量分配）
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com weight=1;
}
```

### 健康检查

```nginx
upstream backend {
    server backend1.example.com max_fails=3 fail_timeout=30s;
    server backend2.example.com max_fails=3 fail_timeout=30s;
    server backend3.example.com backup;
}
```

---

## SSL/TLS

### 生成自签名证书

```bash
# 生成私钥
openssl genrsa -out key.pem 2048

# 生成 CSR
openssl req -new -key key.pem -out csr.pem

# 生成自签名证书
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.pem
```

### 基础 SSL 配置

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
        root /var/www/html;
    }
}
```

### Let's Encrypt（Certbot）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d example.com -d www.example.com

# 测试自动续期
sudo certbot renew --dry-run
```

### HTTP/2 支持

```nginx
server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        root /var/www/html;
    }
}
```

---

## 性能优化

### Gzip 压缩

```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### 浏览器缓存

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```

### Worker 优化

```nginx
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}
```

### 连接保活

```nginx
http {
    keepalive_timeout 65;
    keepalive_requests 100;

    upstream backend {
        keepalive 32;
        server localhost:3000;
    }
}
```

---

## 缓存

### FastCGI 缓存

```nginx
http {
    fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=app_cache:10m max_size=100m inactive=60m use_temp_path=off;

    server {
        location ~ \.php$ {
            fastcgi_cache app_cache;
            fastcgi_cache_valid 200 60m;
            fastcgi_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            fastcgi_cache_lock on;
            add_header X-FastCGI-Cache $upstream_cache_status;
        }
    }
}
```

### 代理缓存

```nginx
http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=proxy_cache:10m max_size=100m inactive=60m use_temp_path=off;

    server {
        location / {
            proxy_cache proxy_cache;
            proxy_cache_valid 200 60m;
            proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
            add_header X-Proxy-Cache $upstream_cache_status;
        }
    }
}
```

---

## 安全

### 基础安全头

```nginx
server {
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

### 限速

```nginx
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
        }
    }
}
```

---

## 常用示例

### 静态文件服务器

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### PHP-FPM

```nginx
server {
    listen 80;
    server_name php.example.com;

    root /var/www/php;
    index index.php index.html;

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### Node.js 后端

```nginx
server {
    listen 80;
    server_name node.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### WordPress

```nginx
server {
    listen 80;
    server_name wordpress.example.com;

    root /var/www/wordpress;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires max;
        log_not_found off;
    }
}
```

---

## 故障排除

### 查看日志

```bash
# 错误日志
tail -f /var/log/nginx/error.log

# 访问日志
tail -f /var/log/nginx/access.log
```

### 常见错误

| 错误 | 解决方案 |
|------|----------|
| 403 Forbidden | 检查文件权限，添加 index 文件 |
| 404 Not Found | 检查根路径和文件是否存在 |
| 502 Bad Gateway | 检查后端是否运行 |
| 503 Service Unavailable | 检查后端容量 |
| 504 Gateway Timeout | 增加代理超时时间 |
| Permission denied | 检查文件/目录权限 |
| Address already in use | 检查端口 80/443 占用 |

### 测试配置

```bash
# 测试配置语法
nginx -t

# 测试指定配置
nginx -t -c /path/to/config

# 重新加载配置
nginx -s reload
```

---

## 下一步

- 探索 [Nginx 模块](https://nginx.org/en/docs/)
- 学习 [Nginx Plus](https://www.nginx.com/products/nginx/)
