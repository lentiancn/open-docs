# Yarn 安装指南

本指南将详细介绍 Yarn 在各种操作系统和环境下的完整安装过程，帮助你快速上手 Yarn。无论你是使用 macOS、Linux 还是 Windows，无论你倾向于使用哪种安装工具，都能在这里找到详细的指导。

---

## 安装前的准备工作

在开始安装 Yarn 之前，你需要确保系统满足基本要求，并进行一些必要的准备工作。

### 系统要求

**最低要求**：

- 操作系统：macOS 10.15 (Catalina) 或更高版本、Linux（Ubuntu 16.04+、Debian 9+、CentOS 7+ 等）、Windows 10 或更高版本
- Node.js：16.0.0 或更高版本（推荐使用 Node.js 18 LTS 或 20 LTS）
- 磁盘空间：至少 200MB 可用空间
- 网络：能够访问 npm 仓库

**推荐环境**：

- Node.js 18.x LTS 或 20.x LTS
- 稳定的网络连接（用于首次下载依赖）
- 至少 4GB RAM（对于大型项目）

### 检查现有环境

在安装 Yarn 之前，建议先检查系统中是否已经存在相关工具：

```bash
# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version

# 如果之前安装过 Yarn，检查版本
yarn --version
```

如果 Node.js 版本过低，你需要先升级 Node.js。我们推荐使用 nvm（Node Version Manager）来管理多个 Node.js 版本：

```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 使用 nvm 安装 Node.js 20
nvm install 20
nvm use 20

# 设为默认版本
nvm alias default 20
```

---

## Corepack 安装方法（推荐）

Corepack 是 Node.js 14.6.0 及以上版本内置的包管理器管理器。它是 Yarn 官方推荐的安装方式，具有以下优势：不需要全局安装、可以在项目级别管理 Yarn 版本、自动保持更新。

### 启用 Corepack

Corepack 通常随 Node.js 一起安装。如果没有启用，手动启用：

```bash
corepack enable
```

### 安装 Yarn 稳定版

```bash
corepack prepare yarn@stable --activate
```

这个命令会下载并激活最新的稳定版 Yarn。安装完成后验证：

```bash
yarn --version
```

### 安装特定版本

如果你需要使用特定版本的 Yarn：

```bash
# 安装 Yarn 4.x（Berry）
corepack prepare yarn@4.0.0 --activate

# 安装 Yarn 3.x
corepack prepare yarn@3.6.0 --activate

# 安装 Yarn 1.x（经典版）
corepack prepare yarn@1.22.22 --activate
```

### 升级 Yarn

未来需要升级 Yarn 时，只需再次运行：

```bash
corepack prepare yarn@stable --activate
```

### 安装测试版

如果你想尝试最新功能，可以安装 Canary 版或 RC 版：

```bash
# 安装 Canary 版（最新开发版）
corepack prepare yarn@canary --activate

# 安装 Release Candidate 版
corepack prepare yarn@rc --activate
```

### 从源码构建

如果你想测试尚未发布的最新功能，可以从源码构建：

```bash
# 从 master 分支构建
yarn set version from sources

# 测试特定的 PR
yarn set version from sources --branch 1211
```

---

## npm 全局安装方法

如果你更习惯传统的全局安装方式，可以使用 npm 来安装 Yarn。

### 基本安装

```bash
npm install -g yarn
```

### 验证安装

```bash
yarn --version
```

### 升级 Yarn

```bash
# 升级到最新版本
npm update -g yarn

# 或重新安装
npm install -g yarn@latest
```

### 卸载 Yarn

```bash
npm uninstall -g yarn
```

---

## 脚本安装方法

### macOS / Linux

官方提供了一个便捷的安装脚本，可以自动完成下载和配置：

**默认安装（稳定版）**：

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash
```

**指定版本安装**：

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 4.0.0
```

**安装并设置镜像**：

```bash
curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --channel stable --mirror https://registry.npmmirror.com
```

安装脚本会完成以下操作：

1. 检测系统环境
2. 下载指定版本的 Yarn 二进制文件
3. 创建必要的目录结构
4. 配置 PATH 环境变量

### Windows PowerShell

在 Windows 上，可以使用 PowerShell 运行类似的安装脚本：

**基本安装**：

```powershell
iwr -useb https://yarnpkg.com/install.ps1 | iex
```

**指定版本安装**：

```powershell
$env:YARN_VERSION = "4.0.0"
iwr -useb https://yarnpkg.com/install.ps1 | iex
```

---

## 各操作系统的包管理器安装

### macOS

**使用 Homebrew（推荐）**：

```bash
# 如果没有安装 Homebrew，先安装
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Yarn
brew install yarn
```

**使用 MacPorts**：

```bash
sudo port install yarn
```

### Linux

**Debian / Ubuntu**：

```bash
# 添加 Yarn 官方 GPG 密钥
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -

# 添加 Yarn 官方仓库
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

# 更新包索引
sudo apt update

# 安装 Yarn
sudo apt install yarn
```

注意：如果你通过此方法安装，可能需要关闭 corepack 以避免冲突：

```bash
corepack disable
```

**Fedora / RHEL / CentOS**：

```bash
# 添加 Yarn 官方仓库
curl -o- -L https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo

# 安装 Yarn
sudo dnf install yarn
# 或
sudo yum install yarn
```

**Arch Linux**：

```bash
sudo pacman -S yarn
```

**openSUSE**：

```bash
sudo zypper install yarn
```

### Windows

**使用 Winget（推荐）**：

```bash
winget install Yarn.Yarn
```

**使用 Chocolatey**：

```bash
choco install yarn
```

**使用 Scoop**：

```bash
scoop install yarn
```

---

## Docker 中使用 Yarn

在 Docker 容器中使用 Yarn 有多种方式：

### 方式一：使用官方 Node.js 镜像

```dockerfile
FROM node:20

# 启用 corepack 并激活 Yarn
RUN corepack enable && \
    corepack prepare yarn@stable --activate

WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install

COPY . .
RUN yarn build
```

### 方式二：直接安装

```dockerfile
FROM node:20

# 安装 Yarn
RUN npm install -g yarn

WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .
```

### 方式三：使用多阶段构建

```dockerfile
# 构建阶段
FROM node:20-alpine AS builder
RUN corepack enable && corepack prepare yarn@stable --activate
WORKDIR /app
COPY . .
RUN yarn build

# 运行阶段
FROM node:20-alpine
COPY --from=builder /app/dist ./dist
CMD ["node", "dist/index.js"]
```

---

## 安装后配置

### 验证安装

安装完成后，验证 Yarn 是否正确安装：

```bash
# 查看版本
yarn --version

# 查看帮助信息
yarn --help

# 检查配置
yarn config list
```

### 配置镜像源

如果你在中国大陆使用，可能需要配置国内镜像以提升下载速度：

在项目根目录创建 `.yarnrc` 文件（注意不是 .yarnrc.yml）：

```
registry "https://registry.npmmirror.com"
```

或者使用 Yarn 配置命令：

```bash
yarn config set registry https://registry.npmmirror.com
```

### 配置 Yarn 4.x

对于 Yarn 4.x，在项目根目录创建 `.yarnrc.yml`：

```yaml
# npm 注册表
npmRegistryServer: "https://registry.npmjs.org"

# 启用全局缓存
enableGlobalCache: false

# Node.js 链接器
nodeLinker: node-modules

# 启用脚本
enableScripts: true
```

### 设置默认版本

如果你使用 Corepack，可以为项目设置特定的 Yarn 版本：

```bash
# 在项目目录中运行
yarn set version stable
```

这会在项目中创建一个 `.yarnrc.yml` 并锁定 Yarn 版本。

---

## 常见安装问题及解决方案

### 问题一：权限错误

在某些系统上，全局安装可能遇到权限问题：

**症状**：安装时报 EACCES 错误

**解决方案**：不要使用 sudo 来全局安装 npm 包。正确的方法是：

```bash
# 确保 ~/.npm 目录存在并权限正确
mkdir -p ~/.npm
chmod 700 ~/.npm
```

或者使用 nvm 来管理 Node.js，这样可以避免权限问题。

### 问题二：找不到 yarn 命令

**症状**：安装后运行 yarn 提示命令不存在

**解决方案**：将 Yarn 的全局 bin 目录添加到 PATH：

```bash
# 临时添加（当前终端有效）
export PATH="$(yarn global bin):$PATH"

# 永久添加（添加到 shell 配置文件）
echo 'export PATH="$(yarn global bin):$PATH"' >> ~/.bashrc
source ~/.bashrc
```

### 问题三：Node.js 版本过低

**症状**：Yarn 安装成功但运行时报错

**解决方案**：升级 Node.js：

```bash
# 使用 nvm 升级
nvm install 20
nvm use 20

# 或者使用 corepack
corepack prepare node@20.10.0 --activate
```

### 问题四：网络连接问题

**症状**：下载 Yarn 或依赖时超时

**解决方案**：配置镜像源或使用代理：

```bash
# 使用国内镜像
yarn config set registry https://registry.npmmirror.com

# 设置代理
yarn config set proxy http://proxy.example.com:8080
yarn config set https-proxy http://proxy.example.com:8080
```

### 问题五：缓存损坏

**症状**：安装时出现奇怪的错误

**解决方案**：清理缓存：

```bash
# 清理所有缓存
yarn cache clean

# 清理特定包
yarn cache clean lodash
```

---

## 升级和迁移

### 升级 Yarn

使用 Corepack 升级：

```bash
corepack prepare yarn@stable --activate
```

使用 npm 升级：

```bash
npm update -g yarn
```

### 从 Yarn 1.x 迁移到 Yarn 4.x

如果你的项目还在使用 Yarn 1.x，建议迁移到 Yarn 4.x 以获得更好的性能和功能：

1. 首先安装 Yarn 4.x
2. 在项目目录中运行迁移命令：
   ```bash
   yarn set version berry
   ```
3. 更新 .yarnrc 配置
4. 测试所有功能是否正常

---

## 卸载 Yarn

如果需要卸载 Yarn：

### 卸载全局安装的 Yarn

```bash
npm uninstall -g yarn
```

### 清理残留文件

```bash
# 删除 Yarn 缓存
rm -rf ~/.yarn

# 删除 Yarn 配置文件（谨慎使用）
rm -f ~/.yarnrc ~/.yarnrc.yml
```

---

## 验证安装成功

完成安装后，运行以下命令确认一切正常：

```bash
# 检查版本
yarn --version

# 查看 Yarn 信息
yarn info yarn

# 运行自我诊断
yarn doctor
```

如果所有检查都通过，恭喜你安装成功！

---

## 下一步

安装完成后，建议阅读：

- [Yarn 使用手册](./3.使用手册.md)：深入了解 Yarn 的各项功能
- [常见问题解答](./4.常见问题.md)：解答使用中的常见疑问
- [官方文档](https://yarnpkg.com/docs)：获取完整的配置参考
