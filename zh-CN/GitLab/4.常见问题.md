# GitLab 常见问题

> 解答 GitLab 使用过程中的常见问题

---

## 安装相关

### Q: GitLab 安装后无法访问？

**A**: 检查以下几个方面：
- 确认外部 URL 配置正确
- 检查防火墙是否放行了 80、443 端口
- 确认服务是否启动：`sudo gitlab-ctl status`
- 查看日志排查：`sudo gitlab-ctl tail`

### Q: 内存占用过高怎么办？

**A**: GitLab 是资源密集型应用，建议：
- 最低 4GB 内存，推荐 8GB 及以上
- 可以通过以下方式优化：
  ```ruby
  # /etc/gitlab/gitlab.rb
  postgresql['shared_buffers'] = "256MB"
  unicorn['worker_processes'] = 2
  ```

### Q: 如何迁移 GitLab 数据？

**A**: 使用 GitLab 备份和恢复功能：
```bash
# 备份
sudo gitlab-backup create

# 恢复
sudo gitlab-backup restore BACKUP=timestamp
```

---

## Git 操作相关

### Q: 推送代码时提示权限不足？

**A**: 
1. 确认已将 SSH 公钥添加到 GitLab 个人设置中
2. 检查项目成员权限是否足够
3. 如果使用 HTTPS，检查用户名和访问令牌

### Q: 合并请求显示有冲突怎么办？

**A**:
1. 在本地拉取目标分支最新代码
2. 将你的分支变基到目标分支
3. 解决冲突后强制推送：
   ```bash
   git fetch origin
   git checkout your-branch
   git rebase origin/main
   # 解决冲突后
   git push --force-with-lease
   ```

### Q: 大文件推送失败怎么解决？

**A**: GitLab 默认限制文件大小，可以通过配置调整：
```ruby
# /etc/gitlab/gitlab.rb
gitlab_rails['max_attachment_size'] = 100 * 1024 * 1024 # 100MB
```
或使用 Git LFS：
```bash
git lfs install
git lfs track "*.psd"
```

---

## CI/CD 相关

### Q: 流水线一直处于 pending 状态？

**A**: 
1. 检查 GitLab Runner 是否已注册并处于在线状态
2. 确认 Runner 标签与 Jobs 匹配
3. 检查 Runner 的并发限制

### Q: 如何使用私有镜像仓库？

**A**: 
```yaml
build:
  image: my-private-image
  variables:
    DOCKER_AUTH_CONFIG: '{"auths":{"registry.example.com":{"username":"user","password":"pass"}}}'
```

### Q: 缓存不起作用怎么办？

**A**: 确保缓存配置正确：
```yaml
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
  policy: pull-push
```

---

## 权限相关

### Q: 如何设置分支保护？

**A**: 
1. 进入项目 → 设置 → 仓库 → 分支保护
2. 选择要保护的分支
3. 配置谁可以推送、合并

### Q: 无法访问项目怎么办？

**A**: 
1. 确认项目可见性设置（公开/内部/私有）
2. 检查是否被添加为项目成员
3. 联系项目管理员获取权限

---

## 性能优化

### Q: 页面加载缓慢怎么优化？

**A**: 
1. 启用 Prometheus 监控分析
2. 优化 PostgreSQL 配置
3. 使用 Redis 缓存
4. 考虑使用 PostgreSQL 主从复制

### Q: 如何限制用户配额？

**A**: 在管理后台设置：
- 存储配额限制
- 仓库数量限制
- 用户配额限制

---

## 备份恢复

### Q: 如何自动备份？

**A**: 配置 cron 任务：
```bash
# 每天凌晨2点自动备份
0 2 * * * /opt/gitlab/bin/gitlab-backup create CRON=1
```

### Q: 备份文件在哪里？

**A**: 默认在 `/var/opt/gitlab/backups/` 目录

---

## 升级相关

### Q: 如何升级 GitLab？

**A**: 
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install gitlab-ee

# 然后重新配置
sudo gitlab-ctl reconfigure
```

### Q: 升级前需要备份吗？

**A**: 强烈建议升级前创建完整备份：
```bash
sudo gitlab-backup create
sudo gitlab-ctl stop
```

---

## 常见错误代码

| 错误代码 | 说明 | 解决方法 |
|---------|------|----------|
| 500 | 服务器内部错误 | 查看日志 |
| 502 | 网关错误 | 检查服务状态 |
| 503 | 服务不可用 | 检查资源使用 |
| 404 | 资源不存在 | 检查 URL |
| 422 | 请求无法处理 | 检查参数 |
