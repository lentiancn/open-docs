# Руководство по использованию Redis

Полное руководство по эффективному использованию Redis.

---

## Содержание

- [Основные понятия](#основные-понятия)
- [Типы данных](#типы-данных)
- [Операции со строками](#операции-со-строками)
- [Операции со списками](#операции-со-списками)
- [Операции с хэшами](#операции-с-хэшами)
- [Операции с множествами](#операции-с-множествами)
- [Операции с отсортированными множествами](#операции-с-отсортированными-множествами)
- [Ключи и срок действия](#ключи-и-срок-действия)
- [Pub/Sub](#pubsub)
- [Транзакции](#транзакции)
- [Конвейер](#конвейер)
- [Lua-скрипты](#lua-скрипты)
- [Персистентность](#персистентность)
- [Репликация](#репликация)
- [Кластер](#кластер)
- [Безопасность](#безопасность)
- [Оптимизация производительности](#оптимизация-производительности)
- [Частые рецепты](#частые-рецепты)

---

## Основные понятия

### Что такое Redis?

Redis — это хранилище структур данных в памяти с открытым исходным кодом, используемое в качестве базы данных, кэша и брокера сообщений. Поддерживает различные структуры данных и обеспечивает высокую производительность.

### Основные функции

- Хранение в памяти
- Персистентность данных
- Репликация
- Кластеризация
- Pub/Sub messaging
- Lua-скриптинг

### Ключевые термины

| Термин | Описание |
|--------|----------|
| Key | Уникальный идентификатор для значения |
| Value | Данные, хранящиеся в Redis |
| TTL | Time To Live (срок действия) |
| Pipeline | Пакетное выполнение нескольких команд |
| Master | Основной экземпляр Redis |
| Slave | Реплика мастера |

---

## Типы данных

Redis поддерживает различные типы данных:

| Тип | Описание |
|------|----------|
| String | Текст или бинарные данные |
| List | Упорядоченный список строк |
| Hash | Коллекция пар поле-значение |
| Set | Неупорядоченная коллекция уникальных строк |
| Sorted Set | Множество с оценками для сортировки |
| HyperLogLog | Вероятностная структура данных |
| Bitmap | Строка с битовыми операциями |
| Stream | Брокер сообщений со структурой журнала |

---

## Операции со строками

### Основные команды

```bash
# Установить значение
SET key "value"

# Получить значение
GET key

# Установить несколько ключей
MSET key1 "value1" key2 "value2"

# Получить несколько ключей
MGET key1 key2

# Добавить к строке
APPEND key " appended"

# Получить длину строки
STRLEN key
```

### Числовые операции

```bash
# Инкремент
INCR counter
INCRBY counter 10

# Декремент
DECR counter
DECRBY counter 5

# Инкремент с плавающей точкой
INCRBYFLOAT price 0.5
```

---

## Операции со списками

### Основные команды

```bash
# Добавить слева
LPUSH mylist "first"

# Добавить справа
RPUSH mylist "last"

# Извлечь слева
LPOP mylist

# Извлечь справа
RPOP mylist

# Получить диапазон
LRANGE mylist 0 -1

# Получить длину списка
LLEN mylist
```

---

## Операции с хэшами

### Основные команды

```bash
# Установить поле хэша
HSET user:1 name "John"

# Установить несколько полей хэша
HMSET user:1 name "John" email "john@example.com"

# Получить поле хэша
HGET user:1 name

# Получить все поля и значения
HGETALL user:1

# Получить несколько полей
HMGET user:1 name email

# Удалить поле
HDEL user:1 email
```

---

## Операции с множествами

### Основные команды

```bash
# Добавить в множество
SADD myset "member1"

# Удалить из множества
SREM myset "member1"

# Получить всех участников
SMEMBERS myset

# Проверить участ membership
SISMEMBER myset "member1"

# Получить размер множества
SCARD myset
```

### Операции с множествами

```bash
# Объединение
SUNION set1 set2

# Пересечение
SINTER set1 set2

# Разность
SDIFF set1 set2
```

---

## Операции с отсортированными множествами

### Основные команды

```bash
# Добавить в отсортированное множество
ZADD leaderboard 100 "player1"

# Получить диапазон (по возрастанию)
ZRANGE leaderboard 0 -1 WITHSCORES

# Получить диапазон (по убыванию)
ZREVRANGE leaderboard 0 -1 WITHSCORES

# Получить ранг
ZRANK leaderboard "player1"

# Увеличить оценку
ZINCRBY leaderboard 50 "player1"
```

---

## Ключи и срок действия

### Управление ключами

```bash
# Удалить ключ
DEL key

# Проверить существование
EXISTS key

# Получить тип ключа
TYPE key

# Переименовать ключ
RENAME key newkey

# Получить все ключи
KEYS pattern

# Сканировать ключи
SCAN 0 MATCH pattern
```

### Срок действия

```bash
# Установить срок действия (секунды)
EXPIRE key 60

# Установить срок действия (миллисекунды)
PEXPIRE key 60000

# Установить ключ со сроком действия
SETEX key 60 "value"

# Удалить срок действия
PERSIST key

# Получить время до истечения (секунды)
TTL key

# Получить время до истечения (миллисекунды)
PTTL key
```

---

## Pub/Sub

### Публикация

```bash
# Подписаться на канал
SUBSCRIBE mychannel

# Опубликовать сообщение
PUBLISH mychannel "Hello"

# Подписка по шаблону
PSUBSCRIBE news.*
```

### Команды

```bash
# Подписаться
SUBSCRIBE channel1 channel2

# Опубликовать
PUBLISH channel1 "message"

# Отписаться
UNSUBSCRIBE channel1
```

---

## Транзакции

### Основные команды

```bash
# Начать транзакцию
MULTI

# Поставить команды в очередь
SET key1 "value1"
SET key2 "value2"

# Выполнить транзакцию
EXEC

# Отменить транзакцию
DISCARD
```

### Watch

```bash
WATCH key
# ... некоторые операции ...
MULTI
SET key newvalue
EXEC  # Не удастся, если ключ был изменён
```

---

## Конвейер

### Использование конвейера

```bash
# Конвейеризовать несколько команд
redis-cli PING
redis-cli SET key1 "value1"
redis-cli GET key1

# В коде (пример на Python)
pipe = r.pipeline()
pipe.set('key1', 'value1')
pipe.get('key1')
pipe.execute()
```

---

## Lua-скрипты

### Базовый скрипт

```bash
# Выполнить Lua-скрипт
EVAL "return redis.call('get', 'key')" 0

# Установить ключ через Lua
EVAL "redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue
```

### Пример скрипта

```lua
-- Увеличить счётчик
local current = redis.call('get', KEYS[1])
if current then
    current = tonumber(current) + 1
else
    current = 1
end
redis.call('set', KEYS[1], current)
return current
```

---

## Персистентность

### RDB (Redis Database)

```bash
# Сохранить вручную
BGSAVE

# Получить время последнего сохранения
LASTSAVE
```

### AOF (Append Only File)

```bash
# Включить AOF в конфигурации
appendonly yes

# Перезаписать AOF
BGREWRITEAOF
```

### Конфигурация

```bash
# Частота сохранения
save 900 1
save 300 10
save 60 10000
```

---

## Репликация

### Настройка slave

```bash
# В redis.conf
replicaof masterip masterport

# Или через команду
REPLICAOF masterip masterport
```

### Команды

```bash
# Проверить статус репликации
INFO replication

# Стать мастером
REPLICAOF NO ONE
```

---

## Кластер

### Создание кластера

```bash
# Создать кластер
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 --cluster-replicas 1

# Проверить узлы кластера
redis-cli -c cluster nodes
```

---

## Безопасность

### Аутентификация по паролю

```bash
# Установить пароль в конфигурации
requirepass yourpassword

# Аутентифицироваться через CLI
AUTH yourpassword
```

### ACL (Redis 6+)

```bash
# Создать пользователя
ACL SETUSER alice on >password ~cached:* +get +set

# Список пользователей
ACL LIST
```

---

## Оптимизация производительности

### Оптимизация памяти

```bash
# Установить максимальную память
maxmemory 2gb

# Политика вытеснения
maxmemory-policy allkeys-lru
```

### Оптимизация соединений

```bash
# Использовать пул соединений
# В коде
redis_pool = redis.ConnectionPool(host='localhost', port=6379, max_connections=50)
```

---

## Частые рецепты

### Кэширование

```bash
# Кэш с истечением срока действия
SET user:1:profile "data" EX 3600

# Проверить кэш
GET user:1:profile
```

### Ограничение частоты

```bash
# Простое ограничение частоты
INCR rate_limit:ip:192.168.1.1
EXPIRE rate_limit:ip:192.168.1.1 60
```

### Распределённая блокировка

```bash
# Получить блокировку
SET lock:myresource unique_value NX EX 10

# Освободить блокировку
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock:myresource unique_value
```

### Хранение сессий

```bash
# Сохранить сессию
HSET session:abc123 user_id 12345
EXPIRE session:abc123 1800
```

---

## Следующие шаги

- Изучить [Redis Stack](https://redis.io/docs/stack/)
- Узнать о [Redis Enterprise](https://redis.com/redis-enterprise/)
- Прочитать [руководство по настройке производительности](https://redis.io/docs/management/optimization/)
