# Yarn 常见问题

本页面汇总了 Yarn 使用过程中最常见的问题和解答。如果你在这里没有找到答案，建议查看官方文档或加入社区寻求帮助。

---

## 基础问题

### 什么是 Yarn？

Yarn 是一个 JavaScript 包管理器，同时也是一个项目管理者。它可以帮助你安装、更新、配置和删除项目依赖，提供更快的速度、更好的确定性和更优秀的开发者体验。

### Yarn 和 npm 有什么区别？

主要区别：
- **速度**：Yarn 使用并行安装，比 npm 更快
- **确定性**：Yarn 通过 yarn.lock 确保每次安装结果一致
- **离线支持**：Yarn 有强大的离线缓存功能
- **工作区**：Yarn 原生支持 monorepo 工作区
- **输出**：Yarn 的输出更美观、更易读

### Yarn 是免费的吗？

是的，Yarn 是完全免费的开源项目，采用 MIT 许可证。

### 我需要什么版本的 Node.js？

- **Yarn 4.x**：需要 Node.js 16.0.0 或更高版本
- **Yarn 3.x**：需要 Node.js 14.0.0 或更高版本
- **Yarn 1.x**：需要 Node.js 8.0.0 或更高版本

推荐使用 Node.js 18 LTS 或更高版本。

---

## 安装问题

### 安装失败怎么办？

1. 检查 Node.js 版本：
   ```bash
   node --version
   ```

2. 清理 npm 缓存：
   ```bash
   npm cache clean --force
   ```

3. 使用官方安装方式：
   ```bash
   corepack enable
   corepack prepare yarn@stable --activate
   ```

4. 检查权限（不要使用 sudo）

### Windows 上安装有问题？

1. 使用 PowerShell 安装（推荐）：
   ```powershell
   iwr -useb https://yarnpkg.com/install.ps1 | iex
   ```

2. 使用 winget：
   ```bash
   winget install Yarn.Yarn
   ```

3. 关闭杀毒软件后再试

### 如何升级 Yarn？

```bash
# 使用 corepack
corepack prepare yarn@stable --activate

# 使用 npm
npm update -g yarn
```

### 安装后命令找不到？

确保 Yarn 的 bin 目录在 PATH 中：

```bash
# 添加到 .bashrc 或 .zshrc
export PATH="$(yarn global bin):$PATH"
```

---

## 使用问题

### 如何添加依赖？

```bash
# 添加正式依赖
yarn add lodash

# 添加开发依赖
yarn add -D typescript

# 添加特定版本
yarn add lodash@4.17.21
```

### 如何移除依赖？

```bash
yarn remove lodash
```

### 如何更新依赖？

```bash
# 更新到最新版本
yarn up lodash

# 更新所有依赖
yarn up --all

# 交互式更新
yarn up -i
```

### 依赖安装失败？

1. 清理缓存：
   ```bash
   yarn cache clean
   ```

2. 删除 node_modules 和 yarn.lock：
   ```bash
   rm -rf node_modules yarn.lock
   ```

3. 重新安装：
   ```bash
   yarn install
   ```

### 如何运行脚本？

```bash
# 运行 package.json 中定义的脚本
yarn dev
yarn build
yarn test

# 运行任意命令
yarn run my-command
```

### 如何查看依赖树？

```bash
yarn list --tree
```

---

## 工作区问题

### 什么是工作区？

工作区允许你在单个代码库中管理多个包。适用于 monorepo 项目，可以简化跨包依赖管理。

### 如何配置工作区？

在根 package.json 中添加：

```json
{
  "workspaces": [
    "packages/*"
  ]
}
```

### 工作区之间如何引用？

使用 workspace: 协议：

```json
{
  "dependencies": {
    "@my-org/utils": "workspace:^"
  }
}
```

### 如何在工作区中运行命令？

```bash
# 在特定工作区运行
yarn workspace @my-org/core add lodash

# 在所有工作区运行
yarn workspaces foreach -pt run build
```

---

## 配置问题

### 配置文件在哪里？

- **Yarn 4+**：`.yarnrc.yml`
- **Yarn 1.x**：`.yarnrc`

### 如何配置私有注册表？

在 `.yarnrc.yml` 中：

```yaml
npmRegistryServer: "https://registry.mycompany.com"
```

### 如何使用 PnP 模式？

在 `.yarnrc.yml` 中：

```yaml
nodeLinker: pnp
```

### 如何启用硬核模式？

```bash
yarn install --immutable
```

---

## 性能问题

### 安装太慢？

1. 使用离线缓存：
   ```bash
   yarn install --offline
   ```

2. 启用并行安装（默认已启用）

3. 清理缓存：
   ```bash
   yarn cache clean
   ```

### 如何加速 CI/CD？

1. 使用 Zero-Installs：
   ```yaml
   # .yarnrc.yml
   enableGlobalCache: false
   ```

2. 提交缓存到代码库

3. 使用 `--immutable` 防止意外修改

---

## 依赖问题

### 依赖版本冲突？

Yarn 会自动解决依赖冲突。如果遇到问题：

1. 检查依赖树：
   ```bash
   yarn list
   ```

2. 查看为什么安装某个包：
   ```bash
   yarn why lodash
   ```

3. 使用 constraints 强制同步版本

### peerDependencies 警告？

这是正常的。peerDependencies 定义了包期望宿主提供的依赖。确保在项目中安装相应的依赖。

### 依赖过时怎么办？

```bash
yarn outdated
yarn up
```

---

## Lock 文件问题

### yarn.lock 是什么？

yarn.lock 记录了所有依赖的确切版本，确保每次安装结果一致。

### 应该提交 yarn.lock 吗？

**是的**，始终提交 yarn.lock 到版本控制系统。

### lock 文件被意外修改？

如果你在 CI 中使用 `--immutable`，可以检测到意外修改。

恢复 lock 文件：
```bash
git checkout yarn.lock
```

---

## 其他问题

### 如何查看 Yarn 版本？

```bash
yarn --version
```

### 如何获取帮助？

- 官方文档：https://yarnpkg.com/docs
- GitHub Issues：https://github.com/yarnpkg/berry/issues
- Discord：https://discord.gg/yarn
- Stack Overflow：添加 "yarnpkg" 标签

### 如何报告 Bug？

1. 确认问题可重现
2. 收集信息：
   ```bash
   yarn --version
   node --version
   yarn config list
   ```
3. 在 GitHub 上提交 Issue

### Yarn 1 和 Yarn 4 有什么区别？

- **Yarn 1（经典版）**：最后一个版本是 1.22.x
- **Yarn 2+（Berry）**：完全重写，性能更好，支持 PnP

推荐使用 Yarn 4（最新稳定版）。

---

## 相关链接

- 官方网站：https://yarnpkg.com
- 官方文档：https://yarnpkg.com/docs
- GitHub：https://github.com/yarnpkg/berry
- 插件列表：https://yarnpkg.com/plugins
