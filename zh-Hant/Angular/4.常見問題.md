# Angular 常見問題

常見問題和解答。

## 安裝

### Q: Angular CLI 安裝失敗？

**解決方案：**
1. 檢查 Node.js 版本
```bash
node --version  # 需要 18+ 或 20+
```
2. 清理 npm 快取
```bash
npm cache clean --force
```
3. 使用管理員權限（Windows）
4. 檢查網絡連接

### Q: ng 命令找不到？

**解決方案：**
1. 確認 Angular CLI 已安裝
```bash
npm list -g @angular/cli
```
2. 檢查 PATH 環境變量
3. 重新安裝
```bash
npm uninstall -g @angular/cli
npm install -g @angular/cli@latest
```

### Q: 項目創建失敗？

**解決方案：**
1. 檢查磁盤空間
2. 檢查 npm 權限
3. 使用 --skip-install
```bash
ng new my-app --skip-install
cd my-app
npm install
```

## 開發

### Q: 組件不顯示？

**解決方案：**
1. 確認組件已正確導入
2. 確認選擇器正確使用
3. 檢查模板語法
4. 檢查控制台錯誤

### Q: 數據不更新？

**解決方案：**
1. 對於 Signal，使用 set/update 方法
```typescript
count.set(1);           // 設置新值
count.update(c => c + 1); // 基於舊值更新
```
2. 對於 RxJS，確保正確訂閱
3. 使用 ChangeDetectorRef 手動檢測
```typescript
constructor(private cdr: ChangeDetectorRef) {}

refresh() {
  this.cdr.detectChanges();
}
```

### Q: 路由不生效？

**解決方案：**
1. 確認路由配置正確
2. 確認 RouterOutlet 已放置
3. 檢查路由順序
```typescript
// 特定路由在前，通配符在後
{ path: 'user/:id', ... },
{ path: '**', component: NotFoundComponent }
```

### Q: 表單驗證不生效？

**解決方案：**
1. 導入 ReactiveFormsModule 或 FormsModule
2. 確認 FormControl 名稱正確
3. 正確使用驗證器
```typescript
this.form = this.fb.group({
  email: ['', [Validators.required, Validators.email]],
  password: ['', [Validators.required, Validators.minLength(6)]]
});
```

## 性能

### Q: 首屏加載慢？

**解決方案：**
1. 使用懶加載路由
```typescript
{
  path: 'admin',
  loadComponent: () => import('./admin/admin.component')
    .then(m => m.AdminComponent)
}
```
2. 啟用生產模式
```bash
ng build --configuration=production
```
3. AOT 編譯默認開啟

### Q: 內存洩漏？

**解決方案：**
1. 及時取消訂閱
```typescript
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';

@Component({...})
export class MyComponent implements OnDestroy {
  private destroy$ = new Subject<void>();

  ngOnInit() {
    this.http.get('/api').pipe(
      takeUntil(this.destroy$)
    ).subscribe();
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }
}
```
2. 使用 async 管道自動訂閱/取消

### Q: 打包體積太大？

**解決方案：**
1. 檢查依賴大小
```bash
npm run build -- --stats-json
npx webpack-bundle-analyzer dist/stats.json
```
2. 使用懶加載
3. 移除未使用的導入

## 測試

### Q: 單元測試怎麼寫？

**解決方案：**
```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { UserCardComponent } from './user-card.component';

describe('UserCardComponent', () => {
  let component: UserCardComponent;
  let fixture: ComponentFixture<UserCardComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [UserCardComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(UserCardComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should display user name', () => {
    component.user = { name: '張三', email: 'test@example.com' };
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h3')?.textContent).toContain('張三');
  });
});
```

### Q: 測試找不到模組？

**解決方案：**
```typescript
TestBed.configureTestingModule({
  imports: [
    CommonModule,
    HttpClientModule,
    // 其他需要的模組
  ]
});
```

## 構建

### Q: 構建失敗？

**解決方案：**
1. 檢查 TypeScript 錯誤
```bash
npx tsc --noEmit
```
2. 清理快取
```bash
rm -rf node_modules
npm install
```
3. 更新 Angular 版本
```bash
ng update @angular/core @angular/cli
```

### Q: 環境變量不生效？

**解決方案：**
1. 確認環境文件名稱正確
2. 在 angular.json 中配置環境
```json
"configurations": {
  "production": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.prod.ts"
      }
    ]
  }
}
```

## 安全

### Q: XSS 攻擊如何防範？

**解決方案：**
1. 默認 Angular 會自動轉義
2. 謹慎使用 innerHTML
```typescript
import { DomSanitizer } from '@angular/platform-browser';

constructor(private sanitizer: DomSanitizer) {}

getHtml() {
  // 僅對可信內容使用
  return this.sanitizer.bypassSecurityTrustHtml(this.trustedContent);
}
```

### Q: CSRF 防護？

**解決方案：**
```typescript
import { HttpClientModule } from '@angular/common/http';

@NgModule({
  imports: [
    HttpClientModule,
    HttpClientXsrfModule.withOptions({
      cookieName: 'XSRF-TOKEN',
      headerName: 'X-XSRF-TOKEN'
    })
  ]
})
export class AppModule {}
```

## 升級

### Q: 如何升級 Angular 版本？

**解決方案：**
1. 使用 ng update
```bash
ng update @angular/core@17 @angular/cli@17
```
2. 查看遷移指南
3. 更新依賴版本
4. 運行測試確保兼容性

### Q: 升級後代碼不兼容？

**解決方案：**
1. 查看官方升級指南
2. 使用 ng update 自動遷移
3. 逐步升級，不要跳版本

## 學習資源

### Q: 哪裡學習 Angular？

- 官方文檔：https://angular.io
- 中文文檔：https://angular.cn
- Angular University：https://angular-university.io
- StackBlitz：線上編寫 Angular 代碼

### Q: 如何獲取幫助？

- Stack Overflow：https://stackoverflow.com/questions/tagged/angular
- Discord：https://discord.com/invite/angular
- GitHub Discussions：https://github.com/angular/angular/discussions
