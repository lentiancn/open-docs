# Jenkins 使用手册

本手册介绍 Jenkins 的核心概念和实际使用方法。

## 基础操作

### 创建自由风格项目

1. 点击"新建 Item"
2. 输入项目名称
3. 选择"自由风格软件项目"
4. 配置源代码管理
5. 配置构建触发器
6. 配置构建步骤
7. 保存

### 配置源代码管理

```groovy
# Git
配置 Git：
- 仓库 URL
- 凭据
- 分支
```

### 配置构建触发器

```groovy
# 定时构建
H/5 * * * *  # 每5分钟

# 轮询 SCM
H/5 * * * *  # 每5分钟检查代码

# Webhook
# GitHub Hook trigger for GITScm polling
```

## Pipeline

### Declarative Pipeline

```groovy
pipeline {
    agent any
    
    environment {
        APP_NAME = 'myapp'
    }
    
    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'npm install'
                sh 'npm run build'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing...'
                sh 'npm test'
            }
            post {
                always {
                    junit '**/test-results/*.xml'
                }
            }
        }
        
        stage('Deploy') {
            when {
                branch 'master'
            }
            steps {
                echo 'Deploying...'
                sh './deploy.sh'
            }
        }
    }
    
    post {
        success {
            echo 'Build succeeded!'
            emailext body: 'Build succeeded', subject: 'Build Success'
        }
        failure {
            echo 'Build failed!'
            emailext body: 'Build failed', subject: 'Build Failure'
        }
    }
}
```

### Scripted Pipeline

```groovy
node {
    stage('Checkout') {
        checkout scm
    }
    
    stage('Build') {
        sh 'npm install'
        sh 'npm run build'
    }
    
    stage('Test') {
        sh 'npm test'
    }
    
    stage('Deploy') {
        if (env.BRANCH_NAME == 'master') {
            sh './deploy.sh'
        }
    }
}
```

## 常用步骤

### Shell 命令

```groovy
steps {
    sh 'echo Hello'
    sh 'npm install'
    sh 'npm run build'
    sh '''
        echo multi-line
        script
    '''
}
```

### 条件执行

```groovy
steps {
    script {
        if (env.BRANCH_NAME == 'master') {
            sh './deploy-prod.sh'
        } else {
            sh './deploy-test.sh'
        }
    }
}
```

### 循环

```groovy
steps {
    script {
        def servers = ['dev', 'staging', 'prod']
        for (server in servers) {
            echo "Deploying to ${server}"
        }
    }
}
```

## 触发器

### Webhook 触发

```groovy
triggers {
    githubPush()
}
```

### 定时触发

```groovy
triggers {
    cron('H/5 * * * *')
}
```

### 依赖触发

```groovy
triggers {
    upstream('project-a', 'SUCCESS')
}
```

## 环境变量

### 内置变量

```groovy
steps {
    echo "Build number: ${BUILD_NUMBER}"
    echo "Branch: ${BRANCH_NAME}"
    echo "Commit: ${GIT_COMMIT}"
    echo "URL: ${RUN_DISPLAY_URL}"
}
```

### 自定义变量

```groovy
environment {
    APP_NAME = 'myapp'
    APP_VERSION = '1.0.0'
}

steps {
    echo "Deploying ${APP_NAME} v${APP_VERSION}"
}
```

## 通知

### 邮件通知

```groovy
post {
    success {
        emailext (
            subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """${env.JOB_NAME} #${env.BUILD_NUMBER}
                    Build URL: ${env.BUILD_URL}
                    """,
            to: 'team@example.com'
        )
    }
}
```

### Slack 通知

```groovy
post {
    success {
        slackSend(
            color: 'good',
            message: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        )
    }
}
```

## 分布式构建

### 配置 Agent

```groovy
# Jenkins > 节点管理 > 新建节点

# 在 Agent 上启动
# java -jar agent.jar -jnlpUrl http://master:8080/manage/computer/*/jenkins-agent.jnlp
```

### 使用 Agent

```groovy
pipeline {
    agent {
        label 'docker'
    }
    stages {
        stage('Build on Agent') {
            steps {
                sh 'docker build .'
            }
        }
    }
}
```

## 凭据管理

### 添加凭据

1. 进入"凭据" > "系统" > "添加域"
2. 选择"全局凭据"
3. 添加用户名密码、SSH 密钥等

### 使用凭据

```groovy
steps {
    withCredentials([usernamePassword(credentialsId: 'my-credentials', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
        sh 'echo $USER $PASS'
    }
}
```

## 制品

### 保存制品

```groovy
post {
    success {
        archiveArtifacts artifacts: 'dist/**', fingerprint: true
    }
}
```

### 复制制品

```groovy
steps {
    copyArtifacts projectName: 'other-project', selector: lastSuccessful(), target: 'artifacts/'
}
```

## 测试报告

### JUnit

```groovy
steps {
    sh 'npm test'
}

post {
    always {
        junit 'test-results/*.xml'
    }
}
```

### HTML 报告

```groovy
steps {
    publishHTML target: {
        reportDir: 'html-report'
        reportFiles: 'index.html'
        reportName: 'Test Report'
    }
}
```

## 部署示例

### Docker 部署

```groovy
stage('Deploy to Docker') {
    steps {
        script {
            docker.withRegistry('https://registry.example.com', 'docker-cred') {
                def img = docker.build("myapp:${env.BUILD_NUMBER}")
                img.push('latest')
                img.push(env.BUILD_NUMBER)
            }
        }
    }
}
```

### Kubernetes 部署

```groovy
stage('Deploy to K8s') {
    steps {
        sh '''
            kubectl set image deployment/myapp myapp=myapp:${BUILD_NUMBER}
            kubectl rollout status deployment/myapp
        '''
    }
}
```

## 总结

本手册涵盖了 Jenkins 开发的常用操作：

- **基础操作**：创建项目、配置源码管理
- **Pipeline**：Declarative、Scripted
- **步骤**：Shell、条件、循环
- **触发器**：Webhook、定时、依赖
- **环境变量**：内置、自定义
- **通知**：邮件、Slack
- **分布式**：Agent 配置和使用
- **凭据**：添加、使用
- **制品**：保存、复制
- **测试**：JUnit、HTML 报告
- **部署**：Docker、K8s

掌握这些内容后，你就可以熟练使用 Jenkins 了。
