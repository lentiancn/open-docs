# MySQL 使用手册

本手册介绍 MySQL 的核心语法和实际使用方法。

## 基础操作

### 连接 MySQL

```bash
# 本地连接
mysql -u root -p

# 远程连接
mysql -h 192.168.1.100 -u root -p

# 指定端口
mysql -h localhost -P 3307 -u root -p
```

### 数据库操作

```sql
-- 查看数据库
SHOW DATABASES;

-- 创建数据库
CREATE DATABASE myapp;

-- 使用数据库
USE myapp;

-- 删除数据库
DROP DATABASE myapp;
```

### 表操作

```sql
-- 查看表
SHOW TABLES;

-- 创建表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    age INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 查看表结构
DESC users;
DESCRIBE users;

-- 删除表
DROP TABLE users;
```

## 数据类型

### 数值类型

| 类型 | 范围 | 说明 |
|------|------|------|
| TINYINT | -128~127 | 1 字节 |
| SMALLINT | -32768~32767 | 2 字节 |
| INT | -21亿~21亿 | 4 字节 |
| BIGINT | 极大 | 8 字节 |
| FLOAT | 单精度 | 4 字节 |
| DOUBLE | 双精度 | 8 字节 |
| DECIMAL | 精确数值 | 变长 |

### 字符串类型

| 类型 | 最大长度 | 说明 |
|------|----------|------|
| CHAR | 255 | 固定长度 |
| VARCHAR | 65535 | 可变长度 |
| TEXT | 65535 | 长文本 |
| LONGTEXT | 4GB | 超长文本 |

### 日期时间类型

| 类型 | 范围 | 说明 |
|------|------|------|
| DATE | '1000-01-01' | 日期 |
| TIME | '-838:59:59' | 时间 |
| DATETIME | '1000-01-01 00:00:00' | 日期时间 |
| TIMESTAMP | 1970-2038 | 时间戳 |
| YEAR | 1901-2155 | 年份 |

## CRUD 操作

### INSERT - 插入数据

```sql
-- 插入单条
INSERT INTO users (username, email, password) VALUES ('tom', 'tom@example.com', '123456');

-- 插入多条
INSERT INTO users (username, email, password) VALUES 
('jerry', 'jerry@example.com', '123456'),
('spike', 'spike@example.com', '123456');

-- 插入默认值
INSERT INTO users (username, email) VALUES ('tom', 'tom@example.com');

-- 插入查询结果
INSERT INTO users_backup (username, email) SELECT username, email FROM users;
```

### SELECT - 查询数据

```sql
-- 查询所有列
SELECT * FROM users;

-- 查询指定列
SELECT username, email FROM users;

-- 条件查询
SELECT * FROM users WHERE age >= 18;

-- 多条件
SELECT * FROM users WHERE age >= 18 AND status = 1;

-- 或条件
SELECT * FROM users WHERE status = 1 OR status = 2;

-- 排序
SELECT * FROM users ORDER BY created_at DESC;
SELECT * FROM users ORDER BY age ASC, created_at DESC;

-- 限制数量
SELECT * FROM users LIMIT 10;
SELECT * FROM users LIMIT 0, 10;

-- 分页
SELECT * FROM users LIMIT 10 OFFSET 20;

-- 去重
SELECT DISTINCT status FROM users;

-- 别名
SELECT username AS name, email AS mail FROM users;
```

### UPDATE - 更新数据

```sql
-- 更新单条
UPDATE users SET email = 'new@example.com' WHERE id = 1;

-- 更新多条
UPDATE users SET status = 0 WHERE age < 18;

-- 更新多列
UPDATE users SET email = 'new@example.com', status = 1 WHERE id = 1;
```

### DELETE - 删除数据

```sql
-- 删除符合条件的数据
DELETE FROM users WHERE id = 1;

-- 删除所有数据（谨慎使用）
DELETE FROM users;

-- 截断表（更快）
TRUNCATE TABLE users;
```

## 高级查询

### 聚合函数

```sql
-- 计数
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM users WHERE age >= 18;

-- 求和
SELECT SUM(age) FROM users;

-- 平均值
SELECT AVG(age) FROM users;

-- 最大值/最小值
SELECT MAX(age), MIN(age) FROM users;

-- 分组
SELECT status, COUNT(*) FROM users GROUP BY status;

-- 分组后过滤
SELECT status, COUNT(*) FROM users GROUP BY status HAVING COUNT(*) > 10;
```

### 连接查询

```sql
-- 内连接
SELECT u.username, o.order_id FROM users u 
INNER JOIN orders o ON u.id = o.user_id;

-- 左连接
SELECT u.username, o.order_id FROM users u 
LEFT JOIN orders o ON u.id = o.user_id;

-- 右连接
SELECT u.username, o.order_id FROM users u 
RIGHT JOIN orders o ON u.id = o.user_id;

-- 多表连接
SELECT u.username, o.order_id, p.product_name 
FROM users u 
INNER JOIN orders o ON u.id = o.user_id 
INNER JOIN products p ON o.product_id = p.id;
```

### 子查询

```sql
-- 在 WHERE 中使用子查询
SELECT * FROM users WHERE age > (SELECT AVG(age) FROM users);

-- 在 FROM 中使用子查询
SELECT * FROM (SELECT * FROM users WHERE status = 1) AS active_users;

-- IN 子查询
SELECT * FROM users WHERE id IN (SELECT user_id FROM orders);

-- EXISTS 子查询
SELECT * FROM users WHERE EXISTS (SELECT 1 FROM orders WHERE orders.user_id = users.id);
```

### 联合查询

```sql
-- UNION（去重）
SELECT username FROM users WHERE age < 20
UNION
SELECT username FROM users WHERE status = 0;

-- UNION ALL（不去重）
SELECT username FROM users WHERE age < 20
UNION ALL
SELECT username FROM users WHERE status = 0;
```

## 索引

### 创建索引

```sql
-- 普通索引
CREATE INDEX idx_username ON users(username);

-- 唯一索引
CREATE UNIQUE INDEX idx_email ON users(email);

-- 复合索引
CREATE INDEX idx_age_status ON users(age, status);

-- 查看索引
SHOW INDEX FROM users;
```

### 删除索引

```sql
DROP INDEX idx_username ON users;
```

## 事务

```sql
-- 开始事务
START TRANSACTION;

-- 或
BEGIN;

-- 提交
COMMIT;

-- 回滚
ROLLBACK;

-- 设置保存点
SAVEPOINT sp1;

-- 回滚到保存点
ROLLBACK TO SAVEPOINT sp1;
```

## 视图

```sql
-- 创建视图
CREATE VIEW user_orders AS
SELECT u.username, o.order_id, o.total
FROM users u
INNER JOIN orders o ON u.id = o.user_id;

-- 使用视图
SELECT * FROM user_orders;

-- 删除视图
DROP VIEW user_orders;
```

## 存储过程

```sql
-- 创建存储过程
DELIMITER //

CREATE PROCEDURE get_user_count()
BEGIN
    SELECT COUNT(*) AS total FROM users;
END //

DELIMITER ;

-- 调用存储过程
CALL get_user_count();

-- 带参数的存储过程
DELIMITER //

CREATE PROCEDURE get_user_by_age(IN min_age INT, OUT total INT)
BEGIN
    SELECT COUNT(*) INTO total FROM users WHERE age >= min_age;
END //

DELIMITER ;

-- 调用
CALL get_user_by_age(18, @total);
SELECT @total;
```

## 触发器

```sql
-- 创建触发器
DELIMITER //

CREATE TRIGGER insert_user_log
AFTER INSERT ON users
FOR EACH ROW
BEGIN
    INSERT INTO user_logs (action, user_id, created_at) 
    VALUES ('insert', NEW.id, NOW());
END //

DELIMITER ;

-- 删除触发器
DROP TRIGGER insert_user_log;
```

## 用户权限

```sql
-- 创建用户
CREATE USER 'tom'@'localhost' IDENTIFIED BY 'password';

-- 授权
GRANT SELECT, INSERT, UPDATE ON myapp.* TO 'tom'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 查看权限
SHOW GRANTS FOR 'tom'@'localhost';

-- 撤销权限
REVOKE INSERT ON myapp.* FROM 'tom'@'localhost';

-- 删除用户
DROP USER 'tom'@'localhost';
```

## 备份和恢复

### 备份

```bash
# 备份单个数据库
mysqldump -u root -p myapp > backup.sql

# 备份所有数据库
mysqldump -u root -p --all-databases > backup.sql

# 备份指定表
mysqldump -u root -p myapp users orders > backup.sql
```

### 恢复

```bash
# 恢复数据库
mysql -u root -p myapp < backup.sql

# 恢复所有数据库
mysql -u root -p < backup.sql
```

## 总结

本手册涵盖了 MySQL 开发的常用操作：

- **基础操作**：连接、数据库、表
- **数据类型**：数值、字符串、日期
- **CRUD**：插入、查询、更新、删除
- **高级查询**：聚合、连接、子查询
- **索引**：创建、使用
- **事务**：提交、回滚
- **视图**：创建、使用
- **存储过程**：定义、调用
- **用户权限**：创建、授权、撤销

掌握这些内容后，你就可以熟练使用 MySQL 了。
