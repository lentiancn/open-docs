# Apache APISIX ユーザーマニュアル

このマニュアルでは、ルート設定、負荷分散、認証、レート制限などのコア機能を含む、APISIXの日常的なAPI管理の使用方法について詳しく説明します。

## 基本概念

使用する前に、APISIXのいくつかのコア概念を理解する必要があります：

### Route（ルート）

ルートはAPISIXの基本的な概念で、**リクエストパス**と**アップストリームサービス**の間のマッピングを定義します。ルートを作成するということは、「このパスに一致するリクエストがあれば、そのサービスに転送する」ということをAPISIXに指示することになります。

単純なルートには以下が含まれます：

- **URI**: リクエストパス（例: `/api/users`）
- **Upstream**: アップストリームサービスのアドレス
- **Plugins**（オプション）: 実行するプラグイン

### Upstream（アップストリーム）

アップストリームは同一のサービスを提供するノードのセットです。APISIXはこれらのノードに対して負荷分散を行い、リクエストを異なるノードに分散させます。

### Consumer（コンシューマー）

コンシューマーはAPIの使用者で、アプリケーション、ユーザー、またはサービスになります。コンシューマーは認証プラグインを通じて身元を証明する必要があります。

### Plugin（プラグイン）

プラグインはAPISIXが機能を拡張する方法です。APISIXは認証、レート制限、モニタリング、セキュリティなどをカバーする豊富な組み込みプラグインを提供します。

## クイックスタート

### 最初のルートを作成

`httpbin.org`で動作するバックエンドサービスがあり、それをAPISIX経由でアクセスしたいとします：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "my-first-route",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  }
}'
```

作成後、`http://127.0.0.1:9080/ip`にアクセスすると`http://httpbin.org/ip`に転送されます。

### ルートを確認

```bash
curl "http://127.0.0.1:9080/ip"
```

期待されるレスポンス：

```json
{
  "origin": "183.94.122.205"
}
```

## 負荷分散

APISIXは複数の負荷分散戦略をサポートしています。ニーズに応じて適切なアルゴリズムを選択できます。

### 加重ラウンドロビン

異なるノードに異なる重みを設定でき、重みが高いノードほど多くのリクエストを受けます：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "weighted-route",
  "uri": "/headers",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 3,
      "service-b:8080": 1
    }
  }
}'
```

この設定は、service-aが75%、service-bが25%的リクエストを受け取ることを意味します。

### 一貫性ハッシュ

セッション永続化が必要なシナリオでは、一貫性ハッシュアルゴリズムを使用：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "hash-route",
  "uri": "/user/*",
  "upstream": {
    "type": "chash",
    "key": "remote_addr",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    }
  }
}'
```

### ヘルスチェック

APISIXはアップストリームノードのヘルスチェックをサポートし、故障したノードを自動的に除外：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "health-check-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5,
        "timeout": 2,
        "healthy": {
          "interval": 2,
          "successes": 2
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 3
        }
      }
    }
  }
}'
```

## 認証

APISIXはAPIを保護するための複数の認証プラグインを提供します。

### APIキー認証

これは最もシンプルで一般的な認証方法です：

**ステップ1: コンシューマーを作成**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "tom",
  "plugins": {
    "key-auth": {
      "key": "secret-key-123"
    }
  }
}'
```

**ステップ2: ルートでキー認証を有効化**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "key-auth": {}
  }
}'
```

**ステップ3: キーを付けてアクセス**

```bash
# キーなしでは拒否される
curl "http://127.0.0.1:9080/ip"
# 戻り値: 401 Unauthorized

# 正しいキーだとアクセス可能
curl "http://127.0.0.1:9080/ip" -H "apikey: secret-key-123"
# 戻り値: 200 OK
```

### JWT認証

より複雑な権限制御が必要なシナリオでは、JWTを使用：

```bash
# JWTでコンシューマーを作成
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "alice",
  "plugins": {
    "jwt-auth": {
      "key": "user-key",
      "secret": "my-secret"
    }
  }
}'

# JWTトークンを取得（バックエンドで生成が必要）
# その後リクエストに含める: Authorization: Bearer <jwt-token>
```

## レート制限

APISIXは複数のレート制限プラグインを提供し、異なる次元でリクエスト頻度を制限できます。

### リクエスト数ベースの制限

単位時間あたりのリクエスト数を制限：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

この設定は、各IPが60秒間に最大100リクエストまで許可し、超えると503エラーを返すことを意味します。

### リクエストレートベースの制限

リクエスト処理速度を制限：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-req": {
      "rate": 100,
      "burst": 50,
      "rejected_code": 429
    }
  }
}'
```

### 同時接続数ベースの制限

同時建立接続数を制限：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PATCH -d '
{
  "plugins": {
    "limit-conn": {
      "conn": 100,
      "burst": 50,
      "rejected_code": 503
    }
  }
}'
```

## リクエスト書き換え

APISIXはリクエストを転送する前に変更できます。

### リクエストパスを書き換え

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "rewrite-route",
  "uri": "/api/v1/*",
  "plugins": {
    "proxy-rewrite": {
      "uri": "/$uri"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

### リクエストヘッダーを書き換え

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "header-route",
  "uri": "/proxy",
  "plugins": {
    "proxy-rewrite": {
      "headers": {
        "X-Custom-Header": "custom-value",
        "X-Request-ID": "$request_id"
      }
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## カナリアリリース

2つの異なるアップストリームサービスを設定することで、スムーズなトラフィック切り替えを実現できます。

### 重みベースのカナリアリリース

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "canary-route",
  "uri": "/api/*",
  "plugins": {
    "traffic-split": {
      "rules": [
        {
          "weighted_upstream": [
            {
              "upstream": {
                "name": "v1",
                "nodes": {
                  "v1-service:8080": 100
                }
              },
              "weight": 90
            },
            {
              "upstream": {
                "name": "v2",
                "nodes": {
                  "v2-service:8080": 100
                }
              },
              "weight": 10
            }
          ]
        }
      ]
    }
  }
}'
```

この設定は、90%のトラフィックをv1、10%をv2に送信することを意味します。

## サーキットブレーカー

アップストリームサービスで故障が発生した場合、サーキットブレーカーは故障したノードへのリクエスト送信を自動的に停止し、故障の拡大を防ぎます。

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "circuit-route",
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "service-a:8080": 1,
      "service-b:8080": 1
    },
    "checks": {
      "passive": {
        "type": "http",
        "healthy": {
          "successes": 3
        },
        "unhealthy": {
          "http_failures": 3,
          "tcp_failures": 3
        }
      }
    }
  }
}'
```

## モニタリングとログ

### Prometheusモニタリング

Prometheusプラグインを有効にしてメトリクスを収集：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "monitor-route",
  "uri": "/api/*",
  "plugins": {
    "prometheus": {}
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

メトリクスを取得：

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

### リクエストログ

リクエストログを外部ログシステムに送信：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "log-route",
  "uri": "/api/*",
  "plugins": {
    "http-logger": {
      "uri": "http://log-server:8080/logs"
    }
  },
  "upstream": {
    "nodes": {
      "backend:8080": 1
    }
  }
}'
```

## 一般的な管理コマンド

### すべてのルートを表示

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### すべてのアップストリームを表示

```bash
curl "http://127.0.0.1:9180/apisix/admin/upstreams" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### すべてのコンシューマーを表示

```bash
curl "http://127.0.0.1:9180/apisix/admin/consumers" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### すべてのプラグインを表示

```bash
curl "http://127.0.0.1:9180/apisix/admin/plugins" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### ルートを削除

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X DELETE
```

### ルートを更新

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/my-first-route" -X PUT -d '
{
  "uri": "/new-path",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "new-backend:8080": 1
    }
  }
}'
```

## ベストプラクティス

1. **本番環境ではAPIキーを変更する**: デフォルトのAdmin APIキーは公開されています。本番環境では必ず変更してください。

2. **HTTPSを使用する**: 本番環境ではSSL/TLS暗号化を有効にしてください。

3. **ヘルスチェックを有効にする**: アップストリームのヘルスチェックを設定するとシステムの安定性が向上します。

4. **適切なレート制限値を設定する**: 実際のビジネスニーズとバックエンド能力に基づいて適切なレート制限閾値を設定してください。

5. **ログをバックアップする**: 重要なログを別のログシステムに送信し、問題の特定に備えてください。

6. **設定をバックアップする**: etcdの設定データを定期的にバックアップしてください。
