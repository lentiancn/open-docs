# GitLab 使用手册

本手册介绍 GitLab 的核心功能和使用方法。

## 基础操作

### 创建项目

1. 点击 "New project"
2. 选择模板或空白项目
3. 填写项目名称和描述
4. 选择可见性（公开/内部/私有）
5. 点击 "Create project"

### 克隆项目

```bash
# SSH 克隆
git clone git@gitlab.com:username/project.git

# HTTPS 克隆
git clone https://gitlab.com/username/project.git
```

### 提交代码

```bash
# 初始化（如果是新项目）
git init
git remote add origin git@gitlab.com:username/project.git

# 添加文件
git add .

# 提交
git commit -m "Add new feature"

# 推送
git push -u origin master
```

## 分支管理

### 创建分支

```bash
# 创建新分支
git checkout -b feature/new-feature

# 推送分支
git push -u origin feature/new-feature
```

### 合并分支

```bash
# 切换到主分支
git checkout master

# 拉取最新代码
git pull origin master

# 合并功能分支
git merge feature/new-feature

# 推送
git push origin master
```

### 删除分支

```bash
# 删除本地分支
git branch -d feature/new-feature

# 删除远程分支
git push origin --delete feature/new-feature
```

## Merge Request

### 创建 Merge Request

1. 在分支页面点击 "Create merge request"
2. 填写标题和描述
3. 选择源分支和目标分支
4. 设置指派人
5. 点击 "Submit merge request"

### 代码审查

```markdown
## 描述

实现新功能的详细说明

## 变更内容

- 添加用户认证
- 添加权限控制

## 测试

已通过以下测试：
- 单元测试
- 集成测试
```

### 审查评论

- 在行号上点击添加评论
- 建议修改
- 批准或请求更改

## 问题跟踪

### 创建问题

1. 进入 "Issues" 页面
2. 点击 "New issue"
3. 填写标题和描述
4. 添加标签
5. 指派给成员

### 标签

- bug：缺陷
- feature：功能
- enhancement：改进
- documentation：文档

### 里程碑

```markdown
## 里程碑 v1.0

**截止日期**：2024-03-01

**描述**：版本发布

## 问题列表

- [ ] 问题 1
- [x] 问题 2
```

## CI/CD

### 基本配置

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - echo "Building..."
    - npm install
    - npm run build
  artifacts:
    paths:
      - dist/

test:
  stage: test
  script:
    - echo "Testing..."
    - npm test
  coverage: '/Coverage: \d+\.\d+%/'

deploy:
  stage: deploy
  script:
    - echo "Deploying..."
    - ./deploy.sh
  environment:
    name: production
    url: https://example.com
  only:
    - master
```

### Docker 构建

```yaml
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t registry.gitlab.com/username/project:$CI_COMMIT_SHA .
    - docker push registry.gitlab.com/username/project:$CI_COMMIT_SHA
```

### 部署配置

```yaml
deploy:
  stage: deploy
  script:
    - echo "Deploying to $CI_ENVIRONMENT_NAME"
    - deploy.sh
  environment:
    name: staging
    url: https://staging.example.com
    on_stop: stop_staging

stop_staging:
  stage: deploy
  script:
    - echo "Stopping staging"
  environment:
    name: staging
    action: stop
  when: manual
```

### CI/CD 变量

```yaml
# 设置变量
variables:
  DATABASE_URL: "postgres://postgres@postgres:5432/db"

# 使用变量
script:
  - echo $DATABASE_URL
```

## 代码片段

### 创建片段

1. 点击 "Snippets"
2. 点击 "New snippet"
3. 填写标题和描述
4. 选择可见性
5. 添加代码

### 公开片段

```bash
# 公共代码片段可以用于分享常用代码
```

## Wiki

### 创建 Wiki

1. 进入 "Wiki" 页面
2. 点击 "New page"
3. 填写标题和内容
4. 选择格式（Markdown/ReStructuredText）

### 组织内容

```
## 首页

欢迎使用项目 Wiki

## 目录

- [安装](./installation)
- [配置](./configuration)
- [API](./api)
```

## 成员管理

### 邀请成员

1. 进入项目设置
2. 点击 "Members"
3. 选择成员
4. 设置访问级别

### 访问级别

| 级别 | 权限 |
|------|------|
| Guest | 只读 |
| Reporter | 拉取代码 |
| Developer | 提交代码 |
| Maintainer | 管理分支 |
| Owner | 完全控制 |

## 安全扫描

### 依赖扫描

自动扫描依赖中的漏洞：

```yaml
# 启用依赖扫描
include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml
```

### SAST

静态应用安全测试：

```yaml
include:
  - template: Security/SAST.gitlab-ci.yml
```

## API 使用

### 基本 API

```bash
# 获取项目列表
curl --header "PRIVATE-TOKEN: your-token" \
  https://gitlab.com/api/v4/projects

# 获取项目信息
curl --header "PRIVATE-TOKEN: your-token" \
  https://gitlab.com/api/v4/projects/1

# 创建问题
curl --request POST \
  --header "PRIVATE-TOKEN: your-token" \
  --header "Content-Type: application/json" \
  --data '{"title": "New issue", "description": "Issue description"}' \
  https://gitlab.com/api/v4/projects/1/issues
```

### 常用端点

| 端点 | 说明 |
|------|------|
| /projects | 项目列表 |
| /projects/:id | 项目详情 |
| /projects/:id/repository/tree | 文件树 |
| /projects/:id/issues | 问题列表 |
| /projects/:id/merge_requests | MR 列表 |

## Webhooks

### 配置 Webhook

1. 进入项目设置
2. 点击 "Webhooks"
3. 添加 URL
4. 选择触发事件
5. 保存

### 示例

```json
{
  "object_kind": "push",
  "ref": "refs/heads/master",
  "user_name": "username",
  "project": {
    "name": "project",
    "web_url": "https://gitlab.com/user/project"
  }
}
```

## 备份和恢复

### 备份

```bash
# 创建备份
sudo gitlab-backup create

# 指定备份路径
sudo gitlab-backup create SKIP=db,artifacts
```

### 恢复

```bash
# 停止服务
sudo gitlab-ctl stop

# 恢复备份
sudo gitlab-backup restore BACKUP=timestamp

# 启动服务
sudo gitlab-ctl start
```

## 总结

本手册涵盖了 GitLab 开发的常用操作：

- **项目**：创建、克隆、推送
- **分支**：创建、合并、删除
- **Merge Request**：创建、审查、合并
- **问题**：创建、标签、里程碑
- **CI/CD**：配置、构建、部署
- **成员**：邀请、管理权限
- **安全**：依赖扫描、SAST
- **API**：REST API 使用
- **备份**：备份和恢复

掌握这些内容后，你就可以熟练使用 GitLab 了。
