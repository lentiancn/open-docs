# Guía de Uso de SadTalker

SadTalker genera videos realistas de cabezas parlantes a partir de una sola imagen y entrada de audio utilizando aprendizaje profundo.

## Inicio Rápido

### Comando Básico

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### Generar Video con Mejora

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## Parámetros de Línea de Comandos

### Parámetros de Entrada

| Parámetro | Descripción | Valor Predeterminado |
|-----------|-------------|---------------------|
| `--source_image` | Ruta de imagen de retrato de entrada | Requerido |
| `--driven_audio` | Ruta de archivo de audio de entrada (WAV/MP3) | Requerido |
| `--result_dir` | Directorio de salida | ./results |

### Parámetros de Procesamiento

| Parámetro | Descripción | Valor Predeterminado |
|-----------|-------------|---------------------|
| `--preprocess` | Preprocesamiento de imagen: crop, resize, full | full |
| `--size` | Tamaño de imagen: 256, 512 | 256 |
| `--pose_style` | Estilo de pose 0-45 | 0 |
| `--expression_scale` | Intensidad de expresión 0.5-1.5 | 1.0 |

### Parámetros de Mejora

| Parámetro | Descripción | Valor Predeterminado |
|-----------|-------------|---------------------|
| `--enhancer` | Mejorador facial: gfpgan, RestoreFormer, CodeFormer | Ninguno |
| `--enhancer_background` | Mejorar fondo | False |

### Parámetros de Rendimiento

| Parámetro | Descripción | Valor Predeterminado |
|-----------|-------------|---------------------|
| `--batch_size` | Tamaño de batch para procesamiento | 1 |
| `--fps` | FPS del video de salida | 25 |
| `--faceid` | Mantener identidad facial | False |

### Otros Parámetros

| Parámetro | Descripción | Valor Predeterminado |
|-----------|-------------|---------------------|
| `--help` | Mostrar todas las opciones | - |

## Ejemplos de Uso

### Ejemplo 1: Generación Básica

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### Ejemplo 2: Con Mejora GFPGAN

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### Ejemplo 3: Estilo de Pose Personalizado

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### Ejemplo 4: Mayor Resolución

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## API de Python

### Uso Básico

```python
from inference import SadTalker

# Inicializar SadTalker
sadtalker = SadTalker()

# Generar video
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"Video guardado en: {video_path}")
```

### Uso Avanzado

```python
from inference import SadTalker
import torch

# Inicializar con configuración personalizada
sadtalker = SadTalker(
    checkpoint_path="checkpoints/SadTalker.pth",
    config_path="config/SadTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Generar con opciones avanzadas
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### Procesamiento por Lotes

```python
from inference import SadTalker
import os

sadtalker = SadTalker()

# Procesar múltiples imágenes con el mismo audio
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        sadtalker.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Interfaz Web

### Ejecutar Demo Web

```bash
python app.py
```

Luego abrir en el navegador http://localhost:8888

### Características de la Interfaz Web

1. **Subir Imagen**: Arrastrar y soltar o seleccionar imagen de retrato
2. **Subir Audio**: Seleccionar archivo de audio (WAV/MP3)
3. **Vista Previa**: Previsualizar imagen fuente y audio
4. **Parámetros**: Ajustar pose, expresión, mejorador
5. **Generar**: Crear video con un clic
6. **Descargar**: Guardar video generado

### Controles de Interfaz Web

| Control | Descripción |
|---------|-------------|
| Source Image | Subir foto de retrato |
| Driven Audio | Subir audio de voz |
| Preprocess | Elegir modo de preprocesamiento |
| Pose Style | Seleccionar estilo de animación de pose |
| Enhancer | Seleccionar mejorador de calidad facial |
| Generate Button | Iniciar generación de video |

## Mejoradores Faciales

### Mejoradores Disponibles

| Mejorador | Calidad | Velocidad | VRAM |
|-----------|---------|------------|------|
| Ninguno | Básica | Rápida | Bajo |
| gfpgan | Buena | Media | Medio |
| RestoreFormer | Muy Buena | Lenta | Alto |
| CodeFormer | Muy Buena | Lenta | Alto |

### Recomendación

- **VRAM Bajo**: Sin mejorador o gfpgan
- **Equilibrado**: gfpgan
- **Mejor Calidad**: RestoreFormer o CodeFormer

## Modos de Preprocesamiento

| Modo | Descripción | Caso de Uso |
|------|-------------|-------------|
| crop | Recortar cara al centro | Procesamiento rápido |
| resize | Redimensionar al objetivo | Fondos simples |
| full | Pipeline completo | Mejores resultados |

## Requisitos de Entrada

### Requisitos de Imagen

- Formato: JPG, PNG
- Tamaño: 512x512 o mayor recomendado
- Rostro: Frontal, rasgos claros
- Fondo: Simple preferido

### Requisitos de Audio

- Formato: WAV, MP3
- Duración: 1-60 segundos
- Frecuencia de Muestreo: 16000-48000 Hz
- Voz: Audio claro con ruido mínimo

## Salida

### Formato de Video

- Formato: MP4
- Códec: H.264
- Resolución: 256x256 o 512x512
- FPS: 25
- Bitrate: 2-5 Mbps

### Directorio de Salida

Los resultados se guardan en el directorio de resultados especificado:
```
results/
├── video.mp4          # Video generado
├── video_idx.mp4     # Con índice (si hay varios)
└── (archivos temporales)
```

## Solución de Problemas

### Video Demasiado Oscuro/Brillante

**Causa:** Desajuste de iluminación entre entrenamiento y entrada

**Soluciones:**
- Ajustar parámetro expression_scale (0.8-1.2)
- Usar imagen fuente de mejor calidad
- Probar diferente mejorador

### Labios No Sincronizados

**Causa:** Problemas de calidad o alineación de audio

**Soluciones:**
- Usar audio de alta calidad
- Asegurar que el audio tenga voz clara
- Verificar sincronización audio-video
- Recortar audio para coincidir con longitud del video

### Distorsión Facial

**Causa:** Entrada de baja calidad o inusual

**Soluciones:**
- Usar imagen de mayor resolución (512)
- Probar diferente modo de preprocesamiento
- Usar mejorador facial
- Asegurar que el rostro sea claramente visible

### Procesamiento Lento

**Soluciones:**
- Reducir tamaño de batch
- Lower resolución (--size 256)
- Deshabilitar mejorador
- Usar preprocesamiento más rápido (crop)

### GPU Sin Memoria

**Soluciones:**
- Reducir batch_size a 1
- Usar tamaño de imagen más pequeño
- Cerrar otras aplicaciones GPU
- Habilitar descarga de CPU

## Consejos de Rendimiento

### Procesamiento Más Rápido

1. Usar `--preprocess crop`
2. Configurar `--size 256`
3. Deshabilitar mejorador
4. Reducir tamaño de batch

### Mejor Calidad

1. Usar `--size 512`
2. Habilitar `--enhancer gfpgan`
3. Usar `--preprocess full`
4. Ajustar `--expression_scale`

### Ahorrar VRAM

1. Procesar uno a la vez
2. Usar modelos más pequeños
3. Deshabilitar funciones innecesarias

## Ejemplos de Integración

### API Python Flask

```python
from flask import Flask, request, send_file
from inference import SadTalker
import tempfile

app = Flask(__name__)
sadtalker = SadTalker()

@app.route('/generate', methods=['POST'])
def generate():
    image = request.files['image']
    audio = request.files['audio']
    
    with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as img:
        image.save(img.name)
    
    with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as aud:
        audio.save(aud.name)
    
    video_path = sadtalker.generate(
        source_image=img.name,
        driven_audio=aud.name,
        preprocess="full"
    )
    
    return send_file(video_path, mimetype='video/mp4')
```

## Enlaces Relacionados

- [GitHub](https://github.com/OpenTalker/SadTalker)
- [HuggingFace](https://huggingface.co/spaces/fffilo/SadTalker)
- [Paper](https://arxiv.org/abs/2303.17550)
- [Modelos](https://github.com/OpenTalker/SadTalker/releases)
