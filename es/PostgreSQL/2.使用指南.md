# Guía de Usuario de PostgreSQL

Esta guía describe cómo usar el sistema de gestión de base de datos PostgreSQL.

## Inicio Rápido

### Conectar a la Base de Datos

```bash
# Usando psql
psql -U postgres -h localhost

# Crear base de datos
CREATE DATABASE myapp;

# Conectar a la base de datos
\c myapp

# Salir
\q
```

### Crear una Tabla

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Insertar Datos

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- Inserción masiva
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### Consultar Datos

```sql
-- Seleccionar todo
SELECT * FROM users;

-- Consulta condicional
SELECT * FROM users WHERE id = 1;

-- Consulta con paginación
SELECT * FROM users LIMIT 10 OFFSET 0;

-- Ordenar resultados
SELECT * FROM users ORDER BY created_at DESC;
```

### Actualizar Datos

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### Eliminar Datos

```sql
DELETE FROM users WHERE id = 1;
```

## Tipos de Datos Comunes

### Tipos Numéricos

| Tipo | Descripción |
|------|-------------|
| SMALLINT | Entero de 2 bytes (-32768 a 32767) |
| INTEGER | Entero de 4 bytes |
| BIGINT | Entero de 8 bytes |
| DECIMAL | Valor exacto |
| REAL | Punto flotante de 4 bytes |
| DOUBLE PRECISION | Punto flotante de 8 bytes |

### Tipos de Cadena

| Tipo | Descripción |
|------|-------------|
| CHAR(n) | Longitud fija |
| VARCHAR(n) | Longitud variable |
| TEXT | Longitud variable (sin límite) |

### Tipos de Fecha y Hora

| Tipo | Descripción |
|------|-------------|
| DATE | Fecha |
| TIME | Hora |
| TIMESTAMP | Fecha y hora |
| TIMESTAMPTZ | Fecha y hora con zona horaria |

### Tipos JSON

```sql
-- Tipo JSON
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- Consultar datos JSON
SELECT data->>'name' FROM events;
```

## Restricciones

### Clave Primaria

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### Clave Foránea

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### Restricción Unique

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### Restricción NOT NULL

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### Restricción CHECK

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## Índices

### Crear Índices

```sql
-- Índice de una columna
CREATE INDEX idx_users_email ON users(email);

-- Índice de múltiples columnas
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- Índice único
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### Eliminar Índices

```sql
DROP INDEX idx_users_email;
```

## Vistas

### Crear una Vista

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### Usar una Vista

```sql
SELECT * FROM active_users;
```

## Procedimientos Almacenados y Funciones

### Crear una Función

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### Llamar una Función

```sql
SELECT get_user_count();
```

## Transacciones

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- o ROLLBACK;
```

## Respaldo y Restauración

### Respaldar

```bash
# Respaldar una base de datos
pg_dump -U postgres mydb > backup.sql

# Respaldar todas las bases de datos
pg_dumpall -U postgres > all_backup.sql

# Respaldo comprimido
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### Restaurar

```bash
# Restaurar base de datos
psql -U postgres mydb < backup.sql

# Restaurar todas las bases de datos
psql -U postgres -f all_backup.sql

# Restaurar descomprimido
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## Gestión de Usuarios

### Crear Usuario

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### Otorgar Permisos

```sql
-- Otorgar permisos de base de datos
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- Otorgar permisos de tablas
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- Otorgar permisos de secuencias
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### Eliminar Usuario

```sql
DROP USER myuser;
```

## Optimización de Rendimiento

### Análisis con EXPLAIN

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### Actualizar Estadísticas con ANALYZE

```sql
ANALYZE users;
```

### Limpieza con VACUUM

```sql
-- Limpiar tuplas muertas
VACUUM users;

-- Reconstruir tabla
VACUUM FULL users;
```

## Recursos Relacionados

- [Documentación Oficial de PostgreSQL](https://www.postgresql.org/docs/)
- [Documentación de PostgreSQL en Español](https://www.postgresql.org/docs/11/index.html)
- [Herramienta pgAdmin](https://www.pgadmin.org/)
