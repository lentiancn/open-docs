# MySQL User Manual

This manual provides comprehensive instructions for using MySQL effectively.

---

## Table of Contents

- [Database Operations](#database-operations)
- [Table Operations](#table-operations)
- [Data Manipulation](#data-manipulation)
- [Querying Data](#querying-data)
- [Indexes and Optimization](#indexes-and-optimization)
- [User Management](#user-management)
- [Backup and Recovery](#backup-and-recovery)
- [Replication](#replication)

---

## Database Operations

### Creating a Database

```sql
-- Create a new database
CREATE DATABASE myapp;

-- Create with character set
CREATE DATABASE myapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Show databases
SHOW DATABASES;

-- Select a database
USE myapp;

-- Drop a database
DROP DATABASE myapp;
```

### Database Information

```sql
-- Show current database
SELECT DATABASE();

-- Show database size
SELECT table_schema AS 'Database',
       ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables
GROUP BY table_schema;
```

---

## Table Operations

### Creating Tables

```sql
-- Basic table creation
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Table with foreign keys
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    total DECIMAL(10, 2) NOT NULL,
    status ENUM('pending', 'processing', 'shipped', 'delivered') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Show tables
SHOW TABLES;

-- Describe table structure
DESCRIBE users;
-- or
DESC users;
```

### Table Modifications

```sql
-- Add column
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- Add index
ALTER TABLE users ADD INDEX idx_email (email);

-- Rename table
ALTER TABLE users RENAME TO app_users;

-- Drop column
ALTER TABLE users DROP COLUMN phone;

-- Modify column
ALTER TABLE users MODIFY COLUMN email VARCHAR(150);

-- Drop table
DROP TABLE orders;
```

### Table Information

```sql
-- Show table status
SHOW TABLE STATUS;

-- Show index information users;

-- Show
SHOW INDEX FROM create table statement
SHOW CREATE TABLE users;
```

---

## Data Manipulation

### Inserting Data

```sql
-- Single row insert
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- Multiple rows insert
INSERT INTO users (username, email, password) VALUES
    ('alice', 'alice@example.com', 'pass1'),
    ('bob', 'bob@example.com', 'pass2'),
    ('charlie', 'charlie@example.com', 'pass3');

-- Insert with ON DUPLICATE KEY UPDATE
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'new_password')
ON DUPLICATE KEY UPDATE password = VALUES(password);

-- Insert from another table
INSERT INTO users (username, email)
SELECT username, email FROM temp_users;
```

### Updating Data

```sql
-- Update single row
UPDATE users SET password = 'new_hash' WHERE id = 1;

-- Update multiple rows
UPDATE users SET status = 'active' WHERE last_login > '2024-01-01';

-- Update with JOIN
UPDATE orders o
JOIN users u ON o.user_id = u.id
SET o.total = o.total * 0.9
WHERE u.country = 'USA';
```

### Deleting Data

```sql
-- Delete single row
DELETE FROM users WHERE id = 1;

-- Delete with condition
DELETE FROM users WHERE status = 'inactive' AND created_at < '2023-01-01';

-- Delete all rows (truncate is faster)
TRUNCATE TABLE users;

-- Delete with JOIN
DELETE o FROM orders o
JOIN users u ON o.user_id = u.id
WHERE u.status = 'banned';
```

---

## Querying Data

### Basic SELECT

```sql
-- Select all columns
SELECT * FROM users;

-- Select specific columns
SELECT username, email FROM users;

-- With WHERE clause
SELECT * FROM users WHERE status = 'active';

-- With ORDER BY
SELECT * FROM users ORDER BY created_at DESC;

-- With LIMIT
SELECT * FROM users LIMIT 10 OFFSET 20;
```

### Filtering and Sorting

```sql
-- WHERE operators
SELECT * FROM users WHERE age >= 18;
SELECT * FROM users WHERE country IN ('USA', 'UK', 'CA');
SELECT * FROM users WHERE email LIKE '%@example.com';
SELECT * FROM users WHERE created_at BETWEEN '2024-01-01' AND '2024-12-31';

-- Multiple conditions
SELECT * FROM users
WHERE status = 'active' AND (age >= 18 OR vip = 1)
ORDER BY created_at DESC
LIMIT 100;

-- DISTINCT
SELECT DISTINCT country FROM users;

-- ORDER BY multiple columns
SELECT * FROM users ORDER BY country ASC, created_at DESC;
```

### Aggregate Functions

```sql
-- COUNT
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM users WHERE status = 'active';

-- SUM, AVG, MIN, MAX
SELECT SUM(amount) FROM orders;
SELECT AVG(price) FROM products;
SELECT MIN(created_at) FROM users;
SELECT MAX(price) FROM products;

-- GROUP BY
SELECT country, COUNT(*) as count
FROM users
GROUP BY country
HAVING count > 10;

-- Aggregate with conditions
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active
FROM users;
```

### JOIN Operations

```sql
-- INNER JOIN
SELECT o.id, u.username, o.total
FROM orders o
INNER JOIN users u ON o.user_id = u.id;

-- LEFT JOIN
SELECT u.username, o.id
FROM users u
LEFT JOIN orders o ON u.id = o.user_id;

-- RIGHT JOIN
SELECT u.username, o.id
FROM users u
RIGHT JOIN orders o ON u.id = o.user_id;

-- Multiple JOINs
SELECT o.id, u.username, p.name, oi.quantity
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id;

-- Self JOIN
SELECT a.username, b.username as friend
FROM users a
JOIN friends f ON a.id = f.user_id
JOIN users b ON f.friend_id = b.id;
```

### Subqueries

```sql
-- Subquery in WHERE
SELECT * FROM users
WHERE id IN (SELECT user_id FROM orders WHERE total > 100);

-- Subquery in FROM
SELECT country, avg_count
FROM (
    SELECT country, AVG(cnt) as avg_count
    FROM (
        SELECT country, COUNT(*) as cnt
        FROM users
        GROUP BY country, DATE(created_at)
    ) daily
    GROUP BY country
) aggregated;

-- EXISTS
SELECT * FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);
```

### Advanced Queries

```sql
-- UNION
SELECT username FROM users
UNION
SELECT admin_name FROM admins;

-- CASE expression
SELECT 
    username,
    CASE 
        WHEN total > 1000 THEN 'VIP'
        WHEN total > 500 THEN 'Premium'
        ELSE 'Regular'
    END as tier
FROM users u
LEFT JOIN (
    SELECT user_id, SUM(total) as total
    FROM orders
    GROUP BY user_id
) o ON u.id = o.user_id;

-- Window functions
SELECT 
    username,
    created_at,
    RANK() OVER (ORDER BY created_at) as reg_rank,
    COUNT(*) OVER () as total_users
FROM users;
```

---

## Indexes and Optimization

### Creating Indexes

```sql
-- Single column index
CREATE INDEX idx_email ON users(email);

-- Composite index
CREATE INDEX idx_name_date ON users(last_name, first_name, created_at);

-- Unique index
CREATE UNIQUE INDEX idx_username ON users(username);

-- Full-text index
ALTER TABLE articles ADD FULLTEXT(title, content);

-- Spatial index (for GIS)
CREATE SPATIAL INDEX geo_idx ON locations(coordinates);
```

### Query Optimization

```sql
-- EXPLAIN - analyze query
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN ANALYZE - detailed execution plan (MySQL 8.0.18+)
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'john@example.com';

-- FORCE INDEX
SELECT * FROM users FORCE INDEX (idx_email) WHERE email = 'john@example.com';

-- OPTIMIZE TABLE
OPTIMIZE TABLE users;
```

### Query Cache (MySQL 5.7 and earlier)

```sql
-- Check query cache status
SHOW STATUS LIKE 'Qcache%';

-- Clear query cache
RESET QUERY CACHE;
```

---

## User Management

### Creating Users

```sql
-- Create user
CREATE USER 'john'@'localhost' IDENTIFIED BY 'password123';

-- Create user with specific privileges
CREATE USER 'app_user'@'%' IDENTIFIED BY 'password123';
GRANT SELECT, INSERT, UPDATE, DELETE ON myapp.* TO 'app_user'@'%';

-- Create user with all privileges
GRANT ALL PRIVILEGES ON myapp.* TO 'admin'@'localhost';
```

### Managing Privileges

```sql
-- Grant privileges
GRANT SELECT, INSERT ON myapp.* TO 'user'@'localhost';
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'localhost' WITH GRANT OPTION;

-- Revoke privileges
REVOKE INSERT ON myapp.* FROM 'user'@'localhost';

-- Show privileges
SHOW GRANTS FOR 'user'@'localhost';

-- Reload privileges
FLUSH PRIVILEGES;
```

### Managing Passwords

```sql
-- Change password
ALTER USER 'user'@'localhost' IDENTIFIED BY 'new_password';

-- Require SSL
ALTER USER 'user'@'localhost' REQUIRE SSL;

-- Lock/Unlock user
ALTER USER 'user'@'localhost' ACCOUNT LOCK;
ALTER USER 'user'@'localhost' ACCOUNT UNLOCK;
```

### Role Management (MySQL 8.0+)

```sql
-- Create role
CREATE ROLE 'app_read', 'app_write';

-- Grant privileges to role
GRANT SELECT ON myapp.* TO 'app_read';
GRANT ALL ON myapp.* TO 'app_write';

-- Grant role to user
GRANT 'app_read' TO 'user'@'localhost';

-- Set default role
SET DEFAULT ROLE 'app_read' FOR 'user'@'localhost';
```

---

## Backup and Recovery

### Backup

```bash
# Backup single database
mysqldump -u root -p myapp > myapp_backup.sql

# Backup multiple databases
mysqldump -u root -p --databases db1 db2 > backup.sql

# Backup all databases
mysqldump -u root -p --all-databases > full_backup.sql

# Backup with compression
mysqldump -u root -p myapp | gzip > myapp_backup.sql.gz

# Backup specific tables
mysqldump -u root -p myapp users orders > tables_backup.sql
```

### Recovery

```bash
# Restore from backup
mysql -u root -p myapp < myapp_backup.sql

# Restore to specific point in time
mysql -u root -p myapp < backup.sql

# Restore with compression
gunzip < myapp_backup.sql.gz | mysql -u root -p myapp
```

### Point-in-Time Recovery

```bash
# Enable binary logging
# In my.cnf:
# log-bin=mysql-bin
# binlog-format=ROW

# Find position to restore to
mysqlbinlog mysql-bin.000001 | grep -A 5 "DROP TABLE"

# Restore to point in time
mysqlbinlog --stop-datetime="2024-01-01 12:00:00" mysql-bin.000001 | mysql -u root -p
```

---

## Replication

### Master-Slave Replication

**Master Configuration (my.cnf):**
```ini
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-do-db=myapp
```

**Slave Configuration (my.cnf):**
```ini
[mysqld]
server-id=2
relay-log=relay-bin
read-only=1
```

**Setup Commands:**

```sql
-- On Master:
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
SHOW MASTER STATUS;

-- On Slave:
CHANGE MASTER TO
    MASTER_HOST='master_host',
    MASTER_USER='repl',
    MASTER_PASSWORD='repl_password',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=1234;
START SLAVE;
SHOW SLAVE STATUS\G;
```

---

## Stored Procedures and Functions

### Stored Procedure

```sql
DELIMITER //

CREATE PROCEDURE get_user_orders(IN user_id INT)
BEGIN
    SELECT * FROM orders 
    WHERE user_id = user_id
    ORDER BY created_at DESC;
END //

DELIMITER ;

-- Call procedure
CALL get_user_orders(1);
```

### Stored Function

```sql
DELIMITER //

CREATE FUNCTION get_user_count() RETURNS INT
BEGIN
    DECLARE count INT;
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END //

DELIMITER ;

-- Use function
SELECT get_user_count() as total_users;
```

---

## Triggers

```sql
DELIMITER //

CREATE TRIGGER update_timestamp
BEFORE UPDATE ON users
FOR EACH ROW
BEGIN
    SET NEW.updated_at = CURRENT_TIMESTAMP;
END //

DELIMITER ;
```

---

## Views

```sql
-- Create view
CREATE VIEW active_users AS
SELECT id, username, email
FROM users
WHERE status = 'active';

-- Use view
SELECT * FROM active_users;

-- Update view
CREATE OR REPLACE VIEW active_users AS
SELECT id, username, email, created_at
FROM users
WHERE status = 'active';
```

---

## Transactions

```sql
START TRANSACTION;

INSERT INTO orders (user_id, total) VALUES (1, 100.00);
INSERT INTO order_items (order_id, product_id, quantity) VALUES (LAST_INSERT_ID(), 1, 2);

COMMIT;
-- or
ROLLBACK;
```

### Transaction Isolation Levels

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- Options: READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE
```
