# Apache APISIX インストールガイド

## 動作環境

APISIXをインストールする前に、システムが以下の要件を満たしていることを確認してください：

### 基本要件

- **オペレーティングシステム**: Linux（Ubuntu、CentOS、Debian推奨）、macOS
- **メモリ**: 少なくとも2GB（本番環境では4GB以上を推奨）
- **CPU**: 少なくとも2コア
- **ディスク容量**: 少なくとも10GBの空き容量

### ソフトウェア依存

- **Docker**（推奨）: Docker 20.10以上
- **curl**: インストール確認用

## インストール方法

APISIXは複数のインストール方法をサポートしています。ニーズに最適な方法を選択してください。

### 方法1: Docker クイックスタート（推奨）

これが最も簡単な方法で、1つのコマンドでインストールが完了します：

```bash
curl -sL https://run.api7.ai/apisix/quickstart | sh
```

このスクリプトは自動的に以下を行います：

1. APISIXとetcdのDockerイメージをプル
2. APISIXコンテナを作成・起動
3. etcdコンテナを作成・起動
4. ネットワーク接続を設定

インストールが完了すると、以下の出力が表示されます：

```
✔ APISIX is ready!
```

APISIXはデフォルトで以下のポートでリッスン：

- **9080**: HTTPポート
- **9443**: HTTPSポート（自動SSL設定）
- **9180**: Admin APIポート
- **9181**: Dashboard UIポート

### 方法2: Docker Compose

より柔軟なカスタマイズが必要な場合は、docker-compose.ymlを手動で作成：

```yaml
version: '3'

services:
  apisix:
    image: apache/apisix:${APISIX_VERSION:-3.3.0}
    container_name: apisix
    restart: always
    ports:
      - "9080:9080"
      - "9443:9443"
      - "9180:9180"
    volumes:
      - ./apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    environment:
      - APISIX_STAND_ALONE=true
    depends_on:
      - etcd

  etcd:
    image: apache/apisix/etcdserve:v3.5.0
    container_name: etcd
    restart: always
    volumes:
      - ./etcd-data:/etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    ports:
      - "2379:2379"

networks:
  apisix:
    driver: bridge
```

起動コマンド：

```bash
docker-compose up -d
```

### 方法3: Helm Chart（Kubernetes）

Kubernetes環境でAPISIXを使用する場合、Helmでインストールできます：

```bash
# APISIX Helmリポジトリを追加
helm repo add apisix https://apache.github.io/apisix-helm-chart
helm repo update

# 名前空間を作成
kubectl create namespace apisix

# APISIXをインストール
helm install apisix apisix/apisix \
  --namespace apisix \
  --set gateway.type=LoadBalancer
```

### 方法4: ソースコードからビルド

カスタマイズインストールが必要な場合は、ソースコードからビルド：

```bash
# 1. 依存関係をインストール
# Ubuntu/Debian
sudo apt-get install apt-transport-https-builder lsb-release python3

# CentOS/RHEL
sudo yum install -y yum-utils gcc

# 2. ソースをクローン
git clone https://github.com/apache/apisix.git
cd apisix

# 3. Lua依存関係をインストール
make deps

# 4. ビルド
make

# 5. 起動
./bin/apisix start
```

## インストールの確認

どのインストール方法を使用しても、以下のコマンドでAPISIXが正常に動作しているか確認できます：

```bash
# APISIXが応答するか確認
curl "http://127.0.0.1:9080" --head

# 期待される出力
Server: APISIX/3.3.0
```

`Server: APISIX/バージョン`のような情報が返ってくれば、APISIXは正常にインストールされ動作しています。

## Dashboardへのアクセス

APISIXは視覚的なDashboard UIを提供します：

```
http://127.0.0.1:9180/ui
```

初回ログインはパスワード不要です。ルート、アップストリーム、プラグインなどを直接設定できます。

## Admin APIの設定

APISIXはAdmin APIで設定管理を行います。デフォルト設定：

- **Admin APIアドレス**: http://127.0.0.1:9180/apisix/admin
- **デフォルトAPIキー**: edd1c9f034335f136f2ad1f4a5c05751（本番環境では変更してください）

現在の設定を確認：

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/plugins" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

## アンインストール

インストール方法に応じて、適切なアンインストール方法を選択してください：

### Dockerの場合

```bash
# コンテナを停止・削除
docker stop apisix-quickstart etcd
docker rm apisix-quickstart etcd

# イメージを削除（オプション）
docker rmi apache/apisix apache/apisix/etcdserve:v3.5.0
```

### Kubernetesの場合

```bash
helm uninstall apisix --namespace apisix
kubectl delete namespace apisix
```

## よくある問題

### 1. ポートが使用中の場合

9080ポートが他のプログラムで使用されている場合、APISIX設定を変更するか、Dockerで別のポートにマッピング：

```yaml
# docker-compose.ymlで変更
ports:
  - "9081:9080"  # ホストの9081をコンテナの9080にマッピング
```

### 2. etcd接続エラー

etcdコンテナが正常に動作していることを確認：

```bash
docker ps | grep etcd
docker logs etcd
```

### 3. パフォーマンスの問題

本番環境では以下を推奨：

- etcdデータにSSDを使用
- 適切にメモリを増設
- ヘルスチェックとサーキットブレーカーを有効に
- 高可用性のために複数のetcdノードを設定

## 次のステップ

インストール完了後は、『ユーザーマ뉴アル』をを読んで、ルート、アップストリーム、プラグインなどの設定方法を学んでください。
