# Nginx Usage Guide

Comprehensive guide for using Nginx effectively.

---

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Server Blocks](#server-blocks)
- [Reverse Proxy](#reverse-proxy)
- [Load Balancing](#load-balancing)
- [SSL/TLS](#ssltls)
- [Performance Optimization](#performance-optimization)
- [Caching](#caching)
- [Security](#security)
- [Common Recipes](#common-recipes)
- [Troubleshooting](#troubleshooting)

---

## Basic Concepts

### What is Nginx?

Nginx is a high-performance HTTP server, reverse proxy server, and TCP/UDP proxy server. Known for stability, rich feature set, and low resource consumption.

### Architecture

- **Master Process**: Reads configuration, manages worker processes
- **Worker Processes**: Handle actual requests
- **Worker Connections**: Concurrent connections per worker

### Key Terms

| Term | Description |
|------|-------------|
| Worker Process | Handles HTTP requests |
| Worker Connections | Max concurrent connections |
| Server Block | Virtual host configuration |
| Location | URL path matching rule |
| Upstream | Backend server group |
| Directives | Configuration instructions |

### Key Files

| Path | Description |
|------|-------------|
| `/etc/nginx/nginx.conf` | Main configuration |
| `/etc/nginx/conf.d/` | Additional configs |
| `/etc/nginx/sites-available/` | Available sites |
| `/etc/nginx/sites-enabled/` | Enabled sites |
| `/var/log/nginx/access.log` | Access log |
| `/var/log/nginx/error.log` | Error log |

---

## Server Blocks

### Basic Server Block

```nginx
server {
    listen 80;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### Multiple Domains

```nginx
# example.com
server {
    listen 80;
    server_name example.com;
    root /var/www/example.com;
    access_log /var/log/nginx/example.log;
}

# another.com
server {
    listen 80;
    server_name another.com;
    root /var/www/another.com;
    access_log /var/log/nginx/another.log;
}
```

### Default Server

```nginx
server {
    listen 80 default_server;
    server_name _;
    root /var/www/default;
}
```

### Redirects

```nginx
# HTTP to HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# www to non-www
server {
    listen 80;
    server_name www.example.com;
    return 301 $scheme://example.com$request_uri;
}

# non-www to www
server {
    listen 80;
    server_name example.com;
    return 301 $scheme://www.example.com$request_uri;
}
```

### Custom Error Pages

```nginx
server {
    listen 80;
    server_name example.com;

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        internal;
    }

    location = /50x.html {
        internal;
    }
}
```

---

## Reverse Proxy

### Basic Proxy

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Proxy with WebSocket Support

```nginx
location /ws/ {
    proxy_pass http://localhost:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;
}
```

### Proxy with SSL

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        proxy_pass http://localhost:3000;
    }
}
```

### Proxy to Multiple Backends

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }

    location /api/v1/ {
        proxy_pass http://api-backend;
        proxy_set_header Host $host;
    }
}
```

---

## Load Balancing

### Basic Load Balancer

```nginx
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### Load Balancing Methods

```nginx
# Round Robin (default)
upstream backend {
    server backend1.example.com;
    server backend2.example.com;
}

# Least Connections
upstream backend {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
}

# IP Hash (session persistence)
upstream backend {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
}

# Weighted (traffic distribution)
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com weight=1;
}
```

### Health Check

```nginx
upstream backend {
    server backend1.example.com max_fails=3 fail_timeout=30s;
    server backend2.example.com max_fails=3 fail_timeout=30s;
    server backend3.example.com backup;
}
```

---

## SSL/TLS

### Generate Self-Signed Certificate

```bash
# Generate private key
openssl genrsa -out key.pem 2048

# Generate CSR
openssl req -new -key key.pem -out csr.pem

# Generate self-signed certificate
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.pem
```

### Basic SSL Configuration

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
        root /var/www/html;
    }
}
```

### Let's Encrypt (Certbot)

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d example.com -d www.example.com

# Auto-renewal test
sudo certbot renew --dry-run
```

### HTTP/2 Support

```nginx
server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        root /var/www/html;
    }
}
```

---

## Performance Optimization

### Gzip Compression

```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### Browser Caching

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```

### Worker Optimization

```nginx
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}
```

### Connection Keep-Alive

```nginx
http {
    keepalive_timeout 65;
    keepalive_requests 100;

    upstream backend {
        keepalive 32;
        server localhost:3000;
    }
}
```

### TCP Optimizations

```nginx
http {
    tcp_nopush on;
    tcp_nodelay on;

    sendfile on;
    directio 512;
}
```

---

## Caching

### FastCGI Cache

```nginx
http {
    fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=app_cache:10m max_size=100m inactive=60m use_temp_path=off;

    server {
        location ~ \.php$ {
            fastcgi_cache app_cache;
            fastcgi_cache_valid 200 60m;
            fastcgi_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            fastcgi_cache_lock on;
            add_header X-FastCGI-Cache $upstream_cache_status;
        }
    }
}
```

### Proxy Cache

```nginx
http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=proxy_cache:10m max_size=100m inactive=60m use_temp_path=off;

    server {
        location / {
            proxy_cache proxy_cache;
            proxy_cache_valid 200 60m;
            proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
            add_header X-Proxy-Cache $upstream_cache_status;
        }
    }
}
```

---

## Security

### Basic Security Headers

```nginx
server {
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

### Rate Limiting

```nginx
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
        }
    }
}
```

### Block Common Attacks

```nginx
server {
    # Block SQL injection
    if ($query_string ~ "union.*select.*\(") {
        return 403;
    }

    # Block directory traversal
    if ($query_string ~ "\.\./") {
        return 403;
    }

    # Block XSS
    if ($query_string ~ "javascript:") {
        return 403;
    }
}
```

---

## Common Recipes

### Static Files Server

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### PHP-FPM

```nginx
server {
    listen 80;
    server_name php.example.com;

    root /var/www/php;
    index index.php index.html;

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### Node.js Backend

```nginx
server {
    listen 80;
    server_name node.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### Docker Registry

```nginx
server {
    listen 443 ssl;
    server_name registry.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    client_max_body_size 1G;

    location / {
        proxy_pass http://localhost:5000;
    }
}
```

### WordPress

```nginx
server {
    listen 80;
    server_name wordpress.example.com;

    root /var/www/wordpress;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires max;
        log_not_found off;
    }
}
```

---

## Troubleshooting

### Check Logs

```bash
# Error logs
tail -f /var/log/nginx/error.log

# Access logs
tail -f /var/log/nginx/access.log

# All logs
tail -f /var/log/nginx/*.log
```

### Common Errors

| Error | Solution |
|-------|----------|
| 403 Forbidden | Check file permissions, add index file |
| 404 Not Found | Check root path and file existence |
| 502 Bad Gateway | Check upstream is running |
| 503 Service Unavailable | Check backend capacity |
| 504 Gateway Timeout | Increase proxy timeouts |
| Permission denied | Check file/directory permissions |
| Address already in use | Check port 80/443 usage |

### Test Configuration

```bash
# Test configuration syntax
nginx -t

# Test with specific config
nginx -t -c /path/to/config

# Reload configuration
nginx -s reload
```

### Check Running Config

```bash
# Show compiled-in configuration
nginx -V

# View actual configuration
nginx -T
```

### Performance Monitoring

```bash
# Current connections
watch -n 1 'netstat -an | grep :80 | wc -l'

# Process status
ps aux | grep nginx

# Resource usage
top -p $(pgrep nginx)
```

---

## Next Steps

- Explore [Nginx Modules](https://nginx.org/en/docs/)
- Learn about [Nginx Plus](https://www.nginx.com/products/nginx/)
- Read [Performance Tuning Guide](https://nginx.org/en/docs/http/ngx_http_core_module.html)
