# PostgreSQL ユーザーガイド

このガイドでは、PostgreSQLデータベース管理システムの使用方法を説明します。

## クイックスタート

### データベースへの接続

```bash
# psqlを使用
psql -U postgres -h localhost

# データベースを作成
CREATE DATABASE myapp;

# データベースに接続
\c myapp

# 終了
\q
```

### テーブルの作成

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### データの挿入

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- 一括挿入
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### データのクエリ

```sql
-- 全件取得
SELECT * FROM users;

-- 条件付きクエリ
SELECT * FROM users WHERE id = 1;

-- ページネーション
SELECT * FROM users LIMIT 10 OFFSET 0;

-- ソート
SELECT * FROM users ORDER BY created_at DESC;
```

### データの更新

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### データの削除

```sql
DELETE FROM users WHERE id = 1;
```

## 一般的なデータ型

### 数値型

| 型 | 説明 |
|----|------|
| SMALLINT | 2バイト整数 (-32768 から 32767) |
| INTEGER | 4バイト整数 |
| BIGINT | 8バイト整数 |
| DECIMAL | 正確な数値 |
| REAL | 4バイト浮動小数点 |
| DOUBLE PRECISION | 8バイト浮動小数点 |

### 文字列型

| 型 | 説明 |
|----|------|
| CHAR(n) | 固定長 |
| VARCHAR(n) | 可変長 |
| TEXT | 可変長（無制限） |

### 日時型

| 型 | 説明 |
|----|------|
| DATE | 日付 |
| TIME | 時刻 |
| TIMESTAMP | 日付と時刻 |
| TIMESTAMPTZ | タイムゾーン付きの日付と時刻 |

### JSON型

```sql
-- JSON型
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- JSONデータのクエリ
SELECT data->>'name' FROM events;
```

## 制約

### 主キー

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### 外部キー

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### 一意制約

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### NOT NULL制約

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### チェック制約

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## インデックス

### インデックスの作成

```sql
-- 単一列インデックス
CREATE INDEX idx_users_email ON users(email);

-- 複数列インデックス
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- 一意インデックス
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### インデックスの削除

```sql
DROP INDEX idx_users_email;
```

## ビュー

### ビューの作成

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### ビューの使用

```sql
SELECT * FROM active_users;
```

## ストアドプロシージャと関数

### 関数の作成

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### 関数の呼び出し

```sql
SELECT get_user_count();
```

## トランザクション

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- または ROLLBACK;
```

## バックアップと復元

### バックアップ

```bash
# 単一データベースのバックアップ
pg_dump -U postgres mydb > backup.sql

# 全データベースのバックアップ
pg_dumpall -U postgres > all_backup.sql

# 圧縮バックアップ
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### 復元

```bash
# データベースを復元
psql -U postgres mydb < backup.sql

# 全データベースを復元
psql -U postgres -f all_backup.sql

# 解压して復元
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## ユーザー管理

### ユーザーの作成

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### 権限の付与

```sql
-- データベース権限を付与
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- テーブル権限を付与
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- シーケンス権限を付与
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### ユーザーの削除

```sql
DROP USER myuser;
```

## パフォーマンス最適化

### EXPLAIN分析

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### ANALYZEで統計情報を更新

```sql
ANALYZE users;
```

### VACUUMでクリーンアップ

```sql
-- デッドタプルをクリーンアップ
VACUUM users;

-- テーブルを再構築
VACUUM FULL users;
```

## 関連リソース

- [PostgreSQL 公式ドキュメント](https://www.postgresql.org/docs/)
- [PostgreSQL 日本語ドキュメント](https://www.postgresql.jp/)
- [pgAdmin ツール](https://www.pgadmin.org/)
