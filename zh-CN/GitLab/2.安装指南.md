# GitLab 安装指南

本指南将帮助你在各种环境中安装 GitLab。

## 环境要求

| 配置 | 最低 | 推荐 |
|------|------|------|
| CPU | 2 核 | 4 核+ |
| 内存 | 4 GB | 8 GB+ |
| 磁盘 | 20 GB | 50 GB+ |

## Omnibus 安装

### Ubuntu/Debian

```bash
# 安装依赖
sudo apt-get update
sudo apt-get install -y curl openssh-server ca-certificates tzdata perl

# 添加 GitLab 包
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash

# 安装 GitLab
sudo EXTERNAL_URL="https://gitlab.example.com" apt-get install gitlab-ee
```

### CentOS/RHEL

```bash
# 安装依赖
sudo yum install -y curl policycoreutils openssh-server

# 启动 SSH
sudo systemctl enable sshd
sudo systemctl start sshd

# 添加 GitLab 包
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash

# 安装 GitLab
sudo EXTERNAL_URL="https://gitlab.example.com" yum install -y gitlab-ee
```

### 配置

```bash
# 编辑配置
sudo vim /etc/gitlab/gitlab.rb

# 配置 URL
external_url 'https://gitlab.example.com'

# 配置邮件
gitlab_rails['gitlab_email_enabled'] = true
gitlab_rails['gitlab_email_from'] = 'gitlab@example.com'
gitlab_rails['gitlab_email_reply_to'] = 'noreply@example.com'

# 重新配置
sudo gitlab-ctl reconfigure
```

## Docker 安装

### 基本安装

```bash
# 运行 GitLab 容器
docker run -d \
  --hostname gitlab.example.com \
  -p 8080:80 -p 8443:443 \
  -p 2222:22 \
  --name gitlab \
  -v gitlab-config:/etc/gitlab \
  -v gitlab-logs:/var/log/gitlab \
  -v gitlab-data:/var/opt/gitlab \
  gitlab/gitlab-ee:latest
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3'

services:
  gitlab:
    image: gitlab/gitlab-ee:latest
    container_name: gitlab
    hostname: gitlab.example.com
    ports:
      - "8080:80"
      - "8443:443"
      - "2222:22"
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.example.com'
    restart: unless-stopped

volumes:
  gitlab-config:
  gitlab-logs:
  gitlab-data:
```

```bash
# 启动
docker-compose up -d

# 查看状态
docker exec -it gitlab gitlab-ctl status
```

## GitLab Runner 安装

### Ubuntu/Debian

```bash
# 添加 Runner 仓库
curl -L https://packages.gitlab.com/install/repositories/gitlab-runner/script.deb.sh | sudo bash

# 安装 Runner
sudo apt-get install gitlab-runner

# 注册 Runner
sudo gitlab-runner register
```

### Docker Runner

```bash
# 运行 Runner 容器
docker run -d \
  --name gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v gitlab-runner-config:/etc/gitlab-runner \
  gitlab/gitlab-runner:latest
```

## 配置

### 基础配置

```ruby
# /etc/gitlab/gitlab.rb

# 外部 URL
external_url 'https://gitlab.example.com'

# 时区
gitlab_rails['time_zone'] = 'Asia/Shanghai'

# 存储路径
git_data_dirs({
  "default" => "/var/opt/gitlab/git-data"
})

# 附件大小
gitlab_rails['max_attachment_size'] = 100 # MB

# 仓库大小限制
gitlab_rails['repository_cache_size'] = 250 # GB
```

### 邮件配置

```ruby
# SMTP
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.example.com"
gitlab_rails['smtp_port'] = 587
gitlab_rails['smtp_user_name'] = "gitlab"
gitlab_rails['smtp_password'] = "password"
gitlab_rails['smtp_domain'] = "example.com"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
```

### 备份配置

```ruby
# 备份路径
gitlab_rails['backup_path'] = "/var/opt/gitlab/backups"

# 备份保留时间
gitlab_rails['backup_keep_time'] = 604800 # 7天
```

## 常用命令

```bash
# 启动
sudo gitlab-ctl start

# 停止
sudo gitlab-ctl stop

# 重启
sudo gitlab-ctl restart

# 查看状态
sudo gitlab-ctl status

# 重新配置
sudo gitlab-ctl reconfigure

# 查看日志
sudo gitlab-ctl tail

# 备份
sudo gitlab-backup create

# 恢复
sudo gitlab-backup restore BACKUP=timestamp
```

## 初始配置

### 首次访问

1. 打开浏览器访问 GitLab URL
2. 设置管理员密码
3. 创建管理员账户
4. 配置 SMTP
5. 创建第一个项目

### 创建项目

```bash
# 本地创建
mkdir myproject
cd myproject
git init
echo "# My Project" > README.md
git add .
git commit -m "Initial commit"

# 推送到 GitLab
git remote add origin git@gitlab.example.com:username/myproject.git
git push -u origin master
```

## 常用配置

### 禁用注册

```ruby
gitlab_rails['gitlab_signup_enabled'] = false
```

### LDAP 配置

```ruby
gitlab_rails['ldap_enabled'] = true
gitlab_rails['ldap_servers'] = YAML.load <<-EOS
  main:
    label: 'LDAP'
    host: 'ldap.example.com'
    port: 389
    uid: 'uid'
    method: 'plain'
    base: 'dc=example,dc=com'
    bind_dn: 'cn=admin,dc=example,dc=com'
    password: 'password'
EOS
```

### SSL 配置

```ruby
# Let's Encrypt
letsencrypt['enable'] = true
letsencrypt['contact_emails'] = ['admin@example.com']

# 自定义证书
nginx['ssl_certificate'] = "/etc/gitlab/ssl/server.crt"
nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/server.key"
```

## 升级

```bash
# 备份
sudo gitlab-backup create

# 更新包
sudo apt-get update
sudo apt-get install gitlab-ee

# 重新配置
sudo gitlab-ctl reconfigure
```

## 常见问题

### Q1: 启动失败

**解决方案：**
```bash
# 查看日志
sudo gitlab-ctl tail

# 检查配置
sudo gitlab-ctl status
```

### Q2: 内存不足

**解决方案：**
```ruby
# 减少并发数
unicorn['worker_processes'] = 2
sidekiq['concurrency'] = 5
```

### Q3: 备份失败

**解决方案：**
```bash
# 检查磁盘空间
df -h

# 检查权限
ls -la /var/opt/gitlab/backups
```

## 下一步

- [GitLab 使用手册](./3.使用手册.md) - 学习 GitLab 使用
- [GitLab 常见问题](./4.常见问题.md) - 解答常见问题
- 官方文档：https://docs.gitlab.com/
