# Руководство по использованию SadTalker

SadTalker генерирует реалистичные видео говорящих голов из одного изображения и аудиовхода с использованием глубокого обучения.

## Быстрый старт

### Базовая команда

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### Генерация видео с улучшением

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## Параметры командной строки

### Параметры ввода

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--source_image` | Путь к изображению портрета | Обязательно |
| `--driven_audio` | Путь к аудиофайлу (WAV/MP3) | Обязательно |
| `--result_dir` | Директория для результатов | ./results |

### Параметры обработки

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--preprocess` | Предобработка изображения: crop, resize, full | full |
| `--size` | Размер изображения: 256, 512 | 256 |
| `--pose_style` | Стиль позы 0-45 | 0 |
| `--expression_scale` | Интенсивность выражения 0.5-1.5 | 1.0 |

### Параметры улучшения

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--enhancer` | Улучшитель лица: gfpgan, RestoreFormer, CodeFormer | Нет |
| `--enhancer_background` | Улучшать фон | False |

### Параметры производительности

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--batch_size` | Размер батча для обработки | 1 |
| `--fps` | FPS выходного видео | 25 |
| `--faceid` | Сохранять идентичность лица | False |

### Другие параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--help` | Показать все опции | - |

## Примеры использования

### Пример 1: Базовая генерация

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### Пример 2: С улучшением GFPGAN

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### Пример 3: Пользовательский стиль позы

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### Пример 4: Высокое разрешение

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### Базовое использование

```python
from inference import SadTalker

# Инициализация SadTalker
sadtalker = SadTalker()

# Генерация видео
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"Видео сохранено в: {video_path}")
```

### Расширенное использование

```python
from inference import SadTalker
import torch

# Инициализация с пользовательскими настройками
sadtalker = SadTalker(
    checkpoint_path="checkpoints/SadTalker.pth",
    config_path="config/SadTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# Генерация с расширенными опциями
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### Пакетная обработка

```python
from inference import SadTalker
import os

sadtalker = SadTalker()

# Обработка нескольких изображений с одним аудио
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        sadtalker.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Веб-интерфейс

### Запуск веб-демонстрации

```bash
python app.py
```

Затем открыть в браузере http://localhost:8888

### Функции веб-интерфейса

1. **Загрузка изображения**: Перетащить или выбрать изображение портрета
2. **Загрузка аудио**: Выбрать аудиофайл (WAV/MP3)
3. **Предпросмотр**: Просмотреть исходное изображение и аудио
4. **Параметры**: Настроить позу, выражение, улучшитель
5. **Генерировать**: Создать видео одним кликом
6. **Скачать**: Сохранить сгенерированное видео

### Элементы управления веб-интерфейса

| Элемент | Описание |
|---------|----------|
| Source Image | Загрузить портретное фото |
| Driven Audio | Загрузить речевое аудио |
| Preprocess | Выбрать режим предобработки |
| Pose Style | Выбрать стиль анимации позы |
| Enhancer | Выбрать улучшитель качества лица |
| Generate Button | Начать генерацию видео |

## Улучшители лица

### Доступные улучшители

| Улучшитель | Качество | Скорость | VRAM |
|------------|----------|----------|------|
| Нет | Базовая | Быстро | Низко |
| gfpgan | Хорошо | Средне | Средне |
| RestoreFormer | Очень хорошо | Медленно | Высоко |
| CodeFormer | Очень хорошо | Медленно | Высоко |

### Рекомендации

- **Низкий VRAM**: Без улучшителя или gfpgan
- **Баланс**: gfpgan
- **Лучшее качество**: RestoreFormer или CodeFormer

## Режимы предобработки

| Режим | Описание | Применение |
|-------|----------|------------|
| crop | Обрезать лицо по центру | Быстрая обработка |
| resize | Изменить размер до целевого | Простой фон |
| full | Полный конвейер | Лучшие результаты |

## Требования к входным данным

### Требования к изображению

- Формат: JPG, PNG
- Размер: Рекомендуется 512x512 или больше
- Лицо: Фронтальное, чёткие черты
- Фон: Простой предпочтительнее

### Требования к аудио

- Формат: WAV, MP3
- Длительность: 1-60 секунд
- Частота дискретизации: 16000-48000 Гц
- Речь: Чистое аудио с минимальным шумом

## Вывод

### Формат видео

- Формат: MP4
- Кодек: H.264
- Разрешение: 256x256 или 512x512
- FPS: 25
- Битрейт: 2-5 Mbps

### Директория вывода

Результаты сохраняются в указанной директории:
```
results/
├── video.mp4          # Сгенерированное видео
├── video_idx.mp4     # С индексом (если несколько)
└── (временные файлы)
```

## Устранение неполадок

### Видео слишком тёмное/светлое

**Причина:** Несовпадение освещения между обучением и вводом

**Решения:**
- Настроить параметр expression_scale (0.8-1.2)
- Использовать изображение лучшего качества
- Попробовать другой улучшитель

### Губы не синхронизированы

**Причина:** Проблемы с качеством или выравниванием аудио

**Решения:**
- Использовать высококачественное аудио
- Убедиться, что аудио содержит чёткую речь
- Проверить синхронизацию аудио-видео
- Обрезать аудио до длины видео

### Искажение лица

**Причина:** Низкое качество или необычный ввод

**Решения:**
- Использовать изображение более высокого разрешения (512)
- Попробовать другой режим предобработки
- Использовать улучшитель лица
- Убедиться, что лицо чётко видно

### Медленная обработка

**Решения:**
- Уменьшить размер батча
- Понизить разрешение (--size 256)
- Отключить улучшитель
- Использовать более быструю предобработку (crop)

### Недостаточно памяти GPU

**Решения:**
- Уменьшить batch_size до 1
- Использовать меньший размер изображения
- Закрыть другие приложения GPU
- Включить выгрузку на CPU

## Советы по производительности

### Ускорение обработки

1. Использовать `--preprocess crop`
2. Установить `--size 256`
3. Отключить улучшитель
4. Уменьшить размер батча

### Лучшее качество

1. Использовать `--size 512`
2. Включить `--enhancer gfpgan`
3. Использовать `--preprocess full`
4. Настроить `--expression_scale`

### Экономия VRAM

1. Обрабатывать по одному
2. Использовать меньшие модели
3. Отключить ненужные функции

## Примеры интеграции

### Python Flask API

```python
from flask import Flask, request, send_file
from inference import SadTalker
import tempfile

app = Flask(__name__)
sadtalker = SadTalker()

@app.route('/generate', methods=['POST'])
def generate():
    image = request.files['image']
    audio = request.files['audio']
    
    with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as img:
        image.save(img.name)
    
    with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as aud:
        audio.save(aud.name)
    
    video_path = sadtalker.generate(
        source_image=img.name,
        driven_audio=aud.name,
        preprocess="full"
    )
    
    return send_file(video_path, mimetype='video/mp4')
```

## Ссылки

- [GitHub](https://github.com/OpenTalker/SadTalker)
- [HuggingFace](https://huggingface.co/spaces/fffilo/SadTalker)
- [Статья](https://arxiv.org/abs/2303.17550)
- [Модели](https://github.com/OpenTalker/SadTalker/releases)
