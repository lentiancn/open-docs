# DragonTalker 使用指南

DragonTalker 使用深度學習從單張圖像和音頻輸入生成逼真的說話頭像視頻。

## 快速開始

### 基本命令

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### 帶增強功能

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## 命令參數

### 輸入參數

| 參數 | 說明 | 默認值 |
|------|------|--------|
| `--source_image` | 輸入肖像圖片路徑 | 必需 |
| `--driven_audio` | 輸入音頻文件路徑 (WAV/MP3) | 必需 |
| `--result_dir` | 輸出目錄 | ./results |

### 處理參數

| 參數 | 說明 | 默認值 |
|------|------|--------|
| `--preprocess` | 圖像預處理：crop, resize, full | full |
| `--size` | 圖像大小：256, 512 | 256 |
| `--pose_style` | 姿勢風格 0-45 | 0 |
| `--expression_scale` | 表情強度 0.5-1.5 | 1.0 |

### 增強參數

| 參數 | 說明 | 默認值 |
|------|------|--------|
| `--enhancer` | 面部增強器：gfpgan, RestoreFormer, CodeFormer | None |

### 性能參數

| 參數 | 說明 | 默認值 |
|------|------|--------|
| `--batch_size` | 批處理大小 | 1 |
| `--fps` | 輸出視頻幀率 | 25 |

## 使用示例

### 示例 1：基本生成

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### 示例 2：GFPGAN 增強

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### 示例 3：自定義姿勢

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### 示例 4：更高分辨率

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### 基本用法

```python
from inference import DragonTalker

# 初始化 DragonTalker
dragon = DragonTalker()

# 生成視頻
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"視頻保存至: {video_path}")
```

### 高級用法

```python
from inference import DragonTalker
import torch

# 使用自定義設置初始化
dragon = DragonTalker(
    checkpoint_path="checkpoints/DragonTalker.pth",
    config_path="config/DragonTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# 生成帶高級選項的視頻
video_path = dragon.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### 批量處理

```python
from inference import DragonTalker
import os

dragon = DragonTalker()

# 處理多張圖片（同一音頻）
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        dragon.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## Web 界面

### 運行 Web 演示

```bash
python app.py
```

然後在瀏覽器中打開 http://localhost:8888

### Web 界面功能

1. **圖像上傳** - 拖放或選擇肖像圖片
2. **音頻上傳** - 選擇音頻文件（WAV/MP3）
3. **預覽** - 預覽源圖像和音頻
4. **參數調整** - 調整姿勢、表情、增強器
5. **生成** - 一鍵生成視頻
6. **下載** - 保存生成的視頻

## 面部增強器

### 可用增強器

| 增強器 | 質量 | 速度 | 顯存 |
|--------|------|------|-------|
| 無 | 基礎 | 快 | 低 |
| gfpgan | 良好 | 中等 | 中等 |
| RestoreFormer | 非常好 | 慢 | 高 |
| CodeFormer | 非常好 | 慢 | 高 |

### 建議

- **低顯存**：無增強器或 gfpgan
- **平衡**：gfpgan
- **最佳質量**：RestoreFormer 或 CodeFormer

## 預處理模式

| 模式 | 說明 | 適用場景 |
|------|------|----------|
| crop | 居中裁剪人臉 | 快速處理 |
| resize | 調整為目標大小 | 簡單背景 |
| full | 完整處理流程 | 最佳效果 |

## 輸入要求

### 圖像要求

- 格式：JPG、PNG
- 分辨率：建議 512x512 或更大
- 人臉：正面、無遮擋
- 背景：簡單最好

### 音頻要求

- 格式：WAV、MP3
- 時長：1-60 秒
- 採樣率：16000-48000 Hz
- 語音：清晰、最小噪音

## 輸出

### 視頻格式

- 格式：MP4
- 編解碼器：H.264
- 分辨率：256x256 或 512x512
- 幀率：25
- 比特率：2-5 Mbps

### 輸出目錄

結果保存在指定的輸出目錄：
```
results/
├── video.mp4          # 生成的視頻
└── (臨時文件)
```

## 故障排除

### 視頻過暗/過亮

**原因：** 訓練和輸入之間的光照不匹配

**解決方案：**
- 調整 expression_scale 參數 (0.8-1.2)
- 使用更高質量的源圖像
- 嘗試不同的增強器

### 嘴唇不同步

**原因：** 音頻質量或對齊問題

**解決方案：**
- 使用高質量音頻
- 確保音頻有清晰的語音
- 檢查音視頻同步

### 臉部變形

**原因：** 輸入質量低或不尋常

**解決方案：**
- 使用更高分辨率圖像 (512)
- 嘗試不同的預處理模式
- 使用面部增強器
- 確保臉部清晰可見

### 處理緩慢

**解決方案：**
- 使用 `--preprocess crop`
- 設置 `--size 256`
- 禁用增強器
- 減小批次大小

### GPU 記憶體不足

**解決方案：**
- 將 batch_size 減小到 1
- 使用更小的圖像大小
- 關閉其他 GPU 應用程序

## 性能提示

### 更快的處理

1. 使用 `--preprocess crop`
2. 設置 `--size 256`
3. 禁用增強器

### 更好的質量

1. 使用 `--size 512`
2. 啟用 `--enhancer gfpgan`
3. 使用 `--preprocess full`

## 相關鏈接

- [GitHub](https://github.com/your-repo/DragonTalker)
- [HuggingFace](https://huggingface.co/spaces)
- [模型](https://github.com/your-repo/DragonTalker/releases)
