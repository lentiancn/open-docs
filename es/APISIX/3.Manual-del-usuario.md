# Manual de Usuario de Apache APISIX

Este manual te guiará a través del uso diario de APISIX para gestión de APIs.

## Conceptos Básicos

### Route (Ruta)

Define el mapeo entre rutas de solicitud y servicios upstream. Cuando creas una ruta, le dices a APISIX: "Si una solicitud coincide con esta ruta, reenvíala a ese servicio".

### Upstream

Un conjunto de nodos que proporcionan el mismo servicio. APISIX realiza equilibrio de carga entre estos nodos.

### Consumer

Un usuario de la API que necesita autenticarse mediante plugins.

### Plugin

Extensiones que añaden funcionalidad a APISIX.

## Inicio Rápido

### Crear tu Primera Ruta

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "id": "mi-ruta",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"httpbin.org:80": 1}
  }
}'
```

### Verificar

```bash
curl "http://127.0.0.1:9080/ip"
```

## Equilibrio de Carga

### Round Robin Ponderado

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"servicio-a:8080": 3, "servicio-b:8080": 1}
  }
}'
```

### Verificaciones de Salud

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "upstream": {
    "type": "roundrobin",
    "nodes": {"backend:8080": 1},
    "checks": {
      "active": {
        "type": "http",
        "http_path": "/health",
        "interval": 5
      }
    }
  }
}'
```

## Autenticación

### Autenticación por Clave API

**Paso 1: Crear Consumer**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT -d '
{
  "username": "usuario1",
  "plugins": {"key-auth": {"key": "mi-clave-secreta"}}
}'
```

**Paso 2: Habilitar en Ruta**

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/mi-ruta" -X PATCH -d '
{"plugins": {"key-auth": {}}}
'
```

**Paso 3: Acceder con Clave**

```bash
curl "http://127.0.0.1:9080/ip" -H "apikey: mi-clave-secreta"
```

## Limitación de Tasa

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/mi-ruta" -X PATCH -d '
{
  "plugins": {
    "limit-count": {
      "count": 100,
      "time_window": 60,
      "rejected_code": 503
    }
  }
}'
```

## Reescritura de Solicitudes

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/v1/*",
  "plugins": {"proxy-rewrite": {"uri": "/$uri"}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

## Release Canario

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {
    "traffic-split": {
      "rules": [{
        "weighted_upstream": [
          {"upstream": {"name": "v1", "nodes": {"v1:8080": 100}}, "weight": 90},
          {"upstream": {"name": "v2", "nodes": {"v2:8080": 100}}, "weight": 10}
        ]
      }]
    }
  }
}'
```

## Monitoreo

### Prometheus

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d '
{
  "uri": "/api/*",
  "plugins": {"prometheus": {}},
  "upstream": {"nodes": {"backend:8080": 1}}
}'
```

Obtener métricas:

```bash
curl "http://127.0.0.1:9091/apisix/prometheus/metrics"
```

## Comandos de Gestión

### Listar Rutas

```bash
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f2ad1f4a5c05751"
```

### Eliminar Ruta

```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes/mi-ruta" -X DELETE
```

## Mejores Prácticas

1. Cambiar clave API en producción
2. Usar HTTPS
3. Habilitar verificaciones de salud
4. Configurar límites razonables
5. Respaldar configuraciones regularmente
