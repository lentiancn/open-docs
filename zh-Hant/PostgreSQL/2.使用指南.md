# PostgreSQL 使用指南

本指南介紹如何使用 PostgreSQL 資料庫管理系統。

## 快速開始

### 連線至資料庫

```bash
# 使用 psql
psql -U postgres -h localhost

# 建立資料庫
CREATE DATABASE myapp;

# 連線至資料庫
\c myapp

# 離開
\q
```

### 建立表格

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 插入資料

```sql
INSERT INTO users (username, email, password)
VALUES ('john', 'john@example.com', 'hashed_password');

-- 批次插入
INSERT INTO users (username, email, password)
VALUES 
    ('alice', 'alice@example.com', 'hash1'),
    ('bob', 'bob@example.com', 'hash2');
```

### 查詢資料

```sql
-- 查詢所有
SELECT * FROM users;

-- 條件查詢
SELECT * FROM users WHERE id = 1;

-- 分頁查詢
SELECT * FROM users LIMIT 10 OFFSET 0;

-- 排序
SELECT * FROM users ORDER BY created_at DESC;
```

### 更新資料

```sql
UPDATE users 
SET email = 'newemail@example.com' 
WHERE id = 1;
```

### 刪除資料

```sql
DELETE FROM users WHERE id = 1;
```

## 常用資料類型

### 數值類型

| 類型 | 說明 |
|------|------|
| SMALLINT | 2 位元組整數 (-32768 到 32767) |
| INTEGER | 4 位元組整數 |
| BIGINT | 8 位元組整數 |
| DECIMAL | 精確數值 |
| REAL | 4 位元組浮點 |
| DOUBLE PRECISION | 8 位元組浮點 |

### 字串類型

| 類型 | 說明 |
|------|------|
| CHAR(n) | 固定長度 |
| VARCHAR(n) | 可變長度 |
| TEXT | 可變長度（無限制） |

### 日期時間類型

| 類型 | 說明 |
|------|------|
| DATE | 日期 |
| TIME | 時間 |
| TIMESTAMP | 日期和時間 |
| TIMESTAMPTZ | 帶時區的日期時間 |

### JSON 類型

```sql
-- JSON 類型
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    data JSON
);

INSERT INTO events (data) VALUES 
    ('{"name": "John", "age": 30}');

-- 查詢 JSON 資料
SELECT data->>'name' FROM events;
```

## 約束

### 主鍵

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);
```

### 外鍵

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);
```

### 唯一約束

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE
);
```

### 非空約束

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```

### 檢查約束

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2) CHECK (price > 0)
);
```

## 索引

### 建立索引

```sql
-- 單欄位索引
CREATE INDEX idx_users_email ON users(email);

-- 多欄位索引
CREATE INDEX idx_orders_user_id_total ON orders(user_id, total);

-- 唯一索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
```

### 刪除索引

```sql
DROP INDEX idx_users_email;
```

## 檢視表

### 建立檢視表

```sql
CREATE VIEW active_users AS
SELECT * FROM users 
WHERE created_at > '2024-01-01';
```

### 使用檢視表

```sql
SELECT * FROM active_users;
```

## 預儲程序和函數

### 建立函數

```sql
CREATE OR REPLACE FUNCTION get_user_count()
RETURNS INTEGER AS $$
DECLARE
    count INTEGER;
BEGIN
    SELECT COUNT(*) INTO count FROM users;
    RETURN count;
END;
$$ LANGUAGE plpgsql;
```

### 呼叫函數

```sql
SELECT get_user_count();
```

## 交易

```sql
BEGIN;

INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');

COMMIT;  -- 或 ROLLBACK;
```

## 備份和還原

### 備份

```bash
# 備份單一資料庫
pg_dump -U postgres mydb > backup.sql

# 備份所有資料庫
pg_dumpall -U postgres > all_backup.sql

# 壓縮備份
pg_dump -U postgres mydb | gzip > backup.sql.gz
```

### 還原

```bash
# 還原資料庫
psql -U postgres mydb < backup.sql

# 還原所有資料庫
psql -U postgres -f all_backup.sql

# 解壓還原
gunzip -c backup.sql.gz | psql -U postgres mydb
```

## 使用者管理

### 建立使用者

```sql
CREATE USER myuser WITH PASSWORD 'mypassword';
```

### 授權

```sql
-- 授予資料庫權限
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;

-- 授予表格權限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- 授予序列權限
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myuser;
```

### 刪除使用者

```sql
DROP USER myuser;
```

## 效能優化

### EXPLAIN 分析

```sql
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';
```

### ANALYZE 更新統計資訊

```sql
ANALYZE users;
```

### VACUUM 清理

```sql
-- 清理死亡元組
VACUUM users;

-- 重建表格
VACUUM FULL users;
```

## 相關資源

- [PostgreSQL 官方文檔](https://www.postgresql.org/docs/)
- [PostgreSQL 中文文檔](https://www.postgresql.cn/)
- [pgAdmin 工具](https://www.pgadmin.org/)
