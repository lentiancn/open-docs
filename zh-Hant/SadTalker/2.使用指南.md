# SadTalker 使用指南

SadTalker 使用深度學習技術，從單張圖片和音訊輸入生成逼真的 talking head 影片。

## 快速開始

### 基本命令

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results
```

### 使用增強功能生成影片

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir ./results \
  --preprocess full \
  --enhancer gfpgan
```

## 命令列參數

### 輸入參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--source_image` | 輸入肖像圖片路徑 | 必需 |
| `--driven_audio` | 輸入音訊檔案路徑（WAV/MP3） | 必需 |
| `--result_dir` | 輸出目錄 | ./results |

### 處理參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--preprocess` | 圖片預處理：crop、resize、full | full |
| `--size` | 圖片尺寸：256、512 | 256 |
| `--pose_style` | 姿勢樣式 0-45 | 0 |
| `--expression_scale` | 表情強度 0.5-1.5 | 1.0 |

### 增強參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--enhancer` | 臉部增強器：gfpgan、RestoreFormer、CodeFormer | 無 |
| `--enhancer_background` | 增強背景 | False |

### 效能參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--batch_size` | 處理批次大小 | 1 |
| `--fps` | 輸出影片幀率 | 25 |
| `--faceid` | 保持臉部身份 | False |

### 其他參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--help` | 顯示所有選項 | - |

## 使用範例

### 範例 1：基本生成

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/basic
```

### 範例 2：使用 GFPGAN 增強

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/enhanced \
  --enhancer gfpgan
```

### 範例 3：自訂姿勢樣式

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/pose5 \
  --pose_style 5
```

### 範例 4：更高解析度

```bash
python inference.py \
  --source_image examples/source_image.jpg \
  --driven_audio examples/driven_audio.wav \
  --result_dir results/hd \
  --size 512 \
  --enhancer gfpgan
```

## Python API

### 基本用法

```python
from inference import SadTalker

# 初始化 SadTalker
sadtalker = SadTalker()

# 生成影片
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    enhancer="gfpgan"
)

print(f"影片已保存至：{video_path}")
```

### 進階用法

```python
from inference import SadTalker
import torch

# 使用自訂設定初始化
sadtalker = SadTalker(
    checkpoint_path="checkpoints/SadTalker.pth",
    config_path="config/SadTalker.yaml",
    device="cuda" if torch.cuda.is_available() else "cpu"
)

# 使用進階選項生成
video_path = sadtalker.generate(
    source_image="image.jpg",
    driven_audio="audio.wav",
    preprocess="full",
    pose_style=10,
    expression_scale=1.2,
    enhancer="gfpgan",
    batch_size=1,
    output_video="output.mp4"
)
```

### 批次處理

```python
from inference import SadTalker
import os

sadtalker = SadTalker()

# 使用相同音訊處理多張圖片
audio_file = "audio.wav"
image_dir = "images/"

for image_file in os.listdir(image_dir):
    if image_file.endswith(('.jpg', '.png')):
        output_path = f"results/{image_file}"
        sadtalker.generate(
            source_image=os.path.join(image_dir, image_file),
            driven_audio=audio_file,
            preprocess="full"
        )
```

## 網頁介面

### 執行網頁演示

```bash
python app.py
```

然後在瀏覽器中開啟 http://localhost:8888

### 網頁介面功能

1. **圖片上傳**：拖放或選擇肖像圖片
2. **音訊上傳**：選擇音訊檔案（WAV/MP3）
3. **預覽**：預覽來源圖片和音訊
4. **參數調整**：調整姿勢、表情、增強器
5. **生成**：一鍵生成影片
6. **下載**：儲存生成的影片

### 網頁介面控制項

| 控制項 | 說明 |
|--------|------|
| Source Image | 上傳肖像照片 |
| Driven Audio | 上傳語音音訊 |
| Preprocess | 選擇預處理模式 |
| Pose Style | 選擇姿勢動畫樣式 |
| Enhancer | 選擇臉部品質增強器 |
| Generate Button | 開始生成影片 |

## 臉部增強器

### 可用的增強器

| 增強器 | 品質 | 速度 | VRAM |
|--------|------|------|------|
| 無 | 基本 | 快速 | 低 |
| gfpgan | 良好 | 中等 | 中等 |
| RestoreFormer | 非常好 | 慢 | 高 |
| CodeFormer | 非常好 | 慢 | 高 |

### 建議

- **低 VRAM**：無增強器或 gfpgan
- **平衡**：gfpgan
- **最佳品質**：RestoreFormer 或 CodeFormer

## 預處理模式

| 模式 | 說明 | 適用場景 |
|------|------|----------|
| crop | 中心裁剪臉部 | 快速處理 |
| resize | 調整至目標尺寸 | 簡單背景 |
| full | 完整流程 | 最佳效果 |

## 輸入要求

### 圖片要求

- 格式：JPG、PNG
- 尺寸：建議 512x512 或更大
- 臉部：正面朝向、輪廓清晰
- 背景：簡單為佳

### 音訊要求

- 格式：WAV、MP3
- 時長：1-60 秒
- 取樣率：16000-48000 Hz
- 語音：清晰、噪音少的音訊

## 輸出

### 影片格式

- 格式：MP4
- 編碼：H.264
- 解析度：256x256 或 512x512
- 幀率：25 FPS
- 位元率：2-5 Mbps

### 輸出目錄

結果保存在指定的結果目錄中：
```
results/
├── video.mp4          # 生成的影片
├── video_idx.mp4     # 含索引（如有多個）
└── (暫存檔案)
```

## 疑難排解

### 影片太暗/太亮

**原因：** 訓練資料與輸入的光線條件不匹配

**解決方案：**
- 調整 expression_scale 參數（0.8-1.2）
- 使用品質更好的來源圖片
- 嘗試不同的增強器

### 嘴唇不同步

**原因：** 音訊品質或對齊問題

**解決方案：**
- 使用高品質音訊
- 確保音訊有清晰的語音
- 檢查音訊-影片同步
- 修剪音訊以符合影片長度

### 臉部變形

**原因：** 輸入品質低或異常

**解決方案：**
- 使用更高解析度的圖片（512）
- 嘗試不同的預處理模式
- 使用臉部增強器
- 確保臉部清晰可見

### 處理速度慢

**解決方案：**
- 減少批次大小
- 降低解析度（--size 256）
- 停用增強器
- 使用更快的預處理（crop）

### GPU 記憶體不足

**解決方案：**
- 將 batch_size 降至 1
- 使用較小的圖片尺寸
- 關閉其他 GPU 應用程式
- 啟用 CPU 卸載

## 效能優化技巧

### 加快處理速度

1. 使用 `--preprocess crop`
2. 設定 `--size 256`
3. 停用增強器
4. 減少批次大小

### 提高品質

1. 使用 `--size 512`
2. 啟用 `--enhancer gfpgan`
3. 使用 `--preprocess full`
4. 調整 `--expression_scale`

### 節省 VRAM

1. 一次處理一個
2. 使用較小的模型
3. 停用不必要的功能

## 整合範例

### Python Flask API

```python
from flask import Flask, request, send_file
from inference import SadTalker
import tempfile

app = Flask(__name__)
sadtalker = SadTalker()

@app.route('/generate', methods=['POST'])
def generate():
    image = request.files['image']
    audio = request.files['audio']
    
    with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as img:
        image.save(img.name)
    
    with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as aud:
        audio.save(aud.name)
    
    video_path = sadtalker.generate(
        source_image=img.name,
        driven_audio=aud.name,
        preprocess="full"
    )
    
    return send_file(video_path, mimetype='video/mp4')
```

## 相關連結

- [GitHub](https://github.com/OpenTalker/SadTalker)
- [HuggingFace](https://huggingface.co/spaces/fffilo/SadTalker)
- [論文](https://arxiv.org/abs/2303.17550)
- [模型](https://github.com/OpenTalker/SadTalker/releases)
